
/*******************************************************************************
 * Copyright 1999-2015, Computer Sciences Corporation. All rights reserved.
 *  
 * Warning: This computer program is protected by copyright law and international treaties.
 * Unauthorized reproduction or distribution of this program, or any portion of it, 
 * may result in severe civil and criminal penalties, and will be prosecuted to 
 * the maximum extent possible under the law. 
 ******************************************************************************/ 
/*
--------------------------------------------------------------------------------------------------------------
Date			Edit History       Name			Description 
--------------------------------------------------------------------------------------------------------------
?				100					?           created
04/07/2017      ML-MMOH-SCF-0690  Devindra      Unable to select batch for alternate drug if the batch expiry is near/lesser than prescribed duration and only on batch exist for the item in the store.  
09/08/2019      IN070605		 prathyusha  MMS-KH-CRF-0028  
13/08/2019      IN070451		 Manickavasagam J  MMS-KH-CRF-1408 
13/08/2019      IN070605		 Devindra           MMS-KH-CRF-0028 
22/11/2019      IN070800        PRATHYUSHA                          ML-MMOH-SCF-1303
24/12/2019		IN070059        Shazana					ML-BRU-SCF-1927
06/02/2020		IN071362                Manickavasagam J                       AAKH-CRF-0117
9/4/2020		IN072656		Shazana					SKR-SCF-1319
26/10/2020      IN074250    Prabha			 ML-MMOH-SCF-1634
1/12/2020      TFS:7840    Manickavasagam J			 SKR-SCF-1467
30/12/2020      8046    Manickavasagam			 PMG2020-ML-MMOH-CRF-0002
20/1/2021      	TFS-10599		 Manickavasagam K			SKR-SCF-1512
11/2/2021		TFS-12983			Shazana					SKR-SCF-1561
24/02/2021		TFS-15598       Prabha          MOHE-CRF-0074
18/06/2021      	TFS-19447		 Manickavasagam K			SKR-SCF-1606
13/07/2021		TFS-20859		Prabha			SKR-SCF-1614
19/8/2021		TFS:9495	Shazana					MOHE-CRF-0026.1
13/09/2021		TFS-23359		Manickavasagam J			ML-MMOH-SCF-1898
29/09/2021      TFS-23793       Prabha          ML-MMOH-SCF-1904
19/11/2022						Sushant Tambe	ML-MMOH-CRF-1666
29/11/2023						Sushant Tambe	MMS-DM-CRF-0228
20/09/2023						Sushant Tambe	ML-MMOH-SCF-2267
10-10-23						Himanshu Saxena	   MMS-DM-CRF-0232
03-01-24						Himanshu Saxena   GHL-CRF-0672
07/05/2024						Sushant Tambe	ML-MMOH-CRF-2085
---------------------------------------------------------------------------------------------------------------
*/  

package ePH ;
import java.io.Serializable ;
import java.util.* ;
import java.sql.* ;
import javax.rmi.PortableRemoteObject ;
import javax.naming.InitialContext ;
import java.text.DecimalFormat;
import ePH.Common.* ;
import eCommon.Common.* ; 
import ePH.DispMedication.*;
import ePH.DispMedicationWorkSheet.*;
import ePH.DispMedicationTPNWorkSheet.*;
import eXH.*; // added for Bru-HIMS-CRF-076 [IN029942]

import java.text.SimpleDateFormat; //added for MO-MCMSS-CRF-0009 start
import java.io.*;//added for MO-MCMSS-CRF-0009 end

public class DispMedicationBean extends PhAdapter implements Serializable {

	protected boolean stock_installed				= false;
	private int rf_qty								= 0;
	private int rf_item_count						= 0;
	private int item_count							= 0;		
	private String admixture_identity				= "";
	private String ws_type							= "";
	private String ws_status						= "";
	private String admixture_type					= ""; //I-IV,C-CYTO,T-TPN
	private String worksheet_id						= "";
	//	private String iv_prep_yn=""; // this variable is used in the case of patient wise dispensing... 
	private String deliver_dtls_set					= "N";
	private String admx_prep_charges_appl_yn	= "N";	
	private String allow_usage_of_spil_qty_yn	= "N";
	private String allocated_status					= "";
	private String token_series_description			= "";
	private String source							= "";
	private String disp_locn_details				= "";
	private String disp_locn_code					= "";
	private String finalized_yn						= "Y";
	private String issue_token_on_regn_yn			= "";
	private String disp_regn_reqd_yn				= "";
	private String disp_stage						= "";
	private String disp_locn_catg					= "";
	private String verf_combined_with_alloc			= "";
	private String token_series_code				= "";
	private String disp_locn_name					= "";
	private String store_code						= "";	
	private String rf_qty_uom						= "";
	private String ip_verification_yn				= "";
	private String order_type						= "";
	private String orderingfacility					= "";
	private String disp_cash_coll_stage				= "";
	private String disp_bill_stage					= "";
	private String charge_pat_for_spill_qty_yn = ""; 
	//Query criteria settings starts here
	private String token_no							= "";
	private String order_date_from					= "";
	private String order_date_to					= "";
	private String scope							= "";
	private String priority							= "";
	private String patient_id						= "";
	private String order_id							= "";
	private String nursing_unit						= "";
	private String ordlocntype						= ""; 	
	private String orderby							= "";
	private String chk_group_by_patient				= "";
	private String fill_process_date				= "";
	private String fill_type						= "";
	private String fill_process_id					= "";
	private String batches							= "";
	private String order_status						= "";
	private String selected_patient_id				= ""; // related to order
	private String function_identity				= "";
	//Query criteria settings ends here
	// Additional Query Criteria starts here
	private String add_criteria_locn_code		= "";
	private String add_criteria_locn_desc		= "";
	private String add_criteria_practitioner_name	= "";
	private String add_criteria_practitioner_id		= "";
	private String add_criteria_encounter_id	= "";
	private String add_criteria_order_type			= "";	
	private String add_criteria_nat_code			= "";
	private String add_criteria_nat_desc			= "";	
	// Additional Query Criteria ends here
	// Nationality Id 
	private String nationality_id_no				= "";
	private String disp_narcotic_yn					= "";
	private String disp_controlled_yn				= ""; //added for SKR-SCF-0688 [IN:036036]
	private String change_trade_name_yn				= "";	
	private String allwo_multi_trade_yn				= "";
	private String viewpatienthistoryyn				= "";
	private String ApplicableStagesForTheUser		= "";
	private String today_date						= "";
	private String today_date_time					= "";
	private String date_plus_365					= "";	
	private String fill_list						= "";
	private String user_name						= "";
	private String password							= "";
	private String fillingStatus					= "";
	private String stageDisplaySequence				="";	
	private String disp_stage_identity				= "";	
	private String encounter_id						= "";
	private String stock_qty						= "";
	private String stock_qty_uom					= "";	
	private String fill_period						= "";
	private String fill_unit						= "";
	private String billing_det						= "";
	private String gender							= "";
	private String ip_scope							= "";
	private String user_print_yn					= "N";
	private String fill_date_time					= "";
	private String queue_date 					= "";
	private String prescQty							= "";
	private String qtyUom							= ""; 
	private String strIncludeZeroAllocQtyItems	= "N";
	protected String disp_level						= "";
	protected String appl_user_id					= "";
	protected String selected_nursing_unit			= "";
	protected String issue_by_uom					= "D";
	protected String allow_short_expiry_drugs_yn = "N";	
	protected String strOPDispPeriod				= "";
	protected String strIPFillPeriodAhead			= "";
	protected String strIPFillPeriodUnit			= "";
	protected String strChangedDispensePeriod		= "";
	protected String strChangedDispenseUnit 		= "";
	protected String strResetQty					= "";
	protected String group_by_ord_locn				= "";
	protected String include_drugs_by_freq_durn		= "";		//exclude_drugs_by_freq_durn changed to include_drugs_by_freq_durn for SRR20056-CRF-0663 
	protected String include_absolute_orders		= "";		//Added for SRR20056-CRF-0663 
	protected String sDisp_dflt_display_yn		= "";		//Added for SRR20056-CRF-0663 
	protected String exclude_PRN_orders				= "";	
	protected String drug_medical					= "";
	protected String orderID1						= "";
	protected String date_plus_30					= "";
	protected String date_minus_30					= "";
	protected String display_unallocDrugs			= "";
	protected String allow_disp_record_lock_yn		= "";
	protected String unlock_all_records_yn			= "";
	protected String amend_alt_drug_dtl_yn			= "";     // Added for JD-CRF-0198 [IN058599]
	private String alt_generic_id                   = "";    //Added for JD-CRF-0198 [IN058599]
	protected String sFreqDurnAbsOrderFlag_1        = ""; //Added for RBU-GHL-CRF-0047
	
	
	public String getsFreqDurnAbsOrderFlag_1() {
		return sFreqDurnAbsOrderFlag_1;
	}
	public void setsFreqDurnAbsOrderFlag_1(String sFreqDurnAbsOrderFlag_1) {
		this.sFreqDurnAbsOrderFlag_1 = sFreqDurnAbsOrderFlag_1;
	}
	private HashMap hmDispTMPForDeleteSales			= new HashMap();
	private HashMap	refYnOrder					= null;
	private HashMap order_qty						= new HashMap();
	private HashMap duration_value					= new HashMap();
	private HashMap FLAG_VALUE1						= new HashMap();
	private HashMap VERIFY_REMARKS					= new HashMap();
	private HashMap trade_codes						= new HashMap();
	private HashMap ws_first_yn						= new HashMap();	
	private HashMap ht_ws_allocated_drugs			= new HashMap();
	private HashMap order_id_modified_date			= new HashMap();
	private HashMap order_id_Attended_pract_id		= new HashMap();
	private HashMap order_id_amend_yn				= new HashMap(); 
	private Hashtable ws_allocate_batches			= new Hashtable();
	private Hashtable ws_allocated_qty				= new Hashtable();
	private Hashtable ht_ws_allocate_batches		= new Hashtable();
	private Hashtable ht_ws_allocated_qty			= new Hashtable();
	private Hashtable ht_ws_fluid_allocate_batches	= new Hashtable();
	private Hashtable forVerification				= new Hashtable();
	private Hashtable forAllocation					= new Hashtable();
	private Hashtable forFilling					= new Hashtable();
	private Hashtable forDelivery					= new Hashtable();
	private Hashtable forFillDelivery				= new Hashtable();
	private Hashtable ht_drug_details				= new Hashtable();		
	private Hashtable ht_ordered_qty				= new Hashtable();
	//private Hashtable ht_spill_qty_yn				= new Hashtable();
	private Hashtable pa_ord_sel_ht					= new Hashtable();	
	private ArrayList rf_item_details				= null; 
	private ArrayList item_details					= null;
	private ArrayList arrListdrugClass				= null;
	private ArrayList ws_drug_details				= new ArrayList();	
	private ArrayList mfg_unit_details				= new ArrayList();
	private ArrayList patient_details				= new ArrayList();	
	private ArrayList referralYnStatus				= new ArrayList();	
	private ArrayList prevWorkSheetDetails			= new ArrayList();
	protected ArrayList delivery_details			= new ArrayList();
	protected ArrayList patient_locator				= new ArrayList();
	private HashMap hmAllowMoreQty					= new HashMap();
	private ArrayList alTrxOrderIds					= new ArrayList();
	private String criteriaOrderType				= new String();
	private HashMap hmOrderLineNumbers				= new HashMap();
	private String sFunctionId						= "";
	private HashMap hmPPNValues						= null;
	private ArrayList alBMSOrderIds					= new ArrayList();
	private ArrayList alOrderLineDataForEditLables	= new ArrayList();
	private HashMap hmAllocBmsChk					= new HashMap();
	private HashMap hmFillPorcID_OrderID			= new HashMap();
	private HashMap trn_rx_ids_patientwise			= new HashMap();
	protected boolean bConsuableItemAvailable		= false;
	private boolean bEditValues						= false;
	private boolean bPatientPaid					= false;
	private boolean bEditDispLabelAfterDisp			= false;
	private boolean bValuesChanged					= false;
	DispMedicationAllStages objAllStages			= null;
	private String barcode_multi_id				="N";//Added for Bru-HIMS-CRF-076 [IN:034551]
	protected String from_date				= "";//add this for SRR20056-SCF-7807[28329]
	protected String to_date				= "";//add this for SRR20056-SCF-7807[28329]
	//added for CRF# PMG25006-CRF-0867 -start
	private String tab_based_group_sort_disp		= "";
	protected String customGroupBy="";
	protected String customGroupOrder="";
	protected String customSortby="";
	protected String customSortOrder="";
	protected String customTabBased="";
	protected String customTabBasedHrs="";
	protected String customTabBasedOption="";
	private ArrayList disp_med_stages	= new ArrayList(); //added for SKR-SCF-0611 [IN:034816] 
	private ArrayList alPrevVisitOrders				= new ArrayList();
	protected String delivery_applicable="";
	protected String QMS_required_yn = ""; // Added for Bru-HIMS-CRF-076 [IN:029942]
	protected String dispExpOrders = "Y"; //Added for ML-BRU-SCF-0636 [IN:036826]
	protected String alt_drug_remarks_ind = "N"; //Added for Bru-HIMS-CRF-082 [IN:029948]
	protected String disp_drug_penalty = "N"; //Added for JD-CRF-0170.1 [IN:040204]
	protected String allow_deliver_without_bl = "N"; //Added for JD-CRF-0170.1 [IN:040204]
	protected String display_dms_link_yn=""; //added for RUT-CRF-0083.5 [IN:041511]
	protected String totalTaperQtyDisplay     = "N"; //Added for  RUT-CRF-0088 [IN:036978]
	protected String blDocSrlNo=""; //Added for  [IN:043100]
	protected HashMap hmFillReasons = new HashMap();//code added for ML-BRU-SCF-0971[IN042220]-- Start
	protected String print_seq_no     = ""; 
	protected String presQtyAlert     = ""; //code added for AMS-CRF-0035[IN033551]
	protected String FillPersonNameYN="";//Added for AMS-CRF-0009[IN:030935] -start
	protected String includeBMSDefCheck_yn="";//added for [IN:045055](Bru-HIMS-CRF-281[IN:033166])
	protected String dispMednDrugProfile="N";//added for Bru-HIMS-CRF-081[IN:029947]
	protected String autoCompletePartialDisp="N";//Added for JD-CRF-0179 [IN:41211] 
	protected String curr_enc_financial_dtl_yn="N";//Added for JD-CRF-0156 [IN:41737] 
	protected String allow_label_zero_copy="N";//Added for ML-BRU-SCF-1122[IN:44833] 
	private String recCount= "";//Added for Bru-HIMS-CRF-416
	private String patientclass= "";//Added for Bru-HIMS-CRF-416
	private ArrayList allPatients = null;//Added for Bru-HIMS-CRF-416
	private String relpatient_id = "";//Added for Bru-HIMS-CRF-416
	private String releaseflag = "";//Added for Bru-HIMS-CRF-416
	private String strIPDefStage = "";//Added for [IN:047788]
	private String strOPDefStage = "";//Added for [IN:047788]
	private String pat_paid_yn_for_zero_bill= "";//Added for SKR-SCF-0979 [IN:048119]
	private String dflt_token_series_ind= "W";//Added for HSA-CRF-0136 [IN:048412]
	private String sort_token_series_ind= "O";//Added for HSA-CRF-0136 [IN:048412]
	private String def_sort_token_series_ind= "O";//Added for HSA-CRF-0136 [IN:048412]
	private String generate_actual_token_yn= "N";//Added for HSA-CRF-0136 [IN:048412]
	private String allow_edit_disp_label = "N";//Added for Bru-HIMS-CRF-414 [IN045554] 
	private String editableLabelLangId = "";//Added for Bru-HIMS-CRF-414 [IN045554] 
	MedicationPlannerBean medplan_bean		= null;// Added for Bru-HIMS-CRF-072.1[IN 049144]
	private boolean  Min_Rol_yn = false; //Added for AMS-CRF-0068.1 [IN:050333] start
	private boolean  Req_allowed_yn = false;
	private String medicationPlannerYN = "N";// Added for Bru-HIMS-CRF-072.1 [IN:049144]
	private String filterBasedOnOrdDateYN = "N"; //Added KAUH -EMR for Order date filter
	private ArrayList alSalDocDtls = null; //Added for AMS-CRF-0079 [IN:050762]
	private String disp_doc_no = "N"; //Added for AMS-CRF-0079 [IN:050762]
	private String retn_disp_med_for_outstanding = "N"; //Added for MMS-QH-CRF-0201 [IN:052255]
	private String tpn_admixture_label_yn = "N"; //Added for ML-MMOH-CRF-0430 [IN:057336]
	private String ph_alt_disp_locn_yn = "N";// PH_ALT_DISP_LOCN added for ML-MMOH-SCF-0330.1[IN058994]
	private String ph_st_decimal_restr = "N";//added for MMS-DM-SCF-0210
	private String order_status_1 = ""; // Added for JD-CRF-198
	private String alternateAmendReason = ""; // Added for JD-CRF-198
	private ArrayList batchDetailsForBarcodeDrug	= new ArrayList();//added for GHL-CRF-0413.1 [IN:061794]
    private HashMap printValue = new HashMap(); //added for GHL-CRF-453
    private HashMap printValueForOrders = new HashMap();//added for GHL-CRF-453
	private String bed_no = ""; // added for KDAH-CRF-0338
    private HashMap scanned_barcode_id =new HashMap(); // Added for GHL-CRF-0463 // String changed to HashMap  for MMS-DM-SCF-0488
	private HashMap barcodeColorYn =new HashMap(); // Added for MMS-DM-SCF-0488
	private String strIncludeZeroAllocQtyItemsForIP	= "N";//Added for ML-BRU-CRF-0473
	private String locnCode = ""; // Added for BSP-SCF-0060
	private HashMap form_codes= new HashMap(); // Added for MMS-KH-CRF-0013 - Start
	private HashMap hmbarcodescan= new HashMap();//Added for MMS-DM-CRF-0157.1
	public ArrayList manualBarcodeRemarks = new ArrayList(); //Added for MMS-DM-CRF-0157.1
	private String bar_code_scan_site_YN ="";//Added for MMS-DM-CRF-157.1
	private String iqvia_integration_yn = ""; //MOHE-CRF-0026.1 START 
	private String iqviaDispData = "";  
	private String iqviaAuthStatusDispData = "";
	private String settlementId = "";  
	private String iqviaAfterDispenseData = ""; 
	public ArrayList OrderClaimIdDet = new ArrayList(); 
	private String patient_mobile_no = "";//Added for TH-KW-0014
	private String patient_national_id = "";//Added for TH-KW-0014
	private String disp_auto_refresh ="";
	private String disp_genral_drug_yn ="N";//Added for Performance Issue by chandra 17072022
	private String disp_narco_drug_yn ="N";//Added for Performance Issue by chandra 17072022
	private String disp_control_drug_yn ="N";//Added for Performance Issue by chandra 17072022
	private String opCustomSortBy = ""; //Added for ML-MMOH-CRF-1666
	private String opCustomSortOrder = ""; //Added for ML-MMOH-CRF-1666
	private String disp_before_start_date_yn="";//Added for COMMON-ICN-0116 [39681]
	private String disp_before_no_of_days="";//Added for COMMON-ICN-0116 [39681]
	private String disp_beyond_earliest_start_yn="";//Added for COMMON-ICN-0116 [39681]
	private String disp_beyond_no_of_days="";//Added for COMMON-ICN-0116 [39681]
	protected String disp_drug_verify_remarks_yn="";//added for ml-mmoh-crf-1755 start
	private String barcode_2d_applicable_yn ="N";//Addef for MMS-DM-CRF-0174.5
	private String disp_locn_iae="";//Added by Himanshu for MMS-DM-CRF-0232
	private String disp_locn_codeall="";//Added by Himanshu for MMS-DM-CRF-0232
	private String temp_patient_classl="";//Added by Himanshu for MMS-DM-CRF-0232
	private String prescription_number="";//Added by Himanshu for GHL-CRF-0672 //it is created for the column value
	private String prescription_no="";//Added by Himanshu for GHL-CRF-0672 // it is created for the TRN_GROUP_REF from  or_order where order_category='PH' value
	private String fill_doc_num="";//Added by Himanshu for GHL-CRF-0672
	private String excl_ord_locn_dispense_yn="";//Added for ML-MMOH-CRF-2085
	protected String Token_No_Default_DispMed = "N"; //Added by Himanshu for ML-MMOH-CRF-2094
	public String getToken_No_Default_DispMed() {
		return Token_No_Default_DispMed;
	}
	public void setToken_No_Default_DispMed(String token_No_Default_DispMed) {
		Token_No_Default_DispMed = token_No_Default_DispMed;
	}

	public void setExclOrdLocnDispenseYN(String excl_ord_locn_dispense_yn) {
		this.excl_ord_locn_dispense_yn = excl_ord_locn_dispense_yn;
	}//Added for ML-MMOH-CRF-2085
	public String getExclOrdLocnDispenseYN() {
		return excl_ord_locn_dispense_yn;
	}//Added for ML-MMOH-CRF-2085
	public String getFill_doc_num() {
		return fill_doc_num;
	}
	public void setFill_doc_num(String fill_doc_num) {
		this.fill_doc_num = fill_doc_num;
	}
	public String getPrescription_no() {
		return prescription_no;
	}
	public void setPrescription_no(String prescription_no) {
		this.prescription_no = prescription_no;
	}
	public String getPrescription_number() {
		return prescription_number;
	}
	public void setPrescription_number(String prescription_number) {
		this.prescription_number = prescription_number;
	}
	public String getTemp_patient_classl() {
		return temp_patient_classl;
	}
	public void setTemp_patient_classl(String temp_patient_classl) {
		this.temp_patient_classl = temp_patient_classl;
	}
	public String getDisp_locn_codeall() {
		return disp_locn_codeall;
	}
	public void setDisp_locn_codeall(String disp_locn_codeall) {
		this.disp_locn_codeall = disp_locn_codeall;
	}
	public String getDisp_locn_iae() {
		return disp_locn_iae;
	}
	public void setDisp_locn_iae(String disp_locn_iae) {
		this.disp_locn_iae = disp_locn_iae;
	}

	private HashMap hm2DBarCodes = new HashMap();
	public String getDisp_drug_verify_remarks_yn() {
		return this.disp_drug_verify_remarks_yn;
	}
	public void setDisp_drug_verify_remarks_yn(String disp_drug_verify_remarks_yn) {
		this.disp_drug_verify_remarks_yn = disp_drug_verify_remarks_yn;
	}
	//added for ml-mmoh-crf-1755 end
	
	public String getDisp_before_start_date_yn() {
		return disp_before_start_date_yn;
	}
	public void setDisp_before_start_date_yn(String disp_before_start_date_yn) {
		this.disp_before_start_date_yn = disp_before_start_date_yn;
	}
	public String getDisp_before_no_of_days() {
		return disp_before_no_of_days;
	}
	public void setDisp_before_no_of_days(String disp_before_no_of_days) {
		this.disp_before_no_of_days = disp_before_no_of_days;
	}
	public String getDisp_beyond_earliest_start_yn() {
		return disp_beyond_earliest_start_yn;
	}
	public void setDisp_beyond_earliest_start_yn(String disp_beyond_earliest_start_yn) {
		this.disp_beyond_earliest_start_yn = disp_beyond_earliest_start_yn;
	}
	public String getDisp_beyond_no_of_days() {
		return disp_beyond_no_of_days;
	}
	public void setDisp_beyond_no_of_days(String disp_beyond_no_of_days) {
		this.disp_beyond_no_of_days = disp_beyond_no_of_days;
	}
	public String getOpCustomSortBy() {
		return opCustomSortBy;
	}
	public void setOpCustomSortBy(String opCustomSortBy) {
		this.opCustomSortBy = opCustomSortBy;
	}//added for ML-MMOH-CRF-1666
	public String getOpCustomSortOrder() {
		return opCustomSortOrder;
	}
	public void setOpCustomSortOrder(String opCustomSortOrder) {
		this.opCustomSortOrder = opCustomSortOrder;
	}//added for ML-MMOH-CRF-1666
	public ArrayList getOrderClaimIdDet() {
		return OrderClaimIdDet;
	}
	public void setOrderClaimIdDet(ArrayList orderClaimIdDet) {
		OrderClaimIdDet = orderClaimIdDet;
	}
	public String getIqviaAfterDispenseData() {
		return iqviaAfterDispenseData;
	}
	public void setIqviaAfterDispenseData(String iqviaAfterDispenseData) {
		this.iqviaAfterDispenseData = iqviaAfterDispenseData;
	}
	public String getSettlementId() {
		return settlementId;
	}
	public void setSettlementId(String settlementId) {
		this.settlementId = settlementId;
	}

	public String getIqvia_integration_yn() {
		return iqvia_integration_yn;
	}
	public String getIqviaDispData() {
		return iqviaDispData;
	}
	public void setIqviaDispData(String iqviaDispData) {
		this.iqviaDispData = iqviaDispData;
	}
	public void setIqvia_integration_yn(String iqvia_integration_yn) {
		this.iqvia_integration_yn = iqvia_integration_yn;
	}
	public String getIqviaAuthStatusDispData() {
		return iqviaAuthStatusDispData;
	}
	public void setIqviaAuthStatusDispData(String iqviaAuthStatusDispData) {
		this.iqviaAuthStatusDispData = iqviaAuthStatusDispData;
	}
//end 
	
	//added for SKR-SCF-1319 START
	private String ivprep = "";
	public String getIvprep() {
		return ivprep;
	}
	public void setIvprep(String ivprep) {
		this.ivprep = ivprep;
	}//END 
	
	private HashMap form_descs= new HashMap();
	
	public String getForm_code(String key) {
		return (String)form_codes.get(key);
	}

	public void setForm_codes(String key,String form_code) {
		form_codes.put(key, form_code);
	}
	
	public String getForm_descs(String key) {
		return (String)form_descs.get(key);
	}

	public void setForm_descs(String key,String form_desc) {
		form_descs.put(key, form_desc);
	}  // Added for MMS-KH-CRF-0013 - End

	public String getLocnCode() {//added for BSP-SCF-0060 - Start
		return locnCode;
	}
    
	public void setLocnCode(String locnCode) {
		this.locnCode = locnCode;
	} //added for BSP-SCF-0060 - End
	public String getBarcodeColorYn(String order_id,String order_line_no) { // Added for MMS-DM-SCF-0488 -Start
		return (String)(barcodeColorYn.get(order_id+"_"+order_line_no)==null?"":barcodeColorYn.get(order_id+"_"+order_line_no));
	}
	public void setBarcodeColorYn(String order_id,String order_line_no,String barcodeColorYn) { //Added MMS-QH-CRF-0201 [IN:052255]
		this.barcodeColorYn.put(order_id+"_"+order_line_no, barcodeColorYn);
	}  // Added for MMS-DM-SCF-0488 -End
    public String getBedNo() {//added for KDAH-CRF-0338 - Start
		return bed_no;
	}
    
	public void setBedNo(String bed_no) {
		this.bed_no = bed_no;
	} //added for KDAH-CRF-0338 - End
	
	public ArrayList getBatchDetailsForBarcodeDrug() {//added for GHL-CRF-0413.1 [IN:061794]
		return batchDetailsForBarcodeDrug;
	}


	public void setBatchDetailsForBarcodeDrug(ArrayList batchDetailsForBarcodeDrug) {
		this.batchDetailsForBarcodeDrug = batchDetailsForBarcodeDrug;
	}//added for GHL-CRF-0413.1 [IN:061794]
	
	public void clearBatchDetailsForBarcodeDrug(){
		batchDetailsForBarcodeDrug = new ArrayList();
	}//added for GHL-CRF-0413.1 [IN:061794]
	/**
	 * @return the alternateAmendReason Added for JD-CRF-198
	 */
	public String getAlternateAmendReason() {
		return alternateAmendReason;
	}
	/**
	 * @param alternateAmendReason the alternateAmendReason to set Added for JD-CRF-198
	 */
	public void setAlternateAmendReason(String alternateAmendReason) {
		this.alternateAmendReason = alternateAmendReason;
	}
	public String getOrStatus_1() { // Added for JD-CRF-198 - Start
		return order_status_1;
	}
	public void setOrStatus_1(String order_status_1) { 
		this.order_status_1 = order_status_1;
	}  
	
	public String getGenericId() { // Added for JD-CRF-198 - Start
		return alt_generic_id;
	}
	public void setGenericId(String alt_generic_id) { 
		this.alt_generic_id = alt_generic_id;
	}                             // Added for JD-CRF-198 - End
	
	public String getPhAltDispLocnYN() { // PH_ALT_DISP_LOCN added for ML-MMOH-SCF-0330.1[IN058994]
		return ph_alt_disp_locn_yn;
	}
	public void setPhAltDispLocnYN(String ph_alt_disp_locn_yn) { // PH_ALT_DISP_LOCN added for ML-MMOH-SCF-0330.1[IN058994]
		this.ph_alt_disp_locn_yn = ph_alt_disp_locn_yn;
	}

	public String getTpnAdmixtureLabelYN() { //Added ML-MMOH-CRF-0430 [IN:057336]
		return tpn_admixture_label_yn;
	}
	public void setTpnAdmixtureLabelYN(String tpn_admixture_label_yn) { //Added ML-MMOH-CRF-0430 [IN:057336]
		this.tpn_admixture_label_yn = tpn_admixture_label_yn;
	}
	
	public String getPhStDecimalRestrictionYN() { //Added for MMS-DM-SCF-0210
		return ph_st_decimal_restr;
	}
	public void setPhStDecimalRestrictionYN(String ph_st_decimal_restr) { //Added for MMS-DM-SCF-0210
		this.ph_st_decimal_restr = ph_st_decimal_restr;
	}
	public String getRetnDispMedForOutStanding() { //Added MMS-QH-CRF-0201 [IN:052255]
		return retn_disp_med_for_outstanding;
	}
	public void setRetnDispMedForOutStanding(String retn_disp_med_for_outstanding) { //Added MMS-QH-CRF-0201 [IN:052255]
		this.retn_disp_med_for_outstanding = retn_disp_med_for_outstanding;
	}
	public String getFilterBasedOnOrdDateYN() { //Added KAUH -EMR for Order date filter 
		return filterBasedOnOrdDateYN;
	}
	public void setFilterBasedOnOrdDateYN(String filterBasedOnOrdDateYN) { //Added KAUH -EMR for Order date filter 
		this.filterBasedOnOrdDateYN = filterBasedOnOrdDateYN;
	}
	public String getMedicationPlannerYN() {// Added for Bru-HIMS-CRF-072.1 [IN:049144]
		return medicationPlannerYN;
	}
	public void setMedicationPlannerYN(String medicationPlannerYN) {// Added for Bru-HIMS-CRF-072.1 [IN:049144]
		this.medicationPlannerYN = medicationPlannerYN;
	}
	public boolean getMin_Rol_yn() {
		return Min_Rol_yn;
	}
	public void setMin_Rol_yn(boolean min_Rol_yn) {
		this.Min_Rol_yn = min_Rol_yn;
	}

	public void setReq_allowed_yn(boolean req_allowed_yn) {
		this.Req_allowed_yn = req_allowed_yn;
	}

	public boolean getReq_allowed_yn() {
		return Req_allowed_yn;
	}// AMS-CRF-0068.1 [IN:050333] end
	private String filter_on_next_fill_date = "N";//Added for ML-BRU-SCF-1147 [IN045177] start  - KAUH Production upgrade [IN:049692]
	public String getFilter_on_next_fill_date() {
		return filter_on_next_fill_date;
	}
	public void setFilter_on_next_fill_date(String filter_on_next_fill_date) {
		this.filter_on_next_fill_date = filter_on_next_fill_date;
	} //Added for ML-BRU-SCF-1147 [IN045177] end 
	public String getAllowEditDispLabel() { //Added for Bru-HIMS-CRF-414 [IN045554] -start
		return allow_edit_disp_label;
	}
	public void setAllowEditDispLabel(String allow_edit_disp_label) {
		this.allow_edit_disp_label = allow_edit_disp_label;
	} 
	public String getEditableLabelLangId() {
		return editableLabelLangId;
	}
	public void SetEditableLabelLangId(String editableLabelLangId) {
		this.editableLabelLangId = editableLabelLangId;
	} //Added for Bru-HIMS-CRF-414 [IN045554]  [IN045177] end 
	public String getStrIPDefStage() {//Added for [IN:047788] start
		return strIPDefStage;
	}
	public void setStrIPDefStage(String strIPDefStage) {
		this.strIPDefStage = strIPDefStage;
	}
	public String getStrOPDefStage() {
		return strOPDefStage;
	}
	public void setStrOPDefStage(String strOPDefStage) {
		this.strOPDefStage = strOPDefStage;
	}								//Added for [IN:047788] end
	public String getCurrEncFinancialDtl() {//Added for JD-CRF-0156 [IN:41737] -Start
		return curr_enc_financial_dtl_yn;
	}
	public void setCurrEncFinancialDtl(String curr_enc_financial_dtl_yn) {
		this.curr_enc_financial_dtl_yn = curr_enc_financial_dtl_yn;
	} //Added for JD-CRF-0156 [IN:41737] end

	public String getDfltTokenSeriesInd() {//Added for HSA-CRF-0136 [IN:048412] -Start
		return dflt_token_series_ind;
	}
	public void setDfltTokenSeriesInd(String dflt_token_series_ind) {
		this.dflt_token_series_ind = dflt_token_series_ind;
	} 
	public String getDefSortTokenSeriesInd() {
		return def_sort_token_series_ind;
	}
	public void setDefSortTokenSeriesInd(String def_sort_token_series_ind) {
		this.def_sort_token_series_ind = def_sort_token_series_ind;
	} 
	public String getSortTokenSeriesInd() {
		return sort_token_series_ind;
	} 
	public void setSortTokenSeriesInd(String sort_token_series_ind) {
		this.sort_token_series_ind = sort_token_series_ind;
	} 
	public String getGenerateActualTokenYN() {
		return generate_actual_token_yn;
	}
	public void setGenerateActualTokenYN(String generate_actual_token_yn) {
		this.generate_actual_token_yn = generate_actual_token_yn;
	} //Added for HSA-CRF-0136 [IN:048412] end

	public String getAutoCompletePartialDisp() {//Added for JD-CRF-0179 [IN:41211] start
		return autoCompletePartialDisp;
	}
	public void setAutoCompletePartialDisp(String autoCompletePartialDisp) {
		this.autoCompletePartialDisp = autoCompletePartialDisp;
	} //Added for JD-CRF-0179 [IN:41211] end
	public String getDispMednDrugProfile(){ //added for Bru-HIMS-CRF-081[IN:029947]
		return this.dispMednDrugProfile;
	}
	public void setDispMednDrugProfile(String dispMednDrugProfile){ //added for Bru-HIMS-CRF-081[IN:029947]
		this.dispMednDrugProfile = dispMednDrugProfile;
	}

	public String getIncludeBMSDefCheck(){ //added for [IN:045055](Bru-HIMS-CRF-281[IN:033166])
		return this.includeBMSDefCheck_yn;
	}
	public void setIncludeBMSDefCheck(String includeBMSDefCheck_yn){ //added for [IN:045055](Bru-HIMS-CRF-281[IN:033166])
		this.includeBMSDefCheck_yn = includeBMSDefCheck_yn;
	}

	public String getFillPerson(){  //Added for AMS-CRF-0009[IN:030935] 
		return this.FillPersonNameYN;
	}
	public void setFillPersonName(String FillPersonNameYN){ //Added for AMS-CRF-0009[IN:030935] 
		this.FillPersonNameYN = FillPersonNameYN;
	}

	public String getPrintSeqNo(){ //Added for JD-CRF-0170.1 [IN:040204]
		return this.print_seq_no;
	}
	public void setPrintSeqNo(String print_seq_no){ 
		this.print_seq_no = print_seq_no;
	}
	public ArrayList getSalDocDtls(){ //Added for AMS-CRF-0079 [IN:050762]
		return this.alSalDocDtls;
	}
	public void setSalDocDtls(ArrayList alSalDocDtls){ //Added for AMS-CRF-0079 [IN:050762]
		this.alSalDocDtls = alSalDocDtls;
	}
	public String getDispDocNo(){ //Added for AMS-CRF-0079 [IN:050762]
		return this.disp_doc_no;
	}
	public void setDispDocNo(String disp_doc_no){ //Added for AMS-CRF-0079 [IN:050762]
		this.disp_doc_no = disp_doc_no;
	}
	public ArrayList getFillReasons(String key){
		if(this.hmFillReasons!=null && this.hmFillReasons.containsKey(key))
			return (ArrayList)this.hmFillReasons.get(key);
		else
			return null;
	}//code added for ML-BRU-SCF-0971[IN042220]-- End
	public String getTotalTaperQtyDisplay() {  //Added for  RUT-CRF-0088 [IN:036978] -Start
		return this.totalTaperQtyDisplay;
	}
	public void setTotalTaperQtyDisplay(String totalTaperQtyDisplay) {
		this.totalTaperQtyDisplay = totalTaperQtyDisplay;
	}  //Added for  RUT-CRF-0088 [IN:036978] -end

	public String getPresQtyAlert() { //code added for AMS-CRF-0035[IN033551]
		return this.presQtyAlert;
	}
	public void setPresQtyAlert(String presQtyAlert) {
		this.presQtyAlert = presQtyAlert;		
	}  //code added for AMS-CRF-0035[IN033551]

	public String getDeliverWithoutBL(){ //Added for JD-CRF-0170.1 [IN:040204]
		return this.allow_deliver_without_bl;
	}
	public void setDeliverWithoutBL(String allow_deliver_without_bl){ 
		this.allow_deliver_without_bl = allow_deliver_without_bl;
	}
	public String getDispDrugPenalty(){ 
		return this.disp_drug_penalty;
	}
	public void setDispDrugPenalty(String disp_drug_penalty){ 
		this.disp_drug_penalty = disp_drug_penalty;
	}//Added for JD-CRF-0170.1 [IN:040204] -End

	public String getDispDMSLink(){ //added for RUT-CRF-0083.5 [IN:041511] -start
		return this.display_dms_link_yn;
	}
	public void setDispDMSLink(String display_dms_link_yn){ 
		this.display_dms_link_yn = display_dms_link_yn;
	}//added for RUT-CRF-0083.5 [IN:041511] -End
	public String getAltDrugRemarksInd(){ //Added for Bru-HIMS-CRF-082 [IN:029948]
		return this.alt_drug_remarks_ind;
	}
	public void setAltDrugRemarksInd(String alt_drug_remarks_ind){ //Added for Bru-HIMS-CRF-082 [IN:029948]
		this.alt_drug_remarks_ind = alt_drug_remarks_ind;
	}

	public String getDispExpOrders(){ //Added for ML-BRU-SCF-0636 [IN:036826]
		return this.dispExpOrders;
	}
	public void setDispExpOrders(String dispExpOrders){ //Added for ML-BRU-SCF-0636 [IN:036826]
		this.dispExpOrders = dispExpOrders;
	}

	public String getQMSRequiredYN(){ // Added for Bru-HIMS-CRF-076 [IN:029942]
		return this.QMS_required_yn;
	}
	public void setQMSRequiredYN(String QMS_required_yn){ // Added for Bru-HIMS-CRF-076 [IN:029942]
		this.QMS_required_yn = QMS_required_yn;
	}
	public String getAllow_Label_Zero_Copy() {//Added for ML-BRU-SCF-1122[IN:44833] -Start
		return allow_label_zero_copy;
	}
	public void setAllow_Label_Zero_Copy(String allow_label_zero_copy) {
		this.allow_label_zero_copy = allow_label_zero_copy;
	} //Added for ML-BRU-SCF-1122[IN:44833]-end
	public void setPatPaidYNForZeroBill(String pat_paid_yn_for_zero_bill){ //Added for SKR-SCF-0979 [IN:048119] -start
		this.pat_paid_yn_for_zero_bill = pat_paid_yn_for_zero_bill;
	}
	public String getPatPaidYNForZeroBill(){
		return this.pat_paid_yn_for_zero_bill;
	} //Added for SKR-SCF-0979 [IN:048119] - End
	//added for GHL-CRF-0453 - start
	public void setPrintValue(String order_id,String order_line_num,String print_value){
		this.printValue.put(order_id+order_line_num,print_value);
	}
	public HashMap getPrintValue(){
		return printValue;
	}
	public void setPrintValueForOrders(String order_id,String print_value){
		this.printValueForOrders.put(order_id,print_value);
	}
	public HashMap getPrintValueForOrders(){
		return printValueForOrders;
	}
	//added for GHL-CRF-0453 - end

	private String barcode_scan_yn="";		//added for KDAH-CRF-0231 [IN-034551] -start
	private String barcode_batch_id="";
	private HashMap stockdtl = new HashMap();
	private ArrayList batch_val = new ArrayList();
	private HashMap hmBarCodesForDrug = new HashMap();
	private ArrayList orderdrugdtl = new ArrayList();
	private HashSet drugqty = new HashSet();
	private HashMap tempStockDtls = new HashMap();	//Added for KDAH-CRF-0231 [IN-034551] - end
	private HashMap approvalNo = new HashMap(); //Added for AAKH-CRF-0117
	private boolean approval_no_flag = false; //AAKH-CRF-0117
	public String getDeliveryApplicable(){
		return this.delivery_applicable;
	}
	public void setDeliveryApplicable(String delivery_applicable){		
		this.delivery_applicable = delivery_applicable;
	}
	public ArrayList getPrevVisitOrders(){
		return alPrevVisitOrders;
	}
	public void setPrevVisitOrders(ArrayList alPrevVisitOrders){		
		this.alPrevVisitOrders = alPrevVisitOrders;
	}
	public String getTabBasegGroupSortDisp(){
		return tab_based_group_sort_disp;
	}
	public String getCustomGroupBy(){
		return customGroupBy;
	}
	public void setCustomGroupBy(String customGroupBy){		
		this.customGroupBy = customGroupBy;
	}
	public String getCustomGroupOrder(){
		return customGroupOrder;
	}
	public void setCustomGroupOrder(String customGroupOrder){		
		this.customGroupOrder = customGroupOrder;
	}
	public String getCustomSortBy(){
		return customSortby;
	}
	public void setCustomSortBy(String customSortby){		
		this.customSortby = customSortby;
	}
	public String getCustomSortOrder(){
		return customSortOrder;
	}
	public void setCustomSortOrder(String customSortOrder){		
		this.customSortOrder = customSortOrder;
	}
	public String getCustomTabBased(){
		return customTabBased;
	}
	public void setCustomTabBased(String customTabBased){		
		this.customTabBased = customTabBased;
	}
	public String getCustomTabBasedHrs(){
		return customTabBasedHrs;
	}
	public void setCustomTabBasedHrs(String customTabBasedHrs){		
		this.customTabBasedHrs = customTabBasedHrs;
	}
	public String getCustomTabBasedOption(){
		return customTabBasedOption;
	}
	public void setCustomTabBasedOption(String customTabBasedOption){		
		this.customTabBasedOption = customTabBasedOption;
	}//added for CRF# PMG25006-CRF-0867 -end
	
	//Added for AAKH-CRF-0117
	public void setApprovalNo(String order_id,String order_line_no,String approval_no){ //modified for AAKH-CRF-0117
	 
		this.approvalNo.put(order_id+order_line_no,approval_no);
	}
	public HashMap getApprovalNo(){

	 return  approvalNo;
	}
	public void setApprovalNoFlag(boolean approval_no_flag){ //AAKH-CRF-0117
	 this.approval_no_flag = approval_no_flag;
	}
	//Ended for AAKH-CRF-0117
	public DispMedicationBean() {
		try {
			doCommon();
		}
		catch(Exception e) {e.printStackTrace();}
	}

	/* added for SRR20056-CRF-0663 - START */
	protected String strIPFillDispPeriod			= ""; 
	protected String strIPFillDispPeriodUnit			= ""; 

	public void setIPFillDispPeriod(String strIPFillDispPeriod){		
		this.strIPFillDispPeriod = strIPFillDispPeriod;
	}
	public String getIPFillDispPeriod(){
		return strIPFillDispPeriod;
	}
	public void setIPFillDispPeriodUnit(String strIPFillDispPeriodUnit){		
		this.strIPFillDispPeriodUnit=strIPFillDispPeriodUnit;
	}
	public String getIPFillDispPeriodUnit(){
		return strIPFillDispPeriodUnit;
	}

	public void setIncludeAbsoluteOrders(String include_absolute_orders) {
		this.include_absolute_orders	=	include_absolute_orders;
	}

	public String getIncludeAbsoluteOrders(){
		return this.include_absolute_orders;
	}

	public void setDispDfltDisplay_YN(String sDisp_dflt_display_yn) {
		this.sDisp_dflt_display_yn	=	sDisp_dflt_display_yn;
	}

	public String getDispDfltDisplay_YN(){
		return this.sDisp_dflt_display_yn;
	}
	public void setStockInstalled(boolean stock_installed) {
		this.stock_installed	=	stock_installed;
	}

	public boolean getStockInstalled(){
		return this.stock_installed;
	}//Added for SRR20056-CRF-0663	--End

	// Additional Query Criteria get methods starts here
	public void setPrevWorkSheetDetails(ArrayList al){		
		prevWorkSheetDetails=al;
	}
	public ArrayList getPrevWorkSheetDetails(){
		return prevWorkSheetDetails;
	}
	public void setPrescQty(String qty){
		prescQty=qty;
	}
	public void setQtyUom(String qty){
		qtyUom=qty;
	}
	public String getPrescQty(){
		return prescQty;
	}

	public boolean getEditValues(){
		return bEditValues;
	}

	public void setEditValues(boolean bEditValues){
		this.bEditValues = bEditValues;
	}

	public boolean getValuesChanged(){
		return bValuesChanged;
	}

	public void setValuesChanged(boolean bValuesChanged){
		this.bValuesChanged = bValuesChanged;
	}
	public boolean getPatientPaid(){
		return bPatientPaid;
	}

	public void setPatientPaid(boolean bPatientPaid){
		this.bPatientPaid = bPatientPaid;
	}

	public String getQtyUom(){
		return qtyUom;
	}
	public String getAddCriteriaLocnCode(){
		return this.add_criteria_locn_code;
	}
	public String getAddCriteriaLocnDesc(){
		return this.add_criteria_locn_desc;
	}
	public String getAddCriteriaPractitionerName(){
		return this.add_criteria_practitioner_name;
	}
	public String getAddCriteriaPractitionerID(){
		return this.add_criteria_practitioner_id;
	}
	public String getAddCriteriaEncounterID(){
		return this.add_criteria_encounter_id;
	}
	public String getAddCriteriaOrderType(){
		return this.add_criteria_order_type;
	}	
	public String getAddCriteriaNatCode(){
		return this.add_criteria_nat_code;
	}
	public String getAddCriteriaNatDesc(){
		return this.add_criteria_nat_desc;
	}
	public String getFromDate(){ //add this for SRR20056-SCF-7807[28329]
		return this.from_date;
	}
	public String getToDate(){ //add this for SRR20056-SCF-7807[28329]
		return this.to_date;
	}// Additional Query Criteria get methods ends here
	// Additional Query Criteria set methods starts here
	public void setFromDate(String from_date){ //add this for SRR20056-SCF-7807[28329]
		this.from_date = from_date;
	}
	public void setToDate(String to_date){ //add this for SRR20056-SCF-7807[28329]
		this.to_date = to_date;
	}

	public void setAddCriteriaLocnCode(String add_criteria_locn_code){
		this.add_criteria_locn_code=add_criteria_locn_code;
	}
	public void setAddCriteriaLocnDesc(String add_criteria_locn_desc){
		this.add_criteria_locn_desc=add_criteria_locn_desc;
	}
	public void setAddCriteriaPractitionerName(String add_criteria_practitioner_name){
		this.add_criteria_practitioner_name=add_criteria_practitioner_name;
	}
	public void setAddCriteriaPractitionerID(String add_criteria_practitioner_id){
		this.add_criteria_practitioner_id=add_criteria_practitioner_id;
	}
	public void setAddCriteriaEncounterID(String add_criteria_encounter_id){
		this.add_criteria_encounter_id=add_criteria_encounter_id;
	}
	public void setAddCriteriaOrderType(String add_criteria_order_type){
		this.add_criteria_order_type=add_criteria_order_type;
	}
	public void setAddCriteriaNatCode(String add_criteria_nat_code){
		this.add_criteria_nat_code = add_criteria_nat_code;
	}
	public void setAddCriteriaNatDesc(String add_criteria_nat_desc){
		this.add_criteria_nat_desc = add_criteria_nat_desc;
	}
	
	// Additional Query Criteria set methods ends here	
	public void setNationalIDNo(String nationality_id_no) {
		this.nationality_id_no	=	nationality_id_no;
	}	
	public String getNationalIDNo() {
		return this.nationality_id_no;
	}
	public void setUserPrintYN(String user_print_yn){
		this.user_print_yn = user_print_yn;
	}
	public String getUserPrintYN(){
		return this.user_print_yn;
	}
	public void setDispNarcoticYN(String disp_narcotic_yn) {
		this.disp_narcotic_yn	=	disp_narcotic_yn;
	}
	public String getDispNarcoticYN() {
		return this.disp_narcotic_yn;
	}
	////added for SKR-SCF-0688 [IN:036036] - start
	public void setDispControlledYN(String disp_controlled_yn) {
		this.disp_controlled_yn	=	disp_controlled_yn;
	}
	public String getDispControlledYN() {
		return this.disp_controlled_yn;
	}
	////added for SKR-SCF-0688 [IN:036036] -end
	public void setDispChangeTradeNameYN(String change_trade_name_yn) {
		this.change_trade_name_yn	=	change_trade_name_yn;
	}
	public String getDispChangeTradeNameYN() {
		return this.change_trade_name_yn;
	}

	public void setadmx_prep_charges_appl_yn(String admx_prep_charges_appl_yn) {
		this.admx_prep_charges_appl_yn	=	admx_prep_charges_appl_yn;
	}
	public String getadmx_prep_charges_appl_yn() {
		return this.admx_prep_charges_appl_yn;
	}

	public void setDispAllowMultiTradesYN(String allwo_multi_trade_yn) {
		this.allwo_multi_trade_yn	=	allwo_multi_trade_yn;
	}
	public String getDispAllowMultiTradesYN() {
		return this.allwo_multi_trade_yn;
	}

	public void setViewPatientHistoryYN(String viewpatienthistoryyn) {
		this.viewpatienthistoryyn	=	viewpatienthistoryyn;
	}
	public String getViewPatientHistoryYN() {
		return this.viewpatienthistoryyn;
	}
	public void setSFunctionId(String sFunctionId) {
		if(sFunctionId != null)
			this.sFunctionId	=	sFunctionId;
		else
			sFunctionId		= "";
	}
	public String getSFunctionId() {
		return this.sFunctionId;
	}

	public void setSelectedNursingUnit(String selected_nursing_unit) {
	
		this.selected_nursing_unit	=	selected_nursing_unit;
	}
	public String getSelectedNursingUnit() {
		return this.selected_nursing_unit;
	}	
	public void setApplPassword(String appl_user_id) {
		this.appl_user_id	=	appl_user_id;
	}

	public HashMap getHmPPNValues() {
		return this.hmPPNValues;
	}	
	public void setHmPPNValues(HashMap hmPPNValues) {
		this.hmPPNValues	=	hmPPNValues;
	}

	public HashMap getHmAllocBmsChk() {
		return this.hmAllocBmsChk;
	}	
	public void setHmAllocBmsChk(HashMap hmAllocBmsChk) {
		this.hmAllocBmsChk	=	hmAllocBmsChk;
	}

	public String getApplPassword() {
		return this.appl_user_id;
	}
	public void setPatientLocator(ArrayList patient_locator) {
		this.patient_locator	=	patient_locator;
	}
	public ArrayList getPatientLocator() {
		return this.patient_locator;
	}	

	public void setAlOrderLineDataForEditLables(ArrayList alOrderLineDataForEditLables) {
		this.alOrderLineDataForEditLables	=	alOrderLineDataForEditLables;
	}
	public ArrayList getAlOrderLineDataForEditLables() {
		return this.alOrderLineDataForEditLables;
	}	

	public void clearAlOrderLineDataForEditLables(){
		this.alOrderLineDataForEditLables = new ArrayList();
	}
	
	public void setOrderType(String order_type) {
		this.order_type	=	order_type;
	}
	public String getOrderType(){
		return this.order_type;
	}
	public void setOrderingFacility(String orderingfacility) {
		this.orderingfacility	=	orderingfacility;
	}
	public String getOrderingFacility(){
		return this.orderingfacility;
	}
	public void setCollectorDtlsFlag(String clctr_dtls_flag) {
		this.deliver_dtls_set	=	clctr_dtls_flag;
	}
	public String getCollectorDtlsFlag() {
		return this.deliver_dtls_set;
	}
	public void setDEL_IR_FLAG_VALUE(HashMap FLAG_VALUE){
		this.FLAG_VALUE1 = FLAG_VALUE;		
	}
	public HashMap getDEL_IR_FLAG_VALUE(){	
		return this.FLAG_VALUE1;
	}
 
	public void setBILLING_DET(String billing_det){
		this.billing_det = billing_det;		
	}
	public String getBILLING_DET(){	
		return this.billing_det;
	}
	public void setBLDocSrlNo(String blDocSrlNo){ //Added for  [IN:043100] -start
		this.blDocSrlNo = blDocSrlNo;		
	}
	public String getBLDocSrlNo(){	
		return this.blDocSrlNo;
	} //Added for  [IN:043100] -End
	public void setverifyremarks(HashMap VERIFY_REMARKS){
		this.VERIFY_REMARKS = VERIFY_REMARKS;		
	}
	public HashMap getverifyremarks(){	
		return this.VERIFY_REMARKS;
	}

	public void setAllow_short_expiry_drugs_yn(String allow_short_expiry_drugs_yn){
		this.allow_short_expiry_drugs_yn = allow_short_expiry_drugs_yn;		
	}

	public String getAllow_short_expiry_drugs_yn(){	
		return this.allow_short_expiry_drugs_yn;
	}

	public String getStrOPDispPeriod(){
		return this.strOPDispPeriod;
	}

	public String getStrIPFillPeriodAhead(){
		return this.strIPFillPeriodAhead;
	}
	public String getStrIPFillPeriodUnit(){
		return this.strIPFillPeriodUnit;
	}
	public String getStrChangedDispenseUnit(){
		return this.strChangedDispenseUnit;
	}
	public String getStrResetQty(){
		return this.strResetQty;
	}
	public String getStrChangedDispensePeriod(){
		return this.strChangedDispensePeriod;
	}
	public HashMap getHmAllowMoreQty(){
		return this.hmAllowMoreQty;
	}

	public String getCriteriaOrderType(){
		return this.criteriaOrderType;
	}

	public void setCriteriaOrderType(String criteriaOrderType){
		this.criteriaOrderType = criteriaOrderType;
	}

	public void setHmAllowMoreQty(HashMap hmAllowMoreQty){
		this.hmAllowMoreQty = hmAllowMoreQty;
	}

	public void setStrOPDispPeriod(String strOPDispPeriod){
		this.strOPDispPeriod = strOPDispPeriod;
	}

	public void setStrIPFillPeriodAhead(String strIPFillPeriodAhead){
		this.strIPFillPeriodAhead = strIPFillPeriodAhead;
	}

	public void setStrIPFillPeriodUnit(String strIPFillPeriodUnit){
		this.strIPFillPeriodUnit = strIPFillPeriodUnit;
	}
	
	public void setStrChangedDispensePeriod(String strChangedDispensePeriod){
		this.strChangedDispensePeriod = strChangedDispensePeriod;
	}
	public void setStrChangedDispenseUnit(String strChangedDispenseUnit){
		this.strChangedDispenseUnit = strChangedDispenseUnit;
	}
	public void setStrResetQty(String strResetQty){
		this.strResetQty = strResetQty;
	}

	public void setGroupByOrdLocn(String group_by_ord_locn) {
		this.group_by_ord_locn	=	group_by_ord_locn;
	}
	public String getGroupByOrdLocn(){
		return this.group_by_ord_locn;
	}
// Method name setExcludeDrugsByFreqDurn changed to setIncludeDrugsByFreqDurn for SRR20056-CRF-0663
	public void setIncludeDrugsByFreqDurn(String include_drugs_by_freq_durn) {
		this.include_drugs_by_freq_durn	=	include_drugs_by_freq_durn;
	}

// Method name getExcludeDrugsByFreqDurn changed to getIncludeDrugsByFreqDurn for SRR20056-CRF-0663
	public String getIncludeDrugsByFreqDurn(){
		return this.include_drugs_by_freq_durn;
	}
	public void setExcludePRNOrders(String exclude_PRN_orders) {
		this.exclude_PRN_orders	=	exclude_PRN_orders;
	}
	public String getExcludePRNOrders(){
		return this.exclude_PRN_orders;
	}

	public void setDrugMedical(String drug_medical) {
		this.drug_medical	=	drug_medical;
	}
	public String getDrugMedical(){
		return this.drug_medical;
	}

	public void setAlTrxOrderIds(ArrayList alTrxOrderIds) {
		this.alTrxOrderIds	=	alTrxOrderIds;
	}
	public ArrayList getAlTrxOrderIds(){
		return this.alTrxOrderIds;
	}

	public void setAlBMSOrderIds(ArrayList alBMSOrderIds) {
		this.alBMSOrderIds	=	alBMSOrderIds;
	}
	public ArrayList getAlBMSOrderIds(){
		return this.alBMSOrderIds;
	}

	public void clearAlTrxOrderIds(){
		alTrxOrderIds = new ArrayList();
	}

	public void clearAlBMSOrderIds(){
		alBMSOrderIds = new ArrayList();
	}
	
	public void setOrderID1(String orderID1){
		this.orderID1 = orderID1;
	}

	public String getOrderID1(){
		return orderID1;
	}

	public void setHmDispTMPForDeleteSales(HashMap hmDispTMPForDeleteSales){
		this.hmDispTMPForDeleteSales = hmDispTMPForDeleteSales;
	}

	public HashMap getHmDispTMPForDeleteSales(){
		return hmDispTMPForDeleteSales;
	}

	public void setBConsuableItemAvailable(boolean bConsuableItemAvailable) {
		this.bConsuableItemAvailable	=	bConsuableItemAvailable;
	}

	public boolean getBConsuableItemAvailable() {
		return this.bConsuableItemAvailable;
	}

	public void resetBConsuableItemAvailable(){
		this.bConsuableItemAvailable = false;
	}

	public boolean getBEditDispLabelAfterDisp(){
		return this.bEditDispLabelAfterDisp;
	}
//used for finding whether unallocated orders should be displayed in delivery stage or not
	public void setUnallocDrugs(String display_unallocDrugs){
		this.display_unallocDrugs = display_unallocDrugs;
	}

	public String geuUallocDrugs(){
		return display_unallocDrugs;
	}
	
	public void setRecCount(String recCount) {//Added for Bru-HIMS-CRF-416--start
		this.recCount	=	recCount;
	}	
	public String getRecCount() {
		return this.recCount;
	}
	
	public void setPatientclass(String patientclass) {
		this.patientclass	=	patientclass;
	}
	
	public String getPatientclass() {
		return this.patientclass;
	}
	public void setallPatients(ArrayList allPatients) {
		this.allPatients	=	allPatients;
	}
	
	public ArrayList getallPatients() {
		return this.allPatients;
	}//Added for Bru-HIMS-CRF-416--end
	
	public void setAllow_disp_record_lock_yn(String allow_disp_record_lock_yn){
		this.allow_disp_record_lock_yn = allow_disp_record_lock_yn;
	}

	public String getAllow_disp_record_lock_yn(){
		return allow_disp_record_lock_yn;
	}

	public void setUnlockAllRecordsYN(String unlock_all_records_yn){
		this.unlock_all_records_yn = unlock_all_records_yn;
	}

	public String geuUnlockAllRecordsYN(){
		return unlock_all_records_yn;
	}
	/*public void setIncludeZeroAllocQtyItems() throws Exception{
		Connection connection	= null ;
		PreparedStatement pstmt	= null ;
		ResultSet resultSet		= null;
		try {
				connection = getConnection() ;
		// SQL -> REP
			pstmt = connection.prepareStatement("select INCLUDE_ZERO_ALLOC_QTY_ITEMS FROM ph_facility_param where facility_id =? ") ;
				
				pstmt.setString(1,login_facility_id.trim());
			resultSet = pstmt.executeQuery() ;

		if ( resultSet != null && resultSet.next() ) {
					setStrIncludeZeroAllocQtyItems(resultSet.getString("INCLUDE_ZERO_ALLOC_QTY_ITEMS"));
				}
		}
		catch ( Exception e ) {
			System.err.println( "Error while selecting INCLUDE_ZERO_ALLOC_QTY_ITEMS from ph_facility_param " ) ;
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
	}*/
	public void setStrIncludeZeroAllocQtyItems(String strValue){
		this.strIncludeZeroAllocQtyItems = strValue;
	}

	public String getStrIncludeZeroAllocQtyItems(){
		return this.strIncludeZeroAllocQtyItems;
	}
//Adding start for ML-BRU-CRF-0473
	public void setStrIncludeZeroAllocQtyItemsForIP(String strValue){
		this.strIncludeZeroAllocQtyItemsForIP = strValue;
	}

	public String getStrIncludeZeroAllocQtyItemsForIP(){
		return this.strIncludeZeroAllocQtyItemsForIP;
	}
	//Adding end for ML-BRU-CRF-0473
	public void setDispencePeriod(String strDispLocationCode) throws Exception{
		HashMap hmDispensePeriod = getDispensePeriod(strDispLocationCode);

		if(hmDispensePeriod != null){
			setStrOPDispPeriod(hmDispensePeriod.get("OP_DISP_PERIOD")!=null?(String)hmDispensePeriod.get("OP_DISP_PERIOD"):"1");
			setStrIPFillPeriodAhead(hmDispensePeriod.get("IP_FILL_PRD_AHEAD")!=null?(String)hmDispensePeriod.get("IP_FILL_PRD_AHEAD"):"1");
			setStrIPFillPeriodUnit(hmDispensePeriod.get("IP_FILL_PRD_UNIT")!=null?(String)hmDispensePeriod.get("IP_FILL_PRD_UNIT"):"");
			
			setIPFillDispPeriod(hmDispensePeriod.get("IP_FILL_DISP_PRD")!=null?(String)hmDispensePeriod.get("IP_FILL_DISP_PRD"):"1");// added for SRR20056-CRF-0663
			setIPFillDispPeriodUnit(hmDispensePeriod.get("IP_FILL_DISP_PRD_UNIT")!=null?(String)hmDispensePeriod.get("IP_FILL_DISP_PRD_UNIT"):"");// added for SRR20056-CRF-0663 

			if(getDispLocnCode()!=null && getDispLocnCode().equals("I")){
				setStrChangedDispensePeriod(hmDispensePeriod.get("IP_FILL_PRD_AHEAD")!=null?(String)hmDispensePeriod.get("IP_FILL_PRD_AHEAD"):"1");
				setStrChangedDispenseUnit(hmDispensePeriod.get("IP_FILL_PRD_UNIT")!=null?(String)hmDispensePeriod.get("IP_FILL_PRD_UNIT"):"");
			}
			else if(getDispLocnCode()!=null && getDispLocnCode().equals("O")){
				setStrChangedDispensePeriod(hmDispensePeriod.get("OP_DISP_PERIOD")!=null?(String)hmDispensePeriod.get("OP_DISP_PERIOD"):"1");
				setStrChangedDispenseUnit("D"); // For out patient the default duration unit will be set as "Days". This may be changed in the system.
			}
		}
	}
	//public void settrade_codes(HashMap trade_codes){
	//	this.trade_codes = trade_codes;		
	//}
	public String gettrade_codes(String order_id,String order_line_num,String drug_code){	
		String trade_code="";
		if(trade_codes.containsKey(order_id+order_line_num+drug_code)){
			trade_code=(String)trade_codes.get(order_id+order_line_num+drug_code);
		}
		return trade_code;
	}

	// Clear the Additional Query Criteria values
	public void clearAdditionalCriteriaValues(){
		this.add_criteria_practitioner_name = null;
		this.add_criteria_practitioner_id = null;
		this.add_criteria_encounter_id	= null;
		this.add_criteria_order_type	= null;
	}
	
	public String getFillDateTime(){
		if(fill_date_time==null){
			fill_date_time=""; 
		}
		return this.fill_date_time;
	}
	
	public void setFillDateTime(String fill_date_time){
		this.fill_date_time = fill_date_time;
	}

	public String getWorksheetID(){
		return this.worksheet_id;
	}
	public String getAdmixtureIdentity(){
		return this.admixture_identity;
	}
	public void setAdmixtureIdentity(String admixture_identity){
		this.admixture_identity=admixture_identity;
	}
	public String getAdmixtureType(){
		return this.admixture_type;
	}
	public void setAdmixtureType(String admixture_type){
		this.admixture_type=admixture_type;
	}
	public String getWsType(){
		return this.ws_type;
	}
	public void setWsType(String ws_type){
		this.ws_type = ws_type;
	}
	public String getWsStatus(){
		return this.ws_status;
	}
	public String getDispLevelValue() {
		return this.disp_level;
	}
	public String getIPScope(){
		return this.ip_scope;
	}
	public void setIPScope(String ip_scope) {
		this.ip_scope	=	ip_scope;
	}
	public void setDispLevelValue(String disp_level) {
		this.disp_level	=	disp_level;
	}
	public void setWsStatus(String ws_status){
		this.ws_status = ws_status;
	}
	public void setMfgUnitDetails(ArrayList arr_list){		
		this.mfg_unit_details = arr_list;
	}
	public void setFillPeriod(String fill_period) {
		this.fill_period	=	fill_period;
	}
	public void setFillUnit(String fill_unit) {
		this.fill_unit	=	fill_unit;
	}
	public void setGender(String gender){
	
		this.gender = gender;
	}
	public String getGender() {
		return this.gender;
	}
	public String getFillUnit() {
		return this.fill_unit;
	}
	public String getFillPeriod() {
		return this.fill_period;
	}
	public ArrayList getMfgUnitDetails(){
		return this.mfg_unit_details;
	}
	public String getIPVerificationYN(){
		return this.ip_verification_yn;
	}
	public void setIPVerificationYN(String ip_verification_yn){
		this.ip_verification_yn = ip_verification_yn;
	}
	public String getTokenSeriesDescription(){
		return this.token_series_description;
	}
	public void setStoreCode(String store_code){
		this.store_code = store_code;
	}
	public String getStoreCode(){
		if(store_code==null){
			store_code="";
		}
		return this.store_code;
	}
	public void setFunctionIdentity(String function_identity){
		this.function_identity = function_identity;
	}
	public String getFunctionIdentity(){
		return this.function_identity;
	}
	public void setChkGroupByPatient(String chk_group_by_patient){
		this.chk_group_by_patient = chk_group_by_patient;
	}
	public String getChkGroupByPatient(){
		return this.chk_group_by_patient;
	}
	public void setSelectedPatientID(String selected_patient_id){
		this.selected_patient_id = selected_patient_id;
	}
	public String getSelectedPatientID(){
		return this.selected_patient_id;
	}
	public String getVersion() {
		return PhLicenceRights.getKey();
	}
	public String getKey() {
		return IVLicenceRights.getKey();
	}
	public ArrayList getPatientDetails() {
		return this.patient_details;
	}
	public void setOrderQty(String key,String order_qty) {
		this.order_qty.put(key,order_qty);
	}
	public String getOrderQty(String key) {
		String result	=	"";
		if(order_qty.containsKey(key))
			result	=	(String)order_qty.get(key);
		return result;
	}
	public HashMap getOrderQty() {
		return this.order_qty;
	}

	public HashMap getOrderIDOrderDate() {
		return this.order_id_modified_date;
	}

	public HashMap getorder_id_Attended_pract_id() {
		return this.order_id_Attended_pract_id;
	}
	public void setOrderIDOrderDate(){
	
		order_id_modified_date		= new HashMap(); 
	}

	public void setWorksheetID(String worksheet_id){
		this.worksheet_id=worksheet_id ;
	}

	public HashMap getOrder_id_amend_yn() {
			return this.order_id_amend_yn;

	}
	public void setOrder_id_amend_yn(){		
			order_id_amend_yn		= new HashMap(); 
	}

	public HashMap getWSFirstYN() {
		return this.ws_first_yn;
	}
	public void setDurationValue(String key, String duration_value) {
		this.duration_value.put(key,duration_value);
	}
	public String getDurationValue(String key) {
		String result	=	"";
		if(duration_value.containsKey(key))
			result	=	(String)duration_value.get(key);
		return result;
	}
	public HashMap getDurationValue() {
		return this.duration_value;
	}
	public void setReferral(String order_id, String order_line_num){
		refYnOrder = new HashMap();
		refYnOrder.put("order_id",order_id);
		refYnOrder.put("order_line_num",order_line_num);
		this.referralYnStatus.add(refYnOrder);
	}
	public void unsetReferral(){
		referralYnStatus=new ArrayList();
	}
	public ArrayList getReferral(){
		return this.referralYnStatus;
	}

	public void setQueueDate(String queue_date){
		this.queue_date = queue_date;
	}
	public String getQueueDate() {
		return this.queue_date;
	}
	public String getIssueByUOM() {
		return this.issue_by_uom;
	}
	public void setTrn_rx_ids_patientwise(HashMap trn_rx_ids_patientwise) {
		this.trn_rx_ids_patientwise	=	trn_rx_ids_patientwise;
	}
	public String getPatMobileNo(){//Adding start for TH-KW-0014
		return this.patient_mobile_no;
	}
	public void setPatMobileNo(String pat_mobile_no){
		this.patient_mobile_no = pat_mobile_no;
	}
	public void setPatNationalID(String national_id){
		this.patient_national_id =national_id;
	}
	public String getPatNationalID(){
		return this.patient_national_id;
	}
	//Adding end for TH-KW-0014

	public String getDispAutoRefresh(){//Adding start for TH-KW-0011
		return this.disp_auto_refresh;
	}
	public void setDispAutoRefresh(String auto_refresh){
		this.disp_auto_refresh = auto_refresh;
	}//Adding end for TH-KW-0011
	public String getDispGenralDrug(){//Adding start for Performance Issue by chandra 17072022
		return this.disp_genral_drug_yn ;
	}
	public void setDispGenralDrug( String disp_general_drug){
		this.disp_genral_drug_yn =disp_general_drug;
	}
	public String getDispNarcoDrug(){
		return this.disp_narco_drug_yn ;
	}
	public void setDispNarcoDrug( String disp_narco_drug){
		this.disp_narco_drug_yn =disp_narco_drug;
	}
	public String getDispControlDrug(){
		return this.disp_control_drug_yn ;
	}
	public void setDispControlDrug(String disp_control_drug){
		this.disp_control_drug_yn =disp_control_drug;
	}//Adding end for Performance Issue by chandra 17072022

	public void set2DBarcodeApplicable(String barcode_2d_appl){//Adding start for MMS-DM-CRF-0174.5
         this.barcode_2d_applicable_yn=barcode_2d_appl;
	}
   public String get2DBarcodeApplicable(){
	   return this.barcode_2d_applicable_yn;
   }//Adding end for MMS-DM-CRF-0174.5

	public HashMap storeRefDetails(String ref_facility_id,String ref_location,String ref_remarks,String order_id){
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		HashMap tabData = new HashMap() ;
		HashMap sqlMap = new HashMap() ;

		tabData.put( "properties", getProperties());
		tabData.put( "ref_facility_id", ref_facility_id);
		tabData.put( "ref_location",ref_location);
		tabData.put( "ref_remarks",ref_remarks);
		tabData.put( "order_id",order_id);
		tabData.put( "refyn_status",getReferral());
		tabData.put( "facility_id", login_facility_id.trim());
		tabData.put( "login_by_id", login_by_id.trim());
		tabData.put( "login_at_ws_no",login_at_ws_no.trim());
	
		try{
			sqlMap.put("SQL_PH_DISP_MEDICATION_REFERRAL_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_REFERRAL_ORDER_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_REFERRAL_ORDER_LINE_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_REFERRAL_ORDER_LINE_UPDATE1"));
			sqlMap.put("SQL_PH_OVERRIDE_BMS_SELECT2",PhRepository.getPhKeyValue("SQL_PH_OVERRIDE_BMS_SELECT2"));
			sqlMap.put("SQL_PH_OVERRIDE_BMS_UPDATE2",PhRepository.getPhKeyValue("SQL_PH_OVERRIDE_BMS_UPDATE2"));

 			/*InitialContext context = new InitialContext() ;
			Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION") ) ;
			home = (DispMedicationHome) PortableRemoteObject.narrow( object, DispMedicationHome.class ) ;
			remote = home.create() ;
			HashMap result = remote.insertRefDetails( tabData, sqlMap ) ; */
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION" ),DispMedicationHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);

			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;

			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();

			HashMap result = (HashMap)(busObj.getClass().getMethod("insertRefDetails",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);
			
			if( ((Boolean) result.get( "result" )).booleanValue() )	{
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
				map.put("flag","0");
			}
			else{
				map.put( "message", result.get("msgid") ) ;
				map.put("flag","0");
			}
		}
		catch(Exception e){
			e.printStackTrace();
			System.err.println("error in dispense tabData="+tabData);
		}
		map.put("flag","0");
		return map;
	}
		
	// This will be used if issue token is not applicable
	public void setDeliveryDetails(String collected_by,String gender,String nationality,String dispensed_by,String date_time,String Received_at,String practioner_id,String practioner_name){
		delivery_details = new ArrayList();
		delivery_details.add(collected_by);
		delivery_details.add(gender);
		delivery_details.add(nationality);
		delivery_details.add(dispensed_by);
		delivery_details.add(date_time);
		if(Received_at==null||Received_at.equals(""))
			Received_at="P";
		delivery_details.add(Received_at);
		if(practioner_id==null ||practioner_id.equals(""))
			practioner_id="";
		
		delivery_details.add(practioner_id);
		delivery_details.add(practioner_name);
		
	}
	// This will be used if issue token is applicable
	public void setDeliveryDetails(String collected_by,String gender,String nationality,String dispensed_by,String date_time,String token_series_code,String Received_at,String practioner_id,String practioner_name){
		delivery_details = new ArrayList();
		delivery_details.add(collected_by);
		delivery_details.add(gender);
		delivery_details.add(nationality);
		delivery_details.add(dispensed_by);
		delivery_details.add(date_time);
		delivery_details.add(token_series_code);
		
		if(Received_at==null|| Received_at.equals(""))
			Received_at="P";
		delivery_details.add(Received_at);
		if(practioner_id==null && practioner_id.equals(""))
			practioner_id="";
		delivery_details.add(practioner_id);
		delivery_details.add(practioner_name);
	}
	public ArrayList getDeliveryDetails(){
		return delivery_details;
	}
	public String getEncounterID(){
		return this.encounter_id;
	}
	public void setEncounterID(String encounter_id){
		this.encounter_id = encounter_id;
	}
	public String getFillProcessDate(){
		return this.fill_process_date;
	}
	public void setFillProcessDate(String fill_process_date){
		this.fill_process_date = fill_process_date;
	}
	public String getFillType(){
		return this.fill_type;
	}
	public void setFillType(String fill_type){
		this.fill_type = fill_type;
	}
	public String getFillProcessID(){
		return this.fill_process_id;
	}
	public void setFillProcessID(String fill_process_id){
		this.fill_process_id = fill_process_id;
	}
	public String getBatches(){
		return this.batches;
	}
	public void setBatches(String batches){
		this.batches = batches;
	}
	public String getOrderStatus(){
		return this.order_status;
	}
	public void setOrderStatus(String order_status){
		this.order_status = order_status;
	}
	public String getNursingUnit(){
		return this.nursing_unit;
	}
	public void setNursingUnit(String nursing_unit){
		this.nursing_unit = nursing_unit;
	}
	public String getOrdLocnType(){
		return this.ordlocntype;
	}
	public void setOrdLocnType(String ordlocntype){
		this.ordlocntype = ordlocntype;
	}
	public String getOrderBy(){
		return this.orderby;
	}
	public void setOrderBy(String orderby){
		this.orderby = orderby;
	}
	public String getUserName(){
		return this.user_name;
	}
	public void setUserName(String user_name){
		this.user_name = user_name;
	}
	/*
		The following two methods are used to get the dispense stage in 
		sequence depending on the conditions
	*/
	public String getStageDisplaySequence(){
		return this.stageDisplaySequence;
	}
	public void setStageDisplaySequence(String stageDisplaySequence){
		this.stageDisplaySequence = stageDisplaySequence;
	}

	/*	The following two methods are used to know whether filling is
		before allocation or after allocation...
	*/
	public String getFillingStatus(){
		return this.fillingStatus;
	}
	public void setFillingStatus(String fillingStatus){
		this.fillingStatus = fillingStatus;
	}
	//To set and get the password
	public String getPassword(){
		return this.password;
	}
	public void setPassword(String password){
		this.password = password;
	}
	public String getSource(){
		return this.source;
	}
	public void setSource(String source){
		this.source = source;
	}
	public void setObject(DispMedicationAllStages allStages) {
		objAllStages = allStages;
	}
	public void setObject(MedicationPlannerBean medplan_bean) { //Added for Bru-HIMS-CRF-072.1[IN 049144]
		this.medplan_bean = medplan_bean;
	}
	public String getTodaysDateTime(){
		return this.today_date_time;
	}
	public String getDate_plus_365(){
		return this.date_plus_365;
	}
	public String getDate_plus_30(){
		return this.date_plus_30;
	}
	public String getDate_minus_30(){
		return this.date_minus_30;
	}
	public String getTodaysDate(){
		return this.today_date ;
	}
	public String getFillList(){
		return fill_list;
	}
	public void setFillList(String fill_list){
		this.fill_list = fill_list;
	}
	public String getDispLocnName(){
		return this.disp_locn_name;
	}
	public void setDispLocnName(String disp_locn_name){
		this.disp_locn_name = disp_locn_name;
	}
	//Query Criteria Set and Get methods starts here
	public String getTokenNo(){
		return this.token_no ;
	}
	public void setTokenNo(String token_no){
		this.token_no = token_no;
	}
	public String getOrderDateFrom(){
		return this.order_date_from ;
	}
	public void setOrderDateFrom(String order_date_from){
		this.order_date_from = order_date_from;
	}
	public String getOrderDateTo(){
		return this.order_date_to ;
	}
	public void setOrderDateTo(String order_date_to){
		this.order_date_to = order_date_to;
	}
	public String getScope(){
		return this.scope ;
	}
	public void setScope(String scope){
		this.scope = scope;
	}
	public String getPriority(){
		return this.priority ;
	}
	public void setPriority(String priority){
		this.priority = priority;
	}
	public String getPatientID(){
		return this.patient_id ;
	}
	public void setPatientID(String patient_id){

		this.patient_id = patient_id;
	}
	public String getRelPatientID(){//Added for Bru-HIMS-CRF-416--start
		return this.relpatient_id ;
	}
	public void setRelPatientID(String relpatient_id){

		this.relpatient_id = relpatient_id;
	}
	public String getreleaseFlag(){
		return this.releaseflag ;
	}
	public void setreleaseFlag(String releaseflag){

		this.releaseflag = releaseflag;
	}	//Added for Bru-HIMS-CRF-416--end
	public String getOrderID(){
		if(this.order_id==null)
			return "";
		else
			return this.order_id ;
	}
	public void setOrderID(String order_id){
		this.order_id = order_id;
	}
	//Query Criteria Set and Get methods ends here
	public void setDispLocnCode(String disp_locn_code){
		this.disp_locn_code = disp_locn_code;
	}
	public String getDispLocnCode(){
		return disp_locn_code;
	}
	public void setFinalized_yn(String finalized_yn){
		this.finalized_yn = finalized_yn;
	}
	public String getFinalized_yn(){
		return finalized_yn;
	}	
	public void setIssueTokenOnRegnYN(String issue_token_on_regn_yn){
		this.issue_token_on_regn_yn = issue_token_on_regn_yn;
	}
	public String getIssueTokenOnRegnYN(){
		return issue_token_on_regn_yn;
	}
	public void setDispCashCollStage(String disp_cash_coll_stage){
		this.disp_cash_coll_stage = disp_cash_coll_stage;
	}
	public String getDispCashCollStage(){
		return this.disp_cash_coll_stage;
	}
	public void setDispBillStage(String disp_bill_stage){
		this.disp_bill_stage = disp_bill_stage;
	}
	public String getDispBillStage(){
		return this.disp_bill_stage;
	}
	public void setChargePatForSpillQtyYN(String charge_pat_for_spill_qty_yn){
		this.charge_pat_for_spill_qty_yn = charge_pat_for_spill_qty_yn;
	}
	public String getChargePatForSpillQtyYN(){
		return this.charge_pat_for_spill_qty_yn;
	}
	public void setDispRegnReqdYN(String disp_regn_reqd_yn){
		disp_regn_reqd_yn = disp_regn_reqd_yn;
	}
	public String getDispRegnReqdYN(){
		return disp_regn_reqd_yn;
	}
	public void setDispStage(String disp_stage){
		this.disp_stage=disp_stage;
	}
	public String getDispStage(){
		return disp_stage;
	}
	//SKR-SCF-0611 [IN:034816] - Begin
	public void setDispMedStages(String disp_med_stages){
		this.disp_med_stages.add(disp_med_stages);
	}
	public ArrayList  getDispMedStages(){
		return disp_med_stages;
	}
	public void clearDispMedStageDetails() {
		this.disp_med_stages.clear();
	}
	//SKR-SCF-0611 [IN:034816] - End
	public void setDispLocnCatg(String disp_locn_catg){
		this.disp_locn_catg = disp_locn_catg;
	}
	public String getDispLocnCatg(){
		return disp_locn_catg;
	}
	public void setVerfCombinedWithAlloc(String verf_combined_with_alloc){
		this.verf_combined_with_alloc = verf_combined_with_alloc;
	}
	public String getVerfCombinedWithAlloc(){
		return verf_combined_with_alloc;
	}

	public void setTokenSeriesCode(String token_series_code){
		this.token_series_code = token_series_code;
	}
	public String getTokenSeriesCode(){
		return token_series_code;
	}
	
	public void setAmendAltDrugDtlYN(String amend_alt_drug_dtl_yn){  // JD-CRF-0198 [IN058599] - Start
		this.amend_alt_drug_dtl_yn = amend_alt_drug_dtl_yn;
	}
	
	public String getAmendAltDrugDtlYN(){  
		return this.amend_alt_drug_dtl_yn;
	}                                                            // JD-CRF-0198 [IN058599] - End
	
	public void clearDeliveryDetails() {
		this.delivery_details.clear(); //changed from new ArrayList() for SKR-SCF-0611 [IN:034816] 
	}
	//KDAH-CRF-0231 [IN-034551] - Barcode CRF Changes. - Start
	public void setBarcode_Scan_YN(String barcode_scan_yn){
	    this.barcode_scan_yn=barcode_scan_yn;
	}
	
	public String getBarcode_Scan_YN(){
	    return this.barcode_scan_yn;
	}
	
	public void getBarCodeflg(String facilityid,String disp_locn){
	    Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		String barcodeflg	= "";
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement("select bar_code_scan_yn from ph_disp_locn where facility_id=? and disp_locn_code=? ");
			pstmt.setString(1,facilityid);
			pstmt.setString(2,disp_locn);
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
			    barcodeflg = resultSet.getString("bar_code_scan_yn") == null ? "N":resultSet.getString("bar_code_scan_yn");
			    setBarcode_Scan_YN(barcodeflg);
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				 es.printStackTrace();
			}
		}
	}
	
	public void setStockDtl(HashMap stockdtl){
	    this.stockdtl=stockdtl;
	}
	
	public void setStockDtlKey(String key,String value){//Added for KDAH-CRF-0231 [IN-034551].
	    this.stockdtl.put(key, value);
	}
	public HashMap getStockDtl(){
	    return stockdtl;
	}
	//Added for KDAH-CRF-0231 [IN-034551].	
	public void setTempStockDtls(HashMap tempStockDtls){
	    	this.tempStockDtls=tempStockDtls;
	}
	
	public HashMap getTempStockDtls(){
	    return tempStockDtls;
	}
	//Added for KDAH-CRF-0231 [IN-034551].	
	public void setBatch_val(ArrayList batch_val){
	    this.batch_val.add(batch_val);
	}
	
	public ArrayList getBatch_val(){
	    return batch_val;
	}
	public void setBarCodesForDrug(String key, String temp_barcode){
		ArrayList tmpBarcodeList;
		if(hmBarCodesForDrug.containsKey(key))
			tmpBarcodeList = (ArrayList)hmBarCodesForDrug.get(key);
		else
			tmpBarcodeList = new ArrayList();
		if(!tmpBarcodeList.contains(temp_barcode))
			tmpBarcodeList.add(temp_barcode);
	    this.hmBarCodesForDrug.put(key, tmpBarcodeList);
	}
	
	public ArrayList getBarCodesForDrug( String key){
	    return (ArrayList)hmBarCodesForDrug.get(key);
	}
	public HashMap getBarCodesForDrug( ){
	    return hmBarCodesForDrug;
	}

	public void setBarcode_id(String barcode_batch_id){
	    this.barcode_batch_id=barcode_batch_id;
	}
	
	public String getBarcode_id(){
	    return barcode_batch_id;
	}
	public void setOrderDrugdtl(String orderdrugdtl){
	    this.orderdrugdtl.add(orderdrugdtl);
	}
	
	public void setScannedBarcode_id(String order_id,String order_line_no,String scanned_barcode_id){ // Added fro GHL-CRF-0463 - Start // changed for MMS-DM-SCF-0488
	    this.scanned_barcode_id.put(order_id+"_"+order_line_no, scanned_barcode_id);
	}
	public String getScannedBarcode_id(String order_id,String order_line_no){ // changed for MMS-DM-SCF-0488
	   return  (String)(scanned_barcode_id.get(order_id+"_"+order_line_no)==null?"":scanned_barcode_id.get(order_id+"_"+order_line_no));
	} // Added fro GHL-CRF-0463 - End 
	public ArrayList getOrderDrugdtl(){
	    return orderdrugdtl;
	}
	
	public void setDrugQty(String drugqty){
	    this.drugqty.add(drugqty);
	}
	
	public HashSet getDrugQty(){
	    return drugqty;
	}
	//Added for Bru-HIMS-CRF-076 [IN:034551]
	public void setBarcode_multi_id(String barcode_multi_id){
	    this.barcode_multi_id=barcode_multi_id;
	}
	
	public String getBarcode_multi_id(){
	    return barcode_multi_id;
	}
	//KDAH-CRF-0231 [IN-034551] - Barcode CRF Changes. - End
	//Added for MMS-DM-CRF-0157.1
	public void setBarCodeScanedData(String key, String entry_type){
	    this.hmbarcodescan.put(key, entry_type);
	}
	public HashMap getBarCodeScanedData( ){
	    return hmbarcodescan;
	}
	public void setManualBarcodeRemarks(HashMap barCodeRemakrs){
		manualBarcodeRemarks.add(barCodeRemakrs);
	}
	public ArrayList getManualBarcodeRemarks()
	{
		return manualBarcodeRemarks;
	}
	public void setBarcodeSiteYN(Connection con){
	    //this.hmbarcodescan.put(key, entry_type);
		 boolean barcode_scan_count_site = eCommon.Common.CommonBean.isSiteSpecific(con, "AM","BARCODE_SCANNING_APPLICABLE");
		 if(barcode_scan_count_site)
				{
					bar_code_scan_site_YN = "Y";
				}
				else
				{
					bar_code_scan_site_YN = "N";
				}
	}
	public String getBarcodeSiteYN( ){
	    return bar_code_scan_site_YN;
	}
	//Adding end for MMS-DM-CRF-0157.1
	public void set2DBarCodeForDrug(String key, String temp_barcode){//Adding start for MMS-DM-CRF-0174.5
		String drug_2d_barcode ="";
		if(!hm2DBarCodes.containsKey(key))		
	      this.hm2DBarCodes.put(key, temp_barcode);
	}
	public HashMap get2DBarCodeForDrug(){
		 return  hm2DBarCodes;
	}//Adding end for MMS-DM-CRF-0174.5
	   
	
	/* Over-ridden Adapter methods start here */
	public void clear() {
		disp_locn_details			= "";
		disp_locn_code				= "";
		issue_token_on_regn_yn		= "";
		disp_stage					= "";
		disp_locn_catg				= "";
		verf_combined_with_alloc	= "";
		token_series_code			= "";
		ApplicableStagesForTheUser	= "";
		password					= "";
		stock_installed				= false;
		ws_allocate_batches			= new Hashtable();
		ws_allocated_qty			= new Hashtable();
		ws_allocate_batches			= new Hashtable();
		ws_allocated_qty			= new Hashtable();
		ws_drug_details				= new ArrayList();
		ht_drug_details				= new Hashtable();
		ht_ws_allocated_drugs		= new HashMap();
		ht_ws_allocate_batches		= new Hashtable();
		ht_ws_allocated_qty			= new Hashtable();		
		ht_ws_fluid_allocate_batches= new Hashtable();
		VERIFY_REMARKS				= new HashMap();
		mfg_unit_details			= new ArrayList();		
		stock_qty					= "";
		stock_qty_uom				= "";
		patient_details				= new ArrayList();
		delivery_details			= new ArrayList();
		disp_level					= ""; 		
		fill_period					= ""; 
		fill_unit					= ""; 
		order_qty					= new HashMap(); 
		duration_value				= new HashMap(); 
		order_id_modified_date		= new HashMap(); 
		order_id_Attended_pract_id = new HashMap();
		patient_locator				= new ArrayList();
		deliver_dtls_set			= "N";
		admixture_type				= "";
		scope						="";
		trade_codes					= new HashMap(); 
		billing_det					="";
		ws_first_yn					= new HashMap();
		super.clear() ;
		strOPDispPeriod				= "";
		strIPFillPeriodAhead		= "";
		strIPFillPeriodUnit			= "";
		strChangedDispensePeriod = "";
		strChangedDispenseUnit	= "";
		hmAllowMoreQty				= new HashMap();
		patient_id					= "";
		relpatient_id = 			"";//Added for Bru-HIMS-CRF-416
		releaseflag = 				"";//Added for Bru-HIMS-CRF-416
		hmPPNValues					= null;
		clearAlOrderLineDataForEditLables();
		trn_rx_ids_patientwise		= new HashMap();
		bEditDispLabelAfterDisp = false;
		bValuesChanged = false;
		blDocSrlNo = "";
		print_seq_no = "";
		FillPersonNameYN = "Y";
		includeBMSDefCheck_yn = "";
		editableLabelLangId = ""; //Added for Bru-HIMS-CRF-414- ML-BRU-SCF-1454 [IN:052271]
		amend_alt_drug_dtl_yn = "";//added for JD-CRF-0198
		alt_generic_id        = "";//added for JD-CRF-0198
		order_status_1        = "";//added for JD-CRF-0198
		batchDetailsForBarcodeDrug	= new ArrayList();//added for GHL-CRF-0413.1 [IN:061794]
		printValue			= new HashMap();//added for GHL-CRF-453
		printValueForOrders = new HashMap();//added for GHL-CRF-453
		barcodeColorYn = new HashMap(); // Added for MMS-DM-SCF-0488
		add_criteria_nat_desc="";//ARYU-SCF-0073
		locnCode = ""; // Added for BSP-SCF-0060
		form_codes= new HashMap(); // Added for MMS-KH-CRF-0013
		form_descs= new HashMap(); // Added for MMS-KH-CRF-0013
		approvalNo = new HashMap();//added for AAKH-CRF-0117
		hmbarcodescan = new HashMap();//Added for MMS-DM-CRF-0157.1
		manualBarcodeRemarks   =new ArrayList();//Added for MMS-DM-CRF-157.1
		iqvia_integration_yn = "";  //MOHE-CRF-0026.1 
		patient_national_id  ="";//Added for TH-KW-CRF-0014
        patient_mobile_no    ="";//Added for TH-KW-CRF-0014
        disp_genral_drug_yn ="";//Added for Performance Issue by chandra 17072022
        disp_narco_drug_yn ="";//Added for Performance Issue by chandra 17072022
        disp_control_drug_yn ="";//Added for Performance Issue by chandra 17072022
        disp_before_start_date_yn="";//Added for COMMON-ICN-0116 [39681]
    	disp_before_no_of_days="";//Added for COMMON-ICN-0116 [39681]
    	disp_beyond_earliest_start_yn="";//Added for COMMON-ICN-0116 [39681]
    	disp_beyond_no_of_days="";//Added for COMMON-ICN-0116 [39681]
		hm2DBarCodes =new HashMap();//Added for MMS-DM-CRF-0174.5
	}

	public void clearonrefresh(){ 
		ht_ws_allocate_batches		= new Hashtable();	
		ws_allocate_batches			= new Hashtable();
		ht_ws_allocated_qty			= new Hashtable();
		ht_drug_details = new Hashtable();
		VERIFY_REMARKS				= new HashMap();
		ht_ws_allocated_drugs		= new HashMap();
		worksheet_id				= "";
		admixture_type				= "";	
		trade_codes					= new HashMap(); 
		billing_det				= "";
		ws_first_yn					= new HashMap();
		pa_ord_sel_ht				= new Hashtable();
		hmOrderLineNumbers			= new HashMap();
		strOPDispPeriod				= "";
		strIPFillPeriodAhead		= "";
		strIPFillPeriodUnit			= "";
		strChangedDispensePeriod = "";
		strChangedDispenseUnit	= "";
		hmAllowMoreQty				= new HashMap();
		patient_id					= "";
		relpatient_id				="";//Added for Bru-HIMS-CRF-416
		releaseflag					="";//Added for Bru-HIMS-CRF-416
		hmPPNValues					= null;
		//clearAlOrderLineDataForEditLables(); commented for ML-BRU-SCF-1872.1
		trn_rx_ids_patientwise		= new HashMap();
		blDocSrlNo = "";
		print_seq_no="";
		alt_generic_id        = "";//added for JD-CRF-0198
		order_status_1        = "";//added for JD-CRF-0198
		scanned_barcode_id =new HashMap(); // Added for GHL-CRF-0463 // "" changed to new HashMap() for MMS-DM-SCF-0488
		barcode_batch_id =""; // Added for GHL-CRF-0463
		hm2DBarCodes = new HashMap();//Added for MMS-DM-CRF-0174.5
	}

	public void clearCriteriaValues() {
		gender							= "";
		add_criteria_locn_code		= "";
		add_criteria_locn_desc		= "";
		add_criteria_practitioner_name	= "";
		add_criteria_practitioner_id	= "";
		add_criteria_encounter_id	= "";
		add_criteria_order_type			= "";
		add_criteria_nat_code			= "";
		add_criteria_nat_desc="";//ARYU-SCF-0073
		ip_scope						= "";
		trade_codes						= new HashMap(); 
		clearAlOrderLineDataForEditLables();
	}

	private void doCommon() throws Exception {
	}
	/* Over-ridden Adapter methods end here */
/*	The method setDispLocnDetails() is used to store dispense location code,short desc,issue token on regn (Y/N)
	Format :--> disp_locn_code,short_desc,issue_token_on_regn_yn|disp_locn_code,short_desc,issue_token_on_regn_yn|........*/
	public void setDispLocnDetails(String disp_locn_details){
		this.disp_locn_details = disp_locn_details;
	}
	public String getDispLocnDetails(){
		return 	disp_locn_details;
	}

	public HashMap validate() throws Exception {
		HashMap map=new HashMap();
		map.put( "result", new Boolean( true ) ) ;
		map.put( "message", "success.." ) ;
		return map;
	}

	// setAll method to set all the values
	public void setAll(Hashtable recordSet) {
		if(recordSet.containsKey("mode")){
			setMode(((String)recordSet.get("mode")).trim()) ;
		}
		if(recordSet.containsKey("disp_stage")){
			disp_stage_identity = (String)recordSet.get("disp_stage");
			if(disp_stage_identity.equals("V")){				//	Verification stage
				forVerification = recordSet;
			}
			else if(disp_stage_identity.equals("A")){			//	Allocation stage
				forAllocation = recordSet;
			}
			else if(disp_stage_identity.equals("F")){			// Filling stage
				forFilling		= recordSet;
				forAllocation	=	forFilling;
			}
			else if(disp_stage_identity.equals("D")){			
				// Delivery stage
				if(getFillList().equals("DWF") ){
					forFillDelivery = recordSet;
				}
				else{
					forDelivery = recordSet;
				}
			}
			/*else if(disp_stage_identity.equals("AS")){			// All stages
				forDispense = recordSet;
			}*/
		}
	}

	public HashMap modify() {
		Connection connection	= null;// added for ML-MMOH-CRF-0468
		
		HashMap map=new HashMap();
		if(alSalDocDtls !=null && alSalDocDtls.size()>0)//Added for MMS-RY-SCF-0088
		alSalDocDtls.clear(); //added for AMS-CRF-0079 [IN:050762] -start
		try{
		/*	Admixture Type
				S	-	Standard Regimen
				C	- Cyto Admixture
				I	-	IV Admixture
				T	-	Non-Standard Regimen*/

		//String allocated_status = getAllocatedStatus();
			 connection = getConnection() ;// added for ML-MMOH-CRF-0468
			boolean siteTpn = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","TPN_MF_LABEL");// added for ML-MMOH-CRF-0468
			String login_id=login_by_id;  // Added for RUT-CRF-0035 [IN029926]
			if("Y".equals(objAllStages.getUserAuthPINRequiredYN())){  // Added for RUT-CRF-0035 [IN029926] - Based on this flag, the User ID Captured with PIN will be updated
				login_by_id=objAllStages.getAuthUserID();
				if(getDeliveryDetails()!=null && getDeliveryDetails().size()>0)
					getDeliveryDetails().set(3,login_by_id); // Added for RUT-SCF-0274 IN039740
			}
			if(disp_stage_identity.equals("A")){		//	Allocation
				if(getAdmixtureType().equals("TD") || getAdmixtureType().equals("")){
					map = completeAllocation();
				}
				else if(getAdmixtureType().equals("TA")){
					map = completeTPNWSAllocation();
				}
				else{
					map = completeWSAllocation();
				}
			}
			else if(disp_stage_identity.equals("F")){	// Filling
				if(getAdmixtureType().equals("TD") || getAdmixtureType().equals("") ){
					//if else condtion is added for ml-mmoh-crf-0468
					if(siteTpn && getAdmixtureType().equals("TD")){
						map = completeTPNWSAllocation();
					}
					else{
						map = completeFilling();
					}
					
				}
				else if(getAdmixtureType().equals("TA")){
					map = completeTPNWSAllocation();
				}
				else{
					map = completeWSAllocation();
				}
			}
			else if(disp_stage_identity.equals("V")){	// Verification
				map = completeVerification();
			}
			else if(disp_stage_identity.equals("D")){	// Delivery
				// if order type is TA then invoke a new function 
				if(getOrderType().equals("TA")){
					map = completeTPNDelivery();
				}
				if(siteTpn && getOrderType().equals("TD")){//if condtion added for ML-MMOH-SCF-1304
					map = completeTPNDelivery();
				}
				else if(getFillList().equals("DWF") ){
					map = completeFillDelivery();
				}
				else{
					map = completeDelivery();
				}
			}
			if("Y".equals(objAllStages.getUserAuthPINRequiredYN())){  // Added for RUT-CRF-0035 [IN029926] 
				login_by_id=login_id;
			}
			Boolean result = (Boolean)map.get("result");
			if(result && objAllStages != null){
				objAllStages.clear();
				if(delivery_details!=null)
					delivery_details.clear();// clear delivery details
			}
		}
		catch (Exception e12){
			e12.printStackTrace();
		}
		//Added for ML-MMOH-CRF-0468 START
		finally{
			try {
				closeConnection( connection );
			} catch (Exception e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			}
		//Added for ML-MMOH-CRF-0468 end
		return map;
	}

	/* Through this method Verification transaction will be completed...
		In this stage either prescriptions can be put	1. on hold	2. verified.	*/
	public HashMap completeVerification(){
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;

		boolean no_records_to_verify = true;
//		DispMedicationHome home=null;
//		DispMedicationRemote remote=null;
		try{
			ArrayList orderLineData = new ArrayList() ;
			ArrayList orderLineData1 = new ArrayList() ;
			ArrayList patientDrugProfileData = new ArrayList() ;
			for(int i=0;i<forVerification.size();i++){
				if(forVerification.containsKey("order_line_num"+(i+1)) &&((String)forVerification.get("verifyChecked_"+(i+1))).equals("Y") && (((String)forVerification.get("ALLERGY_VALUE"+(i+1))).equals("Y") &&
						((String)forVerification.get("DOSELIMIT_VALUE"+(i+1))).equals("Y") &&
						((String)forVerification.get("CURRENTRX_VALUE"+(i+1))).equals("Y") && ((String)forVerification.get("INTARACTION_VALUE"+(i+1))).equals("Y"))  ){ // ((String)forVerification.get("verifyChecked_"+(i+1))).equals("Y")) Added for MMS-KH-CRF-0028 [IN070605]
						//&& ((String)forVerification.get("INTARACTION_VALUE"+(i+1))).equals("Y"))
					if(forVerification.get("hold"+(i+1))==null || ((String)forVerification.get("hold"+(i+1))).equals("")){
						orderLineData.add("N");					// N - Not on hold
						patientDrugProfileData.add("N");
						no_records_to_verify = false;
					}
					else{
						if(!((String)forVerification.get("fromdb_"+(i+1))).equals("Y")){
							no_records_to_verify = false;
						}
						orderLineData.add("Y");					// Y - On hold
						patientDrugProfileData.add("Y");
					}

					orderLineData.add(login_by_id.trim());
					patientDrugProfileData.add(login_by_id.trim());
					ArrayList reason = objAllStages.getBeanReason((i+1)+"");
					if(reason.size()>=2){
						patientDrugProfileData.add((String)reason.get(1));
						orderLineData.add((String)reason.get(2));
					}
					else{
						patientDrugProfileData.add("");
						orderLineData.add("");
					}
					patientDrugProfileData.add((String)forVerification.get("patient_id"));
												
					if(disp_level.equals("P")) {
						orderLineData.add((String)forVerification.get("order_id"+(i+1)));
						patientDrugProfileData.add((String)forVerification.get("order_id"+(i+1)));
					}
					else {
						orderLineData.add((String)forVerification.get("order_id"));
						patientDrugProfileData.add((String)forVerification.get("order_id"));
					}
					orderLineData.add((String)forVerification.get("order_line_num"+(i+1)));
					patientDrugProfileData.add((String)forVerification.get("order_line_num"+(i+1)));
 
					orderLineData.add("N");				
					//orderLineData.add("N");				//added for taper order   //Commented for RUT-CRF-0088 [IN036978] 
					if(forVerification.containsKey("pat_reqd_"+(i+1))){
						if(((String)forVerification.get("pat_reqd_"+(i+1))).trim().equals("C")){
							orderLineData1.add((String)forVerification.get("pat_reqd_"+(i+1))==null?"":(String)forVerification.get("pat_reqd_"+(i+1)));	
							if(disp_level.equals("P")) {
								orderLineData1.add((String)forVerification.get("order_id"+(i+1)));
							}
							else {
								orderLineData1.add((String)forVerification.get("order_id"));
							}
							orderLineData1.add((String)forVerification.get("order_line_num"+(i+1)));
						}
					}
				}
			}
			if(no_records_to_verify){
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", "APP-PH0162 Record(s) cannot be verified being on hold..." ) ;
				map.put("flag","0");
			}
			else{
				HashMap tabData = new HashMap() ;
				tabData.put( "properties", getProperties());
				tabData.put( "disp_stage", getDispStage());
				tabData.put( "today",getTodaysDate());
				tabData.put( "dateTime",getTodaysDateTime());
				tabData.put( "orderLineData", orderLineData );
				tabData.put( "orderLineData1", orderLineData1 );
				tabData.put( "patientDrugProfileData", patientDrugProfileData );
				tabData.put( "facility_id", login_facility_id.trim() );
				tabData.put( "login_by_id", login_by_id.trim() );
				tabData.put( "login_at_ws_no",login_at_ws_no.trim());
				tabData.put("funct_role_id",getFunctRollID( login_by_id));
				tabData.put( "disp_locn_code", getDispLocnCode().trim() );
				tabData.put("token_yn",issue_token_on_regn_yn);
				tabData.put("Token_Queue_date",this.queue_date);
				tabData.put("token_series_code",getTokenSeriesCode());
				tabData.put("token_vals",objAllStages.getTokenVals());
				tabData.put( "patient_class", getDispLocnCatg().trim() );
				tabData.put( "source_code",forVerification.get("source_code"));
				tabData.put( "source_type",forVerification.get("source_type"));
				tabData.put( "ordering_facility_id",forVerification.get("ordering_facility_id"));
				tabData.put( "ord_date_time",forVerification.get("ord_date_time"));
				tabData.put( "dateTime",getTodaysDateTime());
				tabData.put( "today",getTodaysDate());
				tabData.put( "performing_pract_id",forVerification.get("performing_pract_id"));
				tabData.put( "patient_id", forVerification.get("patient_id"));
				tabData.put( "encounter_id", forVerification.get("encounter_id"));
				tabData.put( "delivery_applicable", getDeliveryApplicable()); //checkDeliveryApplicability
				tabData.put( "verify_remarks", this.getverifyremarks());
				tabData.put( "LanguageId",getLanguageId());
				tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
				tabData.put("BL_REASONS", objAllStages.getBiilingReasonDetails());
				tabData.put("ORDER_ID_ORDER_DATE",getOrderIDOrderDate());
				tabData.put("IPFillProcess",getFillUnit());
				tabData.put("IPFillPeriodAhead",getFillPeriod());
				tabData.put( "alloc_bms_chk", new HashMap());
				tabData.put("p_user_name",getUserName());//Added for ML-BRU-SCF-0418[Inc:35081 Reopen]
				tabData.put("dispMedStages",getDispMedStages());//Added for //added for SKR-SCF-0611 [IN:034816]

				HashMap sqlMap = new HashMap() ;
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE2"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE3",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE3"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE4",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE4"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE5",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE5"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE6",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE6"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE7",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE7"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE8",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE8"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE9",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE9"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE10",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE10"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE11",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE11"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE14",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE14"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1"));
				sqlMap.put("SQL_PH_TDM_PRES_SELECT3",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT3"));
				sqlMap.put("SQL_PH_TDM_PRES_SELECT4",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT4"));
				sqlMap.put("SQL_PH_TDM_PRES_SELECT5",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT5"));
				sqlMap.put("SQL_PH_IVPRESCRIPTION_INSERT1",PhRepository.getPhKeyValue("SQL_PH_IVPRESCRIPTION_INSERT1"));
				sqlMap.put("SQL_PH_PRESCRIPTION_SELECT37",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT37"));
				sqlMap.put("SQL_PH_TDM_PRES_SELECT6",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT6"));
				sqlMap.put("SQL_PH_PRESCRIPTION_INSERT2",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_INSERT2"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT145",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT145"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE1",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE1"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT148",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT148"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE_VERIFY_REMARKS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE_VERIFY_REMARKS"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT152",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT152"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2A",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2A"));

				//alloc_bms_check
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT162","SELECT ORDER_CATALOG_CODE, ORDER_UOM FROM OR_ORDER_LINE WHERE ORDER_ID = ? AND ORDER_LINE_NUM=?");
				/*InitialContext context = new InitialContext() ;
				Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION") ) ;
				home = (DispMedicationHome) PortableRemoteObject.narrow( object, DispMedicationHome.class ) ;
				remote = home.create() ;
				HashMap result = remote.modify( tabData, sqlMap ) ;*/
				Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION" ),DispMedicationHome.class,getLocalEJB());
				Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
				Object argArray[] = new Object[2];
				argArray[0] = tabData;
				argArray[1] = sqlMap;

				Class [] paramArray = new Class[2];
				paramArray[0] = tabData.getClass(); ;
				paramArray[1] = sqlMap.getClass();

				HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
				(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);

				if( ((Boolean) result.get( "result" )).booleanValue() )	{
					map.put( "result", new Boolean( true ) ) ;
					map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
					map.put("flag","0");
				}
				else{
					String msg_id= (String)result.get("msgid");
					msg_id=msg_id.substring(24,(msg_id.length()));
					if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
						map.put( "message", getMessage(getLanguageId(),msg_id,"PH") ) ;
					}
					else{
						msg_id= (String)result.get("msgid");
						msg_id = msg_id.replace("javax.ejb.EJBException:","");
						map.put( "message", msg_id ) ;
					}
					map.put("flag","0");
				}
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		return map;
	}

	public HashMap completeFilling() {
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		map = completeAllocation();
		return map;
	}
	/*	Through this allocation transaction will be completed
		In this stage prescriptions can be put
							1. on hold
							2. allocated
							3. no action .	*/
	public HashMap completeAllocation(){
		System.out.println("@@@ ML-MMOH-SCF-2496 DispMedicationBean.java-CompleteAllocation() Start :"+getTodaysDateTime());
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		HashMap tabData = new HashMap() ;
		ArrayList patientDrugProfileData	= new ArrayList() ;
		ArrayList dispTMP					= new ArrayList();	
		Connection connection	= null; // Added for MMS-KH-CRF-0028 [IN070605]
		boolean validate_order_yn = false; // Added for MMS-KH-CRF-0028 [IN070605]
		try{
			ArrayList orderLineData				= new ArrayList() ;
			ArrayList orderLineData1			= new ArrayList() ;
			ArrayList alDispTMPForDeleteSales	= new ArrayList();
			HashMap alloc						= new HashMap();
			ArrayList unique_orders				= new ArrayList();
			ArrayList reason					= null;
			HashMap complete_status = new HashMap();
			HashMap complete_order_reason = new HashMap();
			HashMap alloc_complete_status		= new HashMap();
			ArrayList resultStatusFlags			= new ArrayList();
			ArrayList not_allocated				= new ArrayList();
			String order_id						= "";
			String order_line_num				= "";
			HashMap alloc_bms_chk				= new HashMap();
			ArrayList alBMSOrderValues			= null;
			HashMap hmBMSValues					= new HashMap();
			String sBMSQty						= "0";
			HashMap alloc_bms_chk_val 			=new HashMap();
			String alloc_bms_chk_val_temp	="";
			String ivprep = ""; //added for SKR-SCF-1319 
			try{ // Added for MMS-KH-CRF-0028 [IN070605] - Start
			    connection = getConnection() ;
			    validate_order_yn = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","DISP_STAGE_INTRACTN_REQ_YN");
			}
			catch (Exception e) {
				e.printStackTrace();
			}
			finally{
				closeConnection(connection);
			} // Added for MMS-KH-CRF-0028 [IN070605] - End
			//String tapered_yn, taper_order_id, taper_order_line_num, taper_order;   //Commented for RUT-CRF-0088 [IN036978] 
			//int taperorderIndx=-1;  Removed for IN063877
			String temp_OrderId, temp_DrugReson, complete_order;// added for incident No:32227
			for(int i=0;i<forAllocation.size();i++){
				if(forAllocation.containsKey("order_line_num"+(i+1)) && (!validate_order_yn || !fill_list.equals("WF") || (!forAllocation.get("iv_prep_yn").equals("")) ||(validate_order_yn && ((String)forAllocation.get("print_"+(i+1))).equals("Y")))){ // && ((validate_order_yn && ((String)forAllocation.get("print_"+(i+1))).equals("Y")) || !validate_order_yn) Added for MMS-KH-CRF-0028 [IN070605]
					if(disp_level.equals("P")) {
						order_id =(String)forAllocation.get("order_id"+(i+1));
					} 
					else {
						order_id =(String)forAllocation.get("order_id");
					}
					//code added for 25825 by naveen on 11jan2011
					temp_DrugReson = forAllocation.get("ComplteOrderReason"+(i+1))==null?"":(String)forAllocation.get("ComplteOrderReason"+(i+1)); // added for incident No:32227
					complete_order =  forAllocation.get("CompleteOrder"+(i+1))==null?"":(String)forAllocation.get("CompleteOrder"+(i+1)); // added for incident No:32227
					/* Commented for RUT-CRF-0088 [IN036978]
					 * tapered_yn =forAllocation.get("taper_order_yn"+(i+1))==null?"":(String)forAllocation.get("taper_order_yn"+(i+1));
					taper_order_id=forAllocation.get("taper_order_id"+(i+1))==null?"":(String)forAllocation.get("taper_order_id"+(i+1));
					taper_order_line_num =forAllocation.get("taper_order_line_num"+(i+1))==null?"":(String)forAllocation.get("taper_order_line_num"+(i+1));
					taper_order="N";
					if(tapered_yn.equals("Y") && !taper_order_id.equals("") && !taper_order_line_num.equals("")){
						for(int ordL=0; ordL<orderLineData.size();ordL+=7){
							if(((String)orderLineData.get(ordL+3)).equals(taper_order_id) && ((String)orderLineData.get(ordL+4)).equals(taper_order_line_num)){
								taper_order="Y";
								break;
							}
						}
					}*/
					if(forAllocation.containsKey("alloc_bms_chk_"+(i+1))){
						alloc_bms_chk_val_temp =(String)forAllocation.get("alloc_bms_chk_"+(i+1));// Added for [IN:045295] start
						if(disp_level.equals("P") && alloc_bms_chk_val_temp.equals("Y")) {
							alloc_bms_chk_val.put(((String)forAllocation.get("order_id"+(i+1)))+((String)forAllocation.get("order_line_num"+(i+1))),"Y");
						}
						else{
							alloc_bms_chk_val.put(((String)forAllocation.get("order_id")+(i+1))+((String)forAllocation.get("order_line_num"+(i+1))),"N");
						}
					}
					else{
						alloc_bms_chk_val.put(((String)forAllocation.get("order_id"+(i+1)))+((String)forAllocation.get("order_line_num"+(i+1))),"N");
					} // Added for [IN:045295] end
					alloc_bms_chk_val_temp = (String)alloc_bms_chk_val.get(((String)forAllocation.get("order_id"+(i+1)))+((String)forAllocation.get("order_line_num"+(i+1))));
					//if(forAllocation.get("bms_qty"+(i+1)) != null&&(((String)forAllocation.get("allocateyn_"+(i+1))).equals("Y") || alloc_bms_chk_val_temp.equals("Y")) && (complete_order.equals("")&& temp_DrugReson.equals(""))){ //Commented [IN:003426] 
					//if(forAllocation.get("bms_qty"+(i+1)) != null&& ((String)forAllocation.get("allocateyn_"+(i+1))).equals("Y") && (alloc_bms_chk_val_temp==null || (alloc_bms_chk_val_temp!=null && alloc_bms_chk_val_temp.equals("Y"))) && (complete_order.equals("")&& temp_DrugReson.equals(""))){// allocateyn_ || alloc_bms_chk_val_temp changed ==> || to  && [IN:003426] and modified for SKR-SCF-1338 and alloc_bms_chk_val_temp==null added for ML-MMOH-SCF-1634
					if(forAllocation.get("bms_qty"+(i+1)) != null&& ((String)forAllocation.get("allocateyn_"+(i+1))).equals("Y") && (alloc_bms_chk_val_temp==null || alloc_bms_chk_val_temp.equals("Y")) && (complete_order.equals("")&& temp_DrugReson.equals(""))){

						sBMSQty = forAllocation.get("bms_qty"+(i+1)).toString();
						hmBMSValues.put(order_id+"~"+forAllocation.get("order_line_num"+(i+1)).toString(),sBMSQty);
						if( Double.parseDouble(sBMSQty) > 0){
							alBMSOrderValues	= new ArrayList();
							alBMSOrderValues.add(order_id);
							alBMSOrderValues.add((String)forAllocation.get("order_line_num"+(i+1)));
							alBMSOrderIds.add(alBMSOrderValues);
						}
					}
					else
						hmBMSValues.put(order_id+"~"+forAllocation.get("order_line_num"+(i+1)).toString(),"0");
					if(forAllocation.get("hold"+(i+1))==null || ((String)forAllocation.get("hold"+(i+1))).equals("")){
						//if((((String)forAllocation.get("hold_status"+(i+1))).equals("disabled")&& ((String)forAllocation.get("allocateyn_"+(i+1))).equals("Y")) || taper_order.equals("Y")) {  //Commented for RUT-CRF-0088 [IN036978]
						if((((String)forAllocation.get("hold_status"+(i+1))).equals("disabled")&& ((String)forAllocation.get("allocateyn_"+(i+1))).equals("Y"))) { //for RUT-CRF-0088 [IN036978] 
							orderLineData.add("N");						// N - Not Hold and allocated
							patientDrugProfileData.add("N");
							//Added by Himanshu Saxena for PMG-COMN-CRF-0050 Starts
							if((forAllocation.get("patient_class").equals("EM") || forAllocation.get("patient_class").equals("OP") )&& forAllocation.get("alloc_qty_"+(i+1)).equals("0")){
								if(forAllocation.containsKey("alloc_bms_chk_"+(i+1))){
									if(disp_level.equals("P")) {
										System.out.println("Himanshu001===========> "+(String)forAllocation.get("alloc_bms_chk_"+(i+1)));
										alloc_bms_chk.put(((String)forAllocation.get("order_id"+(i+1)))+((String)forAllocation.get("order_line_num"+(i+1))),(String)forAllocation.get("alloc_bms_chk_"+(i+1)));
									}
									else{
										alloc_bms_chk.put(((String)forAllocation.get("order_id"))+((String)forAllocation.get("order_line_num"+(i+1))),(String)forAllocation.get("alloc_bms_chk_"+(i+1)));
									}
								}
							}
							//Added by Himanshu Saxena for PMG-COMN-CRF-0050 ends
						}
						else{
							orderLineData.add("NN");					// NN - Not Hold and Not Allocated
							patientDrugProfileData.add("NN");

							not_allocated.add(order_id+(String)forAllocation.get("order_line_num"+(i+1)));

							// For alloc_bms by charles
							if(forAllocation.containsKey("alloc_bms_chk_"+(i+1))){
								if(disp_level.equals("P")) {
									alloc_bms_chk.put(((String)forAllocation.get("order_id"+(i+1)))+((String)forAllocation.get("order_line_num"+(i+1))),(String)forAllocation.get("alloc_bms_chk_"+(i+1)));
								}
								else{
									alloc_bms_chk.put(((String)forAllocation.get("order_id"))+((String)forAllocation.get("order_line_num"+(i+1))),(String)forAllocation.get("alloc_bms_chk_"+(i+1)));
								}
							}
						}
					}
					else{
						not_allocated.add(order_id+(String)forAllocation.get("order_line_num"+(i+1)));
						orderLineData.add("Y");							// Y - Hold
						patientDrugProfileData.add("Y");
					}
					orderLineData.add(login_by_id.trim());
					patientDrugProfileData.add(login_by_id.trim());
					reason = objAllStages.getBeanReason((i+1)+"");
					if(reason.size()>=2){
						patientDrugProfileData.add((String)reason.get(1));
						orderLineData.add((String)reason.get(2));
					}
					else{
						patientDrugProfileData.add("");
						orderLineData.add("");
					}
					patientDrugProfileData.add((String)forAllocation.get("patient_id"));

					if(disp_level.equals("P")) {
						orderLineData.add((String)forAllocation.get("order_id"+(i+1)));
						patientDrugProfileData.add((String)forAllocation.get("order_id"+(i+1)));
					}
					else {
						orderLineData.add((String)forAllocation.get("order_id"));
						patientDrugProfileData.add((String)forAllocation.get("order_id"));
					}
					orderLineData.add((String)forAllocation.get("order_line_num"+(i+1)));
					patientDrugProfileData.add((String)forAllocation.get("order_line_num"+(i+1)));

				
					order_line_num =(String)forAllocation.get("order_line_num"+(i+1)); 
					objAllStages.setOrderCheckedYn(order_id+"@"+order_line_num, "Y"); // Added for MMS-KH-CRF-0028 [IN070605]
 /*====code added to completing order when complete order checkbox is checked======*/
					temp_OrderId=order_id; // added for incident No:32227
					if( !(forAllocation.get("CompleteOrder"+(i+1))!=null && forAllocation.get("CompleteOrder"+(i+1)).equals(""))) {					
						orderLineData.add((String)forAllocation.get("CompleteOrder"+(i+1)));	
						complete_status.put((order_id+order_line_num),"Y");
						complete_order_reason.put((order_id+order_line_num),(String)forAllocation.get("ComplteOrderReason"+(i+1)));
					} 
					else{
						// added below if condition for incident No:32227
						//if(temp_DrugReson!=null && !temp_DrugReson.equals("") && !taper_order_id.equals("") && !taper_order_line_num.equals("") && temp_OrderId.equals(taper_order_id) ){ //Commented for RUT-CRF-0088 [IN036978]
						if(temp_DrugReson!=null && !temp_DrugReson.equals("")){
							orderLineData.add("Y");	
							complete_status.put((order_id+order_line_num),"Y");
							complete_order_reason.put((order_id+order_line_num),temp_DrugReson);
						}
						else{
							orderLineData.add("N");
							complete_status.put((order_id+order_line_num),"N");
						}
					}

					if( !(forAllocation.get("alloc_strength"+(i+1))!=null && forAllocation.get("alloc_strength"+(i+1)).equals("")) && !(((String)complete_status.get(order_id+order_line_num)).equals("Y"))) {	// && !(((String)complete_status.get(order_id+order_line_num)).equals("Y")) added for ML-MMOH-SCF-0356.1				
						alloc_complete_status.put((order_id+order_line_num),"Y");	
					}
					else {
						alloc_complete_status.put((order_id+order_line_num),"N");
					} 
				
					if(forAllocation.containsKey("pat_reqd_"+(i+1))){
						if(((String)forAllocation.get("pat_reqd_"+(i+1))).trim().equals("C")){
							orderLineData1.add((String)forAllocation.get("pat_reqd_"+(i+1))==null?"":(String)forAllocation.get("pat_reqd_"+(i+1)));	
							if(disp_level.equals("P")) {
								orderLineData1.add((String)forAllocation.get("order_id"+(i+1)));
							}
							else {
								orderLineData1.add((String)forAllocation.get("order_id"));
							}
							orderLineData1.add((String)forAllocation.get("order_line_num"+(i+1)));
						}
					}
					/*CODE FOR RESUMING HOLD ORDERS*/
					if( !(forAllocation.get("release_flag"+(i+1))!=null && forAllocation.get("release_flag"+(i+1)).equals(""))) {					
						resultStatusFlags.add((String)forAllocation.get("release_flag"+(i+1)));						
					}
					else{
						resultStatusFlags.add("N");
					}
					//orderLineData.add(taper_order); // Commented for RUT-CRF-0088 [IN036978]
				}
			}
			/*	Allocated then get the allocation details from DispMedicationAllStages bean based	on patient id and order id	*/
			try{
				if(disp_level.equals("P")) {
					ArrayList arrListAlloc =	null;
					HashMap hmAllocRecord	=	null;
					
					//for(int i=0;i<orderLineData.size();i=i+7){   
					for(int i=0;i<orderLineData.size();i=i+6){ // reduced for RUT-CRF-0088 [IN036978]   //Modified for RUT-CRF-0088 [IN036978] 7->6
						if(!unique_orders.contains(((String)orderLineData.get(i+3)).trim())) {
							unique_orders.add(((String)orderLineData.get(i+3)).trim());

							alloc =	objAllStages.getAllocation( (String)forAllocation.get("patient_id"),((String)orderLineData.get(i+3)).trim());
							arrListAlloc = (ArrayList)alloc.get("detail");

							for(int j=0;j<arrListAlloc.size();j++){
								hmAllocRecord = (HashMap)arrListAlloc.get(j);
								order_id		=(String) hmAllocRecord.get("order_id");
								//added for SKR-SCF-1319 start
								 ivprep=getIvprepynFrManufacture(order_id); 
								 setIvprep(ivprep);
								//added for SKR-SCF-1319 end
								 
								order_line_num	=(String) hmAllocRecord.get("order_line_no");
								if(complete_status.containsKey(order_id+order_line_num)||alloc_complete_status.containsKey(order_id+order_line_num)){
									if((( ((String)complete_status.get(order_id+order_line_num)).equals("N"))|| ( ((String)alloc_complete_status.get(order_id+order_line_num)).equals("Y")))&&(!not_allocated.contains(order_id+order_line_num)) ) { 
										if(Float.parseFloat((String)hmAllocRecord.get("disp_qty"))>0){ // Added for ML-MMOH-SCF-2968
										dispTMP.add(hmAllocRecord.get("order_id"));
										dispTMP.add(hmAllocRecord.get("order_line_no"));
										dispTMP.add(hmAllocRecord.get("pres_drug_code"));
										dispTMP.add(hmAllocRecord.get("disp_drug_code"));
										dispTMP.add(hmAllocRecord.get("disp_qty"));
										dispTMP.add(hmAllocRecord.get("disp_uom_code"));
										dispTMP.add((ArrayList)hmAllocRecord.get("batch_record"));
										}							
										if(fill_list!= null && fill_list.equals("AF")){
											alDispTMPForDeleteSales.add(hmAllocRecord.get("order_id"));
											alDispTMPForDeleteSales.add(hmAllocRecord.get("order_line_no"));
											alDispTMPForDeleteSales.add(hmAllocRecord.get("pres_drug_code"));
											alDispTMPForDeleteSales.add(hmAllocRecord.get("disp_drug_code"));
											alDispTMPForDeleteSales.add(hmAllocRecord.get("disp_qty"));
											alDispTMPForDeleteSales.add(hmAllocRecord.get("disp_uom_code"));
											alDispTMPForDeleteSales.add((ArrayList)hmAllocRecord.get("batch_record"));
										}
									}
								}
							}
						}
					}
				}
				else {
					alloc =	objAllStages.getAllocation( (String)forAllocation.get("patient_id"),(String)forAllocation.get("order_id"));					
					ArrayList arrListAlloc = (ArrayList)alloc.get("detail");
					HashMap hmAllocRecord	=	null;
					for(int j=0;j<arrListAlloc.size();j++){

						hmAllocRecord = (HashMap)arrListAlloc.get(j);
						order_id		= (String)hmAllocRecord.get("order_id");
						order_line_num	= (String)hmAllocRecord.get("order_line_no");
						if(complete_status.containsKey(order_id+order_line_num)||alloc_complete_status.containsKey(order_id+order_line_num)){
							if((complete_status.get(order_id+order_line_num).equals("N")||alloc_complete_status.get(order_id+order_line_num).equals("Y"))&&(!not_allocated.contains(order_id+order_line_num))) { 
								if(Float.parseFloat((String)hmAllocRecord.get("disp_qty"))>0){ // Added for ML-MMOH-SCF-2968
								dispTMP.add(hmAllocRecord.get("order_id"));
								dispTMP.add(hmAllocRecord.get("order_line_no"));
								dispTMP.add(hmAllocRecord.get("pres_drug_code"));
								dispTMP.add(hmAllocRecord.get("disp_drug_code"));
								dispTMP.add(hmAllocRecord.get("disp_qty"));
								dispTMP.add(hmAllocRecord.get("disp_uom_code"));
								dispTMP.add((ArrayList)hmAllocRecord.get("batch_record"));
								}
								if(fill_list!= null && fill_list.equals("AF")){
									alDispTMPForDeleteSales.add(hmAllocRecord.get("order_id"));
									alDispTMPForDeleteSales.add(hmAllocRecord.get("order_line_no"));
									alDispTMPForDeleteSales.add(hmAllocRecord.get("pres_drug_code"));
									alDispTMPForDeleteSales.add(hmAllocRecord.get("disp_drug_code"));
									alDispTMPForDeleteSales.add(hmAllocRecord.get("disp_qty"));
									alDispTMPForDeleteSales.add(hmAllocRecord.get("disp_uom_code"));
									alDispTMPForDeleteSales.add((ArrayList)hmAllocRecord.get("batch_record"));
								}
							}	
						}
					}
				}

				String sTmp = "";
				if(hmDispTMPForDeleteSales != null && hmDispTMPForDeleteSales.size()>0){
					for(int iTmpDelSales = 0;iTmpDelSales < alDispTMPForDeleteSales.size() ;iTmpDelSales+=7){
						sTmp = alDispTMPForDeleteSales.get(iTmpDelSales).toString()+"~"+alDispTMPForDeleteSales.get(iTmpDelSales+1).toString();
						if(hmDispTMPForDeleteSales.get(sTmp)!=null)	{
							alDispTMPForDeleteSales.set(iTmpDelSales+3,hmDispTMPForDeleteSales.get(sTmp));

						}
					}
				}

				if(dispTMP.size()==0){
					System.err.println("|====alloc======|"+alloc);
					System.err.println("=6=dispensing bean===complete_status======|"+complete_status+"|====alloc_complete_status======|"+alloc_complete_status+"=====orderLineData====="+orderLineData);
				}
			}
			catch(Exception e){
				System.err.println("=DISPMEDICATION BEAN==while preparing DISPTMP DEATILS dispTMP="+dispTMP);
				e.printStackTrace();
			}
			tabData = new HashMap() ;
			tabData.put( "properties", getProperties() );
			tabData.put( "disp_stage", getDispStage());
			tabData.put( "filling_status", getFillingStatus());
			tabData.put( "facility_id", login_facility_id.trim() );
			tabData.put( "login_at_ws_no", login_at_ws_no.trim());
			tabData.put( "login_by_id", login_by_id.trim());
			tabData.put( "funct_role_id",getFunctRollID( login_by_id));
			tabData.put( "disp_locn_code", getDispLocnCode().trim() );
			tabData.put( "patient_class", getDispLocnCatg().trim() );
			tabData.put( "source_code",forAllocation.get("source_code"));
			tabData.put( "source_type",forAllocation.get("source_type"));
			tabData.put( "ordering_facility_id",getOrderingFacility());
			tabData.put( "ord_date_time",forAllocation.get("ord_date_time"));
			tabData.put( "dateTime",getTodaysDateTime());
			tabData.put( "today",getTodaysDate());
			tabData.put( "performing_pract_id",forAllocation.get("performing_pract_id"));
			tabData.put( "patient_id", forAllocation.get("patient_id"));			
			tabData.put( "encounter_id", forAllocation.get("encounter_id"));
			tabData.put( "delivery_applicable", getDeliveryApplicable()); //checkDeliveryApplicability
			tabData.put( "orderLineData", orderLineData );
			tabData.put( "orderLineData1", orderLineData1 );
			tabData.put( "patientDrugProfileData", patientDrugProfileData );
			tabData.put( "resultStatusFlags", resultStatusFlags );//FOR RESUMING HOLD ORDERS
			tabData.put( "dispTMP", dispTMP );
			tabData.put("stock",getStockInstalled()+"");//stock_installed
			tabData.put("store_code",getStoreCode());
			tabData.put("DISP_LEVEL",disp_level);
			tabData.put("mode",getMode());
			//code added for filling,fill person and edit.....on 20/4/2004..
			tabData.put("fillingRemarks",objAllStages.fill_remarks);
			tabData.put("deliveryRemarks",objAllStages.delivery_remarks);
			tabData.put("allocatefill_remarks",objAllStages.allocatefill_remarks);
			if("Y".equals(objAllStages.getUserAuthPINRequiredYN()))  // Added for RUT-SCF-0274 IN039740 Based on this flag, the User ID Captured with PIN will be updated
				tabData.put("FillPersonName", objAllStages.getAuthUserName(objAllStages.getAuthUserID()));    // Added for RUT-SCF-0274 IN039740
			else
				tabData.put("FillPersonName",objAllStages.getFilledPersonName()); //Modified for GHL-CRF-0627
			tabData.put("editLabel",objAllStages.editLabel);
			tabData.put("token_yn",issue_token_on_regn_yn);
			tabData.put("Token_Queue_date",this.queue_date);
			tabData.put("token_series_code",getTokenSeriesCode());
			tabData.put("token_vals",objAllStages.getTokenVals());
			tabData.put("fill_list",fill_list);
			tabData.put("func_role_id",getFunctRollID(login_by_id.trim()));
			tabData.put("complte_order_reason",complete_order_reason);//complte order reason code
			tabData.put( "LanguageId",getLanguageId());
			tabData.put( "DispBillingStage",getDispBillStage());
			tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
			tabData.put("BL_REASONS", objAllStages.getBiilingReasonDetails());
			tabData.put("DISP_CASH_COLL_STAGE", getDispCashCollStage());
			tabData.put("IV_PREP_YN", getWsType());
			tabData.put("nonPrefernceRemarks",objAllStages.getNonPrefernceRemarks());//GHL-CRF-0619
			tabData.put("CONSUMABLES_DET", objAllStages.getConsumableDetails());
			tabData.put("ORDER_ID_ORDER_DATE",getOrderIDOrderDate());
			if(this.issue_by_uom.equals("I")){
				tabData.put( "ISSUE_UOM_QTY", objAllStages.issueUomQty);
			}
			tabData.put( "alloc_bms_chk", alloc_bms_chk);
			tabData.put("ORDER_ID_ATTENDED_PRACT_ID",this.order_id_Attended_pract_id);
			tabData.put("IPFillProcess",getFillUnit());
			tabData.put("IPFillPeriodAhead",getFillPeriod());
			tabData.put("BMSValues",hmBMSValues);
			tabData.put("DispPeriodForHdr",getStrChangedDispensePeriod());
			tabData.put("DispUnitForHdr",getStrChangedDispenseUnit());
			tabData.put("FillProcIDForOrderID",this.hmFillPorcID_OrderID);
			tabData.put("CHARGE_DTLS",objAllStages.charge_dtls);
			tabData.put( "delivery_details",getDeliveryDetails());
			tabData.put("DRUG_INDICATION",getDrugIndication(order_id.trim(),order_line_num.trim()));//Added DRUG_INDICATION for  ML-BRU-CRF-072[Inc:29938]
			tabData.put("dispMedStages",getDispMedStages());//Added for SKR-SCF-0611 [IN:034816]
			tabData.put("ALTDRUGREMARKS",objAllStages.getAltDrugRemarks());//Added for Bru-HIMS-CRF-082 [IN:029948]
			tabData.put( "alloc_bms_chk_val", alloc_bms_chk_val);	// Added for [IN:045295]
			tabData.put( "autoCompletePartialDisp", getAutoCompletePartialDisp()); // Added forJD-CRF-0179 [IN:41211]
			tabData.put( "st_no_of_decimals", objAllStages.getSt_no_of_decimals()); // Added for AAKH-SCF-0113 [IN:048937]
			tabData.put( "hshmedplan", medplan_bean.getMedPlan_DrugDetails()); // Added for  Bru-HIMS-CRF-072.1[IN 049144] start // Anitha
			tabData.put( "hshmedplanlocal", medplan_bean.getMedPlan_Local_DrugDetails()); 
			tabData.put( "arrMedPlanSeqNo", medplan_bean.getMediPlanSeqNo()); 
			tabData.put("strMedPlanYN", getMedicationPlannerYN());
			tabData.put( "isMedValuesChanged", medplan_bean.isMedValuesChanged()+""); // Added for  Bru-HIMS-CRF-072.1[IN 049144] end
			tabData.put("editableLabel",objAllStages.getEditableLabel());//added for Bru-HIMS-CRF-414 [IN:045554]
			tabData.put("allow_edit_disp_label", getAllowEditDispLabel());//added for Bru-HIMS-CRF-414 [IN:045554]
			tabData.put("editableLabelLangId", getEditableLabelLangId());//added for Bru-HIMS-CRF-414 
			tabData.put("st_decimal_restriction", getPhStDecimalRestrictionYN());//added for MMS-DM-SCF-0210 [IN:059660]

			tabData.put("hmFillReasons", hmFillReasons);//added for ML-MMOH-SCF-0465 [IN:059660]
			tabData.put("approvalNo",getApprovalNo()); //Added for AAKH-CRF-0117
			tabData.put("IV_PREP", getIvprep()); //Added for SKR-SCF-1319 

			
			if(getPatientPaid())
				this.bEditValues = false;
			tabData.put("Editable",this.bEditValues+"");
			tabData.put("ValuesChanged",this.bValuesChanged+"");
			// tabData.put("DailySequenceNo",getSeqNumber(login_facility_id.trim(),getStoreCode()));
			if(fill_list!= null && fill_list.equals("AF") && alDispTMPForDeleteSales.size()>0){
				tabData.put("DispTMPForDeleteSales",alDispTMPForDeleteSales);
			}
			//For PPN Orders
			if(forAllocation.get("ord_type")!=null &&forAllocation.get("ord_type").toString().equals("TD") && hmPPNValues!=null){
				tabData.put("ordType","TD");	
				tabData.put("hmPPNValues",hmPPNValues);
			}
			if(objAllStages.getConsumableDetails()!=null && objAllStages.getConsumableDetails().size()>0)
				setBConsuableItemAvailable(true);
			else
				setBConsuableItemAvailable(false);
			tabData.put("barcode_remarks",getManualBarcodeRemarks());//Added for MMS-DM-CRF-0157.1
			tabData.put("barcode_2d_applicable_yn",get2DBarcodeApplicable());//Added for MMS-DM-CRF-0174.5
			tabData.put("hm2dBarcode",get2DBarCodeForDrug());//Added for MMS-DM-CRF-0174.5
			//code ended...			
			HashMap sqlMap = new HashMap() ;
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1"));
			//sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_INSERT","INSERT INTO PH_DISP_HDR_TMP (DISP_TMP_NO, FACILITY_ID,DISP_LOCN_CODE,ORDER_ID,RECORD_DATE_TIME,FILL_PROC_ID,ORDERING_FACILITY_ID,ORD_DATE_TIME,PATIENT_ID,ENCOUNTER_ID,PATIENT_CLASS,LOCN_TYPE,LOCN_CODE,SPECIALITY_CODE,ATTEND_PRACTITIONER_ID,PRES_PHYSICIAN_ID,DISPENSED_DATE_TIME, ADDED_BY_ID, ADDED_DATE, ADDED_AT_WS_NO, ADDED_FACILITY_ID, MODIFIED_BY_ID, MODIFIED_DATE, MODIFIED_AT_WS_NO, MODIFIED_FACILITY_ID,FILLED_BY_NAME , DISPENSED_BY,DISP_TRN_SEQ_NO,DAILY_SEQ_NUM,TOKEN_SERIAL_NO,TOKEN_SERIES_CODE,ALLOC_FOR_DURN,ALLOC_FOR_DURN_UNIT,ROOM_NO, BED_NO, BED_CLASS, BED_TYPE) VALUES(?,?,?,?,SYSDATE,?,?,TO_DATE(?,'DD/MM/YYYY HH24:MI'),?,?,?,?,?,?,?,?,sysdate,?,SYSDATE,?,?,?,SYSDATE,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE_FILLEDBY",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE_FILLEDBY"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DRUG_BATCH_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DRUG_BATCH_TMP_INSERT"));

			//sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT","INSERT INTO PH_DISP_DTL_TMP (DISP_TMP_NO,DTL_SERIAL_NUM,RECORD_DATE_TIME, FACILITY_ID,DISP_LOCN_CODE,ORDER_ID,ORDER_LINE_NO, PRES_DRUG_CODE, ORDERING_FACILITY_ID, DISP_DRUG_CODE,DISP_QTY,DISP_UOM_CODE,ADDED_BY_ID,ADDED_DATE ,ADDED_AT_WS_NO,ADDED_FACILITY_ID, MODIFIED_BY_ID,MODIFIED_DATE ,MODIFIED_AT_WS_NO , MODIFIED_FACILITY_ID,DOC_SRL_NO,FILL_REMARKS_CODE,FILL_TASK_FINDING ,LABEL_CAU_INSTRN1_ENG,LABEL_CAU_INSTRN2_ENG,LABEL_SPL_INSTRN1_ENG,LABEL_SPL_INSTRN2_ENG,LABEL_PAT_INSTRN1_ENG,LABEL_CAU_INSTRN1_LOC,LABEL_CAU_INSTRN2_LOC,LABEL_SPL_INSTRN1_LOC,LABEL_SPL_INSTRN2_LOC,LABEL_PAT_INSTRN1_LOC,DELIVERY_REMARKS_CODE,DELIVERY_TASK_FINDING,ALLOCATE_REMARKS_CODE,ALLOCATE_TASK_FINDING,BL_INCL_EXCL_OVERRIDE_VALUE,BL_INCL_EXCL_OVERRIDE_REASON,PRES_REMARK_CODE,ISSUE_QTY ,ISSUE_UOM_CODE,DSN_REFERENCE, BMS_QTY,CERT_REIMB_APPL_YN,DRUG_INDICATION, ALT_DRUG_REMARKS,PRINT_SEQ_NO,APPROVAL_NO, NOT_PREFERED_ITEM_REM_CODE)VALUES (?,?,SYSDATE,?,?,?,?,?,?,?,?,?,?,SYSDATE,?,?,?,SYSDATE,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");//Added DRUG_INDICATION for  ML-BRU-CRF-072[Inc:29938]//ADDED PRINT_SEQ_NO FOR RUT-CRF-0061 //ADDED approval_no FOR AAKH-CRF-0117 and NOT_PREFERED_ITEM_REM_CODE added for GHL-CRF-0619
			//NOT_PREFERED_ITEM_REMARKS_CODE added for GHL-CRF-0619
			sqlMap.put("SQL_PH_DISP_MEDI_EDIT_INSTRUCTIONS" , PhRepository.getPhKeyValue("SQL_PH_DISP_MEDI_EDIT_INSTRUCTIONS"));	
			sqlMap.put("SQL_PH_DISP_MEDI_EDIT_INT_RESULTS" , PhRepository.getPhKeyValue("SQL_PH_DISP_MEDI_EDIT_INT_RESULTS"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT33",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT33"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DRUG_BATCH_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DRUG_BATCH_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DISP_DTL_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE3",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE3"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE4",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE4"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE5",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE5"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE6",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE6"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE7",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE7"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE8",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE8"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE9",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE9"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE10",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE10"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE11",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE11"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HDR_COUNT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT47"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HDR_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE3"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DTL_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BATCH_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT56",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT56"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT57",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT57"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT58",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT58"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT59",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT59"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT67","SELECT DOC_SRL_NO FROM PH_DISP_DTL_TMP WHERE ORDER_ID=? AND ORDER_LINE_NO=?");
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT68",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT68"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE14",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE14"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT3",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT3"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT4",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT4"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT5",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT5"));
			sqlMap.put("SQL_PH_IVPRESCRIPTION_INSERT1",PhRepository.getPhKeyValue("SQL_PH_IVPRESCRIPTION_INSERT1"));
			sqlMap.put("SQL_PH_PRESCRIPTION_SELECT37",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT37"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT6",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT6"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT126",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT126"));
			sqlMap.put("SQL_PH_PRESCRIPTION_INSERT2",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_INSERT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT135",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT135"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT145",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT145"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE1",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT149",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT149"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT150",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT150"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT151",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT151"));
			sqlMap.put("SQL_DISP_MEDN_GET_PAT_ORDER_ENDDATETIME",PhRepository.getPhKeyValue("SQL_DISP_MEDN_GET_PAT_ORDER_ENDDATETIME"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT152",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT152"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT159",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT159"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT160",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT160"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT167",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT167"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2A",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2A"));
			sqlMap.put("SQL_PH_PPN_ORDERS_INSERT","INSERT INTO PH_PPN_ORDERS( FACILITY_ID, ITEM_CODE, BATCH_ID, DISP_QTY, TRADE_ID, DISP_NO,DISP_QTY_UOM, DISP_LOCN_CODE, ORDER_ID , ORD_DATE_TIME , EXPIRY_DATE, BIN_LOCATION_CODE, PATIENT_ID, ADDED_BY_ID , ADDED_DATE , ADDED_AT_WS_NO , MODIFIED_BY_ID , MODIFIED_DATE , MODIFIED_AT_WS_NO, ADDED_FACILITY_ID, MODIFIED_FACILITY_ID) VALUES (?,?,?,?,?,?,?,?,?,SYSDATE,TO_DATE(?,'DD/mm/YYYY'),?,?,?,SYSDATE,?,?,SYSDATE,?,?,?)");

			//alloc_bms_check
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT162","SELECT ORDER_CATALOG_CODE, ORDER_UOM FROM OR_ORDER_LINE WHERE ORDER_ID = ? AND ORDER_LINE_NUM=?");

			sqlMap.put("SQL_PH_SEQ_NO_FOR_IP_FILL_SELECT","SELECT CASE WHEN (DSN_REFERENCE IS NOT NULL) THEN 'Y' ELSE 'N' END DSN_AVAILABLE, B.ORDER_ID||'~'||B.ORDER_LINE_NO ORDER_IDS,DAILY_SEQ_NUM ||'~'|| DSN_REFERENCE SEQ_NUM FROM PH_DISP_HDR_TMP A,PH_DISP_DTL_TMP B WHERE A.ORDER_ID = B.ORDER_ID");
			sqlMap.put("SQL_PH_DISP_MEDICATION_DTL_TMP_UPDATE_ALT_DRUG_REMARKS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DTL_TMP_UPDATE_ALT_DRUG_REMARKS"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_INSERT", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_INSERT"));// Added for  Bru-HIMS-CRF-072.1[IN 049144] start
			sqlMap.put("SQL_PH_MED_PLAN_ID_SEQ", PhRepository.getPhKeyValue("SQL_PH_MED_PLAN_ID_SEQ"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE1", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE1"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE2", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE2"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE3", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE3"));
			sqlMap.put("SQL_PH_MED_PLAN_SELECT_CURR_DRUG", PhRepository.getPhKeyValue("SQL_PH_MED_PLAN_SELECT_CURR_DRUG"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_INSERT_CHECK", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_INSERT_CHECK"));// Added for  Bru-HIMS-CRF-072.1[IN 049144] end
			if(getAllowEditDispLabel().equals("Y")){//if block Added for Bru-HIMS-CRF-414 [IN:045554]
				sqlMap.put("SQL_PH_DISP_LABEL_UPDATE", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_UPDATE"));
				sqlMap.put("SQL_PH_DISP_LABEL_INSERT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_INSERT"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_DISP_DTL", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP1", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP1"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_COUNT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_COUNT"));
				sqlMap.put("SQL_PH_DISP_LABEL_DELETE", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_DELETE"));
				sqlMap.put("SQL_PH_DISP_LABEL_DTL_TMP_PREV_INSERT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_DTL_TMP_PREV_INSERT"));
			}
			setHmAllocBmsChk(alloc_bms_chk);
			/*InitialContext context = new InitialContext() ;
			Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION") ) ;
			home = (DispMedicationHome) PortableRemoteObject.narrow( object, DispMedicationHome.class ) ;
			remote = home.create() ;
			HashMap result = remote.modify( tabData, sqlMap ) ;*/
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION" ),DispMedicationHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;

			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();

			HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);
			if( ((Boolean) result.get( "result" )).booleanValue() )	{
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")) ;
				map.put("flag","0");
				if(result.containsKey("print_seq_no_tmp"))//Added for RUT-CRF-0061
					setPrintSeqNo(result.get("print_seq_no_tmp").toString());
				if(result.containsKey("mediplan_seq_no")){//Added for Bru-HIMS-CRF-072.1[IN 049144]
					medplan_bean.clearMediPlanSeqNo();
					medplan_bean.setMediPlanSeqNo(result.get("mediplan_seq_no").toString());
				}
				if(result.containsKey("SAL_DOC_DTLS") && getDispDocNo().equals("Y") && disp_locn_catg.equals("I")){ //Added for AMS-CRF-0079 [IN:050762] -start
					setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
					if(alSalDocDtls != null && alSalDocDtls.size()>0){
						StringBuffer sbSalDocDtls = new StringBuffer();
						for(int i=0; i<alSalDocDtls.size(); i++){
							if(i ==0)
								sbSalDocDtls.append("Document Reference Number: <b>");
							if(i>0)
								sbSalDocDtls.append(" , ");
							sbSalDocDtls.append(alSalDocDtls.get(i));
						}
						map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")+"\n" +sbSalDocDtls.toString()+"</b>") ;
						map.put("dispNos", sbSalDocDtls.toString());//added for th-kw-crf-0020.3
					}
					
				}//Added for AMS-CRF-0079 [IN:050762] -end
				else{
					setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
					if(alSalDocDtls != null && alSalDocDtls.size()>0){
						StringBuffer sbSalDocDtls = new StringBuffer();
						for(int i=0; i<alSalDocDtls.size(); i++){
							
							if(i>0)
								sbSalDocDtls.append(" , ");
							sbSalDocDtls.append(alSalDocDtls.get(i));
						}
						
						map.put("dispNos", sbSalDocDtls.toString());
					}
				}//Added for AMS-CRF-0079 [IN:050762] -end
			}
			else{
				String msg_id= (String)result.get("msgid");
				String orig_msg_id = msg_id; //Added for for MMS-SCF-0306 [IN:047499]-start
				String message="";
				int index = msg_id.indexOf(":-");
				if(index== -1)
					index = msg_id.length();
				//msg_id=msg_id.substring(24,(msg_id.length())); //commented for for MMS-SCF-0306 [IN:047499]
				msg_id=msg_id.substring(32,index);//24->32 //added for for MMS-SCF-0306 [IN:047499]
				String item_code=(String)result.get("ITEM_CODE")==null?"":(String)result.get("ITEM_CODE");
				String drug_desc=(String)result.get("DRUG_DESC")==null?"":(String)result.get("DRUG_DESC");
				if(!drug_desc.equals(""))
					drug_desc = " - "+drug_desc;
				if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
					index = orig_msg_id.indexOf(":- :"); //Added for for MMS-SCF-0306 [IN:047499] -start
					if(index >0)
						message = getMessage(getLanguageId(),msg_id,"PH")+" for "+ orig_msg_id.substring(index+4, orig_msg_id.length());
					else
						message = getMessage(getLanguageId(),msg_id,"PH");
					map.put( "message", message) ; //added for for MMS-SCF-0306 [IN:047499]-end
					//map.put( "message", getMessage(getLanguageId(),msg_id,"PH")+item_code+drug_desc ) ; //Commented for for MMS-SCF-0306 [IN:047499]
				}
				else{
					msg_id= (String)result.get("msgid");
					msg_id = msg_id.replace("javax.ejb.EJBException:","");
					msg_id = msg_id.replace("java.lang.Exception:","");
					msg_id = msg_id.trim();
					map.put( "message", msg_id +item_code+drug_desc) ;
				}
				map.put("flag","0");
			}
			clearAlOrderLineDataForEditLables();
			objAllStages.clearTokenVals();
			setAlOrderLineDataForEditLables(orderLineData);
			System.out.println("@@@ ML-MMOH-SCF-2496 DispMedicationBean.java-CompleteAllocation() End :"+getTodaysDateTime());
		}
		catch(Exception e){
			System.err.println("==error in dispense completeAllocation forAllocation===="+forAllocation);	
			System.err.println("==error in dispense completeAllocation patientDrugProfileData===="+patientDrugProfileData);	
			System.err.println("==error in dispense completeAllocation dispTMP===="+dispTMP);	
			System.err.println("==error in dispense completeAllocation getStockInstalled===="+getStockInstalled()+"==disp_level="+disp_level);	
			System.err.println("==error in dispense completeAllocation tabData===="+tabData);			
			map.put( "message", e.getMessage() ) ;
			e.printStackTrace();
		}
		map.put("flag","0");
		return map;
	}
	
	public HashMap completeWSAllocation(){
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		HashMap tabData = new HashMap() ;
		try{
			HashMap complete_status = new HashMap();
			HashMap complete_order_reason = new HashMap();
			ArrayList orderLineData			= new ArrayList() ;
			ArrayList orderLineData1		= new ArrayList() ;
			ArrayList patientDrugProfileData = new ArrayList() ;
			ArrayList dispTMP				= new ArrayList();
			ArrayList reason				= null;
			String order_id					= "";
			String order_line_no			= "";

			for(int i=0;i<forAllocation.size();i++){
				if(forAllocation.containsKey("order_line_num"+(i+1))){
					if(forAllocation.get("hold"+(i+1))==null || ((String)forAllocation.get("hold"+(i+1))).equals("")){
						if((((String)forAllocation.get("hold_status"+(i+1))).equals(""))||((String)forAllocation.get("hold_status"+(i+1))).equals("disabled")){
							orderLineData.add("N");					// N - Not Hold and allocated
							patientDrugProfileData.add("N");
						}
						else{
							orderLineData.add("NN");					// NN - Not Hold and Not Allocated
							patientDrugProfileData.add("NN");
						}
					}
					else{
						orderLineData.add("Y");							// Y - Hold
						patientDrugProfileData.add("Y");
					}

					orderLineData.add(login_by_id.trim());
					patientDrugProfileData.add(login_by_id.trim());
					reason = objAllStages.getBeanReason((i+1)+"");
					if(reason.size()>=2){
						patientDrugProfileData.add((String)reason.get(1));
						orderLineData.add((String)reason.get(2));
					}
					else{
						patientDrugProfileData.add("");
						orderLineData.add("");
					}
					patientDrugProfileData.add((String)forAllocation.get("patient_id"));
					orderLineData.add((String)forAllocation.get("order_id"));
					patientDrugProfileData.add((String)forAllocation.get("order_id"));
					orderLineData.add((String)forAllocation.get("order_line_num"+(i+1)));
					patientDrugProfileData.add((String)forAllocation.get("order_line_num"+(i+1)));
					if(forAllocation.containsKey("pat_reqd_"+(i+1))){
						if(((String)forAllocation.get("pat_reqd_"+(i+1))).trim().equals("C")){
							orderLineData1.add((String)forAllocation.get("pat_reqd_"+(i+1))==null?"":(String)forAllocation.get("pat_reqd_"+(i+1)));	
							if(disp_level.equals("P")) {
								orderLineData1.add((String)forAllocation.get("order_id"+(i+1)));
							}
							else {
								orderLineData1.add((String)forAllocation.get("order_id"));
							}
							orderLineData1.add((String)forAllocation.get("order_line_num"+(i+1)));
						}
					}
					order_id = (String)forAllocation.get("order_id");
					order_line_no = (String)forAllocation.get("order_line_num"+(i+1));
					objAllStages.setOrderCheckedYn(order_id+"@"+order_line_no, "Y"); // Added for MMS-KH-CRF-0028 [IN070605]
					if( !(forAllocation.get("CompleteOrder"+(i+1))!=null && forAllocation.get("CompleteOrder"+(i+1)).equals(""))) {					
						orderLineData.add((String)forAllocation.get("CompleteOrder"+(i+1)));	
						complete_status.put((order_id+order_line_no),"Y");
						complete_order_reason.put((order_id+order_line_no),(String)forAllocation.get("ComplteOrderReason"+(i+1)));
					}
					else{
						orderLineData.add("N");
						complete_status.put((order_id+order_line_no),"N");
					}
				}
			}
			int stock_count = 1;
			Hashtable worksheetDtlsData = new Hashtable();
			Hashtable addedDrugs		= getAllDrugDetails();
			if((forAllocation.get("stock_availability_check"+(stock_count)))!=null &&(orderLineData.get(0))!=null){
				if((((String)orderLineData.get(0)).equals("N") && ((String)forAllocation.get("stock_availability_check"+(stock_count))).equals("Y"))){
					Hashtable ht = getHTWSAllocateBatches();
					if( ht.size()>0 ){
						Set			ws_set				= ht.keySet();
						Iterator	ws_iterator			= ws_set.iterator();
						ArrayList arrListWorksheetDtl	=	null;
						String order_line_num			=	null;
						ArrayList arr_list				=	null;
						ArrayList tmp_arr_list			=	null;
						Hashtable ht_ws_qty				=	null;
						Hashtable ht_qty				=	null;
						ArrayList arr_qty				=	null;
						while (ws_iterator.hasNext()){
							arrListWorksheetDtl= new ArrayList();
							order_line_num = (String)ws_iterator.next();
							arr_list = (ArrayList)ht.get(order_line_num);
							int kk=0,mm=0;
							tmp_arr_list = new ArrayList();
							if( ((String)complete_status.get(order_id+order_line_num)).equals("N")){
								dispTMP.add(forAllocation.get("order_id"));					// order_id
								dispTMP.add(order_line_num);								// order_line
								dispTMP.add(forAllocation.get("drug_code"+order_line_num));	// pres_drug_code
								dispTMP.add(forAllocation.get("drug_code"+order_line_num)); // disp_drug_code
								// For Worksheet Dtls
								arrListWorksheetDtl.add(forAllocation.get("order_id"));					// order_id
								arrListWorksheetDtl.add(order_line_num);								// order_line_num
								arrListWorksheetDtl.add(forAllocation.get("drug_code"+order_line_num));	// pres_drug_code
								arrListWorksheetDtl.add(forAllocation.get("drug_code"+order_line_num)); // disp_drug_code
								arrListWorksheetDtl.add(forAllocation.get("qty_uom"+order_line_num));	// UOM
								double total_disp_qty=0;
								for (int jj=0;jj<arr_list.size() ;jj=jj+15 ){
									ht_ws_qty = getHTWSAllocatedQty();
									ht_qty	= (Hashtable)ht_ws_qty.get(order_line_num);
									arr_qty = (ArrayList)ht_qty.get((String)arr_list.get(jj)+(String)forAllocation.get("drug_code"+order_line_num));

									total_disp_qty += Double.parseDouble((String)arr_qty.get(kk));
									kk++;
								}
								arrListWorksheetDtl.add(total_disp_qty+"");
								dispTMP.add(total_disp_qty+"");						// disp_qty
								dispTMP.add(forAllocation.get("qty_uom"+order_line_num));	// uom

								for (int jj=0;jj<arr_list.size() ;jj=jj+15 ){
									ht_ws_qty = getHTWSAllocatedQty();
									ht_qty	= (Hashtable)ht_ws_qty.get(order_line_num);
									arr_qty = (ArrayList)ht_qty.get((String)arr_list.get(jj)+(String)forAllocation.get("drug_code"+order_line_num));
									tmp_arr_list.add(arr_list.get(jj));							// item_code
									tmp_arr_list.add(arr_list.get(jj+1));						// batch_id
									tmp_arr_list.add(arr_list.get(jj+7));						// expiry_date
									tmp_arr_list.add((String)arr_qty.get(mm));					// qty
									tmp_arr_list.add(forAllocation.get("qty_uom"+order_line_num));
									tmp_arr_list.add("");
									tmp_arr_list.add(arr_list.get(jj+8));			//bin location code
									tmp_arr_list.add(arr_list.get(jj+10));			//trade id
									tmp_arr_list.add("10");
									tmp_arr_list.add(forAllocation.get("qty_uom"+order_line_num)); //for base_uom added MMS-SCF-0040 [IN:041888]
									mm++;
								}
								dispTMP.add(tmp_arr_list);
								arrListWorksheetDtl.add(tmp_arr_list);	// This is for Item_code and batches(Batch_id,Expiry Date)...
								worksheetDtlsData.put(order_line_num,arrListWorksheetDtl);
							}
						}
					}
				}
			}
			tabData = new HashMap() ;
			tabData.put( "properties", getProperties() );
			tabData.put( "disp_stage", getDispStage());
			tabData.put( "filling_status", getFillingStatus());
			tabData.put( "facility_id", login_facility_id.trim() );
			tabData.put( "login_at_ws_no", login_at_ws_no.trim());
			tabData.put( "login_by_id", login_by_id.trim());
			tabData.put( "disp_locn_code", getDispLocnCode().trim() );
			tabData.put( "patient_class", getDispLocnCatg().trim() );
			tabData.put( "mode",getMode());
			tabData.put( "source_code",forAllocation.get("source_code"));
			tabData.put( "source_type",forAllocation.get("source_type"));
			tabData.put( "ordering_facility_id",getOrderingFacility());
			tabData.put( "ord_date_time",forAllocation.get("ord_date_time"));
			tabData.put( "performing_pract_id",forAllocation.get("performing_pract_id"));
			tabData.put( "patient_id", forAllocation.get("patient_id"));
			tabData.put( "encounter_id", forAllocation.get("encounter_id"));
			tabData.put( "worksheet_id", getWorksheetID());
			tabData.put( "finalized_yn", getWorksheetFinalisedYN(getWorksheetID(),getDispLocnCode().trim(),login_facility_id.trim()));			
			tabData.put("store_code",getStoreCode());
			tabData.put( "dateTime",getTodaysDateTime());
			tabData.put( "delivery_applicable", getDeliveryApplicable());//checkDeliveryApplicability
			tabData.put( "orderLineData", orderLineData );
			tabData.put( "orderLineData1", orderLineData1 );
			tabData.put( "patientDrugProfileData", patientDrugProfileData );
			tabData.put( "dispTMP", dispTMP );
			tabData.put("stock",getStockInstalled()+"");//stock_installed
			tabData.put( "today",getTodaysDate());
			tabData.put("ws_type",getWsType());		//Work sheet type
			tabData.put("ws_status",getWsStatus().trim());	//Work sheet status	(C-Complete,I-Incomplete)
			tabData.put("worksheetDtlsData",worksheetDtlsData);
			tabData.put("addedDrugs",addedDrugs);
			tabData.put("tot_rec",(Integer.parseInt((String)forAllocation.get("tot_rec"))-1)+"");
			tabData.put("ht_ws_fluid_allocate_batches",getHTWSFluidAllocateBatches()); // Fluid Details
			tabData.put( "LanguageId",getLanguageId());
			tabData.put( "DispBillingStage",getDispBillStage());
			tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
			tabData.put("barcode_2d_applicable_yn",get2DBarcodeApplicable());//Added for 51317
			if(forAllocation.containsKey("mark_up_down")){
				tabData.put( "admx_prep_charge_units",forAllocation.get("mark_up_down"));
			}
			if(forAllocation.containsKey("ItemForAdmixPrepCharges")){
				tabData.put( "admx_prep_charge_item_code",forAllocation.get("ItemForAdmixPrepCharges"));
			}
			tabData.put("token_vals",objAllStages.getTokenVals());
			tabData.put("bl_patient_class",forAllocation.get("bl_patient_class"));
			if(forAllocation.containsKey("old_mark_up_down")){
				tabData.put("old_mark_up_down",forAllocation.get("old_mark_up_down"));
			}
			if(forAllocation.containsKey("admx_prep_charges_appl_yn")){
				tabData.put("admx_prep_charges_appl_yn",forAllocation.get("admx_prep_charges_appl_yn"));
			}
			tabData.put("Token_Queue_date",this.queue_date);
			tabData.put("token_series_code",getTokenSeriesCode()); 
			tabData.put("token_yn",issue_token_on_regn_yn);
			tabData.put( "charge_pat_for_spill_qty_yn",getChargePatForSpillQtyYN());
			tabData.put("ORDER_ID_ORDER_DATE",getOrderIDOrderDate());
			tabData.put("complte_order_reason",complete_order_reason);//complte order reason code
			tabData.put("ORDER_ID_ATTENDED_PRACT_ID",this.order_id_Attended_pract_id);
			//tabData.put("DailySequenceNo",getSeqNumber(login_facility_id.trim(),getStoreCode()));
			tabData.put( "delivery_details",getDeliveryDetails());
			tabData.put("IV_PREP_YN", getWsType());
			tabData.put("DRUG_INDICATION",getDrugIndication(order_id.trim(),order_line_no.trim()));//Added DRUG_INDICATION for ML-BRU-CRF-072[Inc:29938]
			tabData.put("dispMedStages",getDispMedStages());//Added for //added for SKR-SCF-0611 [IN:034816]
			tabData.put("st_decimal_restriction", getPhStDecimalRestrictionYN());//added for MMS-DM-SCF-0210 [IN:059660]
			tabData.put("approvalNo",getApprovalNo()); //Added for AAKH-CRF-0117

			ArrayList arr_list=new ArrayList();
			if(getMfgUnitDetails().size()==0){
				arr_list.add("");
				arr_list.add("");
				arr_list.add("");
				arr_list.add("0");
				arr_list.add("");
				arr_list.add("");
				arr_list.add("N");
				arr_list.add("");
				tabData.put("mfg_unit_details",arr_list);
			}
			else{
				tabData.put("mfg_unit_details",getMfgUnitDetails());
			}
			tabData.put("CONSUMABLES_DET", objAllStages.getConsumableDetails());
			HashMap sqlMap = new HashMap() ;
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE_FOR_WS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE_FOR_WS"));	
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_WS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_WS"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1"));
			//sqlMap.put("SQL_PH_WS_DISP_MEDICATION_HRD_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_WS_DISP_MEDICATION_HRD_TMP_INSERT"));			
			sqlMap.put("SQL_PH_WS_DISP_MEDICATION_HRD_TMP_INSERT","INSERT INTO PH_DISP_HDR_TMP (DISP_TMP_NO, FACILITY_ID,DISP_LOCN_CODE,ORDER_ID,RECORD_DATE_TIME,FILL_PROC_ID,ORDERING_FACILITY_ID,ORD_DATE_TIME,PATIENT_ID,ENCOUNTER_ID,PATIENT_CLASS,LOCN_TYPE,LOCN_CODE,SPECIALITY_CODE,ATTEND_PRACTITIONER_ID,PRES_PHYSICIAN_ID,DISPENSED_DATE_TIME,ADDED_AT_WS_NO,ADDED_FACILITY_ID,MODIFIED_AT_WS_NO,MODIFIED_FACILITY_ID,WORKSHEET_ID,DISP_TRN_SEQ_NO,DAILY_SEQ_NUM,TOKEN_SERIES_CODE, TOKEN_SERIAL_NO) VALUES(?,?,?,?,SYSDATE,?,?,TO_DATE(?,'DD/MM/YYYY HH24:MI'),?,?,?,?,?,?,?,?,SYSDATE,?,?,?,?,?,?,?,?,?)");			
			sqlMap.put("SQL_PH_DISP_MEDICATION_DRUG_BATCH_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DRUG_BATCH_TMP_INSERT"));		
			//sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT","INSERT INTO PH_DISP_DTL_TMP (DISP_TMP_NO,DTL_SERIAL_NUM,RECORD_DATE_TIME, FACILITY_ID,DISP_LOCN_CODE,ORDER_ID,ORDER_LINE_NO, PRES_DRUG_CODE, ORDERING_FACILITY_ID, DISP_DRUG_CODE,DISP_QTY,DISP_UOM_CODE,ADDED_BY_ID,ADDED_DATE ,ADDED_AT_WS_NO,ADDED_FACILITY_ID, MODIFIED_BY_ID,MODIFIED_DATE ,MODIFIED_AT_WS_NO , MODIFIED_FACILITY_ID,DOC_SRL_NO,FILL_REMARKS_CODE,FILL_TASK_FINDING ,LABEL_CAU_INSTRN1_ENG,LABEL_CAU_INSTRN2_ENG,LABEL_SPL_INSTRN1_ENG,LABEL_SPL_INSTRN2_ENG,LABEL_PAT_INSTRN1_ENG,LABEL_CAU_INSTRN1_LOC,LABEL_CAU_INSTRN2_LOC,LABEL_SPL_INSTRN1_LOC,LABEL_SPL_INSTRN2_LOC,LABEL_PAT_INSTRN1_LOC,DELIVERY_REMARKS_CODE,DELIVERY_TASK_FINDING,ALLOCATE_REMARKS_CODE,ALLOCATE_TASK_FINDING,BL_INCL_EXCL_OVERRIDE_VALUE,BL_INCL_EXCL_OVERRIDE_REASON,PRES_REMARK_CODE,DSN_REFERENCE,CERT_REIMB_APPL_YN,DRUG_INDICATION,APPROVAL_NO)VALUES (?,?,SYSDATE,?,?,?,?,?,?,?,?,?,?,SYSDATE,?,?,?,SYSDATE,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");//DRUG_INDICATION added for  ML-BRU-CRF-072[Inc:29938] and Approval no added for AAKH-CRF-117

			sqlMap.put("SQL_PH_DISP_MEDI_EDIT_INSTRUCTIONS" , PhRepository.getPhKeyValue("SQL_PH_DISP_MEDI_EDIT_INSTRUCTIONS"));	
			sqlMap.put("SQL_PH_DISP_MEDI_EDIT_INT_RESULTS" , PhRepository.getPhKeyValue("SQL_PH_DISP_MEDI_EDIT_INT_RESULTS"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT33",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT33"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_HDR_COUNT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT47"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_HDR_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE3"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_DTL_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE2"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_BATCH_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT56",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT56"));		
			
			sqlMap.put("SQL_PH_WORKSHEET_HDR_INSERT",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_HDR_INSERT"));		
			//sqlMap.put("SQL_PH_WORKSHEET_HDR_INSERT","INSERT INTO PH_WORKSHEET_HDR(FACILITY_ID, DISP_LOCN, WORKSHEET_ID, MFG_UNIT, WS_PREP_BY, PREP_DATE_TIME, WS_TYPE, WS_STATUS, ADDED_BY_ID, ADDED_DATE, ADDED_AT_WS_NO, ADDED_FACILITY_ID, MODIFIED_BY_ID, MODIFIED_DATE, MODIFIED_AT_WS_NO, MODIFIED_FACILITY_ID,BATCH_ID, EXPIRY_DATE, QTY_VOLUME, QTY_UOM,ORDER_ID,ADMIN_INSTRUCTION,FINALIZED_YN,ADMX_PREP_CHARGE_ITEM_CODE,ADMX_PREP_CHARGE_UNITS,PRODUCT_CODE ) VALUES(?,?,?,?,?,SYSDATE,?,?,?,SYSDATE,?,?,?,SYSDATE,?,?,?,TO_DATE(?,'DD/MM/YYYY hh24:mi'),?,?,?,?,?,?,?,?) ");		
			sqlMap.put("SQL_PH_WORKSHEET_DTL_INSERT",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_DTL_INSERT"));
			sqlMap.put("SQL_PH_WORKSHEET_ID_COUNT",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_ID_COUNT"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT57",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT57"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT58",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT58"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_UPDATE"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT58",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT58"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT67","SELECT DOC_SRL_NO FROM PH_DISP_DTL_TMP WHERE ORDER_ID=? AND ORDER_LINE_NO=?");	
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DELETE4",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE4"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DELETE5",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DELETE5"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT159",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT159"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT160",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT160"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT167",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT167"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT169",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT169"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE3A",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE3A"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE4A",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE4A"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE8",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE8"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE9",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE9"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2"));
			sqlMap.put("SQL_PH_INSERT_DISP_CONS_BATCH","INSERT INTO PH_DISP_CONS_BATCH(FACILITY_ID,DISP_NO,SRL_NO ,SRL_NO_BATCH,DISP_LOCN_CODE,STORE_CODE,CONS_CODE,BATCH_ID,EXPIRY_DATE,TRADE_ID,DISP_QTY,DISP_QTY_UOM,BIN_LOCATION_CODE, LOOSE_STOCK_YN,ADDED_BY_ID,ADDED_DATE,ADDED_AT_WS_NO,ADDED_FACILITY_ID,MODIFIED_BY_ID,MODIFIED_DATE,MODIFIED_AT_WS_NO, MODIFIED_FACILITY_ID) values(?,?,?,?,?,?,?,?,TO_DATE(?,'DD/MM/YYYY'),?,?,?,?,?,?,SYSDATE,?,?,?,SYSDATE,?,?)");
			sqlMap.put("SQL_PH_INSERT_PH_DISP_CONS_DTL","INSERT INTO PH_DISP_CONS_DTL (FACILITY_ID,DISP_TRN_SEQ_NO,DISP_NO,SRL_NO,ORDERING_FACILITY_ID,ORDER_ID,ORDER_LINE_NO,DISP_LOCN_CODE,STORE_CODE,ORDER_CONS_CODE,DISP_CONS_CODE,DISP_ITEM_CODE,STK_UOM_CODE,DISP_QTY,DISP_UOM_CODE,BL_INCL_EXCL_OVERRIDE_VALUE,BL_INCL_EXCL_OVERRIDE_REASON,DAILY_DISP_SRL_NO,STATUS,ADDED_BY_ID,ADDED_DATE,ADDED_AT_WS_NO,ADDED_FACILITY_ID,MODIFIED_BY_ID,MODIFIED_DATE,MODIFIED_AT_WS_NO,MODIFIED_FACILITY_ID) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,SYSDATE,?,?,?,SYSDATE,?,?)");

			/*InitialContext context = new InitialContext() ;
			Object object			= context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION_WORK_SHEET") ) ;
			home = (DispMedicationWorkSheetHome) PortableRemoteObject.narrow( object, DispMedicationWorkSheetHome.class ) ;
			remote = home.create() ;
			HashMap result = remote.modify( tabData, sqlMap ) ;*/
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION_WORK_SHEET" ),DispMedicationWorkSheetHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;

			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();
			HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);
			if( ((Boolean) result.get( "result" )).booleanValue() )	{
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
				map.put( "flag",(String)result.get("flag"));
				if(result.containsKey("SAL_DOC_DTLS") && getDispDocNo().equals("Y") && disp_locn_catg.equals("I") ){//Added for AMS-CRF-0079 [IN:050762] -start
					setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
					if(alSalDocDtls != null && alSalDocDtls.size()>0){
						StringBuffer sbSalDocDtls = new StringBuffer();
						for(int i=0; i<alSalDocDtls.size(); i++){
							if(i ==0)
								sbSalDocDtls.append("Document Reference Number: <b>");
							if(i>0)
								sbSalDocDtls.append(" , ");
							sbSalDocDtls.append(alSalDocDtls.get(i));
						}
						map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")+"\n" +sbSalDocDtls.toString()+"</b>") ;
					}
				}//Added for AMS-CRF-0079 [IN:050762]-end
			}
			else{
				String msg_id= (String)result.get("msgid");
				String orig_msg_id = msg_id; //Added for for MMS-SCF-0306 [IN:047499]-start
				String message="";
				int index = msg_id.indexOf(":-");
				if(index== -1)
					index = msg_id.length(); //for MMS-SCF-0306 [IN:047499] -end
				//msg_id=msg_id.substring(32,index);//24->32 //Commented for for MMS-SCF-0306 [IN:047499]
				msg_id=msg_id.substring(32,index);//Added for for MMS-SCF-0306 [IN:047499]
				if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
					index = orig_msg_id.indexOf(":- :"); //Added for for MMS-SCF-0306 [IN:047499]- start
					if(index >0)
						message = getMessage(getLanguageId(),msg_id,"PH")+" for "+ orig_msg_id.substring(index+4, orig_msg_id.length());
					else
						message = getMessage(getLanguageId(),msg_id,"PH");
						map.put( "message", message) ; //Added for for MMS-SCF-0306 [IN:047499]-end
					//map.put( "message", getMessage(getLanguageId(),msg_id,"PH") ) ; //Commented for for MMS-SCF-0306 [IN:047499]
				}
				else{
					msg_id= (String)result.get("msgid");
					msg_id = msg_id.replace("javax.ejb.EJBException:","");
					map.put( "message", msg_id ) ;
				}
				map.put("flag","0");
			}
		}
		catch(Exception e){
			System.err.println("==error in dispense== completeWSAllocation tabData===="+tabData);			
			e.printStackTrace();
		}
		return map;
	}
	
	public HashMap completeTPNWSAllocation(){
		//Connection	cnFillDely		= null;
		HashMap map					= new HashMap();
		ArrayList TotalTpnValues	= new ArrayList();
		HashMap tabData = new HashMap() ;
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		Connection connection	= null;// added for ML-MMOH-CRF-0468
		//DispMedicationTPNWorkSheetHome home	= null;
		//DispMedicationTPNWorkSheetRemote remote = null;
		try{
			/*InitialContext context = new InitialContext() ;
			Object object			= context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION_TPN_WORK_SHEET") ) ;
			home = (DispMedicationTPNWorkSheetHome) PortableRemoteObject.narrow( object, DispMedicationTPNWorkSheetHome.class ) ;
			remote = home.create() ;*/
			connection = getConnection() ;// added for ML-MMOH-CRF-0468
			boolean siteTpn = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","TPN_MF_LABEL");// added for ML-MMOH-CRF-0468
			ArrayList orderLineData			= new ArrayList() ;
			ArrayList orderLineData1		= new ArrayList() ;
			ArrayList patientDrugProfileData = new ArrayList() ;
			ArrayList dispTMP				= new ArrayList();
			ArrayList TPNDetails			= new ArrayList();
			ArrayList reason				= null;
			String temp_DrugReson="",complete_order="",order_id="",order_line_num="";   // Added for CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706 --begin
			HashMap complete_status = new HashMap();
			HashMap complete_order_reason = new HashMap();							// CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706 --end
			for(int i=0;i<forAllocation.size();i++){
				if(forAllocation.containsKey("order_line_num"+(i+1))){
					if(disp_level.equals("P")) {     // Added for CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706  -- begin
						order_id =(String)forAllocation.get("order_id"+(i+1));
					} 
					else {
						order_id =(String)forAllocation.get("order_id");
					}
					order_line_num =(String)forAllocation.get("order_line_num"+(i+1));
					objAllStages.setOrderCheckedYn(order_id+"@"+order_line_num, "Y"); // Added for MMS-KH-CRF-0028 [IN070605]
					temp_DrugReson = forAllocation.get("ComplteOrderReason"+(i+1))==null?"":(String)forAllocation.get("ComplteOrderReason"+(i+1)); 
					complete_order =  forAllocation.get("CompleteOrder"+(i+1))==null?"":(String)forAllocation.get("CompleteOrder"+(i+1)); // CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706  -- end
					if(forAllocation.get("hold"+(i+1))==null || ((String)forAllocation.get("hold"+(i+1))).equals("")){
						if((((String)forAllocation.get("hold_status"+(i+1))).equals(""))||((String)forAllocation.get("hold_status"+(i+1))).equals("disabled")){
							orderLineData.add("N");					// N - Not Hold and allocated
							patientDrugProfileData.add("N");
						}
						else{
							orderLineData.add("NN");					// NN - Not Hold and Not Allocated
							patientDrugProfileData.add("NN");
						}
					}
					else{
						orderLineData.add("Y");							// Y - Hold
						patientDrugProfileData.add("Y");
					}
					orderLineData.add(login_by_id.trim());
					patientDrugProfileData.add(login_by_id.trim());
					reason = objAllStages.getBeanReason((i+1)+"");
					if(reason.size()>=2){
						patientDrugProfileData.add((String)reason.get(1));
						orderLineData.add((String)reason.get(2));
					}
					else{
						patientDrugProfileData.add("");
						orderLineData.add("");
					}
					patientDrugProfileData.add((String)forAllocation.get("patient_id"));
					orderLineData.add((String)forAllocation.get("order_id"));
					patientDrugProfileData.add((String)forAllocation.get("order_id"));
					orderLineData.add((String)forAllocation.get("order_line_num"+(i+1)));

					patientDrugProfileData.add((String)forAllocation.get("order_line_num"+(i+1)));					
					if(forAllocation.containsKey("pat_reqd_"+(i+1))){
						if(((String)forAllocation.get("pat_reqd_"+(i+1))).trim().equals("C")){
							orderLineData1.add((String)forAllocation.get("pat_reqd_"+(i+1))==null?"":(String)forAllocation.get("pat_reqd_"+(i+1)));	
							if(disp_level.equals("P")) {
								orderLineData1.add((String)forAllocation.get("order_id"+(i+1)));
							}
							else {
								orderLineData1.add((String)forAllocation.get("order_id"));
							}
							orderLineData1.add((String)forAllocation.get("order_line_num"+(i+1)));
						}
					}
					if( !(forAllocation.get("CompleteOrder"+(i+1))!=null && forAllocation.get("CompleteOrder"+(i+1)).equals(""))) {	 // Added for CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706  -- begin
						orderLineData.add((String)forAllocation.get("CompleteOrder"+(i+1)));	
						complete_status.put((order_id+order_line_num),"Y");
						complete_order_reason.put((order_id+order_line_num),(String)forAllocation.get("ComplteOrderReason"+(i+1)));
					} 
					else{
						orderLineData.add("N");
						complete_status.put((order_id+order_line_num),"N");
					}					//  CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706  -- end
				}
			}
						
			dispTMP		= objAllStages.getTPNValues();
			TPNDetails	= objAllStages.setTPNDetails();
		
			TotalTpnValues.add((String)forAllocation.get("order_id"));
			TotalTpnValues.add("1");
			TotalTpnValues.add(getPrescQty());
			TotalTpnValues.add(getPrescQty());
			TotalTpnValues.add(objAllStages.getTPNQty());
			TotalTpnValues.add(getQtyUom());
			TotalTpnValues.add((ArrayList)dispTMP);	
			tabData = new HashMap() ;
			tabData.put( "properties", getProperties() );
			tabData.put( "disp_stage", getDispStage());
			tabData.put( "facility_id", login_facility_id.trim() );
			tabData.put( "login_at_ws_no", login_at_ws_no.trim());
			tabData.put( "login_by_id", login_by_id.trim());
			tabData.put( "disp_locn_code", getDispLocnCode().trim() );
			tabData.put( "patient_class", getDispLocnCatg().trim() );
			tabData.put( "source_code",forAllocation.get("source_code"));
			tabData.put( "source_type",forAllocation.get("source_type"));
			tabData.put( "today",getTodaysDate());
			tabData.put( "ordering_facility_id",getOrderingFacility());
			tabData.put( "ord_date_time",forAllocation.get("ord_date_time"));
			tabData.put( "performing_pract_id",forAllocation.get("performing_pract_id"));
			tabData.put( "patient_id", forAllocation.get("patient_id"));
			tabData.put( "encounter_id", forAllocation.get("encounter_id"));
			tabData.put("store_code",getStoreCode());
			tabData.put( "dateTime",getTodaysDateTime());
			tabData.put( "delivery_applicable", getDeliveryApplicable()); //checkDeliveryApplicability
			tabData.put( "orderLineData", orderLineData );
			tabData.put( "orderLineData1", orderLineData1 );
			tabData.put( "patientDrugProfileData", patientDrugProfileData );
			tabData.put( "dispTMP", TotalTpnValues );
			tabData.put( "ws_type",getWsType());
			tabData.put("approvalNo",getApprovalNo());//AAKH-CRF-0117
			System.err.println("getApprovalNo())==========3509===>"+getApprovalNo());
			//if else condtion added for ml-mmoh-crf-0468 start
			if(siteTpn && getWsType().equals("7") ){
			
				tabData.put( "ws_status","C");
			}
			else{
				tabData.put( "ws_status",getWsStatus());
			}
			//if else condtion added for ml-mmoh-crf-0468 end
			
			tabData.put( "stock","true");
			tabData.put( "TPNDetails",TPNDetails);
			tabData.put( "overage_volume",objAllStages.getOverageVol());
			tabData.put( "overage_volume_uom",objAllStages.getOverageVolUom());
			tabData.put( "LanguageId",getLanguageId());
			tabData.put( "DispBillingStage",getDispBillStage());
			tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
			tabData.put( "delivery_details",getDeliveryDetails());
			tabData.put("IV_PREP_YN", getWsType());
			tabData.put("dispMedStages",getDispMedStages());//Added for //added for SKR-SCF-0611 [IN:034816]
			tabData.put("complte_order_reason",complete_order_reason);// Added for CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706  
			tabData.put("st_decimal_restriction", getPhStDecimalRestrictionYN());//added for MMS-DM-SCF-0210 [IN:059660]
			if(forAllocation.containsKey("mark_up_down")){
				tabData.put( "admx_prep_charge_units",forAllocation.get("mark_up_down"));
			}
			if(forAllocation.containsKey("ItemForAdmixPrepCharges")){
				tabData.put( "admx_prep_charge_item_code",forAllocation.get("ItemForAdmixPrepCharges"));
			}			
			if(forAllocation.containsKey("admx_prep_charges_appl_yn")){
				tabData.put("admx_prep_charges_appl_yn",forAllocation.get("admx_prep_charges_appl_yn"));
			}
			tabData.put("ORDER_ID_ATTENDED_PRACT_ID",this.order_id_Attended_pract_id);
			ArrayList arr_list=new ArrayList();
			if(getMfgUnitDetails().size()==0){
				arr_list.add("");
				arr_list.add("");
				arr_list.add("");
				arr_list.add("0");
				arr_list.add("");
				arr_list.add("");
				arr_list.add("N");
				arr_list.add("");				
				tabData.put("mfg_unit_details",arr_list);
			}
			else{
				tabData.put("mfg_unit_details",getMfgUnitDetails());
			}
		
			HashMap sqlMap = new HashMap() ;
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE_FOR_WS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE_FOR_WS"));			
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_WS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_WS"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1"));
			//sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_INSERT"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_DRUG_BATCH_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DRUG_BATCH_TMP_INSERT"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DISP_DTL_TMP_INSERT"));
			sqlMap.put("SQL_PH_DISP_MEDI_EDIT_INSTRUCTIONS" , PhRepository.getPhKeyValue("SQL_PH_DISP_MEDI_EDIT_INSTRUCTIONS"));	
			sqlMap.put("SQL_PH_DISP_MEDI_EDIT_INT_RESULTS" , PhRepository.getPhKeyValue("SQL_PH_DISP_MEDI_EDIT_INT_RESULTS"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT33",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT33"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_HDR_COUNT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HDR_COUNT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DTL_COUNT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DTL_COUNT"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_DTL_DELETE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DTL_DELETE1"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_HDR_DELETE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HDR_DELETE1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT56",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT56"));			
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE"));			
			sqlMap.put("SQL_PH_WORKSHEET_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_UPDATE1"));			
			sqlMap.put("SQL_PH_TPN_WORKSHEET_HDR_SELECT",PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_HDR_SELECT"));	
			sqlMap.put("SQL_PH_WORKSHEET_TPN_DTL_INSERT1",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_TPN_DTL_INSERT1"));			
			sqlMap.put("SQL_PH_WORKSHEET_TPN_HDR_INSERT",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_TPN_HDR_INSERT"));			
			sqlMap.put("SQL_PH_TPN_WORKSHEET_ID_COUNT",PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_ID_COUNT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_TPN_WS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_TPN_WS"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT144",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT144"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT159",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT159"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT160",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT160"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT2"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2A",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2A"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2")); // Added for CRF-PH- Bru-HIMS-CRF-087/12 -TPN  IN#38706 
			
			
			//HashMap result = remote.modify( tabData, sqlMap ) ;
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION_TPN_WORK_SHEET" ),DispMedicationTPNWorkSheetHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;
			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();
			HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);
			if( ((Boolean) result.get( "result" )).booleanValue() )	{
				prevWorkSheetDetails=null;
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
				map.put( "flag",(String)result.get("flag"));
				if(result.containsKey("SAL_DOC_DTLS") && getDispDocNo().equals("Y") && disp_locn_catg.equals("I")){//Added for AMS-CRF-0079 [IN:050762] -start
					setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
					if(alSalDocDtls != null && alSalDocDtls.size()>0){
						StringBuffer sbSalDocDtls = new StringBuffer();
						for(int i=0; i<alSalDocDtls.size(); i++){
							if(i ==0)
								sbSalDocDtls.append("Document Reference Number: <b>");
							if(i>0)
								sbSalDocDtls.append(" , ");
							sbSalDocDtls.append(alSalDocDtls.get(i));
						}
						map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")+"\n" +sbSalDocDtls.toString()+"</b>") ;
					}
				}//Added for AMS-CRF-0079 [IN:050762]-end
			}
			else{
				String msg_id= (String)result.get("msgid");
				String orig_msg_id = msg_id; //Added for for MMS-SCF-0306 [IN:047499]- start
				String message="";
				int index = msg_id.indexOf(":-");
				if(index== -1)
					index = msg_id.length(); //Added for for MMS-SCF-0306 [IN:047499] -end
				//msg_id=msg_id.substring(24,(msg_id.length())); //Commented for for MMS-SCF-0306 [IN:047499]
				msg_id=msg_id.substring(32,index); //Added for -for MMS-SCF-0306 [IN:047499]
				if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
					//map.put( "message", getMessage(getLanguageId(),msg_id,"PH") ) ; //Commented for for MMS-SCF-0306 [IN:047499]
					index = orig_msg_id.indexOf(":- :"); //Added for MMS-SCF-0306 [IN:047499] -start
					if(index >0)
						message = getMessage(getLanguageId(),msg_id,"PH")+" for "+ orig_msg_id.substring(index+4, orig_msg_id.length());
					else
						message = getMessage(getLanguageId(),msg_id,"PH");
					map.put( "message", message) ; //Added for for MMS-SCF-0306 [IN:047499] -end
				}
				else{
					msg_id= (String)result.get("msgid");
					msg_id = msg_id.replace("javax.ejb.EJBException:","");
					map.put( "message", msg_id ) ;
				}
				map.put("flag","0");
			}
		}
		catch(Exception e){
			System.err.println("error in dispense completeTPNWSAllocation =tabData"+tabData);
			e.printStackTrace();
		}
		//Added for ML-MMOH-CRF-0468 START
				finally{
					try {
						closeConnection( connection );
					} catch (Exception e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					
					}
				//Added for ML-MMOH-CRF-0468 end
		return map;
	}

	public void prseCtrlNmUpd(String CtrlName){
		ArrayList alSelOrderIds = new ArrayList();
		ArrayList alSelOrderLineNumbers = new ArrayList();
		//alSelOrderIds.clear();
		String strPatientId			= "";
		String strOrderId			= "";
		String strSelOpt			= "";
		String strOrderLineNumber	= "";
		String[] sOrderPatIds = CtrlName.split("_");
		if(sOrderPatIds.length == 4){
			strPatientId		= sOrderPatIds[0].substring(3,sOrderPatIds[0].length());
			strOrderId			= sOrderPatIds[1];
			strOrderLineNumber	= sOrderPatIds[3];
			strSelOpt = (String) forFillDelivery.get(CtrlName);
			if(strSelOpt.equals("Y") ){
				// This is to update the orderId for a patient in to the variable pa_ord_sel_ht
				if( pa_ord_sel_ht.containsKey(strPatientId) ){
					alSelOrderIds = (ArrayList) pa_ord_sel_ht.get(strPatientId);
					alSelOrderIds.add(strOrderId);
				}
				else{
					alSelOrderIds.add(strOrderId);
					pa_ord_sel_ht.put(strPatientId,alSelOrderIds);
				}
				// To remove the duplicate order ids in the arraylist --- start
				HashSet hsRemoveDuplicate = new HashSet(alSelOrderIds);
				alSelOrderIds.clear();
				alSelOrderIds.addAll(hsRemoveDuplicate);
				// To remove the duplicate order ids in the arraylist ----- end
				// This is to update the orderLineNumber for a order id in to the variable hmOrderLineNumbers
				if( hmOrderLineNumbers.containsKey(strOrderId) ){
					alSelOrderLineNumbers = (ArrayList) hmOrderLineNumbers.get(strOrderId);
					alSelOrderLineNumbers.add(strOrderLineNumber);
				}
				else{
					alSelOrderLineNumbers.add(strOrderLineNumber);
					hmOrderLineNumbers.put(strOrderId,alSelOrderLineNumbers);
				}
				// To sort the orderLineNumbers
				Collections.sort(alSelOrderLineNumbers);
			}
		}
		/*int nFirstIdx				= 0;
		int nSecondIdx				= 0;
		nFirstIdx = CtrlName.indexOf("_");
		strPatientId	= CtrlName.substring(3,nFirstIdx);
		nSecondIdx		= CtrlName.lastIndexOf("_");
		if(nSecondIdx >=0 && (nFirstIdx != nSecondIdx) ){
			strOrderId		= CtrlName.substring(nFirstIdx+1,nSecondIdx);
			strSelOpt = (String) forFillDelivery.get(CtrlName);
			if(strSelOpt.equals("Y") )	{
				if( pa_ord_sel_ht.containsKey(strPatientId) ){
					pa_ord_sel_Orders = (ArrayList) pa_ord_sel_ht.get(strPatientId);
					pa_ord_sel_Orders.add(strOrderId);
				}
				else{
					pa_ord_sel_Orders.add(strOrderId);
					pa_ord_sel_ht.put(strPatientId,pa_ord_sel_Orders);
				}
			}
		}*/
	}

	public String getTotalDispQty(String order_id) throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String result			= "";
		try {
			connection	= getConnection() ;
			pstmt	= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_DISP_MEDN_SEL_DISP_QTY")) ;
			pstmt.setString(1,order_id);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result = checkForNull(resultSet.getString("TOT_DISPENSED"));
			}
		}
		catch ( Exception e ) {
			System.err.println("Error in getTotalDispQty order_id="+order_id ) ;
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return result;
	}

	public HashMap completeFillDelivery(){
		Connection			cnFillDely		= null;
		PreparedStatement	pstFillDely		= null;
		PreparedStatement	pstFillDely1	= null;
		PreparedStatement	pstItemCost		= null;
		//PreparedStatement	pstTradeId		= null;
		ResultSet			rsFillDely		= null;
		ResultSet			rsFillDely1		= null;
		ResultSet			rsItemCost		= null;
		//ResultSet			rsTradeId		= null;
		ArrayList drug_detail_for_OrderId	= new ArrayList();
		ArrayList drug_detail_for_OrderId_1	= new ArrayList();
		ArrayList dispTmp					= new ArrayList();
		drug_detail_for_OrderId.clear();
		dispTmp.clear();
		String strBatch_Id			= "";
		String strBin_Locn_Code		= "";
		String strEndDateTime		= "";
		String strExpiry_Date		= "";
		String strIssue_Qty			= "";
		String strItem_Drug_Code	= "";
		String strItem_Cost			= "";
		String strObjName			= "";
		String strQty_Uom			= "";
		String strStore_Code		= "";
		String strTradeId			= "";
		//String strOrderLineNumber	= ""; Removed for IN063877
		HashMap Consumable_det = new HashMap();//code added for Medical items
	//	DispMedicationHome home	= null;
	//	DispMedicationRemote remote	= null;
		HashMap map	=	new HashMap();
		HashMap tabData = new HashMap() ;
		HashMap mapPadispTmp = new HashMap();
		map.put( "result", new Boolean( false )) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		// Iterating the Hashtable to findout the control name for <patient_order_seq No> to split
		// the Patient Id and Order Id and put the Order Id in the ArrayList
		Enumeration enFill_Delivery	= forFillDelivery.keys();

		while (enFill_Delivery.hasMoreElements()){
			strObjName = (String) enFill_Delivery.nextElement();
			if(strObjName.indexOf("_") >= 0)
				prseCtrlNmUpd(strObjName);
		}
		// To get the Batch Details for a particular Order Id
		try{
			cnFillDely = getConnection();
			pstFillDely		= cnFillDely.prepareStatement( PhRepository.getPhKeyValue("SQL_DISP_MEDN_SEL_BATCH_RECORDS") );
			pstFillDely1	= cnFillDely.prepareStatement( PhRepository.getPhKeyValue("SQL_DISP_MEDN_SEL_DRUG_DTLS") );
			pstItemCost		= cnFillDely.prepareStatement( PhRepository.getPhKeyValue("SQL_DISP_MEDN_GET_PAT_ORDER_ENDDATETIME"));
			//pstTradeId		= cnFillDely.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT107"));

			String	strPatId	= "";
			String disp_drug_code = "";
			StringBuffer order_ids = new StringBuffer();//code added for Medical items

			Enumeration PaOrdSel = pa_ord_sel_ht.keys();
			// Iteratin the Hashtable for Patient Id 
			while ( PaOrdSel.hasMoreElements() ){
				strPatId = (String) PaOrdSel.nextElement();
				//dispTmp.clear();
				dispTmp	=	new ArrayList();
				ArrayList PaOrdAlTmp = new ArrayList();
				// Getting the Order Ids for a Particular Patienet Id
				PaOrdAlTmp = (ArrayList) pa_ord_sel_ht.get(strPatId);
				int nAlSize = PaOrdAlTmp.size();
				// Iterating thru the Order Id ARRAYLIST to get batch details,drug details for each order Id
				order_ids = new StringBuffer();//code added for Medical items
				for(int nCtr = 0; nCtr < nAlSize; nCtr++){
					String sOrderId = (String)PaOrdAlTmp.get(nCtr);
					ArrayList alOrderLineNos = (ArrayList)hmOrderLineNumbers.get(sOrderId);
					if(order_ids.length()>0){//code added for Medical items
						order_ids.append(",");
					}
					order_ids.append("'").append(sOrderId).append("'");	//code added for Medical items
					for(int p=0;p<alOrderLineNos.size();p++){
						drug_detail_for_OrderId = new ArrayList(); // contains batch details of the curent order id 
						drug_detail_for_OrderId.clear();
						pstFillDely.setString(1,(String)PaOrdAlTmp.get(nCtr));
						pstFillDely.setString(2,(String)alOrderLineNos.get(p));
						rsFillDely = pstFillDely.executeQuery();
						while(rsFillDely.next()){		// To get Multiple Batch Id's if available
							strItem_Drug_Code	= rsFillDely.getString("ITEM_CODE");
							strBatch_Id			= rsFillDely.getString("BATCH_ID");
							strExpiry_Date		= rsFillDely.getString("EXPIRY_DATE");
							strIssue_Qty		= rsFillDely.getString("DISP_QTY");
							strQty_Uom			= rsFillDely.getString("DISP_QTY_UOM");
							strBin_Locn_Code	= rsFillDely.getString("BIN_LOCATION_CODE");	
							strStore_Code		= rsFillDely.getString("STORE_CODE");
							strTradeId		= rsFillDely.getString("TRADE_ID");
							//strOrderLineNumber	= rsFillDely.getString("ORDER_LINE_NO");
							drug_detail_for_OrderId.add(strItem_Drug_Code);						
							drug_detail_for_OrderId.add(strBatch_Id);
							drug_detail_for_OrderId.add(strExpiry_Date);
							drug_detail_for_OrderId.add(strIssue_Qty);
							drug_detail_for_OrderId.add(strQty_Uom);
							drug_detail_for_OrderId.add("");
							//COMMENTED FOR INCIDENT 24490 and selected trade id from ph_disp_drug_batch_tmp
							// Get the Trade Id from the Query
								/*pstTradeId.setString(1,strStore_Code);
								pstTradeId.setString(2,strItem_Drug_Code);
								pstTradeId.setString(3,strBatch_Id);
								pstTradeId.setString(4,strBin_Locn_Code);
								pstTradeId.setString(5,strExpiry_Date);
								rsTradeId = pstTradeId.executeQuery();
								if( rsTradeId.next() )
									strTradeId = rsTradeId.getString("TRADE_ID");
								else
									strTradeId = "";

								//System.out.println("bean: Trade Id : " + strTradeId);
								closeResultSet(rsTradeId);*/
							drug_detail_for_OrderId.add(strTradeId);
							drug_detail_for_OrderId.add(strBin_Locn_Code);

							// Getting the Item Cost
							pstItemCost.setString(1,(String)PaOrdAlTmp.get(nCtr));
							pstItemCost.setString(2,(String)alOrderLineNos.get(p));
							rsItemCost = pstItemCost.executeQuery();
							if(rsItemCost.next())
								strEndDateTime = rsItemCost.getString("END_DATE_TIME");
							closeResultSet(rsItemCost);
							strItem_Cost = getItemCost(strItem_Drug_Code,strStore_Code,strIssue_Qty,strEndDateTime);
							drug_detail_for_OrderId.add(strItem_Cost); 			
							//drug_detail_for_OrderId.add(strOrderLineNumber);
						}

						closeResultSet(rsFillDely);
						// To get the Drug Details of the curent Order Id
						pstFillDely1.setString(1,(String)PaOrdAlTmp.get(nCtr));
						pstFillDely1.setString(2,(String)alOrderLineNos.get(p));
						rsFillDely1 = pstFillDely1.executeQuery();
						//String prev_disp_drug_code ="";
						while( rsFillDely1.next()){
							dispTmp.add(rsFillDely1.getString("ORDER_ID"));
							dispTmp.add(rsFillDely1.getString("ORDER_LINE_NO"));
							dispTmp.add(rsFillDely1.getString("PRES_DRUG_CODE"));
							dispTmp.add(rsFillDely1.getString("DISP_DRUG_CODE"));
							dispTmp.add(rsFillDely1.getString("DISP_QTY"));
							dispTmp.add(rsFillDely1.getString("DISP_UOM_CODE"));
							drug_detail_for_OrderId_1=new ArrayList();
							for (int m=0; m<drug_detail_for_OrderId.size(); m=m+9){
								disp_drug_code =(String)drug_detail_for_OrderId.get(m);
								if(disp_drug_code.equals(rsFillDely1.getString("DISP_DRUG_CODE"))){
									/* if(!prev_disp_drug_code.equals(disp_drug_code)&&!prev_disp_drug_code.equals("")){
											drug_detail_for_OrderId_1=new ArrayList();	
											dispTmp.add((ArrayList)drug_detail_for_OrderId_1);
										}*/
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m));						
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+1));
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+2));
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+3));
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+4));
										drug_detail_for_OrderId_1.add("");
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+6));
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+7));
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+8));
										drug_detail_for_OrderId_1.add(drug_detail_for_OrderId.get(m+4));//Added for  MMS-SCF-0040 [IN:041888]
									// prev_disp_drug_code =disp_drug_code;
										/*if((drug_detail_for_OrderId.size()-9) ==m){
											drug_detail_for_OrderId_1=new ArrayList();	
											dispTmp.add((ArrayList)drug_detail_for_OrderId_1);						
										}*/
									// drug_detail_for_OrderId_1=new ArrayList();	
								}	
							}
							dispTmp.add((ArrayList)drug_detail_for_OrderId_1);
							drug_detail_for_OrderId_1=new ArrayList();	
						}
						closeResultSet(rsFillDely1);
					}
				}
	//code added for medical items
				Consumable_det.put(strPatId,getDispensedConsumableOrderDetailsForFillDelivery( order_ids.toString(), getDispLocnCode() ));
				// Patient Id, dispTmp HashMap (so dispTmp will be available for each Patient)
				if(dispTmp.size()>0){
					mapPadispTmp.put(strPatId, dispTmp);
				}
			}
		}
		catch (Exception e){
			try	{
				if(rsFillDely1 != null)
					closeResultSet( rsFillDely1 ) ;

				if(pstFillDely != null)
					closeStatement( pstFillDely ) ;

				if(pstFillDely1 != null)
					closeStatement( pstFillDely1 ) ;

				if(pstItemCost != null)
					closeStatement( pstItemCost ) ;

				//if(pstTradeId != null)
					//closeStatement( pstTradeId ) ;

				if(cnFillDely != null)
					closeConnection( cnFillDely );
			}
			catch (Exception e1){
				e1.printStackTrace();	
			}
			e.printStackTrace();
		}
		// Building the Structure
		tabData = new HashMap() ;
		tabData.put( "properties", getProperties() );
		tabData.put( "disp_stage", getDispStage());
		tabData.put( "login_by_id", login_by_id.trim());
		tabData.put( "login_at_ws_no", login_at_ws_no.trim());
		tabData.put( "facility_id", login_facility_id.trim() );
		tabData.put( "fill_list",getFillList());
		tabData.put( "pat_ord_sel",pa_ord_sel_ht);
		tabData.put( "hmOrderLineNumbers",hmOrderLineNumbers);
		tabData.put( "dateTime", getTodaysDateTime());
		tabData.put( "fill_proc_id",getFillProcessID());
		tabData.put( "disp_locn_code",getDispLocnCode() );
		tabData.put( "today",getTodaysDate());
		tabData.put( "patient_class", getDispLocnCatg().trim() );
		tabData.put( "mode",getMode());
		tabData.put( "store_code",getStoreCode());
		tabData.put( "LanguageId",getLanguageId());
		tabData.put( "token_vals",new HashMap());
		tabData.put("DISP_CASH_COLL_STAGE", getDispCashCollStage());
		tabData.put("ORDER_ID_ATTENDED_PRACT_ID",this.order_id_Attended_pract_id);
		tabData.put("IPFillProcess",getFillUnit());
		tabData.put("IPFillPeriodAhead",getFillPeriod());
		tabData.put( "ordering_facility_id",getOrderingFacility());
		tabData.put("IV_PREP_YN", getWsType());
		tabData.put("ALTDRUGREMARKS",objAllStages.getAltDrugRemarks());//Added for Bru-HIMS-CRF-082 [IN:029948]
		tabData.put("editableLabel",objAllStages.getEditableLabel());//added for Bru-HIMS-CRF-414 [IN:045554]
		tabData.put("allow_edit_disp_label", getAllowEditDispLabel());//added for Bru-HIMS-CRF-414 [IN:045554]
		tabData.put("editableLabelLangId", getEditableLabelLangId());//added for Bru-HIMS-CRF-414 
		tabData.put("st_decimal_restriction", getPhStDecimalRestrictionYN());//added for MMS-DM-SCF-0210 [IN:059660]
		// Strucutred changed for each Patient in the dispTmp
		tabData.put("dispTmp",mapPadispTmp);
		//code added for medical items
		tabData.put("CONSUMABLES_DET_ALL",Consumable_det);
		tabData.put("TRN_RX_IDS_PATIENTWISE",this.trn_rx_ids_patientwise);
		HashMap sqlMap = new HashMap() ;

		try	{
			tabData.put( "DispBillingStage",getDispBillStage());
			tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT56",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT56"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT58",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT58"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT67","SELECT DOC_SRL_NO FROM PH_DISP_DTL_TMP WHERE ORDER_ID=? AND ORDER_LINE_NO=?");		
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_UPDATE"));
			sqlMap.put("SQL_DISP_MEDN_SEL_ENC_ID",PhRepository.getPhKeyValue("SQL_DISP_MEDN_SEL_ENC_ID"));
			sqlMap.put("SQL_PH_DISP_IP_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_IP_ORDER_LINE_PH_UPDATE"));
			sqlMap.put("SQL_PH_IP_FILL_PROCESS_CAL_NO_OF_DAYS_A",PhRepository.getPhKeyValue("SQL_PH_IP_FILL_PROCESS_CAL_NO_OF_DAYS_A"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT109",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT109"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT108",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT108"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT111",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT111"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT112",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT112"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_DEL_AF",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE_FOR_DEL_AF"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT134",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT134"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT135",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT135"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT167",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT167"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2A",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2A"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DTL_TMP_UPDATE_ALT_DRUG_REMARKS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DTL_TMP_UPDATE_ALT_DRUG_REMARKS"));

			if(getAllowEditDispLabel().equals("Y")){//if block Added for Bru-HIMS-CRF-414 [IN:045554]
				sqlMap.put("SQL_PH_DISP_LABEL_UPDATE", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_UPDATE"));
				sqlMap.put("SQL_PH_DISP_LABEL_INSERT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_INSERT"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_DISP_DTL", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP1", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP1"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_COUNT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_COUNT"));
				sqlMap.put("SQL_PH_DISP_LABEL_DELETE", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_DELETE"));
				sqlMap.put("SQL_PH_DISP_LABEL_DTL_TMP_PREV_INSERT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_DTL_TMP_PREV_INSERT"));
			}

			/*InitialContext context = new InitialContext() ;
			Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION") ) ;
			home = (DispMedicationHome) PortableRemoteObject.narrow( object, DispMedicationHome.class ) ;
			remote = home.create() ;
			HashMap result = remote.modify( tabData, sqlMap ) ;*/
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION" ),DispMedicationHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;
			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();
			HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);
			if( ((Boolean) result.get( "result" )).booleanValue() ){
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
				map.put("flag","0");
				if(result.containsKey("SAL_DOC_DTLS") && getDispDocNo().equals("Y") && disp_locn_catg.equals("I")) {
					setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
					if(alSalDocDtls != null && alSalDocDtls.size()>0){//Added for AMS-CRF-0079 [IN:050762] -start
						StringBuffer sbSalDocDtls = new StringBuffer();
						for(int i=0; i<alSalDocDtls.size(); i++){
							if(i ==0)
								sbSalDocDtls.append("Document Reference Number: <b>");
							if(i>0)
								sbSalDocDtls.append(" , ");
							sbSalDocDtls.append(alSalDocDtls.get(i));
						}
						map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")+"\n" +sbSalDocDtls.toString()+"</b>") ;
					}
				}//Added for AMS-CRF-0079 [IN:050762] -end
			}
			else{
				String msg_id= (String)result.get("msgid");
				String orig_msg_id = msg_id; //Added for for MMS-SCF-0306 [IN:047499]- start
				String message="";
				int index = msg_id.indexOf(":-");
				if(index== -1)
					index = msg_id.length(); //added for for MMS-SCF-0306 [IN:047499] -end
				//msg_id=msg_id.substring(24,(msg_id.length()));				
				msg_id=msg_id.substring(32,index);//added for for MMS-SCF-0306 [IN:047499]
				if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
					index = orig_msg_id.indexOf(":- :"); //Added for for MMS-SCF-0306 [IN:047499]-start
					if(index >0)
						message = getMessage(getLanguageId(),msg_id,"PH")+" for "+ orig_msg_id.substring(index+4, orig_msg_id.length());
					else
						message = getMessage(getLanguageId(),msg_id,"PH");
					map.put( "message", message) ; //for MMS-SCF-0306 [IN:047499] -end
					//map.put( "message", getMessage(getLanguageId(),msg_id,"PH") ) ; //Commented for for MMS-SCF-0306 [IN:047499]
				}
				else{
					msg_id= (String)result.get("msgid");
					msg_id = msg_id.replace("javax.ejb.EJBException:","");
					map.put( "message", msg_id ) ;
				}
				map.put("flag","0");
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally{
			try{
				if(rsFillDely != null)
					closeResultSet( rsFillDely ) ;

				if(rsFillDely1 != null)
					closeResultSet( rsFillDely1 ) ;

				if(pstFillDely != null)
					closeStatement( pstFillDely ) ;

				if(pstFillDely1 != null)
					closeStatement( pstFillDely1 ) ;

				if(pstItemCost != null)
					closeStatement( pstItemCost ) ;

	//			if(pstTradeId != null)
				//	closeStatement( pstTradeId ) ;

				if(cnFillDely != null)
					closeConnection( cnFillDely );
				
			//	objAllStages = null;
				pa_ord_sel_ht.clear();
				hmOrderLineNumbers = new HashMap();
				pa_ord_sel_ht = null;
			}
			catch (Exception e1){
				System.err.println("Error in completeFillDelivery tabData="+tabData);
				e1.printStackTrace();	
			}
		}
		return map;
	}

	public HashMap completeTPNDelivery(){
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		HashMap tabData = new HashMap() ;

		
		//ArrayList orderLineNumbers = new ArrayList();
		ArrayList orderLineData	= new ArrayList() ;
		ArrayList orderLineData1 = new ArrayList() ;
		ArrayList holdingDetails = new ArrayList();

		ArrayList dispTMP		= new ArrayList();
		HashMap stock_srl		= new HashMap();
		float bms_qty=0;//added for ML-MMOH-SCF-1303
		int i=0;
		try{
			if(forDelivery.size()>0){
				if(forDelivery.containsKey("order_id")){
					dispTMP.add((String)forDelivery.get("order_id"));
				}
				if(forDelivery.containsKey("order_line_num"+(i+1))){
					dispTMP.add((String)forDelivery.get("order_line_num"+(i+1)));
				}
				if(forDelivery.containsKey("drug_code"+(i+1))){
					dispTMP.add((String)forDelivery.get("drug_code"+(i+1)));
				}
				if(forDelivery.containsKey("drug_code"+(i+1))){
					dispTMP.add((String)forDelivery.get("drug_code"+(i+1)));
				}
				if(forDelivery.containsKey("bms_qty"+(i+1))){//ADDED FOR ML-MMOH-SCF-1303
					bms_qty=Float.parseFloat((String)forDelivery.get("bms_qty"+(i+1)));
				}
			}
			if(forDelivery.containsKey("pat_reqd_"+(i+1))){
				if(((String)forDelivery.get("pat_reqd_"+(i+1))).trim().equals("C")){
					orderLineData1.add((String)forDelivery.get("pat_reqd_"+(i+1))==null?"":(String)forDelivery.get("pat_reqd_"+(i+1)));	
					orderLineData1.add((String)forDelivery.get("order_id"));
					orderLineData1.add((String)forDelivery.get("order_line_num"+(i+1)));
				}
			}
		
			Connection connection	= null;
			PreparedStatement pstmt	= null;
			ResultSet resultSet		= null;	

			String item_code		= "";
			String locn_code		= "";
			String Total_Disp_Qty	= "0";
			boolean siteTpn =false;//added for ML-MMOH-SCF-1304
			//DispMedicationTPNWorkSheetHome home=null;
			//DispMedicationTPNWorkSheetRemote remote=null;
			String WS_SRL_NO="";
			//System.out.println("code in bean" + code);
			try {
				String item_cost	=	"";
				String alloc_qty	=	"";
				//float alloc_qty1		=	0;
				//float item_cost1;
				String stock_unit	=	"";
				String patient_id	=	(String)forDelivery.get("patient_id");
				String order_id		=	(String)forDelivery.get("order_id");
				ArrayList orderDetails	=	getOrderLineDetails(patient_id,order_id);
				String end_date			=	(String)orderDetails.get(7);
				objAllStages.setOrderCheckedYn(order_id+"@1", "Y"); // Added for MMS-KH-CRF-0028 [IN070605]
				connection	= getConnection() ;
				 siteTpn = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","TPN_MF_LABEL");// added for ML-MMOH-SCF-1304
				pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_DRUG_DTL_SELECT")) ;

				pstmt.setString(1,(String)dispTMP.get(0));
				pstmt.setString(2,(String)dispTMP.get(1));
				
				resultSet	= pstmt.executeQuery() ;
				
				while (resultSet.next()){
					item_code=resultSet.getString("disp_item_code");
					if(item_code==null){
						item_code="";
					}
					locn_code=resultSet.getString("disp_locn");
					//alloc_qty=resultSet.getString("disp_qty");
					alloc_qty=resultSet.getString("batch1_qty");
					if(alloc_qty==null){
						alloc_qty="";
					}
					stock_unit=resultSet.getString("stock_unit");
					if(stock_unit==null){
						stock_unit="";
					}
					WS_SRL_NO=resultSet.getString("WS_SRL_NO");
				
				//if(holdingDetails.indexOf(item_code)==-1){
					if(!item_code.equals("")){
						holdingDetails.add(resultSet.getString("disp_item_code"));
						holdingDetails.add(resultSet.getString("batch_id1"));	
						holdingDetails.add(resultSet.getString("EXPIRY_DATE"));	
						
						//holdingDetails.add(resultSet.getString("disp_qty"));
						holdingDetails.add(resultSet.getString("batch1_qty"));
						stock_unit=resultSet.getString("stock_unit");
						if(stock_unit==null){
							stock_unit="";
						}
						holdingDetails.add(stock_unit);	
						holdingDetails.add("");	
						holdingDetails.add(resultSet.getString("TRADE_ID1"));	
						holdingDetails.add(resultSet.getString("bin_location_code1"));	
						
						item_cost= getItemCost(item_code, locn_code, alloc_qty, end_date);
						holdingDetails.add(item_cost);
						holdingDetails.add("");	// Added for [IN:051475]
					}			
				/*}else{
				if(!item_code.equals("")){
					if(!alloc_qty.equals("")&&holdingDetails.get(holdingDetails.indexOf(item_code)+3)!=null&&!holdingDetails.get(holdingDetails.indexOf(item_code)+3).equals("")){

						//alloc_qty1=Integer.parseInt(alloc_qty)+Integer.parseInt((String)holdingDetails.get(holdingDetails.indexOf(item_code)+3));
						alloc_qty1=Float.parseFloat(alloc_qty)+Float.parseFloat((String)holdingDetails.get(holdingDetails.indexOf(item_code)+3));
						holdingDetails.set(holdingDetails.indexOf(item_code)+3,alloc_qty1+"");		
						item_cost= getItemCost(item_code, locn_code, alloc_qty, end_date);
						item_cost1=Float.parseFloat(item_cost)+Float.parseFloat((String)holdingDetails.get(holdingDetails.indexOf(item_code)+8));	
						holdingDetails.set(holdingDetails.indexOf(item_code)+8,item_cost1+"");	
					}
				}
				}*/
					if(alloc_qty!=null){
						if(!alloc_qty.equals("")){
							Total_Disp_Qty=String.valueOf(Double.parseDouble(Total_Disp_Qty)+Double.parseDouble(alloc_qty));
						}
					}
					stock_srl.put(((String)dispTMP.get(0)).trim()+item_code,WS_SRL_NO);
					orderLineData.add(holdingDetails);
				}
				dispTMP.add(Total_Disp_Qty);
				dispTMP.add(stock_unit);			
				orderLineData.add(holdingDetails);
				dispTMP.add(holdingDetails);
				tabData = new HashMap() ;
				tabData.put( "properties", getProperties() );
				tabData.put( "disp_stage", getDispStage());
				if(siteTpn && getOrderType().equals("TD")){//if condtion added for ML-MMOH-SCF-1304
				tabData.put( "fill_list", "TD");
				tabData.put( "bms_qty", bms_qty);//ADDED FOR ML-MMOH-SCF-1303
				
				}
				else{
					tabData.put( "fill_list", "TA");
					tabData.put( "bms_qty", 0.0f);//ADDED FOR ML-MMOH-SCF-1303 and handled the exception at tpn admixture deliver for MMS-KH-CRF-0017.1
				}
				tabData.put( "login_by_id", login_by_id.trim());
				tabData.put( "login_at_ws_no", login_at_ws_no.trim());
				tabData.put( "facility_id", login_facility_id.trim() );
				tabData.put( "disp_locn_code", getDispLocnCode().trim() );
				tabData.put( "dateTime", getTodaysDateTime());
				tabData.put( "order_id",((String)forDelivery.get("order_id")).trim());
				tabData.put( "patient_id",patient_id);
				tabData.put( "patient_class", getDispLocnCatg().trim() );
				tabData.put( "order_line_numbers",((String)forDelivery.get("order_line_num1")).trim());
				tabData.put( "stock_srl",stock_srl);
				tabData.put( "holding_details",holdingDetails );
				tabData.put( "dispTMP",dispTMP );
				tabData.put( "orderLineData", orderLineData );
				tabData.put( "orderLineData1", orderLineData1 );
				tabData.put("store_code",getStoreCode());
				tabData.put( "today",getTodaysDate());
				tabData.put( "encounter_id", forDelivery.get("encounter_id"));
				tabData.put("DISP_LEVEL",disp_level);
				tabData.put("mode",getMode());			
				tabData.put( "source_type",forDelivery.get("source_type"));
				tabData.put( "LanguageId",getLanguageId());
				tabData.put( "DispBillingStage",getDispBillStage());
				tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
				tabData.put( "ordering_facility_id",getOrderingFacility());
				tabData.put("IV_PREP_YN", getWsType());
				tabData.put("st_decimal_restriction", getPhStDecimalRestrictionYN());//added for MMS-DM-SCF-0210 [IN:059660]
				tabData.put("approvalNo",getApprovalNo());//AAKH-CRF-0117
			System.err.println("getApprovalNo())==========3509===>"+getApprovalNo());

				if(forDelivery.containsKey("mark_up_down")){
					tabData.put( "admx_prep_charge_units",forDelivery.get("mark_up_down"));
				}
				if(forDelivery.containsKey("ItemForAdmixPrepCharges")){
					tabData.put( "admx_prep_charge_item_code",forDelivery.get("ItemForAdmixPrepCharges"));
				}			
				if(forDelivery.containsKey("admx_prep_charges_appl_yn")){
					tabData.put("admx_prep_charges_appl_yn",forDelivery.get("admx_prep_charges_appl_yn"));
				}

				tabData.put("ORDER_ID_ATTENDED_PRACT_ID",this.order_id_Attended_pract_id);
	 
				HashMap sqlMap = new HashMap() ;
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE_FOR_WS",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE_FOR_WS"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1"));
				sqlMap.put("SQL_PH_TPN_WORKSHEET_ID_COUNT",PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_ID_COUNT"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT56",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT56"));
				sqlMap.put("SQL_PH_WORKSHEET_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_UPDATE1"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE"));
				sqlMap.put("SQL_PH_TPN_STD_REGIMEN_INSERT6",PhRepository.getPhKeyValue("SQL_PH_TPN_STD_REGIMEN_INSERT6"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_TPN_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_TPN_SELECT2"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_PH_PATIENT_DRUG_PROFILE_TPN_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PH_PATIENT_DRUG_PROFILE_TPN_SELECT1"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT135",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT135"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT144",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT144"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT1"));
				sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT2"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2A",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2A"));
				sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2"));

	/*			InitialContext context = new InitialContext() ;
				Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION_TPN_WORK_SHEET") ) ;

				home = (DispMedicationTPNWorkSheetHome) PortableRemoteObject.narrow( object, DispMedicationTPNWorkSheetHome.class ) ;
				remote = home.create() ;

				HashMap result = remote.modify( tabData, sqlMap ) ;*/


				//HashMap result	=	new HashMap();
				/*if(result.containsKey("IR_FLAG"))
				{
					objAllStages.setIR_FLAG_VALUE((HashMap)result.get("IR_FLAG"));
				}*/

				Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION_TPN_WORK_SHEET" ),DispMedicationTPNWorkSheetHome.class,getLocalEJB());

				Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);

				Object argArray[] = new Object[2];
				argArray[0] = tabData;
				argArray[1] = sqlMap;

				Class [] paramArray = new Class[2];
				paramArray[0] = tabData.getClass(); ;
				paramArray[1] = sqlMap.getClass();

				HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
				(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);

				if( ((Boolean) result.get( "result" )).booleanValue() ){
					prevWorkSheetDetails=null;
					map.put( "result", new Boolean( true ) ) ;
					map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
					map.put("flag","0");
					if(result.containsKey("SAL_DOC_DTLS") && getDispDocNo().equals("Y") && disp_locn_catg.equals("I")){//Added for AMS-CRF-0079 [IN:050762]
						setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
						if(alSalDocDtls != null && alSalDocDtls.size()>0){
							StringBuffer sbSalDocDtls = new StringBuffer();
							for(int j=0; j<alSalDocDtls.size(); j++){
								if(i ==0)
									sbSalDocDtls.append("Document Reference Number: <b>");
								if(i>0)
									sbSalDocDtls.append(" , ");
								sbSalDocDtls.append(alSalDocDtls.get(i));
							}
							map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")+"\n" +sbSalDocDtls.toString()+"</b>") ;
						}
					}//Added for AMS-CRF-0079 [IN:050762]
				}
				else{
					String msg_id= (String)result.get("msgid");
					String orig_msg_id = msg_id; //Added for for MMS-SCF-0306 [IN:047499]- start
					String message="";
					int index = msg_id.indexOf(":-");
					if(index== -1)
						index = msg_id.length();
					//msg_id=msg_id.substring(24,(msg_id.length())); //Commented for for MMS-SCF-0306 [IN:047499]
					msg_id=msg_id.substring(32,index);//for MMS-SCF-0306 [IN:047499] -end
					if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
						index = orig_msg_id.indexOf(":- :"); //added for for MMS-SCF-0306 [IN:047499] -start
						if(index >0)
							message = getMessage(getLanguageId(),msg_id,"PH")+" for "+ orig_msg_id.substring(index+4, orig_msg_id.length());
						else
							message = getMessage(getLanguageId(),msg_id,"PH");
						map.put( "message", message) ; //Added for for MMS-SCF-0306 [IN:047499]- end
						//map.put( "message", getMessage(getLanguageId(),msg_id,"PH") ) ; //commented for for MMS-SCF-0306 [IN:047499]
					}
					else{
						msg_id= (String)result.get("msgid");
						msg_id = msg_id.replace("javax.ejb.EJBException:","");
						map.put( "message", msg_id ) ;
					}
					map.put("flag","0");
				}
			}
			catch ( Exception e ) {
				System.err.println( "Error in completeTPNDelivery tabData="+tabData ) ;
				e.printStackTrace() ;			
			}
			finally {
				try{
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection ); 
				}
				catch(Exception es){
					es.printStackTrace();
				}
			}
		}
		catch(Exception e){
			System.err.println( "Error in completeTPNDelivery tabData="+tabData ) ;
			e.printStackTrace();
		}
		map.put("flag","0");
		return map;
	}

	public HashMap completeDelivery(){
		HashMap map=new HashMap();
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;

		ArrayList orderLineNumbers = new ArrayList();
		ArrayList orderLineData	= new ArrayList() ;
		ArrayList orderLineData1	= new ArrayList() ;
		ArrayList holdingDetails = new ArrayList();
		ArrayList dispTMP		= new ArrayList();
		
		HashMap delivery		= new HashMap();
		ArrayList unique_orders		= new ArrayList();
//		ArrayList fillingRemarks	= new ArrayList();
		String patient_id			= "";

		String order_id = "";
		String order_line_num = "";
		HashMap complete_status = new HashMap();

//		DispMedicationHome home	=	null;
//		DispMedicationRemote remote	=	null;
		ArrayList reason			=	null;
		ArrayList not_allocated		=	new ArrayList();
		HashMap complete_order_reason = new HashMap();
		boolean bBMSAvailable		=	true;
		HashMap tabData = new HashMap() ;
		String ivprep = "";//added for SKR-SCF-1319
		//tring tapered_yn, taper_order_id, taper_order_line_num, taper_order;  // Commented for RUT-CRF-0088 [IN036978]
		try{
			int iTotalRec = forDelivery.get("tot_rec")!=null?Integer.parseInt(forDelivery.get("tot_rec").toString()):forDelivery.size();
			HashMap hmOrderLineBMS = new HashMap();

			if(forDelivery.get("worksheet_id") != null && !forDelivery.get("worksheet_id").toString().trim().equals("")){
				for(int i=0;i<iTotalRec;i++){
					if(forDelivery.containsKey("order_line_num"+(i+1)) && forDelivery.containsKey("bms_qty"+(i+1))){
						hmOrderLineBMS.put(forDelivery.get("order_line_num"+(i+1)),forDelivery.get("bms_qty"+(i+1)));
					}
				}
				bBMSAvailable = checkBMS(forDelivery.get("order_id").toString(),hmOrderLineBMS);
			} 
			//added for SKR-SCF-1319 start
			 ivprep=getIvprepynFrManufacture(forDelivery.get("order_id").toString());  
			 setIvprep(ivprep);
			//added for SKR-SCF-1319 end
			for(int i=0;i<forDelivery.size();i++){
				if(forDelivery.containsKey("order_line_num"+(i+1)) && ((String)forDelivery.get("deliveryChecked_"+(i+1))).equals("Y")){ // && ((String)forDelivery.get("deliveryChecked_"+(i+1))).equals("Y") Added for MMS-KH-CRF-0028 [IN070605] 
					/*tapered_yn =forDelivery.get("taper_order_yn"+(i+1))==null?"":(String)forDelivery.get("taper_order_yn"+(i+1));   //Commented for RUT-CRF-0088 [IN036978] 
					taper_order_id=forDelivery.get("taper_order_id"+(i+1))==null?"":(String)forDelivery.get("taper_order_id"+(i+1));
					taper_order_line_num =forDelivery.get("taper_order_line_num"+(i+1))==null?"":(String)forDelivery.get("taper_order_line_num"+(i+1));
					taper_order="N";
					if(tapered_yn.equals("Y") && !taper_order_id.equals("") && !taper_order_line_num.equals("")){
						for(int ordL=0; ordL<orderLineData.size();ordL+=7){
							if(((String)orderLineData.get(ordL+3)).equals(taper_order_id) && ((String)orderLineData.get(ordL+4)).equals(taper_order_line_num)){
								taper_order="Y";
								break;
							}
						}
					}
					else
						taper_order="N";  */
					if(forDelivery.get("hold"+(i+1))==null || ((String)forDelivery.get("hold"+(i+1))).equals("")){
						//if((((String)forDelivery.get("hold_status"+(i+1))).equals("disabled") && ((String)forDelivery.get("del_detail"+(i+1))).equals("Y")) || taper_order.equals("Y")){
						if((((String)forDelivery.get("hold_status"+(i+1))).equals("disabled") && ((String)forDelivery.get("del_detail"+(i+1))).equals("Y"))){
							orderLineData.add("N");						// N - Not Hold and allocated
						}
						else{
							orderLineData.add("NN");					// NN - Not Hold and Not Allocated
							if(!disp_level.equals("P")) {
								not_allocated.add((String)forDelivery.get("order_id")+(String)forDelivery.get("order_line_num"+(i+1)));
							}
						}
					}
					else{
						orderLineData.add("Y");							// Y - Hold
						
					}
					orderLineData.add(login_by_id.trim());
					orderLineData.add("");

					if(disp_level.equals("P")) {
						orderLineData.add((String)forDelivery.get("order_id"+(i+1)));
						order_id=(String)forDelivery.get("order_id"+(i+1));
					}
					else {
						orderLineData.add((String)forDelivery.get("order_id"));
						order_id=(String)forDelivery.get("order_id");
					}
					
					orderLineData.add((String)forDelivery.get("order_line_num"+(i+1)));
					order_line_num =(String)forDelivery.get("order_line_num"+(i+1));
					objAllStages.setOrderCheckedYn(order_id+"@"+order_line_num, "Y"); // Added for MMS-KH-CRF-0028 [IN070605]
					if( !(forDelivery.get("CompleteOrder"+(i+1))!=null && forDelivery.get("CompleteOrder"+(i+1)).equals(""))){					
						orderLineData.add((String)forDelivery.get("CompleteOrder"+(i+1)));	
						complete_status.put((order_id+order_line_num),"Y");
						complete_order_reason.put((order_id+order_line_num),(String)forDelivery.get("ComplteOrderReason"+(i+1)));
					}
					else if (forDelivery.get("worksheet_id") != null && !forDelivery.get("worksheet_id").toString().trim().equals("") && !bBMSAvailable){ // in case of worksheet order, if the worksheet is completing the precribed quantity values the order should be completed automatically

						orderLineData.add("Y");
						complete_status.put((order_id+order_line_num),"Y");
						complete_order_reason.put((order_id+order_line_num)," ");
					}
					else if(order_type.equals("CO")){
						orderLineData.add("Y");
						complete_status.put((order_id+order_line_num),"Y");
						complete_order_reason.put((order_id+order_line_num)," ");
					}
					else{
						orderLineData.add("N");
						complete_status.put((order_id+order_line_num),"N");
					}

					if(forDelivery.containsKey("pat_reqd_"+(i+1))){
						if(((String)forDelivery.get("pat_reqd_"+(i+1))).trim().equals("C")){
							orderLineData1.add((String)forDelivery.get("pat_reqd_"+(i+1))==null?"":(String)forDelivery.get("pat_reqd_"+(i+1)));	
							if(disp_level.equals("P")) {
								orderLineData1.add((String)forDelivery.get("order_id"+(i+1)));
							}
							else {
								orderLineData1.add((String)forDelivery.get("order_id"));
							}
							orderLineData1.add((String)forDelivery.get("order_line_num"+(i+1)));
						}
					}
 					//orderLineData.add(taper_order);	//Commented for RUT-CRF-0088 [IN036978] 
				}
			}
			if(forDelivery.containsKey("patient_id")){
				patient_id = (String)forDelivery.get("patient_id");
			}

			for(int i=0;i<forDelivery.size();i++){
				if(forDelivery.get("hold"+(i+1))== null || forDelivery.get("hold"+(i+1)).equals("") ){
					if(forDelivery.containsKey("order_line_num"+(i+1))){
						orderLineNumbers.add((String)forDelivery.get("order_line_num"+(i+1)));
					}
				}
				else if((((String)forDelivery.get("hold"+(i+1))).equals("E"))){
					reason = objAllStages.getBeanReason((i+1)+"");
					if(reason.size()>=2){
						holdingDetails.add((String)forDelivery.get("pract_id"));
						holdingDetails.add((String)reason.get(1));
						holdingDetails.add((String)reason.get(2));
						holdingDetails.add((String)forDelivery.get("order_id"));
						holdingDetails.add((String)forDelivery.get("order_line_num"+(i+1)));
					}
				}
			}

			try{
				delivery =	objAllStages.getAllocation( (String)forDelivery.get("patient_id"),(String)forDelivery.get("order_id"));
			}
			catch(Exception e){
					e.printStackTrace();
			}

			if(disp_level.equals("P")) {
				ArrayList arrListAlloc =	null;
				HashMap hmAllocRecord =	null;
				String disp_qty		= "";

				//for(int i=0;i<orderLineData.size();i=i+7){
				for(int i=0;i<orderLineData.size();i=i+6){	//Modified for RUT-CRF-0088 [IN036978] 7->6
					if(!((String)orderLineData.get(i)).equals("NN") ) {
						if(!unique_orders.contains(((String)orderLineData.get(i+3)).trim())) {
							unique_orders.add(((String)orderLineData.get(i+3)).trim());
							delivery =	objAllStages.getAllocation( (String)forDelivery.get("patient_id"),((String)orderLineData.get(i+3)).trim());
							arrListAlloc = (ArrayList)delivery.get("detail");
							for(int j=0;j<arrListAlloc.size();j++){
								hmAllocRecord = (HashMap)arrListAlloc.get(j);
								order_id =(String)hmAllocRecord.get("order_id");
								order_line_num =(String)hmAllocRecord.get("order_line_no");
								disp_qty	=(String)hmAllocRecord.get("disp_qty");
							
								if(!disp_qty.equals("")&&disp_qty!=null ){
							// if(complete_status.get(order_id+order_line_num).equals("N"))
									dispTMP.add(hmAllocRecord.get("order_id"));
									dispTMP.add(hmAllocRecord.get("order_line_no"));
									dispTMP.add(hmAllocRecord.get("pres_drug_code"));
									dispTMP.add(hmAllocRecord.get("disp_drug_code"));
									dispTMP.add(hmAllocRecord.get("disp_qty"));
									dispTMP.add(hmAllocRecord.get("disp_uom_code"));
									dispTMP.add((ArrayList)hmAllocRecord.get("batch_record"));
								}
							}
						}
					}
				}
			} 
			else {
				ArrayList arrListAlloc = (ArrayList)delivery.get("detail");
				HashMap hmAllocRecord =	null;
				String disp_qty		= "";
				for(int j=0;j<arrListAlloc.size();j++){
					hmAllocRecord = (HashMap)arrListAlloc.get(j);
					order_id =(String)hmAllocRecord.get("order_id");
					order_line_num =(String)hmAllocRecord.get("order_line_no");
					disp_qty	=(String)hmAllocRecord.get("disp_qty");

				// if(complete_status.get(order_id+order_line_num).equals("N"))
					if(!disp_qty.equals("")&& disp_qty!=null ){
						if(!not_allocated.contains((String)hmAllocRecord.get("order_id")+(String)hmAllocRecord.get("order_line_no"))) {
							dispTMP.add(hmAllocRecord.get("order_id"));
							dispTMP.add(hmAllocRecord.get("order_line_no"));
							dispTMP.add(hmAllocRecord.get("pres_drug_code"));
							dispTMP.add(hmAllocRecord.get("disp_drug_code"));
							dispTMP.add(hmAllocRecord.get("disp_qty"));
							dispTMP.add(hmAllocRecord.get("disp_uom_code"));
							dispTMP.add((ArrayList)hmAllocRecord.get("batch_record"));
						}
					}
				}
			}
			tabData = new HashMap() ;
			tabData.put( "properties", getProperties() );
			tabData.put( "disp_stage", getDispStage());
			tabData.put( "login_by_id", login_by_id.trim());
			tabData.put( "login_at_ws_no", login_at_ws_no.trim());
			tabData.put( "funct_role_id",getFunctRollID( login_by_id));
			tabData.put( "facility_id", login_facility_id.trim() );
			tabData.put( "disp_locn_code", getDispLocnCode().trim() );
			tabData.put( "dateTime", getTodaysDateTime());
			tabData.put( "order_id",(String)forDelivery.get("order_id"));
			tabData.put( "patient_id",patient_id);
			tabData.put( "patient_class", getDispLocnCatg().trim() );
			tabData.put( "order_line_numbers",orderLineNumbers);
			tabData.put( "delivery_details",getDeliveryDetails());
			tabData.put( "holding_details",holdingDetails );
			tabData.put( "dispTMP",dispTMP );
			tabData.put( "orderLineData", orderLineData );
			tabData.put( "orderLineData1", orderLineData1 );
			tabData.put( "ordering_facility_id",getOrderingFacility());
			tabData.put("store_code",getStoreCode());
			tabData.put( "today",getTodaysDate());
			tabData.put( "encounter_id", forDelivery.get("encounter_id"));
			tabData.put("DISP_LEVEL",disp_level);
			tabData.put("order_qty",getOrderQty());
			tabData.put("durn_val",getDurationValue());
			tabData.put("mode",getMode());
			//code added for delivery findings.....on 21/4/2004..
			tabData.put("fillingRemarks",objAllStages.fill_remarks);
			tabData.put("deliveryRemarks",objAllStages.delivery_remarks);
			tabData.put("editLabel",objAllStages.editLabel);
			tabData.put("allocatefill_remarks",objAllStages.allocatefill_remarks);
			tabData.put("token_yn",issue_token_on_regn_yn);
			tabData.put("Token_Queue_date",this.queue_date);
			tabData.put("token_series_code",getTokenSeriesCode());
			tabData.put("token_vals",objAllStages.getTokenVals());
			tabData.put( "source_type",forDelivery.get("source_type"));
			tabData.put( "source_code",getLocnCode());//SKR-SCF-1239
			tabData.put( "performing_pract_id",forDelivery.get("performing_pract_id"));
			tabData.put("complte_order_reason",complete_order_reason);//complte order reason code
			tabData.put( "LanguageId",getLanguageId());
			tabData.put( "DispBillingStage",getDispBillStage());
			tabData.put( "billing_interface_yn",objAllStages.getBLInterfaceYN());//checkforbillinginterface
			tabData.put("BL_REASONS", objAllStages.getBiilingReasonDetails());
			tabData.put("DISP_CASH_COLL_STAGE", getDispCashCollStage());
			tabData.put("CONSUMABLES_DET", objAllStages.getConsumableDetails());
			tabData.put("ORDER_ID_ORDER_DATE",getOrderIDOrderDate());
			tabData.put("ORDER_ID_ATTENDED_PRACT_ID",this.order_id_Attended_pract_id);			// added for SRR20056-SCF-7373
			tabData.put("DRUG_INDICATION",getDrugIndication(order_id.trim(),order_line_num.trim()));//Added DRUG_INDICATION for  ML-BRU-CRF-072[Inc:29938]
			if(this.issue_by_uom.equals("I")){
				tabData.put( "ISSUE_UOM_QTY", objAllStages.issueUomQty);
			}
			tabData.put("IPFillProcess",getFillUnit());
			tabData.put("IPFillPeriodAhead",getFillPeriod());
			tabData.put("CHARGE_DTLS",objAllStages.charge_dtls);
			tabData.put("IV_PREP_YN", getWsType());
			tabData.put("ALTDRUGREMARKS",objAllStages.getAltDrugRemarks());//Added for Bru-HIMS-CRF-082 [IN:029948]
			tabData.put("st_no_of_decimals", objAllStages.getSt_no_of_decimals()); // Added for AAKH-SCF-0113 [IN:048937]
			tabData.put("hshmedplan", medplan_bean.getMedPlan_DrugDetails()); // Added for  Bru-HIMS-CRF-072.1[IN 049144] start
			tabData.put("hshmedplanlocal", medplan_bean.getMedPlan_Local_DrugDetails()); 
			tabData.put("arrMedPlanSeqNo", medplan_bean.getMediPlanSeqNo()); 
			tabData.put("strMedPlanYN", getMedicationPlannerYN());
			tabData.put("isMedValuesChanged", medplan_bean.isMedValuesChanged()+""); // Added for  Bru-HIMS-CRF-072.1[IN 049144] end
			tabData.put("editableLabel",objAllStages.getEditableLabel());//added for Bru-HIMS-CRF-414 [IN:045554]
			tabData.put("allow_edit_disp_label", getAllowEditDispLabel());//added for Bru-HIMS-CRF-414 [IN:045554]
			tabData.put("editableLabelLangId", getEditableLabelLangId());//added for Bru-HIMS-CRF-414 [IN:045554]
			tabData.put("st_decimal_restriction", getPhStDecimalRestrictionYN());//added for MMS-DM-SCF-0210 [IN:059660]
			tabData.put("hmFillReasons", hmFillReasons);//added for ML-MMOH-SCF-0465
			tabData.put("approvalNo",getApprovalNo()); //Added for AAKH-CRF-0117
			tabData.put("IV_PREP", getIvprep()); //Added for SKR-SCF-1319 
			tabData.put("iqviaIntegrationFlag", getIqvia_integration_yn()); //MOHE-CRF-0026.1 START
			tabData.put( "postAuthStatusData", forDelivery.get("postAuthStatusData"));
			tabData.put( "authStatusCompleted_yn", forDelivery.get("authStatusCompleted_yn"));
			tabData.put( "settlement_id", forDelivery.get("settlement_id")); //MOHE-CRF-0026.1 END  
			//System.err.println("barcode_2d_applicable_yn@@ Allstages==="+barcode_2d_applicable_yn+"hm2dBarcode=="+get2DBarCodeForDrug());
			tabData.put("barcode_2d_applicable_yn",get2DBarcodeApplicable());//Added for MMS-DM-CRF-0174.5
			tabData.put("hm2dBarcode",get2DBarCodeForDrug());//Added for MMS-DM-CRF-0174.5
			if(objAllStages.getConsumableDetails()!=null && objAllStages.getConsumableDetails().size()>0)
				setBConsuableItemAvailable(true);
			else
				setBConsuableItemAvailable(false);

			clearAlOrderLineDataForEditLables();
			setAlOrderLineDataForEditLables(orderLineData);

			HashMap sqlMap = new HashMap() ;
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_UPDATE"));

			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_UPDATE1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PATIENT_DRUG_PROFILE_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_PH_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_IP_ORDER_LINE_PH_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT33",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT33"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT56",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT56"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT57",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT57"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_TMP_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_HRD_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_HRD_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT58",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT58"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT59",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT59"));

			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT66",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT66"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT67","SELECT DOC_SRL_NO FROM PH_DISP_DTL_TMP WHERE ORDER_ID=? AND ORDER_LINE_NO=?");
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT68",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT68"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_DISP_DTL_UPDATE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DISP_DTL_UPDATE"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE3",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE3"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE4",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE4"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE5",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE5"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE6",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE6"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE7",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE7"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE8",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE8"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE9",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE9"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE10",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE10"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE11",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE11"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE12",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE12"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE13",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE13"));
			sqlMap.put("SQL_PH_PRESCRIPTION_SELECT45",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT45"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_UPDATE14",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_UPDATE14"));		
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT88",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT88"));		
			sqlMap.put("SQL_PH_IP_FILL_PROCESS_CAL_NO_OF_DAYS_A",PhRepository.getPhKeyValue("SQL_PH_IP_FILL_PROCESS_CAL_NO_OF_DAYS_A"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT106",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT106"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT108",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT108"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT109",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT109"));	
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT111",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT111"));	
			sqlMap.put("SQL_PH_TDM_PRES_SELECT3",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT3"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT4",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT4"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT5",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT5"));
			sqlMap.put("SQL_PH_IVPRESCRIPTION_INSERT1",PhRepository.getPhKeyValue("SQL_PH_IVPRESCRIPTION_INSERT1"));
			sqlMap.put("SQL_PH_PRESCRIPTION_SELECT37",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT37"));
			sqlMap.put("SQL_PH_TDM_PRES_SELECT6",PhRepository.getPhKeyValue("SQL_PH_TDM_PRES_SELECT6"));
			sqlMap.put("SQL_PH_PRESCRIPTION_INSERT2",PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_INSERT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT135",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT135"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT137",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT137"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT148",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT148"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT167",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT167"));
			//sqlMap.put("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_SELECT1")); //commented this SQL for Performence tuning from SKR IV_PREP_YN value is added in orderlinedata
			sqlMap.put("SQL_PH_IVPRESCRIPTION_INSERT2",PhRepository.getPhKeyValue("SQL_PH_IVPRESCRIPTION_INSERT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_SELECT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_PH_PATIENT_DRUG_PROFILE_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PH_PATIENT_DRUG_PROFILE_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_FIELD_VALUES_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_FIELD_VALUES_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_FIELD_VALUES_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_OR_ORDER_LINE_FIELD_VALUES_SELECT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_PH_MEDN_ADMIN_DELETE",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_PH_MEDN_ADMIN_DELETE"));

			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT1"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_BL_SELECT2",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_BL_SELECT2"));
			sqlMap.put("SQL_PH_DISP_MEDICATION_SELECT145",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT145"));
			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE1",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE1"));
 			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2"));
 			sqlMap.put("SQL_OR_ORDER_LINE_PH_UPDATE2A",PhRepository.getPhKeyValue("SQL_OR_ORDER_LINE_PH_UPDATE2A"));
 			sqlMap.put("SQL_PH_DISP_DTL_TMP_UPDATE","update ph_disp_dtl_tmp set LABEL_CAU_INSTRN1_ENG =? , LABEL_CAU_INSTRN2_ENG=? , LABEL_SPL_INSTRN1_ENG=? , LABEL_SPL_INSTRN2_ENG=? , LABEL_PAT_INSTRN1_ENG=? , LABEL_CAU_INSTRN1_LOC=? , LABEL_CAU_INSTRN2_LOC=? , LABEL_SPL_INSTRN1_LOC=? , LABEL_SPL_INSTRN2_LOC=? , LABEL_PAT_INSTRN1_LOC=?,PRES_REMARK_CODE = ?,DRUG_INDICATION=? where facility_id = ? AND order_id = ? AND ORDER_LINE_NO =? AND DISP_DRUG_CODE =?"); //AND DISP_DRUG_CODE =? newly added by manickam & DRUG_INDICATION for  ML-BRU-CRF-072[Inc:29938]
 			sqlMap.put("SQL_PH_DISP_DTL_TMP_UPDATE_ALT_REMARKS","update ph_disp_dtl_tmp set ALT_DRUG_REMARKS =? , MODIFIED_BY_ID = ?, MODIFIED_DATE = SYSDATE, MODIFIED_AT_WS_NO = ? , MODIFIED_FACILITY_ID = ? where order_id = ? AND ORDER_LINE_NO =? "); 
			sqlMap.put("SQL_PH_IP_FILL_PROCESS_UPDATE_DRUG_PROFILE",PhRepository.getPhKeyValue("SQL_PH_IP_FILL_PROCESS_UPDATE_DRUG_PROFILE"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_INSERT", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_INSERT"));// Added for  Bru-HIMS-CRF-072.1[IN 049144] start
			sqlMap.put("SQL_PH_MED_PLAN_ID_SEQ", PhRepository.getPhKeyValue("SQL_PH_MED_PLAN_ID_SEQ"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE1", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE1"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE2", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE2"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_UPDATE3", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_UPDATE3"));
			sqlMap.put("SQL_PH_MED_PLAN_SELECT_CURR_DRUG", PhRepository.getPhKeyValue("SQL_PH_MED_PLAN_SELECT_CURR_DRUG"));
			sqlMap.put("SQL_PH_MEDICATION_PLAN_INSERT_CHECK", PhRepository.getPhKeyValue("SQL_PH_MEDICATION_PLAN_INSERT_CHECK"));// Added for  Bru-HIMS-CRF-072.1[IN 049144] end
			if(getAllowEditDispLabel().equals("Y")){//if block Added for Bru-HIMS-CRF-414 [IN:045554]
				sqlMap.put("SQL_PH_DISP_LABEL_UPDATE", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_UPDATE"));
				sqlMap.put("SQL_PH_DISP_LABEL_INSERT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_INSERT"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_DISP_DTL", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_DISP_DTL_TMP"));
				sqlMap.put("SQL_PH_DISP_LABEL_SELECT_COUNT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_SELECT_COUNT"));
				sqlMap.put("SQL_PH_DISP_LABEL_DELETE", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_DELETE"));
				sqlMap.put("SQL_PH_DISP_LABEL_DTL_TMP_PREV_INSERT", PhRepository.getPhKeyValue("SQL_PH_DISP_LABEL_DTL_TMP_PREV_INSERT"));
			}
			/*InitialContext context = new InitialContext() ;
			Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION") ) ;

			home = (DispMedicationHome) PortableRemoteObject.narrow( object, DispMedicationHome.class ) ;
			remote = home.create() ;

			HashMap result = remote.modify( tabData, sqlMap ) ;
			//HashMap result	=	new HashMap();
			*/
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION" ),DispMedicationHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;

			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();

			HashMap result = (HashMap)(busObj.getClass().getMethod("modify",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);
			if(result.containsKey("IR_FLAG")){				
				setDEL_IR_FLAG_VALUE((HashMap)result.get("IR_FLAG"));
			}
			if(objAllStages.getBLInterfaceYN().equals("Y")){//checkforbillinginterface
				if(result.containsKey("BILLING_DET")){				
					setBILLING_DET((String)result.get("BILLING_DET"));
					setBLDocSrlNo((String)result.get("BLDocSrlNo")); //Added for  [IN:043100]
				}
			}
			if(result.containsKey("print_seq_no"))				
				setPrintSeqNo((String)result.get("print_seq_no"));
			if(result.containsKey("mediplan_seq_no")){//Added for Bru-HIMS-CRF-072.1[IN 049144]
				medplan_bean.clearMediPlanSeqNo();
				medplan_bean.setMediPlanSeqNo(result.get("mediplan_seq_no").toString());
			}
			if(result.containsKey("arr_mediplan_seq_no")){//Added for Bru-HIMS-CRF-072.1[IN 051382]  // In Deliver Stage Print Dialog Window - Current drugs should not come for Merge Medication Plan 
				medplan_bean.clearMediPlanSeqNo();
				ArrayList<String> arrTempMedseqno = (ArrayList<String>)result.get("arr_mediplan_seq_no");
				for(String temp: arrTempMedseqno)
					medplan_bean.setMediPlanSeqNo(temp);
			}

			if( ((Boolean) result.get( "result" )).booleanValue() ){
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
				map.put("flag","0");
				if(result.containsKey("SAL_DOC_DTLS") && getDispDocNo().equals("Y") && disp_locn_catg.equals("I") ){//Added for AMS-CRF-0079 [IN:050762] -start
					setSalDocDtls((ArrayList)result.get("SAL_DOC_DTLS"));
					if(alSalDocDtls != null && alSalDocDtls.size()>0){
						StringBuffer sbSalDocDtls = new StringBuffer();
						for(int i=0; i<alSalDocDtls.size(); i++){
							if(i ==0)
								sbSalDocDtls.append("Document Reference Number: <b>");
							if(i>0)
								sbSalDocDtls.append(" , ");
							sbSalDocDtls.append(alSalDocDtls.get(i));
						}
						map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH")+"\n" +sbSalDocDtls.toString()+"</b>") ;
					}
				} //Added for AMS-CRF-0079 [IN:050762] -end
				//added for MO-MCMSS-CRF-0009 start
				String PatientClass = getPatientclass();
				boolean site = getPhIssueSite();
				System.out.println("site"+site);	 
				if(site && PatientClass.equals("IP")){
		    	   ArrayList BLDocSrlNo = ((ArrayList)result.get("SAL_DOC_DTLS"));
					String arr_doc_no[] = null;
					String doc_no = "";
					for(int i=0;i<BLDocSrlNo.size();i++){	
						arr_doc_no = null;
						doc_no = (String)BLDocSrlNo.get(i);
						arr_doc_no = doc_no.split("-");
						doc_no = arr_doc_no[1];
						HashMap<String, Object> details = new HashMap<String, Object>();
				        details.put("doc_no", doc_no);
				        details.put("patientId", patient_id);
				        createFile(details);
					}
				}
				//added for MO-MCMSS-CRF-0009 end
			}
			else{
				map.put( "result", new Boolean( false ) ) ;
				//map.put( "message", result.get("msgid") ) ;
				String msg_id= (String)result.get("msgid");
				String orig_msg_id = msg_id; //Added for for MMS-SCF-0306 [IN:047499]- start
				String message="";
				int index = msg_id.indexOf(":-");
				if(index== -1)
					index = msg_id.length();
				//msg_id=msg_id.substring(24,(msg_id.length())); //Commented for for MMS-SCF-0306 [IN:047499]				
				msg_id=msg_id.substring(32,index);//for MMS-SCF-0306 [IN:047499] -end
				if(msg_id.equals("ORDER_PROC_BY_OTHER_USER")||msg_id.equals("BATCH_RECORD_NOT_FOUND")||msg_id.equals("NEGATIVE_STOCK")||msg_id.equals("SUSPENDED_BATCH")||msg_id.equals("INSUFFICIENT_BATCH_QTY")){
					index = orig_msg_id.indexOf(":- :"); //added for for MMS-SCF-0306 [IN:047499] -start
					if(index >0)
						message = getMessage(getLanguageId(),msg_id,"PH")+" for "+ orig_msg_id.substring(index+4, orig_msg_id.length());
					else
						message = getMessage(getLanguageId(),msg_id,"PH");
					map.put( "message", message) ; //for MMS-SCF-0306 [IN:047499] -end
					//map.put( "message", getMessage(getLanguageId(),msg_id,"PH") ) ; //commented for for MMS-SCF-0306 [IN:047499]
				}
				else{
					msg_id= (String)result.get("msgid");
					msg_id = msg_id.replace("javax.ejb.EJBException:","");
					map.put( "message", msg_id ) ;
				} 
				map.put("flag",result.get("flag"));
			}
		}
		catch(Exception e){
			System.err.println("==error in dispense completeDelivery forDelivery===="+forDelivery);	
			System.err.println("==error in dispense completeDelivery dispTMP===="+dispTMP);	
			System.err.println("==error in dispense completeDelivery getStockInstalled===="+getStockInstalled()+"==disp_level="+disp_level);	
			System.err.println("<<< @@@tabData in Delivery == "+tabData);
			e.printStackTrace();
			/*map.put( "result", new Boolean( false ) ) ;
			map.put( "message", (String)e.getMessage()) ;
			map.put("flag","0");*/
		}
		return map;
	}

	//This method will check whether the user is having all rights to view Verify Prescriptions function or not
	public ArrayList checkToProceed(String facility_id,String function_identity) {
		setFunctionIdentity(function_identity.trim());
		setTodaysDate();
		ArrayList result		= new ArrayList();
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection = getConnection() ;
			boolean proceed			= false;
			String disp_locn_code	= "";

			//To get the user name based on the login_id
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT31") ) ;
			pstmt.setString(1,login_by_id.trim());
			pstmt.setString(2,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				setUserName(resultSet.getString("APPL_USER_NAME"));
//commented during PE By Naveen
			/*}
			closeStatement(pstmt);
			closeResultSet(resultSet);
//// Get the logged in user password
 pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT81")) ;
			pstmt.setString(1,login_by_id);			
 resultSet	= pstmt.executeQuery() ;
			
			if (resultSet.next()){*/
				setApplPassword(resultSet.getString("PIN_NO"));			
			}
			closeStatement(pstmt);
			closeResultSet(resultSet);

			//CHECK WHETHER LOGGED-IN USER IS PHARMACIST OR NOT.
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT1") ) ;
			pstmt.setString(1,login_by_id.trim());
			resultSet = pstmt.executeQuery() ;

			if ( resultSet.next() ) {
				proceed	= true ;
			}
			else {
				result.add("NO DISPLAY-1");
				return result;
			}
			//CHECK WHETHER OR MODULE IS INSTALLED OR NOT.
			if (proceed) {
				proceed = false ;
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT2") ) ;
				resultSet = pstmt.executeQuery() ;
				if ( resultSet.next() ) {
					proceed = true ;
				}
				else {
					result.add("NO DISPLAY-2");
					return result;
				}
			}
			//CHECK WHETHER LOGGED-IN WORKSTATION NO. MAPS WITH THE WS_NO IN PH_WS_NO_FOR_DISP_LOCN
			if (proceed) {
				proceed = false ;
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;

				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT3") ) ;
				pstmt.setString(1,facility_id.trim());
				pstmt.setString(2,login_at_ws_no.trim());
				resultSet = pstmt.executeQuery() ;

				if (resultSet.next()) {
					disp_locn_code = disp_locn_code + " AND (A.DISP_LOCN_CODE = '" + resultSet.getString("DISP_LOCN_CODE") + "' OR ";
					while ( resultSet.next() ) {
						disp_locn_code = disp_locn_code + "A.DISP_LOCN_CODE = '";
						disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + "' OR ";
					}
					disp_locn_code = disp_locn_code.substring(0, disp_locn_code.length()-4);
					disp_locn_code = disp_locn_code + ") ORDER BY 1";
					proceed = true ;
				}
				else {
					result.add("NO DISPLAY-3");
					return result;
				}
			}

			//CHECK FOR DISP_REGN_REQD_YN='Y/N' AND ISSUE_TOKEN_ON_REGN_YN='Y/N' IN PH_DISP_LOCN TABLE AND ACK_YN='Y' IN PH_DISP_RIGHTS TABLE FOR THE GENERATED DISP_LOCN_CODE's IN THE ABOVE STAGE
			if (proceed) {
				proceed = false ;
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				if(function_identity.equals("DispMedication")){
					// This block will be executed if the method is called from Dispense Medication function
					pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT54") + disp_locn_code ) ;
					disp_locn_code = "";
					pstmt.setString(1,facility_id.trim());
					pstmt.setString(2,login_by_id.trim());
					pstmt.setString(3,getLanguageId());
					resultSet = pstmt.executeQuery() ;
					if ( resultSet.next() ) {
						disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
						disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
						disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
						disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
						while ( resultSet.next() ) {
							disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
							disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
							disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
							disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
						}
						result.add(disp_locn_code);
					}
					else {
						result.add("NO DISPLAY-4");
						return result;
					}
				}
				else if(function_identity.equals("VerifyPrescriptions")){
					// This block will be executed if the method is called from Verify Order function
					//pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT54A") + disp_locn_code ) ;
					pstmt = connection.prepareStatement( "SELECT A.SHORT_DESC, A.DISP_LOCN_CODE, A.ISSUE_TOKEN_ON_REGN_YN,A.DISP_REGN_REQD_YN, DISP_VERF_STAGE, B.CURR_ENC_FINANCIAL_DTL_YN FROM PH_DISP_LOCN_LANG_VW A,PH_DISP_RIGHTS B WHERE A.FACILITY_ID = ? AND B.FACILITY_ID=A.FACILITY_ID AND B.APPL_USER_ID = ? AND A.DISP_LOCN_CODE=B.DISP_LOCN_CODE AND A.LANGUAGE_ID = ? " + disp_locn_code ) ;
					disp_locn_code = "";
					pstmt.setString(1,facility_id.trim());
					pstmt.setString(2,login_by_id.trim());
					pstmt.setString(3,getLanguageId());
					resultSet = pstmt.executeQuery() ;
					if ( resultSet.next() ) {
						//String check_disp_catg = getDispCatg(resultSet.getString("DISP_LOCN_CODE").trim()); Removed for IN063877
						//String check_disp_stages = getDispStagesApplicable(resultSet.getString("DISP_LOCN_CODE").trim(),check_disp_catg);
						disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
						disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
						disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
						disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 

						while ( resultSet.next() ) {
							disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
							disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
							disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
							disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
						}
						result.add(disp_locn_code);
					}
					else {
						result.add("NO DISPLAY-4");
						return result;
					}
				}
				else{
					// This block will be executed if the method is called from Verify Prescription function
					pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT4") + disp_locn_code ) ;
					disp_locn_code = "";
					pstmt.setString(1,facility_id.trim());
					pstmt.setString(2,login_by_id.trim());
					pstmt.setString(3,getLanguageId());
					resultSet = pstmt.executeQuery() ;
					if(resultSet.next()){
						String check_disp_catg = getDispCatg(resultSet.getString("DISP_LOCN_CODE").trim());
						String check_disp_stages = getDispStagesApplicable(resultSet.getString("DISP_LOCN_CODE").trim(),check_disp_catg);
						StringTokenizer st1 = new StringTokenizer(check_disp_stages,":");
						while(st1.hasMoreTokens()){
							if(((String)st1.nextToken()).equals("V")){
								disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
								disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
								disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
								disp_locn_code = disp_locn_code + checkForNull( resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
							}
						}
						while ( resultSet.next() ) {
							check_disp_catg = getDispCatg(resultSet.getString("DISP_LOCN_CODE").trim());
							check_disp_stages = getDispStagesApplicable(resultSet.getString("DISP_LOCN_CODE").trim(),check_disp_catg);
							StringTokenizer st2 = new StringTokenizer(check_disp_stages,":");
							while(st2.hasMoreTokens()){
								if(((String)st2.nextToken()).equals("V")){
									disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
									disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
									disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
									disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
								}
							}
						}
						result.add(disp_locn_code);
					}
					else {
						result.add("NO DISPLAY-4");
						return result;
					}
				}
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}

	
	//This method will check whether the user is having verfication rights to view Verify Prescriptions function or not
		public ArrayList checkToProceed1(String facility_id,String function_identity,String in_out) {
			setFunctionIdentity(function_identity.trim());
			setTodaysDate();
			ArrayList result		= new ArrayList();
			Connection connection	= null;
			PreparedStatement pstmt	= null;
			ResultSet resultSet		= null;
			try {
				connection = getConnection() ;
				boolean proceed			= false;
				String disp_locn_code	= "";
				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT31") ) ;
				pstmt.setString(1,login_by_id.trim());
				pstmt.setString(2,getLanguageId());
				resultSet = pstmt.executeQuery() ;
				if ( resultSet.next() ) {
					setUserName(resultSet.getString("APPL_USER_NAME"));
	
					setApplPassword(resultSet.getString("PIN_NO"));			
				}
				closeStatement(pstmt);
				closeResultSet(resultSet);

				//CHECK WHETHER LOGGED-IN USER IS PHARMACIST OR NOT.
				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT1") ) ;
				pstmt.setString(1,login_by_id.trim());
				resultSet = pstmt.executeQuery() ;

				if ( resultSet.next() ) {
					proceed	= true ;
				}
				else {
					result.add("NO DISPLAY-1");
					return result;
				}
				//CHECK WHETHER OR MODULE IS INSTALLED OR NOT.
				if (proceed) {
					proceed = false ;
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT2") ) ;
					resultSet = pstmt.executeQuery() ;
					if ( resultSet.next() ) {
						proceed = true ;
					}
					else {
						result.add("NO DISPLAY-2");
						return result;
					}
				}
				//CHECK WHETHER LOGGED-IN WORKSTATION NO. MAPS WITH THE WS_NO IN PH_WS_NO_FOR_DISP_LOCN
				if (proceed) {
					proceed = false ;
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;

					pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT3") ) ;
					pstmt.setString(1,facility_id.trim());
					pstmt.setString(2,login_at_ws_no.trim());
					resultSet = pstmt.executeQuery() ;

					if (resultSet.next()) {
						disp_locn_code = disp_locn_code + " AND (A.DISP_LOCN_CODE = '" + resultSet.getString("DISP_LOCN_CODE") + "' OR ";
						while ( resultSet.next() ) {
							disp_locn_code = disp_locn_code + "A.DISP_LOCN_CODE = '";
							disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + "' OR ";
						}
						disp_locn_code = disp_locn_code.substring(0, disp_locn_code.length()-4);
						disp_locn_code = disp_locn_code + ") ORDER BY 1";
						proceed = true ;
					}
					else {
						result.add("NO DISPLAY-3");
						return result;
					}
				}

				//CHECK FOR DISP_REGN_REQD_YN='Y/N' AND ISSUE_TOKEN_ON_REGN_YN='Y/N' IN PH_DISP_LOCN TABLE AND ACK_YN='Y' IN PH_DISP_RIGHTS TABLE FOR THE GENERATED DISP_LOCN_CODE's IN THE ABOVE STAGE
				if (proceed) {
					proceed = false ;
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					if(function_identity.equals("DispMedication")){
						// This block will be executed if the method is called from Dispense Medication function
						if(in_out.equals("IN_IAE")){
						pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT54B") + disp_locn_code ) ;
						}else
						{
						pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT54C") + disp_locn_code ) ;
						}
						disp_locn_code = "";
						pstmt.setString(1,facility_id.trim());
						pstmt.setString(2,login_by_id.trim());
						pstmt.setString(3,getLanguageId());
						resultSet = pstmt.executeQuery() ;
						if ( resultSet.next() ) {
							disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
							disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
							disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
							disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
							while ( resultSet.next() ) {
								disp_locn_code = disp_locn_code + resultSet.getString("DISP_LOCN_CODE") + ",";
								disp_locn_code = disp_locn_code + resultSet.getString("SHORT_DESC") + ",";
								disp_locn_code = disp_locn_code + resultSet.getString("ISSUE_TOKEN_ON_REGN_YN")+"," ;
								disp_locn_code = disp_locn_code + checkForNull(resultSet.getString("CURR_ENC_FINANCIAL_DTL_YN"))+"|" ;//Added for JD-CRF-0156 [IN:41737] 
							}
							result.add(disp_locn_code);
						}
						else {
							result.add("NO DISPLAY-4");
							return result;
						}
					}
					
				}
			}
			catch ( Exception e ) {
				e.printStackTrace() ;
			}
			finally {
				try {
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}
				catch(Exception es) { es.printStackTrace();}
			}
			return result;
		}
	// This method gives the applicable dispense category based on dispense location code
	public String getDispCatg(String disp_locn_code){
		String disp_catg="";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;

		try {
			connection = getConnection() ;
			// pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT5") ) ;
			pstmt = connection.prepareStatement( "SELECT DISP_LOCN_CATEGORY,ISSUE_TOKEN_ON_REGN_YN,DISP_REGN_REQD_YN, DISP_STAGE,STORE_CODE FROM PH_DISP_LOCN WHERE FACILITY_ID=? AND DISP_LOCN_CODE=? " ) ;
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,disp_locn_code.trim());
			//pstmt.setString(3,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				setStoreCode(resultSet.getString("STORE_CODE"));
				disp_catg = resultSet.getString("DISP_LOCN_CATEGORY");
				issue_token_on_regn_yn = resultSet.getString("ISSUE_TOKEN_ON_REGN_YN").trim();
				disp_regn_reqd_yn	= resultSet.getString("DISP_REGN_REQD_YN").trim();
				disp_stage = resultSet.getString("DISP_STAGE").trim();
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return disp_catg;
	}

	public String getNursingUnitCode(String short_desc) {
		String nursing_unit_code = "";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;

	try {
		connection = getConnection() ;
		pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_IP_MEDICATION_SELECT14") ) ;
		pstmt.setString(1,short_desc.trim());
		pstmt.setString(2,getLanguageId());

		resultSet = pstmt.executeQuery() ;

		if ( resultSet.next() ) {
				nursing_unit_code =resultSet.getString("NURSING_UNIT_CODE").trim();
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return nursing_unit_code;
	}

	public ArrayList getAllNationalities() {
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		ArrayList nat_codes		= new ArrayList();
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_COMMON_SELECT3") ) ;
			pstmt.setString(1,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			while( resultSet.next() ) {
				nat_codes.add(checkForNull(resultSet.getString("COUNTRY_CODE")));
				nat_codes.add(checkForNull(resultSet.getString("SHORT_NAME")));
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return nat_codes;
	}

	public void getDefaultNationality() {
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String nat_code			=	"";
		String nat_desc			=	"";
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_COMMON_SELECT2") ) ;
			pstmt.setString(1,getLanguageId());
			
			resultSet = pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				nat_code		=	resultSet.getString("CITIZEN_NATIONALITY_CODE");
				nat_desc		=	resultSet.getString("SHORT_DESC");
				setAddCriteriaNatCode(nat_code);
				setAddCriteriaNatDesc(nat_desc);
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		
	}

	public String getDispLevel() {
		String disp_level		=	"";
		String fill_prd			=	"";
		String fill_prd_unit	=	"";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;

		try {
			connection = getConnection() ;
			//changed during PE By Naveen
			 // pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT64") ) ;
			pstmt = connection.prepareStatement( "SELECT DISP_LEVEL,IP_FILL_PRD_AHEAD, IP_FILL_PRD_UNIT,ALLOW_USAGE_OF_SPIL_QTY_YN FROM PH_DISP_LOCN WHERE DISP_LOCN_CODE =? AND FACILITY_ID= ? " ) ;
			
			pstmt.setString(1,getDispLocnCode());
			pstmt.setString(2,login_facility_id);
			//pstmt.setString(3,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				disp_level		=	resultSet.getString("DISP_LEVEL");
				fill_prd		=	resultSet.getString("IP_FILL_PRD_AHEAD");
				fill_prd_unit	=	resultSet.getString("IP_FILL_PRD_UNIT");
				this.allow_usage_of_spil_qty_yn	=	resultSet.getString("ALLOW_USAGE_OF_SPIL_QTY_YN")==null?"N":resultSet.getString("ALLOW_USAGE_OF_SPIL_QTY_YN");
				setFillPeriod(fill_prd);
				setFillUnit(fill_prd_unit);
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return disp_level;
	}

	public String getApplicableStagesForTheUser(){
		return this.ApplicableStagesForTheUser ;
	}
	public void setApplicableStagesForTheUser(String ApplicableStagesForTheUser){
		this.ApplicableStagesForTheUser= ApplicableStagesForTheUser;
	}

	public ArrayList getHtWt(String patient_id)	{
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null ;
		ArrayList ht_wt			= new ArrayList();
		String sql_str			=	null;
		try{
			connection			= getConnection() ;
			sql_str				= PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT70");
			pstmt				= connection.prepareStatement(sql_str) ;
			pstmt.setString(1,patient_id);
			pstmt.setString(2,patient_id);
			resultSet	= pstmt.executeQuery();
			if ( resultSet != null && resultSet.next() ) {
				ht_wt.add(checkForNull(resultSet.getString("HEIGHT")));
				ht_wt.add(checkForNull(resultSet.getString("HEIGHT_UOM")));
				ht_wt.add(checkForNull(resultSet.getString("WEIGHT")));
				ht_wt.add(checkForNull(resultSet.getString("WEIGHT_UOM")));
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){ 
				es.printStackTrace();
			}
		}
		return ht_wt;
	}

	public String getDispStagesApplicable(String disp_locn_code,String disp_locn_catg) throws Exception{
		setDispLocnCatg(disp_locn_catg.trim());
		setDispLocnCode(disp_locn_code.trim());
		String disp_stages_applicable = "";
		boolean all_stages_applicable = true;
		this.user_print_yn			= "N";
		ArrayList disp_locn_stages=new ArrayList();
		ArrayList disp_rights_stages=new ArrayList();
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String filling = "", verify= "", allocation= "", delivery= "";
		//String sIssueTokenYN	= "";
		String edit_disp_label_after_del	= "";
		try {
			connection = getConnection() ;
			boolean  allow_zero_disp_label_site= eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","ALLOW_ZERO_DISP_LABEL");
			//Added for ML-BRU-CRF-0473
			System.out.println("allow_zero_disp_label_site--------->"+allow_zero_disp_label_site);
			//pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT8") ) ;
			//pstmt = connection.prepareStatement("SELECT DISP_FLNG_REQD_YN, DISP_VERF_STAGE, DISP_CASH_COLL_STAGE, DISP_DELV_REQD_YN, IP_VERF_YN, IP_DELV_REQD_YN, IP_ALLOC_YN,DISP_STAGE,DISP_FILL_STAGE, ISSUE_TOKEN_ON_REGN_YN FROM PH_DISP_LOCN_LANG_VW PH_DISP_LOCN WHERE FACILITY_ID=? AND DISP_LOCN_CODE = ? AND LANGUAGE_ID = ?");
			//changed during PE By Naveen
			pstmt = connection.prepareStatement("SELECT DISP_FLNG_REQD_YN, DISP_VERF_STAGE, DISP_CASH_COLL_STAGE, DISP_DELV_REQD_YN, IP_VERF_YN, IP_DELV_REQD_YN, IP_ALLOC_YN,DISP_STAGE,DISP_FILL_STAGE, ISSUE_TOKEN_ON_REGN_YN, IP_DELV_REQD_YN,DISP_DELV_REQD_YN, GENERATE_ACTUAL_TOKEN_YN FROM PH_DISP_LOCN WHERE FACILITY_ID=? AND DISP_LOCN_CODE = ? ");
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,disp_locn_code.trim());
			//pstmt.setString(3,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				setFillingStatus((resultSet.getString("DISP_FILL_STAGE")).trim());
				setGenerateActualTokenYN(checkForNull(resultSet.getString("GENERATE_ACTUAL_TOKEN_YN"), "N"));//Added for HSA-CRF-0136 [IN:048412]
				if(disp_locn_catg.equals("O")){					// O --> OutPatient
					verf_combined_with_alloc = resultSet.getString("DISP_VERF_STAGE");
					setIssueTokenOnRegnYN(resultSet.getString("ISSUE_TOKEN_ON_REGN_YN"));
					setDeliveryApplicable(resultSet.getString("DISP_DELV_REQD_YN"));
										
					if(getFillingStatus().equals("B")){			//(B) --> Filling is Before Allocation
						if(!verf_combined_with_alloc.equals("C")){
							disp_locn_stages.add("V");
						}
						filling = resultSet.getString("DISP_FLNG_REQD_YN");
						if(filling.equals("Y")){
							disp_locn_stages.add("F");
						}
						disp_locn_stages.add("A");
					}
					else if(getFillingStatus().equals("A")){	//(A) --> Filling is After Allocation
						if(!verf_combined_with_alloc.equals("C")){
							disp_locn_stages.add("V");
						}
						disp_locn_stages.add("A");
						filling = resultSet.getString("DISP_FLNG_REQD_YN");
						if(filling.equals("Y")){
							disp_locn_stages.add("F");
						}
					}
					else{
						if(verf_combined_with_alloc.equals("C")){
							disp_locn_stages.add("A");
						}
						else if(verf_combined_with_alloc.equals("B")){
							disp_locn_stages.add("V");
							disp_locn_stages.add("A");
						}
						else{
							disp_locn_stages.add("V");
						}
					}
					/*String billing = resultSet.getString("DISP_CASH_COLL_STAGE");
					if(!billing.equals("X")){			// X --> Not Applicable
						disp_locn_stages.add("B");
					}*/
					delivery = resultSet.getString("DISP_DELV_REQD_YN");
					if(!delivery.equals("N")){
						disp_locn_stages.add("D");
					}
				}
				else{
					verify = resultSet.getString("IP_VERF_YN");
					setIPVerificationYN(verify);
					setDeliveryApplicable(resultSet.getString("IP_DELV_REQD_YN"));
					if(verify.equals("Y")){
						disp_locn_stages.add("V");
					}
					allocation = resultSet.getString("IP_ALLOC_YN");
					if(allocation.equals("Y")){
						disp_locn_stages.add("F");
					}
					delivery = resultSet.getString("IP_DELV_REQD_YN");
					if(delivery.equals("Y")){
						disp_locn_stages.add("D");
					}
				}
			}
			else if(disp_locn_catg.equals("IAE"))// // /* Below else if Condition  Added  by Himanshu For MMS-DM-CRF-0232
			{	
				issue_token_on_regn_yn="N";
				verify="Y";
				setIPVerificationYN(verify);
				disp_locn_stages.add("V");
			}
			
			closeStatement(pstmt);
			closeResultSet(resultSet);
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT168") ) ;			
			pstmt.setString(1,login_facility_id.trim());			
			resultSet	= pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				admx_prep_charges_appl_yn = checkForNull(resultSet.getString("ADMX_PREP_CHARGES_APPL_YN"));
				edit_disp_label_after_del = checkForNull(resultSet.getString("EDIT_DISP_LABEL_AFTER_DEL"));
				this.allow_short_expiry_drugs_yn	= resultSet.getString("ALLOW_SHORT_EXPIRY_DRUGS_YN")==null?"N":resultSet.getString("ALLOW_SHORT_EXPIRY_DRUGS_YN");	
				this.strIncludeZeroAllocQtyItems = resultSet.getString("INCLUDE_ZERO_ALLOC_QTY_ITEMS")==null?"N":resultSet.getString("INCLUDE_ZERO_ALLOC_QTY_ITEMS");
				this.display_unallocDrugs = resultSet.getString("DISP_UNALLOC_DRUGS_AT_DEL_STG")==null?"N":resultSet.getString("DISP_UNALLOC_DRUGS_AT_DEL_STG");
				this.allow_disp_record_lock_yn = resultSet.getString("ALLOW_DISP_RECORD_LOCK_YN")==null?"N":resultSet.getString("ALLOW_DISP_RECORD_LOCK_YN");
				this.amend_alt_drug_dtl_yn = resultSet.getString("ALLOW_AMEND_ALTERNATE_DRUG_DT")==null?"N":resultSet.getString("ALLOW_AMEND_ALTERNATE_DRUG_DT"); // Added for JD-CRF-0198 [IN058599]
				if(allow_zero_disp_label_site)//Added for ML-BRU-CRF-0473
				this.strIncludeZeroAllocQtyItemsForIP = resultSet.getString("INCLUDE_ZERO_ALOC_QTY_ITEMS_IP")==null?"N":resultSet.getString("INCLUDE_ZERO_ALOC_QTY_ITEMS_IP");//Added for ML-BRU-CRF-0473
				else 
				this.strIncludeZeroAllocQtyItemsForIP ="N";//Added for ML-BRU-CRF-0473
				if(edit_disp_label_after_del.equals("Y")){
					this.bEditDispLabelAfterDisp = true;
				}
				else{
					this.bEditDispLabelAfterDisp = false;
				}
				this.setDispAutoRefresh(resultSet.getString("DISP_AUTO_REFRESH")==null?"1":resultSet.getString("DISP_AUTO_REFRESH"));//Added for TH-KW-CRF-0011
				this.disp_drug_verify_remarks_yn=resultSet.getString("DISP_VERI_REM_DRUG_INST")==null?"N":resultSet.getString("DISP_VERI_REM_DRUG_INST"); // Added for ml-mmoh-crf-1755
			}
			closeStatement(pstmt); 
			closeResultSet(resultSet);

			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT9") ) ;
			pstmt.setString(1,login_by_id.trim());
			pstmt.setString(2,login_facility_id.trim());
			pstmt.setString(3,disp_locn_code.trim());
			resultSet = pstmt.executeQuery() ;

			if ( resultSet.next() ) {
				setDispNarcoticYN(checkForNull(resultSet.getString("DISP_NARCOTIC_YN")));
				setDispControlledYN(checkForNull(resultSet.getString("DISP_CONTROLLED_DRUG_YN")));//added for SKR-SCF-0688 [IN:036036]
				setDispChangeTradeNameYN(checkForNull(resultSet.getString("TRADE_CHANGE_ALLOWED_YN")));
				setDispAllowMultiTradesYN(checkForNull(resultSet.getString("MULTI_TRADE_ALLOWED_YN")));
				setViewPatientHistoryYN(checkForNull(resultSet.getString("VIEW_PAT_HIST_YN")));
				setUnlockAllRecordsYN(checkForNull(resultSet.getString("UNLOCK_ALL_RECORDS_YN"),"N"));
				setStrIPDefStage(checkForNull(resultSet.getString("IP_DFLT_DISP_STAGE")));//Added for [IN:047788]
				setStrOPDefStage(checkForNull(resultSet.getString("OP_DFLT_DISP_STAGE")));//Added for [IN:047788]
				setDfltTokenSeriesInd(checkForNull(resultSet.getString("DFLT_TOKEN_SERIES_IND"), "W"));//Added for HSA-CRF-0136 [IN:048412]
				setDefSortTokenSeriesInd(checkForNull(resultSet.getString("SORT_TOKEN_SERIES_IND"), "O"));//Added for HSA-CRF-0136 [IN:048412]
				if(disp_locn_catg.equals("O")){				//(O) --> OutPatient
					if(getFillingStatus().equals("B")){		//(B) --> Filling is Before Allocation
						verify = resultSet.getString("VERIFY_YN");
						if(verify.equals("Y")){
							disp_rights_stages.add("V");
						}
						filling = resultSet.getString("FILL_YN");
						if(filling.equals("Y")){
							disp_rights_stages.add("F"); 
						}

						allocation = resultSet.getString("ALLOCATE_YN");
						if(allocation.equals("Y")){
							disp_rights_stages.add("A");
						}
					}
					else if(getFillingStatus().equals("A")) {	//(A) --> Filling is After Allocation
						verify = resultSet.getString("VERIFY_YN");
						if(verify.equals("Y")){
							disp_rights_stages.add("V");
						}
						allocation = resultSet.getString("ALLOCATE_YN");
						if(allocation.equals("Y")){
							disp_rights_stages.add("A");
						}
						filling = resultSet.getString("FILL_YN");
						if(filling.equals("Y")){
							disp_rights_stages.add("F");
						}
					}
					else{
						verify = resultSet.getString("VERIFY_YN");
						if(verify.equals("Y")){
							disp_rights_stages.add("V");
						}
						allocation = resultSet.getString("ALLOCATE_YN");
						if(allocation.equals("Y")){
							disp_rights_stages.add("A");
						}						
					}
					/*String billing = resultSet.getString("BILL_RECEIPT_YN");
					if(billing.equals("Y")){
						disp_rights_stages.add("B");
					}*/
					delivery = resultSet.getString("DELIVER_YN");
					if(delivery.equals("Y")){
						disp_rights_stages.add("D");
					}
					setUserPrintYN(resultSet.getString("ALLOW_REPRINT_YN"));
				}
				else{
					verify = resultSet.getString("IP_VERIFY_YN");
					if(verify.equals("Y")){
						disp_rights_stages.add("V");
					}
					allocation = resultSet.getString("IP_ALLOCATE_YN");
					if(allocation.equals("Y")){
						disp_rights_stages.add("F");
					}
					delivery = resultSet.getString("IP_DELIVER_YN");
					if(delivery.equals("Y")){
						disp_rights_stages.add("D");
					}
				}
			}
			else if(disp_locn_catg.equals("IAE"))
			{	
				verify ="Y";
				issue_token_on_regn_yn="N";
				if(verify.equals("Y")){
					disp_rights_stages.add("V");
				}
			}

			String stage =	null;
			for(int i=0;i<disp_locn_stages.size();i++){
				stage = 	(String)disp_locn_stages.get(i);
				if(disp_rights_stages.contains(stage)){
					disp_stages_applicable = disp_stages_applicable + (stage + ":");
				}
				else{
					all_stages_applicable = false;
				}
			}
			if( ! getDeliveryApplicable().equals("Y")) //if block added SKR-SCF-0611 [IN:034816].
				all_stages_applicable = false;
			if(all_stages_applicable==true && (!getDispStage().equals("S"))&&disp_locn_catg.equals("O")){
				disp_stages_applicable = disp_stages_applicable + "AS";
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		setApplicableStagesForTheUser(disp_stages_applicable);
		return disp_stages_applicable;
	}

	/*	This function is used to get the nationality and health card number of the patient	*/
	public ArrayList getNationalityHealthCardNo(String patient_id) throws Exception{
		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT6") ) ;
			pstmt.setString(1,patient_id.trim());
			pstmt.setString(2,getLanguageId());
			pstmt.setString(3,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("NATIONAL_ID_NO"));
				result.add(resultSet.getString("HEALTH_CARD_NO"));
			}
		 }
		 catch ( Exception e ) {
			 e.printStackTrace() ;
			 throw e ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			catch(Exception es) { es.printStackTrace();}
		 }
		return result;
	}

	/*
		This function is used to get all the order type codes and descriptions for PH
	*/
	public ArrayList getAllOrderTypeCodes() throws Exception{

		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT7") ) ;
			pstmt.setString(1,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("ORDER_TYPE_CODE"));
				result.add(resultSet.getString("SHORT_DESC"));
			}
		 }
		 catch ( Exception e ) {
			 e.printStackTrace() ;
			 throw e ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			 catch(Exception es) { es.printStackTrace();}
		 }
		return result;
	}

	public HashMap displayTokenNumber(String token_series,String token_no, String validate_yn)throws Exception{
		String result			= "";
		String added_facility_id ="";
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		StringBuilder append_qry = new StringBuilder();
		HashMap token_dtls = new HashMap();
		try {
			connection = getConnection() ;
			append_qry.append(	"select min(token_serial_no)token_serial_no,added_facility_id from ( "); //Added for HSA-CRF-0136 [IN:048412]
			append_qry.append(	"SELECT  y.token_serial_no, y.ADDED_FACILITY_ID FROM ph_disp_queue y,ph_ord_for_disp_queue x WHERE  Y.FACILITY_ID = x.facility_id AND y.disp_locn_code = x.disp_locn_code AND y.queue_date = x.queue_date AND y.queue_shift = x.queue_shift AND y.token_series_code = x.token_series_code AND y.token_serial_no = x.token_serial_no AND y.facility_id = ? AND y.disp_locn_code = ? AND y.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND y.queue_shift = '*ALL' AND y.regn_date_time IS NOT NULL"); //MIN(token_serial_no) removed for HSA-CRF-0136 [IN:048412] //regn_date_time modified to y.regn_date_time for TFS-26200
			//query modified for PMG2020-ML-MMOH-CRF-0002
			if(!(token_series.trim().equals("")) ) //if condition Added for HSA-CRF-0136 [IN:048412]
				append_qry.append(	"  AND y.token_series_code = ? ");
			if(!(token_no.trim().equals("")) && validate_yn.equals("Y")) 
				append_qry.append(	" AND y.TOKEN_SERIAL_NO > ? ");

			if(getDispStage().equals("V")) 
				append_qry.append(" AND TOKEN_LINE_STATUS in ('RG','XX') ");//changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
			else if(getDispStage().equals("A")){
				if(verf_combined_with_alloc.equals("C")) {
					if(getFillingStatus().equals("A")||getFillingStatus().equals("X")){
						append_qry.append(" AND TOKEN_LINE_STATUS in ('RG','XX')  "); //changed token_status to token_line_status and removed and ALLOCATE_DATE_TIME IS NULL and FILL_DATE_TIME IS NULL for PMG2020-ML-MMOH-CRF-0002 
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append(" AND TOKEN_LINE_STATUS='IP' and y.FILL_DATE_TIME IS NOT NULL "); //changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 //FILL_DATE_TIME modified to y.FILL_DATE_TIME for TFS-26200
					} 
				}
				else{
					if(getFillingStatus().equals("A")||getFillingStatus().equals("X")){
						append_qry.append(" AND TOKEN_LINE_STATUS='VF' AND y.VERIFY_DATE_TIME IS NOT NULL ");  //VERIFY_DATE_TIME modified to y.VERIFY_DATE_TIME for TFS-26200
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append(" AND TOKEN_LINE_STATUS='IP'and y.FILL_DATE_TIME IS NOT NULL ");  //FILL_DATE_TIME modified to y.FILL_DATE_TIME for TFS-26200
					} 
				}
			}
			else if(getDispStage().equals("F")){
				if(verf_combined_with_alloc.equals("C")) {
					if(getFillingStatus().equals("A")){
						append_qry.append("AND ((TOKEN_LINE_STATUS='AL' and y.ALLOCATE_DATE_TIME IS NOT NULL) OR (TOKEN_LINE_STATUS='HD' and y.ALLOCATE_DATE_TIME IS NOT NULL)) "); //ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append(" AND TOKEN_LINE_STATUS in ('RG','XX') "); //and removed and ALLOCATE_DATE_TIME IS NULL and FILL_DATE_TIME IS NULL
					} 
				}
				else{
					if(getFillingStatus().equals("A")){
						append_qry.append(" AND ((TOKEN_LINE_STATUS='AL'and y.ALLOCATE_DATE_TIME IS NOT NULL) OR (TOKEN_LINE_STATUS='HD'and y.ALLOCATE_DATE_TIME IS NOT NULL)) "); //ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append(" AND TOKEN_LINE_STATUS='VF' ");
					} 
				}
			}
			else if(getDispStage().equals("D")){
				if(getFillingStatus().equals("A")){
					append_qry.append(" AND ((TOKEN_LINE_STATUS='IP' and y.FILL_DATE_TIME IS NOT NULL AND y.ALLOCATE_DATE_TIME IS NOT NULL ) OR (TOKEN_LINE_STATUS='HD' and y.FILL_DATE_TIME IS NOT NULL AND y.ALLOCATE_DATE_TIME IS NOT NULL )) "); //and DELIVER_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002 //FILL_DATE_TIME modified to y.FILL_DATE_TIME  & ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200
				}
				else if(getFillingStatus().equals("B")||getFillingStatus().equals("X")){
					//append_qry.append(" AND ((TOKEN_LINE_STATUS='AL' and y.ALLOCATE_DATE_TIME IS NOT NULL ) OR (TOKEN_LINE_STATUS='HD' and y.ALLOCATE_DATE_TIME IS NOT NULL )) "); //and DELIVER_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002 //ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200
					append_qry.append("AND Y.TOKEN_STATUS='AL'");//ADDED FOR ML-MMOH-SCF-2339
				} 
			}
			else if(getDispStage().equals("AS")){
				if(verf_combined_with_alloc.equals("C")) {
					append_qry.append(" AND TOKEN_LINE_STATUS IN ('RG','XX') ");//Removed 'AL','IP' for TTM-SCF-0097 [IN:048812]
				}
				else{
					append_qry.append(" AND TOKEN_LINE_STATUS IN ('VF','XX') ");//Removed 'AL','IP' for TTM-SCF-0097 [IN:048812]
				}
			}

			append_qry.append(" and ph_check_dc_token_status(y.facility_id,y.disp_locn_code,y.queue_date,y.queue_shift,y.token_series_code,y.token_serial_no)='N' ");
			//append_qry.append(" GROUP BY token_serial_no, ADDED_FACILITY_ID, ROWNUM HAVING ROWNUM<2 ORDER BY token_serial_no"); Commented for HSA-CRF-0136 [IN:048412]
			append_qry.append(" ORDER BY y.token_serial_no ) GROUP BY  added_facility_id"); //Added for HSA-CRF-0136 [IN:048412]
			//pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT76") + append_qry) ;
			pstmt		= connection.prepareStatement( append_qry.toString());//"SELECT MIN(token_serial_no) token_serial_no, ADDED_FACILITY_ID FROM ph_disp_queue WHERE facility_id = ? AND disp_locn_code = ? AND queue_date = TO_DATE (?, 'DD/MM/YYYY') AND queue_shift = '*ALL'  AND token_series_code = nvl(?,token_series_code) AND regn_date_time IS NOT NULL " + append_qry) ;
			int count=0;
			pstmt.setString(++count,login_facility_id);
			pstmt.setString(++count,disp_locn_code);
			pstmt.setString(++count,this.queue_date);
			if(!(token_series.trim().equals("")) )
				pstmt.setString(++count,token_series);
				
			if(!(token_no.equals("")) && validate_yn.equals("Y")) {								
				pstmt.setString(++count,token_no);
			}
 
			resultSet	= pstmt.executeQuery();
			if(resultSet.next()) {
				result	=	checkForNull(resultSet.getString("TOKEN_SERIAL_NO"));
				added_facility_id	=	checkForNull(resultSet.getString("ADDED_FACILITY_ID"));
			} 
			resultSet =null;
			if(!result.equals("")){
				token_dtls.put("TOKEN_NO",result);
				token_dtls.put("TOKEN_STATUS",(String)GetTokenStatus( token_series,result));
				token_dtls.put("ADDED_FACILITY_ID",added_facility_id);
			}
			else{
				token_dtls.put("TOKEN_NO",result);
				token_dtls.put("TOKEN_STATUS","");
				token_dtls.put("ADDED_FACILITY_ID","");
			}
		}
		catch ( Exception e ) {
			System.err.println("=displayTokenNumber==SQL==="+append_qry);
			 e.printStackTrace() ;
		}
		finally {
			try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			}
			catch(Exception es) { 
				es.printStackTrace();
			}
		 }
		return token_dtls;
	}

	public String validateTokenNumber(String token_series,String token_series_no)throws Exception{
		String result			= "N";
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		int count				= 0;
		StringBuilder append_qry = new StringBuilder();
		try {
			connection = getConnection() ;
			if(!token_series.equals(""))
				append_qry.append( "  AND y.TOKEN_SERIES_CODE=? ");
			//changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
			if(getDispStage().equals("V"))
				append_qry.append( " AND TOKEN_LINE_STATUS in ('RG','XX') ");
			else if(getDispStage().equals("A")){
				if(verf_combined_with_alloc.equals("C")) {
					if(getFillingStatus().equals("A")||getFillingStatus().equals("X")){
						append_qry.append( " AND TOKEN_LINE_STATUS in ('RG','XX') ");//and ALLOCATE_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append( " AND TOKEN_LINE_STATUS='IP' "); //and FILL_DATE_TIME IS NOT NULL AND ALLOCATE_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002
					} 
				}
				else{
					if(getFillingStatus().equals("A")||getFillingStatus().equals("X")){
						append_qry.append(" AND TOKEN_LINE_STATUS='VF' AND y.VERIFY_DATE_TIME IS NOT NULL "); //VERIFY_DATE_TIME modified to y.VERIFY_DATE_TIME for TFS-26200
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append( " AND TOKEN_LINE_STATUS='IP'and y.FILL_DATE_TIME IS NOT NULL "); //and ALLOCATE_DATE_TIME IS NULL  removed for PMG2020-ML-MMOH-CRF-0002 //FILL_DATE_TIME modified to y.FILL_DATE_TIME for TFS-26200
					} 
				}
			}
			else if(getDispStage().equals("F")){
				if(verf_combined_with_alloc.equals("C")) {
					if(getFillingStatus().equals("A")){
						append_qry.append( "AND ((TOKEN_LINE_STATUS='AL' and y.ALLOCATE_DATE_TIME IS NOT NULL) OR (TOKEN_LINE_STATUS='HD'and y.ALLOCATE_DATE_TIME IS NOT NULL )) "); //ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append( " AND TOKEN_LINE_STATUS in ('RG','XX') "); //and FILL_DATE_TIME IS NULL and ALLOCATE_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002
					} 
				}
				else{
					if(getFillingStatus().equals("A")){
						append_qry.append( " AND ((TOKEN_LINE_STATUS='AL'and y.ALLOCATE_DATE_TIME IS NOT NULL ) OR (TOKEN_LINE_STATUS='HD'and y.ALLOCATE_DATE_TIME IS NOT NULL )) ");  //ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200 
					}
					else if(getFillingStatus().equals("B")){
						append_qry.append(" AND TOKEN_LINE_STATUS='VF' ");
					} 
				}
			}
			else if(getDispStage().equals("D")){				
					if(getFillingStatus().equals("A")){
						append_qry.append(" AND ((TOKEN_LINE_STATUS='IP' and y.FILL_DATE_TIME IS NOT NULL AND y.ALLOCATE_DATE_TIME IS NOT NULL ) OR (TOKEN_LINE_STATUS='HD' and y.FILL_DATE_TIME IS NOT NULL AND y.ALLOCATE_DATE_TIME IS NOT NULL )) "); //and DELIVER_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002 //FILL_DATE_TIME modified to y.FILL_DATE_TIME  & ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200 
					}
					else if(getFillingStatus().equals("B")||getFillingStatus().equals("X")){
						append_qry.append( " AND ((TOKEN_LINE_STATUS='AL' and y.ALLOCATE_DATE_TIME IS NOT NULL ) OR (TOKEN_LINE_STATUS='HD' and y.ALLOCATE_DATE_TIME IS NOT NULL ))"); //and DELIVER_DATE_TIME IS NULL removed for PMG2020-ML-MMOH-CRF-0002 //ALLOCATE_DATE_TIME modified to y.ALLOCATE_DATE_TIME for TFS-26200
					} 
			}
			else if(getDispStage().equals("AS")){
				if(verf_combined_with_alloc.equals("C")) {
					append_qry.append( " AND TOKEN_LINE_STATUS IN ('IP','AL','RG','XX')");
				}
				else{
					append_qry.append(" AND TOKEN_LINE_STATUS IN ('IP','AL','VF','XX')");
				}
			}

			append_qry.append( " and ph_check_dc_token_status(y.facility_id,y.disp_locn_code,y.queue_date,y.queue_shift,y.token_series_code,y.token_serial_no)='N' ");



			//pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT75A")+append_qry) ;		
			pstmt				= connection.prepareStatement("SELECT COUNT(*) COUNT FROM PH_DISP_QUEUE y, ph_ord_for_disp_queue x WHERE Y.FACILITY_ID = x.facility_id AND y.disp_locn_code = x.disp_locn_code AND y.queue_date = x.queue_date AND y.queue_shift = x.queue_shift AND y.token_series_code = x.token_series_code AND y.token_serial_no = x.token_serial_no AND y.FACILITY_ID=? AND y.DISP_LOCN_CODE=? AND y.QUEUE_DATE=TO_DATE(?,'DD/MM/YYYY') AND y.QUEUE_SHIFT='*ALL'  AND y.TOKEN_SERIAL_NO=? "+append_qry);
			//ph_ord_for_disp_queue added in the existing query for PMG2020-ML-MMOH-CRF-0002
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,disp_locn_code);
			pstmt.setString(3,this.queue_date);
			pstmt.setString(4,token_series_no);
			if(!token_series.equals(""))
				pstmt.setString(5,token_series);
			resultSet	= pstmt.executeQuery();

			if(resultSet.next()) {
				count	=	resultSet.getInt("COUNT");
			} 
			
			if(count > 0 ) {
				result	=	"Y";
			}
		 }
			 catch ( Exception e ) {
			 e.printStackTrace() ;
			 throw e ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			 catch(Exception es) { es.printStackTrace();}
		 }
		return result;
	}

	public String GetTokenStatus(String token_series,String token_no) throws Exception{
		//int count = 0;
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		String token_status ="";
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT14") ) ;
			pstmt		= connection.prepareStatement("SELECT TOKEN_STATUS FROM PH_DISP_QUEUE WHERE FACILITY_ID=? AND DISP_LOCN_CODE=? AND QUEUE_DATE=TO_DATE(?,'DD/MM/YYYY') AND QUEUE_SHIFT='*ALL' AND TOKEN_SERIES_CODE=? AND TOKEN_SERIAL_NO=?");

			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,disp_locn_code);
			pstmt.setString(3,this.queue_date);
			pstmt.setString(4,token_series);
			pstmt.setString(5,token_no);
			resultSet	= pstmt.executeQuery();
			if(resultSet.next()) {				
				token_status = checkForNull(resultSet.getString("TOKEN_STATUS"));
			}
		}
			catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return token_status;
	}

	public String validateWSForTokenSeries() throws Exception{
		int count = 0;
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT14") ) ;
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,getDispLocnCode().trim());
			pstmt.setString(3,login_at_ws_no.trim());
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				count = resultSet.getInt("count");
			}
		}
			catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		if(count>0){
			return "Y";
		}else{
			return "N";
		}
	}

	/*
		This method will be helpful to get all the patients based on the query criteria...
	*/
	public ArrayList getAllThePatientsBasedOnCriteria(String from, String to)throws Exception{
		String patient_id			= checkForNull(getPatientID().trim());// checkForNull Added KAUH-SCF-0183[IN:047989]
		String order_id				= checkForNull(getOrderID());// checkForNull Added KAUH-SCF-0183[IN:047989]
		String priority				= checkForNull(getPriority().trim());// checkForNull Added KAUH-SCF-0183[IN:047989]
		String order_date_from		= checkForNull(getOrderDateFrom());// checkForNull Added KAUH-SCF-0183[IN:047989]
		String order_date_to		= checkForNull(getOrderDateTo());// checkForNull Added KAUH-SCF-0183[IN:047989]
		String disp_locn_code		= getDispLocnCode();
		String scope				= checkForNull(getScope(),"A");// checkForNull Added KAUH-SCF-0183[IN:047989]
		String disp_locn_catg		= getDispLocnCatg();
		String issue_token_on_regn_yn = getIssueTokenOnRegnYN();
		String disp_regn_reqd_yn	= checkForNull(getDispRegnReqdYN());// checkForNull Added KAUH-SCF-0183[IN:047989]
		String nursing_unit			= checkForNull(getNursingUnit().trim());// checkForNull Added KAUH-SCF-0183[IN:047989]		
		String unallocdrugs			= "";
		String disp_locn_iae			= checkForNull(getDisp_locn_iae());//Added by Himanshu for MMS-DM-CRF-0232
		ArrayList result			= new ArrayList();
		ArrayList allPatientssel		= new ArrayList();//Added for Bru-HIMS-CRF-416
		patient_locator				= new ArrayList();
		Connection connection		= getConnection() ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null;
		ResultSet resultSet_meta	= null;
		String prevnextlink			= "";
		int query_result_size		= 12;
		int start = 0 ;
		int end = 0 ;
		StringBuffer sbConstructSql =new StringBuffer();
		StringBuffer sbStagesCondition =new StringBuffer();
		StringBuffer sbDrugRelateSQL =new StringBuffer();
		StringBuffer sbAppendSql1 = new StringBuffer();// Added for [IN:048366]
		StringBuffer sbMainSql = new StringBuffer();
		String str_last_disp = ""; //SKR-SCF-1467
		String tab_based_group_sort_disp = getTabBasegGroupSortDisp();
		String customGroupBySql="", customSortBySql = "";
		String customGroupBy = getCustomGroupBy();
		String customSortBy  = getCustomSortBy();
		String customGroupOrder = getCustomGroupOrder();
		String customSortOrder = getCustomSortOrder();
		String customTabBased = getCustomTabBased();
		String customTabBasedHrs = getCustomTabBasedHrs();
		String customTabBasedOption = getCustomTabBasedOption();
		String orderDateSql = ""; 
		setSalDocDtls(new ArrayList());
		String bed_no = getBedNo()==null?"":getBedNo(); // bed_no Added for KDAH-CRF-0338
		String opCustomSortByValue = getOpCustomSortBy(); //Added for ML-MMOH-CRF-1666 
		String opCustomSortByOrderValue = getOpCustomSortOrder(); //Added for ML-MMOH-CRF-1666 
		StringBuffer CustomSortByValueopSql = new StringBuffer(); //Added for ML-MMOH-CRF-1666 
		String dipenserightforIAE ="";
		
//Added for ML-MMOH-CRF-1666 start		
if((tab_based_group_sort_disp !=null && opCustomSortByValue!=null && tab_based_group_sort_disp.equals("Y")) && !opCustomSortByValue.equals("")){
		if(group_by_ord_locn.equals("N")){
	
	if (opCustomSortByValue.equals("RELEASE_DATE_TIME")){
		CustomSortByValueopSql.append("ORDER BY to_date("+opCustomSortByValue+" ,'dd/mm/yyyy hh24:mi')  "+opCustomSortByOrderValue+"");
	}
	else if (opCustomSortByValue.equals("NURSING_UNIT")){
		CustomSortByValueopSql.append("ORDER BY locn_desc "+opCustomSortByOrderValue+"");
	}
	else {
	CustomSortByValueopSql.append(" ORDER BY "+ opCustomSortByValue);
    CustomSortByValueopSql.append("  "+opCustomSortByOrderValue);
	}
}
		else {
			CustomSortByValueopSql.append("  ORDER BY LOCN_DESC, "+ opCustomSortByValue); //LOCN_DESC, Modified for ML-MMOH-SCF-2267
		    CustomSortByValueopSql.append("  "+opCustomSortByOrderValue);
			}		
}
else{
	CustomSortByValueopSql.append("");
}//Added for ML-MMOH-CRF-1666 end

		unallocdrugs = this.display_unallocDrugs;//code added for finding unallocated drugs....	//changed during PE By Naveen	//unallocdrugs = getAllocDrugs();
		if ( from == null || from.equals(""))
			start = 1 ;
		else
			start = Integer.parseInt( from ) ;

		if ( to == null || to.equals(""))
			end =query_result_size;
		else
			end = Integer.parseInt( to ) ;
		
		long count=0;
		long i = 0;

		try {
			boolean siteTpn = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","TPN_MF_LABEL");// added for ML-MMOH-CRF-0468
			boolean PH_OP_MEDICATION_ORD_DISP = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","PH_OP_MEDICATION_ORD_DISP");// added for MOHE-CRF-0158
			boolean ph_print_prescription = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","PH_PRINT_PRESCRIPTION");//Added for MMS-DM-CRF-0228
			boolean isSite_integration_em_bd_pyxis =  eCommon.Common.CommonBean.isSiteSpecific(connection,"PH","PH_INTEGRATION_EM_BD_PYXIS");//Added by Himanshu for MMS-DM-CRF-0232
			boolean  isSite_ph_new_prescription		= eCommon.Common.CommonBean.isSiteSpecific(connection,"PH","PH_NEW_PRESCRIPTION");//added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24
			if(((scope).trim()).equals("")){
				scope = "A";
			}

			if (scope.equals("AS") ){
				sbDrugRelateSQL = new StringBuffer(" AND EXISTS (SELECT NULL FROM PH_ORDER_TYPE_FOR_DRUG_CLASS WHERE ORDER_TYPE_CODE = A.ORDER_TYPE_CODE) AND EXISTS (SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE != '58' ");
				if (!scope.equals("D") && !scope.equals("A")){	
					sbDrugRelateSQL.append(" OR A.DISCHARGE_IND='D' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
				}
				else {	
					sbDrugRelateSQL.append( " AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
				}
			}
 
			if(getAdmixtureIdentity().equals("IV_CYTO_TPN")){
				getDispStagesApplicable(disp_locn_code,disp_locn_catg);
			}

			// Dispense Location Category --> InPatient
			String sFreqDurnAbsOrderFlag = "X"; //Both unchecked			//added for SRR20056-CRF-0663 --Start
			if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
				if(this.include_absolute_orders.equals("Y") && this.include_drugs_by_freq_durn.equals("Y"))
					sFreqDurnAbsOrderFlag="B";	// For Both Absolute orders and FreqDurn orders
				else if(this.include_absolute_orders.equals("Y") && this.include_drugs_by_freq_durn.equals("N"))
					sFreqDurnAbsOrderFlag="A";	//Only Absolute orders
				if(this.include_absolute_orders.equals("N") && this.include_drugs_by_freq_durn.equals("Y"))
					sFreqDurnAbsOrderFlag="F";	
			}
			else
				sFreqDurnAbsOrderFlag = this.include_absolute_orders;		//added for SRR20056-CRF-0663 --End

			setsFreqDurnAbsOrderFlag_1(sFreqDurnAbsOrderFlag); //Added for RBU-GHL-CRF-0047 - Kishore
			if(disp_locn_catg.equals("I")){
				if(disp_stage.equals("F") && fill_list.equals("AF")){ // Filling stage and Against Fill List					
					sbConstructSql = new StringBuffer(" and a.ORDERING_FACILITY_ID=? ");
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]

					if(getOrderStatus().equals("OSN")){	// If Order Status is New
						sbConstructSql.append(" AND F.ORDER_STATUS_TYPE IN('10','25','36','35','30') AND k.LAST_DISPENSED_DATE IS NULL ");
					}
					else if(getOrderStatus().equals("H")){				
						sbConstructSql.append(" AND F.ORDER_STATUS_TYPE = '50' ");
					}
					if(getOrderType().equals("NOR")) {
						sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
					}
					else if(getOrderType().equals("IVAD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN - KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVAA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN - KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVWA")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='5' ");// = Added instead of IN - KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVID")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN - KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVIA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN - KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("TD")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='7' ");
					}
					else if(getOrderType().equals("TA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
					}
					else if(getOrderType().equals("CD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
					}
					else if(getOrderType().equals("CA")) {
						sbConstructSql.append( " AND A.IV_PREP_YN = '0' ");
					}
					else if(getOrderType().equals("CO")) {
						sbConstructSql.append( " AND A.IV_PREP_YN = '6' ");
					}
			
					if(!getOrderStatus().equals("H")){
						if(getBatches().equals("BA")){		// If Batches Allocated
							sbConstructSql.append(" AND A.ORDER_ID IN (SELECT ORDER_ID FROM PH_DISP_DRUG_BATCH_TMP ) ");
						}
						else if(getBatches().equals("BNA")){
							sbConstructSql.append( " AND A.ORDER_ID NOT IN (SELECT ORDER_ID FROM PH_DISP_DRUG_BATCH_TMP ) ");
						}
					}
						//Added for SRR20056-CRF-0663	--Start
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
						sbConstructSql.append( " and ((j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N' ) and ( (j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
					}
					else{
						sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
					}	//Added for SRR20056-CRF-0663	--End
 
					sbConstructSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id) ");//added to filter only current Inpatient.
					if(!(this.drug_medical.equals(""))){  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbConstructSql.append(" AND J.DRUG_YN = ? ");}
					sbConstructSql.append(" AND ph_get_user_disp_rights(?,?"); // Added parameters - KAUH-SCF-0183[IN:047989]
					sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and h.FILL_INT_START_DATE_TIME =TO_DATE (?, 'dd/mm/yyyy hh24:mi') and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, a.source_code, A.PATIENT_ID, PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code ,  C.NATIONAL_ID_NO");//Added last 3 params to ph_get_user_disp_rights for Performance issue by chandra 17072022

					if(group_by_ord_locn.equals("N")){
						sbConstructSql.append( " order by min(a.ADDED_DATE)");
					}
					else{
						sbConstructSql.append( " order by nursing_unit, min(a.ADDED_DATE),A.PATIENT_ID");
					}				
					if(getOrderStatus().equals("H")){//patient_name-loc
						sbMainSql.append("SELECT MAX (a.priority) priority, a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no, TO_CHAR (MIN (a.added_date), 'dd/mm/yyyy hh24:mi') release_date_time, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID FROM or_order_line b, or_order a, mp_patient c, or_order_status_code f, ph_fill_process_param h, ph_drug j, or_order_line_ph k WHERE  c.patient_id = a.patient_id AND b.order_id = a.order_id AND f.order_status_code = b.order_line_status AND b.order_id = k.order_id AND b.order_line_num = k.order_line_num AND h.fill_proc_id = k.fill_proc_id "); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119]
						if(!nursing_unit.equals(""))	// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND a.source_code = ? " );
						 if( !getOrderID().equals("")){	// Added condition order_id for JD-CRF-0181 [IN:40699]
							 sbMainSql.append(" AND a.order_id = ? " );}
						sbMainSql.append(" AND f.order_status_type IN ('10', '25', '30', '36', '35', '50') AND a.patient_class in( 'IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND a.order_category = 'PH' ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						if(!(getFillProcessID().trim().equals("")))		// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND h.fill_proc_id = ? ");	
						sbMainSql.append(" AND TRUNC (h.fill_proc_date_time) = DECODE (?, NULL, TRUNC (h.fill_proc_date_time), TRUNC (TO_DATE (?, 'dd/mm/yyyy')) ) ");
						if(!(getFillType().trim().equals("")))	// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND h.proc_type = ? ");
						sbMainSql.append(" AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, a.source_type, a.source_code, a.added_facility_id,a.performing_facility_id, a.performing_deptloc_code, j.drug_class, j.drug_code, b.order_type_code, a.patient_class, a.priority,a.discharge_ind,DECODE (j.drug_yn, 'Y', 'D', 'N', 'M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' AND (b.end_date_time) >= TRUNC (SYSDATE) " );
						if(!add_criteria_practitioner_id.equals(""))	// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND a.ord_pract_id = ? ");
						if(!this.getGender().equals(""))	// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND c.sex = ? ");
						if(!add_criteria_nat_code.equals(""))	// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND c.nationality_code = ? ");
						sbMainSql.append(" AND j.drug_code = b.order_catalog_code ");// removed a.ord_date_time BETWEEN SYSDATE - 365 AND SYSDATE + 365 AND for IN030219	SKR-SCF-0364 
						pstmt = connection.prepareStatement(sbMainSql.toString() + sbConstructSql.toString());
					}
					else{
						sbMainSql.append("SELECT /*+ INDEX(PH_DISP_LOCN PH_DISP_LOCN_PK) USE THIS INDEX COZ THE DISP LOCN RETRIEVAL IS ONLY ONE RECORD */ max(a.priority) priority , A.PATIENT_ID, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code and language_id = ?) NURSING_UNIT, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT(DISTINCT A.ORDER_ID) ORDERS, GET_AGE(DATE_OF_BIRTH) AGE, SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC, C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID FROM OR_ORDER_LINE B, OR_ORDER A, MP_PATIENT C , OR_ORDER_STATUS_CODE F,PH_DISP_HDR_TMP G,PH_FILL_PROCESS_PARAM H ,ph_drug j,or_order_line_ph k WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND F.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND B.ORDER_ID=G.ORDER_ID AND H.FILL_PROC_ID=G.FILL_PROC_ID "); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119]
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND a.source_code= ? ");						
						if(!getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							sbMainSql.append(" AND a.order_id = ? ");
						sbMainSql.append(" AND F.ORDER_STATUS_TYPE in ('10','25','30','36','35') AND G.PATIENT_CLASS in ( 'IP','DC') AND A.PATIENT_CLASS in ( 'IP','DC')  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' "); //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						if(!(getFillProcessID().trim().equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND G.FILL_PROC_ID= ? ");
						sbMainSql.append(" and b.ORDER_ID=k.ORDER_ID and b.ORDER_LINE_NUM= k.ORDER_LINE_NUM AND TRUNC(G.RECORD_DATE_TIME)=decode(?,null,TRUNC(G.RECORD_DATE_TIME),TRUNC(TO_DATE(?,'dd/mm/yyyy'))) ");
						if(!(getFillType().trim().equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND H.PROC_TYPE= ? ");
						sbMainSql.append(" AND g.disp_locn_code=? AND (B.END_DATE_TIME) >= TRUNC(SYSDATE) ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID= ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						sbMainSql.append("  and j.drug_code =b.order_catalog_code "); 
						pstmt = connection.prepareStatement(sbMainSql.toString() + sbConstructSql.toString());
					}
//System.err.println("==============Fill AGAISET fill list sbMainSql="+sbMainSql+ sbConstructSql.toString());

					int position =0;
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
					pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
					if(!nursing_unit.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,nursing_unit);
					if(!getOrderID().equals(""))//Added for CRF-0181
					    pstmt.setString(++position,getOrderID());
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					if(!(getFillProcessID().trim().equals("")))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getFillProcessID().trim());
					pstmt.setString(++position,getFillProcessDate().trim());
					pstmt.setString(++position,getFillProcessDate().trim());
					if(!(getFillType().trim().equals("")))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getFillType().trim());
					pstmt.setString(++position,getDispLocnCode());
					if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,add_criteria_practitioner_id);
					if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.getGender());
					if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,add_criteria_nat_code);
					//pstmt.setString(++position,getLanguageId()); //Commented for GHL-SCF-0830 [IN:049943]
					pstmt.setString(++position,this.orderingfacility);
					pstmt.setString(++position,sFreqDurnAbsOrderFlag); //exclude_drugs_by_freq_durn changed to include_absolute_orders for SRR20056-CRF-0663 this.include_absolute_orders===>sFreqDurnAbsOrderFlag
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
						pstmt.setString(++position,this.exclude_PRN_orders);					//added for SRR20056-CRF-0663
					}
					pstmt.setString(++position,this.exclude_PRN_orders);
					if(!(this.drug_medical.equals(""))){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);}
					pstmt.setString(++position,login_facility_id);// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,login_by_id);// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022

					pstmt.setString(++position,getFillDateTime());					
					pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
					pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
				}
				else if(disp_stage.equals("D")){// Delivery Stage
					sbConstructSql = new StringBuffer(" and a.ORDERING_FACILITY_ID=? ");

					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]
					if(getCriteriaOrderType().equals("ALL")){	
						if(ip_scope.equals("A")) { // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
							sbConstructSql.append(" AND (F.ORDER_STATUS_TYPE = '50' ");
							sbConstructSql.append(" OR ((a.iv_prep_yn IN ('2', '4', '6', '0') AND ((NVL (k.finalized_yn, 'N') = 'Y' AND f.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND f.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND f.order_status_type IN ('10', '35', '30')))");
							sbConstructSql.append(" OR ( ( a.iv_prep_yn IN ('2', '4', '6', '0') AND k.finalized_yn = 'Y' AND f.order_status_type = '35') OR ( NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND f.order_status_type = '35' ) ))");								
						} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
						else if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND F.ORDER_STATUS_TYPE = '50' ");
						}
						else if(unallocdrugs.equals("Y"))	{
							sbConstructSql.append(" AND ((a.iv_prep_yn IN ('2', '4', '6', '0') AND ((NVL (k.finalized_yn, 'N') = 'Y' AND f.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND f.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND f.order_status_type IN ('10', '35', '30')))");
						} 
						else {
							sbConstructSql.append(" AND ( ( a.iv_prep_yn IN ('2', '4', '6', '0') AND k.finalized_yn = 'Y' AND f.order_status_type = '35') OR ( NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND f.order_status_type = '35' ) )");
						}						
					}
					else if(getCriteriaOrderType().equals("CDR") ){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]	
						if(ip_scope.equals("A")) { 
							sbConstructSql.append(" AND (F.ORDER_STATUS_TYPE = '50' ");
							sbConstructSql.append(" OR ((a.iv_prep_yn='0' AND ((NVL (k.finalized_yn, 'N') = 'Y' AND f.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND f.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('9', 'X') AND f.order_status_type IN ('10', '35', '30')))");
							sbConstructSql.append(" OR ( ( a.iv_prep_yn='0' AND k.finalized_yn = 'Y' AND f.order_status_type = '35') OR ( NVL (a.iv_prep_yn, 'X') IN ('9', 'X') AND f.order_status_type = '35' ) ))");								
						} 
						else if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND F.ORDER_STATUS_TYPE = '50' ");
						}
						else if(unallocdrugs.equals("Y"))	{
							sbConstructSql.append(" AND ((a.iv_prep_yn='0' AND ((NVL (k.finalized_yn, 'N') = 'Y' AND f.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND f.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('9', 'X') AND f.order_status_type IN ('10', '35', '30')))");
						} 
						else {
							sbConstructSql.append(" AND ( ( a.iv_prep_yn='0' AND k.finalized_yn = 'Y' AND f.order_status_type = '35') OR ( NVL (a.iv_prep_yn, 'X') IN ('9', 'X') AND f.order_status_type = '35' ) )");
						}						
					} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
					else{
						if(ip_scope.equals("A")) {  // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
							sbConstructSql.append(" AND (F.ORDER_STATUS_TYPE = '50' ");
							
							if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")||getOrderType().equals("CA") || getOrderType().equals("TA"))
								sbConstructSql.append( " OR ((a.iv_prep_yn IN ('2', '4', '6', '0','8') AND ((NVL (k.finalized_yn, 'N') = 'Y' AND f.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND f.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND f.order_status_type IN ('10', '35', '30')))");
							else
								sbConstructSql.append(" OR F.ORDER_STATUS_TYPE IN('10','35','30') ");
							 
							sbConstructSql.append( " OR F.ORDER_STATUS_TYPE = '35') ");
						}	 // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
						else if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND F.ORDER_STATUS_TYPE = '50' ");
						}
						else if(unallocdrugs.equals("Y"))	{	
							if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")||getOrderType().equals("CA") || getOrderType().equals("TA"))
								sbConstructSql.append( " AND ((a.iv_prep_yn IN ('2', '4', '6', '0','8') AND ((NVL (k.finalized_yn, 'N') = 'Y' AND f.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND f.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND f.order_status_type IN ('10', '35', '30')))");
							else
								sbConstructSql.append(" AND ( F.ORDER_STATUS_TYPE IN('10','30') OR (f.order_status_type = '35' AND (NVL(k.finalized_yn,'N') = 'Y'))) ");
						} 
						else {
							sbConstructSql.append( " AND F.ORDER_STATUS_TYPE = '35' AND (NVL (k.finalized_yn, 'N') = 'Y' )");
						}
					}

					if(getCriteriaOrderType().equals("ALL")) {
						sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
					}
					else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
						sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
					} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
					else if(getOrderType().equals("NOR")) {
						sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
					} 
					else if(getOrderType().equals("IVAD")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVAA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVWA")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVID")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVIA")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("TD")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='7' ");
					}
					else if(getOrderType().equals("TA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
					}
					else if(getOrderType().equals("CD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
					}
					else if(getOrderType().equals("CA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
					}
					else if(getOrderType().equals("CO")) {
						sbConstructSql.append( " AND A.IV_PREP_YN = '6' ");
					}
					//ended...
					sbConstructSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id) "); //added to filter only current Inpatient.
					
					if(ip_scope.equals("A")) {  // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
						if(getOrderType().equals("TA") || getOrderType().equals("TD")){
							sbConstructSql.append(" AND (G.LAST_DISPENSED_DATE IS NULL OR  G.LAST_DISPENSED_DATE IS NOT NULL) ");
							}
						else{
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
								sbConstructSql.append(" and ( (j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N' ) and ( (j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
							
							}
							else{
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
							}
							sbConstructSql.append( " AND (G.LAST_DISPENSED_DATE IS NULL OR G.LAST_DISPENSED_DATE IS NOT NULL) ");
							if(!(this.drug_medical.equals("")))
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' ");
						}				
					}	// if condition Added for ML-MMOH-CRF-0434 [IN057356] - End	
					else if(ip_scope.equals("N")) {
						if(getOrderType().equals("TA") || getOrderType().equals("TD")){
							sbConstructSql.append(" AND G.LAST_DISPENSED_DATE IS NULL ");//GROUP BY E.LONG_DESC,A.PATIENT_ID, PATIENT_NAME, DATE_OF_BIRTH, SEX,COUNTRY_CODE, D.LONG_DESC,C.NATIONAL_ID_NO");
						}
						else{
							
							//Added for SRR20056-CRF-0663	--Start
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
								sbConstructSql.append(" and ( (j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N' ) and ( (j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
							}
							else{
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
							}
							//Added for SRR20056-CRF-0663	--End
							sbConstructSql.append( " AND G.LAST_DISPENSED_DATE IS NULL ");
							if(!(this.drug_medical.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' ");//GROUP BY E.LONG_DESC,A.PATIENT_ID, PATIENT_NAME, DATE_OF_BIRTH, SEX,COUNTRY_CODE, D.LONG_DESC,C.NATIONAL_ID_NO");
						}
					}
					else {
						if(getOrderType().equals("TA") || getOrderType().equals("TD")){
							sbConstructSql.append(" AND G.LAST_DISPENSED_DATE IS NOT NULL and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?");
							if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									sbConstructSql.append(" AND b.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi' )");
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
								sbConstructSql.append(" AND b.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999");//added for SKR-SCF-1606
							}
							sbConstructSql.append(" GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, a.source_code, A.PATIENT_ID, PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO ");
						}
						else{
							//Added for SRR20056-CRF-0663	--Start
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
								sbConstructSql.append( " and ( (j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N') and ( ( j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
							}
							else{
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
							}
							//Added for SRR20056-CRF-0663	--End							
							sbConstructSql.append( " AND G.LAST_DISPENSED_DATE IS NOT NULL ");
							if(!(this.drug_medical.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' ");//GROUP BY E.LONG_DESC,A.PATIENT_ID, PATIENT_NAME, DATE_OF_BIRTH, SEX,COUNTRY_CODE, D.LONG_DESC,C.NATIONAL_ID_NO ");
						}
					}
						 //Added for PMG20089-CRF-0867 [IN029813] -start
						if( tab_based_group_sort_disp.equals("Y")  ){
							customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?)";
							
							//added condition for SKR-SCF-1606
							if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
								customGroupBySql =customGroupBySql+" AND b.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi')";
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
								customGroupBySql =customGroupBySql+" AND b.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999";//added for SKR-SCF-1606
							}
							customGroupBySql =customGroupBySql+ " GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME, PATIENT_NAME_LOC_LANG,DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO, a.source_code, i.NURSING_UNIT_CODE, i.bed_num ";//E.NURSING_UNIT_CODE,E.LONG_DESC "; //i.bed_num added for KDAH-CRF-0338
							customSortBySql  = " ORDER BY nursing_unit ";
							if(customTabBased.equals("Y")){
								if(customTabBasedOption.equals("PAST"))
									sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
								else
									sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24)  ");// Added parameter - KAUH-SCF-0183[IN:047989]
							}
							if( !customGroupBy.equals("NURSING_UNIT")){
								if(!(customGroupBy.equals("NONE"))){
									customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?)";
									// added SKR-SCF-1606
									
									if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
										if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
										customGroupBySql =customGroupBySql+" AND b.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi')";
									}//Added MMS-DM-CRF-0228 end
									else{
										if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
										customGroupBySql =customGroupBySql+" AND b.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999";//added for SKR-SCF-1606
									}
									customGroupBySql = customGroupBySql+ " GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO, a.source_code, i.NURSING_UNIT_CODE, i.bed_num,  A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy'),to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ";   //i.bed_num added for KDAH-CRF-0338
										if(customGroupBy.equals("ORD_DATE_TIME"))
											customGroupBy = "to_date("+customGroupBy+" ,'dd/mm/yyyy')";
										else if (customGroupBy.equals("RELEASE_DATE_TIME"))
											customGroupBy = "trunc(to_date("+customGroupBy+" ,'dd/mm/yyyy hh24:mi'))";
										customSortBySql = " ORDER BY " +customGroupBy+" " + customGroupOrder ;
										if (customSortBy.equals("RELEASE_DATE_TIME"))
											customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
										customSortBySql = customSortBySql + ", "+customSortBy+" "+customSortOrder;
								}
								else{
										if(!(customSortBy.equals("NURSING_UNIT"))){
											if (customSortBy.equals("RELEASE_DATE_TIME"))
												customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
											customSortBySql = " ORDER BY "+customSortBy+" "+customSortOrder;
										}
										else
											customSortBySql = customSortBySql +" " +customSortOrder	;
									}
							}
							else  if (!(customSortBy.equals("") || customSortBy.equals("NONE") || customSortOrder.equals(""))){
								if(!(customGroupBy.equals("NURSING_UNIT"))){
									if (customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = "  ORDER BY "+customSortBy+" "+customSortOrder;
								}
								else{
									if(!customSortBy.equals("PATIENT_ID")){
										customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?)";

										if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
											if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
												customGroupBySql =customGroupBySql+" AND b.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi' )";
										}//Added MMS-DM-CRF-0228 end
										else{
											if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
												customGroupBySql =customGroupBySql+" AND b.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999";//added for SKR-SCF-1606
										}
										customGroupBySql= customGroupBySql+ "GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_code, i.NURSING_UNIT_CODE, i.bed_num, A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy), "; //i.bed_num added for KDAH-CRF-0338
									}
									if (customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = customSortBySql+" "+customGroupOrder +", "+customSortBy+" "+customSortOrder;
								}
							}
							else{
								if(customGroupBy.equals("NURSING_UNIT"))
									customSortBySql = customSortBySql+" "+customGroupOrder ;
							}
							sbConstructSql.append(customGroupBySql);
							sbConstructSql.append(customSortBySql); 
						} //Added for PMG20089-CRF-0867 [IN029813] -End
						else{
							sbConstructSql.append( " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?)");
							
							if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									sbConstructSql.append(" AND b.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi' )");
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									sbConstructSql.append(" AND b.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999");//added for SKR-SCF-1606
							}
							
							sbConstructSql.append("GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, a.source_code/* i.nursing_unit_code*/, i.bed_num, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO "); //i.bed_num added for KDAH-CRF-0338//modified and added for skr-scf-1231a.source_code/* i.nursing_unit_code*/
							if(group_by_ord_locn.equals("N"))
								sbConstructSql.append(" order by min(a.ADDED_DATE) ");
							else
								sbConstructSql.append( " order by nursing_unit, min(a.ADDED_DATE),A.PATIENT_ID ");
						}
					
					sbMainSql=new StringBuffer();
					if(getCriteriaOrderType().equals("ALL") || getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
						//modified by naveen for PE issues on Apr2010
						if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){//patient_name-loc
							sbMainSql.append("SELECT DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY  ,a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code/*i.NURSING_UNIT_CODE*/ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num,a.source_code /*i.nursing_unit_code*/ FROM or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_worksheet_hdr k,ph_drug j, ph_disp_hdr_tmp l WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC')  AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND a.order_id = k.order_id(+) and j.drug_code =b.order_catalog_code AND a.performing_facility_id = l.facility_id AND a.order_id = l.order_id AND l.fill_proc_id IS NULL"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119]   // i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category KDAH-ICN-0006 // i.nursing_unit_code added for BSP-SCF-0060 //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
						else{ //patient_name-loc
							sbMainSql.append("SELECT max(a.priority)priority ,a.patient_id,(select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*i.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id, A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num /*,i.nursing_unit_code*/,a.source_code FROM or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_worksheet_hdr k,ph_drug j, ph_disp_hdr_tmp l WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC')  AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND a.order_id = k.order_id(+) and j.drug_code =b.order_catalog_code AND a.performing_facility_id = l.facility_id AND a.order_id = l.order_id AND l.fill_proc_id IS NULL"); // removed a.ORD_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND B.START_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND for IN030219 SKR-SCF-0364  //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND//ADDED FOR KDAH-ICN-0006 a.order_category = b.order_category // i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}	
					}
					else if(getOrderType().equals("NOR")||getOrderType().equals("IVAD")||getOrderType().equals("IVID")||getOrderType().equals("IVWA")||getOrderType().equals("CD")){
						if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){//patient_name-lov
							sbMainSql.append("SELECT  DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*i.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no, to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME FROM, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num, /*,i.nursing_unit_code */ a.source_code  from or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_drug j, ph_disp_hdr_tmp l WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' and j.drug_code =b.order_catalog_code AND a.performing_facility_id = l.facility_id AND a.order_id = l.order_id AND l.fill_proc_id IS NULL"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119]   //i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category//ADDED FOR KDAH-ICN-0006 // i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
						else{ //patient_name-loc
							sbMainSql.append("SELECT max(a.priority)priority , a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code/*i.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no, to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num, /*i.nursing_unit_code */ a.source_code  FROM or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_drug j, ph_disp_hdr_tmp l WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' and j.drug_code =b.order_catalog_code AND a.performing_facility_id = l.facility_id AND a.order_id = l.order_id AND l.fill_proc_id IS NULL");  // removed  a.ORD_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND B.START_DATE_TIME BETWEEN SYSDATE-365 AND for IN030219	SKR-SCF-0364  //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] //i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category//ADDED FOR KDAH-ICN-0006 //i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
					}
					else if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")|| getOrderType().equals("CA") ){
						if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){ //patient_name-loc
							sbMainSql.append("SELECT DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*i.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num ,/*i.nursing_unit_code*/ a.source_code FROM or_order_line b,or_order a, mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_worksheet_hdr k,ph_drug j WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC') AND  ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND a.order_id = k.order_id AND k.finalized_yn = 'Y' and j.drug_code =b.order_catalog_code "); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] //i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category //ADDED FOR KDAH-ICN-0006 // i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
						else{//patient_name-lov
							sbMainSql.append("SELECT max(a.priority)priority , a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*i.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num /*,i.nursing_unit_code */ ,a.source_code FROM or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_worksheet_hdr k,ph_drug j WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC') AND  ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /*AND B.order_category = 'PH'*/ AND b.order_category = 'PH'   AND a.order_category = b.order_category AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND a.order_id = k.order_id AND k.finalized_yn = 'Y' and j.drug_code =b.order_catalog_code ");// removed for IN030219 a.ORD_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND B.START_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND SKR-SCF-0364   //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category//ADDED FOR KDAH-ICN-0006 // i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
					}
					else if(getOrderType().equals("TA") || getOrderType().equals("TD")){
						if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){//patient_name-loc
							sbMainSql.append("SELECT DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*i.NURSING_UNIT_CODE*/ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,  COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num,/*i.nursing_unit_code */ a.source_code FROM or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_tpn_worksheet_hdr k WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND a.performing_deptloc_code = ? AND a.order_id = k.order_id(+) AND k.finalized_yn(+)= 'Y' "); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] //i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category//ADDED FOR KDAH-ICN-0006 // i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
						else{//patient_name-loc
							sbMainSql.append("SELECT max(a.priority)priority ,a.patient_id, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*i.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,  COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, i.bed_num, /*i.nursing_unit_code*/ a.source_code FROM or_order_line b,or_order a,mp_patient c, or_order_status_code f,or_order_line_ph g,ip_open_encounter i,ph_tpn_worksheet_hdr k WHERE c.patient_id = a.patient_id AND i.encounter_id = a.encounter_id AND i.facility_id = a.ordering_facility_id AND b.order_id = a.order_id AND g.order_id = a.order_id AND g.order_line_num = b.order_line_num AND f.order_status_code = b.order_line_status AND a.patient_class in ( 'IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 AND b.order_category = 'PH'   AND a.order_category = b.order_category AND a.performing_deptloc_code = ? AND a.order_id = k.order_id(+) AND k.finalized_yn(+)= 'Y' "); // removed a.ORD_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND B.START_DATE_TIME BETWEEN SYSDATE-365 AND SYSDATE+365 AND for IN030219	SKR-SCF-0364 //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] //i.bed_num added for KDAH-CRF-0338 //a.order_category = 'PH' changed to b.order_category = 'PH' and added AND a.order_category = b.order_category //ADDED FOR KDAH-ICN-0006 // i.nursing_unit_code added for BSP-SCF-0060//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						}
					}
					if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
						sbMainSql.append(" AND a.order_id = ?"); 
//code added for PE correction on 13Apr2010
					
					if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
						if(ip_scope.equals("R") ){//if block and else condition for ML-BRU-SCF-1147 [IN045177]
							if( getFilter_on_next_fill_date().equals("Y")) 
								sbMainSql.append(" AND G.NEXT_FILL_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
							else
								sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')  AND G.LAST_DISPENSED_DATE IS NOT NULL");
						}
						else{
							if(getFilterBasedOnOrdDateYN().equals("Y"))  //if block and else condition added KAUH -EMR for Order date filter
								sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
							else
								sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
						}
					}//Added MMS-DM-CRF-0228 end
					else{
						if(ip_scope.equals("R") ){//if block and else condition for ML-BRU-SCF-1147 [IN045177]
							if( getFilter_on_next_fill_date().equals("Y")) 
								sbMainSql.append(" AND G.NEXT_FILL_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
							else
								sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999  AND G.LAST_DISPENSED_DATE IS NOT NULL"); //A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
						}
						else{
							if(getFilterBasedOnOrdDateYN().equals("Y"))  //if block and else condition added KAUH -EMR for Order date filter
								sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
							else
								sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");// code 'A.ORD_DATE_TIME' is replaced by B.START_DATE_TIME for Bru-HIMS-CRF-418[IN045564]
						}
					}
					if(!nursing_unit.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" AND a.source_code = ? ");
					
					// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
					if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
					{
						sbMainSql.append(" and l.DOC_NO = ? ");
					}
					// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 ends
					
					if(!bed_no.equals(""))		//Added for KDAH-CRF-0338 modified and exists
						sbMainSql.append(" AND i.bed_num = ? AND EXISTS (SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = g.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = g.order_line_num AND bed_no=i.bed_num )"); 
					
					if(!priority.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
						{
						// if Added, RBU-GHL-CRF-0047 starts
				    	if(isSite_ph_new_prescription){
				    	if(priority.equals("R"))
				    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
				    	else
				    		sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
				    	}else
				    	{
				    		sbMainSql.append(" AND a.priority = ? ");
				    	}
				    	// if Added, RBU-GHL-CRF-0047 ends
						}
					if(!patient_id.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" AND a.patient_id =? ");

					if(!add_criteria_practitioner_id.equals(""))
						sbMainSql.append(" and a.ord_pract_id = ? ");

					if(!this.getGender().equals(""))
						sbMainSql.append(" AND c.sex = ? ");

					if(!add_criteria_nat_code.equals(""))
						sbMainSql.append(" and c.nationality_code = ? ");
					if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						sbMainSql.append(" AND c.CONTACT2_NO=? ");
                    if(!getPatNationalID().equals(""))
						sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
						   
					
					sbMainSql.append(sbConstructSql.toString());
//System.err.println("==============Deliver without fill list sbMainSql="+sbMainSql);
					pstmt = connection.prepareStatement( sbMainSql.toString()) ;
					int position =1;
//System.err.println("==============Deliver wirhout fill list Values login_facility_id="+login_facility_id+" DispLocnCode="+getDispLocnCode()+" LanguageId="+getLanguageId()+" order_date_from="+order_date_from+" order_date_to="+order_date_to+" nursing_unit="+nursing_unit+" priority="+priority+" add_criteria_practitioner_id="+add_criteria_practitioner_id+" Gender="+getGender()+" add_criteria_nat_code="+add_criteria_nat_code+" orderingfacility="+orderingfacility+" sFreqDurnAbsOrderFlag="+sFreqDurnAbsOrderFlag+" exclude_PRN_orders="+exclude_PRN_orders+" drug_medical="+drug_medical );

					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
					pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
					pstmt.setString(++position,login_facility_id);// Removed trim() - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDispLocnCode());// Removed trim() - KAUH-SCF-0183[IN:047989]			
					//pstmt.setString(++position,getLanguageId()); //Commented GHL-SCF-0830 [IN:049943]
					
					if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
					    pstmt.setString(++position,getOrderID());
					
					/*if(getOrderType().equals("TA") || getOrderType().equals("TD")){	// Commented for [IN:051475]
						pstmt.setString(++position,getLanguageId());
					}*/

					pstmt.setString(++position,this.order_date_from); 
					pstmt.setString(++position,this.order_date_to); 
					
					if(!nursing_unit.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,nursing_unit);

					// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
					if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
					{
						pstmt.setString(++position,getFill_doc_num());
					}
					// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Ends
					
					if(!bed_no.equals(""))//Added for KDAH-CRF-0338
						pstmt.setString(++position,bed_no);

					if(!priority.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,priority);

					if(!patient_id.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,patient_id);

					if(!add_criteria_practitioner_id.equals(""))
						pstmt.setString(++position,add_criteria_practitioner_id);

					if(!this.getGender().equals(""))
						pstmt.setString(++position,this.getGender());

					if(!add_criteria_nat_code.equals(""))
						pstmt.setString(++position,add_criteria_nat_code);
					if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						pstmt.setString(++position,getPatMobileNo());
                    if(!getPatNationalID().equals(""))
						pstmt.setString(++position,getPatNationalID());//Adding end for TH-KW-CRF-0014

					if(getOrderType().equals("TA") || getOrderType().equals("TD")){
						pstmt.setString(++position,this.orderingfacility);
					}
					else{
						pstmt.setString(++position,this.orderingfacility);
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to include_absolute_orders for SRR20056-CRF-0663 -->sFreqDurnAbsOrderFlag
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
							pstmt.setString(++position,this.exclude_PRN_orders);					//added for SRR20056-CRF-0663
						}
						pstmt.setString(++position,this.exclude_PRN_orders);
						if(!(this.drug_medical.equals("")))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,login_facility_id);// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,login_by_id);// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022

					}
					if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,customTabBasedHrs);
					}
					pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
					pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
					if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){ //added for SKR-SCF-1606
							pstmt.setString(++position,this.order_date_from); 
							pstmt.setString(++position,this.order_date_to); 
					}
				}
				else{
					if(disp_stage.equals("V")){
						//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						String getDisp_locn_iae1="";
						if(getDisp_locn_iae().contains("@@@")){
						String name_getDisp_locn_iae[]=getDisp_locn_iae().split("@@@");
						for(String fechedname:name_getDisp_locn_iae)
						{
							getDisp_locn_iae1=getDisp_locn_iae1+fechedname+"','";
						}
						if (getDisp_locn_iae1 != null && getDisp_locn_iae1.length() >= 2) {
						getDisp_locn_iae1=getDisp_locn_iae1.substring(0, getDisp_locn_iae1.length() - 2);
						getDisp_locn_iae1=getDisp_locn_iae1.substring(2);
						}
						}else
						{
							getDisp_locn_iae1="'"+getDisp_locn_iae()+"'";
						}
						
						sbConstructSql = new StringBuffer(" and a.ORDERING_FACILITY_ID=? ");
						if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
							else
								sbConstructSql.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
						} //Added MMS-DM-CRF-0228 end
						else{
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
							else
								sbConstructSql.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");// code 'A.ORD_DATE_TIME' is replaced by B.START_DATE_TIME for Bru-HIMS-CRF-418[IN045564]
						}

						if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
							sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]

						if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND f.order_status_type ='50' ");
						}
						else if(ip_scope.equals("N")){
							sbConstructSql.append(" AND (f.order_status_type ='10' or (f.order_status_type ='25' and olph.NEXT_FILL_DATE is null)) ");//Modified for ML-BRU-SCF-1338[IN049193]
						}
						else if(ip_scope.equals("R")){
							sbConstructSql.append(" AND f.order_status_type ='56' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						// Verification Stage
						if(getCriteriaOrderType().equals("ALL")) {
							sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
						}
						else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
							sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
						} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
						else if(getOrderType().equals("NOR")) {
							sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
						}
						else if(getOrderType().equals("IVAD")) {
							sbConstructSql.append( " AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVAA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVWA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVID")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVIA")) {
							sbConstructSql.append( " AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("TD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
						}
						else if(getOrderType().equals("TA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
						}
						else if(getOrderType().equals("CD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
						}
						else if(getOrderType().equals("CA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
						}
						else if(getOrderType().equals("CO")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
						}
						sbConstructSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id) "); //added to filter only current Inpatient.

						if(!(getOrderType().equals("TA") || getOrderType().equals("TD"))){
							//Added for SRR20056-CRF-0663	--Start
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
								sbConstructSql.append(" and ( (j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N') and (( j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
							}
							else{
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
							}
							//Added for SRR20056-CRF-0663	--End
							if(!(this.drug_medical.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' ");
						}

						 //Added for PMG20089-CRF-0867 [IN029813] -start
						if( tab_based_group_sort_disp.equals("Y")  ){
							customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code ,  C.NATIONAL_ID_NO, /*g.nursing_unit_code*/a.source_code, g.bed_num,a.performing_deptloc_code "; // g.bed_num added for KDAH-CRF-0338 
							customSortBySql  = " ORDER BY nursing_unit "; //E.LONG_DESC
							if(customTabBased.equals("Y")){
								if(customTabBasedOption.equals("PAST"))
									sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
								else
									sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24)  ");// Added parameter - KAUH-SCF-0183[IN:047989]
							}
							if( !customGroupBy.equals("NURSING_UNIT")){
								if(!(customGroupBy.equals("NONE"))){
									customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO,  g.NURSING_UNIT_CODE, A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy'),to_char(a.ORD_DATE_TIME,'dd/mm/yyyy'),g.bed_num,/* g.nursing_unit_code */ a.source_code,a.performing_deptloc_code "; // g.bed_num added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060
										if(customGroupBy.equals("ORD_DATE_TIME"))
											customGroupBy = "to_date("+customGroupBy+" ,'dd/mm/yyyy')";
										else if (customGroupBy.equals("RELEASE_DATE_TIME"))
											customGroupBy = "trunc(to_date("+customGroupBy+" ,'dd/mm/yyyy hh24:mi'))";

										customSortBySql = " ORDER BY " +customGroupBy+" " + customGroupOrder ;
										if(customSortBy.equals("RELEASE_DATE_TIME"))
											customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
										customSortBySql = customSortBySql + ", "+customSortBy+" "+customSortOrder;
								}
								else{
										if(!(customSortBy.equals("NURSING_UNIT"))){
											if(customSortBy.equals("RELEASE_DATE_TIME"))
												customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
											customSortBySql = " ORDER BY "+customSortBy+" "+customSortOrder;
										}
										else
											customSortBySql = customSortBySql +" " +customSortOrder	;
								}
							}
							else  if (!(customSortBy.equals("") || customSortBy.equals("NONE") || customSortOrder.equals(""))){
								if(!(customGroupBy.equals("NURSING_UNIT"))){
									if(customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = "  ORDER BY "+customSortBy+" "+customSortOrder;
								}
								else{
									if(!customSortBy.equals("PATIENT_ID")){
										customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , ,C.NATIONAL_ID_NO, g.NURSING_UNIT_CODE , A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy),g.bed_num,a.source_code,a.performing_deptloc_code /*g.nursing_unit_code */ "; // g.bed_num Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
									}
									if(customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = customSortBySql+" "+customGroupOrder +", "+customSortBy+" "+customSortOrder;
								}
							}
							else{
								if(customGroupBy.equals("NURSING_UNIT"))
									customSortBySql = customSortBySql+" "+customGroupOrder ;
							}
							sbConstructSql.append(customGroupBySql);
							sbConstructSql.append(customSortBySql); 
						} //Added for PMG20089-CRF-0867 [IN029813] -End
						else{
							sbConstructSql.append(" and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,  g.NURSING_UNIT_CODE, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO, g.bed_num,/*G.NURSING_UNIT_CODE */ a.source_code,a.performing_deptloc_code "); //nursing_unit - E.LONG_DESC // g.bed_num Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060

							if(group_by_ord_locn.equals("N")){
								sbConstructSql.append(" order by min(a.ADDED_DATE)");
							}
							else{
								sbConstructSql.append(" order by nursing_unit, min(a.ADDED_DATE),A.PATIENT_ID");//nursing_unit - E.LONG_DESC
							}
						}
						if(getOrderType().equals("TA") || getOrderType().equals("TD")){
							if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){//patient_name-loc
								sbMainSql.append("SELECT  DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code/*g.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,  COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no ,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, G.BED_NUM,/*g.nursing_unit_code */ a.source_code FROM or_order_line b,or_order a,or_order_line_ph olph,mp_patient c, or_order_status_code f,  ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060 
							    if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND  a.source_code= ? ");//e.nursing_unit_code
							    if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
							    if(!priority.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	
							    	// if Added, RBU-GHL-CRF-0047 starts
							    	if(isSite_ph_new_prescription){
							    	if(priority.equals("R"))
							    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
							    	else
							    		sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
							    	}else
							    	{
							    		sbMainSql.append(" AND a.priority = ? ");
							    	}
							    	// if Added, RBU-GHL-CRF-0047 ends
							    }
							    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.patient_id = ? ");
							    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							    	sbMainSql.append(" AND a.order_id = ? ");
							    if(isSite_integration_em_bd_pyxis){
							    sbMainSql.append(" AND a.patient_class ='IP' AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' AND a.performing_deptloc_code in ( "+getDisp_locn_iae1+" )");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
							    }else{
							    sbMainSql.append(" AND a.patient_class ='IP' AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' AND a.performing_deptloc_code =? ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]	
							    }
							    if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.ord_pract_id = ? ");
							    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.sex = ? ");
							    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.nationality_code = ? ");
								if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							        sbMainSql.append(" AND c.CONTACT2_NO=? ");
								if(!getPatNationalID().equals(""))
						            sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							    //sbMainSql.append(" AND d.language_id(+) = ? AND e.language_id = ?"); //GHL-SCF-0830 [IN:049943]
								pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString());// Added - KAUH-SCF-0183[IN:047989]
							}
							else{//patient_name-loc
								sbMainSql.append("SELECT max(a.priority)priority , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*g.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,  COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no ,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,G.BED_NUM,/*g.nursing_unit_code */a.source_code FROM or_order_line b,or_order a, or_order_line_ph olph,mp_patient c,  or_order_status_code f, ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060
								if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.source_code = ? ");//a.source_code- e.nursing_unit_code
								if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
							    if(!priority.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	// if Added, RBU-GHL-CRF-0047 starts
							    	if(isSite_ph_new_prescription){
							    	if(priority.equals("R"))
							    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
							    	else
							    		sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
							    	}else
							    	{
							    		sbMainSql.append(" AND a.priority = ? ");
							    	}
							    	// if Added, RBU-GHL-CRF-0047 ends
							    }
							    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.patient_id = ? ");
							    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							    	sbMainSql.append(" AND a.order_id = ? "); 
							    if(isSite_integration_em_bd_pyxis){
								sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' AND a.performing_deptloc_code  in ( "+getDisp_locn_iae1+" ) ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
							    }else
							    {
							    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' AND a.performing_deptloc_code =? ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]	
							    }
								if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.ord_pract_id = ? ");
							    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.sex = ? ");
							    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.nationality_code = ? ");
								if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							        sbMainSql.append(" AND c.CONTACT2_NO=? ");
								if(!getPatNationalID().equals(""))
						            sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							    //sbMainSql.append(" AND d.language_id(+) = ? AND e.language_id = ?"); //GHL-SCF-0830 [IN:049943]
								
							    pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString());
							}
						}
						else if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){
							sbMainSql.append("SELECT  DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code/*g.NURSING_UNIT_CODE*/ and language_id = ?) nursing_unit,  nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ,to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,G.BED_NUM,/*g.nursing_unit_code */ a.source_code FROM or_order_line b,or_order a, or_order_line_ph olph, mp_patient c, or_order_status_code f, ph_drug j, ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num  AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.source_code = ? ");// a.source_code - e.nursing_unit_code
							if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
						    if(!priority.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	// if Added, RBU-GHL-CRF-0047 starts
						    	if(isSite_ph_new_prescription){
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0)) ");
						    	else
						    		sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND a.priority = ? ");
						    	}
						    	// if Added, RBU-GHL-CRF-0047 ends
						    }
						    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.patient_id = ? ");
						    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
						    	sbMainSql.append(" AND a.order_id = ? ");  
							//sbMainSql.append(" AND a.patient_class ='IP' AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						    //modified by Himanshu for MMS-DM-CRF-0232
						    if(isSite_integration_em_bd_pyxis){
						    if(getDisp_locn_iae().contains("@@@")){
						    	sbMainSql.append("AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'   AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' "); 
						    }else
						    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'  and a.performing_deptloc_code="+getDisp_locn_iae1+"  AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' ");
						    }else
						    {
						    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'   AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						    }
						    
						    if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.ord_pract_id = ? ");
						    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.sex = ? ");
						    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.nationality_code = ? ");
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" and j.drug_code =b.order_catalog_code ");
							pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString());// Added - KAUH-SCF-0183[IN:047989]
						}
						else{
							sbMainSql.append("SELECT  max(a.priority)priority , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = /*g.NURSING_UNIT_CODE */ a.source_code and language_id = ?) nursing_unit,  nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id, A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,G.BED_NUM,/*g.nursing_unit_code */ a.source_code FROM or_order_line b,or_order a,or_order_line_ph olph,mp_patient c, or_order_status_code f,ph_drug j, ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // i.nursing_unit_code added for BSP-SCF-0060
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.source_code = ? ");//a.source_code - e.nursing_unit_code
							if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS (SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
						    if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	{
						    	// if Added, RBU-GHL-CRF-0047 starts
						    	if(isSite_ph_new_prescription){
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND a.priority = ? ");
						    	}
						    	// if Added, RBU-GHL-CRF-0047 ends
						    	}
						    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.patient_id = ? ");
						    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
						    	sbMainSql.append(" AND a.order_id = ? "); 
						////commented by Himanshu for MMS-DM-CRF-0232
//						    if(getPhAltDispLocnYN().equals("Y"))//removed ph_disp_locn_appl_yn and added A.PERFORMING_DEPTLOC_CODE and added  for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP
//						    	sbMainSql.append(" AND a.patient_class ='IP' AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND A.PERFORMING_DEPTLOC_CODE=?  ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
//						    else
//						    	sbMainSql.append(" AND a.patient_class ='IP' AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' "); // Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						   if(isSite_integration_em_bd_pyxis){
						    if(getPhAltDispLocnYN().equals("Y")){////modified by Himanshu for MMS-DM-CRF-0232 Starts
						    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+")  ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						    } else if(getDisp_locn_iae().contains("@@@")){
						    	sbMainSql.append(" AND a.patient_class IN ('IP','DC')  AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'   AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' "); 
						    }else
						    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'  and a.performing_deptloc_code="+getDisp_locn_iae1+"  AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' ");
						   }else
						   {
							   if(getPhAltDispLocnYN().equals("Y"))//removed ph_disp_locn_appl_yn and added A.PERFORMING_DEPTLOC_CODE and added  for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP
							    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND A.PERFORMING_DEPTLOC_CODE=?  ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
							    else
							    	sbMainSql.append(" AND a.patient_class IN ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' "); // Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						   }////modified by Himanshu for MMS-DM-CRF-0232 ends
						    if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.ord_pract_id = ? ");
						    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.sex = ? ");
						    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.nationality_code = ? ");
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" and j.drug_code =b.order_catalog_code");
							pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString());// Added - KAUH-SCF-0183[IN:047989]
						}
//System.err.println("=============sbMainSql=======IP Verification========="+sbMainSql+sbConstructSql);
						int position = 0;
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
						pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
						pstmt.setString(++position,this.orderingfacility); //Added GHL-SCF-0830 [IN:049943]
						if(!nursing_unit.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,nursing_unit);
						if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							pstmt.setString(++position,bed_no);// Added for KDAH-CRF-0338 - End
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,priority);
						if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,patient_id);
						if(!getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
						    pstmt.setString(++position,getOrderID());
						
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]		
						
						//if condition added by Himanshu for MMS-DM-CRF-0232
						if(!isSite_integration_em_bd_pyxis){
							pstmt.setString(++position,getDispLocnCode());// Removed trim() - KAUH-SCF-0183[IN:047989]
						}
						
						if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,add_criteria_practitioner_id);
						if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.getGender());
						if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,add_criteria_nat_code);
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						    pstmt.setString(++position,getPatMobileNo());
						if(!getPatNationalID().equals(""))
						    pstmt.setString(++position,getPatNationalID());//Adding end for TH-KW-CRF-0014
						//pstmt.setString(++position,getLanguageId()); //Commented GHL-SCF-0830 [IN:049943]
						//pstmt.setString(++position,getLanguageId()); //Commented GHL-SCF-0830 [IN:049943]
						pstmt.setString(++position,this.orderingfacility);
						pstmt.setString(++position,this.order_date_from); 
						pstmt.setString(++position,this.order_date_to); 
						if(!(getOrderType().equals("TA") || getOrderType().equals("TD"))){
							pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to include_absolute_orders for SRR20056-CRF-0663 this.include_absolute_orders -->sFreqDurnAbsOrderFlag
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
								pstmt.setString(++position,this.exclude_PRN_orders);					//added for SRR20056-CRF-0663
							}
							pstmt.setString(++position,this.exclude_PRN_orders);
							if(!(this.drug_medical.equals("")))// if Added - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,this.drug_medical);
							pstmt.setString(++position,login_facility_id);// Added parameter - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,login_by_id);// Added parameter - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					        pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					        pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022

						}
						if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,customTabBasedHrs);
						}
						pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
						pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
					}
					else{
						sbConstructSql = new StringBuffer(" B.ORDER_LINE_STATUS = f.order_status_code AND b.order_category = 'PH' AND b.order_id = a.order_id AND b.order_id = h.order_id AND b.order_line_num = h.order_line_num AND ph_check_ord_date_dispensing ( b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						if(ip_scope.equals("N")) //SKR-SCF-1467
						str_last_disp = "AND olph.LAST_DISPENSED_DATE IS NULL";
						if(!this.order_date_from.equals("") && !this.order_date_to.equals("") ){
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(ip_scope.equals("R")){ //if block and else condition for ML-BRU-SCF-1147 [IN045177]
									if(getFilter_on_next_fill_date().equals("Y"))
										sbConstructSql.append(" AND H.NEXT_FILL_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
									else
										sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND H.LAST_DISPENSED_DATE IS NOT NULL"); //A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
								}
								else{ 
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
									else
										sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");// code 'A.ORD_DATE_TIME' is replaced by B.START_DATE_TIME for Bru-HIMS-CRF-418[IN045564]
								}
							
							}//Added MMS-DM-CRF-0228 end
							else{
								if(ip_scope.equals("R")){ //if block and else condition for ML-BRU-SCF-1147 [IN045177]
									if(getFilter_on_next_fill_date().equals("Y"))
										sbConstructSql.append(" AND H.NEXT_FILL_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
									else
										sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 AND H.LAST_DISPENSED_DATE IS NOT NULL"); //A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
								}
								else{ 
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
									else
										sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");// code 'A.ORD_DATE_TIME' is replaced by B.START_DATE_TIME for Bru-HIMS-CRF-418[IN045564]
								}
							}
						}
						if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
							sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]
						
						sbConstructSql.append(" and a.ORDERING_FACILITY_ID=? "); //Added for SKR-SCF-1614-Start
						
						if(getOrderType().equals("TA") || getOrderType().equals("TD") || getPhAltDispLocnYN().equals("Y")){ 
						sbConstructSql.append(" AND a.performing_deptloc_code = ? "); 
						}
						
						sbConstructSql.append(" AND a.patient_class IN ('IP','DC') "); //Added for SKR-SCF-1614-End

						if(getCriteriaOrderType().equals("ALL")) {
							sbConstructSql.append( " AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
						}
						else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
							sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
						} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
						else if(getOrderType().equals("NOR")) {
							sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
						} 
						else if(getOrderType().equals("IVAD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(getOrderType().equals("IVAA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(getOrderType().equals("IVWA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVID")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(getOrderType().equals("IVIA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("TD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
						} 
						else if(getOrderType().equals("TA")) {
							sbConstructSql.append( " AND A.IV_PREP_YN ='8' ");
						} 
						else if(getOrderType().equals("CD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
						} 
						else if(getOrderType().equals("CA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
						} 
						else if(getOrderType().equals("CO")) {
							sbConstructSql.append( " AND A.IV_PREP_YN = '6' ");
					}

					if(getIPVerificationYN().equals("Y")){
						
						if(ip_scope.equals("A")) {    // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
							sbConstructSql.append(" AND (F.ORDER_STATUS_TYPE ='50'");
							if(getCriteriaOrderType().equals("ALL")){
								sbConstructSql.append( " OR ( ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y'and F.ORDER_STATUS_TYPE in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and F.ORDER_STATUS_TYPE in ('30','94'))) AND H.LAST_DISPENSED_DATE IS NULL) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								sbConstructSql.append(" OR ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') and F.ORDER_STATUS_TYPE in ('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and F.ORDER_STATUS_TYPE in ('25','56','94')))) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}
							else if(getCriteriaOrderType().equals("CDR") ){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbConstructSql.append( " OR ( ( (a.iv_prep_yn='0' and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y'and F.ORDER_STATUS_TYPE in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and F.ORDER_STATUS_TYPE in ('30','94'))) AND H.LAST_DISPENSED_DATE IS NULL) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								sbConstructSql.append(" OR ( (a.iv_prep_yn='0' and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') and F.ORDER_STATUS_TYPE in ('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and F.ORDER_STATUS_TYPE in ('25','56','94')))) ");//and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA") ||(getOrderType().equals("TD") && siteTpn)) {//added for ml-mmoh-crf-0468
									sbConstructSql.append( " OR NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' AND F.ORDER_STATUS_TYPE IN('30','35') AND H.LAST_DISPENSED_DATE IS NULL "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
									sbConstructSql.append(" OR DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('25','56','35') )"); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								}
								else{
									sbConstructSql.append(" OR F.ORDER_STATUS_TYPE IN('30','94') AND H.LAST_DISPENSED_DATE IS NULL ");
									sbConstructSql.append(" OR F.ORDER_STATUS_TYPE IN('25','56','94') )");
								}
							}							
						} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
						else if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND F.ORDER_STATUS_TYPE ='50'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(ip_scope.equals("N")){
							if(getCriteriaOrderType().equals("ALL")){
								sbConstructSql.append( " AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y'and F.ORDER_STATUS_TYPE in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and F.ORDER_STATUS_TYPE in ('30','94'))) AND H.LAST_DISPENSED_DATE IS NULL ");// Removed join ph_worksheet_hdr for ML-BRU-Performance issue //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}
							else if(getCriteriaOrderType().equals("CDR") ){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbConstructSql.append( " AND ( (a.iv_prep_yn='0' and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y'and F.ORDER_STATUS_TYPE in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and F.ORDER_STATUS_TYPE in ('30','94'))) AND H.LAST_DISPENSED_DATE IS NULL "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA") || (getOrderType().equals("TD") && siteTpn)) { //added for ml-mmoh-crf-0468
									sbConstructSql.append( " AND NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' AND F.ORDER_STATUS_TYPE IN('30','35') AND H.LAST_DISPENSED_DATE IS NULL ");//Removed join with ph_worksheet_hdr for ML-BRU-Performance issue //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								}
								else{
									sbConstructSql.append(" AND F.ORDER_STATUS_TYPE IN('30','94') AND H.LAST_DISPENSED_DATE IS NULL ");
								}
							}
						}
						else {
							if(getCriteriaOrderType().equals("ALL")){
								sbConstructSql.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(f.order_status_type,'56','Y','35','N','62','Y') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') and F.ORDER_STATUS_TYPE in ('56','35','62') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and F.ORDER_STATUS_TYPE in ('25','56','94','62'))) ");//AND H.LAST_DISPENSED_DATE IS NOT NULL "); Commented for ML-BRU-Performance issue//Added 25 for ML-BRU-SCF-1338[IN049193]//,'62','Y' added for MMS-KH-CRF-0014 //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbConstructSql.append(" AND ( (a.iv_prep_yn='0' and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') and F.ORDER_STATUS_TYPE in ('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and F.ORDER_STATUS_TYPE in ('25','56','94'))) ");//and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA") || (getOrderType().equals("TD") && siteTpn)) {//added ml-mmoh-crf-0468
									sbConstructSql.append(" AND DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('25','56','35') ");//AND H.LAST_DISPENSED_DATE IS NOT NULL "); Commented for ML-BRU-Performance issue//Added 25 for ML-BRU-SCF-1338[IN049193] //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								}
								else{
									sbConstructSql.append(" AND F.ORDER_STATUS_TYPE IN('25','56','94') ");//AND H.LAST_DISPENSED_DATE IS NOT NULL "); Commented for ML-BRU-Performance issue//Added 25 for ML-BRU-SCF-1338[IN049193]
								}
							}
						}
					}
					else{
						if(ip_scope.equals("A")) {  // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
							sbConstructSql.append(" AND (F.ORDER_STATUS_TYPE ='50' ");
							if(getCriteriaOrderType().equals("ALL")){
								sbConstructSql.append(" OR ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' and F.ORDER_STATUS_TYPE in ('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and F.ORDER_STATUS_TYPE in ('10','25','94','30'))) AND H.LAST_DISPENSED_DATE IS NULL "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								sbConstructSql.append( " OR ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and f.ORDER_status_TYPE in ('25','56','94')))) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbConstructSql.append(" OR ( (a.iv_prep_yn='0' and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' and F.ORDER_STATUS_TYPE in ('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and F.ORDER_STATUS_TYPE in ('10','25','94','30'))) AND H.LAST_DISPENSED_DATE IS NULL "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								sbConstructSql.append( " OR ( (a.iv_prep_yn='0' and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and f.ORDER_status_TYPE in ('25','56','94')))) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}  // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA") || (getOrderType().equals("TD") && siteTpn )) {//added for ml-mmoh-crf-0468
									sbConstructSql.append(" OR F.ORDER_STATUS_TYPE IN('10','35')AND NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' AND H.LAST_DISPENSED_DATE IS NULL "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
									sbConstructSql.append(" OR DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('25','56','35')) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								} 
								else {
									sbConstructSql.append(" OR F.ORDER_STATUS_TYPE IN('10','25','94')AND H.LAST_DISPENSED_DATE IS NULL ");
									sbConstructSql.append(" OR F.ORDER_STATUS_TYPE IN('25','56','94') )");
								}
							}														
						} 	// if condition Added for ML-MMOH-CRF-0434 [IN057356] - End				
						else if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND F.ORDER_STATUS_TYPE ='50' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(ip_scope.equals("N")){
							if(getCriteriaOrderType().equals("ALL")){
								sbConstructSql.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' and F.ORDER_STATUS_TYPE in ('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and F.ORDER_STATUS_TYPE in ('10','25','94','30'))) AND H.LAST_DISPENSED_DATE IS NULL ");//Added 30 for ML-BRU-SCF-1325//Added 25 for ML-BRU-SCF-1338[IN049193] //Removed join ph_worksheet_hdr for ML-BRU-Performance issue //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}
							else if(getCriteriaOrderType().equals("CDR") ){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbConstructSql.append(" AND ( (a.iv_prep_yn='0' and NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' and F.ORDER_STATUS_TYPE in ('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and F.ORDER_STATUS_TYPE in ('10','25','94','30'))) AND H.LAST_DISPENSED_DATE IS NULL ");//and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA") || (getOrderType().equals("TD") && siteTpn )) {//added for ml-mmoh-crf-0468
									sbConstructSql.append(" AND F.ORDER_STATUS_TYPE IN('10','35')AND NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') != 'Y' AND H.LAST_DISPENSED_DATE IS NULL ");// Removed join with ph_worksheet_hdr for ML-BRU-Performance issue //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								} 
								else {
									sbConstructSql.append(" AND F.ORDER_STATUS_TYPE IN('10','25','94')AND H.LAST_DISPENSED_DATE IS NULL ");//Added 25 for ML-BRU-SCF-1338[IN049193]
								}
							}
						} 
						else { 

							if(getCriteriaOrderType().equals("ALL")){
								sbConstructSql.append( " AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and f.ORDER_status_TYPE in ('25','56','94'))) ");//AND H.LAST_DISPENSED_DATE IS NOT NULL ");//Added 25 for ML-BRU-SCF-1338[IN049193]// Removed join ph_worksheet_hdr for ML-BRU-Performance issue //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbConstructSql.append( " AND ( (a.iv_prep_yn='0' and DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and f.ORDER_status_TYPE in ('25','56','94'))) "); //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
								
									sbConstructSql.append(" AND DECODE(f.order_status_type,'56','Y','35','N') = NVL((select finalized_yn from ph_worksheet_hdr where order_id = a.order_id and rownum =1),'X') AND F.ORDER_STATUS_TYPE IN('25','56','35') ");//AND H.LAST_DISPENSED_DATE IS NOT NULL");//Added 25 for ML-BRU-SCF-1338[IN049193]// Removed join ph_worksheet_hdr for ML-BRU-Performance issue //and rownum =1 added for aviod multiplerows MOHE-SCF-0272
								}
								else{
									sbConstructSql.append(" AND F.ORDER_STATUS_TYPE IN('25','56','94') ");//AND H.LAST_DISPENSED_DATE IS NOT NULL "); Commented for ML-BRU-Performance issue//Added 25 for ML-BRU-SCF-1338[IN049193]
								}
							}
						}
					}
						if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")||getOrderType().equals("CA")|| getCriteriaOrderType().equals("ALL") || getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){//Added for SRR20056-CRF-0663	--Start
									sbConstructSql.append(" and ((j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N' ) and ((j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = n.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
								}
								else{
									sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = n.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}//Added for SRR20056-CRF-0663	--End
							}
						}
						else{
							if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){//Added for SRR20056-CRF-0663	--Start
									sbConstructSql.append(" and ((j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N') and ( (j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = n.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
								}
								else{
									sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = n.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = n.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}//Added for SRR20056-CRF-0663	--End
							}
						}
						if(!(this.drug_medical.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(" AND J.DRUG_YN = ? ");
						sbMainSql = new StringBuffer();
						
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Himanshu Saxena Changes isSite_ph_new_prescription
						if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
							if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT") &&  !customGroupBy.equals("NONE") && !customGroupBy.equals("PRESCRIPTION_NUMBER")){
								// Added condition order_id for JD-CRF-0181 [IN:40699]  PhRepository.getPhKeyValue("SQL_PH_DISP_IP_MEDICATION_SELECT22A_TAB_BASED"), SQL_PH_DISP_IP_MEDICATION_SELECT2A_TAB_BASED
								sbMainSql.append("SELECT DECODE(PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY, patient_id, COUNT (DISTINCT order_id) orders, TO_CHAR (MIN (ADDED_DATE), 'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, GET_AGE(date_of_birth) age, SEX, nationality_code country_code, (SELECT national_id_no FROM MP_PATIENT B WHERE B.PATIENT_ID = C.PATIENT_ID) national_id_no, NURSING_UNIT, ORD_DATE_TIME ,BED_NUM, min(nvl(print_value,0))min_value, max(nvl(print_value,0))max_value,source_code ");
								// if conditions added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
									sbMainSql.append(",prescription_Number ");
								}
								sbMainSql.append(" FROM (SELECT a.priority, a.patient_id, a.order_id, a.ADDED_DATE, a.ordering_facility_id, a.PATIENT_CLASS, SEX, EPISODE_ID, a.ENCOUNTER_ID, date_of_birth, nationality_code, NVL ( DECODE (?, 'en', l.patient_name, l.PATIENT_NAME_LOC_LANG), l.patient_name) patient_name, (SELECT long_desc FROM mp_country_lang_vw WHERE language_id = ? AND country_code = l.nationality_code "); // bed_num Added for KDAH-CRF-0338 // nursing_unit_code Added for BSP-SCF-0060
								//,min(nvl(olph.print_value,0))min_value,max(nvl(olph.print_value,0))max_value added for GHL-CRF-0453
							/*	if(!this.getGender().equals(""))commented here and added down for ARYU-SCF-0073
									sbMainSql.append(" AND c.sex = ? ");
								if(!add_criteria_nat_code.equals(""))
									sbMainSql.append(" and l.nationality_code = ? ");commented till here for ARYU-SCF-0073 */
								sbMainSql.append(") nationality_desc,");
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
								sbMainSql.append("a.trn_group_ref prescription_Number,");
								}
								sbMainSql.append(" (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = g.facility_id AND nursing_unit_code = a.source_code /*g.nursing_unit_code */ AND language_id = ?) NURSING_UNIT, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME,g.bed_num,olph.print_value,/*g.nursing_unit_code */ a.source_code FROM OR_ORDER A, ip_open_encounter g, PH_DRUG J, or_order_line n, mp_patient l,or_order_line_ph olph WHERE EXISTS (SELECT 1 FROM or_order_line b, or_order_status_code f, OR_ORDER_LINE_PH H WHERE "); // g.bed_num Added for KDAH-CRF-0338 and ,or_order_line_ph olph added for GHL-CRF-0453 // g.nursing_unit_code Added for BSP-SCF-0060
								//,print_value added for GHL-CRF-453
							}
							else{
								//SQL_PH_DISP_IP_MEDICATION_SELECT2A , SQL_PH_DISP_IP_MEDICATION_SELECT22A
								sbMainSql.append("SELECT MAX (priority) priority, patient_id, COUNT (DISTINCT order_id) orders, TO_CHAR (MIN (ADDED_DATE), 'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, GET_AGE(date_of_birth) age, SEX, nationality_code country_code, (SELECT national_id_no FROM MP_PATIENT B WHERE B.PATIENT_ID = C.PATIENT_ID) national_id_no, NURSING_UNIT,BED_NUM,min(nvl(print_value,0))min_value,max(nvl(print_value,0))max_value,source_code ");
								// if conditions added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
									sbMainSql.append(",prescription_Number ");
								}
								sbMainSql.append(" FROM (SELECT a.priority, a.patient_id, a.order_id, a.ADDED_DATE, a.ordering_facility_id, a.PATIENT_CLASS, SEX, EPISODE_ID, a.ENCOUNTER_ID, date_of_birth, nationality_code, NVL ( DECODE (?, 'en', l.patient_name, l.PATIENT_NAME_LOC_LANG), l.patient_name) patient_name, (SELECT long_desc FROM mp_country_lang_vw WHERE language_id = ? AND country_code = l.nationality_code "); // BED_NUM Added for KDAH-CRF-0338 // NURSING_UNIT_CODE added for BSP-SCF-0060
								//,min(nvl(olph.print_value,0))min_value,max(nvl(olph.print_value,0))max_value added for GHL-CRF-453
								/*if(!this.getGender().equals(""))commented here and added down for ARYU-SCF-0073
									sbMainSql.append(" AND c.sex = ? ");
								if(!add_criteria_nat_code.equals(""))
									sbMainSql.append(" and l.nationality_code = ? ");commented till here for ARYU-SCF-0073*/
								sbMainSql.append(") nationality_desc,");
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
								sbMainSql.append("a.trn_group_ref prescription_Number,");
								}
								sbMainSql.append(" (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = g.facility_id AND nursing_unit_code = a.source_code /*g.nursing_unit_code */ AND language_id = ?) NURSING_UNIT,g.bed_num,olph.print_value,/*g.nursing_unit_code */ a.source_code FROM OR_ORDER A, ip_open_encounter g, PH_DRUG J, or_order_line n, mp_patient l,or_order_line_ph olph WHERE EXISTS (SELECT 1 FROM or_order_line b, or_order_status_code f, OR_ORDER_LINE_PH H WHERE "); // g.bed_num Added for KDAH-CRF-0338 and ,or_order_line_ph olph added for GHL-CRF-453 // g.nursing_unit_code Added for BSP-SCF-0060
								//,min(nvl(olph.print_value,0))min_value,max(nvl(olph.print_value,0))max_value added for GHL-CRF-453
							}
							sbConstructSql.append(" AND ph_get_user_disp_rights(?,?, A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' ) ");
							sbMainSql.append(sbConstructSql.toString());
							if(getPhAltDispLocnYN().equals("Y"))
								sbMainSql.append(" AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id AND a.order_id = n.order_id  and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num "+str_last_disp+" /*AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num */ AND j.drug_code = n.order_catalog_code AND a.patient_id = l.patient_id  ");//removed ph_disp_locn_appl_yn for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP and //AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num added for GHL-CRF-453 and commeted for SKR-SCF-1467 and added and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num AND olph.LAST_DISPENSED_DATE IS NULL

							else
								sbMainSql.append(" AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id AND a.order_id = n.order_id and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num "+str_last_disp+" /*AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num */ AND j.drug_code = n.order_catalog_code AND a.patient_id = l.patient_id AND ph_disp_locn_appl_yn ( a.orig_performing_deptloc_code, ?, a.source_type, a.source_code, a.added_facility_id, a.performing_facility_id, a.performing_deptloc_code, j.drug_class, j.drug_code, n.order_type_code, a.patient_class, a.priority, a.discharge_ind, (CASE WHEN j.drug_yn = 'Y' THEN 'D' ELSE 'M' END), a.iv_prep_yn, a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' ");//else condition for ML-MMOH-SCF-0330.1[IN058994] site specific due to alternat disp locn should come in performing disp locn after verification for IP//AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num added for GHL-CRF-453 and commented for SKR-SCF-1467 and added and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num AND olph.LAST_DISPENSED_DATE IS NULL

						}
						else {
							if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT") &&  !customGroupBy.equals("NONE") && !customGroupBy.equals("PRESCRIPTION_NUMBER")){
								sbMainSql.append("SELECT DECODE(PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY, patient_id, COUNT (DISTINCT order_id) orders, TO_CHAR (MIN (ADDED_DATE), 'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, GET_AGE(date_of_birth) age, SEX, nationality_code country_code, (SELECT national_id_no FROM MP_PATIENT B WHERE B.PATIENT_ID = C.PATIENT_ID) national_id_no, NURSING_UNIT, ORD_DATE_TIME,BED_NUM, min(nvl(print_value,0))min_value, max(nvl(print_value,0))max_value,/*NURSING_UNIT_CODE */ SOURCE_CODE " );
									// if conditions added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
									sbMainSql.append(",prescription_Number ");
								}
								sbMainSql.append(" FROM (SELECT a.priority, a.patient_id, a.order_id, a.ADDED_DATE, a.ordering_facility_id, a.PATIENT_CLASS, SEX, EPISODE_ID, a.ENCOUNTER_ID, date_of_birth, nationality_code, NVL ( DECODE (?, 'en', l.patient_name, l.PATIENT_NAME_LOC_LANG), l.patient_name) patient_name, (SELECT long_desc FROM mp_country_lang_vw WHERE language_id = ? AND country_code = l.nationality_code "); // BED_NUM Added for KDAH-CRF-0338 // NURSING_UNIT_CODE Added for BSP-SCF-0060
								//,min(nvl(print_value,0))min_value,max(nvl(print_value,0))max_value added for GHL-CRF-0453
								/*if(!this.getGender().equals("")) commented here and added down for ARYU-SCF-0073
									sbMainSql.append(" AND c.sex = ? ");
								if(!add_criteria_nat_code.equals(""))
									sbMainSql.append(" and l.nationality_code = ? ");commented till here for ARYU-SCF-0073*/
								sbMainSql.append(") nationality_desc,");
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
								sbMainSql.append("a.trn_group_ref prescription_Number, ");
								}
								sbMainSql.append(" (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = g.facility_id AND nursing_unit_code = a.source_code /*g.nursing_unit_code */ AND language_id = ?) NURSING_UNIT, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME,g.bed_num,olph.print_value,/*g.nursing_unit_code */ a.SOURCE_CODE FROM OR_ORDER A, ip_open_encounter g, or_order_line n, mp_patient l,or_order_line olph WHERE l.patient_id = a.patient_id and a.order_id = n.order_id and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num "+str_last_disp+" /*AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num */ and g.patient_id = l.patient_id and g.ENCOUNTER_ID = a.ENCOUNTER_ID and g.FACILITY_ID = a.ORDERING_FACILITY_ID and EXISTS (SELECT 1 FROM or_order_line b, or_order_status_code f, OR_ORDER_LINE_PH H WHERE "); // g.bed_num Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
								//print_value added for GHL-CRF-453
								//AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num and commented for SKR-SCF-1467 and added and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num AND olph.LAST_DISPENSED_DATE IS NULL

								sbMainSql.append(sbConstructSql.toString());
								sbMainSql.append(" AND NVL((select finalized_yn from ph_tpn_worksheet_hdr where order_id = a.order_id),'X')  != 'Y' )");//Removed join ph_tpn_worksheet_hdr for ML-BRU-Performance issue
							}
							else{
								sbMainSql.append("SELECT MAX (priority) priority, patient_id, COUNT (DISTINCT order_id) orders, TO_CHAR (MIN (ADDED_DATE), 'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, GET_AGE(date_of_birth) age, SEX, nationality_code country_code, (SELECT national_id_no FROM MP_PATIENT B WHERE B.PATIENT_ID = C.PATIENT_ID) national_id_no, NURSING_UNIT,BED_NUM, min(nvl(print_value,0))min_value,max(nvl(print_value,0))max_value,/*NURSING_UNIT_CODE */ SOURCE_CODE ");
								// if conditions added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
									sbMainSql.append(",prescription_Number ");
								}
								sbMainSql.append(" FROM (SELECT a.priority, a.patient_id, a.order_id, a.ADDED_DATE, a.ordering_facility_id, a.PATIENT_CLASS, SEX, EPISODE_ID, a.ENCOUNTER_ID, date_of_birth, nationality_code, NVL ( DECODE (?, 'en', l.patient_name, l.PATIENT_NAME_LOC_LANG), l.patient_name) patient_name, (SELECT long_desc FROM mp_country_lang_vw WHERE language_id = ? AND country_code = l.nationality_code "); // BED_NUM Added for KDAH-CRF-0338 // NURSING_UNIT_CODE Added for BSP-SCF-0060
								//,min(nvl(print_value,0))min_value,max(nvl(print_value,0))max_value added for GHL-CRF-453
							/*	if(!this.getGender().equals("")) commented here and added down for ARYU-SCF-0073
									sbMainSql.append(" AND c.sex = ? ");
								if(!add_criteria_nat_code.equals(""))
									sbMainSql.append(" and l.nationality_code = ? ");commenting end for ARYU-SCF-0073*/

								sbMainSql.append(") nationality_desc,");
								if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
								sbMainSql.append("a.trn_group_ref prescription_Number, ");
								}
								sbMainSql.append(" (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = g.facility_id AND nursing_unit_code = g.nursing_unit_code AND language_id = ?) NURSING_UNIT,g.bed_num,olph.print_value,/*g.nursing_unit_code */ a.SOURCE_CODE FROM OR_ORDER A, ip_open_encounter g, or_order_line n, mp_patient l,or_order_line_ph olph WHERE l.patient_id = a.patient_id and a.order_id = n.order_id  and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num "+str_last_disp+" /*AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num */ and  g.patient_id = l.patient_id and g.ENCOUNTER_ID = a.ENCOUNTER_ID and g.FACILITY_ID = a.ORDERING_FACILITY_ID and EXISTS (SELECT 1 FROM or_order_line b, or_order_status_code f, OR_ORDER_LINE_PH H WHERE "); // g.bed_num Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
								//,print_value added for GHL-CRF-453
								//AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num added for CRF-453 and commented and added for SKR-SCF-1467 and a.patient_id=g.patient_id AND a.order_id = n.order_id AND olph.order_id = n.order_id AND olph.order_line_num = n.order_line_num AND olph.LAST_DISPENSED_DATE IS NULL
								///*AND a.order_id = olph.order_id  AND olph.order_id = n.order_id AND n.order_line_num = olph.order_line_num */ commented for SKR-SCF-1512

								sbMainSql.append(sbConstructSql.toString());
								//sbMainSql.append(" AND  NVL((select finalized_yn from ph_tpn_worksheet_hdr where order_id = a.order_id),'X')  != 'Y') ");
								sbMainSql.append(" AND( NVL ((SELECT finalized_yn FROM ph_tpn_worksheet_hdr WHERE order_id = a.order_id), 'X') != 'Y' OR ((SELECT QTY_VOLUME FROM ph_tpn_worksheet_hdr WHERE order_id = a.order_id )< h.BMS_QTY)))");
							}
						}
						if(!priority.trim().equals(""))
						{
					    	// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
					    	}
						if(!patient_id.trim().equals(""))
							sbMainSql.append(" AND a.patient_id =? ");
						if(!add_criteria_practitioner_id.equals(""))
							sbMainSql.append(" and a.ord_pract_id = ? ");
						if(!nursing_unit.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND a.source_code = ? ");
						if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
					    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE orig_order_id = n.order_id AND orig_order_id = a.order_id AND orig_order_line_no = n.order_line_num AND bed_no=g.bed_num )");// Added for KDAH-CRF-0338 - End
					
						// <!-- //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Started -->
						if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && !getPrescription_number().equals("") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
						{
							sbMainSql.append(" AND a.trn_group_ref = ? ");
						}
						if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
						{
						sbMainSql.append("AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N')");
						}
						// <!-- //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Ends -->
						
						if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							sbMainSql.append(" AND a.order_id = ? ");
						if(!this.getGender().equals("")) //Adding start for ARYU-SCF-0073
							sbMainSql.append(" AND l.sex = ? ");
						if(!add_criteria_nat_code.equals(""))
							sbMainSql.append(" and l.nationality_code = ? ");//Adding end for ARYU-SCF-0073
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							sbMainSql.append(" AND l.CONTACT2_NO=? ");
						if(!getPatNationalID().equals(""))
						    sbMainSql.append(" AND l.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
						if( tab_based_group_sort_disp.equals("Y")){ //Added for PMG20089-CRF-0867 [IN029813] -start
							customGroupBySql = " GROUP BY patient_id, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, SEX, nationality_code, date_of_birth , NURSING_UNIT,bed_num,SOURCE_CODE"; // nursing_unit_code Added for BSP-SCF-0060
							if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
								customGroupBySql =customGroupBySql+",prescription_Number ";
							}
							customSortBySql  = " ORDER BY nursing_unit";
							if(customTabBased.equals("Y")){
								if(customTabBasedOption.equals("PAST"))
									sbMainSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");
								else
									sbMainSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24)  ");
							}
							if( !customGroupBy.equals("NURSING_UNIT")){
								if(  !customGroupBy.equals("NONE")){
								customGroupBySql = " GROUP BY patient_id, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, SEX, nationality_code, date_of_birth , NURSING_UNIT ";//, C.NATIONAL_ID_NO, a.source_code, g.NURSING_UNIT_CODE, A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy'),to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') // BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
									if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
										customGroupBySql =customGroupBySql+",prescription_Number ,BED_NUM,/*NURSING_UNIT_CODE */ SOURCE_CODE";
									}else{
									customGroupBySql =customGroupBySql+", PRIORITY, ORD_DATE_TIME,BED_NUM,/*NURSING_UNIT_CODE */ SOURCE_CODE  ";
									}
								}
								if(!(customGroupBy.equals("NONE")) && !customGroupBy.equals("PRESCRIPTION_NUMBER")){
									
									if(customGroupBy.equals("ORD_DATE_TIME"))
										customGroupBy = " to_date("+customGroupBy+" ,'dd/mm/yyyy')";
									else if (customGroupBy.equals("RELEASE_DATE_TIME"))
										customGroupBy = " trunc(to_date("+customGroupBy+" ,'dd/mm/yyyy hh24:mi'))";
									customSortBySql = " ORDER BY " +customGroupBy+" " + customGroupOrder ;
									if (customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = " to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = customSortBySql + ", "+customSortBy+" "+customSortOrder;
								}
								else{
									if(!(customSortBy.equals("NURSING_UNIT"))){
										if (customSortBy.equals("RELEASE_DATE_TIME"))
											customSortBy = " to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
										customSortBySql = " ORDER BY "+customSortBy+" "+customSortOrder;
									}
									else
										customSortBySql = customSortBySql +" " +customSortOrder	;
								}
							}
							else  if (!(customSortBy.equals("") || customSortBy.equals("NONE") || customSortOrder.equals(""))){
								if(!(customGroupBy.equals("NURSING_UNIT"))){
									if (customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = " to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = " ORDER BY "+customSortBy+" "+customSortOrder;
								}
								else{
									if(!customSortBy.equals("PATIENT_ID")){
										customGroupBySql = " GROUP BY patient_id, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, SEX, nationality_code, date_of_birth , NURSING_UNIT, PRIORITY, ORD_DATE_TIME,BED_NUM,/*NURSING_UNIT_CODE*/ SOURCE_CODE ";//,C.NATIONAL_ID_NO, a.source_code, g.NURSING_UNIT_CODE, A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy), // BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
										if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
											customGroupBySql =customGroupBySql+",prescription_Number ";
										}
									}
									if (customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = customSortBySql+" "+customGroupOrder +", "+customSortBy+" "+customSortOrder;
								}
							}
							else{
								if(customGroupBy.equals("NURSING_UNIT"))
									customSortBySql = customSortBySql+" "+customGroupOrder ;
							}
							orderDateSql = "";
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									orderDateSql = "AND n.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi' ) "; //added for SKR-SCF-1606
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									orderDateSql = "AND n.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999 "; //added for SKR-SCF-1606
							}
							sbMainSql.append(" and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?)"+orderDateSql+ ") C ");
							

							sbMainSql.append(customGroupBySql);
							sbMainSql.append(customSortBySql); 
						} //Added for PMG20089-CRF-0867 [IN029813] -End	 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, g.nursing_unit_code ,A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO
						else{
							orderDateSql = "";
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									orderDateSql = "AND n.start_date_time BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND   TO_DATE (?,'dd/mm/yyyy hh24:mi' ) "; //added for SKR-SCF-1606
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!this.order_date_from.equals("") && !this.order_date_to.equals("") )
									orderDateSql = "AND n.start_date_time BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND   TO_DATE (?,'DD/MM/YYYY' )+ 0.99999 "; //added for SKR-SCF-1606
							}
							sbMainSql.append(" and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?)"+orderDateSql+") C ");
							

							sbMainSql.append( " GROUP BY patient_id, ordering_facility_id, PATIENT_CLASS, EPISODE_ID, ENCOUNTER_ID, nationality_desc, patient_name, SEX, nationality_code, date_of_birth , nursing_unit,bed_num,/*NURSING_UNIT_CODE */SOURCE_CODE "); // BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
							if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER")){
								sbMainSql.append(" ,prescription_Number ");
							}
							if(group_by_ord_locn.equals("N"))
								sbMainSql.append( " ORDER BY TO_DATE (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ASC ");
							else
								sbMainSql.append(" order by nursing_unit, TO_DATE (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi'), PATIENT_ID");
						}
//System.err.println("================fill without fill list==sbMainSql====="+sbMainSql);
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					//if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")||getOrderType().equals("CA")|| getCriteriaOrderType().equals("ALL")){
						int position=1;
						pstmt.setString(position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						/*if(!this.getGender().equals("")) commented here and added down for ARYU-SCF-0073
							pstmt.setString(++position,getGender());
						if(!add_criteria_nat_code.equals(""))
							pstmt.setString(++position,add_criteria_nat_code); commented till here for ARYU-SCF-0073*/
						pstmt.setString(++position,this.orderingfacility); 
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
							pstmt.setString(++position,this.order_date_from); 
							pstmt.setString(++position,this.order_date_to); 
						}
						pstmt.setString(++position,this.orderingfacility); 
						
						if(getOrderType().equals("TA") || getOrderType().equals("TD") || getPhAltDispLocnYN().equals("Y")){ //Added for SKR-SCF-1614
						pstmt.setString(++position,getDispLocnCode()); 
						}
						
						if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
							pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663 
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
								pstmt.setString(++position,this.exclude_PRN_orders);//added for SRR20056-CRF-0663
							}
							pstmt.setString(++position,this.exclude_PRN_orders);
							if(!(this.drug_medical.equals("")))
								pstmt.setString(++position,this.drug_medical);
						}
						if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
							pstmt.setString(++position,login_facility_id);
							pstmt.setString(++position,login_by_id);
							pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					        pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					        pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022

							if(!getPhAltDispLocnYN().equals("Y"))
								pstmt.setString(++position,getDispLocnCode());//removed ph_disp_locn_appl_yn for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP
						}
						if(!priority.equals(""))
							pstmt.setString(++position,priority);
						if(!patient_id.equals(""))
							pstmt.setString(++position,patient_id);
						if(!add_criteria_practitioner_id.equals(""))
							pstmt.setString(++position,add_criteria_practitioner_id);
						if(!nursing_unit.equals(""))
							pstmt.setString(++position,nursing_unit);
						if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							pstmt.setString(++position,bed_no);// Added for KDAH-CRF-0338 - End
						if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && !getPrescription_number().equals(""))
						{
							pstmt.setString(++position,getPrescription_number());
						}
						if(!getOrderID().equals(""))
						    pstmt.setString(++position,getOrderID());
						if(!this.getGender().equals(""))// Adding start for ARYU-SCF-0073
							pstmt.setString(++position,getGender());
						if(!add_criteria_nat_code.equals(""))
							pstmt.setString(++position,add_criteria_nat_code); //Addign end for ARYU-SCF-0073
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						    pstmt.setString(++position,getPatMobileNo());
						if(!getPatNationalID().equals(""))
						    pstmt.setString(++position,getPatNationalID());//Adding end for TH-KW-CRF-0014
							
						if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,customTabBasedHrs);
						}
						pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
						pstmt.setString(++position,login_facility_id);		//Added parameter for MOD Performance tuning 
						if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){ //added for SKR-SCF-1606
							pstmt.setString(++position,this.order_date_from); 
							pstmt.setString(++position,this.order_date_to); 
						}
					/*}
					else{
						int position =1;
							pstmt.setString(position,getLanguageId());
							pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
							pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
							if(!nursing_unit.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,nursing_unit);
							if(!priority.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,priority);
							if(!patient_id.equals(""))// Removed trim() - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,patient_id);
							if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							    pstmt.setString(++position,getOrderID());
							pstmt.setString(++position,login_facility_id);// Removed trim() - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.orderingfacility);//Added parameter for ML-BRU-Performance issue
							pstmt.setString(++position,getDispLocnCode());// Removed trim() - KAUH-SCF-0183[IN:047989]
							if(!add_criteria_practitioner_id.equals(""))//Added for KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,add_criteria_practitioner_id);
							if(!this.getGender().equals(""))//Added for KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,this.getGender());
							if(!add_criteria_nat_code.equals(""))//Added for KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,add_criteria_nat_code);
							pstmt.setString(++position,this.orderingfacility); 
							pstmt.setString(++position,this.orderingfacility);
							if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
								pstmt.setString(++position,this.order_date_from); 
								pstmt.setString(++position,this.order_date_to); 
							}

							if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
								pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
									pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
								}
								pstmt.setString(++position,this.exclude_PRN_orders);
								if(!(this.drug_medical.equals("")))// if Added - KAUH-SCF-0183[IN:047989]
									pstmt.setString(++position,this.drug_medical);
								pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
							}
							if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,customTabBasedHrs);
							}
						}	*/			
					}
				}
			}
			if(disp_locn_catg.equals("IAE")) //added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
			{
				String OrderBysql="";
				String uniongroupbysql = "";
				
				StringBuffer unionbsconstructsql =  new StringBuffer();
				StringBuffer unionEmgpatsql  = new StringBuffer();
				dipenserightforIAE=" and (CASE WHEN (a.patient_class in ( 'IP','DC')) THEN (SELECT distinct IP_VERIFY_YN FROM PH_DISP_LOCN_LANG_VW Av, PH_DISP_RIGHTS Br WHERE Av.FACILITY_ID =  '"+login_facility_id+"' AND Br.FACILITY_ID=Av.FACILITY_ID AND Br.APPL_USER_ID =  '"+login_by_id+"' AND Av.DISP_LOCN_CODE=Br.DISP_LOCN_CODE AND Av.LANGUAGE_ID = '"+getLanguageId()+"' and   Br.DISP_LOCN_CODE=a.performing_deptloc_code) ELSE (SELECT distinct VERIFY_YN    FROM PH_DISP_LOCN_LANG_VW Av, PH_DISP_RIGHTS Br WHERE Av.FACILITY_ID =  '"+login_facility_id+"' AND Br.FACILITY_ID=Av.FACILITY_ID AND Br.APPL_USER_ID =  '"+login_by_id+"' AND Av.DISP_LOCN_CODE=Br.DISP_LOCN_CODE AND Av.LANGUAGE_ID = '"+getLanguageId()+"' and   Br.DISP_LOCN_CODE=a.performing_deptloc_code) END) ='Y' ";
				
				if(disp_stage.equals("V"))
				{
					String getDisp_locn_iae1="";
					if(getDisp_locn_iae().contains("@@@")){
					String name_getDisp_locn_iae[]=getDisp_locn_iae().split("@@@");
					for(String fechedname:name_getDisp_locn_iae)
					{
						getDisp_locn_iae1=getDisp_locn_iae1+fechedname+"','";
					}
					if (getDisp_locn_iae1 != null && getDisp_locn_iae1.length() >= 2) {
					getDisp_locn_iae1=getDisp_locn_iae1.substring(0, getDisp_locn_iae1.length() - 2);
					getDisp_locn_iae1=getDisp_locn_iae1.substring(2);
					}
					}else
					{
						getDisp_locn_iae1="'"+getDisp_locn_iae()+"'";
					}
						sbConstructSql = new StringBuffer(" and a.ORDERING_FACILITY_ID=? ");
						
						if(ph_print_prescription){ //Added MMS-DM-CRF-0228 start
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')");
							else
								sbConstructSql.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by B.START_DATE_TIME for Bru-HIMS-CRF-418[IN045564]
						}//Added MMS-DM-CRF-0228 end
						else{
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
							else
								sbConstructSql.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");// code 'A.ORD_DATE_TIME' is replaced by B.START_DATE_TIME for Bru-HIMS-CRF-418[IN045564]
						}
						
						

						if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
							sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]

						if(ip_scope.equals("H")) {
							sbConstructSql.append(" AND f.order_status_type ='50' ");
							unionbsconstructsql.append(" AND g.order_status_type ='50' ");
						}
						else if(ip_scope.equals("N")){
							sbConstructSql.append(" AND (f.order_status_type ='10' or (f.order_status_type ='25' and olph.NEXT_FILL_DATE is null)) ");//Modified for ML-BRU-SCF-1338[IN049193]
							unionbsconstructsql.append(" AND (g.order_status_type ='10' or (g.order_status_type ='25' and f.NEXT_FILL_DATE is null)) ");
								unionbsconstructsql.append("  AND ((h.disp_regn_reqd_yn='Y' and 	g.order_status_type = '25') OR  (h.disp_regn_reqd_yn='N')) ");
						}
						else if(ip_scope.equals("R")){
							sbConstructSql.append(" AND f.order_status_type ='56' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							unionbsconstructsql.append(" AND g.order_status_type ='56' ");
						}
						// Verification Stage
						if(getCriteriaOrderType().equals("ALL")) {
							sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
							unionbsconstructsql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
							sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
							unionbsconstructsql.append( " AND (A.IV_PREP_YN IN ('0','9'))");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
						else if(getOrderType().equals("NOR")) {
							sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
							unionbsconstructsql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("IVAD")) {
							sbConstructSql.append( " AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							unionbsconstructsql.append( " AND A.IV_PREP_YN ='1' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("IVAA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							unionbsconstructsql.append(" AND A.IV_PREP_YN ='2' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("IVWA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							unionbsconstructsql.append(" AND A.IV_PREP_YN ='5' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("IVID")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							unionbsconstructsql.append(" AND A.IV_PREP_YN ='3' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("IVIA")) {
							sbConstructSql.append( " AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							unionbsconstructsql.append( " AND A.IV_PREP_YN ='4' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("TD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
							unionbsconstructsql.append(" AND A.IV_PREP_YN ='7' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("TA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
							unionbsconstructsql.append(" AND A.IV_PREP_YN ='8' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("CD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
							unionbsconstructsql.append(" AND A.IV_PREP_YN = '9' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("CA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
							unionbsconstructsql.append(" AND A.IV_PREP_YN = '0' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						else if(getOrderType().equals("CO")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
							unionbsconstructsql.append(" AND A.IV_PREP_YN = '6' ");//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						}
						sbConstructSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id) "); //added to filter only current Inpatient.

						if(!(getOrderType().equals("TA") || getOrderType().equals("TD"))){
							//Added for SRR20056-CRF-0663	--Start
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
								sbConstructSql.append(" and ( (j.drug_yn='Y' AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR j.drug_yn='N') and (( j.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR j.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR j.drug_yn='N') ");
							}
							else{
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
							}
							//Added for SRR20056-CRF-0663	--End
							if(!(this.drug_medical.equals(""))){
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							   unionbsconstructsql.append(" AND J.DRUG_YN = ? ");
							}
						//	sbConstructSql.append(" AND ph_get_user_disp_rights(?,?,A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' ");
						}

						 //Added for PMG20089-CRF-0867 [IN029813] -start
						if( tab_based_group_sort_disp.equals("Y")  ){
							customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) "+dipenserightforIAE+" GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code ,  C.NATIONAL_ID_NO, /*g.nursing_unit_code*/a.source_type, g.bed_num,a.performing_deptloc_code "; // g.bed_num added for KDAH-CRF-0338 
							uniongroupbysql=" GROUP BY a.source_code,a.ordering_facility_id,  Z.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code ,  C.NATIONAL_ID_NO, /*g.nursing_unit_code*/a.source_type, a.performing_deptloc_code";
							customSortBySql  = " ORDER BY CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC,nursing_unit "; //E.LONG_DESC
							if(customTabBased.equals("Y")){
								if(customTabBasedOption.equals("PAST"))
									sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
								else
									sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24)  ");// Added parameter - KAUH-SCF-0183[IN:047989]
							}
							if( !customGroupBy.equals("NURSING_UNIT")){
								if(!(customGroupBy.equals("NONE"))){
									customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) "+dipenserightforIAE+" GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO,  g.NURSING_UNIT_CODE, A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy'),to_char(a.ORD_DATE_TIME,'dd/mm/yyyy'),g.bed_num,/* g.nursing_unit_code */ a.source_type ,a.performing_deptloc_code"; // g.bed_num added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060
									uniongroupbysql=" GROUP BY a.source_code,a.ordering_facility_id,  Z.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO,  A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy'),to_char(a.ORD_DATE_TIME,'dd/mm/yyyy'),/* g.nursing_unit_code */ a.source_type ,a.performing_deptloc_code ";	
									if(customGroupBy.equals("ORD_DATE_TIME"))
											customGroupBy = "to_date("+customGroupBy+" ,'dd/mm/yyyy')";
										else if (customGroupBy.equals("RELEASE_DATE_TIME"))
											customGroupBy = "trunc(to_date("+customGroupBy+" ,'dd/mm/yyyy hh24:mi'))";

										customSortBySql = " ORDER BY " +customGroupBy+" " + customGroupOrder+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC" ;
										
										if(customSortBy.equals("RELEASE_DATE_TIME"))
											customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
										customSortBySql = customSortBySql + ", "+customSortBy+" "+customSortOrder;
								}
								else{
										if(!(customSortBy.equals("NURSING_UNIT"))){
											if(customSortBy.equals("RELEASE_DATE_TIME"))
												customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
											customSortBySql = " ORDER BY CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC,"+customSortBy+" "+customSortOrder;
										}
										else
											customSortBySql = customSortBySql +" " +customSortOrder	;
								}
							}
							else  if (!(customSortBy.equals("") || customSortBy.equals("NONE") || customSortOrder.equals(""))){
								if(!(customGroupBy.equals("NURSING_UNIT"))){
									if(customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = "  ORDER BY "+customSortBy+" "+customSortOrder;
								}
								else{
									if(!customSortBy.equals("PATIENT_ID")){
										customGroupBySql = " and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) "+dipenserightforIAE+" GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , ,C.NATIONAL_ID_NO, g.NURSING_UNIT_CODE , A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy),g.bed_num,a.source_type /*g.nursing_unit_code */ ,a.performing_deptloc_code"; // g.bed_num Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
										uniongroupbysql="  GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code , ,C.NATIONAL_ID_NO, g.NURSING_UNIT_CODE , A.PRIORITY,to_char(a.ADDED_DATE,'dd/mm/yyyy),a.source_type /*g.nursing_unit_code */ ,a.performing_deptloc_code ";
									}
									if(customSortBy.equals("RELEASE_DATE_TIME"))
										customSortBy = "to_date("+customSortBy+" ,'dd/mm/yyyy hh24:mi')";
									customSortBySql = customSortBySql+" "+customGroupOrder +", "+customSortBy+" "+customSortOrder;
								}
							}
							else{
								if(customGroupBy.equals("NURSING_UNIT"))
									customSortBySql = customSortBySql+" "+customGroupOrder ;
							}
							sbConstructSql.append(customGroupBySql);
						//	sbConstructSql.append(customSortBySql); =========
						} //Added for PMG20089-CRF-0867 [IN029813] -End
						else{
							sbConstructSql.append(" and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) "+dipenserightforIAE+" GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,  g.NURSING_UNIT_CODE, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO, g.bed_num,/*G.NURSING_UNIT_CODE */ a.source_type,a.performing_deptloc_code "); //nursing_unit - E.LONG_DESC // g.bed_num Added for KDAH-CRF-0338 // g.nursing_unit_code Added for BSP-SCF-0060
							uniongroupbysql="GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,  g.NURSING_UNIT_CODE, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH, SEX, c.nationality_code , C.NATIONAL_ID_NO,/*G.NURSING_UNIT_CODE */ a.source_type,a.performing_deptloc_code";
							
							if(group_by_ord_locn.equals("N")){
								OrderBysql=" order by min(a.ADDED_DATE)";
								sbConstructSql.append(" ");
							}
							else{
								OrderBysql=" order by nursing_unit, min(a.ADDED_DATE),A.PATIENT_ID";
								sbConstructSql.append("");//nursing_unit - E.LONG_DESC
							}
						}
						
						 //tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")
						if(getOrderType().equals("TA") || getOrderType().equals("TD")){
							if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){//patient_name-loc
								sbMainSql.append("SELECT priority,patient_id,dispance_location,nursing_unit,patient_name,orders,age, sex,country_code,nationality_desc,national_id_no,release_date_time,ordering_facility_id,patient_class,episode_id,encounter_id,source_type,bed_num,source_code FROM(");
								sbMainSql.append("SELECT  DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code/*g.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,  COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no ,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, null source_type,G.BED_NUM,/*g.nursing_unit_code */a.source_code,a.performing_deptloc_code  FROM or_order_line b,or_order a,or_order_line_ph olph,mp_patient c, or_order_status_code f,  ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060 
							    if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND  a.source_code= ? ");//e.nursing_unit_code
							    if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
							    if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.priority = ? ");
							    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.patient_id = ? ");
							    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							    	sbMainSql.append(" AND a.order_id = ? ");
							    sbMainSql.append(" AND a.patient_class in ('EM','IP') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' AND a.performing_deptloc_code in ( "+getDisp_locn_iae1+" ) ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
							    if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.ord_pract_id = ? ");
							    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.sex = ? ");
							    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.nationality_code = ? ");
								if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							        sbMainSql.append(" AND c.CONTACT2_NO=? ");
								if(!getPatNationalID().equals(""))
						            sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							    //sbMainSql.append(" AND d.language_id(+) = ? AND e.language_id = ?"); //GHL-SCF-0830 [IN:049943]

								unionEmgpatsql.append(" union ");
								
								unionEmgpatsql.append(" SELECT    DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(SELECT DISTINCT (disp_locn_code || ' &&& ' || short_desc ) FROM ph_disp_locn WHERE disp_locn_code = a.performing_deptloc_code) dispance_location, (CASE WHEN (a.source_type = 'C' OR a.source_type = 'E')  THEN (SELECT short_desc  FROM op_clinic_lang_vw  WHERE facility_id = a.ordering_facility_id  AND clinic_code = a.source_code AND language_id = ?)  ELSE (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = a.ordering_facility_id AND nursing_unit_code = a.source_code AND language_id = ? )  END  ) nursing_unit, NVL (DECODE (?, 'en', patient_name, patient_name_loc_lang), patient_name ) patient_name,COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex,c.nationality_code country_code,(SELECT long_desc  FROM mp_country_lang_vw WHERE language_id = ?  AND country_code = c.nationality_code) nationality_desc,c.national_id_no,TO_CHAR (MIN (a.added_date), 'dd/mm/yyyy hh24:mi') release_date_time,TO_CHAR (a.ord_date_time, 'dd/mm/yyyy') ORD_DATE_TIME,a.ordering_facility_id,z.patient_class patient_class, a.episode_id,a.encounter_id, a.source_type,NULL bed_num, a.source_code,a.performing_deptloc_code  FROM or_order_line b,  or_order a,  mp_patient c,  ph_facility_param e, or_order_line_ph f,  or_order_status_code g,  ph_disp_locn h, ph_drug i,  ph_drug j, pr_encounter z  ");
								unionEmgpatsql.append(" WHERE z.encounter_id = a.encounter_id AND z.patient_id = a.patient_id AND e.facility_id = a.ordering_facility_id AND c.patient_id = a.patient_id  AND b.order_id = a.order_id AND b.order_id = f.order_id AND b.order_line_num = f.order_line_num  AND a.order_id = f.order_id  ");
								if(!nursing_unit.equals(""))
									unionEmgpatsql.append(" AND a.source_code = ? ");
								if(!priority.equals(""))
									unionEmgpatsql.append(" AND a.priority = ? ");
								if(!patient_id.equals(""))
									unionEmgpatsql.append(" AND z.patient_id = ? ");
								if( !getOrderID().equals(""))
									unionEmgpatsql.append(" AND a.order_id = ? "); 
								
								unionEmgpatsql.append(" AND  ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' ");
								if(!add_criteria_practitioner_id.equals(""))
									unionEmgpatsql.append(" AND a.ord_pract_id = ? ");
							    if(!this.getGender().equals(""))
							    	unionEmgpatsql.append(" AND c.sex = ? ");
							    if(!add_criteria_nat_code.equals(""))
							    	unionEmgpatsql.append(" AND c.nationality_code = ? ");
								if(!getPatMobileNo().equals(""))
									unionEmgpatsql.append(" AND c.CONTACT2_NO=? ");
								if(!getPatNationalID().equals(""))
									unionEmgpatsql.append(" AND C.NATIONAL_ID_NO=? ");
								
								unionEmgpatsql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.ordering_facility_id = ?");
								if(getDisp_locn_iae().contains("@@@"))
								{
								unionEmgpatsql.append(" AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
								}else
								{
								unionEmgpatsql.append(" and a.performing_deptloc_code="+getDisp_locn_iae1+" ");
								}
								unionEmgpatsql.append("  AND g.order_status_code = b.order_line_status  AND b.order_catalog_code = i.drug_code  AND h.facility_id = a.performing_facility_id AND a.performing_deptloc_code = h.disp_locn_code AND DECODE (h.disp_verf_stage, 'F', i.verification_reqd_yn, 'B', i.verification_reqd_yn, 'X' ) = DECODE (h.disp_verf_stage, 'F', 'Y', 'B', 'Y', 'X') AND j.drug_code = b.order_catalog_code AND  z.patient_class ='EM'  "+unionbsconstructsql+" AND NVL (a.source_type, 'X') = NVL (?, NVL (a.source_type, 'X')) AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?, 'Y', 'N', j.calc_dosg_by_freq_durn_yn ) OR ('Y' = (SELECT 'Y'  FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O'))) AND EXISTS (  SELECT 'Y'  FROM am_frequency  WHERE freq_code = b.freq_code AND freq_nature NOT IN (DECODE (?, 'Y', 'P', 'X')))  "+dipenserightforIAE+" AND a.ord_date_time BETWEEN (SELECT   SYSDATE  - NVL (disp_beyond_no_of_days, 1)  FROM ph_facility_param  WHERE facility_id = ?)  AND (SELECT   SYSDATE  + NVL (disp_before_no_of_days, 1)  FROM ph_facility_param   WHERE facility_id =?)");
								if(bed_no.equals("")){
									pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
								}else
								{
									pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
								}
								System.out.println("==>0 "+sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
							}
							else{//patient_name-loc
								sbMainSql.append("SELECT priority,patient_id,dispance_location,nursing_unit,patient_name,orders,age, sex,country_code,nationality_desc,national_id_no,release_date_time,ordering_facility_id,patient_class,episode_id,encounter_id,source_type,bed_num,source_code FROM(");
								sbMainSql.append("SELECT max(a.priority)priority , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,(select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code /*g.NURSING_UNIT_CODE */ and language_id = ?) nursing_unit, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,  COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no ,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,null source_type,G.BED_NUM,/*g.nursing_unit_code */a.source_code,a.performing_deptloc_code FROM or_order_line b,or_order a, or_order_line_ph olph,mp_patient c,  or_order_status_code f, ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); 
								if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.source_code = ? ");//a.source_code- e.nursing_unit_code
								if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
							    if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.priority = ? ");
							    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.patient_id = ? ");
							    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
							    	sbMainSql.append(" AND a.order_id = ? "); 
								sbMainSql.append("AND a.patient_class in ('EM','IP') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' AND a.performing_deptloc_code in ("+getDisp_locn_iae1+") ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
								if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND a.ord_pract_id = ? ");
							    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.sex = ? ");
							    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							    	sbMainSql.append(" AND c.nationality_code = ? ");
								if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							        sbMainSql.append(" AND c.CONTACT2_NO=? ");
								if(!getPatNationalID().equals(""))
						            sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							    //sbMainSql.append(" AND d.language_id(+) = ? AND e.language_id = ?"); //GHL-SCF-0830 [IN:049943]

								unionEmgpatsql.append(" union ");
								unionEmgpatsql.append(" SELECT    MAX (b.priority) PRIORITY , a.patient_id,(SELECT DISTINCT (disp_locn_code || ' &&& ' || short_desc ) FROM ph_disp_locn WHERE disp_locn_code = a.performing_deptloc_code) dispance_location, (CASE WHEN (a.source_type = 'C' OR a.source_type = 'E')  THEN (SELECT short_desc  FROM op_clinic_lang_vw  WHERE facility_id = a.ordering_facility_id  AND clinic_code = a.source_code AND language_id = ?)  ELSE (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = a.ordering_facility_id AND nursing_unit_code = a.source_code AND language_id = ? )  END  ) nursing_unit, NVL (DECODE (?, 'en', patient_name, patient_name_loc_lang), patient_name ) patient_name,COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex,c.nationality_code country_code,(SELECT long_desc  FROM mp_country_lang_vw WHERE language_id = ?  AND country_code = c.nationality_code) nationality_desc,c.national_id_no,TO_CHAR (MIN (a.added_date), 'dd/mm/yyyy hh24:mi') release_date_time,a.ordering_facility_id,z.patient_class patient_class, a.episode_id,a.encounter_id, a.source_type,NULL bed_num, a.source_code,a.performing_deptloc_code  FROM or_order_line b,  or_order a,  mp_patient c,  ph_facility_param e, or_order_line_ph f,  or_order_status_code g,  ph_disp_locn h, ph_drug i,  ph_drug j, pr_encounter z  ");
								unionEmgpatsql.append(" WHERE z.encounter_id = a.encounter_id AND z.patient_id = a.patient_id AND e.facility_id = a.ordering_facility_id AND c.patient_id = a.patient_id  AND b.order_id = a.order_id AND b.order_id = f.order_id AND b.order_line_num = f.order_line_num  AND a.order_id = f.order_id  ");
								if(!nursing_unit.equals(""))
									unionEmgpatsql.append(" AND a.source_code = ? ");
								if(!priority.equals(""))
									unionEmgpatsql.append(" AND a.priority = ? ");
								if(!patient_id.equals(""))
									unionEmgpatsql.append(" AND z.patient_id = ? ");
								if( !getOrderID().equals(""))
									unionEmgpatsql.append(" AND a.order_id = ? "); 
								
								unionEmgpatsql.append(" AND  ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' ");
								
								if(!add_criteria_practitioner_id.equals(""))
									unionEmgpatsql.append(" AND a.ord_pract_id = ? ");
							    if(!this.getGender().equals(""))
							    	unionEmgpatsql.append(" AND c.sex = ? ");
							    if(!add_criteria_nat_code.equals(""))
							    	unionEmgpatsql.append(" AND c.nationality_code = ? ");
								if(!getPatMobileNo().equals(""))
									unionEmgpatsql.append(" AND c.CONTACT2_NO=? ");
								if(!getPatNationalID().equals(""))
									unionEmgpatsql.append(" AND C.NATIONAL_ID_NO=? ");
								
								unionEmgpatsql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.ordering_facility_id = ?");
								if(getDisp_locn_iae().contains("@@@"))
								{
								unionEmgpatsql.append(" AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
								}else
								{
								unionEmgpatsql.append(" and a.performing_deptloc_code="+getDisp_locn_iae1+" ");
								}
								unionEmgpatsql.append("  AND g.order_status_code = b.order_line_status  AND b.order_catalog_code = i.drug_code  AND h.facility_id = a.performing_facility_id AND a.performing_deptloc_code = h.disp_locn_code AND DECODE (h.disp_verf_stage, 'F', i.verification_reqd_yn, 'B', i.verification_reqd_yn, 'X' ) = DECODE (h.disp_verf_stage, 'F', 'Y', 'B', 'Y', 'X') AND j.drug_code = b.order_catalog_code AND  z.patient_class ='EM'  "+unionbsconstructsql+" AND NVL (a.source_type, 'X') = NVL (?, NVL (a.source_type, 'X')) AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?, 'Y', 'N', j.calc_dosg_by_freq_durn_yn ) OR ('Y' = (SELECT 'Y'  FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O'))) AND EXISTS (  SELECT 'Y'  FROM am_frequency  WHERE freq_code = b.freq_code AND freq_nature NOT IN (DECODE (?, 'Y', 'P', 'X')))  "+dipenserightforIAE+" AND a.ord_date_time BETWEEN (SELECT   SYSDATE  - NVL (disp_beyond_no_of_days, 1)  FROM ph_facility_param  WHERE facility_id = ?)  AND (SELECT   SYSDATE  + NVL (disp_before_no_of_days, 1)  FROM ph_facility_param   WHERE facility_id =?)");								
								System.out.println("==>1 "+sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
								
								if(bed_no.equals("")){
									pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
								}else
								{
									pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
								}
							}
						}
						else if( tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")  && !customGroupBy.equals("NONE")){
							sbMainSql.append("SELECT priority,patient_id,dispance_location,nursing_unit,patient_name,orders,age, sex,country_code,nationality_desc,national_id_no,release_date_time,ORD_DATE_TIME,ordering_facility_id,patient_class,episode_id,encounter_id,source_type,bed_num,source_code,performing_deptloc_code FROM(");
							sbMainSql.append("SELECT  DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = a.source_code/*g.NURSING_UNIT_CODE*/ and language_id = ?) nursing_unit,  nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name, COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ,to_char(a.ORD_DATE_TIME,'dd/mm/yyyy') ORD_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,null source_type,G.BED_NUM,/*g.nursing_unit_code */ a.source_code,a.performing_deptloc_code FROM or_order_line b,or_order a, or_order_line_ph olph, mp_patient c, or_order_status_code f, ph_drug j, ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num  AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // g.nursing_unit_code added for BSP-SCF-0060
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.source_code = ? ");// a.source_code - e.nursing_unit_code
							if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
						    if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.priority = ? ");
						    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.patient_id = ? ");
						    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
						    	sbMainSql.append(" AND a.order_id = ? ");  
							 if(getDisp_locn_iae().contains("@@@")){
							    	sbMainSql.append(" AND a.patient_class in ('EM','IP') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'   AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' "); 
							    }else
							    	sbMainSql.append(" AND a.patient_class in ('EM','IP') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'  and a.performing_deptloc_code="+getDisp_locn_iae1+"  AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' ");
							if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.ord_pract_id = ? ");
						    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.sex = ? ");
						    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.nationality_code = ? ");
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" and j.drug_code =b.order_catalog_code ");

							unionEmgpatsql.append(" union ");
							
							unionEmgpatsql.append(" SELECT    DECODE(A.PRIORITY,'R','Routine','S','Static','U','Urgent') PRIORITY , a.patient_id,(SELECT DISTINCT (disp_locn_code || ' &&& ' || short_desc ) FROM ph_disp_locn WHERE disp_locn_code = a.performing_deptloc_code) dispance_location, (CASE WHEN (a.source_type = 'C' OR a.source_type = 'E')  THEN (SELECT short_desc  FROM op_clinic_lang_vw  WHERE facility_id = a.ordering_facility_id  AND clinic_code = a.source_code AND language_id = ?)  ELSE (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = a.ordering_facility_id AND nursing_unit_code = a.source_code AND language_id = ? )  END  ) nursing_unit, NVL (DECODE (?, 'en', patient_name, patient_name_loc_lang), patient_name ) patient_name,COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex,c.nationality_code country_code,(SELECT long_desc  FROM mp_country_lang_vw WHERE language_id = ?  AND country_code = c.nationality_code) nationality_desc,c.national_id_no,TO_CHAR (MIN (a.added_date), 'dd/mm/yyyy hh24:mi') release_date_time,TO_CHAR (a.ord_date_time, 'dd/mm/yyyy') ORD_DATE_TIME,a.ordering_facility_id,z.patient_class patient_class, a.episode_id,a.encounter_id, a.source_type,NULL bed_num, a.source_code,a.performing_deptloc_code  FROM or_order_line b,  or_order a,  mp_patient c,  ph_facility_param e, or_order_line_ph f,  or_order_status_code g,  ph_disp_locn h, ph_drug i,  ph_drug j, pr_encounter z  ");
							unionEmgpatsql.append(" WHERE z.encounter_id = a.encounter_id AND z.patient_id = a.patient_id AND e.facility_id = a.ordering_facility_id AND c.patient_id = a.patient_id  AND b.order_id = a.order_id AND b.order_id = f.order_id AND b.order_line_num = f.order_line_num  AND a.order_id = f.order_id  ");
							if(!nursing_unit.equals(""))
								unionEmgpatsql.append(" AND a.source_code = ? ");
							if(!priority.equals(""))
								unionEmgpatsql.append(" AND a.priority = ? ");
							if(!patient_id.equals(""))
								unionEmgpatsql.append(" AND z.patient_id = ? ");
							if( !getOrderID().equals(""))
								unionEmgpatsql.append(" AND a.order_id = ? "); 
							
							unionEmgpatsql.append(" AND  ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' ");
							
							if(!add_criteria_practitioner_id.equals(""))
								unionEmgpatsql.append(" AND a.ord_pract_id = ? ");
						    if(!this.getGender().equals(""))
						    	unionEmgpatsql.append(" AND c.sex = ? ");
						    if(!add_criteria_nat_code.equals(""))
						    	unionEmgpatsql.append(" AND c.nationality_code = ? ");
							if(!getPatMobileNo().equals(""))
								unionEmgpatsql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
								unionEmgpatsql.append(" AND C.NATIONAL_ID_NO=? ");
							
							unionEmgpatsql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.ordering_facility_id = ?");
							if(getDisp_locn_iae().contains("@@@"))
							{
							unionEmgpatsql.append(" AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
							}else
							{
							unionEmgpatsql.append(" and a.performing_deptloc_code="+getDisp_locn_iae1+" ");
							}
							unionEmgpatsql.append("  AND g.order_status_code = b.order_line_status  AND b.order_catalog_code = i.drug_code  AND h.facility_id = a.performing_facility_id AND a.performing_deptloc_code = h.disp_locn_code AND DECODE (h.disp_verf_stage, 'F', i.verification_reqd_yn, 'B', i.verification_reqd_yn, 'X' ) = DECODE (h.disp_verf_stage, 'F', 'Y', 'B', 'Y', 'X') AND j.drug_code = b.order_catalog_code AND  z.patient_class ='EM'  "+unionbsconstructsql+" AND NVL (a.source_type, 'X') = NVL (?, NVL (a.source_type, 'X')) AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?, 'Y', 'N', j.calc_dosg_by_freq_durn_yn ) OR ('Y' = (SELECT 'Y'  FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O'))) AND EXISTS (  SELECT 'Y'  FROM am_frequency  WHERE freq_code = b.freq_code AND freq_nature NOT IN (DECODE (?, 'Y', 'P', 'X')))  "+dipenserightforIAE+" AND a.ord_date_time BETWEEN (SELECT   SYSDATE  - NVL (disp_beyond_no_of_days, 1)  FROM ph_facility_param  WHERE facility_id = ?)  AND (SELECT   SYSDATE  + NVL (disp_before_no_of_days, 1)  FROM ph_facility_param   WHERE facility_id =?)");
							System.out.println("==>2 "+sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
							
							if(bed_no.equals("")){
								pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
							}else
							{
								pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+") "+customSortBySql.toString()+",CASE WHEN patient_class = 'EM' THEN 1 ELSE 2 END, patient_class ASC");
							}
						}
						else{
							sbMainSql.append("SELECT priority,patient_id,dispance_location,nursing_unit,patient_name,orders,age, sex,country_code,nationality_desc,national_id_no,release_date_time,ordering_facility_id,patient_class,episode_id,encounter_id,source_type,bed_num,source_code FROM(");
							sbMainSql.append("SELECT  max(a.priority)priority , a.patient_id, (select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, (select short_desc from ip_nursing_unit_lang_vw where facility_id = a.ordering_facility_id  and nursing_unit_code = /*g.NURSING_UNIT_CODE */ a.source_code and language_id = ?) nursing_unit,  nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex, c.nationality_code country_code, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) nationality_desc, c.national_id_no,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id, A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.source_type,G.BED_NUM,/*g.nursing_unit_code */ a.source_code FROM or_order_line b,or_order a,or_order_line_ph olph,mp_patient c, or_order_status_code f,ph_drug j, ip_open_encounter g WHERE c.patient_id = a.patient_id AND b.order_id = a.order_id and b.order_id = olph.order_id and b.order_line_num = olph.order_line_num AND f.order_status_code =b.order_line_status AND a.ordering_facility_id = g.facility_id AND a.encounter_id = g.encounter_id  AND g.facility_id = ?"); //changed from long_desc to short_desc for ML-BRU-SCF-1591 [IN:055119] // in select G.BED_NUM Added for KDAH-CRF-0338 // i.nursing_unit_code added for BSP-SCF-0060
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.source_code = ? ");//a.source_code - e.nursing_unit_code
							if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						    	sbMainSql.append(" AND  g.bed_num= ? AND EXISTS (SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = olph.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = olph.order_line_num AND bed_no=g.bed_num)");// Added for KDAH-CRF-0338 - End
						    if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.priority = ? ");
						    if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND a.patient_id = ? ");
						    if( !getOrderID().equals(""))// Added condition order_id for JD-CRF-0181 [IN:40699]
						    	sbMainSql.append(" AND a.order_id = ? "); 
						    if(getPhAltDispLocnYN().equals("Y")){
						    	sbMainSql.append(" AND a.patient_class in ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'    AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+")  ");// Modify ph_check_ord_date_dispensing for COMMON-ICN-0116 [39681]
						    } else if(getDisp_locn_iae().contains("@@@")){
						    	sbMainSql.append(" AND a.patient_class in ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'   AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' "); 
						    }else
						    	sbMainSql.append(" AND a.patient_class in ('IP','DC') AND ph_check_ord_date_dispensing (b.start_date_time,b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH'  and a.performing_deptloc_code="+getDisp_locn_iae1+"  AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,A.PERFORMING_DEPTLOC_CODE, A.source_type, A.source_code,  a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, J.drug_class, J.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(J.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID ) = 'Y' ");
							if(!add_criteria_practitioner_id.equals(""))
						    	sbMainSql.append(" AND a.ord_pract_id = ? ");
						    if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.sex = ? ");
						    if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						    	sbMainSql.append(" AND c.nationality_code = ? ");
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" and j.drug_code =b.order_catalog_code");
							
							unionEmgpatsql.append(" union ");
							unionEmgpatsql.append("SELECT   MAX (b.priority) priority, a.patient_id,(SELECT DISTINCT (disp_locn_code || ' &&& ' || short_desc ) FROM ph_disp_locn WHERE disp_locn_code = a.performing_deptloc_code) dispance_location, (CASE WHEN (a.source_type = 'C' OR a.source_type = 'E')  THEN (SELECT short_desc  FROM op_clinic_lang_vw  WHERE facility_id = a.ordering_facility_id  AND clinic_code = a.source_code AND language_id = ? )  ELSE (SELECT short_desc FROM ip_nursing_unit_lang_vw WHERE facility_id = a.ordering_facility_id AND nursing_unit_code = a.source_code AND language_id = ?)  END  ) nursing_unit, NVL (DECODE (?, 'en', patient_name, patient_name_loc_lang), patient_name ) patient_name,COUNT (DISTINCT a.order_id) orders, get_age (date_of_birth) age, sex,c.nationality_code country_code,(SELECT long_desc  FROM mp_country_lang_vw WHERE language_id = ?  AND country_code = c.nationality_code) nationality_desc,c.national_id_no,TO_CHAR (MIN (a.added_date), 'dd/mm/yyyy hh24:mi') release_date_time,a.ordering_facility_id,z.patient_class patient_class, a.episode_id,a.encounter_id, a.source_type,NULL bed_num, a.source_code  FROM or_order_line b,  or_order a,  mp_patient c,  ph_facility_param e, or_order_line_ph f,  or_order_status_code g,  ph_disp_locn h, ph_drug i,  ph_drug j, pr_encounter z ");
							unionEmgpatsql.append(" WHERE z.encounter_id = a.encounter_id AND z.patient_id = a.patient_id AND e.facility_id = a.ordering_facility_id AND c.patient_id = a.patient_id  AND b.order_id = a.order_id AND b.order_id = f.order_id AND b.order_line_num = f.order_line_num  AND a.order_id = f.order_id ");
							if(!nursing_unit.equals(""))
								unionEmgpatsql.append(" AND a.source_code = ? ");
							if(!priority.equals(""))
								unionEmgpatsql.append(" AND a.priority = ? ");
							if(!patient_id.equals(""))
								unionEmgpatsql.append(" AND z.patient_id = ? ");
							if( !getOrderID().equals(""))
								unionEmgpatsql.append(" AND a.order_id = ? "); 
							
							unionEmgpatsql.append(" AND  ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time,?,?,?,?,?) = 1 AND a.order_category = 'PH' ");
							if(!add_criteria_practitioner_id.equals(""))
								unionEmgpatsql.append(" AND a.ord_pract_id = ? ");
						    if(!this.getGender().equals(""))
						    	unionEmgpatsql.append(" AND c.sex = ? ");
						    if(!add_criteria_nat_code.equals(""))
						    	unionEmgpatsql.append(" AND c.nationality_code = ? ");
							if(!getPatMobileNo().equals(""))
								unionEmgpatsql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
								unionEmgpatsql.append(" AND C.NATIONAL_ID_NO=? ");
							
							unionEmgpatsql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.ordering_facility_id = ?");
							if(getDisp_locn_iae().contains("@@@"))
							{
							unionEmgpatsql.append(" AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
							}else
							{
							unionEmgpatsql.append(" and a.performing_deptloc_code="+getDisp_locn_iae1+" ");
							}
							unionEmgpatsql.append("  AND g.order_status_code = b.order_line_status  AND b.order_catalog_code = i.drug_code  AND h.facility_id = a.performing_facility_id AND a.performing_deptloc_code = h.disp_locn_code AND DECODE (h.disp_verf_stage, 'F', i.verification_reqd_yn, 'B', i.verification_reqd_yn, 'X' ) = DECODE (h.disp_verf_stage, 'F', 'Y', 'B', 'Y', 'X') AND j.drug_code = b.order_catalog_code AND z.patient_class ='EM'  "+unionbsconstructsql+"  AND NVL (a.source_type, 'X') = NVL (?, NVL (a.source_type, 'X')) AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?, 'Y', 'N', j.calc_dosg_by_freq_durn_yn ) OR ('Y' = (SELECT 'Y'  FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O'))) AND EXISTS (  SELECT 'Y'  FROM am_frequency  WHERE freq_code = b.freq_code AND freq_nature NOT IN (DECODE (?, 'Y', 'P', 'X')))  "+dipenserightforIAE+" AND a.ord_date_time BETWEEN (SELECT   SYSDATE  - NVL (disp_beyond_no_of_days, 1)  FROM ph_facility_param  WHERE facility_id = ?)  AND (SELECT   SYSDATE  + NVL (disp_before_no_of_days, 1)  FROM ph_facility_param   WHERE facility_id =?)");
							if(bed_no.equals("")){
								pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+unionEmgpatsql.toString()+uniongroupbysql.toString()+") "+customSortBySql.toString()+"");
							}else
							{
								pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+") "+customSortBySql.toString()+"");
							}
							
						}
							
							
							int position = 0;
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
						pstmt.setString(++position,getLanguageId()); //Added GHL-SCF-0830 [IN:049943]
						pstmt.setString(++position,this.orderingfacility); //Added GHL-SCF-0830 [IN:049943]
						if(!nursing_unit.equals("")){
							pstmt.setString(++position,nursing_unit);
						}
						if(!bed_no.equals("")){
							System.out.println("bed_no==============>"+bed_no);
							pstmt.setString(++position,bed_no);
						}
						if(!priority.equals("")){
							System.out.println("priority==============>"+priority);
							pstmt.setString(++position,priority);
						}
						if(!patient_id.equals("")){
							System.out.println("patient_id==============>"+patient_id);
							pstmt.setString(++position,patient_id);
						}
						if(!getOrderID().equals("")){
							System.out.println("getOrderID()==============>"+getOrderID());
						    pstmt.setString(++position,getOrderID());
						}
						
					
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]	
						//pstmt.setString(++position,getDisp_locn_iae());// Removed trim() - KAUH-SCF-0183[IN:047989]
						if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,add_criteria_practitioner_id);
						if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.getGender());
						if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,add_criteria_nat_code);
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						    pstmt.setString(++position,getPatMobileNo());
						if(!getPatNationalID().equals(""))
						    pstmt.setString(++position,getPatNationalID());//Adding end for TH-KW-CRF-0014
						
						pstmt.setString(++position,this.orderingfacility);
						pstmt.setString(++position,this.order_date_from); 
						pstmt.setString(++position,this.order_date_to); 
					
						if(!(getOrderType().equals("TA") || getOrderType().equals("TD"))){
							pstmt.setString(++position,sFreqDurnAbsOrderFlag);	
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ 
								pstmt.setString(++position,this.exclude_PRN_orders);		
							}
							pstmt.setString(++position,this.exclude_PRN_orders);
							if(!(this.drug_medical.equals(""))){
								pstmt.setString(++position,this.drug_medical);
							}
						}
						if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){
							pstmt.setString(++position,customTabBasedHrs);
						}
						pstmt.setString(++position,login_facility_id);	 
						pstmt.setString(++position,login_facility_id); 
						
						if(bed_no.equals("")){
						//"Union Section below "
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						if(!nursing_unit.equals("")){
							pstmt.setString(++position,nursing_unit);
							}						
						if(!priority.equals(""))
						{
							pstmt.setString(++position,priority);
						}							
						if(!patient_id.equals("")){
							pstmt.setString(++position,patient_id);
						}
						if(!getOrderID().equals("")){
							pstmt.setString(++position,getOrderID());
						}	
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());
						pstmt.setString(++position,getDisp_before_no_of_days());
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());
						pstmt.setString(++position,getDisp_beyond_no_of_days());
						if(!add_criteria_practitioner_id.equals(""))
							pstmt.setString(++position,add_criteria_practitioner_id);
						if(!this.getGender().equals(""))
							pstmt.setString(++position,this.getGender());
						if(!add_criteria_nat_code.equals(""))
							pstmt.setString(++position,add_criteria_nat_code);
						if(!getPatMobileNo().equals(""))
						    pstmt.setString(++position,getPatMobileNo());
						if(!getPatNationalID().equals(""))
						    pstmt.setString(++position,getPatNationalID());
						pstmt.setString(++position,order_date_from);
						pstmt.setString(++position,order_date_to);
						pstmt.setString(++position,orderingfacility);
						if(!(getOrderType().equals("TA") || getOrderType().equals("TD"))){
						if(!(this.drug_medical.equals(""))){
							System.out.println(drug_medical+"======================> ");
							pstmt.setString(++position,this.drug_medical);
						}
						}
						pstmt.setString(++position,ordlocntype.trim());
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,login_facility_id);
				}

					}
			}//Added by Himanshu
			
			StringBuffer sbLocationSql = new StringBuffer();
			if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085 start
				sbLocationSql.append(", '' source_type, '' locn_desc, '' source_code");
			}
			else{
				sbLocationSql.append(",a.source_type,(case when (a.source_type = 'C' OR a.source_type = 'E') then (SELECT short_desc FROM op_clinic_lang_vw WHERE facility_id = a.ordering_facility_id AND clinic_code = a.source_code AND language_id = ?) else (select short_desc from ip_nursing_unit_lang_vw where facility_id =a.ORDERING_FACILITY_ID and nursing_unit_code =a.source_code and language_id =?)end ) locn_desc,a.source_code"); // ( OR a.source_type = 'E') added for SKR-SCF-0333 [IN:029819] // a.source_code Added for BSP-SCF-0060
			}

		// Dispense Location Category --> Outpatient Issue Token is not Applicable
			if(disp_locn_catg.equals("O") && issue_token_on_regn_yn.equals("N")){
				sbStagesCondition = new StringBuffer();
				sbConstructSql = new StringBuffer();
				String append="";

				if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
					sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]
				if(getDispStage().equals("V")){
					// Dispense Stage --> Verification Stage
					if (disp_regn_reqd_yn.equals("Y")){
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND (G.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D' ) AND G. ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT') ");
						}
						else {
							if(scope.equals("EX")){
								sbStagesCondition.append(" AND (G.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D' ) AND G. ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS ='XT' ");
							}
							else{
								if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
								sbStagesCondition.append(" AND G.ORDER_STATUS_TYPE != '58' AND G. ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS IN ('OP','EM') ");
							}
						}
					}
					else{
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND (G.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D' ) AND G. ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT') ");
						}
						else if(scope.equals("EX")) {
							sbStagesCondition.append( " AND (G.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D' ) AND G. ORDER_STATUS_TYPE IN ('10','25','56','94') AND A.PATIENT_CLASS ='XT' ");//Added '94' for ML-BRU-SCF-1120[IN:44829]
						}
						else {
							if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
							sbStagesCondition.append(" AND G.ORDER_STATUS_TYPE != '58' AND G. ORDER_STATUS_TYPE IN ('10','25','56','94') AND A.PATIENT_CLASS IN ('OP','EM') ");//Added '94' for ML-BRU-SCF-1120[IN:44829]
						}
					}
				}
				else if( (getDispStage().equals("A") && (getFillingStatus().equals("A") ))||(getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
					/*  Dispense Stage Allocation and Filling is after Allocation
											or
						Dispense Stage Filling and Filling is before Allocation	*/

					if (disp_regn_reqd_yn.equals("Y")){
						 if(verf_combined_with_alloc.equals("C")){
							append=" ORDER_STATUS_TYPE ='25' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
						 }
						 else{
							append=" ORDER_STATUS_TYPE ='30' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
						 }
					
						if(scope.equals("H")) {
							sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");//OR ( B.ORDER_QTY>NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_LINE_NO= B.ORDER_LINE_NUM AND ORDER_ID=A.ORDER_ID),0)))AND A.PATIENT_CLASS IN ('OP','EM','XT') "); //Commented for HOLD // = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(scope.equals("EX")) {
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
							sbStagesCondition.append(append);
							sbStagesCondition.append(" )AND A.PATIENT_CLASS ='XT' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]

						} 
						else {
							if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
							sbStagesCondition.append(append);
							sbStagesCondition.append(")AND A.PATIENT_CLASS IN ('OP','EM') ");
						}
					}
					else{
						if(verf_combined_with_alloc.equals("C")){
							if(this.order_date_from.equals("") && this.order_date_to.equals(""))//if condition & else block added for ML-BRU-SCF-0378[IN034797] & ML-BRU-SCF-0638 [IN:036848]
								append=" ORDER_STATUS_TYPE IN ('10','56','94')";
							else{
								
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
										append="( ORDER_STATUS_TYPE IN ('10','94') OR ( ORDER_STATUS_TYPE ='56'  AND F.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')  ) ) ";
									else if(!this.order_date_from.equals(""))
										append="( ORDER_STATUS_TYPE IN ('10','94') OR ( ORDER_STATUS_TYPE ='56'  AND F.NEXT_COLLECTION_DATE >= TO_DATE(?,'dd/mm/yyyy hh24:mi')) ) ";
									else if(!this.order_date_to.equals(""))
										append="( ORDER_STATUS_TYPE IN ('10','94') OR ( ORDER_STATUS_TYPE ='56'  AND F.NEXT_COLLECTION_DATE <= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ) ";
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
										append="( ORDER_STATUS_TYPE IN ('10','94') OR ( ORDER_STATUS_TYPE ='56'  AND F.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) ) "; // Added parameters - KAUH-SCF-0183[IN:047989]
									else if(!this.order_date_from.equals(""))
										append="( ORDER_STATUS_TYPE IN ('10','94') OR ( ORDER_STATUS_TYPE ='56'  AND F.NEXT_COLLECTION_DATE >= TO_DATE(?,'DD/MM/YYYY')) ) ";// Added parameter - KAUH-SCF-0183[IN:047989]
									else if(!this.order_date_to.equals(""))
										append="( ORDER_STATUS_TYPE IN ('10','94') OR ( ORDER_STATUS_TYPE ='56'  AND F.NEXT_COLLECTION_DATE <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) ) ";// Added parameter - KAUH-SCF-0183[IN:047989]
								}
							}
						}
						else{
							append=" ORDER_STATUS_TYPE IN ('30') ";//Removed 94 for INC#48812
						}
						if(scope.equals("H")) {
							sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");/*This condition is used for partiallty allocated order lines*/ // OR ( B.ORDER_QTY>NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_LINE_NO= B.ORDER_LINE_NUM AND ORDER_ID=A.ORDER_ID),0)))AND A.PATIENT_CLASS IN ('OP','EM','XT')"); //Commented for HOLD // = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(scope.equals("EX")) {						
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
							sbStagesCondition.append(append);
							sbStagesCondition.append(" )AND A.PATIENT_CLASS = 'XT'");
						} 
						else {
							if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
							sbStagesCondition.append(append);
							sbStagesCondition.append(" )AND A.PATIENT_CLASS IN ('OP','EM')");
						}
					}
				}
				else if((getDispStage().equals("F") && getFillingStatus().equals("A"))){
					// Dispense Stage is Filling and Filling is after Allocation

					if(scope.equals("H")) {
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(scope.equals("EX")) {
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('50','36')) AND A.PATIENT_CLASS ='XT'");// IN Added instead of OR KAUH-SCF-0183[IN:047989]
					} 
					else {
						if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='36') AND A.PATIENT_CLASS IN ('OP','EM')");
					}
				}
				else if((getDispStage().equals("A") && (getFillingStatus().equals("B")||getFillingStatus().equals("X")))){
					// Dispense Stage is Allocation and Filling is before Allocation or filling is not applicapable
					
					if((getDispStage().equals("A") && (getFillingStatus().equals("B")))){ 
						append=" AND G.ORDER_STATUS_TYPE ='35' ";	// = Added instead of IN KAUH-SCF-0183[IN:047989]			
					}
					else{
						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){
								append=" AND G.ORDER_STATUS_TYPE ='25' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								append=" AND G.ORDER_STATUS_TYPE ='30' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){
								if(this.order_date_from.equals("") && this.order_date_to.equals(""))//if condition & else block added for ML-BRU-SCF-0378[IN034797] & ML-BRU-SCF-0638 [IN:036848]
								  append=" AND G.ORDER_STATUS_TYPE IN ('10','25','30','35','56','94') "; 
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											append=" AND ( g.order_status_type IN ('10', '25', '30', '35', '94') or ( g.order_status_type ='56'  AND F.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') )) ";
										else if(!this.order_date_from.equals(""))
											append=" AND ( g.order_status_type IN ('10', '25', '30', '35', '94') or ( g.order_status_type ='56'  AND F.NEXT_COLLECTION_DATE >= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) )";
										else if(!this.order_date_to.equals(""))
											append=" AND ( g.order_status_type IN ('10', '25', '30', '35', '94') or ( g.order_status_type ='56'  AND F.NEXT_COLLECTION_DATE <= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ) ";
									}//Added MMS-DM-CRF-0228 end
									else{
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											append=" AND ( g.order_status_type IN ('10', '25', '30', '35', '94') or ( g.order_status_type ='56'  AND F.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 )) "; // Added parameters - KAUH-SCF-0183[IN:047989]
										else if(!this.order_date_from.equals(""))
											append=" AND ( g.order_status_type IN ('10', '25', '30', '35', '94') or ( g.order_status_type ='56'  AND F.NEXT_COLLECTION_DATE >= TO_DATE(?,'DD/MM/YYYY') ) )";// Added parameter - KAUH-SCF-0183[IN:047989]
										else if(!this.order_date_to.equals(""))
											append=" AND ( g.order_status_type IN ('10', '25', '30', '35', '94') or ( g.order_status_type ='56'  AND F.NEXT_COLLECTION_DATE <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) ) ";// Added parameter - KAUH-SCF-0183[IN:047989]
									}
								}
							}
							else{
								append=" AND G.ORDER_STATUS_TYPE IN ('30') ";//Removed 94 for TTM-SCF-0097 [IN:048812]
							}
						}
					}

					if(scope.equals("H")) {

						sbStagesCondition.append(" AND G.ORDER_STATUS_TYPE = '50' AND( G.ORDER_STATUS_TYPE ='50' OR A.DISCHARGE_IND='D') AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(scope.equals("EX")) {
						sbStagesCondition.append(" AND (G.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D') ");
						sbStagesCondition.append(append);
						sbStagesCondition.append(" AND A.PATIENT_CLASS IN ('XT')");
					}
					
					/*else {
						if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
						sbStagesCondition.append(append);
						sbStagesCondition.append(" AND A.PATIENT_CLASS IN ('OP','EM') ");
					}*/ //Commented for ML-MMOH-SCF-2267
					
					else {   //Modified for ML-MMOH-SCF-2267 start
						if(!add_criteria_locn_code.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbStagesCondition.append(append); // 
							sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
						}
						else{
						sbStagesCondition.append(append);
						}
						sbStagesCondition.append(" AND A.PATIENT_CLASS IN ('OP','EM') ");
					}//Modified for ML-MMOH-SCF-2267 end
				}
				else if((getDispStage().equals("D") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
					// Dispense Stage is Delivery and Filling is before Allocation

					//code added for unallocated drug findings....on 2/5/2004
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('50') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS)AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(unallocdrugs.equals("Y")) {
						sbStagesCondition.append(" AND G.ORDER_STATUS_TYPE IN('36','10','30')"); // '56' removed for 54478
						if(scope.equals("EX")){
							sbStagesCondition.append(" AND (G.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D')AND A.PATIENT_CLASS ='XT' ");
						}
						else{
							if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
							sbStagesCondition.append(" AND A.PATIENT_CLASS IN ('OP','EM')");
						}
					} 
					else {
						sbStagesCondition.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE='36' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS)");
						if(scope.equals("EX")){
							sbStagesCondition.append(" AND A.PATIENT_CLASS ='XT'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else{
							if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
							sbStagesCondition.append(" AND A.PATIENT_CLASS IN ('OP','EM')");
						}
					}
				}
				else if((getDispStage().equals("D") && getFillingStatus().equals("A"))){
					// Dispense Stage is Delivery and Filling is after Allocation

					//code added for unallocated drug findings....on 2/5/2004
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS)AND A.PATIENT_CLASS IN ('OP','EM','XT')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else {						
						sbStagesCondition.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE='35' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS)");
						if(!scope.equals("EX")){
							if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbStagesCondition.append(" AND A.SOURCE_CODE=? ");
							sbStagesCondition.append(" AND A.PATIENT_CLASS in ('OP','EM') ");
						}
						else
							sbStagesCondition.append(" AND A.PATIENT_CLASS ='XT' ");
					}
				}
				
				// This is formed dynamically depending status...
				//String bmsCheck	= "/*This condition is used for partiallty allocated order lines*/ OR ( B.ORDER_QTY>NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_LINE_NUM= B.ORDER_LINE_NUM AND ORDER_ID=A.ORDER_ID),0)) ) ";

				if(getDispStage().equals("AS")){
					sbConstructSql = new StringBuffer();
					sbAppendSql1 = new StringBuffer();
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]

					if(scope.equals("H")){
						sbAppendSql1.append(" AND A.PATIENT_CLASS in ('OP','EM','XT') ");
					}
					else if(scope.equals("EX")){
						sbAppendSql1.append(" AND A.PATIENT_CLASS ='XT' ");

					}
					else{
						sbAppendSql1.append(" AND A.PATIENT_CLASS in ('OP','EM','XT') ");//,XT Added for Internal Inc 15714
					}

					if (scope.equals("A")){			//	A --> All Prescriptions
						if (disp_regn_reqd_yn.equals("Y")){// if else Added - KAUH-SCF-0183[IN:047989]
							if(verf_combined_with_alloc.equals("C")){
								if(this.order_date_from.equals("") && this.order_date_to.equals(""))
									sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('25','30','50','56')");  //'35','36', removed for TTM-SCF-0097 [IN:048812]
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('25','30','50')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
										else if(!this.order_date_from.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('25','30','50')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
										else if(!this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('25','30','50')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'dd/mm/yyyy hh24:mi')) ");
									}//Added MMS-DM-CRF-0228 end
									else{
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('25','30','50')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
										else if(!this.order_date_from.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('25','30','50')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'DD/MM/YYYY') ) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
										else if(!this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('25','30','50')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
									}
								}
							}
							else{
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
									else if(!this.order_date_from.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
									else if(!this.order_date_to.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ) "); // Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
									else if(!this.order_date_from.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'DD/MM/YYYY') ) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
									else if(!this.order_date_to.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
								}
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){								
								if(this.order_date_from.equals("") && this.order_date_to.equals(""))//if condition & else block added for ML-BRU-SCF-0378[IN034797] & ML-BRU-SCF-0638 [IN:036848]
									sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','50','56','94')"); // A.CHILD_ORDER_YN='Y' OR A.DISCHARGE_IND='D' OR commented for MMS-Adhoc [IN:046372] //'35','36', removed for TTM-SCF-0097 [IN:048812]//Added 94 for TTM-SCF-0097 [IN:048812]
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('10','25','30','50','94')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
										else if(!this.order_date_from.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('10','25','30','50','94')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
										else if(!this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('10','25','30','50','94')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'dd/mm/yyyy hh24:mi')) ");
									}//Added MMS-DM-CRF-0228 end
									else{
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('10','25','30','50','94')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) "); // A.CHILD_ORDER_YN='Y' OR A.DISCHARGE_IND='D' OR commented for MMS-Adhoc [IN:046372]// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]//Added 94 for TTM-SCF-0097 [IN:048812]
										else if(!this.order_date_from.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('10','25','30','50','94')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'DD/MM/YYYY') ) ");// A.CHILD_ORDER_YN='Y' OR A.DISCHARGE_IND='D' OR commented for MMS-Adhoc [IN:046372]// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]//Added 94 for TTM-SCF-0097 [IN:048812]
										else if(!this.order_date_to.equals(""))
											sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('10','25','30','50','94')   OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999) ");//A.CHILD_ORDER_YN='Y' OR A.DISCHARGE_IND='D' OR commented for MMS-Adhoc [IN:046372]// Added parameter - KAUH-SCF-0183[IN:047989]//'35','36', removed for TTM-SCF-0097 [IN:048812]//Added 94 for TTM-SCF-0097 [IN:048812]
									}
								}
							}
							else{	/* above code Added for 33339  --End */	
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))//Added collectiondate for ML-BRU-SCF-1076--start
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
									else if(!this.order_date_from.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
									else if(!this.order_date_to.equals(""))//Added collectiondate for ML-BRU-SCF-1076--end
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'dd/mm/yyyy hh24:mi') ) ");
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))//Added collectiondate for ML-BRU-SCF-1076--start
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ) "); // Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
									else if(!this.order_date_from.equals(""))
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date >= TO_DATE(?,'DD/MM/YYYY') ) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
									else if(!this.order_date_to.equals(""))//Added collectiondate for ML-BRU-SCF-1076--end
										sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE IN ('30','50') OR ( ORDER_STATUS_TYPE ='56'  AND F.next_collection_date <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ) ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
								}
							}
						}
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(")");
					}
					else if (scope.equals("P")){	// P --> Pending Prescriptions
						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE nvl(A.DISCHARGE_IND,'X') !='D' and ORDER_STATUS_TYPE ='25' ");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE nvl(A.DISCHARGE_IND,'X') !='D' and ORDER_STATUS_TYPE ='30' ");
							}
						}
						else{
							
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE nvl(A.DISCHARGE_IND,'X') !='D' and ORDER_STATUS_TYPE IN('10','30','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
						}
						else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE nvl(A.DISCHARGE_IND,'X') !='D' and ORDER_STATUS_TYPE in ('30','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}							
						}
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(")");
					}
					else if (scope.equals("PD")){	// P --> Pending Prescriptions
						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS  )");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
							}
						}
						else{
							
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10','30','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in ('30','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
							}							
						}
					}
					else if (scope.equals("B")){ // B --> BMS Prescriptions										
						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){
								sbConstructSql.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
							else{
								sbConstructSql.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){
								sbConstructSql.append( " AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='56' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbConstructSql.append( " AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}
						sbConstructSql.append(sbStagesCondition.toString());
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							sbConstructSql.append(") AND F.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
						}//Added MMS-DM-CRF-0228 end
						else{
							sbConstructSql.append(") AND F.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
						}
						
					}
					else if (scope.equals("R")){	// R --> Refill Prescriptions
						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN='Y' AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10','30','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN='Y' AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in ('30','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}							
						}
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(") ");
					}
					else if (scope.equals("D")){	// D --> Discharge Medication
						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.DISCHARGE_IND='D' AND ORDER_STATUS_TYPE = '25'  ");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.DISCHARGE_IND='D' AND ORDER_STATUS_TYPE = '30'  ");
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.DISCHARGE_IND='D' AND ORDER_STATUS_TYPE IN('10','30','56','94') ");
							}
							else{
								sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.DISCHARGE_IND='D' AND ORDER_STATUS_TYPE IN('30','56','94') ");
							}							
						}
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(") ");
					}
					else if(scope.equals("H")) {
						sbConstructSql.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(")");
					}
					else if(scope.equals("EX")) {
						sbConstructSql.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10','56','50','30') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS )");// IN Added instead of OR KAUH-SCF-0183[IN:047989] // '30' added for 56916

						if (disp_regn_reqd_yn.equals("Y")){
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
							else{
								sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){ 
								sbConstructSql.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10','30','56','50','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}
							else{
								sbConstructSql.append(" AND EXISTS ( SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in ('30','56','94') AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
							}							
						}
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(")");
					}
					sbConstructSql.insert(0,sbAppendSql1);
				}
				if(getCriteriaOrderType().equals("ALL")) {
					sbConstructSql.append( " AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
				}
				else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
					sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
				} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
				else if(getOrderType().equals("NOR")) {
					sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
				} 
				else if(getOrderType().equals("IVAD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("IVAA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVWA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("IVID")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("IVIA")) {
					sbConstructSql.append( " AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("TD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
				}
				else if(getOrderType().equals("TA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
				}
				else if(getOrderType().equals("CD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
				}
				else if(getOrderType().equals("CA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
				} 
				else if(getOrderType().equals("CO")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
				}

				if(getDispStage().equals("AS")){ 
					sbDrugRelateSQL = new StringBuffer(" AND EXISTS (SELECT NULL FROM PH_ORDER_TYPE_FOR_DRUG_CLASS WHERE ORDER_TYPE_CODE = A.ORDER_TYPE_CODE) AND EXISTS (SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE != '58' ");
					if (!scope.equals("D") && !scope.equals("A")){
						sbDrugRelateSQL.append(" OR A.DISCHARGE_IND='D' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
					} 
					else {
						sbDrugRelateSQL.append(" AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
					}
				}
				if(!scope.equals("EX")&&!scope.equals("H")){
					sbConstructSql.append(" AND NVL(A.SOURCE_type,'X') = NVL(?,NVL(A.SOURCE_type,'X')) ");
				}

				if(group_by_ord_locn.equals("N")){
					if(!getDispStage().equals("AS")){
						if (!scope.equals("EX")){
							if(this.orderby.equals("DM")||this.orderby.equals("")){
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append("  and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type ");//code ', min(a.ADDED_DATE),a.source_code,PATIENT_NAME' added for ML-BRU-SCF-1352[IN049413]
								if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A")){
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
										}
									}
									else{
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
										}
									}									
								}
								else{
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									}
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									}
									
								}//added for MOHE-CRF-0158
								
								//sbConstructSql.append("ORDER BY a.source_type desc , min(a.ADDED_DATE),a.source_code,PATIENT_NAME");
								if(opCustomSortByValue.equals("")){
									sbConstructSql.append("ORDER BY a.source_type desc,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
								}
							
								else{
									sbConstructSql.append("  "+CustomSortByValueopSql.toString());//Added for ML-MMOH-CRF-1666
								}
								
								// SCF--> SRR20056-SCF-7336
								//ORDER BY a.source_type desc,min(a.ADDED_DATE),a.source_code,PATIENT_NAME";
							}
							else if(this.orderby.equals("OP")){		
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append("	AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID, PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ORDER BY a.source_type "); 
								sbConstructSql.append(", min(a.ADDED_DATE),a.source_code,PATIENT_NAME");
							}	
						}
						else{
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
							if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A")){
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									} 	
								}
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									} 	
								} 
							}
							else{
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
							}//added for MOHE-CRF-0158
						}
					}
					else{
						if (!scope.equals("EX")){
							if(this.orderby.equals("DM")||this.orderby.equals("")){			
								sbConstructSql.append(" AND A.ORDERING_FACILITY_ID=? AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type  ");
								
								if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("AS")){
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,  a.performing_deptloc_code  ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code   ");
										}  
									}
									else{
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type, a.performing_deptloc_code  ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type, a.performing_deptloc_code   ");
										}  
									}
								}
								else{
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									}
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									}
								}//added for MOHE-CRF-0158
								
								//sbConstructSql.append(", min(a.ADDED_DATE),a.source_code,PATIENT_NAME");
								// SCF--> SRR20056-SCF-7336		//ORDER BY a.source_type desc,min(a.ADDED_DATE),a.source_code,PATIENT_NAME";
								if(opCustomSortByValue.equals("")){
									sbConstructSql.append("ORDER BY a.source_type desc, min(a.ADDED_DATE),a.source_code,PATIENT_NAME");
								}
							
								else{
									sbConstructSql.append("  "+CustomSortByValueopSql.toString());//Added for ML-MMOH-CRF-1666 
								}
							}
							else if(this.orderby.equals("OP")){
								sbConstructSql.append(" AND A.ORDERING_FACILITY_ID=? AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX,c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ORDER BY a.source_type "); 
								sbConstructSql.append(", min(a.ADDED_DATE),a.source_code,PATIENT_NAME");
								// SCF--> SRR20056-SCF-7336		//ORDER BY a.source_type desc,min(a.ADDED_DATE),a.source_code,PATIENT_NAME";
							}	
						}
						else{
							sbConstructSql.append( " AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
							if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("AS")){
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}  
								}
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}  
								}
							}
							else{
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code  ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code  ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
							}//added for MOHE-CRF-0158
						
						}
					}
				}
				else{
					if(!getDispStage().equals("AS")){
						if (!scope.equals("EX")){
							if(this.orderby.equals("DM")||this.orderby.equals("")){
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type ");
								
								if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A")){
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code  ");
										} 	
									}
									else{
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
										} 	
									} 
								}
								else{
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									}
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									}
								}//added for MOHE-CRF-0158
								
								if(opCustomSortByValue.equals("")){
									sbConstructSql.append(" ORDER BY a.source_type desc,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
								}
							
								else{
									sbConstructSql.append("  "+CustomSortByValueopSql.toString());//Added for ML-MMOH-CRF-1666 
								}
							}
							else if(this.orderby.equals("OP")){		
								sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ORDER BY a.source_type ,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
							}	
						}
						else{
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
							if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A")){
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									} 
								}
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									} 
								}	
							}
							else{
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
							}//added for MOHE-CRF-0158
						}
					}
					else{
						if (!scope.equals("EX")){
							if(this.orderby.equals("DM")||this.orderby.equals("")){			
								sbConstructSql.append(" AND A.ORDERING_FACILITY_ID=? AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type");
								
								if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("AS")){
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
										} 
									}
									else{
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ");
										}//Added MMS-DM-CRF-0228 end
										else{
											sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
										} 
									}
								}
								else{
									if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									}
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									}
								}//added for MOHE-CRF-0158
								
								if(opCustomSortByValue.equals("")){
									sbConstructSql.append(" ORDER BY a.source_type desc,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
								}
							
								else{
									sbConstructSql.append(" "+CustomSortByValueopSql.toString());//Added for ML-MMOH-CRF-1666 
								}
							}
							else if(this.orderby.equals("OP")){
								sbConstructSql.append(" AND A.ORDERING_FACILITY_ID=? AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O')))");
								if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbConstructSql.append(" AND J.DRUG_YN = ? ");
								sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ORDER BY a.source_type ,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
							}	
						}
						else{
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
							if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("AS")){
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}  
								}
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
									}  
								}	
							}
							else{
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),PATIENT_NAME");
								}
							}//added for MOHE-CRF-0158
						}
					}
				}
				sbMainSql = new StringBuffer();
				if(getDispStage().equals("AS")){
					if(scope.equals("E")){ // E --> Expired Medication
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID  #,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value FROM   OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E, OR_ORDER_LINE_PH F ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID  #,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value FROM   OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E, OR_ORDER_LINE_PH F ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
						}
						//min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value added for GHL-CRF-0453
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append(" AND b.PRIORITY=? "); //changed a.priority to b.priority for SKR-SCF-1274
				    	// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID=? ");  
						sbMainSql.append(" AND (A.PATIENT_CLASS IN('OP','EM')) AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) 
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) 
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) 
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi')");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						} 	
						
						sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.PERFORMING_DEPTLOC_CODE=? AND B.END_DATE_TIME < TRUNC(SYSDATE) ");
						if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.SOURCE_CODE=? ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							sbMainSql.append(" AND C.CONTACT2_NO=? ");
						if(!getPatNationalID().equals(""))
						    sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
						sbMainSql.append(" AND  TRUNC(SYSDATE) <= TRUNC(B.END_DATE_TIME)+E.DISP_BEYOND_NO_OF_DAYS AND A.ORDER_STATUS IN ('OS','RG','DP') and j.drug_code =b.order_catalog_code");   // Added A.ORDER_STATUS IN 'DP' for BSP-SCF-0028
					} 
					else if (scope.equals("EX")) { // EX --> External Prescription
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID ,min(nvl(f.print_value,0))min_value , max(nvl(f.print_value,0))max_value   FROM   OR_ORDER_LINE B, OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E, OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID ,min(nvl(f.print_value,0))min_value , max(nvl(f.print_value,0))max_value   FROM   OR_ORDER_LINE B, OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E, OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
						}
						//min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value added for GHL-CRF-0453
						//changed a.priority to b.priority for SKR-SCF-1274
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append(" AND b.PRIORITY=? "); 
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID=? "); 
						sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (? , 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (? , 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						} 
						sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.ORDERING_FACILITY_ID=? AND A.PERFORMING_DEPTLOC_CODE=?  ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? "); 
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							sbMainSql.append(" AND C.CONTACT2_NO=? ");
						if(!getPatNationalID().equals(""))
						    sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
						sbMainSql.append(" AND G.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS and j.drug_code =b.order_catalog_code ");
						sbMainSql.append(sbDrugRelateSQL.toString());
					} 
					else {
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID  #,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value FROM   OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C, PH_FACILITY_PARAM E, OR_ORDER_LINE_PH F,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID  #,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value FROM   OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C, PH_FACILITY_PARAM E, OR_ORDER_LINE_PH F,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
						}
						//min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value added for GHL-CRF-453
						//changed a.priority to b.priority for SKR-SCF-1274
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append(" AND b.PRIORITY=? ");
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID=? ");    
						sbMainSql.append(" AND (A.PATIENT_CLASS IN('OP','EM')) AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]		
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else {
									if (!scope.equals("B"))  // !scope.equals("B") Added for BSP-SCF-0032
									sbMainSql.append("AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else {
									if (!scope.equals("B"))  // !scope.equals("B") Added for BSP-SCF-0032	
								      sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else{
									if (!scope.equals("B"))  // !scope.equals("B") Added for BSP-SCF-0032
									   sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]		
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else {
									if (!scope.equals("B"))  // !scope.equals("B") Added for BSP-SCF-0032
									sbMainSql.append("AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else {
									if (!scope.equals("B"))  // !scope.equals("B") Added for BSP-SCF-0032	
								      sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
								else{
									if (!scope.equals("B"))  // !scope.equals("B") Added for BSP-SCF-0032
									   sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
						}
						sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.PERFORMING_DEPTLOC_CODE=? "); 
						if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.SOURCE_CODE=? ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							sbMainSql.append(" AND c.CONTACT2_NO=? ");
						if(!getPatNationalID().equals(""))
						    sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
						sbMainSql.append(" and j.drug_code =b.order_catalog_code");
						sbMainSql.append(sbDrugRelateSQL.toString());
					}
					sbMainSql.append(sbAppendSql1.toString());
				}
				else{
					if(scope.equals("EX")){ // EX --> External Prescription
						//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
						String getDisp_locn_iae1="";
						if(getDisp_locn_iae().contains("@@@")){
						String name_getDisp_locn_iae[]=getDisp_locn_iae().split("@@@");
						for(String fechedname:name_getDisp_locn_iae)
						{
							getDisp_locn_iae1=getDisp_locn_iae1+fechedname+"','";
						}
						if (getDisp_locn_iae1 != null && getDisp_locn_iae1.length() >= 2) {
						getDisp_locn_iae1=getDisp_locn_iae1.substring(0, getDisp_locn_iae1.length() - 2);
						getDisp_locn_iae1=getDisp_locn_iae1.substring(2);
						}
						}else
						{
							getDisp_locn_iae1="'"+getDisp_locn_iae()+"'";
						}
						
						if(getDispStage().equals("V") &&disp_regn_reqd_yn.equals("N")) {
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID,nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) PATIENT_NAME,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO ,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value  FROM   OR_ORDER_LINE B, OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G, PH_DISP_LOCN H, PH_DRUG I ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
							}
							else{
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID,nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) PATIENT_NAME,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO ,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value  FROM   OR_ORDER_LINE B, OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G, PH_DISP_LOCN H, PH_DRUG I ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
							}
							//min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value added for GHL-CRF-453
							//changed a.priority to b.priority for SKR-SCF-1274
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append(" AND b.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
							if(!priority.trim().equals(""))
							{
						    	if(isSite_ph_new_prescription){
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND b.priority = ? ");
						    	}
						    }// if Added, RBU-GHL-CRF-0054 end
							if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.PATIENT_ID = ? ");
							if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORDER_ID=? ");    
							sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi')");
									else
										sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							} 
							if(isSite_integration_em_bd_pyxis){
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.ORDERING_FACILITY_ID=? AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") "); //modified By Himanshu Saxena for MMS-DM-CRF-0232 //a.performing_deptloc_code=?
							}else{
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.ORDERING_FACILITY_ID=? AND A.PERFORMING_DEPTLOC_CODE=? "); //modified By Himanshu Saxena for MMS-DM-CRF-0232 //a.performing_deptloc_code=?
							}
							if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
							if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.SEX = ? ");
							if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.NATIONALITY_CODE = ? "); 
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" AND G.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS and A.PERFORMING_DEPTLOC_CODE = h.DISP_LOCN_CODE AND B.ORDER_CATALOG_CODE = i.DRUG_CODE AND  h.facility_id=a.PERFORMING_FACILITY_ID AND  decode(h.DISP_VERF_STAGE,'F',i.VERIFICATION_REQD_YN,'B',i.VERIFICATION_REQD_YN,'X') = decode(h.DISP_VERF_STAGE,'F','Y','B','Y','X') and j.drug_code =b.order_catalog_code");
						}
						else{
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value   FROM   OR_ORDER_LINE B, OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
							}
							else{
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value   FROM   OR_ORDER_LINE B, OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=F.ORDER_ID AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM AND A.ORDER_ID=F.ORDER_ID ");
							}
							//min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value added for GHL-CRF-453
							//changed a.priority to b.priority for SKR-SCF-1274
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append(" AND b.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
							if(!priority.trim().equals(""))
							{
						    	if(isSite_ph_new_prescription){
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND b.priority = ? ");
						    	}
						    }// if Added, RBU-GHL-CRF-0054 end
							if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.PATIENT_ID = ? ");
							if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORDER_ID=? ");    
							sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							} 
							//modified By Himanshu Saxena for MMS-DM-CRF-0232 
							if(getDispStage().equals("V") && isSite_integration_em_bd_pyxis){
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.ORDERING_FACILITY_ID=? AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
							}else{
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH' AND A.ORDERING_FACILITY_ID=? AND A.PERFORMING_DEPTLOC_CODE=?  ");
							}
							if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
							if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.SEX = ? ");
							if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.NATIONALITY_CODE = ? "); 
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" AND G.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS and j.drug_code =b.order_catalog_code");
						}
					} 
					else {
						if(getDispStage().equals("V") ){ //commented for IN045978  &&disp_regn_reqd_yn.equals("N")
							
							//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
							String getDisp_locn_iae1="";
							if(getDisp_locn_iae().contains("@@@")){
							String name_getDisp_locn_iae[]=getDisp_locn_iae().split("@@@");
							for(String fechedname:name_getDisp_locn_iae)
							{
								getDisp_locn_iae1=getDisp_locn_iae1+fechedname+"','";
							}
							if (getDisp_locn_iae1 != null && getDisp_locn_iae1.length() >= 2) {
							getDisp_locn_iae1=getDisp_locn_iae1.substring(0, getDisp_locn_iae1.length() - 2);
							getDisp_locn_iae1=getDisp_locn_iae1.substring(2);
							}
							}else
							{
								getDisp_locn_iae1="'"+getDisp_locn_iae()+"'";
							}
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID  # FROM   OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G , PH_DISP_LOCN H, PH_DRUG I ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID  AND C.PATIENT_ID=A.PATIENT_ID  AND B.ORDER_ID=A.ORDER_ID  AND B.ORDER_ID=F.ORDER_ID  AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM  AND A.ORDER_ID=F.ORDER_ID ");
							}
							else{
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID  # FROM   OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G , PH_DISP_LOCN H, PH_DRUG I ,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID  AND C.PATIENT_ID=A.PATIENT_ID  AND B.ORDER_ID=A.ORDER_ID  AND B.ORDER_ID=F.ORDER_ID  AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM  AND A.ORDER_ID=F.ORDER_ID ");
							}
							//changed a.priority to b.priority for SKR-SCF-1274
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append(" AND b.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
							if(!priority.trim().equals(""))
							{
						    	if(isSite_ph_new_prescription){
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND b.priority = ? ");
						    	}
						    }// if Added, RBU-GHL-CRF-0054 end
							if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.PATIENT_ID = ? ");
							if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORDER_ID=? ");    
							sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
									 sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
									 sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							} 
							if(isSite_integration_em_bd_pyxis){
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH'  AND A.ORDERING_FACILITY_ID=? AND  A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+")  ");
							}else
							{
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH'  AND A.ORDERING_FACILITY_ID=? AND  A.PERFORMING_DEPTLOC_CODE=?  ");
							}
							if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
							if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.SEX = ? ");
							if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.NATIONALITY_CODE = ? "); 
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" AND  G.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND B.ORDER_CATALOG_CODE = i.DRUG_CODE AND  h.facility_id=a.PERFORMING_FACILITY_ID	and  a.performing_deptloc_code =h.disp_locn_code and decode(h.DISP_VERF_STAGE,'F',i.VERIFICATION_REQD_YN,'B',i.VERIFICATION_REQD_YN,'X') = decode(h.DISP_VERF_STAGE,'F','Y','B','Y','X')   and j.drug_code =b.order_catalog_code");
						}
						else{
							
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID  #,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID  AND C.PATIENT_ID=A.PATIENT_ID  AND B.ORDER_ID=A.ORDER_ID  AND B.ORDER_ID=F.ORDER_ID  AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM  AND A.ORDER_ID=F.ORDER_ID ");
							}
							else{
								sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,SEX, c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO,to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME, a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID  #,min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , PH_FACILITY_PARAM E,OR_ORDER_LINE_PH F,OR_ORDER_STATUS_CODE G,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID  AND C.PATIENT_ID=A.PATIENT_ID  AND B.ORDER_ID=A.ORDER_ID  AND B.ORDER_ID=F.ORDER_ID  AND B.ORDER_LINE_NUM=F.ORDER_LINE_NUM  AND A.ORDER_ID=F.ORDER_ID ");
							}
							//min(nvl(f.print_value,0))min_value,max(nvl(f.print_value,0))max_value added for GHL-CRF-453
							//changed a.priority to b.priority for SKR-SCF-1274
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append(" AND b.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
							if(!priority.trim().equals(""))
							{
						    	if(isSite_ph_new_prescription){
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (b.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
						    	else
						    	sbMainSql.append(" and (b.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND b.priority = ? ");
						    	}
						    }// if Added, RBU-GHL-CRF-0054 end
							if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.PATIENT_ID = ? ");
							if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORDER_ID=? ");   
							sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_from.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if (!order_date_to.equals("")){// else if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							} 
							sbMainSql.append(" AND A.ORDER_CATEGORY='PH'  AND A.ORDERING_FACILITY_ID=? AND A.PERFORMING_DEPTLOC_CODE=? ");
							if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
							if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.SEX = ? ");
							if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND C.NATIONALITY_CODE = ? "); 
							if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
							    sbMainSql.append(" AND c.CONTACT2_NO=? ");
							if(!getPatNationalID().equals(""))
						        sbMainSql.append(" AND C.NATIONAL_ID_NO=? ");//Adding end for TH-KW-CRF-0014
							sbMainSql.append(" AND  G.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS and j.drug_code =b.order_catalog_code ");
						}
					}
					if(sbDrugRelateSQL!=null)
						sbMainSql.append(sbDrugRelateSQL.toString());
					sbMainSql.append(sbStagesCondition.toString());
				}
				sbMainSql.append(sbConstructSql.toString());

				if(!scope.equals("EX")){
					sbMainSql = replaceLocnQuery(sbMainSql.toString(), sbLocationSql.toString());
				}
//				System.err.println("======OP Without Token=======PATIENT Search=========sbMainSql="+sbMainSql);
//				System.err.println("BMS QUERY==========7797=========sbMainSql="+sbMainSql);
				pstmt = connection.prepareStatement(sbMainSql.toString());		
				int iCount=1;
				if(scope.equals("EX")){ 
					pstmt.setString(iCount++,getLanguageId());
					//if(!getDispStage().equals("V") && disp_regn_reqd_yn.equals("Y"))//added for ml-mmoh-scf-1433 //Commented for ML-BRU-SCF-2068
					 pstmt.setString(iCount++,getLanguageId());//Added GHL-SCF-0830 [IN:049943] and commented for ML-MMOH-SCF-1433
					if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,priority);
					if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,patient_id);
					if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,order_id);//order_id Added for JD-CRF-0181 [IN:40699]
					pstmt.setString(iCount++,login_facility_id);
					pstmt.setString(iCount++,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(iCount++,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(iCount++,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(iCount++,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,order_date_from);
						pstmt.setString(iCount++,order_date_to);
					}
					else if(!order_date_from.equals(""))
						pstmt.setString(iCount++,order_date_from);
					else if(!order_date_to.equals("")) 
						pstmt.setString(iCount++,order_date_to);
					pstmt.setString(iCount++,this.orderingfacility);
					if(isSite_integration_em_bd_pyxis) //modified by Himanshu for MMS-DM-CRF-0232
					{
						if(!getDispStage().trim().equals("V"))
						pstmt.setString(iCount++,getDispLocnCode());
						
					}else
					{
						pstmt.setString(iCount++,getDispLocnCode());
					}
					if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,add_criteria_practitioner_id);
					if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,this.getGender());
					if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,add_criteria_nat_code);
						System.err.println("getPatMobileNo@@@===="+getPatMobileNo());
					if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						pstmt.setString(iCount++,getPatMobileNo());
					if(!getPatNationalID().equals(""))
						pstmt.setString(iCount++,getPatNationalID());//Adding end for TH-KW-CRF-0014
						
					//pstmt.setString(iCount++,getLanguageId());//Commented GHL-SCF-0830 [IN:049943]
					if (!(getDispStage().equals("AS") ||getDispStage().equals("D")||getDispStage().trim().equals("F") ||getDispStage().trim().equals("A") ) && !disp_regn_reqd_yn.equals("Y") && verf_combined_with_alloc.equals("C")){//Added for INC#49585--start
						if(!order_date_from.equals("") && !order_date_to.equals("")){
						pstmt.setString(iCount++,order_date_from);
						pstmt.setString(iCount++,order_date_to);
					}
					else if(!order_date_from.equals(""))
						pstmt.setString(iCount++,order_date_from);
					else if(!order_date_to.equals("")) 
						pstmt.setString(iCount++,order_date_to);
					
					}
					else if(getDispStage().trim().equals("F")  && !getFillingStatus().equals("A") && !disp_regn_reqd_yn.equals("Y") && verf_combined_with_alloc.equals("C")){
						if(!order_date_from.equals("") && !order_date_to.equals("")){
							pstmt.setString(iCount++,order_date_from);
							pstmt.setString(iCount++,order_date_to);
						}
						else if(!order_date_from.equals(""))
							pstmt.setString(iCount++,order_date_from);
						else if(!order_date_to.equals("")) 
							pstmt.setString(iCount++,order_date_to);
					}
					
					else if(getDispStage().trim().equals("A") && (getFillingStatus().equals("A") || getFillingStatus().equals("X")) && !disp_regn_reqd_yn.equals("Y") && verf_combined_with_alloc.equals("C")){
						if(!order_date_from.equals("") && !order_date_to.equals("")){
							pstmt.setString(iCount++,order_date_from);
							pstmt.setString(iCount++,order_date_to);
						}
						else if(!order_date_from.equals(""))
							pstmt.setString(iCount++,order_date_from);
						else if(!order_date_to.equals("")) 
							pstmt.setString(iCount++,order_date_to);
					}//Added for INC#49585--end
					pstmt.setString(iCount++,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,this.drug_medical);
					pstmt.setString(iCount++,this.exclude_PRN_orders);
					pstmt.setString(iCount++,login_facility_id);	//Added parameter for KAUH-SCF-0183  
					pstmt.setString(iCount++,login_by_id);			//Added parameter for KAUH-SCF-0183
					System.err.println("getDispGenralDrug@@==="+getDispGenralDrug()+"getDispNarcoDrug===="+getDispNarcoDrug()+"getDispControlDrug==="+getDispControlDrug());
					pstmt.setString(iCount++,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(iCount++,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(iCount++,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					if(PH_OP_MEDICATION_ORD_DISP==true && (getDispStage().equals("A") || getDispStage().equals("AS"))){ // (getDispStage().equals("A") || getDispStage().equals("AS")) brackets added for 56916
				    	pstmt.setString(iCount++,order_date_from);
						pstmt.setString(iCount++,order_date_to);
					}
					else{
						pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
						pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
					}//added for MOHE-CRF-0158
				} 
				else if( getDispStage().equals("AS") ){
					if(scope.equals("B")){
						pstmt.setString(iCount++,getLanguageId());
						pstmt.setString(iCount++,getLanguageId());
						if(excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")){//Added for ML-MMOH-CRF-2085
							pstmt.setString(iCount++,getLanguageId());
							pstmt.setString(iCount++,getLanguageId());//Added GHL-SCF-0830 [IN:049943]	
						}
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,priority);
						if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							{System.err.println("BMS QUERY==========7871======iCount==="+iCount+"=patient_id"+patient_id);
							pstmt.setString(iCount++,patient_id);
						
							}
						if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						{	System.err.println("BMS QUERY==========7886======iCount==="+iCount+"=order_id"+order_id);
							pstmt.setString(iCount++,order_id);// order_id Added for JD-CRF-0181 [IN:40699]
						}
						System.err.println("BMS QUERY==========7888======iCount==="+iCount+"=login_facility_id"+login_facility_id);
						pstmt.setString(iCount++,login_facility_id);
						pstmt.setString(iCount++,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(iCount++,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(iCount++,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(iCount++,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						// if Added - BSP-SCF-0028 START
					 /*	if(!order_date_from.equals("")){  // if else condition commented for BSP-SCF-0032
							
							pstmt.setString(iCount++,order_date_from);
							}
						else{
							pstmt.setString(iCount++,"");
						} */
						System.err.println("BMS QUERY==========7899======iCount==="+iCount+"=order_date_from"+order_date_from);
						/*if(!order_date_to.equals("")){ // if else condition commented for BSP-SCF-0032
							
							pstmt.setString(iCount++,order_date_to);
						}
						else{
							pstmt.setString(iCount++,"");
						} */
						System.err.println("BMS QUERY==========7907======iCount==="+iCount+"=order_date_to"+order_date_to);
						// if Added - BSP-SCF-0028 END
						
						
						//pstmt.setString(iCount++,"");
						//pstmt.setString(iCount++,"");  
						pstmt.setString(iCount++,getDispLocnCode());
						System.err.println("BMS QUERY==========7915======iCount==="+iCount+"=getDispLocnCode"+getDispLocnCode());
						if(!add_criteria_locn_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							{System.err.println("BMS QUERY==========7916======iCount==="+iCount+"=add_criteria_locn_code"+add_criteria_locn_code);
							pstmt.setString(iCount++,add_criteria_locn_code);
							}
						if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							{System.err.println("BMS QUERY==========7920======iCount==="+iCount+"=add_criteria_practitioner_id"+add_criteria_practitioner_id);
							pstmt.setString(iCount++,add_criteria_practitioner_id);
							}
						if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							{System.err.println("BMS QUERY==========7924======iCount==="+iCount+"=getGender"+this.getGender());
							pstmt.setString(iCount++,this.getGender());
							}
						if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							{System.err.println("BMS QUERY==========7929======iCount==="+iCount+"=add_criteria_nat_code"+add_criteria_nat_code);
							pstmt.setString(iCount++,add_criteria_nat_code);
							}
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						    pstmt.setString(iCount++,getPatMobileNo());
						if(!getPatNationalID().equals(""))
						    pstmt.setString(iCount++,getPatNationalID());//Adding end for TH-KW-CRF-0014
						
						//pstmt.setString(iCount++,getLanguageId()); //Commented GHL-SCF-0830 [IN:049943]
						if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
							System.err.println("BMS QUERY==========7932======iCount==="+iCount+"=order_date_from"+order_date_from);
							pstmt.setString(iCount++,order_date_from);
							System.err.println("BMS QUERY==========7934======iCount==="+iCount+"=order_date_to"+order_date_to);
							pstmt.setString(iCount++,order_date_to);
							
							
						}
						else if(!order_date_from.equals(""))
							{System.err.println("BMS QUERY==========7939======iCount==="+iCount+"=order_date_from"+order_date_from);
							pstmt.setString(iCount++,order_date_from);
							}
						else if(!order_date_to.equals("")) 
							{System.err.println("BMS QUERY==========7943======iCount==="+iCount+"=order_date_to"+order_date_to);
							pstmt.setString(iCount++,order_date_to);
							}
						System.err.println("BMS QUERY==========7945======iCount==="+iCount+"=ordlocntype"+ordlocntype);
						pstmt.setString(iCount++,ordlocntype.trim());
						System.err.println("BMS QUERY==========7947======iCount==="+iCount+"=orderingfacility"+orderingfacility);
						pstmt.setString(iCount++,this.orderingfacility);
						System.err.println("BMS QUERY==========7950======iCount==="+iCount+"=sFreqDurnAbsOrderFlag"+sFreqDurnAbsOrderFlag);
						pstmt.setString(iCount++,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							{System.err.println("BMS QUERY==========7953======iCount==="+iCount+"=drug_medical"+drug_medical);
							pstmt.setString(iCount++,this.drug_medical);
							}
						System.err.println("BMS QUERY==========7956======iCount==="+iCount+"=exclude_PRN_orders"+this.exclude_PRN_orders);
						pstmt.setString(iCount++,this.exclude_PRN_orders);
						System.err.println("BMS QUERY==========7871======iCount==="+iCount+"=login_facility_id"+login_facility_id);
						pstmt.setString(iCount++,login_facility_id);	//Added parameter for KAUH-SCF-0183  
						System.err.println("BMS QUERY==========7960======iCount==="+iCount+"=login_by_id"+login_by_id);
						pstmt.setString(iCount++,login_by_id);			//Added parameter for KAUH-SCF-0183
						System.err.println("BMS QUERY==========7962======iCount==="+iCount+"=login_facility_id"+login_facility_id);
						pstmt.setString(iCount++,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispControlDrug());//Added for Performance Issue by chandra 17072022
						 if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("AS")){
						    	pstmt.setString(iCount++,order_date_from);
								pstmt.setString(iCount++,order_date_to);
							}
							else{
								pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
								System.err.println("BMS QUERY==========7964======iCount==="+iCount+"=login_facility_id"+login_facility_id);
								pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
							}//added for MOHE-CRF-0158
						
					}
					else{
						pstmt.setString(iCount++,getLanguageId());
						pstmt.setString(iCount++,getLanguageId());
						if(excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")){//Added for ML-MMOH-CRF-2085
							pstmt.setString(iCount++,getLanguageId());
							pstmt.setString(iCount++,getLanguageId());//Added GHL-SCF-0830 [IN:049943]	
						}
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,priority);
						if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,patient_id.trim());
						if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,order_id);// order_id Added for JD-CRF-0181 [IN:40699]
						pstmt.setString(iCount++,login_facility_id);
						pstmt.setString(iCount++,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(iCount++,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(iCount++,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(iCount++,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,order_date_from);
							pstmt.setString(iCount++,order_date_to);
						}
						else if(!order_date_from.equals(""))
							pstmt.setString(iCount++,order_date_from);
						else if(!order_date_to.equals("")) 
							pstmt.setString(iCount++,order_date_to);
						pstmt.setString(iCount++,getDispLocnCode());// Removed trim() - KAUH-SCF-0183[IN:047989]
						if(!add_criteria_locn_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,add_criteria_locn_code);
						if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,add_criteria_practitioner_id);
						if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,this.getGender());
						if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,add_criteria_nat_code);
						if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						    pstmt.setString(iCount++,getPatMobileNo());
						if(!getPatNationalID().equals(""))
						    pstmt.setString(iCount++,getPatNationalID());//Adding end for TH-KW-CRF-0014
						
						//pstmt.setString(iCount++,getLanguageId()); //Commneted GHL-SCF-0830 [IN:049943]
						if(scope.equals("A")){// if Added - KAUH-SCF-0183[IN:047989]
							if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
								pstmt.setString(iCount++,order_date_from);// Added parameter - KAUH-SCF-0183[IN:047989]
								pstmt.setString(iCount++,order_date_to);// Added parameter - KAUH-SCF-0183[IN:047989]
							}
							else if(!this.order_date_from.equals(""))
								pstmt.setString(iCount++,order_date_from);// Added parameter - KAUH-SCF-0183[IN:047989]
							else if(!this.order_date_to.equals(""))
								pstmt.setString(iCount++,order_date_to);// Added parameter - KAUH-SCF-0183[IN:047989]
						}
						if(!scope.equals("H"))
							pstmt.setString(iCount++,ordlocntype.trim());
						pstmt.setString(iCount++,this.orderingfacility);
						pstmt.setString(iCount++,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,this.drug_medical);
						pstmt.setString(iCount++,this.exclude_PRN_orders);
						pstmt.setString(iCount++,login_facility_id);	//Added parameter for KAUH-SCF-0183  
						pstmt.setString(iCount++,login_by_id);			//Added parameter for KAUH-SCF-0183
						pstmt.setString(iCount++,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispControlDrug());//Added for Performance Issue by chandra 17072022

					    if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("AS")){
					    	pstmt.setString(iCount++,order_date_from);
							pstmt.setString(iCount++,order_date_to);
						}
						else{
							pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
							pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
						}//added for MOHE-CRF-0158
					}
				}
				else{
					pstmt.setString(iCount++,getLanguageId());
					pstmt.setString(iCount++,getLanguageId());
					if(excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")){//Added for ML-MMOH-CRF-2085
						pstmt.setString(iCount++,getLanguageId());
						pstmt.setString(iCount++,getLanguageId());//Added GHL-SCF-0830 [IN:049943]	
					}
					if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,priority);
					if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,patient_id);
					if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,order_id);//order_id Added for JD-CRF-0181 [IN:40699]
					pstmt.setString(iCount++,login_facility_id);
					pstmt.setString(iCount++,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(iCount++,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(iCount++,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(iCount++,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,order_date_from);// Removed trim() - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,order_date_to);// Removed trim() - KAUH-SCF-0183[IN:047989]
					}
					else if(!order_date_from.equals(""))
						pstmt.setString(iCount++,order_date_from);
					else if(!order_date_to.equals("")) 
						pstmt.setString(iCount++,order_date_to);
					pstmt.setString(iCount++,this.orderingfacility);
					if(isSite_integration_em_bd_pyxis) //modified by Himanshu for MMS-DM-CRF-0232
					{
						if(!getDispStage().trim().equals("V"))
						pstmt.setString(iCount++,getDispLocnCode());
						
					}else
					{
						pstmt.setString(iCount++,getDispLocnCode());
					}
					if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,add_criteria_practitioner_id);
					if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,this.getGender());
					if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(iCount++,add_criteria_nat_code);
					if(!getPatMobileNo().equals(""))//added for TH-K-CRF-0014
						pstmt.setString(iCount++,getPatMobileNo());
					if(!getPatNationalID().equals(""))
						pstmt.setString(iCount++,getPatNationalID());//Adding end for TH-KW-CRF-0014
					
					//pstmt.setString(iCount++,getLanguageId());//Commented GHL-SCF-0830 [IN:049943]
					if( (getDispStage().equals("A") && (getFillingStatus().equals("A") || getFillingStatus().equals("X")))||(getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){// if Added - KAUH-SCF-0183[IN:047989]
						if(disp_regn_reqd_yn.equals("N") && verf_combined_with_alloc.equals("C") && !scope.equals("H")){//!scope.equals("H") added for ML-MMOH-SCF-1898
							if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
								pstmt.setString(iCount++,order_date_from);
								pstmt.setString(iCount++,order_date_to);
							}	
							else if(!this.order_date_from.equals(""))
								pstmt.setString(iCount++,order_date_from);
							else if(!this.order_date_to.equals(""))
								pstmt.setString(iCount++,order_date_to);
						}
					}
					if(!scope.equals("H")){
						if(!add_criteria_locn_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,add_criteria_locn_code);// SOURCE_CODE 
						pstmt.setString(iCount++,ordlocntype.trim());//SOURCE_type
						pstmt.setString(iCount++,sFreqDurnAbsOrderFlag);//calc_dosg_by_freq_durn_yn	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,this.drug_medical);
						pstmt.setString(iCount++,this.exclude_PRN_orders);
						pstmt.setString(iCount++,login_facility_id);	//Added parameter for KAUH-SCF-0183  
						pstmt.setString(iCount++,login_by_id);			//Added parameter for KAUH-SCF-0183
						pstmt.setString(iCount++,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispControlDrug());//Added for Performance Issue by chandra 17072022

					}
					else{
						pstmt.setString(iCount++,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(iCount++,this.drug_medical);
						pstmt.setString(iCount++,this.exclude_PRN_orders);
						pstmt.setString(iCount++,login_facility_id);	//Added parameter for KAUH-SCF-0183  
						pstmt.setString(iCount++,login_by_id);			//Added parameter for KAUH-SCF-0183
						pstmt.setString(iCount++,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(iCount++,getDispControlDrug());//Added for Performance Issue by chandra 17072022

					}
					if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A")){//added for MOHE-CRF-0158
						pstmt.setString(iCount++,order_date_from);
						pstmt.setString(iCount++,order_date_to);
					}
					else{
						pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
						pstmt.setString(iCount++,login_facility_id);		//Added parameter for MOD Performance tuning 
					}
				}
			}
			else if (disp_locn_catg.equals("O") && issue_token_on_regn_yn.equals("Y")){ // Dispense Location Category is OutPatient and Issue Token is Applicable
				sbAppendSql1 = new StringBuffer();
				sbStagesCondition = new StringBuffer();
				if(getDispStage().equals("AS")){
					// Dispense Stage --> All Stages
					sbStagesCondition.append(" AND B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
					if(scope.equals("H")){
						sbAppendSql1.append(" AND A.PATIENT_CLASS in ('OP','EM','XT')");
					}
					else if(scope.equals("EX")){
						sbAppendSql1.append(" AND A.PATIENT_CLASS ='XT'");
					}
					else{
						sbAppendSql1.append(" AND A.PATIENT_CLASS in ('OP','EM','XT')");//,XT Added for Internal Inc 15714
					}
				}
				else if(getDispStage().equals("V")){
					// Verification Stage
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND (E.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D') AND E.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS AND E.ORDER_STATUS_TYPE ='50'AND A.PATIENT_CLASS in ('OP','EM','XT') ");
					} 
					else {						
						sbStagesCondition.append(" AND E.ORDER_STATUS_TYPE ='25' AND E.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
						if(scope.equals("EX")){
							sbStagesCondition.insert(0," AND (E.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D')AND A.PATIENT_CLASS= 'XT'");
						} 
						else{
							sbStagesCondition.append(" AND A.PATIENT_CLASS in ('OP','EM','XT')");
						} 
					}
				}
				else if((getDispStage().equals("A") && getFillingStatus().equals("A")) || (getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
					/*	Allocation Stage and Allocation is after Filling
											or
						Filling Stage and Filling is before Allocation	*/
					if( getDispStage().equals("F") && getFillingStatus().equals("X")){
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') AND A.PATIENT_CLASS in ('OP','EM','XT')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(verf_combined_with_alloc.equals("C")){
							if(scope.equals("EX")){
								sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25') AND A.PATIENT_CLASS ='XT'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25') AND A.PATIENT_CLASS in ('OP','EM','XT')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						} 
						else {
							if(scope.equals("EX")){
								sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30') AND A.PATIENT_CLASS ='XT' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30') AND A.PATIENT_CLASS in ('OP','EM','XT') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}	
					}
					else if(getDispStage().equals("A") && getFillingStatus().equals("A")){
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') AND A.PATIENT_CLASS in ('OP','EM','XT')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else {
							String append="";
							if(scope.equals("EX")){
								append=" AND A.PATIENT_CLASS ='XT' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								append=" AND A.PATIENT_CLASS in ('OP','EM','XT') ";
							}
							if(verf_combined_with_alloc.equals("C")){
								sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25') "+append);// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30') "+append);// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}			
					}
					else if( getDispStage().equals("F") && getFillingStatus().equals("B")){
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') AND A.PATIENT_CLASS in ('OP','EM','XT')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else {
							if(scope.equals("EX")) {
								if(verf_combined_with_alloc.equals("C")){
									sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','56')) AND A.PATIENT_CLASS ='XT' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								}
								else{
									sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '30') AND A.PATIENT_CLASS ='XT' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								}
							}
							else{
							if(verf_combined_with_alloc.equals("C")){
								sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','56')) AND A.PATIENT_CLASS in ('OP','EM','XT') ");
								}
								else{
									sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '30')AND A.PATIENT_CLASS in ('OP','EM','XT') ");
								}
							}
						}
					}
				}
				else if((getDispStage().equals("F") && getFillingStatus().equals("A"))){
					// Dispense Stage is Filling and Filling is after Allocation
					if(scope.equals("H")) {
						sbStagesCondition.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') AND A.PATIENT_CLASS in ('OP','EM','XT')");
					}
					else if(scope.equals("EX")){
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='36') AND A.PATIENT_CLASS ='XT' ");
					}
					else {
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='36') AND A.PATIENT_CLASS in ('OP','EM','XT') ");
					}
				}
				else if((getDispStage().equals("A") && (getFillingStatus().equals("B")||getFillingStatus().equals("X")))){
					// Dispense Stage is Allocation and Filling is before Allocation
					String append="";
					if((getDispStage().equals("A") && getFillingStatus().equals("B"))){
						append=" AND E.ORDER_STATUS_TYPE ='35' ";
					}
					else if((getDispStage().equals("A") && getFillingStatus().equals("X"))){
						if(verf_combined_with_alloc.equals("C")){
						append=" AND E.ORDER_STATUS_TYPE IN('25','30') ";
						}
						else{
						append=" AND E.ORDER_STATUS_TYPE ='30' ";
						}
					} 

					if(scope.equals("H")) {
						sbStagesCondition.append(" AND (E.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D') AND E.ORDER_STATUS_TYPE ='50' AND E.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS AND A.PATIENT_CLASS in ('OP','EM','XT')");
					} 
					else{
						sbStagesCondition.append(append +" AND E.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ");
						if(scope.equals("EX")){
							sbStagesCondition = new StringBuffer(" AND (E.ORDER_STATUS_TYPE != '58' OR A.DISCHARGE_IND='D') AND E.ORDER_STATUS_CODE = B.ORDER_LINE_STATUS "+ append +" AND A.PATIENT_CLASS = 'XT' ");
						}
						else{
							sbStagesCondition.append( " AND A.PATIENT_CLASS in ('OP','EM','XT') ");
						}
					}
				}
				else if((getDispStage().equals("D") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
					// Dispense Stage is Delivery and Filling is before Allocation
					if(scope.equals("H")) {
						sbStagesCondition=new StringBuffer(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '50')");
					} 
					else {
						sbStagesCondition=new StringBuffer(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '36')");
						if(scope.equals("EX")){
							sbStagesCondition.append( " AND A.PATIENT_CLASS= 'XT'");
						}
						else{
							sbStagesCondition.append( " AND A.PATIENT_CLASS in ('OP','EM','XT')");
						}
					}					
				}
				else if((getDispStage().equals("D") && getFillingStatus().equals("A"))){
					sbStagesCondition = new StringBuffer();
					//Dispense Stage is Delivery and Filling is after Allocation
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '50')");
					}
					else {
						sbStagesCondition.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '35')");
					}
					if(scope.equals("EX")){
						sbStagesCondition.append(" AND A.PATIENT_CLASS= 'XT'");
					}
					else{
						sbStagesCondition.append(" AND A.PATIENT_CLASS in ('OP','EM','XT')");
					}					
				}
				
				// This is formed dynamically depending status...
			//	String strAppend = ""; Removed for IN063877
				String strappend1 =""; 
				String strappend3 ="";
				sbConstructSql = new StringBuffer();

				if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
					sbConstructSql.append(" AND b.end_date_time >=  SYSDATE  ");   //Modified for ML-MMOH-SCF-0393 [IN:060238]
				if(getDispStage().equals("AS")){
					if(!scope.equals("H") && !add_criteria_locn_code.equals("")) {// !add_criteria_locn_code.equals("") Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						strappend1=" AND A.SOURCE_CODE = ? ";
					}
					if(verf_combined_with_alloc.equals("C")){
						strappend3=" ORDER_STATUS_TYPE = '25' ";
					}
					else{
						strappend3=" ORDER_STATUS_TYPE = '30' )";
					}
					if (scope.equals("A")){				//	A --> All Prescriptions
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','50','56') "); // A.CHILD_ORDER_YN='Y' OR A.DISCHARGE_IND='D' OR commented for MMS-Adhoc [IN:046372] //'35','36', removed for TTM-SCF-0097 [IN:048812]
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(") AND B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
					}
					else if (scope.equals("P")){		//	P --> Pending Prescriptions
						sbConstructSql.append(" and A.CHILD_ORDER_YN!='Y' and B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbConstructSql.append(strappend3+ sbStagesCondition.toString()+")");
					}
					else if (scope.equals("B")){		//	B --> BMS Prescriptions
						sbConstructSql.append(" and A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(sbStagesCondition.toString());
						//sbConstructSql.append(")");
						sbConstructSql.append(" AND B.ORDER_QTY>NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL WHERE ORDER_LINE_NO= B.ORDER_LINE_NUM AND ORDER_ID=A.ORDER_ID),B.ORDER_QTY) ");/*This condition is used for partiallty allocated order lines*/
					}
					else if (scope.equals("R")){		//	R --> Refill Prescriptions
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.CHILD_ORDER_YN='Y' AND ");
						sbConstructSql.append(strappend3);
					}
					else if (scope.equals("D")){		//	D --> Discharge Medication
						sbConstructSql.append( " AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE (");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(") AND A.DISCHARGE_IND='D'");
					} 
					else if(scope.equals("H")) {
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '50'");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(")");
					}
				}
				if(getCriteriaOrderType().equals("ALL")) {
					sbConstructSql.append( " AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
				}
				else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
					sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
				} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
				else if(getOrderType().equals("NOR")) {
					sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
				} 
				else if(getOrderType().equals("IVAD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("IVAA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVWA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVID")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("IVIA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("TD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
				}
				else if(getOrderType().equals("TA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
				}
				else if(getOrderType().equals("CD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
				}
				else if(getOrderType().equals("CA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
				}
				else if(getOrderType().equals("CO")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
				}
				if(!scope.equals("EX")&&!scope.equals("H")){
					if(getDispStage().equals("AS") && !ordlocntype.equals("")){
						sbConstructSql.append(" AND NVL(A.SOURCE_type,'X') = NVL(?,NVL(A.SOURCE_type,'X')) ");
					}
					else{
						if(!add_criteria_locn_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(" AND A.SOURCE_CODE = ? ");
						if(!ordlocntype.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(" AND A.SOURCE_type = ? ");
					}
				}
				if(group_by_ord_locn.equals("Y")){
					if (!scope.equals("EX")){			
						if(this.orderby.equals("DM")||this.orderby.equals("")){
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code,  C.NATIONAL_ID_NO, a.source_type ");	
							if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A") || getDispStage().equals("AS")){
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									} 
								}
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									} 
								}
							}
							else{
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
								}
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
								}
							}//added for MOHE-CRF-0158
							if(opCustomSortByValue.equals("")){
								sbConstructSql.append(" ORDER BY a.source_type desc,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
							}
						
							else{
								sbConstructSql.append("  "+CustomSortByValueopSql.toString());//Added for ML-MMOH-CRF-1666 
							}
						
						}
						else if(this.orderby.equals("OP")){
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH, SEX, c.nationality_code,  C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ORDER BY a.source_type ,a.source_code,min(a.ADDED_DATE),PATIENT_NAME");
						}	
					}
					else{
						sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
						//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
						if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A") || getDispStage().equals("AS")){
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
								}//Added MMS-DM-CRF-0228 end
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
								} 	
							}
							else{
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
								}//Added MMS-DM-CRF-0228 end
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
								} 	
							}	 
						}
						else{
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
							}
							else{
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX, c.nationality_code, C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY min(a.ADDED_DATE),A.PATIENT_ID");
							}
						}//added for MOHE-CRF-0158
					}
				}
				else{
					if (!scope.equals("EX")){			
						if(this.orderby.equals("DM")||this.orderby.equals("")){
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX,c.nationality_code,C.NATIONAL_ID_NO, a.source_type ");
							//sbConstructSql.append(", TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ,a.source_code,PATIENT_NAME");
								// SCF--> SRR20056-SCF-7336		//ORDER BY a.source_type desc,min(a.ADDED_DATE),a.source_code,PATIENT_NAME";
							if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A") || getDispStage().equals("AS")){
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code   ");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
									} 	
								}
								else{
									if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code   ");
									}//Added MMS-DM-CRF-0228 end
									else{
										sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
									} 	
								} 
							}
							else{
								if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.performing_deptloc_code  ");
								}
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME,PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX, c.nationality_code ,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code  ");
								}
							}//added for MOHE-CRF-0158
							
							if(opCustomSortByValue.equals("")){
								sbConstructSql.append(" ORDER BY a.source_type desc , TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ,a.source_code,PATIENT_NAME");
							}
						
							else{
								sbConstructSql.append(" "+CustomSortByValueopSql.toString());//Added for ML-MMOH-CRF-1666 
							}
							
						}
						else if(this.orderby.equals("OP")){
							sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.source_code,a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH,SEX,c.nationality_code,C.NATIONAL_ID_NO, a.source_type,a.performing_deptloc_code ORDER BY a.source_type , TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ,a.source_code,PATIENT_NAME");
						}	
					}
					else{
						sbConstructSql.append(" AND ( j.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',j.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" AND J.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
						//sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi'), A.PATIENT_ID");
						if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A") || getDispStage().equals("AS")){
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ASC, A.PATIENT_ID");
								}//Added MMS-DM-CRF-0228 end
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ASC, A.PATIENT_ID");
								} 
							}
							else{
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ASC, A.PATIENT_ID");
								}//Added MMS-DM-CRF-0228 end
								else{
									sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi') ASC, A.PATIENT_ID");
								} 
							}		 
						}
						else{
							if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi'), A.PATIENT_ID");
							}
							else{
								sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,J.DRUG_CODE,J.DRUG_CLASS,?,?,?) = 'Y' and a.ord_date_time between (select sysdate- nvl(disp_beyond_no_of_days, 1) from ph_facility_param where facility_id = ?) and (select sysdate + nvl(disp_before_no_of_days,1) from ph_facility_param where facility_id = ?) GROUP BY a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID, A.PATIENT_ID,PATIENT_NAME, PATIENT_NAME_LOC_LANG,  DATE_OF_BIRTH,SEX, c.nationality_code,C.NATIONAL_ID_NO,a.performing_deptloc_code ORDER BY TO_date (RELEASE_DATE_TIME, 'dd/mm/yyyy hh24:mi'), A.PATIENT_ID");
							}
						}//added for MOHE-CRF-0158
					}
				}
				sbDrugRelateSQL = new StringBuffer();			
				//to be removed after changing All Stages queries
				if(getDispStage().equals("AS")){
					sbDrugRelateSQL.append(" AND EXISTS (SELECT NULL FROM PH_ORDER_TYPE_FOR_DRUG_CLASS WHERE ORDER_TYPE_CODE = A.ORDER_TYPE_CODE) AND EXISTS (SELECT NULL FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE != '58' ");
					if (!scope.equals("D") && !scope.equals("A")){	
						sbDrugRelateSQL.append( " OR A.DISCHARGE_IND='D' AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
					}
					else {	
						sbDrugRelateSQL.append(" AND ORDER_STATUS_CODE = B.ORDER_LINE_STATUS ) ");
					}
				}
	
				sbMainSql = new StringBuffer();
				String sort_token_series_ind = getSortTokenSeriesInd();
				if(getDispStage().equals("AS")){
					if(scope.equals("EX")){
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC ,c.NATIONAL_ID_NO, a.ordering_facility_id, A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID ") ;//added , a.ordering_facility_id for  ML-BRU-SCF-0542 [IN:036182]
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC ,c.NATIONAL_ID_NO, a.ordering_facility_id, A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID ") ;//added , a.ordering_facility_id for  ML-BRU-SCF-0542 [IN:036182]
						}
						//changed a.priority to b.priority for SKR-SCF-1274
						if(sort_token_series_ind.equals("R")) //Added for HSA-CRF-0136 [IN:048412] -start
							sbMainSql.append(",to_char(min(dq.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else if(sort_token_series_ind.equals("P"))
							sbMainSql.append(",to_char(min(dispQ.PATIENT_ARRIVED_TIME),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else
							sbMainSql.append(",to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME "); //Added for HSA-CRF-0136 [IN:048412] -end
						sbMainSql.append(" FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C, OR_ORDER_STATUS_CODE E, ph_drug j, ph_ord_for_disp_queue dq, ph_disp_queue dispQ WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID and A.PATIENT_ID = DQ.PATIENT_ID and a.order_id = DQ.ORDER_ID  and DQ.facility_id = ? AND DQ.disp_locn_code = ? AND DQ.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND DQ.queue_shift = '*ALL'  AND DQ.QUEUE_DATE = DISPQ.QUEUE_DATE AND DQ.facility_id = DISPQ.facility_id AND DQ.disp_locn_code = DISPQ.disp_locn_code AND DQ.queue_date = DISPQ.queue_date AND DQ.queue_shift = DISPQ.queue_shift AND DQ.token_series_code = DISPQ.token_series_code AND DQ.token_serial_no = DISPQ.token_serial_no"); // ph_ord_for_disp_queue dq, ph_disp_queue dispQ Added for HSA-CRF-0136 [IN:048412] 
						//"AND (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE x,ph_disp_queue y WHERE x.FACILITY_ID=? AND x.DISP_LOCN_CODE=? "); commented for Added for HSA-CRF-0136 [IN:048412] 
						if(!getTokenSeriesCode().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIES_CODE=? "); //changed x. - > dq. for HSA-CRF-0136 [IN:048412] 
						if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIAL_NO=? "); //changed x. - > dq. for HSA-CRF-0136 [IN:048412] 
						//sbMainSql.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO ");	 // commented for HSA-CRF-0136 [IN:048412] 
								
						if(verf_combined_with_alloc.equals("C")) /*code added for IN033339  --- Start  */ 
							sbMainSql.append(" AND NVL (dq.token_line_status, '!') NOT IN ('XX','DP','DF','VF') ");//changed y. - > DISPQ. for HSA-CRF-0136 [IN:048412] and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 // NVL (dq.token_line_status, '!') added for 61426
						else
							sbMainSql.append( " AND NVL (dq.token_line_status, '!') NOT IN ('XX','DP','DF','VF') ");//changed y. - > DISPQ. for HSA-CRF-0136 [IN:048412] and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 /*code added for IN033339  --- End  */ // NVL (dq.token_line_status, '!') added for 61426
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append(" AND b.PRIORITY=? ");//changed a.priority to b.priority for SKR-SCF-1274
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (b.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (b.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}//Added MMS-DM-CRF-0228 end
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							} 	
						}
						else if (!order_date_from.equals("")){
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}//Added MMS-DM-CRF-0228 end
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
						else if (!order_date_to.equals("")){
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}//Added MMS-DM-CRF-0228 end
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999  ");
								else
									sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}	
						}
						sbMainSql.append(" AND E.ORDER_STATUS_CODE NOT IN ('00','05','95','03','93','97','99','58') ");
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID = ? ");
						sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						//sbMainSql.append(" AND A.ORDERING_FACILITY_ID=?	"); //commneted for  ML-BRU-SCF-0542 [IN:036182]
						sbMainSql.append("	AND A.PERFORMING_DEPTLOC_CODE=? ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						sbMainSql.append(" and j.drug_code =b.order_catalog_code");
						sbMainSql.append(sbStagesCondition.toString());
						sbMainSql.append(sbAppendSql1.toString() + sbConstructSql.toString());
					}
					else if(scope.equals("E")){
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO , a.ordering_facility_id, A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID "); // added , a.ordering_facility_id for ML-BRU-SCF-0542 [IN:036182]
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO , a.ordering_facility_id, A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID "); // added , a.ordering_facility_id for ML-BRU-SCF-0542 [IN:036182]
						}
						//changed a.priority to b.priority for SKR-SCF-1274
						if(sort_token_series_ind.equals("R"))
							sbMainSql.append(",to_char(min(dq.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else if(sort_token_series_ind.equals("P"))
							sbMainSql.append(",to_char(min(dispQ.PATIENT_ARRIVED_TIME),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else
							sbMainSql.append(",to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						sbMainSql.append(" # FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C ,OR_ORDER_STATUS_CODE E , ph_drug j, ph_ord_for_disp_queue dq, ph_disp_queue dispQ WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID and A.PATIENT_ID = DQ.PATIENT_ID and a.order_id = DQ.ORDER_ID and DQ.facility_id = ? AND DQ.disp_locn_code = ? AND DQ.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND DQ.queue_shift = '*ALL' AND DQ.QUEUE_DATE = DISPQ.QUEUE_DATE AND DQ.facility_id = DISPQ.facility_id AND DQ.disp_locn_code = DISPQ.disp_locn_code AND DQ.queue_date = DISPQ.queue_date AND DQ.queue_shift = DISPQ.queue_shift AND DQ.token_series_code = DISPQ.token_series_code AND DQ.token_serial_no = DISPQ.token_serial_no "); // ph_ord_for_disp_queue dq, ph_disp_queue dispQ Added for HSA-CRF-0136 [IN:048412] 
						// AND (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=? AND x.DISP_LOCN_CODE=? "); commented for HSA-CRF-0136 [IN:048412] 
						if(!getTokenSeriesCode().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIES_CODE=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIAL_NO=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						//sbMainSql.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO");
						   
						if(verf_combined_with_alloc.equals("C")) /*if & else block code added for IN033339  ---  */ 
							sbMainSql.append(" AND NVL (dq.token_line_status, '!') NOT IN ('XX','DP','DF','VF')  "); //changed y. -> dispq. for HSA-CRF-0136 [IN:048412]  and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 // NVL (dq.token_line_status, '!') added for 61426
						else
							sbMainSql.append( " AND NVL (dq.token_line_status, '!') NOT IN ('XX','DP','DF','VF') ");	//changed y. -> dispq. for HSA-CRF-0136 [IN:048412] and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002	// NVL (dq.token_line_status, '!') added for 61426		
//						if(!priority.equals("")) // if Added, Removed NVL - KAUH-SCF-0183[IN:047989] 
//							sbMainSql.append(" AND b.PRIORITY=? "); //changed a.priority to b.priority for SKR-SCF-1274
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (b.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (b.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
						sbMainSql.append(" AND E.ORDER_STATUS_CODE NOT IN ('00','05','95','03','93','97','99','58') ");
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID = ? ");
						sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						//sbMainSql.append("AND A.ORDERING_FACILITY_ID=? "); //commented for  ML-BRU-SCF-0542 [IN:036182]
						sbMainSql.append(" AND A.PERFORMING_DEPTLOC_CODE=? ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						sbMainSql.append(" and j.drug_code =b.order_catalog_code AND B.END_DATE_TIME >= TRUNC(SYSDATE) "); 	
						sbMainSql.append(sbDrugRelateSQL.toString());
						sbMainSql.append(strappend1);
						sbMainSql.append(sbAppendSql1.toString() + sbConstructSql.toString());
					} 
					else {
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO, a.ordering_facility_id, A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID "); // added , a.ordering_facility_id for  ML-BRU-SCF-0542 [IN:036182]
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO, a.ordering_facility_id, A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID "); // added , a.ordering_facility_id for  ML-BRU-SCF-0542 [IN:036182]
						}
						//changed a.priority to b.priority for SKR-SCF-1274
						if(sort_token_series_ind.equals("R"))
							sbMainSql.append(",to_char(min(dq.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else if(sort_token_series_ind.equals("P"))
							sbMainSql.append(",to_char(min(dispQ.PATIENT_ARRIVED_TIME),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else
							sbMainSql.append(",to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						sbMainSql.append(" # FROM OR_ORDER_LINE B,OR_ORDER A, MP_PATIENT C, OR_ORDER_STATUS_CODE E , ph_drug j, ph_ord_for_disp_queue dq, ph_disp_queue dispQ WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID and A.PATIENT_ID = DQ.PATIENT_ID and a.order_id = DQ.ORDER_ID and DQ.facility_id = ? AND DQ.disp_locn_code = ? AND DQ.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND DQ.queue_shift = '*ALL' AND DQ.QUEUE_DATE = DISPQ.QUEUE_DATE AND DQ.facility_id = DISPQ.facility_id AND DQ.disp_locn_code = DISPQ.disp_locn_code AND DQ.queue_date = DISPQ.queue_date AND DQ.queue_shift = DISPQ.queue_shift AND DQ.token_series_code = DISPQ.token_series_code AND DQ.token_serial_no = DISPQ.token_serial_no "); //added ph_ord_for_disp_queue dq, ph_disp_queue dispQ for HSA-CRF-0136 [IN:048412] 
						//AND (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=? AND x.DISP_LOCN_CODE=? "); commented for //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						if(!getTokenSeriesCode().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIES_CODE=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIAL_NO=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						//sbMainSql.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO"); commented for HSA-CRF-0136 [IN:048412]
						if(verf_combined_with_alloc.equals("C"))/*if & else block code added for IN033339  ---   */ 
							sbMainSql.append(" AND NVL (dq.token_line_status, '!') NOT IN ('XX','DP','DF','VF')  "); //changed y. -> dispq. for HSA-CRF-0136 [IN:048412]  and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 // NVL (dq.token_line_status, '!') added for 61426
						else
							sbMainSql.append( " AND NVL (dq.token_line_status, '!') NOT IN ('XX', 'DP', 'DF', 'RG') "); //changed y. -> dispq. for HSA-CRF-0136 [IN:048412] and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 // NVL (dq.token_line_status, '!') added for 61426
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append( " AND b.PRIORITY=? ");//changed a.priority to b.priority for SKR-SCF-1274
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (b.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (b.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
								 sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
								 sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
						sbMainSql.append(" AND E.ORDER_STATUS_CODE NOT IN ('00','05','95','03','93','97','99','58') ");
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID = ? ");
						sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						//sbMainSql.append( " AND A.ORDERING_FACILITY_ID=? "); //commented for  ML-BRU-SCF-0542 [IN:036182]
						sbMainSql.append( " AND A.PERFORMING_DEPTLOC_CODE=? ");
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						sbMainSql.append(" and j.drug_code =b.order_catalog_code ");
						sbMainSql.append(sbDrugRelateSQL.toString());
						sbMainSql.append(strappend1);
						sbMainSql.append(sbAppendSql1.toString() + sbConstructSql.toString());
					}
				}
				else{
					
					//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
					String getDisp_locn_iae1="";
					if(getDisp_locn_iae().contains("@@@")){
					String name_getDisp_locn_iae[]=getDisp_locn_iae().split("@@@");
					for(String fechedname:name_getDisp_locn_iae)
					{
						getDisp_locn_iae1=getDisp_locn_iae1+fechedname+"','";
					}
					if (getDisp_locn_iae1 != null && getDisp_locn_iae1.length() >= 2) {
					getDisp_locn_iae1=getDisp_locn_iae1.substring(0, getDisp_locn_iae1.length() - 2);
					getDisp_locn_iae1=getDisp_locn_iae1.substring(2);
					}
					}else
					{
						getDisp_locn_iae1="'"+getDisp_locn_iae()+"'";
					}//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 end
					
					if(scope.equals("EX")){		
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC ,c.NATIONAL_ID_NO, a.ordering_facility_id,A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID,min(nvl(print_value,0))min_value ,max(nvl(print_value,0))max_value ");
						}
						else{
							sbMainSql.append("SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC ,c.NATIONAL_ID_NO, a.ordering_facility_id,A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,min(nvl(print_value,0))min_value ,max(nvl(print_value,0))max_value ");
						}
						//changed a.priority to b.priority for SKR-SCF-1274
						if(sort_token_series_ind.equals("R"))
							sbMainSql.append(",to_char(min(dq.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else if(sort_token_series_ind.equals("P"))
							sbMainSql.append(",to_char(min(dispQ.PATIENT_ARRIVED_TIME),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else
							sbMainSql.append(",to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						sbMainSql.append(" FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C ,OR_ORDER_STATUS_CODE E, ph_drug j, ph_ord_for_disp_queue dq, ph_disp_queue dispQ,or_order_line_ph olph WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID and A.PATIENT_ID = DQ.PATIENT_ID and a.order_id = DQ.ORDER_ID and olph.order_id = a.order_id and olph.order_id = b.order_id and b.order_line_num = olph.order_line_num AND DQ.facility_id = ? AND DQ.disp_locn_code = ? AND DQ.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND DQ.queue_shift = '*ALL' AND DQ.QUEUE_DATE = DISPQ.QUEUE_DATE AND DQ.facility_id = DISPQ.facility_id AND DQ.disp_locn_code = DISPQ.disp_locn_code AND DQ.queue_date = DISPQ.queue_date AND DQ.queue_shift = DISPQ.queue_shift AND DQ.token_series_code = DISPQ.token_series_code AND DQ.token_serial_no = DISPQ.token_serial_no and dq.token_line_status NOT IN ('XX')"); //added ph_ord_for_disp_queue dq, ph_disp_queue dispQ for HSA-CRF-0136 [IN:048412] and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
						//AND (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=? AND x.DISP_LOCN_CODE=?  "); commented for HSA-CRF-0136 [IN:048412]
						//olph.order_id = a.order_id and olph.order_id = b.order_id and b.order_line_num = olph.order_line_num added for GHL-CRF-453
						if(!getTokenSeriesCode().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIES_CODE=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIAL_NO=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						//sbMainSql.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO and y.token_status NOT IN ('XX')) ");
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append(" AND b.PRIORITY=? ");//changed a.priority to b.priority for SKR-SCF-1274
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (b.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (b.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
						sbMainSql.append(" AND E.ORDER_STATUS_CODE NOT IN ('00','05','95','03','93','97','99','58') ");
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID = ? ");
						sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' ");// added , a.ordering_facility_id for ML-BRU-SCF-0542 [IN:036182] //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						//sbMainSql.append(" AND A.ORDERING_FACILITY_ID=? "); //commented ML-BRU-SCF-0542 [IN:036182]
						if(getDispStage().equals("V") && isSite_integration_em_bd_pyxis){//modified By Himanshu Saxena for MMS-DM-CRF-0232
							sbMainSql.append( " AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
							}else{
								sbMainSql.append( " AND A.PERFORMING_DEPTLOC_CODE=? ");
							}
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						sbMainSql.append(" and j.drug_code =b.order_catalog_code ");
						sbMainSql.append(sbDrugRelateSQL.toString());
						sbMainSql.append(sbStagesCondition.toString());
						sbMainSql.append(sbConstructSql.toString());
					} 
					else {
						
						if(excl_ord_locn_dispense_yn.equals("Y")){//Added for ML-MMOH-CRF-2085
							sbMainSql.append( "SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO , a.ordering_facility_id,  A.PATIENT_CLASS, '' EPISODE_ID, '' ENCOUNTER_ID,min(nvl(print_value,0))min_value ,max(nvl(print_value,0))max_value ");
						}
						else{
							sbMainSql.append( "SELECT max(b.priority)priority ,A.PATIENT_ID, nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name,(select distinct (DISP_LOCN_CODE||' &&& '||SHORT_DESC) from ph_disp_locn where DISP_LOCN_CODE =  a.performing_deptloc_code) dispance_location, COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE, SEX,c.nationality_code COUNTRY_CODE, (select long_desc from mp_country_lang_vw where language_id = ? and country_code = c.nationality_code) NATIONALITY_DESC,C.NATIONAL_ID_NO , a.ordering_facility_id,  A.PATIENT_CLASS, A.EPISODE_ID, A.ENCOUNTER_ID,min(nvl(print_value,0))min_value ,max(nvl(print_value,0))max_value ");
						}
						//min(nvl(print_value,0))min_value ,max(nvl(print_value,0))max_value added for GHL-CRF-0453
						//changed a.priority to b.priority for SKR-SCF-1274
						if(sort_token_series_ind.equals("R"))
							sbMainSql.append(",to_char(min(dq.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else if(sort_token_series_ind.equals("P"))
							sbMainSql.append(",to_char(min(dispQ.PATIENT_ARRIVED_TIME),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						else
							sbMainSql.append(",to_char(min(a.ADDED_DATE),'dd/mm/yyyy hh24:mi') RELEASE_DATE_TIME ");
						//sbMainSql.append(" # FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , OR_ORDER_STATUS_CODE E , ph_drug j, ph_ord_for_disp_queue dq, ph_disp_queue dispQ WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID and A.PATIENT_ID = DQ.PATIENT_ID and a.order_id = DQ.ORDER_ID and DQ.facility_id = ? AND DQ.disp_locn_code = ? AND DQ.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND DQ.queue_shift = '*ALL' AND DQ.QUEUE_DATE = DISPQ.QUEUE_DATE AND DQ.facility_id = DISPQ.facility_id AND DQ.disp_locn_code = DISPQ.disp_locn_code AND DQ.queue_date = DISPQ.queue_date AND DQ.queue_shift = DISPQ.queue_shift AND DQ.token_series_code = DISPQ.token_series_code AND DQ.token_serial_no = DISPQ.token_serial_no and dispQ.token_status NOT IN ('XX')"); // ph_ord_for_disp_queue dq, ph_disp_queue dispQ added for HSA-CRF-0136 [IN:048412]
						sbMainSql.append(" # FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C , OR_ORDER_STATUS_CODE E , ph_drug j, ph_ord_for_disp_queue dq, ph_disp_queue dispQ,or_order_line_ph olph WHERE C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID and A.PATIENT_ID = DQ.PATIENT_ID and a.order_id = DQ.ORDER_ID and olph.order_id = a.order_id and olph.order_id = b.order_id and b.order_line_num = olph.order_line_num AND DQ.facility_id = ? AND DQ.disp_locn_code = ? AND DQ.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND DQ.queue_shift = '*ALL' AND DQ.QUEUE_DATE = DISPQ.QUEUE_DATE AND DQ.facility_id = DISPQ.facility_id AND DQ.disp_locn_code = DISPQ.disp_locn_code AND DQ.queue_date = DISPQ.queue_date AND DQ.queue_shift = DISPQ.queue_shift AND DQ.token_series_code = DISPQ.token_series_code AND DQ.token_serial_no = DISPQ.token_serial_no "); // ph_ord_for_disp_queue dq, ph_disp_queue dispQ added for HSA-CRF-0136 [IN:048412]
						//and olph.order_id = a.order_id and olph.order_id = b.order_id and b.order_line_num = olph.order_line_num added for GHL-CRF-453
						if(verf_combined_with_alloc.equals("C"))//if & else added and commented for ML-BRU-SCF-1442[IN:51953]
							sbMainSql.append("AND NVL(dq.token_line_status,'!') NOT IN ('XX', 'DF')"); //modified condition for ML-MMOH-SCF-2339
						else
								sbMainSql.append("AND NVL(dq.token_line_status,'!') NOT IN ('XX', 'DF')"); //modified condition for ML-MMOH-SCF-2339
						//AND (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE x,ph_disp_queue y WHERE x.FACILITY_ID=? AND x.DISP_LOCN_CODE=?  "); //commented for HSA-CRF-0136 [IN:048412]
						if(!getTokenSeriesCode().equals(""))// if Added for HSA-CRF-0136 [IN:048412]
							sbMainSql.append(" AND dq.TOKEN_SERIES_CODE=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND dq.TOKEN_SERIAL_NO=? "); //changed x. -> dq. for HSA-CRF-0136 [IN:048412] 
						//sbMainSql.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO and y.token_status NOT IN ('XX')) "); //commented for HSA-CRF-0136 [IN:048412]
//						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//							sbMainSql.append(" AND b.PRIORITY=? ");//changed a.priority to b.priority for SKR-SCF-1274
						// if Added, RBU-GHL-CRF-0054 starts added for Emergency Case
						if(!priority.trim().equals(""))
						{
					    	if(isSite_ph_new_prescription){
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (b.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");
					    	else
					    	sbMainSql.append(" and (b.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND b.priority = ? ");
					    	}
					    }// if Added, RBU-GHL-CRF-0054 end
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_from.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
								else
									sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							else if (!order_date_to.equals("")){
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
								else
									sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
						sbMainSql.append(" AND E.ORDER_STATUS_CODE NOT IN ('00','05','95','03','93','97','99','58') ");
						if(!patient_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.PATIENT_ID = ? ");
						if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORDER_ID = ? ");
						sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' "); //added  , a.ordering_facility_id for ML-BRU-SCF-0542 [IN:036182]//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						//sbMainSql.append( " AND A.ORDERING_FACILITY_ID=? "); //commented for  ML-BRU-SCF-0542 [IN:036182]
						if(getDispStage().equals("V") && isSite_integration_em_bd_pyxis){//modified By Himanshu Saxena for MMS-DM-CRF-0232
							sbMainSql.append( " AND A.PERFORMING_DEPTLOC_CODE in ("+getDisp_locn_iae1+") ");
							}else{
								sbMainSql.append( " AND A.PERFORMING_DEPTLOC_CODE=? ");
							}
						if(!add_criteria_practitioner_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND A.ORD_PRACT_ID = ? ");
						if(!this.getGender().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.SEX = ? ");
						if(!add_criteria_nat_code.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" AND C.NATIONALITY_CODE = ? ");
						sbMainSql.append(" and j.drug_code =b.order_catalog_code ");
						sbMainSql.append(sbDrugRelateSQL.toString());
						sbMainSql.append(sbStagesCondition.toString());
						sbMainSql.append(strappend1);
						sbMainSql.append(sbConstructSql.toString());
					}			
				}
				if(!scope.equals("EX")){
					sbMainSql=replaceLocnQuery(sbMainSql.toString(),sbLocationSql.toString());
				}				
				//System.err.println("======OP With Token=======PATIENT Search=========sbMainSql="+sbMainSql);
				System.out.println("@@@ ML-MMOH-SCF-2485 DispMedicationBean.java 11165 sbMainSql = "+sbMainSql);
				pstmt = connection.prepareStatement(sbMainSql.toString());
				int ii=1;
				if(scope.equals("EX")){
					pstmt.setString(ii,getLanguageId()); 
					pstmt.setString(++ii,getLanguageId()); //added GHL-SCF-0830 [IN:049943]
					pstmt.setString(++ii,login_facility_id);		
					pstmt.setString(++ii,disp_locn_code.trim());
					pstmt.setString(++ii,this.queue_date);//queue_date
					if(!getTokenSeriesCode().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,getTokenSeriesCode());//series
					if(!getTokenNo().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,getTokenNo());//no
					if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,priority);
					if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,order_date_from);
						pstmt.setString(++ii,order_date_to);
					}
					else if(!order_date_from.equals(""))
						pstmt.setString(++ii,order_date_from);
					else if(!order_date_to.equals(""))
						pstmt.setString(++ii,order_date_to);
					if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,patient_id);
					if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,order_id);
					pstmt.setString(++ii,login_facility_id);
					pstmt.setString(++ii,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++ii,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++ii,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++ii,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					if(isSite_integration_em_bd_pyxis){
						if(!getDispStage().equals("V")){
							pstmt.setString(++ii,getDispLocnCode());	
						}
					}else
					{
						pstmt.setString(++ii,getDispLocnCode());
					}
					
					if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,add_criteria_practitioner_id);
					if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,this.getGender());
					if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,add_criteria_nat_code);
					//pstmt.setString(++ii,getLanguageId());//Commented GHL-SCF-0830 [IN:049943]
					//pstmt.setString(++ii,this.orderingfacility); //Commented for  ML-BRU-SCF-0542 [IN:036182]
					pstmt.setString(++ii,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,this.drug_medical);
					pstmt.setString(++ii,this.exclude_PRN_orders);
					pstmt.setString(++ii,login_facility_id);	//Added parameter for KAUH-SCF-0183[IN:047989]
					pstmt.setString(++ii,login_by_id);	//Added parameter for KAUH-SCF-0183[IN:047989]
					pstmt.setString(++ii,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++ii,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++ii,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A") || getDispStage().equals("AS")){
						pstmt.setString(++ii,order_date_from);
						pstmt.setString(++ii,order_date_to);
					}
					else{
						pstmt.setString(++ii,login_facility_id);		//Added parameter for MOD Performance tuning 
						pstmt.setString(++ii,login_facility_id);		//Added parameter for MOD Performance tuning 	
					}//added for MOHE-CRF-0158
				} 
				else {
					System.out.println("@@@ ML-MMOH-SCF-2485 DispMedicationBean.java 11233 getLanguageId="+getLanguageId()+"=login_facility_id="+login_facility_id+"=disp_locn_code="+disp_locn_code+"=queue_date="+this.queue_date +"=getTokenSeriesCode="+getTokenSeriesCode()+"=getTokenNo="+getTokenNo());
					pstmt.setString(ii,getLanguageId()); 
					pstmt.setString(++ii,getLanguageId()); 
					if(excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")){//Added for ML-MMOH-CRF-2085
						pstmt.setString(++ii,getLanguageId());
						pstmt.setString(++ii,getLanguageId());
					}
					pstmt.setString(++ii,login_facility_id);
					pstmt.setString(++ii,disp_locn_code);
					pstmt.setString(++ii,this.queue_date);//queue_date 
					if(!getTokenSeriesCode().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,getTokenSeriesCode());//series
					if(!getTokenNo().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,getTokenNo());//no
					if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,priority);
					if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,order_date_from);
						pstmt.setString(++ii,order_date_to);
					}
					else if(!order_date_from.equals(""))
						pstmt.setString(++ii,order_date_from);
					else if(!order_date_to.equals(""))
						pstmt.setString(++ii,order_date_to);
					if(!patient_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,patient_id);
					if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,order_id);
					System.out.println("@@@ ML-MMOH-SCF-2485 DispMedicationBean.java 11259 order_date_from="+order_date_from+"=order_date_to="+order_date_to+"=getDisp_before_start_date_yn()="+getDisp_before_start_date_yn()+"=getDisp_before_no_of_days()="+getDisp_before_no_of_days()+"=getDisp_beyond_earliest_start_yn()="+getDisp_beyond_earliest_start_yn()+"=getDisp_beyond_no_of_days()="+getDisp_beyond_no_of_days()+"=getDispLocnCode()="+getDispLocnCode());
					pstmt.setString(++ii,login_facility_id);
					pstmt.setString(++ii,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++ii,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++ii,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++ii,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					//pstmt.setString(++ii,this.orderingfacility);//newly added on 2/25/2005 //cimmented for ML-BRU-SCF-0542 [IN:036182]
					if(isSite_integration_em_bd_pyxis){
						if(!getDispStage().equals("V")){
							pstmt.setString(++ii,getDispLocnCode());
							}
					}else
					{
						pstmt.setString(++ii,getDispLocnCode());
					}
					if(!add_criteria_practitioner_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,add_criteria_practitioner_id);
					if(!this.getGender().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,this.getGender());
					if(!add_criteria_nat_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,add_criteria_nat_code);
					//pstmt.setString(++ii,getLanguageId()); //Commented GHL-SCF-0830 [IN:049943]
					if(!scope.equals("H")){
						if(!add_criteria_locn_code.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++ii,add_criteria_locn_code);
						if(!ordlocntype.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++ii,ordlocntype);
					}
					System.out.println("@@@ ML-MMOH-SCF-2485 DispMedicationBean.java 11287 sFreqDurnAbsOrderFlag="+sFreqDurnAbsOrderFlag+"=exclude_PRN_orders="+this.exclude_PRN_orders+"=login_by_id="+login_by_id+"=getDispGenralDrug()="+getDispGenralDrug()+"=getDispNarcoDrug()="+getDispNarcoDrug()+"=getDispControlDrug()="+getDispControlDrug());
					pstmt.setString(++ii,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to include_absolute_orders for SRR20056-CRF-0663
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++ii,this.drug_medical);
					pstmt.setString(++ii,this.exclude_PRN_orders);
					pstmt.setString(++ii,login_facility_id);		//Added parameter for KAUH-SCF-0183[IN:047989]
					pstmt.setString(++ii,login_by_id);		//Added parameter for KAUH-SCF-0183[IN:047989]
					pstmt.setString(++ii,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++ii,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++ii,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					
					if(PH_OP_MEDICATION_ORD_DISP==true && getDispStage().equals("A") || getDispStage().equals("AS")){
						pstmt.setString(++ii,order_date_from);
						pstmt.setString(++ii,order_date_to);
					}
					else{
						pstmt.setString(++ii,login_facility_id);		//Added parameter for MOD Performance tuning 
						pstmt.setString(++ii,login_facility_id);		//Added parameter for MOD Performance tuning 	
					}//added for MOHE-CRF-0158
				}
			}
			System.out.println("::SbMainSql::"+sbMainSql);
			resultSet		= pstmt.executeQuery() ;
			CallableStatement callableStatement = null;
			String sTokenNumbers = "";
			String min_print_value = "";//GHL-CRF-0453
			String max_print_value = "";//GHL-CRF-0453

			result.add("link");		 //0
			while ( resultSet != null && resultSet.next() && i <= end+1 ) {
				if( start != 1 && (i+1) < start ) {
					i++;
					continue;
				}
				else i++;
					count++ ;
				if(i<=end) {
					if(disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE")){	
						result.add(resultSet.getString("NURSING_UNIT"));
					}
					else if(disp_locn_catg.equals("O")){
						if(!scope.equals("EX")){
							result.add(resultSet.getString("locn_desc"));					
						}
						else
							result.add("");					
					}
					else
						result.add("");			//1		
					if(issue_token_on_regn_yn.equals("Y")){// For the token numbers of a particular patient --- Start ----
						callableStatement = connection.prepareCall("{? = call ph_get_token_number (?,?,?,?)}");
						callableStatement.registerOutParameter(1, Types.VARCHAR);
						callableStatement.setString(2, login_facility_id.trim());
						callableStatement.setString(3, getDispLocnCode());// Removed trim() - KAUH-SCF-0183[IN:047989]
						callableStatement.setString(4, resultSet.getString("PATIENT_ID"));
						callableStatement.setString(5, this.queue_date);
						callableStatement.execute();
						sTokenNumbers = callableStatement.getString(1);
						closeStatement(callableStatement);
					}	// ---- end ----
					allPatientssel.add(resultSet.getString("PATIENT_ID"));//Added for Bru-HIMS-CRF-416
					result.add(resultSet.getString("PATIENT_ID")); //2
					result.add(checkForNull(resultSet.getString("PATIENT_NAME")));
					result.add(resultSet.getString("ORDERS"));
					result.add(checkForNull(resultSet.getString("COUNTRY_CODE")));
					result.add(checkForNull(resultSet.getString("NATIONALITY_DESC")));
					result.add(checkForNull(resultSet.getString("AGE")));
					result.add(checkForNull(resultSet.getString("SEX")));
					result.add(checkForNull(resultSet.getString("NATIONAL_ID_NO")));
					if(disp_locn_catg.equals("O")){
						if(!scope.equals("EX")){
							result.add(resultSet.getString("source_type"));		//10			
						}
						else{
							result.add("");	//10
						}
						result.add(sTokenNumbers); //11
					}
					else{
						result.add("N");//10
						result.add("");//11
					}
					result.add(checkForNull(resultSet.getString("PRIORITY"),"R"));	//12
					result.add(resultSet.getString("RELEASE_DATE_TIME"));	
					if((disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE")) && !customGroupBy.equals("PRESCRIPTION_NUMBER") && !(disp_stage.equals("F") && fill_list.equals("AF") && !disp_stage.equals("D")) && tab_based_group_sort_disp.equals("Y") && !customGroupBy.equals("NURSING_UNIT")&& !customGroupBy.equals("NONE"))
						result.add(resultSet.getString("ORD_DATE_TIME"));	
					else
						result.add("");	
					result.add(checkForNull(resultSet.getString("ORDERING_FACILITY_ID"))); //added for  ML-BRU-SCF-0542 [IN:036182]	
					result.add(checkForNull(resultSet.getString("ENCOUNTER_ID"))); //added for RUT-CRF-0083.5 [IN:041511]	
					result.add(checkForNull(resultSet.getString("EPISODE_ID"))); //added for RUT-CRF-0083.5 [IN:041511]	
					result.add(checkForNull(resultSet.getString("PATIENT_CLASS"))); //added for RUT-CRF-0083.5 [IN:041511] these fields added in SQL also (both to get & group by)
					if(disp_locn_catg.equals("I") && !fill_list.equals("AF")){ // Added for KDAH-CRF-0338 - Start modified for fill with fill list
					result.add(resultSet.getString("bed_num")==null?"":resultSet.getString("bed_num")); 
					} // Added for KDAH-CRF-0338 - End
					
					
					if(disp_locn_catg.equals("IAE")){
						result.add(resultSet.getString("bed_num")==null?"":resultSet.getString("bed_num"));
					}
					
				if(isSite_integration_em_bd_pyxis){	
					if(getDisp_locn_iae().contains("@@@") && disp_stage.equals("V")){
					result.add(resultSet.getString("dispance_location")==null?"":resultSet.getString("dispance_location"));
					}
				}
				
				if(isSite_ph_new_prescription && disp_stage.equals("F") && disp_locn_catg.equals("I") && customGroupBy.equals("PRESCRIPTION_NUMBER"))
				{
					result.add(resultSet.getString("prescription_Number")==null?"":resultSet.getString("prescription_Number"));
				}
					
					if((disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE") )&& !fill_list.equals("AF") ){				// Added for BSP-SCF-0060 - Start and && !fill_list.equals("AF") added for MMS-ME-SCF-001
						result.add(resultSet.getString("SOURCE_CODE"));
					}
					else if(disp_locn_catg.equals("O")){
						if(!scope.equals("EX")){
							result.add(resultSet.getString("SOURCE_CODE"));					
						}
						else
							result.add("");					
					}
					else
						result.add("");		 // Added for BSP-SCF-0060 - End
					
					patient_details.add(resultSet.getString("PATIENT_ID"));
					patient_details.add(resultSet.getString("PATIENT_NAME"));
					patient_details.add(resultSet.getString("COUNTRY_CODE"));
					patient_details.add(resultSet.getString("SEX"));
					patient_locator.add(resultSet.getString("PATIENT_ID"));
				//GHL-CRF-0453 - start
					if(disp_stage.equals("A") || (disp_stage.equals("F") && !fill_list.equals("AF") )){
	 				    min_print_value = resultSet.getString("MIN_VALUE");
						max_print_value = resultSet.getString("MAX_VALUE");
						setPrintValueForOrders(resultSet.getString("PATIENT_ID"),min_print_value+"~"+max_print_value);
					}
				//GHL-CRF-0453 - end
				}				
			}
			setallPatients(allPatientssel);//Added for Bru-HIMS-CRF-416
			int rsCount = 0; //Added for MMS-DM-CRF-0228
			String rsCountStr = ""; //Added for MMS-DM-CRF-0228
			ResultSet resultSetCopy		= null;//Added for MMS-DM-CRF-0228
			
			if(ph_print_prescription){//MMS-DM-CRF-0228 start
			resultSetCopy = pstmt.executeQuery() ;
			
			while(resultSetCopy != null && resultSetCopy.next())
			{
				rsCount++;
			}
			}//MMS-DM-CRF-0228 end
			closeStatement(pstmt);
			closeResultSet(resultSet);
			
			if(ph_print_prescription){//Added for MMS-DM-CRF-0228 start
				closeResultSet(resultSetCopy);
				rsCountStr = Integer.toString(rsCount);
				result.set(0,rsCountStr);
			}//Added for MMS-DM-CRF-0228 end
			else{
			if( start != 1 )
				prevnextlink = prevnextlink + "<td align='right'><a href=\"javascript:SubmitLink('"+(start-query_result_size)+"','"+(end-query_result_size)+"')\">Previous&nbsp;&nbsp;</a>" ;
			if( count > 12 )
				prevnextlink = prevnextlink + "<td align='right'><a href=\"javascript:SubmitLink('"+(start+query_result_size)+"','"+(end+query_result_size)+"')\">Next</a>" ;
				prevnextlink = prevnextlink + "<input type='hidden' name='start' value='"+start+"'><input type='hidden' name='end' value='"+end+"'>";
			if(result!=null)	{
				result.set(0,prevnextlink);
			}
			}
			// below code snippet for locating patient in diff pages		
			//resultSet_meta	= pstmt.executeQuery() ;		
			/*while( resultSet_meta != null && resultSet_meta.next() ) {
				patient_locator.add(resultSet_meta.getString("PATIENT_ID"));
			}*/
			setPatientLocator(patient_locator);	// locating patient code ends
		}
		catch ( Exception e ) {
			System.err.println("Exception in getAllThePatientsBasedOnCriteria sbMainSql="+sbMainSql+" \n sbConstructSql="+sbConstructSql+" result="+result);
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet_meta ) ;
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}
	/*
		This function will return an ArrayList which contains DISP_AUTH_REQD_DRUG_YN, DISP_NARCOTIC_YN, DISP_CONTROLLED_DRUG_YN Based on the Dispense Location Code ,login facility-id and login user-id
	*/
	public ArrayList buildDrugRelatedSQL(String disp_locn_code){
		ArrayList result = new ArrayList();
		String general_drug		= "";
		String narcotic_drug	= "";
		String controlled_drug	= "";
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try{
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT18") ) ;
			pstmt.setString(1,login_by_id);
			pstmt.setString(2,login_facility_id);
			pstmt.setString(3,disp_locn_code.trim());
			resultSet	= pstmt.executeQuery() ;

			if (resultSet.next()){
				general_drug	=	resultSet.getString("DISP_AUTH_REQD_DRUG_YN");
				narcotic_drug	=	resultSet.getString("DISP_NARCOTIC_YN");
				controlled_drug =	resultSet.getString("DISP_CONTROLLED_DRUG_YN");
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}

		if (general_drug.equals("Y")){
			result.add("G");
		}
		if (narcotic_drug.equals("Y")){
			result.add("N");
		}
		if (controlled_drug.equals("Y")){
			result.add("C");
		}
		arrListdrugClass = result;
		return result;
	}

	/*  This method will be used to get all the orders for a patient depending on various conditions
		Parameter to be Passed --> Patient ID
		Return Type				--> ArrayList (PRIORITY,ORDER_ID,ORD_DATE_TIME,PRACTITIONER_NAME,LOCATION,FACILITY_NAME,displayRemarksLink(Y/N),PRACTITIONER_ID)*/
	public ArrayList getOrders(String pat_id) throws Exception {
		ArrayList result		= new ArrayList();
		Connection connection	= null;
		PreparedStatement pstmt=null,pstmt1 = null;
		ResultSet resultSet=null,resultSet1 = null;
		String disp_stage		= getDispStage();
		String disp_regn_reqd_yn = getDispRegnReqdYN();
		order_id=checkForNull(getOrderID());
//changed during PE By Naveen
	//	String unallocdrugs = getAllocDrugs();
		String	unallocdrugs = this.display_unallocDrugs;
		StringBuffer sbConstructSql =new StringBuffer();
		StringBuffer sbStagesCondition =new StringBuffer();
		StringBuffer sbDrugRelateSQL =new StringBuffer();
		StringBuffer sbAppendSql1 = new StringBuffer();
		StringBuffer sbMainSql = new StringBuffer();
		StringBuffer sbAppendSql = new StringBuffer();
		String bed_no = getBedNo()==null?"":getBedNo(); // bed_no Added for KDAH-CRF-0338
		//added for SRR20056-CRF-0663 --Start
		String sFreqDurnAbsOrderFlag = "X"; //Both unchecked
		if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
			if(this.include_absolute_orders.equals("Y") && this.include_drugs_by_freq_durn.equals("Y"))
				sFreqDurnAbsOrderFlag="B";	// For Both Absolute orders and FreqDurn orders
			else if(this.include_absolute_orders.equals("Y") && this.include_drugs_by_freq_durn.equals("N"))
				sFreqDurnAbsOrderFlag="A";	//Only Absolute orders
			if(this.include_absolute_orders.equals("N") && this.include_drugs_by_freq_durn.equals("Y"))
				sFreqDurnAbsOrderFlag="F";	
		}
		else
			sFreqDurnAbsOrderFlag = this.include_absolute_orders;	
		//added for SRR20056-CRF-0663 --End
		try {
			connection = getConnection() ;
			
			boolean siteTpn = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","TPN_MF_LABEL");// added for ML-MMOH-CRF-0468
			boolean ph_print_prescription = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","PH_PRINT_PRESCRIPTION");//Added for MMS-DM-CRF-0228
			boolean  isSite_ph_new_prescription		= eCommon.Common.CommonBean.isSiteSpecific(connection,"PH","PH_NEW_PRESCRIPTION"); // added By Himanshu Saxena for GHL-CRF-0672
			scope		= scope==null	? "A" : scope;
			pat_id		= pat_id==null ? "" : pat_id;
			if(((scope).trim()).equals("")){
				scope = "A";
			}
			sbStagesCondition =new StringBuffer();
			if(disp_locn_catg.equals("O")){	
				if(disp_stage.equals("AS")){
					// Dispense Stage	--> All Stages
					//sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58') ");
					/* Below code added for 33339 --Start */					
					if(verf_combined_with_alloc.equals("C")){
						if(disp_regn_reqd_yn.equals("Y"))//code added for Bru-HIMS-CRF-416[IN045566] --Start
							sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('58','94'))");
						else //code added for Bru-HIMS-CRF-416[IN045566] --End
							sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58') ");
					}	
					else
						sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE  IN('10','25','58','94')) ");//code ''94'' added for Bru-HIMS-CRF-416[IN045566]
					/*  code added for 33339 --End */					
					if (!scope.equals("D") && !scope.equals("A")){
						sbStagesCondition.append(" OR A.DISCHARGE_IND='D') ");
					} 
					else {
						sbStagesCondition.append(")");
					}
				}
				else if(disp_stage.equals("V") && getIssueTokenOnRegnYN().equals("N")){
					// Dispense Stages is Verification and Issue Token is not appplicable
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if (disp_regn_reqd_yn.equals("Y")){					
						if(scope.equals("EX")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS ='XT'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else{
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS IN ('OP','EM')");
						}
					}
					else{
						if(scope.equals("EX")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE IN ('10','25','56','94') AND A.PATIENT_CLASS = 'XT'");//Added '94' for ML-BRU-SCF-1120[IN:44829]
						} 
						else {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE IN ('10','25','56','94') AND A.PATIENT_CLASS IN ('OP','EM')");//Added '94' for ML-BRU-SCF-1120[IN:44829]
						}
					}
				}
				else if(disp_stage.equals("V") && getIssueTokenOnRegnYN().equals("Y")){
					// Dispense Stages is Verification and Issue Token is appplicable
					if(scope.equals("H")) {				
						sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");

					} 
					else {
						if(scope.equals("EX")) {						
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS = 'XT'");
						} 
						else {						
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
					}
				}
				else if((getDispStage().equals("A") && (getFillingStatus().equals("A") )) ||(getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
					sbAppendSql = new StringBuffer();
					/*
						Dispense Stage is Allocation and Allocation is after Filling
													or
						Dispense Stage is Filling and Filling is before Allocation
					*/
					//if(getDispStage().equals("A") && (getFillingStatus().equals("A") )){
					// append=" AND H.ORDER_STATUS_TYPE IN ('35') ";

					// }else if(getDispStage().equals("F") && (getFillingStatus().equals("X") || getFillingStatus().equals("B") )) {
						if(getIssueTokenOnRegnYN().equals("N")){
							if (disp_regn_reqd_yn.equals("Y")){
								if(verf_combined_with_alloc.equals("C")){
									sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='25' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								}
								else{
									sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								}	
							}
							else{
								if(verf_combined_with_alloc.equals("C")){
									if(this.order_date_from.equals("") && this.order_date_to.equals(""))//if condition & else block added for ML-BRU-SCF-0378[IN034797] & ML-BRU-SCF-0638 [IN:036848]
										sbAppendSql.append(" AND H.ORDER_STATUS_TYPE IN ('10','25','30','94') ");//added for ML-BRU-SCF-1802
									else{
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
												sbAppendSql.append(" AND ( H.ORDER_STATUS_TYPE IN ('10','25','30','94') OR ( H.ORDER_STATUS_TYPE ='56'  AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY hh24:mi') AND TO_DATE(?,'DD/MM/YYYY hh24:mi') ))"); 
											else if(!this.order_date_from.equals(""))
												sbAppendSql.append(" AND ( H.ORDER_STATUS_TYPE IN ('10','25','30','94') OR ( H.ORDER_STATUS_TYPE ='56'  AND K.NEXT_COLLECTION_DATE >= TO_DATE(?,'DD/MM/YYYY hh24:mi') )) ");
											else if(!this.order_date_to.equals(""))
												sbAppendSql.append(" AND ( H.ORDER_STATUS_TYPE IN ('10','25','30','94') OR ( H.ORDER_STATUS_TYPE ='56'  AND K.NEXT_COLLECTION_DATE <= TO_DATE(?,DD/MM/YYYY hh24:mi')  )  )");
										}else{
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											sbAppendSql.append(" AND ( H.ORDER_STATUS_TYPE IN ('10','25','30','94') OR ( H.ORDER_STATUS_TYPE ='56'  AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ))"); // Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										else if(!this.order_date_from.equals(""))
											sbAppendSql.append(" AND ( H.ORDER_STATUS_TYPE IN ('10','25','30','94') OR ( H.ORDER_STATUS_TYPE ='56'  AND K.NEXT_COLLECTION_DATE >= TO_DATE(?,'DD/MM/YYYY') )) ");// Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										else if(!this.order_date_to.equals(""))
											sbAppendSql.append(" AND ( H.ORDER_STATUS_TYPE IN ('10','25','30','94') OR ( H.ORDER_STATUS_TYPE ='56'  AND K.NEXT_COLLECTION_DATE <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999  )  )");// Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										}
										}
								}
								else{
									sbAppendSql.append(" AND H.ORDER_STATUS_TYPE IN ('30') ");//Removed 94 for INC#48812
								}	
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){
								sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='25' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}
					//} 
					if(getIssueTokenOnRegnYN().equals("N")){
						// Issue Token is not applicable 
						sbStagesCondition = new StringBuffer();
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");
						} 
						else if(scope.equals("EX")) { 
							sbStagesCondition.append(sbAppendSql);
							sbStagesCondition.append(" AND A.PATIENT_CLASS ='XT'");
						} 
						else if (disp_regn_reqd_yn.equals("Y")){
							sbStagesCondition.append( sbAppendSql);
							sbStagesCondition.append( " AND A.PATIENT_CLASS IN('OP','EM')");
						}
						else{
							sbStagesCondition.append(sbAppendSql);
							sbStagesCondition.append(" AND A.PATIENT_CLASS IN('OP','EM')");
						}
					}
					else{
						// Issue Token is applicable
						/*String append="";
						if(getDispStage().equals("A") && (getFillingStatus().equals("A") )){
						append=" AND H.ORDER_STATUS_TYPE IN ('35') ";
						}else if(getDispStage().equals("F") && (getFillingStatus().equals("X") )) {
							if(verf_combined_with_alloc.equals("C")){
								append=" AND H.ORDER_STATUS_TYPE IN ('25') ";
							}else{
								append=" AND H.ORDER_STATUS_TYPE IN ('30') ";
							}						
						}else if(getDispStage().equals("F") && (getFillingStatus().equals("B") )){
							if(verf_combined_with_alloc.equals("C")){
								append=" AND H.ORDER_STATUS_TYPE IN ('10','25','30','56') ";
							}else{
								append=" AND H.ORDER_STATUS_TYPE IN ('30') ";
							}	
						
						}*/
						sbStagesCondition = new StringBuffer();
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
						else if(scope.equals("EX")) { 
							sbStagesCondition.append(sbAppendSql);
							sbStagesCondition.append(" AND A.PATIENT_CLASS ='XT'");
						} 
						else {
							sbStagesCondition.append(sbAppendSql);
							sbStagesCondition.append(" AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
					}
				}
				else if(getDispStage().equals("F") && getFillingStatus().equals("A")){
					//	Dispense Stage is Filling and Filling is after Allocation
					sbStagesCondition = new StringBuffer();
					if(getIssueTokenOnRegnYN().equals("N")){
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						} 
						else if(scope.equals("EX")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS ='XT'");
						}
						else {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS IN('OP','EM')");
						}
					}
					else{
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						} 
						else if(scope.equals("EX")) {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS ='XT'");
						} 
						else {
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
					}
				}
				else if(getDispStage().equals("A") && (getFillingStatus().equals("B")|| getFillingStatus().equals("X"))){
					sbAppendSql = new StringBuffer();
					//	Dispense Stage is Allocation and Filling is before Allocation
					if(getDispStage().equals("A") && getFillingStatus().equals("B")){
						sbAppendSql.append(" and H.ORDER_STATUS_TYPE ='35' ");
					}
					else{
						if(getIssueTokenOnRegnYN().equals("N")){
							if (disp_regn_reqd_yn.equals("N")){	
								if(verf_combined_with_alloc.equals("C")){
									if(this.order_date_from.equals("") && this.order_date_to.equals(""))//if condition & else block added for ML-BRU-SCF-0378[IN034797] & ML-BRU-SCF-0638 [IN:036848]
										sbAppendSql.append(" AND H.ORDER_STATUS_TYPE IN ('10','25','30', '35','56','94') "); //added for ML-BRU-SCF-1802
									else{
										if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
											if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
												sbAppendSql.append(" AND ( H.order_status_type IN ('10', '25', '30', '35','94') or ( H.order_status_type ='56'  AND K.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY hh24:mi') AND TO_DATE(?,'DD/MM/YYYY hh24:mi') ) ) "); // Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
											else if(!this.order_date_from.equals(""))
												sbAppendSql.append(" AND ( H.order_status_type IN ('10', '25', '30', '35','94') or ( H.order_status_type ='56'  AND K.next_collection_date >= TO_DATE(?,'DD/MM/YYYY hh24:mi') )) ");// Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
											else if(!this.order_date_to.equals(""))
												sbAppendSql.append(" AND ( H.order_status_type IN ('10', '25', '30', '35','94') or ( H.order_status_type ='56'  AND K.next_collection_date <= TO_DATE(?,'DD/MM/YYYY hh24:mi') ))  ");// Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										}else{
										if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
											sbAppendSql.append(" AND ( H.order_status_type IN ('10', '25', '30', '35','94') or ( H.order_status_type ='56'  AND K.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) ) "); // Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										else if(!this.order_date_from.equals(""))
											sbAppendSql.append(" AND ( H.order_status_type IN ('10', '25', '30', '35','94') or ( H.order_status_type ='56'  AND K.next_collection_date >= TO_DATE(?,'DD/MM/YYYY') )) ");// Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										else if(!this.order_date_to.equals(""))
											sbAppendSql.append(" AND ( H.order_status_type IN ('10', '25', '30', '35','94') or ( H.order_status_type ='56'  AND K.next_collection_date <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ))  ");// Added parameter - KAUH-SCF-0183[IN:047989]//added for ML-BRU-SCF-1802
										}
										}
								}
								else{
									sbAppendSql.append(" AND H.ORDER_STATUS_TYPE IN ('30') ");//Removed 94 for TTM-SCF-0097 [IN:048812]
								}
							}
							else{
								if(verf_combined_with_alloc.equals("C")){
									sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='25' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								}
								else{
									sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								}
							}
						}
						else{
							if(verf_combined_with_alloc.equals("C")){
								sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='25' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbAppendSql.append(" AND H.ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}
					}

					if(scope.equals("H")) {
						sbStagesCondition.append(" and H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(scope.equals("EX")) { 
						sbAppendSql.append(" and A.PATIENT_CLASS ='XT'");
						sbStagesCondition.append(sbAppendSql.toString());// Moved here for ML-BRU-SCF-1076[IN:44016]
					}
					else if(getIssueTokenOnRegnYN().equals("N")){
						sbAppendSql.append(" AND A.PATIENT_CLASS IN ('OP','EM')");
						sbStagesCondition.append(sbAppendSql.toString() );// Moved here for ML-BRU-SCF-1076[IN:44016]
					}
					else {
						sbAppendSql.append(" AND A.PATIENT_CLASS IN ('OP','EM','XT') ");
						sbStagesCondition.append(sbAppendSql.toString() );// Moved here for ML-BRU-SCF-1076[IN:44016]
					}
				}
				else if((getDispStage().equals("D") && (getFillingStatus().equals("B") || (getFillingStatus().equals("X"))))){
					//	Dispense Stage is Delivery and Filling is before Allocation
					//code added for unallocated drug findings....on 2/5/2004
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(unallocdrugs.equals("Y")) {
						if(scope.equals("EX")){
							sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE IN ('36','10','30','25') AND A.PATIENT_CLASS = 'XT'");//removed '56' for SKR-SCF-1561
						}
						else{
							if(getIssueTokenOnRegnYN().equals("N")){
								sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE IN ('36','10','30','25') AND A.PATIENT_CLASS IN('OP','EM')");//removed '56' for SKR-SCF-1561
							}
							else{
								sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE IN ('36','10','30','25') AND A.PATIENT_CLASS IN('OP','EM','XT')");//removed '56' for SKR-SCF-1561
							}
						}
					} 
					else {
						if(getIssueTokenOnRegnYN().equals("N")){
							if(scope.equals("EX")){
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS = 'XT'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS IN('OP','EM')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}
						else {
							if(scope.equals("EX")){
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS = 'XT'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS IN('OP','EM','XT')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						}
					}
				}
				else if((getDispStage().equals("D") && getFillingStatus().equals("A"))){
					//	Dispense Stage is Delivery and Filling is after Allocation
					if(scope.equals("H")) {
						sbStagesCondition = new StringBuffer(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else if(unallocdrugs.equals("Y")) {
						if(scope.equals("EX")){
							sbStagesCondition.append( "AND H.ORDER_STATUS_TYPE IN ('10', '35','30','56','25') AND A.PATIENT_CLASS = 'XT'");
						}
						else{
							if(getIssueTokenOnRegnYN().equals("N")){
								sbStagesCondition.append( " AND H.ORDER_STATUS_TYPE IN ('10', '35','30','56','25') AND A.PATIENT_CLASS IN('OP','EM') ");
							}
							else{
								sbStagesCondition.append(" AND H.ORDER_STATUS_TYPE IN ('10', '35','30','56','25') AND A.PATIENT_CLASS IN('OP','EM','XT') ");
							}
						}
					}
					else {
						if(getIssueTokenOnRegnYN().equals("N")){
							if(scope.equals("EX")){
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE = '35' AND A.PATIENT_CLASS = 'XT'");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE = '35' AND A.PATIENT_CLASS IN('OP','EM')");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
						} 
						else {
							if(scope.equals("EX")){
								sbStagesCondition.append("AND H.ORDER_STATUS_TYPE = '35' AND A.PATIENT_CLASS = 'XT'");
							}
							else{
								sbStagesCondition.append( "AND H.ORDER_STATUS_TYPE = '35' AND A.PATIENT_CLASS IN('OP','EM','XT')");
							}
						}
					}
				}
			}

			// This is formed dynamically depending status...
			sbConstructSql= new StringBuffer();
			//String bmsCheck = "/*This condition is used for partiallty allocated order lines*/ OR ( B.ORDER_QTY>NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_LINE_NUM= B.ORDER_LINE_NUM AND ORDER_ID=A.ORDER_ID),0)) )";
			String strappend3=""; 
			String strStagesCondition1="";
			if(disp_stage.equals("AS")){
				if (scope.equals("EX")){
					strStagesCondition1 ="AND A.PATIENT_CLASS ='XT'";
				}
				else if(scope.equals("H")){
					strStagesCondition1 ="AND A.PATIENT_CLASS IN('OP','EM','XT')";
				}
				else{
					strStagesCondition1 ="AND A.PATIENT_CLASS IN('OP','EM')";
				}

				if(verf_combined_with_alloc.equals("C")){
					strappend3=" ORDER_STATUS_TYPE = '25' ";
				}
				else{
					strappend3=" ORDER_STATUS_TYPE = '30' ";
				}

				if (disp_regn_reqd_yn.equals("N")){
					if(verf_combined_with_alloc.equals("C")){
						strappend3=" ORDER_STATUS_TYPE in( '10','94') ";
					}
					else{
						strappend3=" ORDER_STATUS_TYPE IN('30','94')";
					}
				}

				if (scope.equals("A")){				//	A --> All Prescriptions
					if(this.order_date_from.equals("") && this.order_date_to.equals(""))//if condition & else block added for ML-BRU-SCF-0378[IN034797] & ML-BRU-SCF-0638 [IN:036848]
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','56','50','94') ");//'35','36', removed for TTM-SCF-0097 [IN:048812]
					else{
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','56','50','94') ");
						if(!verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y")){// If added for ML-BRU-SCF-1379[IN049771]
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
									sbConstructSql.append("OR ( ORDER_STATUS_TYPE ='56' AND K.next_collection_date BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ) "); // Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
								else if(!this.order_date_from.equals(""))
									sbConstructSql.append("OR ( ORDER_STATUS_TYPE ='56' AND K.next_collection_date >= TO_DATE(?,'dd/mm/yyyy hh24:mi'))  ");// Added parameter - KAUH-SCF-0183[IN:047989]//'35','36', removed for TTM-SCF-0097 [IN:048812]
								else if(!this.order_date_to.equals(""))
									sbConstructSql.append("OR ( ORDER_STATUS_TYPE ='56' AND K.next_collection_date <= TO_DATE(?,'dd/mm/yyyy hh24:mi'))  ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!this.order_date_from.equals("") && !this.order_date_to.equals(""))
									sbConstructSql.append("OR ( ORDER_STATUS_TYPE ='56' AND K.next_collection_date BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999  ) "); // Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
								else if(!this.order_date_from.equals(""))
									sbConstructSql.append("OR ( ORDER_STATUS_TYPE ='56' AND K.next_collection_date >= TO_DATE(?,'DD/MM/YYYY'))  ");// Added parameter - KAUH-SCF-0183[IN:047989]//'35','36', removed for TTM-SCF-0097 [IN:048812]
								else if(!this.order_date_to.equals(""))
									sbConstructSql.append("OR ( ORDER_STATUS_TYPE ='56' AND K.next_collection_date <= TO_DATE(?,'DD/MM/YYYY')+ 0.99999)  ");// Added parameter - KAUH-SCF-0183[IN:047989] //'35','36', removed for TTM-SCF-0097 [IN:048812]
							}	
						}
					}
					//sbConstructSql.append(bmsCheck); //- bmsCheck commented
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" ) "); // OR A.CHILD_ORDER_YN='Y' OR A.DISCHARGE_IND='D'commented for MMS-Adhoc [IN:046372]
				}
				else if (scope.equals("P")){		// P --> Pending Prescriptions
					if (disp_regn_reqd_yn.equals("Y")){
						sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE (");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(")");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" )");
						//sbConstructSql.append(bmsCheck); //- bmsCheck commented
					}
					else{
						sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE (");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(")");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" )");
						//sbConstructSql.append(bmsCheck);//- bmsCheck commented
					}
				}
				else if (scope.equals("PD")){		// P --> Pending Prescriptions
					if (disp_regn_reqd_yn.equals("Y")){
						sbConstructSql.append( " AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE (");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(")");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" )");
						//sbConstructSql.append(bmsCheck);
					}
					else{
						sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE (");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(")");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" )");
						//sbConstructSql.append(bmsCheck);//- bmsCheck commented
					}
				}
				else if (scope.equals("B")){		// B --> BMS Prescriptions
					if (disp_regn_reqd_yn.equals("Y")){
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbConstructSql.append(strappend3);
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" )");
						//sbConstructSql.append(bmsCheck); //- bmsCheck commented
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							sbConstructSql.append(" AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
						}//Added MMS-DM-CRF-0228 end
						else{
							sbConstructSql.append(" AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
						}
						
					}
					else{
						if(verf_combined_with_alloc.equals("C")){
							sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in( '56','94') ");
							sbConstructSql.append(sbStagesCondition.toString());
							sbConstructSql.append(" )");
							//sbConstructSql.append(bmsCheck); //- bmsCheck commented
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								sbConstructSql.append(" AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
							}//Added MMS-DM-CRF-0228 end
							else{
								sbConstructSql.append(" AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
							}
						}
						else{
							sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in( '30','94') ");
							sbConstructSql.append(sbStagesCondition.toString());
							sbConstructSql.append(" )");
							//sbConstructSql.append(bmsCheck);//- bmsCheck commented
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								sbConstructSql.append(" AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
							}//Added MMS-DM-CRF-0228 end
							else{
								sbConstructSql.append(" AND K.NEXT_COLLECTION_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
							}
							
						}
					}
				}
				else if (scope.equals("R")){		// R --> Refill Prescriptions
				if (disp_regn_reqd_yn.equals("Y")){
					sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
					sbConstructSql.append(strappend3);
					sbConstructSql.append(" ) ");
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" AND A.CHILD_ORDER_YN='Y'");
					//sbConstructSql.append(bmsCheck);//- bmsCheck commented
					}
					else{
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10','25','94')) ");// IN Added instead of OR KAUH-SCF-0183[IN:047989]
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" AND A.CHILD_ORDER_YN='Y'");
						//sbConstructSql.append(bmsCheck);//- bmsCheck commented
					}
				}
				else if (scope.equals("D")){		// D --> Discharge Medication
					if (disp_regn_reqd_yn.equals("Y")){
							sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.DISCHARGE_IND='D' AND ");
							sbConstructSql.append(strappend3);
							sbConstructSql.append(")");
							sbConstructSql.append(sbStagesCondition.toString());
							//sbConstructSql.append(bmsCheck);//- bmsCheck commented
						}
						else{
							sbConstructSql.append(" AND A.CHILD_ORDER_YN!='Y' AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE A.DISCHARGE_IND='D' AND ORDER_STATUS_TYPE IN('10','25','56','94') ");// IN Added instead of OR KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(sbStagesCondition.toString());
							//sbConstructSql.append(bmsCheck);//- bmsCheck commented
						}
					}
					else if (scope.equals("H")){
						sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE (ORDER_STATUS_TYPE = '50') ");
						sbConstructSql.append(sbStagesCondition.toString());
						sbConstructSql.append(" )");
						//sbConstructSql.append(bmsCheck);//- bmsCheck commented
					} 
					else if(scope.equals("EX")) {
						if (disp_regn_reqd_yn.equals("Y")){
							sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
							sbConstructSql.append(strappend3);
							sbConstructSql.append(sbStagesCondition.toString());
							sbConstructSql.append(" )");
							//sbConstructSql.append(bmsCheck);//- bmsCheck commented
						}
						else{
							sbConstructSql.append(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10','25','56','94') ");// IN Added instead of OR KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(sbStagesCondition.toString());
							sbConstructSql.append(" )");
							//sbConstructSql.append(bmsCheck);//- bmsCheck commented
						}
					}
				}

				if(getCriteriaOrderType().equals("ALL")) {
					sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
				}
				else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
					sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
				} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
				else if(getOrderType().equals("NOR")) {
					sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
				} 
				else if(getOrderType().equals("IVAD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVAA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVWA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVID")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getOrderType().equals("IVIA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
				else if(getOrderType().equals("TD")) {
					sbConstructSql.append( " AND A.IV_PREP_YN ='7' ");
				} 
				else if(getOrderType().equals("TA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
				} 
				else if(getOrderType().equals("CD")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
				} 
				else if(getOrderType().equals("CA")) {
					sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
				} 
				else if(getOrderType().equals("CO")) {
					sbConstructSql.append( " AND A.IV_PREP_YN = '6' ");
				}
				if(!(getOrderType().equals("TA") || getOrderType().equals("TD"))){
					sbConstructSql.append(" /*and a.ORDERING_FACILITY_ID=?*/  AND( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");//modified for ML-BRU-SCF-1927
					if(!(this.drug_medical.equals("")))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbConstructSql.append(" and i.DRUG_YN = ? ");
					sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
				}
				sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
			 if(!getIssueTokenOnRegnYN().equals("Y")){ // if,else Added for Regression Issue DEC-2018
				sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' ") ;
				if(!scope.equals("EX"))		 //added for ICN69800			
				sbConstructSql.append("AND a.source_code = NVL(?,a.source_code)"); 

					sbConstructSql.append("and A.PERFORMING_DEPTLOC_CODE = '"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
			 }
			 else
				 sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' and A.PERFORMING_DEPTLOC_CODE = '"); 
			 if(getDispLocnCode().trim().equals("all"))
			 {
				 sbConstructSql.append(getDisp_locn_codeall()); 
			 }else
			 {
				 sbConstructSql.append(getDispLocnCode());
			 }
				if(disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE"))//	Inpatient
					sbConstructSql.append("' GROUP BY A.TRN_GROUP_REF,A.ENCOUNTER_ID,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,A.IV_PREP_YN,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
				else
					sbConstructSql.append("' GROUP BY A.TRN_GROUP_REF,A.ENCOUNTER_ID,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,A.IV_PREP_YN,a.MODIFIED_DATE ORDER BY A.PRIORITY");
			/*	Based on the drug class, form the condition which should be appended to the Query.	*/
			/*ArrayList arrListDrug = null;
			if (arrListdrugClass == null){
				arrListDrug = buildDrugRelatedSQL(disp_locn_code);
			}
			else{
				arrListDrug = arrListdrugClass;
			}

			String strDrugRelatedSQL = " AND A.ORDER_TYPE_CODE IN (SELECT ORDER_TYPE_CODE FROM PH_ORDER_TYPE_FOR_DRUG_CLASS WHERE ";
			int k=1;
			for (int i=0;i<arrListDrug.size();i++){
				if (i==0){
					strDrugRelatedSQL += (" DRUG_CLASS = '"+(String)arrListDrug.get(i)+"' ");
				}else{
					strDrugRelatedSQL += (" OR DRUG_CLASS = '"+(String)arrListDrug.get(i)+"' ");;
				}
				k++;
			}
			strDrugRelatedSQL += " ) ";
			if (k==1){
				strDrugRelatedSQL = "";
			}*/
			sbDrugRelateSQL = new StringBuffer(" AND A.ORDER_TYPE_CODE IN (SELECT ORDER_TYPE_CODE FROM PH_ORDER_TYPE_FOR_DRUG_CLASS)");
			if(getDispExpOrders().equals("N"))	//if block Added for ML-BRU-SCF-0636 [IN:036826]
				sbDrugRelateSQL.append("AND b.end_date_time >= SYSDATE ");  //Added for ML-BRU-SCF-0636  IN#36826  //Modified for ML-MMOH-SCF-0393 [IN:060238] // Space given after SYSDATE [IN061796]
			// This is to display order comments
			pstmt1 = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT23") ); 
			if(disp_locn_catg.equals("I")){	//	Inpatient
				//Added for 	PMG20089-CRF-0867 IN[029813] -Start
				String tab_based_group_sort_disp = getTabBasegGroupSortDisp();
			//	String customGroupBySql="", customSortBySql = ""; Removed for IN063877
				String customTabBased = getCustomTabBased();
				String customTabBasedHrs = getCustomTabBasedHrs();
				String customTabBasedOption = getCustomTabBasedOption();
				//Added for 	PMG20089-CRF-0867 IN[029813] -End

				if(disp_stage.equals("V")){	// Verification stage
					sbConstructSql = new StringBuffer();
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
					//AND c.order_status_type IN ('10', '56', '50')
					if(ip_scope.equals("H")){
						sbConstructSql.append(" AND c.order_status_type = '50' ");
					}
					else if(ip_scope.equals("N")){
						sbConstructSql.append(" AND c.order_status_type in('10','25') ");//Added 25 for ML-BRU-SCF-1338[IN049193]
					}
					else if(ip_scope.equals("R")){
						sbConstructSql.append(" AND c.order_status_type = '56' ");
					}

					if(getCriteriaOrderType().equals("ALL")) {
						sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
					}
					else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
						sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
					} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
					else if(getOrderType().equals("NOR")) {
						sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
					}
					else if(getOrderType().equals("IVAD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVAA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVWA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVID")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVIA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("TD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
					} 
					else if(getOrderType().equals("TA")) {
						sbConstructSql.append( " AND A.IV_PREP_YN ='8' ");
					} 
					else if(getOrderType().equals("CD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
					} 
					else if(getOrderType().equals("CA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
					} 
					else if(getOrderType().equals("CO")) {
						sbConstructSql.append( " AND A.IV_PREP_YN = '6' ");
					}
					sbConstructSql.append( " and exists (select 'X' from ip_open_encounter ioen where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id ");//added to filter only current Inpatient. // closed bracket ')' removed for KDAH-CRF-0338 //ioen aliases addeed for KDAH-CRF-0338
					//Added for 	PMG20089-CRF-0867 IN[029813] -Start
					//KDAH-CRF-0338 starts
					if(!bed_no.equals("")){
						sbConstructSql.append( " AND bed_num =? AND EXISTS (SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = j.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = j.order_line_num AND bed_no=ioen.bed_num ) )"); //Modified for KDAH-CRF-0338
					}else{
						sbConstructSql.append( ")");
					}//KDAH-CRF-0338 ends
					if( tab_based_group_sort_disp.equals("Y")  ){
						if(customTabBased.equals("Y")){
							if(customTabBasedOption.equals("PAST"))
								sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
							else
								sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
						}
					}
					//Added for 	PMG20089-CRF-0867 IN[029813] -End
					if(getOrderType().equals("TA") ||getOrderType().equals("TD")) {
						sbConstructSql.append(" and a.ORDERING_FACILITY_ID=? ");
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.source_code = NVL(?,a.source_code) "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							else
								sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.source_code = NVL(?,a.source_code) ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564] // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
						}//Added MMS-DM-CRF-0228 end
						else{
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 AND a.source_code = NVL(?,a.source_code) "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							else
								sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 AND a.source_code = NVL(?,a.source_code) ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564] // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
						}
						sbConstructSql.append(" GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
						sbMainSql.append("SELECT A.TRN_GROUP_REF,a.priority, a.iv_prep_yn, e.long_desc LOCATION, a.order_id, TO_CHAR (a.ord_date_time,'DD/MM/YYYY HH24:MI') ord_date_time,f.practitioner_name,DECODE (a.ordering_facility_id,a.performing_facility_id, '',g.facility_name) facility_name,f.practitioner_id, a.encounter_id,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, j.TAPERED_YN, j.TAPER_ORDER_ID FROM or_order_line b,  or_order a,ip_nursing_unit_lang_vw e, or_order_status_code c,sm_facility_param_lang_vw g,am_practitioner_lang_vw f, or_order_line_ph j WHERE  b.order_id = a.order_id AND b.order_id=j.order_id and b.order_line_num = j.order_line_num   AND g.facility_id = a.ordering_facility_id     AND a.ord_pract_id = f.practitioner_id  AND e.nursing_unit_code = a.source_code AND c.order_status_code =b.order_line_status ");
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND e.nursing_unit_code = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription)
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND a.patient_id = ? ");
						sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /* Check for IP AND ORDER CATEGORY*/  AND a.patient_class in ('IP','DC') AND a.order_category = 'PH' AND a.performing_deptloc_code = ? AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						pstmt = connection.prepareStatement( sbMainSql.toString()+sbConstructSql.toString()) ;
					}
					else{
						sbConstructSql.append(" and a.ORDERING_FACILITY_ID=? ");
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
							else
								sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
						}//Added MMS-DM-CRF-0228 end
						else{
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
							else
								sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
						}
						//Added for SRR20056-CRF-0663	--Start
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
							sbConstructSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and ( (i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
						}
						else{
							sbConstructSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
						}
						//Added for SRR20056-CRF-0663	--End
						if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbConstructSql.append(" and i.DRUG_YN = ? ");
						sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
						sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
						sbMainSql.append("SELECT A.TRN_GROUP_REF,a.priority, a.iv_prep_yn, e.long_desc LOCATION, a.order_id, TO_CHAR (a.ord_date_time,'DD/MM/YYYY HH24:MI') ord_date_time,f.practitioner_name,DECODE (a.ordering_facility_id,a.performing_facility_id, '',g.facility_name) facility_name,f.practitioner_id, a.encounter_id,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, J.TAPERED_YN, J.TAPER_ORDER_ID FROM or_order_line b, or_order a, ip_nursing_unit_lang_vw e, or_order_status_code c,sm_facility_param_lang_vw g,am_practitioner_lang_vw f,ph_drug i, or_order_line_ph j WHERE  b.order_id = a.order_id    AND b.order_id=j.order_id and b.order_line_num = j.order_line_num and g.facility_id = a.ordering_facility_id  AND a.ord_pract_id = f.practitioner_id  AND e.nursing_unit_code = a.source_code AND c.order_status_code =b.order_line_status ");
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND e.nursing_unit_code = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription)
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND a.patient_id = ? ");
						if(getPhAltDispLocnYN().equals("Y"))//removed ph_disp_locn_appl_yn and added A.PERFORMING_DEPTLOC_CODE and added  for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /* Check for IP AND ORDER CATEGORY*/  AND a.patient_class in ('IP','DC') AND a.order_category = 'PH' AND A.PERFORMING_DEPTLOC_CODE=?  AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? and b.order_catalog_code=i.drug_code "); //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						else
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /* Check for IP AND ORDER CATEGORY*/  AND a.patient_class in ('IP','DC') AND a.order_category = 'PH' AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? and b.order_catalog_code=i.drug_code ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						pstmt = connection.prepareStatement( sbMainSql.toString()+sbConstructSql.toString()) ;
						//System.err.println("======IP VErification=========sbMainSql=========>"+sbMainSql+sbConstructSql.toString());
					}
					int position = 0;
					if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,nursing_unit);
					if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,priority);
					if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,pat_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDispLocnCode());
					pstmt.setString(++position,getLanguageId());
					if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						pstmt.setString(++position,bed_no); //Added for KDAH-CRF-0338
					pstmt.setString(++position,this.orderingfacility);
					pstmt.setString(++position,this.order_date_from);
					pstmt.setString(++position,this.order_date_to);
					if(!(getOrderType().equals("TA")|| getOrderType().equals("TD"))) {
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
							pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						}
						pstmt.setString(++position,this.exclude_PRN_orders);
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					}
					if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){
						pstmt.setString(++position,customTabBasedHrs);		// Added parameter - KAUH-SCF-0183[IN:047989]
					}
					pstmt.setString(++position,locnCode);		// Added for BSP-SCF-0060
				}
				else if(disp_stage.equals("F") && fill_list.equals("AF")){
					// Filling stage and against Fill list
					sbAppendSql = new StringBuffer();
					sbConstructSql = new StringBuffer();
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]  // commond not properly ended so changed for [IN061796]
					if(getOrderStatus().equals("OSN")){		// Order Status is new
						sbAppendSql.append( " AND C.ORDER_STATUS_TYPE IN ('10','25','30','36','35') AND k.LAST_DISPENSED_DATE IS NULL ");
					}
					else if(getOrderStatus().equals("H")){
						sbAppendSql.append(" AND C.ORDER_STATUS_TYPE = '50' ");
					}
						if(getCriteriaOrderType().equals("ALL")) {
							//strAppend = "";
						}
						else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
							sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
						} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
						else if(getOrderType().equals("NOR")) {
							sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
						} 
						else if(getOrderType().equals("IVAD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(getOrderType().equals("IVAA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVWA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(getOrderType().equals("IVID")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						} 
						else if(getOrderType().equals("IVIA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("TD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
						} 
						else if(getOrderType().equals("TA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
						}
						else if(getOrderType().equals("CD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
						}
						else if(getOrderType().equals("CA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
						} 
						else if(getOrderType().equals("CO")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
						}
						if(!getOrderStatus().equals("H")){
							if(getBatches().equals("BA")){			// Batches applicable
								sbAppendSql.append(" AND A.ORDER_ID IN (SELECT ORDER_ID FROM PH_DISP_DRUG_BATCH_TMP) ");
							}
							else if(getBatches().equals("BNA")){
								sbAppendSql.append( " AND A.ORDER_ID NOT IN (SELECT ORDER_ID FROM PH_DISP_DRUG_BATCH_TMP) ");
							}
						}
						sbAppendSql.append(" and a.ORDERING_FACILITY_ID=? ");
						//Added for SRR20056-CRF-0663	--Start
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
							sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
						}
						else{
							sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
						}
						//Added for SRR20056-CRF-0663	--End
						sbAppendSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id )");//added to filter only current Inpatient. //
						if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbAppendSql.append(" and i.DRUG_YN = ? ");
						sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
						sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' and h.FILL_INT_START_DATE_TIME =TO_DATE (?, 'dd/mm/yyyy hh24:mi') AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.IV_PREP_YN,F.PRACTITIONER_NAME,a.ENCOUNTER_ID,a.MODIFIED_DATE,G1.FILL_PROC_ID, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060

						if(getOrderStatus().equals("H")){
							sbMainSql.append("SELECT A.TRN_GROUP_REF,A.PRIORITY,A.IV_PREP_YN, E.LONG_DESC LOCATION, A.ORDER_ID, TO_CHAR(A.ORD_DATE_TIME, 'DD/MM/YYYY HH24:MI') ORD_DATE_TIME , F.PRACTITIONER_NAME, DECODE(A.ORDERING_FACILITY_ID, A.PERFORMING_FACILITY_ID,'', G.FACILITY_NAME) FACILITY_NAME, F.PRACTITIONER_ID, F.PRACTITIONER_NAME, a.ENCOUNTER_ID, TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME,H.FILL_PROC_ID FILL_PROC_ID, J.TAPERED_YN, J.TAPER_ORDER_ID FROM OR_ORDER_LINE B, OR_ORDER A, IP_NURSING_UNIT_LANG_VW E , OR_ORDER_STATUS_CODE C, SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F, PH_FILL_PROCESS_PARAM H,ph_drug i,or_order_line_ph j WHERE /* JOIN CONDITIONS START HERE */ B.ORDER_ID=A.ORDER_ID AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID(+) AND E.NURSING_UNIT_CODE=A.SOURCE_CODE AND E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND h.fill_proc_id =j.fill_proc_id ");
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* Check for Nursing Unit Code here */ AND e.nursing_unit_code = ? ");
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE */ AND A.PATIENT_ID =? ");
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND END_DATE */ AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* Check for status */ AND C.ORDER_STATUS_TYPE in ('10','25','30','36','35','50') /* Check for IP AND ORDER CATEGORY*/ AND A.PATIENT_CLASS in ('IP','DC') AND A.ORDER_CATEGORY='PH' AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'), a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getFillProcessID().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND  h.fill_proc_id = ? ");
							sbMainSql.append(" AND TRUNC (h.fill_proc_date_time) = DECODE (?,NULL, TRUNC (h.fill_proc_date_time),TRUNC (TO_DATE (?, 'dd/mm/yyyy'))) ");
							if(!getFillType().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND H.PROC_TYPE= ? "); 
							sbMainSql.append(" AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? and b.order_catalog_code=i.drug_code");
							pstmt = connection.prepareStatement( sbMainSql.toString()+sbConstructSql.toString()+ sbAppendSql.toString()) ; // removed a.ord_date_time BETWEEN SYSDATE - 365 AND SYSDATE + 365	AND for IN030219	SKR-SCF-0364 
						}
						else{
							sbMainSql.append( "SELECT A.TRN_GROUP_REF,A.PRIORITY,A.IV_PREP_YN, E.LONG_DESC LOCATION, A.ORDER_ID, TO_CHAR(A.ORD_DATE_TIME, 'DD/MM/YYYY HH24:MI') ORD_DATE_TIME , F.PRACTITIONER_NAME, DECODE(A.ORDERING_FACILITY_ID, A.PERFORMING_FACILITY_ID,'', G.FACILITY_NAME) FACILITY_NAME, F.PRACTITIONER_ID, F.PRACTITIONER_NAME, a.ENCOUNTER_ID, TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME ,G1.FILL_PROC_ID FILL_PROC_ID, K.TAPERED_YN, K.TAPER_ORDER_ID FROM OR_ORDER_LINE B, OR_ORDER A, IP_NURSING_UNIT_LANG_VW E , OR_ORDER_STATUS_CODE C, SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F, PH_DISP_HDR_TMP G1,PH_FILL_PROCESS_PARAM H,ph_drug i,or_order_line_ph k WHERE /* JOIN CONDITIONS START HERE */ B.ORDER_ID=A.ORDER_ID AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID(+) AND E.NURSING_UNIT_CODE=A.SOURCE_CODE AND E.FACILITY_ID=A.ORDERING_FACILITY_ID AND C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND B.ORDER_ID=G1.ORDER_ID AND H.FILL_PROC_ID=G1.FILL_PROC_ID ");
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* Check for Nursing Unit Code here */ AND e.nursing_unit_code = ? ");
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE */ AND A.PATIENT_ID =? ");
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND END_DATE */ AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* Check for status */ AND C.ORDER_STATUS_TYPE in ('10','25','30','36','35') /* Check for IP AND ORDER CATEGORY*/ AND A.PATIENT_CLASS IN ('IP','DC') AND A.ORDER_CATEGORY='PH' and b.ORDER_ID=k.ORDER_ID and b.ORDER_LINE_NUM= k.ORDER_LINE_NUM AND G1.disp_locn_code=? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getFillProcessID().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" /* CHECK FOR FILL PROCESS ID,DATE,TYPE */ AND G1.FILL_PROC_ID=? ");
							sbMainSql.append(" AND TRUNC(G1.RECORD_DATE_TIME)=decode(?,null,TRUNC(G1.RECORD_DATE_TIME),TRUNC(TO_DATE(?,'dd/mm/yyyy'))) ");
							if(!getFillType().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND H.PROC_TYPE=? ");
							sbMainSql.append(" AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? and b.order_catalog_code=i.drug_code ");
							pstmt = connection.prepareStatement(sbMainSql.toString()+sbConstructSql.toString()+ sbAppendSql.toString()) ; 
						}

						int position=0;
						if(!nursing_unit.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,nursing_unit);
						if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,pat_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDispLocnCode());
						if(!getFillProcessID().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getFillProcessID());
						pstmt.setString(++position,getFillProcessDate());
						pstmt.setString(++position,getFillProcessDate());
						if(!getFillType().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getFillType());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,this.orderingfacility);
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
							pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						}
						pstmt.setString(++position,this.exclude_PRN_orders);
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
						pstmt.setString(++position,getFillDateTime());	
						pstmt.setString(++position,locnCode);		// Added for BSP-SCF-0060

					//}
				/*	if(getBatches().equals("BNA")){
						strAppendForIP = strAppendForIP + " GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.SHORT_DESC,A.IV_PREP_YN,F.PRACTITIONER_NAME,A.ENCOUNTER_ID ORDER BY A.PRIORITY ";
						pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_IP_MEDICATION_SELECT7A")+strAppend+strAppendForIP) ;						
						pstmt.setString(1,nursing_unit.trim());
						pstmt.setString(2,pat_id.trim());
						pstmt.setString(3,login_facility_id.trim());
						pstmt.setString(4,getDispLocnCode().trim());
						pstmt.setString(5,getFillType().trim());
						pstmt.setString(6,getFillDateTime());
						
					}*/
				}
				else if((disp_stage.equals("F") && fill_list.equals("WF"))|| disp_stage.equals("A")){
					// Filling stage and Without Fill List
					sbAppendSql = new StringBuffer();
					if(!this.order_date_from.equals("") && !this.order_date_to.equals("") ){
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(ip_scope.equals("R")){//if block and else condition for ML-BRU-SCF-1147 [IN045177]
								if(getFilter_on_next_fill_date().equals("Y")) 
									sbAppendSql.append(" AND H.NEXT_FILL_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");	
								else
									sbAppendSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND H.LAST_DISPENSED_DATE IS NOT NULL");//A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
							}
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbAppendSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbAppendSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(ip_scope.equals("R")){//if block and else condition for ML-BRU-SCF-1147 [IN045177]
								if(getFilter_on_next_fill_date().equals("Y")) 
									sbAppendSql.append(" AND H.NEXT_FILL_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999");	
								else
									sbAppendSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 AND H.LAST_DISPENSED_DATE IS NOT NULL");//A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
							}
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbAppendSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbAppendSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
					}
					sbConstructSql = new StringBuffer();
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
					if(getCriteriaOrderType().equals("ALL")) {
						sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
					}
					else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
						sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
					} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
					else if(getOrderType().equals("NOR")) {
						sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
					} 
					else if(getOrderType().equals("IVAD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVAA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else if(getOrderType().equals("IVWA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVID")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVIA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else if(getOrderType().equals("TD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
					} 
					else if(getOrderType().equals("TA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
					}
					else if(getOrderType().equals("CD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
					}
					else if(getOrderType().equals("CA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
					}
					else if(getOrderType().equals("CO")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
					}
					sbConstructSql.append(" and exists (select 'X' from ip_open_encounter ioen where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id ");//added to filter only current Inpatient. // closed bracket ')' removed for KDAH-CRF-0338 //ioen aliases addeed for KDAH-CRF-0338
					//KDAH-CRF-0338 starts
					if(!bed_no.equals("")){
						sbConstructSql.append( " AND bed_num =? AND EXISTS (SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = h.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = h.order_line_num AND bed_no=ioen.bed_num ) )"); // Modified for KDAH-CRF-0338
					}else{
						sbConstructSql.append( ")");
					}//KDAH-CRF-0338 ends
					
					if(isSite_ph_new_prescription && fill_list.equals("WF") && disp_stage.equals("F") && !getPrescription_no().equals("")){
						sbConstructSql.append(" AND A.TRN_GROUP_REF=? ");
					}
					
					//Added for 	PMG20089-CRF-0867 IN[029813] -Start
					if( tab_based_group_sort_disp.equals("Y")  ){
						if(customTabBased.equals("Y")){
							if(customTabBasedOption.equals("PAST"))
								sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989] 
							else
								sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24)  ");// Added parameter - KAUH-SCF-0183[IN:047989] 
						}
					}
					//Added for 	PMG20089-CRF-0867 IN[029813] -End
					/*if(ip_scope.equals("R"))//code  added for ML-BRU-SCF-0921[IN041388]
						sbConstructSql.append(" AND TRUNC(h.NEXT_FILL_DATE) = TRUNC(SYSDATE) "); */ //code  added for ML-BRU-SCF-0921[IN041388] //Commented for SKR-SCF-0873 [IN044501]

					if(getIPVerificationYN().equals("Y")){ 
						
						if(ip_scope.equals("A")){    // if condition Added for ML-MMOH-CRF-0434 [IN057356]	- Start
							if(getCriteriaOrderType().equals("ALL")){
								sbAppendSql.append(" AND ((( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL (k.finalized_yn, 'N') != 'Y' and C.ORDER_status_type in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and C.ORDER_status_type in ('30','94')))	AND H.LAST_DISPENSED_DATE IS NULL) OR (C.ORDER_STATUS_TYPE ='50') OR ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and c.order_status_type in ('25','56','94')))	AND H.LAST_DISPENSED_DATE IS NOT NULL) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbAppendSql.append(" AND ((( (a.iv_prep_yn='0' and NVL (k.finalized_yn, 'N') != 'Y' and C.ORDER_status_type in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and C.ORDER_status_type in ('30','94')))	AND H.LAST_DISPENSED_DATE IS NULL) OR (C.ORDER_STATUS_TYPE ='50') OR ( (a.iv_prep_yn='0' and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and c.order_status_type in ('25','56','94')))	AND H.LAST_DISPENSED_DATE IS NOT NULL) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code)  GROUP BY A.IV_PREP_YN ,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
									if(getOrderType().equals("TA")||getOrderType().equals("TD")){
										if(getOrderType().equals("TA") ||  (getOrderType().equals("TD") && siteTpn )){//added for ml-mmoh-crf-0468
											sbAppendSql.append(" AND ((NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('30','35') AND H.LAST_DISPENSED_DATE IS NULL) OR (C.ORDER_STATUS_TYPE ='50') OR (C.ORDER_STATUS_TYPE IN('56','35') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND H.LAST_DISPENSED_DATE IS NOT NULL)) and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
										}
										else {
											sbAppendSql.append(" AND ((NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE ='30' AND H.LAST_DISPENSED_DATE IS NULL) OR (C.ORDER_STATUS_TYPE ='50') OR (C.ORDER_STATUS_TYPE IN('56','35') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND H.LAST_DISPENSED_DATE IS NOT NULL)) and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");// = Added instead of IN KAUH-SCF-0183[IN:047989]
										}
									}
									else{
										sbAppendSql.append(" AND ((NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('30','35')AND H.LAST_DISPENSED_DATE IS NULL) OR (C.ORDER_STATUS_TYPE ='50') OR (C.ORDER_STATUS_TYPE IN('56','35') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND H.LAST_DISPENSED_DATE IS NOT NULL)) and a.ORDERING_FACILITY_ID=? ");
										if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
											sbAppendSql.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N') ");
										}
										else{
											sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
										}
										if(!this.drug_medical.equals(""))  
											sbAppendSql.append(" and i.DRUG_YN = ? ");
										sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
										sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
									}
								}
								else{
									sbAppendSql.append(" AND ((C.ORDER_STATUS_TYPE IN('30','94')AND H.LAST_DISPENSED_DATE IS NULL) OR (C.ORDER_STATUS_TYPE ='50') OR (C.ORDER_STATUS_TYPE IN('56','94')AND H.LAST_DISPENSED_DATE IS NOT NULL ) ) and a.ORDERING_FACILITY_ID=? ");
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql.append( " and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N') ");
									}
									else{
										sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
									}
									if(!this.drug_medical.equals(""))  
										sbAppendSql.append(" and i.DRUG_YN = ? ");
									sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
									sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}						
						} 	 // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
						else if(ip_scope.equals("H")){
							if(getOrderType().equals("TA")||getOrderType().equals("TD")){
								sbAppendSql.append("  AND C.ORDER_STATUS_TYPE ='50' and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbAppendSql.append("  AND C.ORDER_STATUS_TYPE ='50' and a.ORDERING_FACILITY_ID=? ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						} 
						else if(ip_scope.equals("N")){
							if(getCriteriaOrderType().equals("ALL")){
								sbAppendSql.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL (k.finalized_yn, 'N') != 'Y' and C.ORDER_status_type in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and C.ORDER_status_type in ('30','94')))	AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060
							}
							else if(getCriteriaOrderType().equals("CDR") ){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbAppendSql.append(" AND ( (a.iv_prep_yn='0' and NVL (k.finalized_yn, 'N') != 'Y' and C.ORDER_status_type in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and C.ORDER_status_type in ('30','94')))	AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0') OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								if(!this.drug_medical.equals("")) 
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}  // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
									if(getOrderType().equals("TA")||getOrderType().equals("TD")){
										if(getOrderType().equals("TA") || (getOrderType().equals("TD") && siteTpn )){//added for ml-mmoh-crf-0468
											sbAppendSql.append(" AND (NVL (k.finalized_yn, 'N') != 'Y' OR k.qty_volume < h.bms_qty) AND C.ORDER_STATUS_TYPE IN('30','35') AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
										}
										else {
											sbAppendSql.append(" AND (NVL (k.finalized_yn, 'N') != 'Y'  OR  k.qty_volume < h.bms_qty) AND C.ORDER_STATUS_TYPE ='30' AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");// = Added instead of IN KAUH-SCF-0183[IN:047989]
										}
									}
									else{
										sbAppendSql.append(" AND NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('30','35')AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
										//Added for SRR20056-CRF-0663	--Start
										if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
											sbAppendSql.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N') ");
										}
										else{
											sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
										}
										//Added for SRR20056-CRF-0663	--End
										if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
											sbAppendSql.append(" and i.DRUG_YN = ? ");
										sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
									}
								}
								else{
									sbAppendSql.append("AND C.ORDER_STATUS_TYPE IN('30','94')AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql.append( " and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N') ");
									}
									else{
										sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(" and i.DRUG_YN = ? ");
									sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
						}
						else {
							if(getCriteriaOrderType().equals("ALL")){
								// AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL (k.finalized_yn, 'N') != 'Y'and f.ORDER_status_code in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and f.ORDER_status_code in ('30','94'))) 
								sbAppendSql.append( " AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(c.order_status_type,'56','Y','35','N','62','Y') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56','35','62') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and c.order_status_type in ('25','56','94','62')))	AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");//Added 25 for ML-BRU-SCF-1338[IN049193]//,'62','Y' added for MMS-KH-CRF-0014

								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357] 
								sbAppendSql.append( " AND ( (a.iv_prep_yn='0' and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and c.order_status_type in ('25','56','94')))	AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0') OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
									if(getOrderType().equals("TA")||getOrderType().equals("TD")){
										sbAppendSql.append(" AND C.ORDER_STATUS_TYPE IN('56','35') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // space added for MOHE-SCF-0272
									}
									else{
										sbAppendSql.append(" AND C.ORDER_STATUS_TYPE IN('56','35') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? "); // space added for MOHE-SCF-0272
										//Added for SRR20056-CRF-0663	--Start
										if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
											sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
										}
										else{
											sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
										}
										//Added for SRR20056-CRF-0663	--End
										if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
											sbAppendSql.append(" and i.DRUG_YN = ? ");
										sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
									}
								}
								else{
									sbAppendSql.append(" AND C.ORDER_STATUS_TYPE IN('56','94')AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");// space added for MOHE-SCF-0272
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql.append( " and ( (i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N') ");
									}
									else{
										sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(" and i.DRUG_YN = ? ");
									sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
					}						
					}
					else{
						
						if(ip_scope.equals("A")){   // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
							if(getCriteriaOrderType().equals("ALL")){
								sbAppendSql.append(" AND (H.LAST_DISPENSED_DATE IS NULL AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and C.ORDER_STATUS_TYPE in ('10','94','25','30'))) OR (C.ORDER_STATUS_TYPE ='50') OR (H.LAST_DISPENSED_DATE IS NOT NULL AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35) ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and C.ORDER_STATUS_TYPE in ('25','56','94'))))) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357] 
								sbAppendSql.append(" AND (H.LAST_DISPENSED_DATE IS NULL AND ( (a.iv_prep_yn='0' and NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and C.ORDER_STATUS_TYPE in ('10','94','25','30'))) OR (C.ORDER_STATUS_TYPE ='50') OR (H.LAST_DISPENSED_DATE IS NOT NULL AND ( (a.iv_prep_yn='0' and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35) ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and C.ORDER_STATUS_TYPE in ('25','56','94'))))) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0',) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357] 
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
									if(getOrderType().equals("TA")||getOrderType().equals("TD")){
										if(getOrderType().equals("TA")){
											sbAppendSql.append(" AND (H.LAST_DISPENSED_DATE IS NULL AND NVL(k.finalized_yn,'N') != 'Y'AND C.ORDER_STATUS_TYPE IN('10','35') OR (C.ORDER_STATUS_TYPE ='50') OR (H.LAST_DISPENSED_DATE IS NOT NULL AND DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35))) and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
										}
										else{
											sbAppendSql.append( " AND (H.LAST_DISPENSED_DATE IS NULL AND NVL(k.finalized_yn,'N') != 'Y'AND C.ORDER_STATUS_TYPE ='10' OR (C.ORDER_STATUS_TYPE ='50') OR (H.LAST_DISPENSED_DATE IS NOT NULL AND DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35)) ) and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
										}
									}
									else{
										sbAppendSql.append(" AND (H.LAST_DISPENSED_DATE IS NULL AND NVL(k.finalized_yn,'N') != 'Y'AND C.ORDER_STATUS_TYPE IN('10','35')OR (C.ORDER_STATUS_TYPE ='50') OR (H.LAST_DISPENSED_DATE IS NOT NULL AND DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35))) and a.ORDERING_FACILITY_ID=? ");
										if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
											sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
										}
										else{
											sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) " );
										}
										if(!this.drug_medical.equals(""))  
											sbAppendSql.append(" and i.DRUG_YN = ? ");
										sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
										sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
									}
								}
								else {
									sbAppendSql.append("AND ( C.ORDER_STATUS_TYPE IN('10','94') AND H.LAST_DISPENSED_DATE IS NULL OR(C.ORDER_STATUS_TYPE ='50') OR (H.LAST_DISPENSED_DATE IS NOT NULL AND C.ORDER_STATUS_TYPE IN('56','94'))) and a.ORDERING_FACILITY_ID=? ");
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql.append( " and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
									}
									else{
										sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
									}
									if(!this.drug_medical.equals(""))  
										sbAppendSql.append(" and i.DRUG_YN = ? ");
									sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
									sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}							
						} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
						else if(ip_scope.equals("H")){
							if(getOrderType().equals("TA")||getOrderType().equals("TD")){
								sbAppendSql.append("AND C.ORDER_STATUS_TYPE ='50' and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbAppendSql.append("AND C.ORDER_STATUS_TYPE ='50' and a.ORDERING_FACILITY_ID=? ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append( " and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append( " and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						} 
						else if(ip_scope.equals("N")){
							if(getCriteriaOrderType().equals("ALL")){
								// AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL (k.finalized_yn, 'N') != 'Y'and f.ORDER_status_code in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and f.ORDER_status_code in ('30','94')))
								sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NULL AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and C.ORDER_STATUS_TYPE in ('10','94','25','30'))) and a.ORDERING_FACILITY_ID=? ");//Added 30 for ML-BRU-SCF-1325//Added 25 for ML-BRU-SCF-1338[IN049193]

								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // Added for BSP-SCF-0060
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NULL AND ( (a.iv_prep_yn='0' and NVL(k.finalized_yn,'N') != 'Y' AND C.ORDER_STATUS_TYPE IN('10','35') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and C.ORDER_STATUS_TYPE in ('10','94','25','30'))) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0') OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals("")) 
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
									if(getOrderType().equals("TA")||getOrderType().equals("TD")){
										if(getOrderType().equals("TA")){
											sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NULL AND NVL(k.finalized_yn,'N') != 'Y'AND C.ORDER_STATUS_TYPE IN('10','35') and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
										}
										else{
											sbAppendSql.append( " AND H.LAST_DISPENSED_DATE IS NULL AND NVL(k.finalized_yn,'N') != 'Y'AND C.ORDER_STATUS_TYPE ='10' and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");// = Added instead of IN KAUH-SCF-0183[IN:047989]
										}
									}
									else{
										sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NULL AND NVL(k.finalized_yn,'N') != 'Y'AND C.ORDER_STATUS_TYPE IN('10','35') and a.ORDERING_FACILITY_ID=? ");
										//Added for SRR20056-CRF-0663	--Start
										if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
											sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
										}
										else{
											sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) " );
										}
										//Added for SRR20056-CRF-0663	--End
										if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
											sbAppendSql.append(" and i.DRUG_YN = ? ");
										sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060 
										}
								}
								else {
									sbAppendSql.append("AND C.ORDER_STATUS_TYPE IN('10','94') AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql.append( " and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
									}
									else{
										sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(" and i.DRUG_YN = ? ");
									sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
						} 
						else { 
							if(getCriteriaOrderType().equals("ALL")){
								// AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and NVL (k.finalized_yn, 'N') != 'Y'and f.ORDER_status_code in ('30','35') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and f.ORDER_status_code in ('30','94')))
								sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35) ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) and C.ORDER_STATUS_TYPE in ('25','56','94'))) and a.ORDERING_FACILITY_ID=? ");//Added 25 for ML-BRU-SCF-1338[IN049193]
								
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
							else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
								sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND ( (a.iv_prep_yn='0' and DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35) ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) and C.ORDER_STATUS_TYPE in ('25','56','94'))) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
								}
								if(!this.drug_medical.equals("")) 
									sbAppendSql.append(" and i.DRUG_YN = ? ");
								sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
									if(getOrderType().equals("TA")||getOrderType().equals("TD")){
										sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35) and a.ORDERING_FACILITY_ID=? GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY");
									}
									else{
										sbAppendSql.append( " AND H.LAST_DISPENSED_DATE IS NOT NULL AND DECODE(c.order_status_type,'56','Y','35','N') = k.finalized_yn AND C.ORDER_STATUS_TYPE IN('56',35) and a.ORDERING_FACILITY_ID=? ");
										//Added for SRR20056-CRF-0663	--Start
										if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
											sbAppendSql.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
										}
										else{
											sbAppendSql.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
										}
										//Added for SRR20056-CRF-0663	--End
										if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
											sbAppendSql.append(" and i.DRUG_YN = ? ");
										sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
									}
								}
								else{
									sbAppendSql.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND C.ORDER_STATUS_TYPE IN('56','94') and a.ORDERING_FACILITY_ID=? ");
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
									}
									else{
										sbAppendSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql.append(" and i.DRUG_YN = ? ");
									sbAppendSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN,A.TRN_GROUP_REF,A.SOURCE_TYPE,A.SOURCE_CODE,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
						}						
					}
					sbMainSql = new StringBuffer();
					if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")||getOrderType().equals("CA")||getCriteriaOrderType().equals("ALL") || getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
						sbMainSql.append("SELECT  A.TRN_GROUP_REF, A.PRIORITY,A.IV_PREP_YN, E.LONG_DESC LOCATION, A.ORDER_ID,  TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID,MIN(NVL(PRINT_VALUE,0))MIN_VALUE,MAX(NVL(PRINT_VALUE,0))MAX_VALUE  FROM    OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E   ,   OR_ORDER_STATUS_CODE C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH H,PH_WORKSHEET_HDR K,ph_drug i WHERE    /* JOIN CONDITIONS START HERE */    B.ORDER_ID=A.ORDER_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID     AND A.ORDERING_FACILITY_ID=E.FACILITY_ID  AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM AND  C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS    ");
						//,MIN(PRINT_VALUE)MIN_VALUE,MAX(PRINT_VALUE)MAX_VALUE  added for GHL-CRF-0453
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription && fill_list.equals("WF"))
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID AND   ORDER ID HERE  */  AND A.PATIENT_ID = ? ");
						if(getPhAltDispLocnYN().equals("Y"))
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */     AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1  /* Check for status */      /* Check for IP AND ORDER CATEGORY*/  AND A.PATIENT_CLASS='IP' AND A.ORDER_CATEGORY='PH' AND A.PERFORMING_DEPTLOC_CODE=?    AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND a.order_id = k.order_id(+) AND E.LANGUAGE_ID = F.LANGUAGE_ID AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? and b.order_catalog_code=i.drug_code ");//removed ph_disp_locn_appl_yn for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						else
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */     AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1  /* Check for status */      /* Check for IP AND ORDER CATEGORY*/  AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH' AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y'    AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND a.order_id = k.order_id(+) AND E.LANGUAGE_ID = F.LANGUAGE_ID AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? and b.order_catalog_code=i.drug_code ");//else added, ph_disp_locn_appl_yn for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					}
					else if(getOrderType().equals("NOR")||getOrderType().equals("IVAD")||getOrderType().equals("IVID")|| getOrderType().equals("IVWA")||getOrderType().equals("CD")){
						sbMainSql.append("SELECT   A.PRIORITY,A.IV_PREP_YN, E.LONG_DESC LOCATION, A.ORDER_ID,  TO_CHAR(A.ORD_DATE_TIME, 'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID, A.TRN_GROUP_REF, A.SOURCE_TYPE, A.SOURCE_CODE,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID,MIN(NVL(PRINT_VALUE,0))MIN_VALUE,MAX(NVL(PRINT_VALUE,0))MAX_VALUE   FROM    OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E , OR_ORDER_STATUS_CODE C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH H,ph_drug i WHERE    /* JOIN CONDITIONS START HERE */    B.ORDER_ID=A.ORDER_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID     AND A.ORDERING_FACILITY_ID=E.FACILITY_ID  AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM AND  C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS ");
						//,MIN(PRINT_VALUE)MIN_VALUE,MAX(PRINT_VALUE)MAX_VALUE  added for GHL-CRF-0453
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription && fill_list.equals("WF"))
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID AND   ORDER ID HERE  */  AND A.PATIENT_ID = ? ");
						if(getPhAltDispLocnYN().equals("Y"))
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */     AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1  /* Check for status */   /* Check for IP AND ORDER CATEGORY*/  AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH' AND A.PERFORMING_DEPTLOC_CODE=? AND E.NURSING_UNIT_CODE= A.SOURCE_CODE  AND E.LANGUAGE_ID = F.LANGUAGE_ID AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? and b.order_catalog_code=i.drug_code ");//removed ph_disp_locn_appl_yn for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
						else
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */     AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1  /* Check for status */   /* Check for IP AND ORDER CATEGORY*/  AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH' AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y'    AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE  AND E.LANGUAGE_ID = F.LANGUAGE_ID AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? and b.order_catalog_code=i.drug_code ");//else added for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					}
					else if(getOrderType().equals("TA")||getOrderType().equals("TD")){
						sbMainSql.append("SELECT   A.TRN_GROUP_REF,A.PRIORITY,A.IV_PREP_YN, E.LONG_DESC LOCATION, A.ORDER_ID,  TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID,MIN(NVL(PRINT_VALUE,0))MIN_VALUE,MAX(NVL(PRINT_VALUE,0))MAX_VALUE  FROM    OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E   ,   OR_ORDER_STATUS_CODE C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH H,PH_TPN_WORKSHEET_HDR K WHERE    /* JOIN CONDITIONS START HERE */    B.ORDER_ID=A.ORDER_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID     AND A.ORDERING_FACILITY_ID=E.FACILITY_ID  AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM AND  C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  ");
						//,MIN(PRINT_VALUE)MIN_VALUE,MAX(PRINT_VALUE)MAX_VALUE  added for GHL-CRF-453
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription && fill_list.equals("WF"))
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID AND   ORDER ID HERE  */  AND A.PATIENT_ID = ? ");
						sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */     AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1  /* Check for status */      /* Check for IP AND ORDER CATEGORY*/  AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH' AND A.PERFORMING_DEPTLOC_CODE=?  AND a.order_id = k.order_id(+)    AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND (NVL (k.finalized_yn, 'N') != 'Y' OR  k.qty_volume<h.bms_qty )  AND E.LANGUAGE_ID = F.LANGUAGE_ID AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					}
					sbMainSql.append(sbConstructSql.toString());
					sbMainSql.append(sbAppendSql.toString());
					//System.err.println("======IP FILLWITHOUTFILL======ORDERS===sbMainSql=========>"+sbMainSql+sbConstructSql.toString());
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					int position =0;
					if(!nursing_unit.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,nursing_unit);
					if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,priority);
					if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,pat_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDispLocnCode());
					pstmt.setString(++position,getLanguageId());
					if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						pstmt.setString(++position,bed_no); //Added for KDAH-CRF-0338
					
					// added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Started
					System.out.print("getPrescription_no()==========> "+getPrescription_no());
					if(isSite_ph_new_prescription && fill_list.equals("WF") && disp_stage.equals("F") && !getPrescription_no().equals("")){
						pstmt.setString(++position,getPrescription_no());
					}
					
					if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,customTabBasedHrs);
					}
					if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
						pstmt.setString(++position,this.order_date_from);
						pstmt.setString(++position,this.order_date_to);
					}
					pstmt.setString(++position,this.orderingfacility);
					if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
							pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						}
						pstmt.setString(++position,this.exclude_PRN_orders);
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]  
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
						pstmt.setString(++position,locnCode);		// Added for BSP-SCF-0060
					}
				}
				else if(disp_stage.equals("D")){
					// Delivery Stage
					sbConstructSql= new StringBuffer();
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbConstructSql.append(" AND b.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
					if(getCriteriaOrderType().equals("ALL")) {
						sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
					}
					else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
						sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
					} // End - Added for ML-MMOH-CRF-0435 [IN:057357]
					else if(getOrderType().equals("NOR")) {
						sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
					} 
					else if(getOrderType().equals("IVAD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else if(getOrderType().equals("IVAA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderType().equals("IVWA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else if(getOrderType().equals("IVID")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} else if(getOrderType().equals("IVIA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}else if(getOrderType().equals("TD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
					} else if(getOrderType().equals("TA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
					} else if(getOrderType().equals("CD")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
					} else if(getOrderType().equals("CA")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
					} else if(getOrderType().equals("CO")) {
						sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
					}

					//code added for unallocated drug finding....on 2/5/2004..
					sbAppendSql1 = new StringBuffer(); // unallocQuery replaced with sbAppendSql1

					if(!this.order_date_from.equals("") && !this.order_date_to.equals("") ){
						if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
							if(ip_scope.equals("R") ){ //if block and else condition for ML-BRU-SCF-1147 [IN045177]
								if(getFilter_on_next_fill_date().equals("Y"))
									sbAppendSql1.append(" AND H.NEXT_FILL_DATE BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbAppendSql1.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND H.LAST_DISPENSED_DATE IS NOT NULL"); //A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
							}
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbAppendSql1.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbAppendSql1.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}//Added MMS-DM-CRF-0228 end
						else{
							if(ip_scope.equals("R") ){ //if block and else condition for ML-BRU-SCF-1147 [IN045177]
								if(getFilter_on_next_fill_date().equals("Y"))
									sbAppendSql1.append(" AND H.NEXT_FILL_DATE BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999");
								else
									sbAppendSql1.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999  AND H.LAST_DISPENSED_DATE IS NOT NULL"); //A.ORD_DATE_TIME is replaced to B.START_DATE_TIME for SKR-SCF-1658
							}
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbAppendSql1.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbAppendSql1.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
						}
					}
					sbConstructSql.append(" and exists (select 'X' from ip_open_encounter ioen where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id ");//added to filter only current Inpatient.	// closed bracket ')' removed for KDAH-CRF-0338	//ioen aliases addeed for KDAH-CRF-0338			
					//KDAH-CRF-0338 starts
					if(!bed_no.equals("")){
						sbConstructSql.append( " AND bed_num =? AND EXISTS ( SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = h.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = h.order_line_num AND bed_no=ioen.bed_num ) )"); //Modified for KDAH-CRF-0338
					}else{
						sbConstructSql.append( ")");
					}//KDAH-CRF-0338 ends
					if( tab_based_group_sort_disp.equals("Y")  ){//Added for 	PMG20089-CRF-0867 IN[029813] -Start
						if(customTabBased.equals("Y")){
							if(customTabBasedOption.equals("PAST"))
								sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
							else
								sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24)  ");// Added parameter - KAUH-SCF-0183[IN:047989]
						}
					}//Added for PMG20089-CRF-0867 IN[029813] -End
					if(ip_scope.equals("H")){
						//AND K.FINALIZED_YN = 'Y'
						if(getCriteriaOrderType().equals("ALL")){
							sbAppendSql1.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE IN ( '50') ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) AND C.ORDER_STATUS_TYPE IN ( '50'))) and a.ORDERING_FACILITY_ID=? AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
							sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
						}
						else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							sbAppendSql1.append(" AND ( (a.iv_prep_yn='0' and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE IN ( '50') ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) AND C.ORDER_STATUS_TYPE IN ( '50'))) and a.ORDERING_FACILITY_ID=? AND ph_get_user_disp_rights(?,?");
							sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
						} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
						else{
							if(getOrderType().equals("TA")||getOrderType().equals("TD") ){
								sbAppendSql1.append(" AND C.ORDER_STATUS_TYPE = '50' and a.ORDERING_FACILITY_ID=? GROUP BY A.IV_PREP_YN,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else{
								sbAppendSql1.append(" AND C.ORDER_STATUS_TYPE = '50' and a.ORDERING_FACILITY_ID=? ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N') ");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						}
					} 
					else if(unallocdrugs.equals("Y")){
						if(getCriteriaOrderType().equals("ALL")){
							if(ip_scope.equals("A")){   // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
								sbAppendSql1.append(" AND (((a.iv_prep_yn IN ('2', '4', '6', '0') AND ((NVL (k.finalized_yn, 'N') = 'Y' AND C.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND C.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND C.order_status_type IN ('10', '35', '30'))) AND H.LAST_DISPENSED_DATE IS NULL OR (C.ORDER_STATUS_TYPE IN ( '35' , '10','30') AND H.LAST_DISPENSED_DATE IS NOT NULL)) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals("")) 
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060	
							} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
							else if(ip_scope.equals("N")){
								sbAppendSql1.append(" AND ((a.iv_prep_yn IN ('2', '4', '6', '0') AND ((NVL (k.finalized_yn, 'N') = 'Y' AND C.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND C.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('3', '5', '1', '9', 'X') AND C.order_status_type IN ('10', '35', '30'))) AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");

								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // added for BSP-SCF-0060
							}
							else{
								sbAppendSql1.append(" AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )" );
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						}
						else if(getCriteriaOrderType().equals("CDR") ){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
							if(ip_scope.equals("A")){ 
								sbAppendSql1.append(" AND (((a.iv_prep_yn='0' AND ((NVL (k.finalized_yn, 'N') = 'Y' AND C.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND C.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('9', 'X') AND C.order_status_type IN ('10', '35', '30'))) AND H.LAST_DISPENSED_DATE IS NULL OR (C.ORDER_STATUS_TYPE IN ( '35' , '10','30') AND H.LAST_DISPENSED_DATE IS NOT NULL)) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0') OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals("")) 
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060	
							} 
							else if(ip_scope.equals("N")){
								sbAppendSql1.append(" AND ((a.iv_prep_yn='0' AND ((NVL (k.finalized_yn, 'N') = 'Y' AND C.order_status_type = '35') OR ( NVL (k.finalized_yn, 'N') = 'N' AND C.order_status_type IN ('10', '30') ))) OR (NVL (a.iv_prep_yn, 'X') IN ('9', 'X') AND C.order_status_type IN ('10', '35', '30'))) AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals("")) 
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060
							}
							else{
								sbAppendSql1.append(" AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )" );
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
						else{
							
							if(ip_scope.equals("A")){   // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
								if(getOrderType().equals("TA")||getOrderType().equals("TD")){
									sbAppendSql1.append(" AND (H.LAST_DISPENSED_DATE IS NULL OR (H.LAST_DISPENSED_DATE IS NOT NULL)) AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') and a.ORDERING_FACILITY_ID=? GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
								}
								else{
									sbAppendSql1.append(" AND (H.LAST_DISPENSED_DATE IS NULL (H.LAST_DISPENSED_DATE IS NOT NULL)) AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') and a.ORDERING_FACILITY_ID=? ");
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
									}
									else{
										sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
									}
									if(!this.drug_medical.equals(""))  
										sbAppendSql1.append(" and i.DRUG_YN = ? ");
									sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
									sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
							else if(ip_scope.equals("N")){
								if(getOrderType().equals("TA")||getOrderType().equals("TD")){
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NULL AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') and a.ORDERING_FACILITY_ID=? GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
								}
								else{
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NULL AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') and a.ORDERING_FACILITY_ID=? ");
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
									}
									else{
										sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql1.append(" and i.DRUG_YN = ? ");
									sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060
								}
							}
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")){
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') and a.ORDERING_FACILITY_ID=? GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
								}
								else{
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND C.ORDER_STATUS_TYPE IN ( '35' , '10','30') and a.ORDERING_FACILITY_ID=? ");
									
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' )");
									}
									else{
										sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )" );
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql1.append(" and i.DRUG_YN = ? ");
									sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
						}
					}
					else{
						if(getCriteriaOrderType().equals("ALL")){
							 
							if(ip_scope.equals("A")){   // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
								sbAppendSql1.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE = '35' ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) AND C.ORDER_STATUS_TYPE = '35')) AND (H.LAST_DISPENSED_DATE IS NULL OR H.LAST_DISPENSED_DATE IS NOT NULL) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code)  GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
							else if(ip_scope.equals("N")){
								sbAppendSql1.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE = '35' ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) AND C.ORDER_STATUS_TYPE = '35')) AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
							else{
								sbAppendSql1.append(" AND ( (a.iv_prep_yn in ( '2' ,'4' , '6', '0') and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE = '35' ) OR (nvl(a.iv_prep_yn,'X') IN ( '3' ,'5','1','9','X' ) AND C.ORDER_STATUS_TYPE = '35')) AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");
								//Added for SRR20056-CRF-0663	--Start
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
								}
								else{
									sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) " );
								}
								//Added for SRR20056-CRF-0663	--End
								if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						}
						else if(getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]						 
							if(ip_scope.equals("A")){   
								sbAppendSql1.append(" AND ( (a.iv_prep_yn='0' and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE = '35' ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) AND C.ORDER_STATUS_TYPE = '35')) AND (H.LAST_DISPENSED_DATE IS NULL OR H.LAST_DISPENSED_DATE IS NOT NULL) and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0') OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								if(!this.drug_medical.equals(""))  
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							} 
							else if(ip_scope.equals("N")){
								sbAppendSql1.append(" AND ( (a.iv_prep_yn='0' and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE = '35' ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) AND C.ORDER_STATUS_TYPE = '35')) AND H.LAST_DISPENSED_DATE IS NULL and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ((i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N')");
								}
								else{
									sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
								}
								
								if(!this.drug_medical.equals("")) 
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
							else{
								sbAppendSql1.append(" AND ( (a.iv_prep_yn='0' and K.FINALIZED_YN = 'Y' AND C.ORDER_STATUS_TYPE = '35' ) OR (nvl(a.iv_prep_yn,'X') IN ('9','X' ) AND C.ORDER_STATUS_TYPE = '35')) AND H.LAST_DISPENSED_DATE IS NOT NULL and a.ORDERING_FACILITY_ID=? ");
								if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
									sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn='0') OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
								}
								else{
									sbAppendSql1.append( " AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) " );
								}
							
								if(!this.drug_medical.equals("")) 
									sbAppendSql1.append(" and i.DRUG_YN = ? ");
								sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
								sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							}
						} // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]	
						else{
							
							if(ip_scope.equals("A")){   // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
								if(getOrderType().equals("TA")||getOrderType().equals("TD")){
									sbAppendSql1.append(" AND (H.LAST_DISPENSED_DATE IS NULL OR H.LAST_DISPENSED_DATE IS NOT NULL) AND C.ORDER_STATUS_TYPE = '35' and a.ORDERING_FACILITY_ID=? GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
								}
								else{
									sbAppendSql1.append(" AND (H.LAST_DISPENSED_DATE IS NULL OR H.LAST_DISPENSED_DATE IS NOT NULL) AND C.ORDER_STATUS_TYPE = '35' and a.ORDERING_FACILITY_ID=? ");
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
									}
									else{
										sbAppendSql1.append( " and ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
									}
									if(!this.drug_medical.equals(""))  
										sbAppendSql1.append(" and i.DRUG_YN = ? ");
									sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");
									sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							} // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
							
							
							else if(ip_scope.equals("N")){
								if(getOrderType().equals("TA")||getOrderType().equals("TD")){
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NULL AND C.ORDER_STATUS_TYPE = '35' and a.ORDERING_FACILITY_ID=? GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
								}
								else{
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NULL AND C.ORDER_STATUS_TYPE = '35' and a.ORDERING_FACILITY_ID=? ");
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql1.append(" and (( i.drug_yn='Y' AND (i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and (( i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
									}
									else{
										sbAppendSql1.append( " and ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql1.append(" and i.DRUG_YN = ? ");
									sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
							else{
								if(getOrderType().equals("TA")||getOrderType().equals("TD")){
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND C.ORDER_STATUS_TYPE = '35' and a.ORDERING_FACILITY_ID=? GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
								}
								else{
									sbAppendSql1.append(" AND H.LAST_DISPENSED_DATE IS NOT NULL AND C.ORDER_STATUS_TYPE = '35' and a.ORDERING_FACILITY_ID=? ");
									//Added for SRR20056-CRF-0663	--Start
									if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
										sbAppendSql1.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N') and ( (i.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
									}
									else{
										sbAppendSql1.append(" AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) ");
									}
									//Added for SRR20056-CRF-0663	--End
									if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										sbAppendSql1.append(" and i.DRUG_YN = ? ");
									sbAppendSql1.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
									sbAppendSql1.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID ,E.LONG_DESC,A.ENCOUNTER_ID,A.IV_PREP_YN ,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
								}
							}
						}
					}
					sbMainSql = new StringBuffer();

					if(getCriteriaOrderType().equals("ALL") || getCriteriaOrderType().equals("CDR")){ // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]
						sbMainSql.append(" SELECT    A.TRN_GROUP_REF,A.PRIORITY, A.IV_PREP_YN,E.LONG_DESC LOCATION , A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID FROM    OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E   ,  OR_ORDER_STATUS_CODE_LANG_VW C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F,PH_WORKSHEET_HDR K  ,OR_ORDER_LINE_PH H,ph_drug i, ph_disp_hdr_tmp j WHERE   /* JOIN CONDITIONS START HERE */     B.ORDER_ID=A.ORDER_ID AND A.ORDERING_FACILITY_ID=E.FACILITY_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+)     AND   C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM  ");
						if(!selected_nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription)
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0)) ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND A.PATIENT_ID = ? ");
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
						if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
						{
							sbMainSql.append(" and j.DOC_NO = ? ");
						}
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 ends										

						sbMainSql.append(" /* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */  AND  PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1   /* Check for status */      /* Check for IP AND ORDER CATEGORY*/   AND A.PATIENT_CLASS IN ('IP','DC') AND A.ORDER_CATEGORY='PH' AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND A.ORDER_ID = K.ORDER_ID(+)  AND C.LANGUAGE_ID = E.LANGUAGE_ID AND C.LANGUAGE_ID = G.LANGUAGE_ID AND C.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? and b.order_catalog_code=i.drug_code and a.PERFORMING_FACILITY_ID = J.FACILITY_ID  and A.ORDER_ID = J.ORDER_ID  and J.FILL_PROC_ID is null");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					}
					else if(getOrderType().equals("NOR")||getOrderType().equals("IVAD")||getOrderType().equals("IVID")|| getOrderType().equals("IVWA")||getOrderType().equals("CD")){
						sbMainSql.append("SELECT A.TRN_GROUP_REF,A.PRIORITY, A.IV_PREP_YN,E.LONG_DESC LOCATION , A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID FROM   OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E   ,  OR_ORDER_STATUS_CODE C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F ,OR_ORDER_LINE_PH H,ph_drug i,ph_disp_hdr_tmp j WHERE   /* JOIN CONDITIONS START HERE */ B.ORDER_ID=A.ORDER_ID AND A.ORDERING_FACILITY_ID=E.FACILITY_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+)     AND   C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS   AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM  " );
						if(!selected_nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription)
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0)) ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND A.PATIENT_ID = ? ");
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
						if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
						{
							sbMainSql.append(" and j.DOC_NO = ? ");
						}
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 ends	
						sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1   /* Check for status */      /* Check for IP AND ORDER CATEGORY*/   AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH' AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE   AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y'  and A.ORDER_ID = J.ORDER_ID  and J.FILL_PROC_ID is null  AND F.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? and b.order_catalog_code=i.drug_code");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					}
					else if(getOrderType().equals("IVAA")||getOrderType().equals("IVIA")||getOrderType().equals("CO")|| getOrderType().equals("CA")){
						sbMainSql.append(" SELECT    A.TRN_GROUP_REF,A.PRIORITY, A.IV_PREP_YN,E.LONG_DESC LOCATION , A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID FROM    OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E   ,  OR_ORDER_STATUS_CODE_LANG_VW C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F,PH_WORKSHEET_HDR K  ,OR_ORDER_LINE_PH H,ph_drug i  WHERE   /* JOIN CONDITIONS START HERE */     B.ORDER_ID=A.ORDER_ID AND A.ORDERING_FACILITY_ID=E.FACILITY_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+)     AND   C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS    /* Check for Nursing Unit Code here */ AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM  ");
						if(!selected_nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription)
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND A.PATIENT_ID = ? ");
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
						if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
						{
							sbMainSql.append(" and j.DOC_NO = ? ");
						}
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 ends	
						sbMainSql.append(" /* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */     AND    PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1   /* Check for status */      /* Check for IP AND ORDER CATEGORY*/   AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH'  AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y'  AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND A.ORDER_ID = K.ORDER_ID AND K.FINALIZED_YN = 'Y' AND C.LANGUAGE_ID = E.LANGUAGE_ID AND C.LANGUAGE_ID = G.LANGUAGE_ID AND C.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? and b.order_catalog_code=i.drug_code");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]	
					}
					else if(getOrderType().equals("TA")||getOrderType().equals("TD")){
						sbMainSql.append(" SELECT   A.TRN_GROUP_REF, A.PRIORITY, A.IV_PREP_YN,E.LONG_DESC LOCATION , A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY HH24:MI') ORD_DATE_TIME   , F.PRACTITIONER_NAME,  DECODE(A.ORDERING_FACILITY_ID,  A.PERFORMING_FACILITY_ID,'',  G.FACILITY_NAME) FACILITY_NAME,   F.PRACTITIONER_ID,A.ENCOUNTER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, H.TAPERED_YN, H.TAPER_ORDER_ID FROM    OR_ORDER_LINE B,   OR_ORDER A,  IP_NURSING_UNIT_LANG_VW E   ,  OR_ORDER_STATUS_CODE_LANG_VW C,   SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F,PH_TPN_WORKSHEET_HDR K,OR_ORDER_LINE_PH H  WHERE   /* JOIN CONDITIONS START HERE */     B.ORDER_ID=A.ORDER_ID AND A.ORDERING_FACILITY_ID=E.FACILITY_ID AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+)     AND   C.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND  B.ORDER_ID = H.ORDER_ID AND B.ORDER_LINE_NUM= H.ORDER_LINE_NUM ");
						if(!selected_nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* Check for Nursing Unit Code here */ AND E.NURSING_UNIT_CODE = ? "); 
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						{
							// if Added, RBU-GHL-CRF-0047 starts
					    	if(isSite_ph_new_prescription)
							{
					    	if(priority.equals("R"))
					    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
					    	else
					    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
					    	}else
					    	{
					    		sbMainSql.append(" AND a.priority = ? ");
					    	}
					    	// if Added, RBU-GHL-CRF-0047 ends
						}
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND A.PATIENT_ID = ? ");
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
						if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
						{
							sbMainSql.append(" and j.DOC_NO = ? ");
						}
						// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 ends	
						sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1   /* Check for status */      /* Check for IP AND ORDER CATEGORY*/   AND A.PATIENT_CLASS IN  ('IP','DC') AND A.ORDER_CATEGORY='PH' AND A.PERFORMING_DEPTLOC_CODE=?  AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND A.ORDER_ID = K.ORDER_ID(+) AND K.FINALIZED_YN(+) = 'Y' AND C.LANGUAGE_ID = E.LANGUAGE_ID AND C.LANGUAGE_ID = G.LANGUAGE_ID AND C.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ?"); //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					}
					sbMainSql.append(sbConstructSql.toString());
					sbMainSql.append(sbAppendSql1.toString());
					//System.err.println("======IP VErification======DELIVER===sbMainSql=========>"+sbMainSql);
					pstmt = connection.prepareStatement( sbMainSql.toString()) ;
					int position =0;
					if(!selected_nursing_unit.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,selected_nursing_unit);
 					if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
 						pstmt.setString(++position,priority);
 					if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
 						pstmt.setString(++position,pat_id);
 					
 					////added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 Starts
					if(!getFill_doc_num().equals("") && isSite_ph_new_prescription)
 					{
 						pstmt.setString(++position,getFill_doc_num());
 					}
	 				// //added By Himanshu Saxena for GHL-CRF-0672 on 03-01-24 ends
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDispLocnCode());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
						pstmt.setString(++position,bed_no); //Added for KDAH-CRF-0338
					if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,customTabBasedHrs);
					}
					
					if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
						pstmt.setString(++position,this.order_date_from);
						pstmt.setString(++position,this.order_date_to);
					}
					pstmt.setString(++position,this.orderingfacility);
					if(!(getOrderType().equals("TA")||getOrderType().equals("TD"))){
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663 ---include_absolute_orders changed to sFreqDurnAbsOrderFlag for ICN 28560
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
							pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						}
						pstmt.setString(++position,this.exclude_PRN_orders);
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
						pstmt.setString(++position,locnCode);		// Added for BSP-SCF-0060
					}
				}
			}
			else if(disp_locn_catg.equals("IAE")) //added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started
			{
					System.out.println("===============>  "+getDisp_locn_codeall());
					String patient_class=getTemp_patient_classl();
					setDispDrugRights(getDisp_locn_codeall()); // in case of "all"
					String tab_based_group_sort_disp = getTabBasegGroupSortDisp();
					String customTabBased = getCustomTabBased();
					String customTabBasedHrs = getCustomTabBasedHrs();
					String customTabBasedOption = getCustomTabBasedOption();
					if(patient_class.equals("IP")){
					if(disp_stage.equals("V")){	
				// Verification stage
						sbConstructSql = new StringBuffer();
						if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
							sbConstructSql.append(" AND b.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
						//AND c.order_status_type IN ('10', '56', '50')
						if(ip_scope.equals("H")){
							sbConstructSql.append(" AND c.order_status_type = '50' ");
						}
						else if(ip_scope.equals("N")){
							sbConstructSql.append(" AND c.order_status_type in('10','25') ");//Added 25 for ML-BRU-SCF-1338[IN049193]
						}
						else if(ip_scope.equals("R")){
							sbConstructSql.append(" AND c.order_status_type = '56' ");
						}

						if(getCriteriaOrderType().equals("ALL")) {
							sbConstructSql.append(" AND nvl(a.iv_prep_yn,'X') NOT IN ('7', '8') ");
						}
						else if(getCriteriaOrderType().equals("CDR")) {  // Start - Added for ML-MMOH-CRF-0435 [IN:057357]
							sbConstructSql.append( " AND (A.IV_PREP_YN IN ('0','9'))");
						} // End - Added for ML-MMOH-CRF-0435 [IN:057357] 
						else if(getOrderType().equals("NOR")) {
							sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
						}
						else if(getOrderType().equals("IVAD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVAA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVWA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVID")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("IVIA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else if(getOrderType().equals("TD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
						} 
						else if(getOrderType().equals("TA")) {
							sbConstructSql.append( " AND A.IV_PREP_YN ='8' ");
						} 
						else if(getOrderType().equals("CD")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
						} 
						else if(getOrderType().equals("CA")) {
							sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
						} 
						else if(getOrderType().equals("CO")) {
							sbConstructSql.append( " AND A.IV_PREP_YN = '6' ");
						}
						sbConstructSql.append( " and exists (select 'X' from ip_open_encounter ioen where facility_id = a.ordering_facility_id and encounter_id = a.encounter_id ");//added to filter only current Inpatient. // closed bracket ')' removed for KDAH-CRF-0338 //ioen aliases addeed for KDAH-CRF-0338
						//Added for 	PMG20089-CRF-0867 IN[029813] -Start
						//KDAH-CRF-0338 starts
						if(!bed_no.equals("")){
							sbConstructSql.append( " AND bed_num =? AND EXISTS (SELECT 'Y' FROM ph_patient_drug_profile WHERE  orig_order_id = b.order_id AND orig_order_id = a.order_id AND orig_order_id = j.order_id AND orig_order_line_no = b.order_line_num AND orig_order_line_no = j.order_line_num AND bed_no=ioen.bed_num ) )"); //Modified for KDAH-CRF-0338
						}else{
							sbConstructSql.append( ")");
						}//KDAH-CRF-0338 ends
						if( tab_based_group_sort_disp.equals("Y")  ){
							if(customTabBased.equals("Y")){
								if(customTabBasedOption.equals("PAST"))
									sbConstructSql.append(" AND a.ADDED_DATE < SYSDATE-(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
								else
									sbConstructSql.append(" AND a.ADDED_DATE >= SYSDATE -(?/24) ");// Added parameter - KAUH-SCF-0183[IN:047989]
							}
						}
						//Added for 	PMG20089-CRF-0867 IN[029813] -End
						if(getOrderType().equals("TA") ||getOrderType().equals("TD")) {
							sbConstructSql.append(" and a.ORDERING_FACILITY_ID=? ");
							if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
								sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.source_code = NVL(?,a.source_code) "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							else
								sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') AND a.source_code = NVL(?,a.source_code) ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564] // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							sbConstructSql.append(" GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY ");
							sbMainSql.append("SELECT A.TRN_GROUP_REF,a.priority, a.iv_prep_yn, e.long_desc LOCATION, a.order_id, TO_CHAR (a.ord_date_time,'DD/MM/YYYY HH24:MI') ord_date_time,f.practitioner_name,DECODE (a.ordering_facility_id,a.performing_facility_id, '',g.facility_name) facility_name,f.practitioner_id, a.encounter_id,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, j.TAPERED_YN, j.TAPER_ORDER_ID FROM or_order_line b,  or_order a,ip_nursing_unit_lang_vw e, or_order_status_code c,sm_facility_param_lang_vw g,am_practitioner_lang_vw f, or_order_line_ph j WHERE  b.order_id = a.order_id AND b.order_id=j.order_id and b.order_line_num = j.order_line_num   AND g.facility_id = a.ordering_facility_id     AND a.ord_pract_id = f.practitioner_id  AND e.nursing_unit_code = a.source_code AND c.order_status_code =b.order_line_status ");
							if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* Check for Nursing Unit Code here */ AND e.nursing_unit_code = ? "); 
							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND a.patient_id = ? ");
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /* Check for IP AND ORDER CATEGORY*/  AND a.patient_class IN  ('IP','DC') AND a.order_category = 'PH' AND a.performing_deptloc_code = ? AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							pstmt = connection.prepareStatement( sbMainSql.toString()+sbConstructSql.toString()) ;
						}
						else{
							sbConstructSql.append(" and a.ORDERING_FACILITY_ID=? ");
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
								else
									sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}//Added MMS-DM-CRF-0228 end
							else{
								if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
									sbConstructSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
								else
									sbConstructSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
							}
							//Added for SRR20056-CRF-0663	--Start
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
								sbConstructSql.append(" and ((i.drug_yn='Y' AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR (a.iv_prep_yn IN ('0', '2', '4', '6')) OR (i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR i.drug_yn='N' ) and ( (i.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O')) OR i.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR i.drug_yn='N' ) ");
							}
							else{
								sbConstructSql.append(" AND ( i.calc_dosg_by_freq_durn_yn = DECODE (?,'Y', 'N',i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )");
							}
							if(!this.drug_medical.equals(""))  
								sbConstructSql.append(" and i.DRUG_YN = ? ");
							sbConstructSql.append(" AND ph_get_user_disp_rights(?,?");
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.IV_PREP_YN ,A.TRN_GROUP_REF,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.PATIENT_CLASS, A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,E.LONG_DESC,A.ENCOUNTER_ID,a.MODIFIED_DATE, TAPERED_YN, TAPER_ORDER_ID ORDER BY A.PRIORITY "); // AND a.source_code = NVL(?,a.source_code) Added for BSP-SCF-0060
							sbMainSql.append("SELECT A.TRN_GROUP_REF,a.priority, a.iv_prep_yn, e.long_desc LOCATION, a.order_id, TO_CHAR (a.ord_date_time,'DD/MM/YYYY HH24:MI') ord_date_time,f.practitioner_name,DECODE (a.ordering_facility_id,a.performing_facility_id, '',g.facility_name) facility_name,f.practitioner_id, a.encounter_id,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, J.TAPERED_YN, J.TAPER_ORDER_ID FROM or_order_line b, or_order a, ip_nursing_unit_lang_vw e, or_order_status_code c,sm_facility_param_lang_vw g,am_practitioner_lang_vw f,ph_drug i, or_order_line_ph j WHERE  b.order_id = a.order_id    AND b.order_id=j.order_id and b.order_line_num = j.order_line_num and g.facility_id = a.ordering_facility_id  AND a.ord_pract_id = f.practitioner_id  AND e.nursing_unit_code = a.source_code AND c.order_status_code =b.order_line_status ");
							if(!nursing_unit.equals(""))
								sbMainSql.append("/* Check for Nursing Unit Code here */ AND e.nursing_unit_code = ? "); 
							if(!priority.equals(""))
								sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
							if(!pat_id.equals(""))
								sbMainSql.append("/* CHECK FOR PATIENT ID HERE  */  AND a.patient_id = ? ");
							if(getPhAltDispLocnYN().equals("Y"))
								sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /* Check for IP AND ORDER CATEGORY*/  AND a.patient_class IN  ('IP','DC') AND a.order_category = 'PH' AND A.PERFORMING_DEPTLOC_CODE=?  AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? and b.order_catalog_code=i.drug_code "); //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							else
								sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND   END_DATE */ AND ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,?,?,?,?) = 1 /* Check for IP AND ORDER CATEGORY*/  AND a.patient_class IN  ('IP','DC') AND a.order_category = 'PH' AND ph_disp_locn_appl_yn (a.orig_performing_deptloc_code,?, A.source_type, A.source_code, a.added_facility_id, A.performing_facility_id, A.PERFORMING_DEPTLOC_CODE, i.drug_class, i.drug_code, b.ORDER_TYPE_CODE, a.patient_class, a.priority, a.discharge_ind, decode(i.drug_yn,'Y','D','N','M'),a.iv_prep_yn,a.ORIG_PERFORMING_DEPTLOC_CODE, a.order_id, a.HOME_LEAVE_MEDN_YN, a.PATIENT_ID, a.ENCOUNTER_ID) = 'Y' AND  E.NURSING_UNIT_CODE= A.SOURCE_CODE AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? and b.order_catalog_code=i.drug_code ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							pstmt = connection.prepareStatement( sbMainSql.toString()+sbConstructSql.toString()) ;
						}
						int position = 0;
						System.out.println("sbMainSql==> "+sbMainSql);
						System.out.println("sbConstructSql==> "+sbConstructSql);
						if(!nursing_unit.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,nursing_unit);
						if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,priority);
						if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,pat_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_locn_codeall());
						pstmt.setString(++position,getLanguageId());
						if(!bed_no.equals(""))// Added for KDAH-CRF-0338 - Start
							pstmt.setString(++position,bed_no); //Added for KDAH-CRF-0338
						pstmt.setString(++position,this.orderingfacility);
						pstmt.setString(++position,this.order_date_from);
						pstmt.setString(++position,this.order_date_to);
						if(!(getOrderType().equals("TA")|| getOrderType().equals("TD"))) {
							pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
							if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
								pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
							}
							pstmt.setString(++position,this.exclude_PRN_orders);
							if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
								pstmt.setString(++position,this.drug_medical);
							pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
						    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
						    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
						}
						if( tab_based_group_sort_disp.equals("Y") && customTabBased.equals("Y")){
							pstmt.setString(++position,customTabBasedHrs);	
						}
						pstmt.setString(++position,locnCode);	
					}		
					}else if(patient_class.equals("EM") || patient_class.equals("OP")) // this OP condition is for Emergency patient if all is selected in disp medication login screen
					{
						// Outpatient==> Emergency Patient
													if(getIssueTokenOnRegnYN().equals("N")){
														
															if(scope.equals("EX")) {
																if(disp_stage.equals("V")&&disp_regn_reqd_yn.equals("N")){
																	sbMainSql.append("SELECT  A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K,OR_ORDER_STATUS_CODE H,PH_DISP_LOCN J,PH_DRUG I WHERE /* JOIN CONDITIONS START HERE */  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
																	if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");       
																	if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	else if(!order_date_from.equals("")){
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	else if(!order_date_to.equals("")){
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
																	if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																		sbMainSql.append(" AND A.ORDER_ID=? ");
																	sbMainSql.append(" /* CHECK FOR ORDER_LINE START_DATE AND END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* CHECK FOR ORDER_CATEGORY */ AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=? and H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND F.LANGUAGE_ID = G.LANGUAGE_ID AND G.LANGUAGE_ID = ? AND A.PERFORMING_DEPTLOC_CODE = j.DISP_LOCN_CODE AND B.ORDER_CATALOG_CODE = I.DRUG_CODE AND decode(j.DISP_VERF_STAGE,'F',I.VERIFICATION_REQD_YN,'B',I.VERIFICATION_REQD_YN,'X') = decode(j.DISP_VERF_STAGE,'F','Y','B','Y','X') AND B.ORDER_CATALOG_CODE = I.DRUG_CODE ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
																	System.out.println("..>>>>>>>>>>>>>>>>>>>>>> "+ sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() );
																	pstmt = connection.prepareStatement( sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;
																}
																else{
																	sbMainSql.append("SELECT  A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME,min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K,OR_ORDER_STATUS_CODE H ,PH_DRUG I WHERE /* JOIN CONDITIONS START HERE */  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID "); 
																	//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value added for GHL-CRF-0453
																	if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");       
																	if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	else if(!order_date_from.equals("")){
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
																		else
																		 sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	else if(!order_date_to.equals("")){
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
																	if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																		sbMainSql.append(" AND A.ORDER_ID=? ");
																	sbMainSql.append(" /* CHECK FOR ORDER_LINE START_DATE AND END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* CHECK FOR ORDER_CATEGORY */ AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=? and H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND F.LANGUAGE_ID = G.LANGUAGE_ID AND G.LANGUAGE_ID = ? AND B.ORDER_CATALOG_CODE = I.DRUG_CODE");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
																	
																	pstmt = connection.prepareStatement( sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ; 
																}
															} 
															else {
																if(disp_stage.equals("V")){
																	sbMainSql.append("SELECT A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K ,OR_ORDER_STATUS_CODE H ,PH_DISP_LOCN J,PH_DRUG I WHERE B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID  AND A.ORD_PRACT_ID=F.PRACTITIONER_ID "); 
																	if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");       
																	if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	else if(!order_date_from.equals("")){
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	else if(!order_date_to.equals("")){
																		if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																			sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
																		else
																			sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																	}
																	if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																		sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
																	if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																		sbMainSql.append(" AND A.ORDER_ID=? ");
																	sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=?  AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND F.LANGUAGE_ID = G.LANGUAGE_ID AND F.LANGUAGE_ID = ? AND A.PERFORMING_DEPTLOC_CODE = j.DISP_LOCN_CODE AND B.ORDER_CATALOG_CODE = I.DRUG_CODE AND decode(j.DISP_VERF_STAGE,'F',I.VERIFICATION_REQD_YN,'B',I.VERIFICATION_REQD_YN,'X') = decode(j.DISP_VERF_STAGE,'F','Y','B','Y','X')");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
																	pstmt = connection.prepareStatement( sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;	
																}
																
															}					
														
														int position = 0;
															pstmt.setString(++position,getLanguageId());
															if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,priority);
															if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,order_date_from);						
																pstmt.setString(++position,order_date_to);
															}
															else if(!order_date_from.equals(""))
																pstmt.setString(++position,order_date_from);
															else if(!order_date_to.equals(""))
																pstmt.setString(++position,order_date_to);
															if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,pat_id);
															if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																pstmt.setString(++position,order_id);
															pstmt.setString(++position,login_facility_id);
															pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_locn_codeall());
															pstmt.setString(++position,getLanguageId());
															
															if ((getIssueTokenOnRegnYN().equals("N") && disp_regn_reqd_yn.equals("N") && verf_combined_with_alloc.equals("C") && !scope.equals("H") && 				((getDispStage().equals("A") && (getFillingStatus().equals("A") || getFillingStatus().equals("X"))) ||(getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X"))) ) ) || (disp_stage.equals("AS") && scope.equals("A") && !verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y"))){// if Added - KAUH-SCF-0183[IN:047989] // (!verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y")) added for ML-BRU-SCF-1379[IN049771] // && !scope.equals("H") ML-BRU-SCF-1495
																if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
																	pstmt.setString(++position,order_date_from);
																	pstmt.setString(++position,order_date_to);
																}
																else if(!this.order_date_from.equals(""))
																	pstmt.setString(++position,order_date_from);
																else if(!this.order_date_to.equals(""))
																	pstmt.setString(++position,order_date_to);
															}
															
															//pstmt.setString(++position,this.orderingfacility);//commented for ML-BRU-SCF-1927- NEW CHANGE
															pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
															//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
															//	pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
															if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,this.drug_medical);
															pstmt.setString(++position,this.exclude_PRN_orders);
															pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
															pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
															pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
														    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
														    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
														 if(!getIssueTokenOnRegnYN().equals("Y") && !scope.equals("EX") ) // if,else Added for Regression Issue DEC-2018 //!scope.equals("EX") added for ICN69800
															pstmt.setString(++position,locnCode);		// Added for BSP-SCF-0060 
														
													}
													else{
														StringBuilder SQL_PH_DISP_MEDICATION_SELECT22 = new StringBuilder();// String is changed as StringBuilder - KAUH-SCF-0183[IN:047989]
														StringBuilder SQL_PH_DISP_MEDICATION_SELECT22A = new StringBuilder();// String is changed as StringBuilder - KAUH-SCF-0183[IN:047989]
														if(scope.equals("EX")) {
																SQL_PH_DISP_MEDICATION_SELECT22A.append("SELECT  A.TRN_GROUP_REF, A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID, TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value  FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,OR_ORDER_LINE_PH K,ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID  AND   C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
																//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value added for GHL-CRF-0453
																if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");       
																if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																		SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
																	else
																		SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																}
																if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
																if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																	SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORDER_ID=? ");
																SQL_PH_DISP_MEDICATION_SELECT22A.append("AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
																if(!getTokenSeriesCode().equals(""))// if Added, Removed NVL - HSA-CRF-0136 [IN:048412]
																	SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIES_CODE=? ");  	 
																if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIAL_NO=? ");  	 
																SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO AND NVL(x.token_line_status,'!') NOT IN ('XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code "); //and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
																pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22A.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;
															} 
															else {
																SQL_PH_DISP_MEDICATION_SELECT22.append("SELECT   A.TRN_GROUP_REF,A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID,  TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME /*, min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value */   FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,/*OR_ORDER_LINE_PH K,*/ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID /* AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM */ AND  C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+) ");
																//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value  added for GHL-CRF-453 and removed for SKR-SCF-1512 performance
																if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");       
																if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
																		SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
																	else
																		SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
																}
																if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
																if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																	SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORDER_ID=? ");
																SQL_PH_DISP_MEDICATION_SELECT22.append(" AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? 	");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
																if(!getTokenSeriesCode().equals(""))// if Added, Removed NVL - HSA-CRF-0136 [IN:048412]
																	SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIES_CODE=?  "); 	
																if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
																	SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIAL_NO=? "); 	
																SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.QUEUE_DATE=to_date(?,'dd/mm/yyyy hh24:mi') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO  AND NVL(x.token_line_status,'!') NOT IN ('XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code "); //and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
																pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;
															}
														
														int position=0; 
														
														pstmt.setString(++position,getLanguageId());
															if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,priority);
															if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,order_date_from);
																pstmt.setString(++position,order_date_to);
															}
															else if(!order_date_from.equals(""))
																pstmt.setString(++position,order_date_from);
															else if(!order_date_to.equals(""))
																pstmt.setString(++position,order_date_to);
															if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,pat_id);
															if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
																pstmt.setString(++position,order_id);
															pstmt.setString(++position,login_facility_id);
															pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
															pstmt.setString(++position,login_facility_id);
															pstmt.setString(++position,getDisp_locn_codeall());
															if(!getTokenSeriesCode().equals(""))// if added  HSA-CRF-0136 [IN:048412]
																pstmt.setString(++position,getTokenSeriesCode());//series
															if(!getTokenNo().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
																pstmt.setString(++position,getTokenNo());//no
															pstmt.setString(++position,this.queue_date);//queue_date
															pstmt.setString(++position,getLanguageId());
															pstmt.setString(++position,getLanguageId());
															pstmt.setString(++position,getLanguageId());
															pstmt.setString(++position,sFreqDurnAbsOrderFlag);	
															pstmt.setString(++position,this.drug_medical);
															pstmt.setString(++position,this.exclude_PRN_orders);
															pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
															pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
															pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
														    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
														    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
															if(!getIssueTokenOnRegnYN().equals("Y")  && !scope.equals("EX") )  // if Added for Regression Issue DEC-2018
															pstmt.setString(++position,locnCode);		// Added for BSP-SCF-0060 //!scope.equals("EX") added for ICN69800
													}
											}
					//IAE code over
			}
			else if(disp_locn_catg.equals("O")){
				// Outpatient
				if(getIssueTokenOnRegnYN().equals("N")){
					if(disp_stage.equals("AS")){// All Stages
						if (scope.equals("E")){		// E --> Expired Medication
							sbConstructSql=	new StringBuffer();
							if(getOrderType().equals("NOR")) {
								sbConstructSql.append(" AND (A.IV_PREP_YN IS NULL OR A.IV_PREP_YN='N') ");
							} 
							else if(getOrderType().equals("IVAD")) {
								sbConstructSql.append( " AND A.IV_PREP_YN ='1' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else if(getOrderType().equals("IVAA")) {
								sbConstructSql.append(" AND A.IV_PREP_YN ='2' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							} 
							else if(getOrderType().equals("IVWA")) {
								sbConstructSql.append(" AND A.IV_PREP_YN ='5' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else if(getOrderType().equals("IVID")) {
								sbConstructSql.append(" AND A.IV_PREP_YN ='3' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else if(getOrderType().equals("IVIA")) {
								sbConstructSql.append(" AND A.IV_PREP_YN ='4' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
							}
							else if(getOrderType().equals("TD")) {
								sbConstructSql.append(" AND A.IV_PREP_YN ='7' ");
							} 
							else if(getOrderType().equals("TA")) {
								sbConstructSql.append(" AND A.IV_PREP_YN ='8' ");
							} 
							else if(getOrderType().equals("CD")) {
								sbConstructSql.append(" AND A.IV_PREP_YN = '9' ");
							} 
							else if(getOrderType().equals("CA")) {
								sbConstructSql.append(" AND A.IV_PREP_YN = '0' ");
							} 
							else if(getOrderType().equals("CO")) {
								sbConstructSql.append(" AND A.IV_PREP_YN = '6' ");
							}
							sbConstructSql.append(" and a.ORDERING_FACILITY_ID=? AND ( i.calc_dosg_by_freq_durn_yn = decode(iv_prep_yn,'0', i.calc_dosg_by_freq_durn_yn,'2', i.calc_dosg_by_freq_durn_yn,'4', i.calc_dosg_by_freq_durn_yn,'6', i.calc_dosg_by_freq_durn_yn,'8', i.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature ='O'))) ");
							if(!this.drug_medical.equals(""))  // if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbConstructSql.append(" and i.DRUG_YN = ? ");
							sbConstructSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");
							if(!getIssueTokenOnRegnYN().equals("Y")){ // if,else Added for Regression Issue DEC-2018
							if(scope.equals("EX")){ //!scope.equals("EX") added for ICN69800
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y'  GROUP BY A.TRN_GROUP_REF,A.ENCOUNTER_ID,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,A.IV_PREP_YN,a.MODIFIED_DATE ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060
							}else{
							sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' AND a.source_code = NVL(?,a.source_code) GROUP BY A.TRN_GROUP_REF,A.ENCOUNTER_ID,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,A.IV_PREP_YN,a.MODIFIED_DATE ORDER BY A.PRIORITY"); // AND a.source_code = NVL(?,a.source_code) added for BSP-SCF-0060
							}
							}
						    else
							  sbConstructSql.append(",A.PERFORMING_DEPTLOC_CODE,i.DRUG_CODE,i.DRUG_CLASS,?,?,?) = 'Y' GROUP BY A.TRN_GROUP_REF,A.ENCOUNTER_ID,A.PRIORITY, A.ORDER_ID, A.ORD_DATE_TIME, F.PRACTITIONER_NAME, G.FACILITY_NAME,A.SOURCE_CODE,A.SOURCE_TYPE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,F.PRACTITIONER_ID,A.IV_PREP_YN,a.MODIFIED_DATE ORDER BY A.PRIORITY");
							
							sbMainSql.append("SELECT A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM G, AM_PRACTITIONER_LANG_VW F,PH_FACILITY_PARAM H,OR_ORDER_LINE_PH K,PH_DRUG I WHERE /* JOIN CONDITIONS START HERE */ H.FACILITY_ID=A.ORDERING_FACILITY_ID AND B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))// 
							{
								
						    	if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME  >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME  >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								sbMainSql.append(" AND A.ORDER_ID=? ");
							sbMainSql.append(" AND A.PATIENT_CLASS IN ('OP','EM')   /* CHECK FOR ORDER_LINE START_DATE AND END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* CHECK FOR ORDER_CATEGORY */ AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=? AND (B.END_DATE_TIME) < TRUNC(SYSDATE)  AND  TRUNC(SYSDATE) <= TRUNC(B.END_DATE_TIME)+H.DISP_BEYOND_NO_OF_DAYS AND A.ORDER_STATUS IN ('OS','RG','DP') AND F.LANGUAGE_ID = ? AND B.ORDER_CATALOG_CODE = I.DRUG_CODE "); // added ORDER_STATUS IN 'DP' for BSP-SCF-0028 //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							pstmt = connection.prepareStatement( sbMainSql.toString()+sbConstructSql.toString() ) ;
						} 
						else if(scope.equals("EX")) {
							sbMainSql.append("SELECT  A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K,OR_ORDER_STATUS_CODE H ,PH_DRUG I WHERE /* JOIN CONDITIONS START HERE */  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");  
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))// 
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								sbMainSql.append(" AND A.ORDER_ID=? ");
							sbMainSql.append("/* CHECK FOR ORDER_LINE START_DATE AND END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* CHECK FOR ORDER_CATEGORY */ AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=? and H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND F.LANGUAGE_ID = G.LANGUAGE_ID AND G.LANGUAGE_ID = ? AND B.ORDER_CATALOG_CODE = I.DRUG_CODE ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							pstmt = connection.prepareStatement( sbMainSql.toString()+strStagesCondition1+sbConstructSql.toString());
						} 
						else {
							sbMainSql.append("SELECT A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K ,OR_ORDER_STATUS_CODE H,PH_DRUG I WHERE B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID  AND A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								sbMainSql.append("AND A.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))// 
							{
								
						    	if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		sbMainSql.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							if(scope.equals("B")){// if Added - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(NVL(?,'01/01/1472 00:00'),'dd/mm/yyyy hh24:mi') AND TO_DATE(NVL(?,'31/12/5000 00:00'),'dd/mm/yyyy hh24:mi') ");
									else
										sbMainSql.append(" AND TRUNC(B.START_DATE_TIME) BETWEEN TO_DATE(NVL(?,'01/01/1472 00:00'),'dd/mm/yyyy hh24:mi') AND TO_DATE(NVL(?,'31/12/5000 00:00'),'dd/mm/yyyy hh24:mi') " );//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}//Added MMS-DM-CRF-0228 end
								else{
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(NVL(?,'01/01/1472'),'DD/MM/YYYY') AND TO_DATE(NVL(?,'31/12/5000'),'DD/MM/YYYY')+ 0.99999 ");
									else
										sbMainSql.append(" AND TRUNC(B.START_DATE_TIME) BETWEEN TO_DATE(NVL(?,'01/01/1472'),'DD/MM/YYYY') AND TO_DATE(NVL(?,'31/12/5000'),'DD/MM/YYYY')" );//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							else{// else Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND TRUNC(B.START_DATE_TIME) BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi')" );//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											sbMainSql.append(" AND TRUNC(B.START_DATE_TIME) BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')" );//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append("AND A.PATIENT_ID =? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								sbMainSql.append(" AND A.ORDER_ID=? ");  
							sbMainSql.append("AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=?  AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND F.LANGUAGE_ID = G.LANGUAGE_ID AND F.LANGUAGE_ID = ? AND B.ORDER_CATALOG_CODE = I.DRUG_CODE ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							pstmt = connection.prepareStatement( sbMainSql.toString()+ " AND a.patient_class IN ('OP', 'EM')" + sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;//Added AND a.patient_class IN ('OP', 'EM') for ML-BRU-SCF-1076
						}
						//System.err.println("=======OP=========AllStages========>"+PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT20") + sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString());
					}
					else{			// For Independent stages
						if(scope.equals("EX")) {
							if(disp_stage.equals("V")&&disp_regn_reqd_yn.equals("N")){
								sbMainSql.append("SELECT  A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K,OR_ORDER_STATUS_CODE H,PH_DISP_LOCN J,PH_DRUG I WHERE /* JOIN CONDITIONS START HERE */  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
//								if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//									sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");  
								// if Added, RBU-GHL-CRF-0054 starts
								if(!priority.equals(""))// 
								{
									if(isSite_ph_new_prescription)
									{
							    	if(priority.equals("R"))
							    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
							    	else
							    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
							    	}else
							    	{
							    		sbMainSql.append(" AND a.priority = ? ");
							    	}
							    	
								}// if Added, RBU-GHL-CRF-0054 ends
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi')  ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999  ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");//code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}
								
								if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
								if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] //CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
									sbMainSql.append(" AND A.ORDER_ID=? ");
								sbMainSql.append(" /* CHECK FOR ORDER_LINE START_DATE AND END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* CHECK FOR ORDER_CATEGORY */ AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=? and H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND F.LANGUAGE_ID = G.LANGUAGE_ID AND G.LANGUAGE_ID = ? AND A.PERFORMING_DEPTLOC_CODE = j.DISP_LOCN_CODE AND B.ORDER_CATALOG_CODE = I.DRUG_CODE AND decode(j.DISP_VERF_STAGE,'F',I.VERIFICATION_REQD_YN,'B',I.VERIFICATION_REQD_YN,'X') = decode(j.DISP_VERF_STAGE,'F','Y','B','Y','X') AND B.ORDER_CATALOG_CODE = I.DRUG_CODE ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
								pstmt = connection.prepareStatement( sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;
							}
							else{
								sbMainSql.append("SELECT  A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME,min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K,OR_ORDER_STATUS_CODE H ,PH_DRUG I WHERE /* JOIN CONDITIONS START HERE */  B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID "); 
								//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value added for GHL-CRF-0453
//								if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//									sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");  
								// if Added, RBU-GHL-CRF-0054 starts
								if(!priority.equals(""))// 
								{
									if(isSite_ph_new_prescription)
									{
							    	if(priority.equals("R"))
							    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
							    	else
							    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
							    	}else
							    	{
							    		sbMainSql.append(" AND a.priority = ? ");
							    	}
							    	
								}// if Added, RBU-GHL-CRF-0054 ends
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
										 sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
										else
										 sbMainSql.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}
								if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
								if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] \\CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
									sbMainSql.append(" AND A.ORDER_ID=? ");
								sbMainSql.append(" /* CHECK FOR ORDER_LINE START_DATE AND END_DATE */  AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 /* CHECK FOR ORDER_CATEGORY */ AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=? and H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND F.LANGUAGE_ID = G.LANGUAGE_ID AND G.LANGUAGE_ID = ? AND B.ORDER_CATALOG_CODE = I.DRUG_CODE");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
								pstmt = connection.prepareStatement( sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ; 
							}
						} 
						else {
							if(disp_stage.equals("V")){
								sbMainSql.append("SELECT A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K ,OR_ORDER_STATUS_CODE H ,PH_DISP_LOCN J,PH_DRUG I WHERE B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID  AND A.ORD_PRACT_ID=F.PRACTITIONER_ID "); 
//								if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//									sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? "); 
								// if Added, RBU-GHL-CRF-0054 starts
								if(!priority.equals(""))// 
								{
									if(isSite_ph_new_prescription)
									{
							    	if(priority.equals("R"))
							    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
							    	else
							    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
							    	}else
							    	{
							    		sbMainSql.append(" AND a.priority = ? ");
							    	}
							    	
								}// if Added, RBU-GHL-CRF-0054 ends
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											sbMainSql.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}
								if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
								if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] \\CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
									sbMainSql.append(" AND A.ORDER_ID=? ");
								sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=?  AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND F.LANGUAGE_ID = G.LANGUAGE_ID AND F.LANGUAGE_ID = ? AND A.PERFORMING_DEPTLOC_CODE = j.DISP_LOCN_CODE AND B.ORDER_CATALOG_CODE = I.DRUG_CODE AND decode(j.DISP_VERF_STAGE,'F',I.VERIFICATION_REQD_YN,'B',I.VERIFICATION_REQD_YN,'X') = decode(j.DISP_VERF_STAGE,'F','Y','B','Y','X')");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
								pstmt = connection.prepareStatement( sbMainSql.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;	
							}
							else{
								sbMainSql.append("SELECT A.TRN_GROUP_REF,A.ENCOUNTER_ID,  A.PRIORITY, A.IV_PREP_YN,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID,A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,PH_ORDER_SOURCE(A.SOURCE_CODE,A.PATIENT_CLASS,A.ORDERING_FACILITY_ID,A.SOURCE_TYPE,?) LOCATION,F.PRACTITIONER_ID ,TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME /*,min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value */ FROM OR_ORDER_LINE B,OR_ORDER A,SM_FACILITY_PARAM_LANG_VW G, AM_PRACTITIONER_LANG_VW F,OR_ORDER_LINE_PH K ,OR_ORDER_STATUS_CODE H,PH_DRUG I WHERE B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM AND G.FACILITY_ID=A.ORDERING_FACILITY_ID  AND A.ORD_PRACT_ID=F.PRACTITIONER_ID ");
								//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value added for GHL-CRF-0453 and removed for SKR-SCF-1512 performance
//								if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//									sbMainSql.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? "); 
								// if Added, RBU-GHL-CRF-0054 starts
								if(!priority.equals(""))// 
								{
									if(isSite_ph_new_prescription)
									{
							    	if(priority.equals("R"))
							    	sbMainSql.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//sbMainSql.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
							    	else
							    	sbMainSql.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
							    	}else
							    	{
							    		sbMainSql.append(" AND a.priority = ? ");
							    	}
							    	
								}// if Added, RBU-GHL-CRF-0054 ends
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND TRUNC(B.START_DATE_TIME) BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											sbMainSql.append(" AND TRUNC(B.START_DATE_TIME) BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											sbMainSql.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
										else
											sbMainSql.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
								}
								if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									sbMainSql.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
								if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
									sbMainSql.append(" AND A.ORDER_ID=? ");
								sbMainSql.append(" AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH'  AND A.PERFORMING_DEPTLOC_CODE=?  AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND F.LANGUAGE_ID = G.LANGUAGE_ID AND F.LANGUAGE_ID = ? AND B.ORDER_CATALOG_CODE = I.DRUG_CODE ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
								pstmt = connection.prepareStatement( sbMainSql.toString() +"AND a.patient_class IN ('OP', 'EM')"+sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;	//Added AND a.patient_class IN ('OP', 'EM') for ML-BRU-SCF-1076
							}
						}					
					}
					int position = 0;
					if( (disp_stage.equals("AS")) && scope.equals("B") ){
						pstmt.setString(++position,getLanguageId());
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,priority);
						pstmt.setString(++position,"");
						pstmt.setString(++position,"");
						if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,pat_id);
						if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
							pstmt.setString(++position,order_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDispLocnCode());
						pstmt.setString(++position,getLanguageId());
						
						pstmt.setString(++position,order_date_from);
						pstmt.setString(++position,order_date_to);
						
						//pstmt.setString(++position,this.orderingfacility);//commented for NMC-JD-SCF-0047
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
						//	pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,this.exclude_PRN_orders);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					if(!getIssueTokenOnRegnYN().equals("Y") && !scope.equals("EX")) // if Added for Regression Issue DEC-2018 
						pstmt.setString(++position,(locnCode).equals("null")?"":locnCode);		// Added for BSP-SCF-0060 //!scope.equals("EX") added for ICN69800 // null handled for ML-MMOH-CRF-2085
					} 
					else {
						pstmt.setString(++position,getLanguageId());
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,priority);
						if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,order_date_from);						
							pstmt.setString(++position,order_date_to);
						}
						else if(!order_date_from.equals(""))
							pstmt.setString(++position,order_date_from);
						else if(!order_date_to.equals(""))
							pstmt.setString(++position,order_date_to);
						if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,pat_id);
						if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
							pstmt.setString(++position,order_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDispLocnCode());
						pstmt.setString(++position,getLanguageId());
						
						if ((getIssueTokenOnRegnYN().equals("N") && disp_regn_reqd_yn.equals("N") && verf_combined_with_alloc.equals("C") && !scope.equals("H") && 				((getDispStage().equals("A") && (getFillingStatus().equals("A") || getFillingStatus().equals("X"))) ||(getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X"))) ) ) || (disp_stage.equals("AS") && scope.equals("A") && !verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y"))){// if Added - KAUH-SCF-0183[IN:047989] // (!verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y")) added for ML-BRU-SCF-1379[IN049771] // && !scope.equals("H") ML-BRU-SCF-1495
							if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
								pstmt.setString(++position,order_date_from);
								pstmt.setString(++position,order_date_to);
							}
							else if(!this.order_date_from.equals(""))
								pstmt.setString(++position,order_date_from);
							else if(!this.order_date_to.equals(""))
								pstmt.setString(++position,order_date_to);
						}
						
						//pstmt.setString(++position,this.orderingfacility);//commented for ML-BRU-SCF-1927- NEW CHANGE
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
						//	pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,this.exclude_PRN_orders);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					 if(!getIssueTokenOnRegnYN().equals("Y") && !scope.equals("EX") ) // if,else Added for Regression Issue DEC-2018 //!scope.equals("EX") added for ICN69800
						pstmt.setString(++position,(locnCode).equals("null")?"":locnCode);		// Added for BSP-SCF-0060 // null handled for ML-MMOH-CRF-2085
					}
				}
				else{
					StringBuilder SQL_PH_DISP_MEDICATION_SELECT22 = new StringBuilder();// String is changed as StringBuilder - KAUH-SCF-0183[IN:047989]
					StringBuilder SQL_PH_DISP_MEDICATION_SELECT22A = new StringBuilder();// String is changed as StringBuilder - KAUH-SCF-0183[IN:047989]
					if(disp_stage.equals("AS")){	// All Stages
					/* Code added for IN033339 -- Start   */ 
						if(verf_combined_with_alloc.equals("C")){
							SQL_PH_DISP_MEDICATION_SELECT22.append("SELECT   A.TRN_GROUP_REF,A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID,  TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME  FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,OR_ORDER_LINE_PH K,ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM  AND  C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+)  ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	SQL_PH_DISP_MEDICATION_SELECT22.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//SQL_PH_DISP_MEDICATION_SELECT22.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	SQL_PH_DISP_MEDICATION_SELECT22.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		SQL_PH_DISP_MEDICATION_SELECT22.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							if(scope.equals("B")){// if Added - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(NVL(?,'01-01-2000 00:00'),'dd/mm/yyyy hh24:mi') AND TO_DATE(NVL(?,'01-01-3000 00:00'),'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(NVL(?,'01-01-2000 00:00'),'dd/mm/yyyy hh24:mi') AND   TO_DATE(NVL(?,'01-01-3000 00:00'),'dd/mm/yyyy hh24:mi') " );// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}//Added MMS-DM-CRF-0228 end
								else{
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(NVL(?,'01-01-2000'),'DD/MM/YYYY') AND TO_DATE(NVL(?,'01-01-3000'),'DD/MM/YYYY')+ 0.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(NVL(?,'01-01-2000'),'DD/MM/YYYY') AND   TO_DATE(NVL(?,'01-01-3000'),'DD/MM/YYYY')+.99999 " );// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							else{// else Added - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]  
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND  B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]  
									}
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORDER_ID=? "); 
							SQL_PH_DISP_MEDICATION_SELECT22.append(" AND  PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? 	");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getTokenSeriesCode().equals(""))// if Added- HSA-CRF-0136 [IN:048412]
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIES_CODE=? ");
							if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIAL_NO=? ");
							SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO and  x.TOKEN_LINE_STATUS NOT IN ('VF','XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code "); //changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
						}
						else{
							SQL_PH_DISP_MEDICATION_SELECT22.append("SELECT   A.TRN_GROUP_REF,A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID,  TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME  FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,OR_ORDER_LINE_PH K,ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM  AND  C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+) ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	SQL_PH_DISP_MEDICATION_SELECT22.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//SQL_PH_DISP_MEDICATION_SELECT22.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	SQL_PH_DISP_MEDICATION_SELECT22.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		SQL_PH_DISP_MEDICATION_SELECT22.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							if(scope.equals("B")){// if Added - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(NVL(?,'01-01-2000 00:00'),'dd/mm/yyyy hh24:mi') AND TO_DATE(NVL(?,'01-01-3000 00:00'),'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(NVL(?,'01-01-2000 00:00'),'dd/mm/yyyy hh24:mi') AND   TO_DATE(NVL(?,'01-01-3000 00:00'),'dd/mm/yyyy hh24:mi') " );// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}//Added MMS-DM-CRF-0228 end
								else{
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(NVL(?,'01-01-2000'),'DD/MM/YYYY') AND TO_DATE(NVL(?,'01-01-3000'),'DD/MM/YYYY')+ 0.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME  BETWEEN TO_DATE(NVL(?,'01-01-2000'),'DD/MM/YYYY') AND   TO_DATE(NVL(?,'01-01-3000'),'DD/MM/YYYY')+.99999 " );// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								
							}
							else{// else Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(!order_date_from.equals("") && !order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR ORDER DATE TIME HERE */  AND B.START_DATE_TIME  BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi')");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
										else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564] 
									}
								}//Added MMS-DM-CRF-0228 end
								else{
									if(!order_date_from.equals("") && !order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR ORDER DATE TIME HERE */  AND B.START_DATE_TIME  BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_from.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY')");
										else
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
									}
									else if(!order_date_to.equals("")){
										if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
											SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999");
										else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 "); // code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564] 
									}
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] //CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357]//excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORDER_ID=? "); 
							SQL_PH_DISP_MEDICATION_SELECT22.append(" AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getTokenSeriesCode().equals(""))// if Added HSA-CRF-0136 [IN:048412]
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIES_CODE=?");
							if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIAL_NO=? ");
							//SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO and x.TOKEN_LINE_STATUS NOT IN ('RG','XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code"); //changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 //commented for 61426
							SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO AND NVL(x.token_line_status,'!') NOT IN ('RG', 'XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code"); //changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002 //NVL(x.token_line_status,'!') added for 61426
						}
						
						if(verf_combined_with_alloc.equals("C")){
							SQL_PH_DISP_MEDICATION_SELECT22A.append("SELECT  A.TRN_GROUP_REF, A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID, TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,OR_ORDER_LINE_PH K,ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID  AND   C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");  
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//SQL_PH_DISP_MEDICATION_SELECT22.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	SQL_PH_DISP_MEDICATION_SELECT22A.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]  
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]  
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] //CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357]//excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORDER_ID=? ");  
							SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? "); //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getTokenSeriesCode().equals(""))// if Added HSA-CRF-0136 [IN:048412]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIES_CODE=? ");
							if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIAL_NO=? ");
							SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO and x.TOKEN_LINE_STATUS NOT IN ('VF','XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code"); //and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
						}
						else{
							SQL_PH_DISP_MEDICATION_SELECT22A.append("SELECT  A.TRN_GROUP_REF, A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID, TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,OR_ORDER_LINE_PH K,ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID  AND   C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID ");
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");       
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//SQL_PH_DISP_MEDICATION_SELECT22.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	SQL_PH_DISP_MEDICATION_SELECT22A.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							
							if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y"))
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]  
								}
							}//Added MMS-DM-CRF-0228 end
							else{
								if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
									if(getFilterBasedOnOrdDateYN().equals("Y"))
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_from.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME >= TO_DATE (?, 'DD/MM/YYYY') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
								else if(!order_date_to.equals("")){
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME <= TO_DATE (?, 'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]  
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORDER_ID=? ");  
							SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=?  "); //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getTokenSeriesCode().equals(""))// if Added HSA-CRF-0136 [IN:048412]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIES_CODE=? ");
							if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIAL_NO=? ");
							SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO and x.TOKEN_LINE_STATUS NOT IN ('RG','XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code "); //and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
						}
					/* Code added for IN033339 -- End   */ 
						if(scope.equals("EX")) {
							pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22A.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ; //  In query SQL_PH_DISP_MEDICATION_SELECT22A added y.TOKEN_STATUS NOT IN ('RG','XX') or y.TOKEN_STATUS NOT IN ('VF','XX')  and query defined hereself for IN033339 
						}
						else if(scope.equals("E")) {
							pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22.toString() +" AND B.END_DATE_TIME >= TRUNC(SYSDATE) "+sbDrugRelateSQL.toString() + sbConstructSql.toString() ) ;	//  In query SQL_PH_DISP_MEDICATION_SELECT22 added y.TOKEN_STATUS NOT IN ('RG','XX') or y.TOKEN_STATUS NOT IN ('VF','XX')  and query defined hereself for IN033339				
						}
						else {
							pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22.toString() +sbDrugRelateSQL.toString() + sbConstructSql.toString() ) ;	//  In query SQL_PH_DISP_MEDICATION_SELECT22 added y.TOKEN_STATUS NOT IN ('RG','XX') or y.TOKEN_STATUS NOT IN ('VF','XX')  and query defined hereself for IN033339				
						}
					}
					else{	// For Independent stages
						if(scope.equals("EX")) {
							SQL_PH_DISP_MEDICATION_SELECT22A.append("SELECT  A.TRN_GROUP_REF, A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID, TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME, min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value  FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,OR_ORDER_LINE_PH K,ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID  AND   C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID  ");
							//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value added for GHL-CRF-0453
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? ");  
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//SQL_PH_DISP_MEDICATION_SELECT22.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	SQL_PH_DISP_MEDICATION_SELECT22A.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}//Added MMS-DM-CRF-0228 end
								else{
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}	
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22A.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912)// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND A.ORDER_ID=? ");
							SQL_PH_DISP_MEDICATION_SELECT22A.append("AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? ");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getTokenSeriesCode().equals(""))// if Added, Removed NVL - HSA-CRF-0136 [IN:048412]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIES_CODE=? ");  	 
							if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.TOKEN_SERIAL_NO=? ");  	 
							SQL_PH_DISP_MEDICATION_SELECT22A.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO AND NVL(x.token_line_status,'!') NOT IN ('XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code "); //and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
							pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22A.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;
						} 
						else {
							SQL_PH_DISP_MEDICATION_SELECT22.append("SELECT   A.TRN_GROUP_REF,A.ENCOUNTER_ID,   A.PRIORITY,   A.IV_PREP_YN,   A.ORDER_ID,   TO_CHAR(A.ORD_DATE_TIME,   'DD/MM/YYYY') ORD_DATE_TIME,   F.PRACTITIONER_NAME,   DECODE(A.ORDERING_FACILITY_ID,   A.PERFORMING_FACILITY_ID,   '',   G.FACILITY_NAME) FACILITY_NAME,   PH_ORDER_SOURCE(A.SOURCE_CODE,   A.PATIENT_CLASS,   A.ORDERING_FACILITY_ID,   A.SOURCE_TYPE,?) LOCATION,   F.PRACTITIONER_ID,  TO_CHAR(a.MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME /*, min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value */   FROM    OR_ORDER_LINE B,   OR_ORDER A,   MP_PATIENT C ,   MP_COUNTRY_LANG_VW D,  SM_FACILITY_PARAM_LANG_VW G,   AM_PRACTITIONER_LANG_VW F, OR_ORDER_STATUS_CODE H ,/*OR_ORDER_LINE_PH K,*/ph_drug i  WHERE    /* JOIN CONDITIONS START HERE */ C.PATIENT_ID=A.PATIENT_ID AND   B.ORDER_ID=A.ORDER_ID /* AND B.ORDER_ID=K.ORDER_ID AND A.ORDER_ID=K.ORDER_ID AND B.ORDER_LINE_NUM=K.ORDER_LINE_NUM */ AND  C.NATIONAL_ID_NO=D.COUNTRY_CODE(+)  AND   G.FACILITY_ID=A.ORDERING_FACILITY_ID AND   A.ORD_PRACT_ID=F.PRACTITIONER_ID(+) ");
							//min(nvl(k.print_value,0))min_value,max(nvl(k.print_value,0))max_value  added for GHL-CRF-453 and removed for SKR-SCF-1512 performance
//							if(!priority.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
//								SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR ORDER PRIORITY HERE */  AND A.PRIORITY=? "); 
							// if Added, RBU-GHL-CRF-0054 starts
							if(!priority.equals(""))
							{
								if(isSite_ph_new_prescription)
								{
						    	if(priority.equals("R"))
						    	SQL_PH_DISP_MEDICATION_SELECT22.append(" AND (a.priority = ? and ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) = 0))  ");//SQL_PH_DISP_MEDICATION_SELECT22.append(" /* CHECK FOR ORDER PRIORITY HERE */ AND a.priority = ? ");
						    	else
						    	SQL_PH_DISP_MEDICATION_SELECT22.append(" and (a.priority = ? or ((SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID = a.order_id ) > 0))" );
						    	}else
						    	{
						    		SQL_PH_DISP_MEDICATION_SELECT22.append(" AND a.priority = ? ");
						    	}
						    	
							}						
							// if Added, RBU-GHL-CRF-0054 ends
							if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								if(ph_print_prescription){//Added MMS-DM-CRF-0228 start
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'dd/mm/yyyy hh24:mi') AND TO_DATE(?,'dd/mm/yyyy hh24:mi') ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}//Added MMS-DM-CRF-0228 end
								else{
									if(getFilterBasedOnOrdDateYN().equals("Y")) //if block and else condition added KAUH -EMR for Order date filter
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORD_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+ 0.99999 ");
									else
										SQL_PH_DISP_MEDICATION_SELECT22.append(" AND B.START_DATE_TIME BETWEEN TO_DATE(?,'DD/MM/YYYY') AND TO_DATE(?,'DD/MM/YYYY')+.99999 ");// code 'A.ORD_DATE_TIME' is replaced by 'B.START_DATE_TIME' for Bru-HIMS-CRF-418[IN045564]
								}
							}
							if(!pat_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22.append("/* CHECK FOR PATIENT ID AND ORDER ID HERE IF PROVIDED */  AND A.PATIENT_ID = ? ");
							if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND A.ORDER_ID=? ");
							SQL_PH_DISP_MEDICATION_SELECT22.append(" AND   PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND   (A.ORDER_ID,A.PATIENT_ID) IN (SELECT x.ORDER_ID,x.PATIENT_ID FROM PH_ORD_FOR_DISP_QUEUE 	x,ph_disp_queue y WHERE x.FACILITY_ID=?	 AND x.DISP_LOCN_CODE=? 	");//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
							if(!getTokenSeriesCode().equals(""))// if Added, Removed NVL - HSA-CRF-0136 [IN:048412]
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIES_CODE=?  "); 	
							if(!getTokenNo().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.TOKEN_SERIAL_NO=? "); 	
							SQL_PH_DISP_MEDICATION_SELECT22.append(" AND x.QUEUE_DATE=to_date(?,'DD/MM/YYYY') AND x.QUEUE_SHIFT='*ALL' and x.FACILITY_ID=y.FACILITY_id    and x.DISP_LOCN_CODE=y.DISP_LOCN_CODE and   x.QUEUE_DATE=y.QUEUE_DATE and x.QUEUE_SHIFT=y.QUEUE_SHIFT and x.TOKEN_SERIES_CODE=y.TOKEN_SERIES_CODE   and x.TOKEN_SERIAL_NO=y.TOKEN_SERIAL_NO  AND NVL(x.token_line_status,'!') NOT IN ('XX') ) AND H.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS  AND G.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? and b.order_catalog_code =i.drug_code "); //and changed token_status to token_line_status for PMG2020-ML-MMOH-CRF-0002
							pstmt = connection.prepareStatement( SQL_PH_DISP_MEDICATION_SELECT22.toString() +sbDrugRelateSQL.toString() + sbStagesCondition.toString() + sbConstructSql.toString() ) ;
						}
					}
					int position=0; 
					if( (disp_stage.equals("AS")) && scope.equals("B") ){ 
						pstmt.setString(++position,getLanguageId());
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,priority);
						pstmt.setString(++position,"");
						pstmt.setString(++position,"");
						if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,pat_id);
						if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
							pstmt.setString(++position,order_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDispLocnCode());
						if(!getTokenSeriesCode().equals(""))// if Added HSA-CRF-0136 [IN:048412]
							pstmt.setString(++position,getTokenSeriesCode());//series
						if(!getTokenNo().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getTokenNo());//no
						pstmt.setString(++position,this.queue_date);//queue_date
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						
						pstmt.setString(++position,order_date_from);
						pstmt.setString(++position,order_date_to);
						
						pstmt.setString(++position,this.orderingfacility);
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
							//pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,this.exclude_PRN_orders);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]  
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					if(!getIssueTokenOnRegnYN().equals("Y")  && !scope.equals("EX") )
						pstmt.setString(++position,(locnCode).equals("null")?"":locnCode);		// Added for BSP-SCF-0060 //!scope.equals("EX") added for ICN69800 // null handled for ML-MMOH-CRF-2085
					}
					else{
						pstmt.setString(++position,getLanguageId());
						if(!priority.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,priority);
						if(!order_date_from.equals("") && !order_date_to.equals("")){// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,order_date_from);
							pstmt.setString(++position,order_date_to);
						}
						else if(!order_date_from.equals(""))
							pstmt.setString(++position,order_date_from);
						else if(!order_date_to.equals(""))
							pstmt.setString(++position,order_date_to);
						if(!pat_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,pat_id);
						if(!order_id.equals("") && (!criteriaOrderType.equals("CDR")) && (excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("")))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989] // CDR and CA condition added for ML-MMOH-CRF-0435 [IN:057357] //excl_ord_locn_dispense_yn.equals("N") || excl_ord_locn_dispense_yn.equals("") added for 61912
							pstmt.setString(++position,order_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDispLocnCode());
						if(!getTokenSeriesCode().equals(""))// if added  HSA-CRF-0136 [IN:048412]
							pstmt.setString(++position,getTokenSeriesCode());//series
						if(!getTokenNo().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getTokenNo());//no
						pstmt.setString(++position,this.queue_date);//queue_date
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						if (disp_stage.equals("AS") && scope.equals("A") && !verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y")){// if Added - KAUH-SCF-0183[IN:047989] And !verf_combined_with_alloc.equals("B") && !disp_regn_reqd_yn.equals("Y") checking the Condition for EMR-12.X-Alpha-PHIS-PH-Inc#2558
							if(!this.order_date_from.equals("") && !this.order_date_to.equals("")){
								pstmt.setString(++position,order_date_from);
								pstmt.setString(++position,order_date_to);
							}	
							else if(!this.order_date_from.equals(""))
								pstmt.setString(++position,order_date_from);
							else if(!this.order_date_to.equals(""))
								pstmt.setString(++position,order_date_to);
						}
						//pstmt.setString(++position,this.orderingfacility);//commented for ML-BRU-SCF-1927
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
							//pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))  // if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,this.exclude_PRN_orders);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
						if(!getIssueTokenOnRegnYN().equals("Y")  && !scope.equals("EX") )  // if Added for Regression Issue DEC-2018
						pstmt.setString(++position,(locnCode).equals("null")?"":locnCode);		// Added for BSP-SCF-0060 //!scope.equals("EX") added for ICN69800 // null handled for ML-MMOH-CRF-2085
					}
				}
			}

			resultSet = pstmt.executeQuery() ;
			String min_print_value = "";	//GHL-CRF-0453 
			String max_print_value = "";	//GHL-CRF-0453 
			while(resultSet.next()){
				result.add(resultSet.getString("PRIORITY"));
				result.add(resultSet.getString("ORDER_ID"));
				result.add(resultSet.getString("ORD_DATE_TIME"));
				result.add(resultSet.getString("PRACTITIONER_NAME"));
				result.add(checkForNull(resultSet.getString("LOCATION")));
				result.add(resultSet.getString("FACILITY_NAME"));
				pstmt1.setString(1,(resultSet.getString("ORDER_ID")).trim());
				pstmt1.setString(2,(resultSet.getString("ORDER_ID")).trim());
				resultSet1 = pstmt1.executeQuery();
				String displayRemarksLink = "N";
				if(resultSet1.next()){
					if(resultSet1.getInt("COUNT")>0){
						displayRemarksLink = "Y";
					}
				}
				closeResultSet(resultSet1);
				result.add(displayRemarksLink);
				result.add(resultSet.getString("PRACTITIONER_ID"));
				result.add(resultSet.getString("IV_PREP_YN"));
				result.add(resultSet.getString("TRN_GROUP_REF"));
				result.add(resultSet.getString("ENCOUNTER_ID")); //added for	SKR-SCF-0330 ICN 29789
				/*if(disp_locn_catg.equals("I")){   //Commented for RUT-CRF-0088 [IN036978]
					result.add(resultSet.getString("TAPERED_YN")); //added for	RUT-CRF-0069 ICN 29607
					result.add(resultSet.getString("TAPER_ORDER_ID")); //added for	RUT-CRF-0069 ICN 29607
				}
				else{
					result.add(""); //added for	RUT-CRF-0069 ICN 29607
					result.add(""); //added for	RUT-CRF-0069 ICN 29607
				}*/
				//result.add(resultSet.getString("SOURCE_TYPE"));
				//result.add(resultSet.getString("SOURCE_CODE"));
				order_id_modified_date.put(resultSet.getString("ORDER_ID"),resultSet.getString("MODIFIED_DATE_TIME"));
				order_id_Attended_pract_id.put(resultSet.getString("ORDER_ID"),resultSet.getString("PRACTITIONER_ID"));

				//GHL-CRF-0453 - start
				if(disp_stage.equals("A") || (disp_stage.equals("F") && !fill_list.equals("AF"))){
					//min_print_value = resultSet.getString("MIN_VALUE");
					//max_print_value = resultSet.getString("MAX_VALUE");
					String print_value = getPrintValueForOrders(resultSet.getString("ORDER_ID")); //added for SKR-SCF-1512 performance
					min_print_value = print_value.split("~")[0];
					max_print_value = print_value.split("~")[1];	
					setPrintValueForOrders(resultSet.getString("ORDER_ID"),min_print_value+"~"+max_print_value);
				}
				//GHL-CRF-0453 - end				
				//setEncounterID(resultSet.getString("ENCOUNTER_ID"));
				if(!(getCriteriaOrderType().equals("ALL") || getCriteriaOrderType().equals("CDR"))) // CDR Condition Added for ML-MMOH-CRF-0435 [IN:057357]  
					setWsType(resultSet.getString("IV_PREP_YN"));

				if(disp_stage.equals("F") && fill_list.equals("AF")){
					hmFillPorcID_OrderID.put(resultSet.getString("ORDER_ID"),resultSet.getString("FILL_PROC_ID"));
				}
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			System.err.println( "Error loading getOrders sbMainSql = "+sbMainSql+ " result=" +result) ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeResultSet( resultSet1 ) ;
				closeStatement( pstmt1 ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}


	//code added for getting unallocated drugs....
	/*public String getAllocDrugs( ){
		Connection connection		=	null;
		PreparedStatement pstmt_3	=	null;
		ResultSet rset_3			=	null;
		String unallocDrugs			=	"";
		try{
				connection = getConnection() ;
				pstmt_3	= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT71"));
				pstmt_3.setString(1,login_facility_id.trim());
				rset_3 = pstmt_3.executeQuery();
				if(rset_3 != null && rset_3.next() )
				{
					unallocDrugs	= rset_3.getString("DISP_UNALLOC_DRUGS_AT_DEL_STG");
				}
	
			}
			catch ( Exception e ) {
			e.printStackTrace() ;
			}
			finally {
			try {
				closeResultSet(rset_3);
				closeStatement(pstmt_3);
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		
		}
			return unallocDrugs;
	}*/

	//ended..
	/*
		This method will provide the order line details based on patient id,order id and some other conditions which we have taken care in the case of patient id display ,order id
	*/
	public ArrayList getOrderLineDetails(String patient_id,String order_id)throws Exception {
		ArrayList result			= new ArrayList();
		Connection connection		=	null;
		PreparedStatement pstmt		=	null;
		PreparedStatement pstmt_1	=	null;
		PreparedStatement pstmt_2	=	null;
		PreparedStatement pstmt_3	=	null;//AAKH-CRF-0117
		ResultSet resultSet			=	null;
		ResultSet rset_1			=	null;
		ResultSet rset_2			=	null;
		ResultSet rset_3			=	null;//AAKH-CRF-0117
		String disp_stage			=	getDispStage();
		String disp_regn_reqd_yn	=	getDispRegnReqdYN();
		String divided				=	"";	
		String tmp_qty				=	"";
		String tmp_string			=	"";
		String unallocDrugs			=	"";
		String line_scope			=	"";
		PreparedStatement pstmt_4	=	null;//added for mms-dm-crf-0209.1
		ResultSet rset_4			=	null;//added for mms-dm-crf-0209.1
		 String category_code="";//added for mms-dm-crf-0209.1
		 String alternate_yn = "";//added for mms-dm-crf-0209.1
		StringBuffer sbConstructSql =new StringBuffer();	
		StringBuffer sbStagesCondition =new StringBuffer();// strStagesCondition replaced with sbStagesCondition
		//StringBuffer sbStagesCondition1 =new StringBuffer(); Removed for IN063877
		StringBuffer sbDrugRelateSQL =new StringBuffer();
		StringBuffer sbAppendSql = new StringBuffer();
		StringBuffer sbMainSql = new StringBuffer();
		HashMap hmAltDrugRemarks		= new HashMap(); 
		//CallableStatement callableStatement = null;
		if(objAllStages!=null){
			hmAltDrugRemarks=objAllStages.getAltDrugRemarks();// Added For Bru-HIMS-CRF-082 [IN:029948]-start
			objAllStages.clearPenaltyDtls();
		}
		String fill_reason_code ="" ,fill_reason="";//code added for ML-BRU-SCF-0971[IN042220]

		try {
			//checkForStockInstallation();
			connection = getConnection() ;
			boolean  isSite_ph_new_prescription		= eCommon.Common.CommonBean.isSiteSpecific(connection,"PH","PH_NEW_PRESCRIPTION"); // added By Himanshu Saxena for GHL-CRF-0672
			/* for divided dose */
			//changed during PE By Naveen
			//unallocDrugs = getAllocDrugs();
			unallocDrugs = this.display_unallocDrugs;
			//System.out.println("unallocDrugs in bean " + unallocDrugs);
			sbStagesCondition = new StringBuffer();
			if(disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE")){
				line_scope	=	ip_scope;
			} 
			else {
				line_scope	=	scope;
			}

			pstmt_1 = connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT62")) ;
			pstmt_2	= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT1"));
			pstmt_3	= connection.prepareStatement("select approval_no from ph_disp_dtl_tmp where order_id=? and order_line_no=?");//AAKH-CRF-0117

			scope			= scope==null			? "A" : scope;
			if(((scope).trim()).equals("")){
					scope = "A";
			}
			if(disp_stage.equals("AS")){
				//	Dispense Stage	-->	All Stages
				sbStagesCondition.append(" AND A.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
			}
			else if(disp_stage.equals("V") && getIssueTokenOnRegnYN().equals("N")){
				// Dispense Stage is Verification and Issue Token is not applicable 
				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if (disp_regn_reqd_yn.equals("Y")){
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if( line_scope.equals("EX") ) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','56','94')) ");//Added '94'(UC) for ML-BRU-SCF-1120[IN:44829]
				} 
				else{
					sbStagesCondition.append( " AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','56','94')) ");//Added '94'(UC) for ML-BRU-SCF-1120[IN:44829]
				}
			}
			else if(disp_stage.equals("V") && getIssueTokenOnRegnYN().equals("Y")){
				// Dispense Stage is Verification and Issue Token is applicable
				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if( line_scope.equals("EX") ) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='25') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
			}
			else if((getDispStage().equals("A") && getFillingStatus().equals("A")) || (getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
				/*	Dispense Stage is Allocation and Filling is After Allocation
												or
					Dispense Stage is Filling and Filling is Before Allocation	*/
				sbAppendSql = new StringBuffer(); //String append replace with sbAppendSql
				if(getDispStage().equals("A") && (getFillingStatus().equals("A") )){
					if(verf_combined_with_alloc.equals("C")){
						if (disp_regn_reqd_yn.equals("Y"))// if else added for ML-BRU-SCF-1359 [IN:049558]
							sbAppendSql.append(" ORDER_STATUS_TYPE IN ('25','30') "); 
						else 
							sbAppendSql.append(" ORDER_STATUS_TYPE IN ('25','30','56') ");//Removed '10' for ML-BRU-SCF-1120[IN:44829]
					}
					else{
						sbAppendSql.append(" ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}	
				}
				else if(getDispStage().equals("F") && (getFillingStatus().equals("X") )) {
					if(verf_combined_with_alloc.equals("C")){
						sbAppendSql.append(" ORDER_STATUS_TYPE ='25' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else{
						sbAppendSql.append(" ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}						
				}
				else if(getDispStage().equals("F") && (getFillingStatus().equals("B") )){
					if(verf_combined_with_alloc.equals("C")){
						sbAppendSql.append(" ORDER_STATUS_TYPE IN ('10','25','30','56','94') ");//Added '94' for ML-BRU-SCF-1120[IN:44829]
					}
					else{
						sbAppendSql.append(" ORDER_STATUS_TYPE ='30' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}	
				}

				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(getIssueTokenOnRegnYN().equals("N")){
					String strappend ="";
					 if(verf_combined_with_alloc.equals("C")){
						strappend=" ORDER_STATUS_TYPE IN ('10','56','94') ";//added for ML-BRU-SCF-1802
					}
					 else{
						strappend=" ORDER_STATUS_TYPE IN ('30' ) ";//Removed 94 for ML-BRU-SCF-1797
					}
					// Issue Token is not applicable
					if (disp_regn_reqd_yn.equals("Y")){
						 if(verf_combined_with_alloc.equals("C")){
							strappend=" ORDER_STATUS_TYPE ='25' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						else{
							strappend=" ORDER_STATUS_TYPE ='30' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
						}
						//sbStagesCondition.append( " AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('25','30','56','36')) ");
						sbStagesCondition.append( " AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE "+strappend+" ) ");
					} 
					else if( line_scope.equals("EX") ) {
						//sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','56','36','50','94')) AND A.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbStagesCondition.append(strappend);
						sbStagesCondition.append(" ) AND A.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
					} 
					else { 
						//sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','56','36','94')) AND A.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbStagesCondition.append(strappend);
						sbStagesCondition.append("  ) AND A.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
					}
				}
				else{
					// Issue Token is applicable
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
					sbStagesCondition.append(sbAppendSql.toString()+")");
					/* //commented the if -else and put the code above b'z the below else if criterias are same
					if( line_scope.equals("EX") ) {
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbStagesCondition.append(sbAppendSql.toString()+")");
 						strStagesCondition = " AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE "+ append +")";
					} 
					else {
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
						sbStagesCondition.append(sbAppendSql.toString()+")");
					}*/
				}
			}
			else if(getDispStage().equals("F") && getFillingStatus().equals("A")){
				// Dispense Stage is Filling and Filling is after Allocation
				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='36') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				}
			}
			else if(getDispStage().equals("A") && (getFillingStatus().equals("B") || getFillingStatus().equals("X"))){
				// Dispense Stage is Allocation and Filling is before Allocation
				String append1="";
				if(getDispStage().equals("A") && getFillingStatus().equals("B")){
					append1=" ORDER_STATUS_TYPE ='35' ";
				}
				else{
					if(verf_combined_with_alloc.equals("C")){
						if (disp_regn_reqd_yn.equals("Y")) //if block & else condition added for ML-BRU-SCF-1120[IN:44829] 
							append1=" ORDER_STATUS_TYPE IN ('25','30','35' )";// Removed 56 for ML-BRU-SCF-1359 [IN:049558]94 removed for ML-BRU-SCF-1797
						else
							append1=" ORDER_STATUS_TYPE IN ('10','25','30','35','56','94') ";//added for ML-BRU-SCF-1802
					}
					else{
						append1=" ORDER_STATUS_TYPE IN ('30') ";//Removed 94 for TTM-SCF-0097 [IN:048812]
					}						
				}
 
				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				/*else if( line_scope.equals("EX") ) { 
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
					sbStagesCondition.append(append1);
					sbStagesCondition.append(")");
				}
				else if(getIssueTokenOnRegnYN().equals("N")){
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
					sbStagesCondition.append(append1);
					sbStagesCondition.append(")");
				}*/ //commented for tuning - all the above else if criterias are same
				else {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ");
					sbStagesCondition.append(append1);
					sbStagesCondition.append(")");
				}
			}
			else if((getDispStage().equals("D") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
				// Dispense Stage is Delivery and Filling is before Allocation
				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(unallocDrugs.equals("Y")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','36','56','30','25','94'))");//Added '94'(UC) for ML-BRU-SCF-1120[IN:44829]
				}
				else {
					if(getIssueTokenOnRegnYN().equals("N")){
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('36','56')) ");
					}
					else{
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='36') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
				}
			}
			else if((getDispStage().equals("D") && getFillingStatus().equals("A"))){
				// Dispense Stage is Delivery and Filling is after Allocation
				if(line_scope.equals("H")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
				} 
				else if(unallocDrugs.equals("Y")) {
					sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('10', '35','30','56','94')) ");//Added '94' for ML-BRU-SCF-1120[IN:44829]
				} 
				else {
					if(getIssueTokenOnRegnYN().equals("N")){
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('35','56')) ");
					}
					else{
						sbStagesCondition.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='35') ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
				}
			}

			// This is formed dynamically depending status...
			sbConstructSql = new StringBuffer(); // String strAppend replaced with sbConstructSql
			//String bmsCheck	= "OR ( B.ORDER_QTY>(SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_LINE_NUM= B.ORDER_LINE_NUM AND ORDER_ID=A.ORDER_ID)) )";

			if(disp_stage.equals("AS")){
				if (scope.equals("A")){			//	A --> All Prescriptions
					sbConstructSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','56','50','30') ");//'35','36', removed for TTM-SCF-0097 [IN:048812]
					//sbConstructSql.append(bmsCheck);
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" ) AND B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58' )");
				}
				else if (scope.equals("P")){	//	P --> Pending Prescriptions
					if (disp_regn_reqd_yn.equals("Y")){
						sbConstructSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE = '25'");
					}
					else{
						sbConstructSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in('10','94')");
					}
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" )");
					//sbConstructSql.append(bmsCheck);
				}
				else if (scope.equals("B")){	// B --> BMS Prescriptions
					sbConstructSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ( '56','94') ");
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" )");
					//sbConstructSql.append(bmsCheck);
				}
				else if (scope.equals("R")){	// R --> Refill Prescriptions
					sbConstructSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE  ORDER_STATUS_TYPE in('10','25','94')");// IN Added instead of OR KAUH-SCF-0183[IN:047989]
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" )");
					//sbConstructSql.append(bmsCheck);
				}
				else if (scope.equals("D")){	// D --> Discharge Medication
					sbConstructSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE in('10','25','94')");// IN Added instead of OR KAUH-SCF-0183[IN:047989]
					sbConstructSql.append(sbStagesCondition.toString());
					sbConstructSql.append(" )");
					//sbConstructSql.append(bmsCheck);
				}
			}
			sbConstructSql.append(" AND A.ORDER_ID= ? ");
			/*	Based on the drug class, form the condition which should be appended
				to the Query.	*/
			ArrayList arrListDrug = null;
			if (arrListdrugClass == null){
				arrListDrug = buildDrugRelatedSQL(disp_locn_code);
			}
			else{
				arrListDrug = arrListdrugClass;
			}
			sbDrugRelateSQL = new StringBuffer( " AND A.ORDER_TYPE_CODE IN (SELECT ORDER_TYPE_CODE FROM PH_ORDER_TYPE_FOR_DRUG_CLASS WHERE "); // String strDrugRelatedSQL replaced with sbDrugRelateSQL
			int k=1;
			for (int i=0;i<arrListDrug.size();i++){
				if (i==0){
					sbDrugRelateSQL.append(" DRUG_CLASS = '");
					sbDrugRelateSQL.append((String)arrListDrug.get(i)+"' ");
				}
				else{
					sbDrugRelateSQL.append(" OR DRUG_CLASS = '");
					sbDrugRelateSQL.append((String)arrListDrug.get(i)+"' ");
				}
				k++;
			}
			sbDrugRelateSQL.append(" ) ");

			if (k==1){
				sbDrugRelateSQL=new StringBuffer();
			}
			sbMainSql = new StringBuffer(); //String sql_str replace with sbMainSql

			//String sql_stock_append = ",PH_RET_TOT_STOCK_AVAIL (B.DRUG_CODE,G.BMS_QTY,?,TO_CHAR(A.END_DATE_TIME,'DD/MM/YYYY HH24:MI')) STKAVAILABLE ";//commented and added below line by Ganga for ML-BRU-SCF-0905
			String sql_stock_append = ",PH_RET_TOT_STOCK_AVAIL (B.DRUG_CODE,G.BMS_QTY,?, TO_CHAR ((CASE WHEN a.end_date_time < (SYSDATE + ?) THEN a.end_date_time ELSE SYSDATE + ?  END),'DD/MM/YYYY HH24:MI')) STKAVAILABLE ";
			int position = 1;

			//added for SRR20056-CRF-0663 --Start
			String sFreqDurnAbsOrderFlag = "X"; //Both unchecked
			if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
				if(this.include_absolute_orders.equals("Y") && this.include_drugs_by_freq_durn.equals("Y"))
					sFreqDurnAbsOrderFlag="B";	// For Both Absolute orders and FreqDurn orders
				else if(this.include_absolute_orders.equals("Y") && this.include_drugs_by_freq_durn.equals("N"))
					sFreqDurnAbsOrderFlag="A";	//Only Absolute orders
				if(this.include_absolute_orders.equals("N") && this.include_drugs_by_freq_durn.equals("Y"))
					sFreqDurnAbsOrderFlag="F";	
			}
			else
				sFreqDurnAbsOrderFlag = this.include_absolute_orders;//added for SRR20056-CRF-0663 --End
			if(disp_locn_catg.equals("O")){	// Outpatient
				if(disp_stage.equals("AS")){	// All Stages//l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON, added for aakh-crf-0140
					sbMainSql.append("SELECT /*+ INDEX(OR_ORDER_LINE IN_OR_ORDER_LINE) */ H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value ,I.FORM_DESC,I.FORM_CODE, B.DRUG_CODE,B.DRUG_CLASS,B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP,F.GENERIC_NAME, (SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM ) ALLOC_QTY, B.DRUG_DESC,B.IN_FORMULARY_YN,A.ORDER_QTY,Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,A.QTY_UNIT,C.SHORT_DESC QTY_UNIT_DESC,D.FREQ_DESC,decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE,A.DURN_VALUE ACT_DURN, E.DURN_DESC,TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME,TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME,A.ORDER_QTY PRES_QTY_VALUE,A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON,G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON,G.ORDER_LINE_NUM,A.ORDER_LINE_STATUS,B.GENERIC_ID,/* nvl(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY) */ nvl( g.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE,Ph_Drugdoseinlimit(B.DRUG_CODE,?,A.QTY_VALUE,A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT,H.SOURCE_CODE, H.SOURCE_TYPE,H.ORDERING_FACILITY_ID,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,H.ORD_PRACT_ID PERFORMING_PRACT_ID,j.long_name trade_name,g.trade_code, Ph_Getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON ,(CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN VERIFICATION_REQD_YN,A.ORDER_LINE_STATUS ORDER_LINE_STATUS,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn , l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON, l.DOSAGE_LIMIT_OVERRIDE_REASON, l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN, g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM, b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS,g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING,g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE,g.BMS_INCLUDE_YN, g.DELIVERY_TASK_FINDING #,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN, PATIENT_BROUGHT_MEDICATION_YN, PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT, b.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F,OR_ORDER H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE  A.ORDER_ID= H.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY = A.ORDER_CATEGORY AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G.TRADE_CODE = J.TRADE_ID(+)  AND A.ORDER_ID= ? AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ?  ");//code " ,m.ALLOCATE_REMARKS_CODE, m.ALLOCATE_TASK_FINDING,m.FILL_REMARKS_CODE, m.FILL_TASK_FINDING, m.DELIVERY_REMARKS_CODE,m.DELIVERY_TASK_FINDING and ,PH_DISP_DTL_TMP m and AND m.ORDER_ID(+) = A.ORDER_ID AND m.ORDER_LINE_NO(+) = a.ORDER_LINE_NUM " added for  ML-BRU-SCF-0971[IN042220] - changed from PH_DISP_DTL_TMP to or_order_line_ph/*OR ( A.ORDER_QTY>nvl((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP M WHERE M.ORDER_LINE_NO= A.ORDER_LINE_NUM AND M.ORDER_ID=A.ORDER_ID),0)))*/////Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013 //Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]
					if(verf_combined_with_alloc.equals("B")){//code added for ML-BRU-SCF-1120[IN044829]--Start
							sbMainSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='30')");//code ' ,'94' ' removed for Bru-HIMS-CRF-416[IN045566] //'35','36', removed for TTM-SCF-0097 [IN:048812]//'50','56'- Removed for ML-BRU-SCF-1379[IN049771]
					}
					else if(verf_combined_with_alloc.equals("C")){
						if(disp_regn_reqd_yn.equals("Y"))
							sbMainSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('25','50','56'))");//code ' ,'94' ' removed for Bru-HIMS-CRF-416[IN045566]	//'35','36', removed for TTM-SCF-0097 [IN:048812]//'30','56'- Removed for ML-BRU-SCF-1379[IN049771]
						else
							sbMainSql.append(" AND A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','30','50','56','94'))");//code added for ML-BRU-SCF-1120[IN044829] --End //'35','36', removed for TTM-SCF-0097 [IN:048812]
					}

					sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbMainSql.append(" AND a.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
					sbMainSql.append(" AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) ");
					if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" and b.DRUG_YN =? "); 
					sbMainSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
					if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC ");
					else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM ");

					if(drug_medical.equals("")){
						sbMainSql.append(" , b.DRUG_YN desc");
					}
					//System.err.println("===10958=====OP ORDERLINTDTL======sbMainSql===>"+sbMainSql.toString());
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,patient_id);
					if(getStockInstalled()){//stock_installed
						if(store_code==null)store_code="";
						pstmt.setString(++position,store_code);
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905						
					}
					pstmt.setString(++position,order_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to include_absolute_orders for SRR20056-CRF-0663
					//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
						//pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);
					pstmt.setString(++position,this.exclude_PRN_orders);
					pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
				}
				else{	// Independent Stages ,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details added for mms-kh-crf-0028
					if(disp_stage.equals("V")&&getIssueTokenOnRegnYN().equals("N")&&disp_regn_reqd_yn.equals("N")){//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
						sbMainSql.append("SELECT H.PATIENT_ID, (SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE, (SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_Getmindosedetails(B.drug_code,?) MINDOSEDETAILS, (SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM ) ALLOC_QTY, Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value,B.DRUG_CODE,B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS,B.DRUG_DESC, I.FORM_DESC,I.FORM_CODE, ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_QTY,A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC,D.FREQ_DESC,decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE,A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP,G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON, G.ALLERGY_OVERRIDE_REASON,G.DRUG_INDICATION, G.DUPLICATE_DRUG_OVERRIDE_REASON,G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM,A.ORDER_LINE_STATUS,B.GENERIC_ID,/*nvl(ph_calculatebalance(a.order_id,a.order_line_num) ,A.ORDER_QTY)*/nvl( g.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE,Ph_Drugdoseinlimit(B.DRUG_CODE,?,A.QTY_VALUE, A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT,H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID ,J.LONG_NAME TRADE_NAME,G.TRADE_CODE, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON ,(CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn , B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn, l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN ,g.SLIDING_SCALE_YN SLIDING_SCALE_YN , G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM, b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN,G.BMS_INCLUDE_YN, l.ALT_DRUG_REMARKS, h.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN #,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F, OR_ORDER H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J ,PH_DISP_LOCN k ,ph_patient_drug_profile l WHERE A.ORDER_ID = H.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY = A.ORDER_CATEGORY AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE AND A.DURN_TYPE=E.DURN_TYPE AND F.GENERIC_ID=B.GENERIC_ID AND G.TRADE_CODE = J.TRADE_ID(+) AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = D.LANGUAGE_ID AND B.LANGUAGE_ID = E.LANGUAGE_ID AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? AND H.PERFORMING_DEPTLOC_CODE = k.DISP_LOCN_CODE AND decode(k.DISP_VERF_STAGE,'F',B.VERIFICATION_REQD_YN,'B',B.VERIFICATION_REQD_YN,'X') = decode(k.DISP_VERF_STAGE,'F','Y','B','Y','X')"); // Added BMS_INCLUDE_YN for [IN:045295] // //Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013  
					}
					else{//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
						sbMainSql.append("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE, (SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_Getmindosedetails(B.drug_code,?) MINDOSEDETAILS, (SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM ) ALLOC_QTY, Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value,B.DRUG_CODE,B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS,B.DRUG_DESC, I.FORM_DESC,I.FORM_CODE, ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_QTY,A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC,D.FREQ_DESC,decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE,A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON,G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM,A.ORDER_LINE_STATUS,B.GENERIC_ID,/*nvl(ph_calculatebalance(a.order_id,a.order_line_num) ,A.ORDER_QTY)*/nvl( g.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE,Ph_Drugdoseinlimit(B.DRUG_CODE,?,A.QTY_VALUE, A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT,H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID ,J.LONG_NAME TRADE_NAME,G.TRADE_CODE, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON ,(CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn ,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn, l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN ,g.SLIDING_SCALE_YN SLIDING_SCALE_YN , G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS, g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING, g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE, g.DELIVERY_TASK_FINDING, g.BMS_INCLUDE_YN , h.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN #,print_value,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F, OR_ORDER H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE A.ORDER_ID = H.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY = A.ORDER_CATEGORY AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE AND A.DURN_TYPE=E.DURN_TYPE AND F.GENERIC_ID=B.GENERIC_ID AND G.TRADE_CODE = J.TRADE_ID(+) AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = D.LANGUAGE_ID AND B.LANGUAGE_ID = E.LANGUAGE_ID AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? "); //and exists (select 'Y' from ph_disp_dtl_tmp ddtl where ddtl.ORDER_ID=a.order_id and ddtl.disp_qty > 0  and not exists (select 'Y' from or_ordeR_line ol where ol.order_id = ddtl.order_id and ol.order_line_num = ddtl.order_line_no)) for BRU-SCF-274 AND //code " ,m.ALLOCATE_REMARKS_CODE, m.ALLOCATE_TASK_FINDING,m.FILL_REMARKS_CODE, m.FILL_TASK_FINDING, m.DELIVERY_REMARKS_CODE,m.DELIVERY_TASK_FINDING  and ,PH_DISP_DTL_TMP m and AND m.ORDER_ID(+) = A.ORDER_ID  AND m.ORDER_LINE_NO(+) = a.ORDER_LINE_NUM " added for  ML-BRU-SCF-0971[IN042220] - changed from PH_DISP_DTL_TMP to or_order_line_ph // //Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013
						//print_value added for GHL-CRF-453
					}
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbMainSql.append(" AND a.end_date_time >= SYSDATE ");  //Modified for ML-MMOH-SCF-0393 [IN:060238]
					sbMainSql.append(sbDrugRelateSQL.toString());
					sbMainSql.append(sbStagesCondition.toString());
					sbMainSql.append(sbConstructSql.toString());

					sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
					sbMainSql.append(	"AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) ");
					if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" and b.DRUG_YN =? "); 
					sbMainSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
					if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC ");
					else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM ");

					if(drug_medical.equals("")){
						sbMainSql.append(" , b.DRUG_YN desc");
					}
					//System.err.println("========OP ORDERLINTDTL======sbMainSql===>"+sbMainSql.toString());
					position = 1;
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;

					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					if(getStockInstalled()){//stock_installed
						if(store_code==null)store_code="";
						pstmt.setString(++position,store_code);
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
					}
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,order_id);
					pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
						//pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);
					pstmt.setString(++position,this.exclude_PRN_orders);
					pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
					pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
				}
			}
			else if(disp_locn_catg.equals("I")){	//Inpatient
				if(disp_stage.equals("V")){
					// Verification Stage //,alergy_details,dosage_details,duplicate_details,INTARACTION_DETAILS added for MMS-KH-CRF-0028
					//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
					sbMainSql = new StringBuffer("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE, B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS,B.DRUG_DESC, I.FORM_DESC,I.FORM_CODE,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_QTY, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, B.IN_FORMULARY_YN, /*NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY)*/ NVL( G.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, A.QTY_VALUE, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value, H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,J.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn ,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON, l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM, b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS # ,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details,PATIENT_BROUGHT_MEDICATION_YN, ph_drug_expiry_alert (h.performing_deptloc_code,b.drug_code,b.drug_expiry_alert_days) expiry_alert, b.drug_expiry_alert_days FROM OR_ORDER_LINE A,OR_ORDER H, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE_LANG_VW G1,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE H.ORDer_ID=A.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY=A.ORDER_CATEGORY AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND G.TRADE_CODE = J.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND G1.ORDER_STATUS_TYPE IN ('10','25','56','50') AND A.ORDER_ID= ? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ?");   //and exists (select 'Y' from ph_disp_dtl_tmp ddtl where ddtl.ORDER_ID=a.order_id and ddtl.disp_qty > 0  and not exists (select 'Y' from or_ordeR_line ol where ol.order_id = ddtl.order_id and ol.order_line_num = ddtl.order_line_no)) for BRU-SCF-274//Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223]//Added 25 for ML-BRU-SCF-1338[IN049193] // I.FORM_CODE Added for MMS-KH-CRF-0013//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]

					sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbMainSql.append(" AND a.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]

					//Added for SRR20056-CRF-0663	--Start
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
						sbMainSql.append( " and ((b.drug_yn='Y' AND ( b.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', b.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR (h.iv_prep_yn IN ('0', '2', '4', '6')) OR (b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR b.drug_yn='N' ) and ( (b.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR b.drug_yn='N') ");
					}
					else{
						sbMainSql.append(" AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')))") ;
					}
					//Added for SRR20056-CRF-0663	--End
					sbMainSql.append( " and exists (select 'X' from ip_open_encounter where facility_id = h.ordering_facility_id and encounter_id = h.encounter_id) "); //added to filter only current Inpatient.

					if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" and b.DRUG_YN =? "); 
					sbMainSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
					if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC "); 
					else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM");

					if(drug_medical.equals("")){
						sbMainSql.append(" , b.DRUG_YN desc");
					}
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					position = 1;
					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					if(getStockInstalled()){//stock_installed
						if(store_code==null)store_code="";
							pstmt.setString(++position,store_code);
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
					}
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,order_id);
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
						pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
					}
					pstmt.setString(++position,this.exclude_PRN_orders);
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);
					pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
				    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
				}
				else if(disp_stage.equals("F") && fill_list.equals("AF")){
					// Filling Stage and Against Fill List
					String strAppendForIP = "";
					sbMainSql = new StringBuffer();
					if(line_scope.equals("H")) {
						strAppendForIP = strAppendForIP + " AND G1.ORDER_STATUS_TYPE ='50' ";// = Added instead of IN KAUH-SCF-0183[IN:047989]
					}
					else if(getOrderStatus().equals("OSN")){	//Order Status is new
						strAppendForIP = strAppendForIP + " AND G1.ORDER_STATUS_TYPE IN ('10','25','30','36','35') ";
					}
					//if(getBatches().equals("BA")){
						if(line_scope.equals("H")) {//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
							sbMainSql.append("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE,B.IN_FORMULARY_YN, H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS, B.DRUG_DESC,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_LINE_NUM ,A.ORDER_QTY, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value , A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, I.FORM_DESC,I.FORM_CODE, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP,G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, A.QTY_VALUE, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, H.SOURCE_CODE,H.SOURCE_TYPE,H.ORDERING_FACILITY_ID,TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,J.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,A.FREQ_CODE freq_code,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn ,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS #,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A,OR_ORDER H, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE_LANG_VW G1, PH_FILL_PROCESS_PARAM H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE H.ORDER_ID=A.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND h.fill_proc_id = g.fill_proc_id AND G.TRADE_CODE = J.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 ");//Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013
							if(!getFillProcessID().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND h.fill_proc_id = ? "); 
							sbMainSql.append(" AND TRUNC (h.FILL_PROC_DATE_TIME) = DECODE (?,NULL, TRUNC (h.FILL_PROC_DATE_TIME),TRUNC (TO_DATE (?, 'dd/mm/yyyy'))) ");
							if(!getFillType().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND H.PROC_TYPE=? ");
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('10','25','30','36','35','50') AND A.ORDER_ID=? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? ");
						}
						else{//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
							sbMainSql.append("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE,B.IN_FORMULARY_YN, H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS, B.DRUG_DESC,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_LINE_NUM ,A.ORDER_QTY, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value , A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, I.FORM_DESC,I.FORM_CODE, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP,G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, A.QTY_VALUE, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, H.SOURCE_CODE,H.SOURCE_TYPE,H.ORDERING_FACILITY_ID,TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,J.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,A.FREQ_CODE freq_code,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn ,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS , g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING, g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE, g.DELIVERY_TASK_FINDING #,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A,OR_ORDER H, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE_LANG_VW G1, PH_DISP_HDR_TMP G2, PH_FILL_PROCESS_PARAM H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE H.ORDER_ID=A.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND A.ORDER_ID=G2.ORDER_ID AND H.ORDER_ID=G2.ORDER_ID AND H.FILL_PROC_ID=G2.FILL_PROC_ID AND G.TRADE_CODE = J.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 ");//Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013
							if(!getFillProcessID().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND G2.FILL_PROC_ID=? ");
							sbMainSql.append(" AND TRUNC(G2.RECORD_DATE_TIME)=decode(?,null,TRUNC(G2.RECORD_DATE_TIME),TRUNC(TO_DATE(?,'dd/mm/yyyy'))) ");
							if(!getFillType().equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
								sbMainSql.append(" AND H.PROC_TYPE=? ");
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('10','25','30','36','35') AND A.ORDER_ID=? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? "); //- changed from PH_DISP_DTL_TMP to or_order_line_ph
						} //and exists (select 'Y' from ph_disp_dtl_tmp ddtl where ddtl.ORDER_ID=a.order_id and ddtl.disp_qty > 0  and not exists (select 'Y' from or_ordeR_line ol where ol.order_id = ddtl.order_id and ol.order_line_num = ddtl.order_line_no)) for BRU-SCF-274
						sbMainSql.append(strAppendForIP);
						sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
						if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
							sbMainSql.append(" AND a.end_date_time >= SYSDATE ");  //Modified for ML-MMOH-SCF-0393 [IN:060238]
						//Added for SRR20056-CRF-0663	--Start
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
							sbMainSql.append(" and ((b.drug_yn='Y' AND ( b.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', b.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR (h.iv_prep_yn IN ('0', '2', '4', '6')) OR (b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR b.drug_yn='N' ) and ( (b.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR b.drug_yn='N' ) ");
						}
						else{
							sbMainSql.append(" AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) " );
						}
						//Added for SRR20056-CRF-0663	--End
						sbMainSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = h.ordering_facility_id and encounter_id = h.encounter_id) "); //added to filter only current Inpatient.

						if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" and b.DRUG_YN =? "); 
						if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
						    sbMainSql.append(" AND ph_get_user_disp_rights(?,?,H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC ");
						else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
						sbMainSql.append(" AND ph_get_user_disp_rights(?,?,H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM");

						pstmt = connection.prepareStatement( sbMainSql.toString() ) ;
						position = 1;
						pstmt.setString(position,getLanguageId());
						pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
						pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
						pstmt.setString(++position,patient_id);
						pstmt.setString(++position,patient_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
						pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
						pstmt.setString(++position,patient_id);
						if(getStockInstalled()){//stock_installed
							if(store_code==null)store_code="";
							pstmt.setString(++position,store_code);
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
						}
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						if(!getFillProcessID().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getFillProcessID());
						pstmt.setString(++position,getFillProcessDate());
						pstmt.setString(++position,getFillProcessDate());
						if(!getFillType().equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,getFillType());
						pstmt.setString(++position,order_id);
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
							pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						}
						pstmt.setString(++position,this.exclude_PRN_orders);
						if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,login_facility_id);	//Added for KAUH-SCF-0183  
						pstmt.setString(++position,login_by_id);		//Added for KAUH-SCF-0183
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022

					/*}else if(getBatches().equals("BNA")){	//Batches not applicable
						sql_str = PhRepository.getPhKeyValue("SQL_PH_DISP_IP_MEDICATION_SELECT11A")+strAppendForIP;
						sql_str = replaceStockQuery(sql_str,sql_stock_append);

						sql_str	+=	" ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM";
						//System.out.println("#### 444 sql_str="+sql_str);
						pstmt = connection.prepareStatement( sql_str ) ;
						position = 1;
						pstmt.setString(position,patient_id.trim());
						pstmt.setString(++position,patient_id.trim());
						pstmt.setString(++position,patient_id.trim());
						if(stock_installed){
							if(store_code==null)store_code="";
							pstmt.setString(++position,store_code.trim());
						}
						pstmt.setString(++position,login_facility_id.trim());
						pstmt.setString(++position,getFillType().trim());
						pstmt.setString(++position,order_id.trim());
					}*/					
				}
				else if((disp_stage.equals("F") && fill_list.equals("WF"))|| disp_stage.equals("A")){
					// Filling Stage and Without Fill List//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
					if(getPhAltDispLocnYN().equals("Y"))
						sbMainSql.append("SELECT H.PATIENT_ID,(CASE WHEN TRUNC (G.picklist_date) = TRUNC (SYSDATE) THEN 'true' ELSE 'false' END) is_picklist_date_today, (SELECT max(worksheet_id) FROM ph_worksheet_hdr WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,DECODE((SELECT DISP_QTY FROM PH_DISP_DTL WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2),NULL,(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2),(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2)) ALLOC_QTY, Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CLASS,B.DRUG_CODE,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, F.GENERIC_NAME, B.DRUG_DESC,B.IN_FORMULARY_YN, J.FORM_DESC,J.FORM_CODE, A.ORDER_QTY, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP,G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.ALLERGY_OVERRIDE_REASON,G.DRUG_INDICATION, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, /* G.BMS_QTY-NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM),0) NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY) */ NVL(G.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, a.qty_value, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value, H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID, H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,K.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE, b.drug_yn drug_yn ,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON, l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS, g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING, g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE,g.DELIVERY_TASK_FINDING # ,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN,print_value,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, OR_ORDER H , PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE G1, PH_FORM_LANG_VW J,AM_TRADE_NAME_LANG_VW K,ph_patient_drug_profile l WHERE A.ORDER_ID=H.ORDER_ID AND H.ORDER_CATEGORY='PH' AND H.ORDER_CATEGORY=A.ORDER_CATEGORY AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=J.FORM_CODE AND B.FORM_CODE=J.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND G.TRADE_CODE = K.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME ,A.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_ID= ?  AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = J.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID = ? AND K.LANGUAGE_ID(+) = ? "); //Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223]//removed ph_disp_locn_appl_yn for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP // I.FORM_CODE Added for MMS-KH-CRF-0013
						//print_value added for GHL-CRF-0453
					else
						sbMainSql.append("SELECT H.PATIENT_ID,(CASE WHEN TRUNC (G.picklist_date) = TRUNC (SYSDATE) THEN 'true' ELSE 'false' END) is_picklist_date_today, (SELECT max(worksheet_id) FROM ph_worksheet_hdr WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,DECODE((SELECT DISP_QTY FROM PH_DISP_DTL WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2),NULL,(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2),(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2)) ALLOC_QTY, Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CLASS,B.DRUG_CODE,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, F.GENERIC_NAME, B.DRUG_DESC,B.IN_FORMULARY_YN, J.FORM_DESC,J.FORM_CODE, A.ORDER_QTY, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.ALLERGY_OVERRIDE_REASON,G.DRUG_INDICATION, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, /* G.BMS_QTY-NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM),0) NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY) */ NVL(G.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, a.qty_value, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value, H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID, H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,K.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE, b.drug_yn drug_yn ,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON, l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS, g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING, g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE,g.DELIVERY_TASK_FINDING # ,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN ,print_value,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, OR_ORDER H , PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE G1, PH_FORM_LANG_VW J,AM_TRADE_NAME_LANG_VW K,ph_patient_drug_profile l WHERE A.ORDER_ID=H.ORDER_ID AND H.ORDER_CATEGORY='PH' AND H.ORDER_CATEGORY=A.ORDER_CATEGORY AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=J.FORM_CODE AND B.FORM_CODE=J.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND G.TRADE_CODE = K.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME ,A.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_ID= ? AND ph_disp_locn_appl_yn (h.orig_performing_deptloc_code,?, H.source_type, H.source_code, h.added_facility_id, H.performing_facility_id, H.PERFORMING_DEPTLOC_CODE, B.drug_class, B.drug_code, H.ORDER_TYPE_CODE, H.patient_class, H.priority, H.discharge_ind, decode(B.drug_yn,'Y','D','N','M'),H.iv_prep_yn,H.ORIG_PERFORMING_DEPTLOC_CODE, H.order_id, H.HOME_LEAVE_MEDN_YN, H.PATIENT_ID, H.ENCOUNTER_ID) = 'Y' AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = J.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID = ? AND K.LANGUAGE_ID(+) = ? "); //Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223]//commented  for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP // I.FORM_CODE Added for MMS-KH-CRF-0013
					sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);

					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbMainSql.append(" AND a.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
					if(line_scope.equals("H")) {
						sbMainSql.append(" AND G1.ORDER_STATUS_TYPE ='50' ");// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else	if(getIPVerificationYN().equals("Y")){
						if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA") || getOrderType().equals("TD")) {//added for ml-mmoh-crf-0468
							if(line_scope.equals("A"))  // if condition Added for ML-MMOH-CRF-0434 [IN057356] 
								sbMainSql.append(	" AND G1.ORDER_STATUS_TYPE IN ('25','30','56','35','50') ");
							else
							sbMainSql.append(	" AND G1.ORDER_STATUS_TYPE IN ('25','30','56','35') ");//Added 25 for ML-BRU-SCF-1338[IN049193]
						}
						else{
							if(line_scope.equals("A"))  // if condition Added for ML-MMOH-CRF-0434 [IN057356]
								sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('25','30','56','94','50') ");
							else 
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('25','30','56','94','62') ");//Added 25 for ML-BRU-SCF-1338[IN049193]//,'62' added for MMS-KH-CRF-0014
						}
					}
					else{
						if(getOrderType().equals("TA")||getOrderType().equals("IVIA")||getOrderType().equals("IVAA")||getOrderType().equals("CO")||getOrderType().equals("CA")) {
							
							if(line_scope.equals("A"))  // if condition Added for ML-MMOH-CRF-0434 [IN057356]
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('10','30','56','35','50') ");
							else 
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('10','30','56','35') ");
						} 
						else {
							if(line_scope.equals("A"))  // if condition Added for ML-MMOH-CRF-0434 [IN057356]
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('10','25','30','56','94','50') ");
							else
							sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('10','25','30','56','94') ");//Added 25 for ML-BRU-SCF-1338[IN049193]
						}
					}

					//Added for SRR20056-CRF-0663	--Start
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
						sbMainSql.append( " and (( b.drug_yn='Y' AND ( b.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', b.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR (h.iv_prep_yn IN ('0', '2', '4', '6')) OR (b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR b.drug_yn='N' ) and ( (b.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR b.drug_yn='N') ");
					}
					else{
						sbMainSql.append( " AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) )") ;
					}
					//Added for SRR20056-CRF-0663	--End
					/*if(line_scope.equals("R"))//code  added for ML-BRU-SCF-0921[IN041388]
						sbMainSql.append( "AND TRUNC(G.NEXT_FILL_DATE) = TRUNC(SYSDATE)"); */ //code  added for ML-BRU-SCF-0921[IN041388] //Commented for SKR-SCF-0873 [IN044501]
					sbMainSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = h.ordering_facility_id and encounter_id = h.encounter_id) "); //added to filter only current Inpatient.

					if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" and b.DRUG_YN =? "); 
					sbMainSql.append("AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
					if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM desc ");
					else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM");

					if(drug_medical.equals("")){
						sbMainSql.append(" ,b.DRUG_YN desc");
					} 
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					position =1;
					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					if(getStockInstalled()){//stock_installed
						if(store_code==null)store_code="";
						pstmt.setString(++position,store_code);
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
					}
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,order_id);
					if(!getPhAltDispLocnYN().equals("Y"))
						pstmt.setString(++position,getDispLocnCode());//if added for ML-MMOH-SCF-0330.1[IN058994] due to alternat disp locn should come in performing disp locn after verification for IP
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
						pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
					}
					pstmt.setString(++position,this.exclude_PRN_orders);
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);
					pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
				}
				else if(disp_stage.equals("D")){
					// Delivery Stage//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
					sbMainSql.append("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE,B.IN_FORMULARY_YN, H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS, B.DRUG_DESC,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID,I.FORM_DESC,I.FORM_CODE, A.ORDER_QTY, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE, A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP,G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON, G.ALLERGY_OVERRIDE_REASON,G.DRUG_INDICATION, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, /*G.BMS_QTY-NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM),0) NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY) */ NVL(G.BMS_QTY,A.ORDER_QTY) BMS_QTY , A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, A.QTY_VALUE, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value , H.SOURCE_CODE,H.SOURCE_TYPE,H.ORDERING_FACILITY_ID, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,J.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn ,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS, g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING, g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE, g.DELIVERY_TASK_FINDING #,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A,OR_ORDER H, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE_LANG_VW G1,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE  H.ORDER_ID=A.ORDER_ID AND H.ORDER_CATEGORY='PH' AND A.ORDER_CATEGORY=H.ORDER_CATEGORY AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND G.TRADE_CODE = J.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_ID= ? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? ");//Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223]	//and exists (select 'Y' from ph_disp_dtl_tmp ddtl where ddtl.ORDER_ID=a.order_id and ddtl.disp_qty > 0  and not exists (select 'Y' from or_ordeR_line ol where ol.order_id = ddtl.order_id and ol.order_line_num = ddtl.order_line_no)) for BRU-SCF-274 and //code  ", m.FILL_REMARKS_CODE,m.FILL_TASK_FINDING,PH_DISP_DTL_TMP m and  and m.order_id = a.order_id  AND m.order_line_no = a.order_line_num AND added for ML-BRU-SCF-0971[IN042220] - changed from PH_DISP_DTL_TMP to or_order_line_ph // I.FORM_CODE Added for MMS-KH-CRF-0013
					sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
				
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbMainSql.append(" AND a.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]
					//CODE added for checking unallocated drugs....on 29/4/2004
					if(line_scope.equals("A")) {  // if condition Added for ML-MMOH-CRF-0434 [IN057356] - Start
						sbMainSql.append(" AND (G1.ORDER_STATUS_TYPE ='50' OR (G1.ORDER_STATUS_TYPE IN ('35','10','30')) OR (G1.ORDER_STATUS_TYPE = '35') )") ;	
					}  // if condition Added for ML-MMOH-CRF-0434 [IN057356] - End
					else if(line_scope.equals("H")) {
						sbMainSql.append(" AND G1.ORDER_STATUS_TYPE ='50'") ;// = Added instead of IN KAUH-SCF-0183[IN:047989]
					} 
					else if(unallocDrugs.equals("Y"))
						sbMainSql.append(" AND G1.ORDER_STATUS_TYPE IN ('35','10','30')") ;
					else
						sbMainSql.append(" AND G1.ORDER_STATUS_TYPE = '35'") ;// = Added instead of IN KAUH-SCF-0183[IN:047989]
					// append the line status 'OS' based on parameter

					//Added for SRR20056-CRF-0663	--Start
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
						sbMainSql.append(" and ((b.drug_yn='Y' AND ( b.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', b.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR (h.iv_prep_yn IN ('0', '2', '4', '6')) OR (b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR b.drug_yn='N') and ( (b.drug_yn='Y' AND ( ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR b.drug_yn='N') ");
					}
					else{
						sbMainSql.append( " AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')))") ;
					}
					//Added for SRR20056-CRF-0663	--End
					sbMainSql.append(" and exists (select 'X' from ip_open_encounter where facility_id = h.ordering_facility_id and encounter_id = h.encounter_id) "); //added to filter only current Inpatient.
						
					if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" and b.DRUG_YN =? "); 
					sbMainSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
					if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC ");
					else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM");

					if(drug_medical.equals("")){
						sbMainSql.append(" ,b.DRUG_YN desc");
					}
		
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					position =1;
					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					if(getStockInstalled()){//stock_installed
						if(store_code==null)store_code="";
						pstmt.setString(++position,store_code);
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
						pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905 
					}
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,order_id);
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
						pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
					}
					pstmt.setString(++position,this.exclude_PRN_orders);
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);
					pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
					pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
				}
			}
			else if(disp_locn_catg.equals("IAE")){	//added By Himanshu Saxena for MMS-DM-CRF-0232 on 10-10-23 Started //Inpatient And Emergncy Patient=================
				String patient_class=getTemp_patient_classl();
				if(patient_class.equals("IP")){
				if(disp_stage.equals("V")){
					// Verification Stage //,alergy_details,dosage_details,duplicate_details,INTARACTION_DETAILS added for MMS-KH-CRF-0028
					//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
					sbMainSql = new StringBuffer("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_getmindosedetails(B.drug_code,?) MINDOSEDETAILS ,Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE, B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS,B.DRUG_DESC, I.FORM_DESC,I.FORM_CODE,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_QTY, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, D.FREQ_DESC, decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, B.IN_FORMULARY_YN, /*NVL(ph_calculatebalance(a.order_id,a.order_line_num),A.ORDER_QTY)*/ NVL( G.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE, PH_DrugDoseInLimit(B.DRUG_CODE, ?, A.QTY_VALUE, A.DURN_VALUE, A.ORDER_QTY) DRUG_DOSAGE_LIMIT, DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value, H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,G.TRADE_CODE,J.LONG_NAME TRADE_NAME, H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON , (CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn ,l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON, l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN,g.SLIDING_SCALE_YN SLIDING_SCALE_YN, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM, b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS # ,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE, B.APPL_FOR_COMPOUNDING_RX_YN,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details,PATIENT_BROUGHT_MEDICATION_YN, ph_drug_expiry_alert (h.performing_deptloc_code,b.drug_code,b.drug_expiry_alert_days) expiry_alert, b.drug_expiry_alert_days FROM OR_ORDER_LINE A,OR_ORDER H, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, PH_GENERIC_NAME_LANG_VW F, OR_ORDER_STATUS_CODE_LANG_VW G1,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE H.ORDer_ID=A.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY=A.ORDER_CATEGORY AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND G.TRADE_CODE = J.TRADE_ID(+) AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND G1.ORDER_STATUS_TYPE IN ('10','25','56','50') AND A.ORDER_ID= ? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ?");   //and exists (select 'Y' from ph_disp_dtl_tmp ddtl where ddtl.ORDER_ID=a.order_id and ddtl.disp_qty > 0  and not exists (select 'Y' from or_ordeR_line ol where ol.order_id = ddtl.order_id and ol.order_line_num = ddtl.order_line_no)) for BRU-SCF-274//Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223]//Added 25 for ML-BRU-SCF-1338[IN049193] // I.FORM_CODE Added for MMS-KH-CRF-0013//Modify PH_CHECK_ORD_DATE_DISPENSING for COMMON-ICN-0116 [39681]

					sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
					if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
						sbMainSql.append(" AND a.end_date_time >= SYSDATE "); //Modified for ML-MMOH-SCF-0393 [IN:060238]

					//Added for SRR20056-CRF-0663	--Start
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){
						sbMainSql.append( " and ((b.drug_yn='Y' AND ( b.calc_dosg_by_freq_durn_yn = DECODE (?,'A', 'N','X', 'X','F', 'Y', b.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR (h.iv_prep_yn IN ('0', '2', '4', '6')) OR (b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N')) OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature IN (DECODE (?, 'N', 'P', 'X'))))) OR b.drug_yn='N' ) and ( (b.drug_yn='Y' AND (('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O')) OR b.generic_id IN (SELECT generic_id FROM ph_generic_name WHERE drug_class = 'N') OR EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X'))))) OR b.drug_yn='N') ");
					}
					else{
						sbMainSql.append(" AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')))") ;
					}
					//Added for SRR20056-CRF-0663	--End
					sbMainSql.append( " and exists (select 'X' from ip_open_encounter where facility_id = h.ordering_facility_id and encounter_id = h.encounter_id) "); //added to filter only current Inpatient.

					if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
						sbMainSql.append(" and b.DRUG_YN =? "); 
					sbMainSql.append(" AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
					if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC "); 
					else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
					sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM");

					if(drug_medical.equals("")){
						sbMainSql.append(" , b.DRUG_YN desc");
					}
					System.out.println("sbMainSql.toString()=======> 0 "+sbMainSql.toString());
					pstmt = connection.prepareStatement(sbMainSql.toString()) ;
					position = 1;
					pstmt.setString(position,getLanguageId());
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,patient_id);
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
					pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
					pstmt.setString(++position,patient_id);
					System.out.println("sbMainSql.toString()=======> store_code "+store_code);
					if(getStockInstalled()){//stock_installed
						if(store_code==null)store_code="";
							pstmt.setString(++position,store_code);
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
					}
					pstmt.setString(++position,login_facility_id);
					pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
					pstmt.setString(++position,order_id);
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,getLanguageId());
					pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
					if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")){ //added for SRR20056-CRF-0663
						pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
					}
					pstmt.setString(++position,this.exclude_PRN_orders);
					if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,this.drug_medical);
					pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
					pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
				    pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
				}	
				}else if(patient_class.equals("EM") || patient_class.equals("OP"))
				{
					// Outpatient
					if(disp_stage.equals("AS")){}
					else{	// Independent Stages ,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details added for mms-kh-crf-0028
						if(disp_stage.equals("V")&&getIssueTokenOnRegnYN().equals("N")&&disp_regn_reqd_yn.equals("N")){//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
							sbMainSql.append("SELECT H.PATIENT_ID, (SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE, (SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_Getmindosedetails(B.drug_code,?) MINDOSEDETAILS, (SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM ) ALLOC_QTY, Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value,B.DRUG_CODE,B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS,B.DRUG_DESC, I.FORM_DESC,I.FORM_CODE, ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_QTY,A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC,D.FREQ_DESC,decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE,A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP,G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON, G.ALLERGY_OVERRIDE_REASON,G.DRUG_INDICATION, G.DUPLICATE_DRUG_OVERRIDE_REASON,G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM,A.ORDER_LINE_STATUS,B.GENERIC_ID,/*nvl(ph_calculatebalance(a.order_id,a.order_line_num) ,A.ORDER_QTY)*/nvl( g.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE,Ph_Drugdoseinlimit(B.DRUG_CODE,?,A.QTY_VALUE, A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT,H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID ,J.LONG_NAME TRADE_NAME,G.TRADE_CODE, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON ,(CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn , B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn, l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN ,g.SLIDING_SCALE_YN SLIDING_SCALE_YN , G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM, b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN,G.BMS_INCLUDE_YN, l.ALT_DRUG_REMARKS, h.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE,null PATIENT_BROUGHT_MEDICATION_YN,B.APPL_FOR_COMPOUNDING_RX_YN #,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F, OR_ORDER H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J ,PH_DISP_LOCN k ,ph_patient_drug_profile l WHERE A.ORDER_ID = H.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY = A.ORDER_CATEGORY AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE AND A.DURN_TYPE=E.DURN_TYPE AND F.GENERIC_ID=B.GENERIC_ID AND G.TRADE_CODE = J.TRADE_ID(+) AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = D.LANGUAGE_ID AND B.LANGUAGE_ID = E.LANGUAGE_ID AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? AND H.PERFORMING_DEPTLOC_CODE = k.DISP_LOCN_CODE AND decode(k.DISP_VERF_STAGE,'F',B.VERIFICATION_REQD_YN,'B',B.VERIFICATION_REQD_YN,'X') = decode(k.DISP_VERF_STAGE,'F','Y','B','Y','X')"); // Added BMS_INCLUDE_YN for [IN:045295] // //Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013  
						}
						else{//ABUSE_EXISTS,ABUSE_DRUG_OVERRIDE_REASON added for aakh-crf-0140
							sbMainSql.append("SELECT H.PATIENT_ID,(SELECT max(worksheet_id) FROM ph_disp_hdr_tmp WHERE order_id=a.order_id ) WORKSHEET_ID, B.STRENGTH_VALUE, (SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GET_UOM_DISPLAY(?, B.STRENGTH_UOM, ?) STRENGTH_UOM_DISP, Ph_Getmindosedetails(B.drug_code,?) MINDOSEDETAILS, (SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM ) ALLOC_QTY, Ph_Isduplicatedrug(B.DRUG_CODE,?) ISDUPLICATE,DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value,B.DRUG_CODE,B.IN_FORMULARY_YN,H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, F.GENERIC_NAME, B.DRUG_CLASS,B.DRUG_DESC, I.FORM_DESC,I.FORM_CODE, ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_QTY,A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC,D.FREQ_DESC,decode(g.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE ,A.DURN_VALUE ACT_DURN, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE,A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, G.ABUSE_EXISTS,G.ABUSE_DRUG_OVERRIDE_REASON,G.DRUG_INDICATION,G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON,G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM,A.ORDER_LINE_STATUS,B.GENERIC_ID,/*nvl(ph_calculatebalance(a.order_id,a.order_line_num) ,A.ORDER_QTY)*/nvl( g.BMS_QTY,A.ORDER_QTY) BMS_QTY, A.ORDER_CATALOG_CODE,Ph_Drugdoseinlimit(B.DRUG_CODE,?,A.QTY_VALUE, A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT,H.SOURCE_CODE, H.SOURCE_TYPE, H.ORDERING_FACILITY_ID ,J.LONG_NAME TRADE_NAME,G.TRADE_CODE, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME,H.ORD_PRACT_ID PERFORMING_PRACT_ID,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON ,(CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn ,B.VERIFICATION_REQD_YN,b.ALLOW_MORETHAN_PRES_QTY_YN ,d.FREQ_NATURE FREQ_NATURE,b.drug_yn drug_yn, l.PRN_REMARKS,l.SLIDING_SCALE_REMARKS,g.VERIFY_REMARKS,l.DRUG_DB_PRODUCT_ID,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON,l.ALLERGY_OVERRIDE_REASON,l.DOSAGE_LIMIT_OVERRIDE_REASON,l.DUPLICATE_DRUG_OVERRIDE_REASON,l.INTERACTION_OVERRIDE_REASON,l.CONTRAIND_OVERRIDE_REASON,b.PT_COUN_REQD_YN DRUG_PT_COUN_REQD_YN,	g.PAT_COUNS_REQD_YN ord_PAT_COUNS_REQD_YN ,g.SLIDING_SCALE_YN SLIDING_SCALE_YN , G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM,b.BILLABLE_ITEM_YN BILLABLE_ITEM_YN, l.ALT_DRUG_REMARKS, g.ALLOCATE_REMARKS_CODE, g.ALLOCATE_TASK_FINDING, g.FILL_REMARKS_CODE, g.FILL_TASK_FINDING, g.DELIVERY_REMARKS_CODE, g.DELIVERY_TASK_FINDING, g.BMS_INCLUDE_YN , h.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.LAST_DISPENSED_DATE,null PATIENT_BROUGHT_MEDICATION_YN, B.APPL_FOR_COMPOUNDING_RX_YN #,print_value,G.alergy_details,G.dosage_details,G.duplicate_details,G.intaraction_details,PH_DRUG_EXPIRY_ALERT (H.PERFORMING_DEPTLOC_CODE,B.DRUG_CODE,B.DRUG_EXPIRY_ALERT_DAYS) EXPIRY_ALERT,B.DRUG_EXPIRY_ALERT_DAYS FROM OR_ORDER_LINE A, PH_DRUG_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F, OR_ORDER H,PH_FORM_LANG_VW I,AM_TRADE_NAME_LANG_VW J,ph_patient_drug_profile l WHERE A.ORDER_ID = H.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND H.ORDER_CATEGORY='PH' and a.order_id =l.orig_order_id AND a.order_line_num = l.orig_order_line_no AND H.ORDER_CATEGORY = A.ORDER_CATEGORY AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE AND A.DURN_TYPE=E.DURN_TYPE AND F.GENERIC_ID=B.GENERIC_ID AND G.TRADE_CODE = J.TRADE_ID(+) AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = D.LANGUAGE_ID AND B.LANGUAGE_ID = E.LANGUAGE_ID AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND J.LANGUAGE_ID(+) = ? "); //and exists (select 'Y' from ph_disp_dtl_tmp ddtl where ddtl.ORDER_ID=a.order_id and ddtl.disp_qty > 0  and not exists (select 'Y' from or_ordeR_line ol where ol.order_id = ddtl.order_id and ol.order_line_num = ddtl.order_line_no)) for BRU-SCF-274 AND //code " ,m.ALLOCATE_REMARKS_CODE, m.ALLOCATE_TASK_FINDING,m.FILL_REMARKS_CODE, m.FILL_TASK_FINDING, m.DELIVERY_REMARKS_CODE,m.DELIVERY_TASK_FINDING  and ,PH_DISP_DTL_TMP m and AND m.ORDER_ID(+) = A.ORDER_ID  AND m.ORDER_LINE_NO(+) = a.ORDER_LINE_NUM " added for  ML-BRU-SCF-0971[IN042220] - changed from PH_DISP_DTL_TMP to or_order_line_ph // //Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1[IN047223] // I.FORM_CODE Added for MMS-KH-CRF-0013
							//print_value added for GHL-CRF-453
						}
						if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
							sbMainSql.append(" AND a.end_date_time >= SYSDATE ");  //Modified for ML-MMOH-SCF-0393 [IN:060238]
						sbMainSql.append(sbDrugRelateSQL.toString());
						sbMainSql.append(sbStagesCondition.toString());
						sbMainSql.append(sbConstructSql.toString());

						sbMainSql = replaceStockQuery(sbMainSql,sql_stock_append);
						sbMainSql.append(	"AND ( b.calc_dosg_by_freq_durn_yn = decode(h.iv_prep_yn,'0', b.calc_dosg_by_freq_durn_yn,'2', b.calc_dosg_by_freq_durn_yn,'4', b.calc_dosg_by_freq_durn_yn,'6', b.calc_dosg_by_freq_durn_yn,'8', b.calc_dosg_by_freq_durn_yn,DECODE (?, 'Y', 'N', b.calc_dosg_by_freq_durn_yn)) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = a.freq_code AND freq_nature = 'O'))) ");
						if(!this.drug_medical.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
							sbMainSql.append(" and b.DRUG_YN =? "); 
						sbMainSql.append(" and EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = a.FREQ_CODE AND freq_nature not IN (decode(?,'Y','P','X')) ) AND ph_get_user_disp_rights(?,?");// Added parameters - KAUH-SCF-0183[IN:047989]
						if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
						    sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC ");
						else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
						sbMainSql.append(",H.PERFORMING_DEPTLOC_CODE,b.DRUG_CODE,b.DRUG_CLASS,?,?,?) = 'Y' ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM ");

						if(drug_medical.equals("")){
							sbMainSql.append(" , b.DRUG_YN desc");
						}
						//System.err.println("========OP ORDERLINTDTL======sbMainSql===>"+sbMainSql.toString());
						position = 1;
						pstmt = connection.prepareStatement(sbMainSql.toString()) ;

						pstmt.setString(position,getLanguageId());
						pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
						pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
						pstmt.setString(++position,patient_id);
						pstmt.setString(++position,patient_id);
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
						pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
						pstmt.setString(++position,patient_id);
						if(getStockInstalled()){//stock_installed
							if(store_code==null)store_code="";
							pstmt.setString(++position,store_code);
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
							pstmt.setString(++position,getStrChangedDispensePeriod());//added by Ganga for ML-BRU-SCF-0905
						}
						pstmt.setString(++position,login_facility_id);
						pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,getLanguageId());
						pstmt.setString(++position,order_id);
						pstmt.setString(++position,sFreqDurnAbsOrderFlag);	//exclude_drugs_by_freq_durn changed to sFreqDurnAbsOrderFlag for SRR20056-CRF-0663
						//if(this.sDisp_dflt_display_yn !=null && this.sDisp_dflt_display_yn.equals("Y")) //added for SRR20056-CRF-0663
							//pstmt.setString(++position,this.exclude_PRN_orders);		//added for SRR20056-CRF-0663
						if(!this.drug_medical.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
							pstmt.setString(++position,this.drug_medical);
						pstmt.setString(++position,this.exclude_PRN_orders);
						pstmt.setString(++position,login_facility_id);	// Added parameter - KAUH-SCF-0183[IN:047989] 
						pstmt.setString(++position,login_by_id);		// Added parameter - KAUH-SCF-0183[IN:047989]
						pstmt.setString(++position,getDispGenralDrug());//Added for Performance Issue by chandra 17072022
						pstmt.setString(++position,getDispNarcoDrug());//Added for Performance Issue by chandra 17072022
						pstmt.setString(++position,getDispControlDrug());//Added for Performance Issue by chandra 17072022
					}
				
				}
			}
			resultSet = pstmt.executeQuery() ;
			boolean isRows=false;
			String tmp					=	null;
			String calc_dosg_by_freq	=	null;
			String strength_per_value_pres_uom =null;
			String trade_name			="";
			String form_desc			="";
			String disc_cancelled_orders="", last_dispensed_date="";
			String approval_no = "";//AAKH-CRF-0117
			StringBuilder sb1		= new StringBuilder();
			while (resultSet.next()){
				isRows				= true;
				calc_dosg_by_freq	=	"";
				strength_per_value_pres_uom="";
				tmp					=	"";
				boolean firstTime	=	true;
				boolean found		=	false;
				boolean entered		=	false;
				trade_name			= "";
				sb1.append("'"+resultSet.getString("DRUG_CODE")+"',");				
				medplan_bean.getDosageDetails(resultSet.getString("DRUG_CODE"), resultSet.getString("DRUG_CODE"), order_id, resultSet.getString("ORDER_LINE_NUM"));
				result.add(checkForNull(resultSet.getString("ALLERGY_OVERRIDE_REASON"))); //0
				result.add(checkForNull(resultSet.getString("DOSAGE_LIMIT_OVERRIDE_REASON")));
				result.add(checkForNull(resultSet.getString("DUPLICATE_DRUG_OVERRIDE_REASON")));
				result.add(checkForNull(resultSet.getString("DRUG_CODE"))); //3
				trade_name=checkForNull(resultSet.getString("TRADE_NAME"));
				setForm_codes(order_id+checkForNull(resultSet.getString("ORDER_LINE_NUM"))+checkForNull(resultSet.getString("DRUG_CODE")), checkForNull(resultSet.getString("FORM_CODE"))); // Added for MMS-KH-CRF-0013
				setForm_descs(order_id+checkForNull(resultSet.getString("ORDER_LINE_NUM"))+checkForNull(resultSet.getString("DRUG_CODE")), checkForNull(resultSet.getString("FORM_DESC"))); // Added for MMS-KH-CRF-0013
				if(resultSet.getString("DRUG_YN").equals("N"))
					form_desc="";
				else
					form_desc = checkForNull(resultSet.getString("FORM_DESC"));

				if(!trade_name.equals("")){
					result.add(form_desc+" "+checkForNull(resultSet.getString("DRUG_DESC"))+" ("+trade_name+")"); //4
				}
				else{
					result.add(form_desc+" "+checkForNull(resultSet.getString("DRUG_DESC"))); //4
				}
				trade_codes.put(order_id+resultSet.getString("ORDER_LINE_NUM")+resultSet.getString("DRUG_CODE"),checkForNull(resultSet.getString("TRADE_code")));

				pstmt_1.setString(1,order_id);
				pstmt_1.setString(2,resultSet.getString("ORDER_LINE_NUM"));
			
				rset_1	=	pstmt_1.executeQuery();				
				pstmt_2.setString(1,checkForNull(resultSet.getString("DRUG_CODE")));
				pstmt_2.setString(2,getLanguageId());
				pstmt_2.setString(3,getLanguageId());
				pstmt_2.setString(4,getLanguageId());
				pstmt_2.setString(5,getLanguageId());
				pstmt_2.setString(6,getLanguageId());

				rset_2	=	pstmt_2.executeQuery();
				if(rset_2.next()){
					calc_dosg_by_freq	=	checkForNull(rset_2.getString("CALC_DOSG_BY_FREQ_DURN_YN"));
					strength_per_value_pres_uom =	checkForNull(rset_2.getString("STRENGTH_PER_VALUE_PRES_UOM"));
				}
				if(strength_per_value_pres_uom==null || strength_per_value_pres_uom.equals(""))
					strength_per_value_pres_uom="1";

				closeResultSet(rset_2);
				//added for mms-dm-crf-0209.1 start
				pstmt_4	= connection.prepareStatement("select CATEGORY_CODE,ALTERNATE_YN from mm_item m,PH_DRUG_VW_LANG_VW p where  m.item_code=p.DRUG_CODE and m.item_code=p.ITEM_CODE and p.drug_code=?");//added for mms-dm-crf-0209.1
				
				pstmt_4.setString(1,checkForNull(resultSet.getString("DRUG_CODE")));
		      System.out.println("drug_code"+checkForNull(resultSet.getString("DRUG_CODE")));
				category_code="";
				alternate_yn = "";
				rset_4	=	pstmt_4.executeQuery();	
				while (rset_4.next()) {
				category_code=checkForNull(rset_4.getString("CATEGORY_CODE"));
				alternate_yn = checkForNull(rset_4.getString("ALTERNATE_YN"));
				}
				closeResultSet(rset_4);
				//added for mms-dm-crf-0209.1 end
			//added for AAKH-CRF-0117 - start
				if(disp_stage.equals("D") && approval_no_flag){
					pstmt_3.setString(1,order_id);
					pstmt_3.setString(2,resultSet.getString("ORDER_LINE_NUM"));
					approval_no = "";
					rset_3	=	pstmt_3.executeQuery();	
					if(rset_3!=null && rset_3.next()){
						approval_no = rset_3.getString("APPROVAL_NO")==null?"":rset_3.getString("APPROVAL_NO");
					}
					setApprovalNo(order_id,resultSet.getString("ORDER_LINE_NUM"),approval_no);
					closeResultSet(rset_3);
				}
			//added for AAKH-CRF-0117 - end
				ArrayList tmpFillReasons = null;
				while(rset_1.next()){
					entered			=	true;
					divided		=	checkForNull(rset_1.getString("ORDER_LINE_DOSE_QTY_VALUE"));

					if(firstTime){
						tmp			=	divided;
						firstTime	=	false;
					} 
					else if(!tmp.equals(divided)) {
						found		=	true;
					}
				}
				closeResultSet(rset_1);
				if(!entered){
					if(resultSet.getString("SLIDING_SCALE_YN").equals("N")){

						result.add(checkForNull(resultSet.getString("QTY_VALUE"))+" "+getUomDisplay(login_facility_id,checkForNull(resultSet.getString("QTY_UNIT")))+" "+checkForNull(resultSet.getString("FREQ_DESC"))+" "+checkForNull(resultSet.getString("DURN_VALUE"))+" "+checkForNull(resultSet.getString("DURN_DESC")));
					}
					else{
						result.add("<label style='color:red'>(Sliding Scale) </label>"+" "+checkForNull(resultSet.getString("FREQ_DESC"))+" "+checkForNull(resultSet.getString("DURN_VALUE"))+" "+checkForNull(resultSet.getString("DURN_DESC")));
					}
				} 
				else{
					if(found){
						tmp_string	= "<label style='color:red'>(Divided) </label>";
						tmp_qty		= checkForNull(resultSet.getString("QTY_VALUE"));

					}
					else {
						tmp_string	= "";
						tmp_qty		= divided;
					}

					if(resultSet.getString("SLIDING_SCALE_YN").equals("N")){ 
						result.add(tmp_qty+" "+tmp_string+" "+getUomDisplay(login_facility_id,checkForNull(resultSet.getString("QTY_UNIT")))+" "+checkForNull(resultSet.getString("FREQ_DESC"))+" "+checkForNull(resultSet.getString("DURN_VALUE"))+" "+checkForNull(resultSet.getString("DURN_DESC")));
					}
					else{
						result.add("<label style='color:red'>(Sliding Scale) </label>"+" "+checkForNull(resultSet.getString("FREQ_DESC"))+" "+checkForNull(resultSet.getString("DURN_VALUE"))+" "+checkForNull(resultSet.getString("DURN_DESC")));
					}
				}
				setOrderQty(order_id+resultSet.getString("ORDER_LINE_NUM"),resultSet.getString("ORDER_QTY"));
				setDurationValue(order_id+resultSet.getString("ORDER_LINE_NUM"),resultSet.getString("ACT_DURN"));

				result.add(checkForNull(resultSet.getString("START_DATE_TIME"))); //index-6
				result.add(checkForNull(resultSet.getString("END_DATE_TIME")));
				result.add(checkForNull(resultSet.getString("PRES_QTY_VALUE")));
				result.add(checkForNull(resultSet.getString("PRES_QTY_UOM")));
				result.add(checkForNull(resultSet.getString("PRES_QTY_UOM_DISP"))); //10
				result.add(checkForNull(resultSet.getString("ORDER_LINE_NUM")));
				result.add(checkForNull(resultSet.getString("GENERIC_ID")));
				result.add(checkForNull(resultSet.getString("GENERIC_NAME")));
				result.add(checkForNull(resultSet.getString("DRUG_DOSAGE_LIMIT")));
				result.add(checkForNull(resultSet.getString("BMS_QTY"))); //15
				result.add(checkForNull(resultSet.getString("SOURCE_CODE")));
				result.add(checkForNull(resultSet.getString("SOURCE_TYPE")));
				result.add(checkForNull(resultSet.getString("ORDERING_FACILITY_ID")));
				result.add(checkForNull(resultSet.getString("ORD_DATE_TIME")));
				result.add(checkForNull(resultSet.getString("PERFORMING_PRACT_ID"))); //20
				//if condition is added for 24961
				if(resultSet.getString("DRUG_YN").equals("N"))
					result.add("N");
				else
					result.add(checkForNull(resultSet.getString("ISDUPLICATE")));

				result.add(checkForNull(resultSet.getString("MINDOSEDETAILS")));
				result.add(checkForNull(resultSet.getString("ALLOC_QTY")));
				result.add(checkForNull(resultSet.getString("STRENGTH_VALUE")));
				result.add(checkForNull(resultSet.getString("STRENGTH_UOM"))); //25
				result.add(checkForNull(resultSet.getString("STRENGTH_UOM_DISP"))); //26
				setSelectedPatientID(checkForNull(resultSet.getString("PATIENT_ID")));

				if(getStockInstalled()){//stock_installed
					result.add(checkForNull(resultSet.getString("STKAVAILABLE"))); //27
					if(objAllStages!=null)//added by Ganga for ML-BRU-SCF-0905 [IN:041285]	
						objAllStages.setStockItems(resultSet.getString("DRUG_CODE"),new ArrayList());
				}
				else
					result.add(""); //27
				result.add(checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));	//28
				
				setWorksheetID(checkForNull(resultSet.getString("WORKSHEET_ID")));

				result.add(checkForNull(resultSet.getString("IN_FORMULARY_YN"))); //29
				result.add(checkForNull(resultSet.getString("IV_PREP_YN"))); //30
				result.add(checkForNull(resultSet.getString("DRUG_CLASS")));	
				result.add(checkForNull(resultSet.getString("BL_INCL_EXCL_OVERRIDE_VALUE")));
				result.add(checkForNull(resultSet.getString("BL_INCL_EXCL_OVERRIDE_REASON")));	
				result.add(checkForNull(resultSet.getString("EXPIRED_YN")));
				result.add(checkForNull(resultSet.getString("VERIFICATION_REQD_YN"),"N")); //35
				result.add(resultSet.getString("ORDER_LINE_STATUS"));
				result.add(strength_per_value_pres_uom);
				result.add(checkForNull(resultSet.getString("FREQ_NATURE")));
				result.add(calc_dosg_by_freq);
				//added during PE By Naveen
				result.add(checkForNull(resultSet.getString("PRN_REMARKS"),"")); //40
				result.add(checkForNull(resultSet.getString("SLIDING_SCALE_REMARKS"),""));
				result.add(checkForNull(resultSet.getString("VERIFY_REMARKS"),""));
				result.add(checkForNull(resultSet.getString("DRUG_DB_PRODUCT_ID"),""));
				result.add(checkForNull(resultSet.getString("ALLERGY_OVERRIDE_REASON"),""));
				result.add(checkForNull(resultSet.getString("DOSAGE_LIMIT_OVERRIDE_REASON"),"")); //45
				result.add(checkForNull(resultSet.getString("DUPLICATE_DRUG_OVERRIDE_REASON"),""));
				result.add(checkForNull(resultSet.getString("INTERACTION_OVERRIDE_REASON"),""));
				result.add(checkForNull(resultSet.getString("CONTRAIND_OVERRIDE_REASON"),""));
				result.add(checkForNull(resultSet.getString("ORD_PAT_COUNS_REQD_YN"),"N"));	
				result.add(checkForNull(resultSet.getString("DRUG_PT_COUN_REQD_YN"),"N")); //50
				result.add(checkForNull(resultSet.getString("BILLABLE_ITEM_YN"),"N"));
				result.add(checkForNull(resultSet.getString("DISCHARGE_IND"),"N"));
				if(disp_locn_catg.equals("O")){
					result.add(checkForNull(resultSet.getString("BMS_INCLUDE_YN"),"N"));}	// Added for [IN:045295] 
				else if(disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE"))
					result.add("");	
				//GHL-CRF-0453 - start					
				if(disp_stage.equals("A") || (disp_stage.equals("F") && !fill_list.equals("AF"))){
				setPrintValue(order_id,resultSet.getString("ORDER_LINE_NUM"),checkForNull(resultSet.getString("PRINT_VALUE")));	System.err.println("DispMedicationBean.java=12843===PRINT_VALUE==>"+checkForNull(resultSet.getString("PRINT_VALUE")));
				}
				//GHL-CRF-0453 - end				
				result.add(resultSet.getString("HOME_LEAVE_MEDN_YN"));//Added for Bru-HIMS-CRF-093-DD1 [IN047223]
				result.add(checkForNull(resultSet.getString("DRUG_DESC"))); //Added for Bru-HIMS-CRF-414 ML-BRU-SCF-1454 [IN:052271]
				last_dispensed_date = checkForNull(resultSet.getString("LAST_DISPENSED_DATE")); //Added for HSA-CRF-0138 [IN:048414]- start
				disc_cancelled_orders = "";
				if(last_dispensed_date.equals(""))
					disc_cancelled_orders = checkForNull(resultSet.getString("DISC_CANCELLED_ORDERS"));
				result.add(disc_cancelled_orders); //Added for HSA-CRF-0138 [IN:048414] -End
				result.add(checkForNull(resultSet.getString("APPL_FOR_COMPOUNDING_RX_YN")));//Added for Bru-HIMS-CRF-080

				/*result.add(checkForNull(resultSet.getString("TAPERED_YN"),"N"));  Commented for RUT-CRF-0088 [IN036978] 7->6
				result.add(checkForNull(resultSet.getString("TAPER_ORDER_ID"),""));
				result.add(checkForNull(resultSet.getString("TAPER_ORDER_LINE_NUM"),"N")); //55 //ends here  */  //Commented for RUT-CRF-0088 [IN036978]
				if(disp_stage.equals("V")){//added for IN070605 start
				result.add(checkForNull(resultSet.getString("ALERGY_DETAILS")));//ADDED FOR MMS-KH-CRF-0028
				result.add(checkForNull(resultSet.getString("DOSAGE_DETAILS")));//ADDED FOR MMS-KH-CRF-0028
				result.add(checkForNull(resultSet.getString("DUPLICATE_DETAILS")));//ADDED FOR MMS-KH-CRF-0028
				result.add(checkForNull(resultSet.getString("INTARACTION_DETAILS")));//ADDED FOR MMS-KH-CRF-0028
				
			}result.add(checkForNull(resultSet.getString("ABUSE_DRUG_OVERRIDE_REASON"))); //aakh-crf-0140
			result.add(checkForNull(resultSet.getString("ABUSE_EXISTS"))); //aakh-crf-0140
			result.add(checkForNull(resultSet.getString("DRUG_INDICATION")));//jd-crf-0220
			//System.err.println("disp_stage@@@==="+disp_stage+"disp_locn_catg@@@===="+disp_locn_catg+"PATIENT_BROUGHT_MEDICATION_YN=="+resultSet.getString("PATIENT_BROUGHT_MEDICATION_YN"));
			if(disp_stage.equals("V") && (disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE")))//Added for TH-KW-CRF-0002
			 result.add(checkForNull(resultSet.getString("PATIENT_BROUGHT_MEDICATION_YN")));//Added for TH-KW-CRF-0002
			//added for IN070605 end
              result.add(checkForNull(resultSet.getString("EXPIRY_ALERT")));//Added for TH-KW-CRF-0008
		      result.add(checkForNull(resultSet.getString("DRUG_EXPIRY_ALERT_DAYS")));//Added for TH-KW-CRF-0008
          result.add(category_code);//added for mms-dm-crf-0209.1
			result.add(alternate_yn);//added for mms-dm-crf-0209.1
				hmAllowMoreQty.put(checkForNull(resultSet.getString("DRUG_CODE")),checkForNull(resultSet.getString("ALLOW_MORETHAN_PRES_QTY_YN"),"N"));

                if(hmAltDrugRemarks!=null && !hmAltDrugRemarks.containsKey(order_id+"~"+resultSet.getString("ORDER_LINE_NUM")) && objAllStages!=null)
					objAllStages.setAltDrugRemarks(order_id+"~"+resultSet.getString("ORDER_LINE_NUM"), checkForNull(resultSet.getString("ALT_DRUG_REMARKS")));// Added For Bru-HIMS-CRF-082 [IN:029948]-end
				
				 if(!disp_stage.equals("V") ){  //code added for ML-BRU-SCF-0971[IN042220] -Start
					tmpFillReasons = new ArrayList();		
					if(disp_stage.equals("D") ){//added for ml-mmoh-scf-1008
					if(fill_reason_code.equals("") && resultSet.getString("DELIVERY_REMARKS_CODE") !=null )
						fill_reason_code = resultSet.getString("DELIVERY_REMARKS_CODE") ;
				     }
					if(disp_stage.equals("F")){//added for ml-mmoh-scf-1008
					 if( fill_reason_code.equals("") &&  resultSet.getString("FILL_REMARKS_CODE") !=null )
						fill_reason_code = resultSet.getString("FILL_REMARKS_CODE") ; 
					}
					if(disp_stage.equals("A")|| disp_stage.equals("AS")){//added for ml-mmoh-scf-1008
					 if(fill_reason_code.equals("") &&  fill_reason_code.equals("") && resultSet.getString("ALLOCATE_REMARKS_CODE") !=null )
						fill_reason_code = resultSet.getString("ALLOCATE_REMARKS_CODE") ;
					}
					if(disp_stage.equals("D")){//added for ml-mmoh-scf-1008
					if(fill_reason.equals("") &&  resultSet.getString("DELIVERY_TASK_FINDING") !=null )
						fill_reason = resultSet.getString("DELIVERY_TASK_FINDING") ;  
					 }
					if(disp_stage.equals("F")){//added for ml-mmoh-scf-1008
					if(fill_reason.equals("") && resultSet.getString("FILL_TASK_FINDING") !=null )
						fill_reason = resultSet.getString("FILL_TASK_FINDING") ;
					 }
					if(disp_stage.equals("A") || disp_stage.equals("AS")){//added for ml-mmoh-scf-1008
					 if(fill_reason.equals("") &&  resultSet.getString("ALLOCATE_TASK_FINDING") !=null )
						fill_reason = resultSet.getString("ALLOCATE_TASK_FINDING") ;
	}
					tmpFillReasons.add(fill_reason_code);
					tmpFillReasons.add(fill_reason );		
                    fill_reason_code ="";					
                    fill_reason ="";		  		 
					hmFillReasons.put(order_id+"_"+resultSet.getString("ORDER_LINE_NUM"), tmpFillReasons); //code added for ML-BRU-SCF-0971[IN042220]-- End	
				 }						
				 if((disp_stage.equals("F") && fill_list.equals("WF")) && isSite_ph_new_prescription && disp_locn_catg.equals("I"))//Added for GHL-CRF-0672.1 By Himanshu
					{
					 	result.add(resultSet.getString("is_picklist_date_today"));
					}
			}
			if(disp_locn_catg.equals("O") && sb1.length()>3)//Added for Bru-HIMS-CRF-072.1[IN 049144]  AniT R
				medplan_bean.getPrescribeDrugDetails(sb1);
			closeStatement(pstmt);
			closeResultSet(resultSet);
			if(!isRows){
				//sql_str = PhRepository.getPhKeyValue("SQL_PH_TPN_DISP_MEDICATION_SELECT1");
				sbMainSql = new StringBuffer("SELECT /*+ INDEX(OR_ORDER_LINE IN_OR_ORDER_LINE) */ H.PATIENT_ID, A.QTY_VALUE ,B.ITEM_CODE, b.tpn_regimen_code drug_CODE, '' STRENGTH_VALUE, '' STRENGTH_UOM, '' STRENGTH_UOM_DISP,'' GENERIC_NAME, (SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM ) ALLOC_QTY, A.CATALOG_DESC drug_deSC, A.ORDER_QTY, '' ISDUPLICATE, A.QTY_UNIT,C.SHORT_DESC QTY_UNIT_DESC,D.FREQ_DESC,A.DURN_VALUE, E.DURN_DESC,TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY HH24:MI') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY HH24:MI') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE,A.ORDER_UOM PRES_QTY_UOM, PH_GET_UOM_DISPLAY(?, A.ORDER_UOM, ?) PRES_QTY_UOM_DISP, H.IV_PREP_YN, decode(H.DISCHARGE_IND,'D','Y','N') DISCHARGE_IND, B.DRUG_CLASS, G.ALLERGY_OVERRIDE_REASON,G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON,G.ORDER_LINE_NUM,A.ORDER_LINE_STATUS, '' GENERIC_ID, g.bms_qty BMS_QTY, A.ORDER_CATALOG_CODE, '' DRUG_DOSAGE_LIMIT,H.SOURCE_CODE, H.SOURCE_TYPE,H.ORDERING_FACILITY_ID, '' EXTERNAL_PRODUCT_ID, TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME, H.ORD_PRACT_ID PERFORMING_PRACT_ID, '' MINDOSEDETAILS ,'' STKAVAILABLE ,G.BL_INCL_EXCL_OVERRIDE_VALUE, G.BL_INCL_EXCL_OVERRIDE_REASON,(CASE WHEN TRUNC(A.END_DATE_TIME)<TRUNC(SYSDATE) THEN 'Y' ELSE 'N' END)expired_yn ,g.VERIFY_REMARKS, G.TAPERED_YN, G.TAPER_ORDER_ID, G.TAPER_ORDER_LINE_NUM, l.ALT_DRUG_REMARKS,H.HOME_LEAVE_MEDN_YN, G.DISC_CANCELLED_ORDERS, G.DRUG_INDICATION,PATIENT_BROUGHT_MEDICATION_YN,G.LAST_DISPENSED_DATE,PRINT_VALUE,l.ABUSE_EXISTS,l.ABUSE_DRUG_OVERRIDE_REASON FROM OR_ORDER_LINE A, PH_TPN_REGIMEN_LANG_VW B, OR_ORDER_LINE_PH G, AM_UOM_LANG_VW C, AM_FREQUENCY_LANG_VW D, AM_DURATION_TYPE_LANG_VW E, OR_ORDER H, ph_patient_drug_profile l WHERE A.ORDER_ID= H.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM And g.order_id = l.orig_order_id AND g.order_line_num = l.ORIG_ORDER_LINE_NO AND A.ORDER_CATALOG_CODE=B.tpn_REGIMEN_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND (A.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('10','25','50','56','30','35','36')) OR ( A.ORDER_QTY> NVL((SELECT SUM(DISP_QTY) FROM PH_DISP_DTL_TMP M WHERE M.ORDER_LINE_NO= A.ORDER_LINE_NUM AND M.ORDER_ID=A.ORDER_ID),0) )) ");//Added HOME_LEAVE_MEDN_YN for Bru-HIMS-CRF-093-DD1 [IN047223]
				if(!order_id.equals(""))// if Added, Removed NVL - KAUH-SCF-0183[IN:047989]
					sbMainSql.append(" AND A.ORDER_ID = ? "); 
				if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]
				    sbMainSql.append(" AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ?	ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM DESC ");
				else // if else block added for ML-MMOH-CRF-0435 [IN:057357]
				sbMainSql.append(" AND Ph_Check_Ord_Date_Dispensing(A.START_DATE_TIME,A.END_DATE_TIME,?,?,?,?,?)=1 AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ?	ORDER BY G.ORDER_ID,G.ORDER_LINE_NUM ");
				position=0;
				//PRINT_VALUE added for GHL-SCF-1268
				pstmt = connection.prepareStatement(sbMainSql.toString()) ;
				pstmt.setString(++position,login_facility_id); //added to get UOM desc PT
				pstmt.setString(++position,getLanguageId());	//added to get UOM desc PT
				if(!order_id.equals(""))// if Added - KAUH-SCF-0183[IN:047989]
					pstmt.setString(++position,order_id);
				pstmt.setString(++position,login_facility_id);
				pstmt.setString(++position,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
				pstmt.setString(++position,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
				pstmt.setString(++position,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
				pstmt.setString(++position,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
				pstmt.setString(++position,getLanguageId());
				pstmt.setString(++position,getLanguageId());
				pstmt.setString(++position,getLanguageId());
				pstmt.setString(++position,getLanguageId());
				//pstmt.setString(9,getLanguageId());
				//pstmt.setString(10,getLanguageId());

				resultSet = pstmt.executeQuery() ;
				
				while (resultSet.next()) {
					result.add(checkForNull(resultSet.getString("ALLERGY_OVERRIDE_REASON")));
					result.add(checkForNull(resultSet.getString("DOSAGE_LIMIT_OVERRIDE_REASON")));
					result.add(checkForNull(resultSet.getString("DUPLICATE_DRUG_OVERRIDE_REASON")));
					result.add(checkForNull(resultSet.getString("DRUG_CODE")));
					result.add(checkForNull(resultSet.getString("DRUG_DESC")));
					//for checking divided dose
					pstmt_1.setString(1,order_id);
					pstmt_1.setString(2,resultSet.getString("ORDER_LINE_NUM"));
					rset_1	=	pstmt_1.executeQuery();
				//	System.out.println("@@@ 3 rset ="+rset_1);
					
					pstmt_2.setString(1,checkForNull(resultSet.getString("DRUG_CODE")));
					pstmt_2.setString(2,getLanguageId());
					pstmt_2.setString(3,getLanguageId());
					pstmt_2.setString(4,getLanguageId());
					pstmt_2.setString(5,getLanguageId());
					pstmt_2.setString(6,getLanguageId());
					rset_2	=	pstmt_2.executeQuery();
					//added for mms-dm-crf-0209.1 start
					pstmt_4	= connection.prepareStatement("select CATEGORY_CODE,ALTERNATE_YN from mm_item m,PH_DRUG_VW_LANG_VW p where  m.item_code=p.DRUG_CODE and m.item_code=p.ITEM_CODE and p.drug_code=?");//added for mms-dm-crf-0209.1
					
					pstmt_4.setString(1,checkForNull(resultSet.getString("DRUG_CODE")));
			        category_code="";
					alternate_yn = "";
					rset_4	=	pstmt_4.executeQuery();	
					closeResultSet(rset_4);
					//added for mms-dm-crf-0209.1 end
					//System.out.println("@@@ 4 rset_2 ="+rset_2);
					if(rset_2.next()){
						calc_dosg_by_freq	=	checkForNull(rset_2.getString("CALC_DOSG_BY_FREQ_DURN_YN"));
					}
					closeResultSet(rset_2);

					tmp			=	"";
					boolean firstTime	=	true;
					boolean found		=	false;
					boolean entered		=	false;
					while(rset_1.next()) {
						entered			=	true;
						divided		=	checkForNull(rset_1.getString("ORDER_LINE_DOSE_QTY_VALUE"));
						if(firstTime) {
							tmp			=	divided;
							firstTime	=	false;
						} 
						else if(!tmp.equals(divided)) {
							found		=	true;
							//break;
						}
					}
					closeResultSet(rset_1);
					if(!entered) {

						result.add(checkForNull(resultSet.getString("QTY_VALUE"))+" "+getUomDisplay(login_facility_id,checkForNull(resultSet.getString("QTY_UNIT")))+" "+checkForNull(resultSet.getString("FREQ_DESC"))+" "+checkForNull(resultSet.getString("DURN_VALUE"))+" "+checkForNull(resultSet.getString("DURN_DESC")));
					} 
					else {
						if(found) { 
							tmp_string	= "<label style='color:red'>(Divided) </label>";
							tmp_qty		= checkForNull(resultSet.getString("QTY_VALUE"));
						}
						else {
							tmp_string	= "";
							tmp_qty		= divided;
						}

						result.add(tmp_qty+" "+tmp_string+" "+getUomDisplay(login_facility_id,checkForNull(resultSet.getString("QTY_UNIT")))+" "+checkForNull(resultSet.getString("FREQ_DESC"))+" "+checkForNull(resultSet.getString("DURN_VALUE"))+" "+checkForNull(resultSet.getString("DURN_DESC")));
					}
					setOrderQty(order_id+resultSet.getString("ORDER_LINE_NUM"),resultSet.getString("ORDER_QTY"));
					setDurationValue(order_id+resultSet.getString("ORDER_LINE_NUM"),resultSet.getString("DURN_VALUE"));

					result.add(checkForNull(resultSet.getString("START_DATE_TIME")));
					result.add(checkForNull(resultSet.getString("END_DATE_TIME")));
					result.add(checkForNull(resultSet.getString("PRES_QTY_VALUE")));
					result.add(checkForNull(resultSet.getString("PRES_QTY_UOM")));
					result.add(checkForNull(resultSet.getString("PRES_QTY_UOM_DISP")));
					result.add(checkForNull(resultSet.getString("ORDER_LINE_NUM")));
					result.add(checkForNull(resultSet.getString("GENERIC_ID")));
					result.add(checkForNull(resultSet.getString("GENERIC_NAME")));
					result.add(checkForNull(resultSet.getString("DRUG_DOSAGE_LIMIT")));
					result.add(checkForNull(resultSet.getString("BMS_QTY")));
					result.add(checkForNull(resultSet.getString("SOURCE_CODE")));
					result.add(checkForNull(resultSet.getString("SOURCE_TYPE")));
					result.add(checkForNull(resultSet.getString("ORDERING_FACILITY_ID")));
					result.add(checkForNull(resultSet.getString("ORD_DATE_TIME")));
					result.add(checkForNull(resultSet.getString("PERFORMING_PRACT_ID")));
					result.add(checkForNull(resultSet.getString("ISDUPLICATE")));
					result.add(checkForNull(resultSet.getString("MINDOSEDETAILS")));
					result.add(checkForNull(resultSet.getString("ALLOC_QTY")));
					result.add(checkForNull(resultSet.getString("STRENGTH_VALUE")));
					result.add(checkForNull(resultSet.getString("STRENGTH_UOM")));
					result.add(checkForNull(resultSet.getString("STRENGTH_UOM_DISP")));

					setSelectedPatientID(checkForNull(resultSet.getString("PATIENT_ID")));
					if(getStockInstalled()){//stock_installed
						result.add(checkForNull(resultSet.getString("STKAVAILABLE")));
					}
					else
						result.add("");
					//if(disp_stage.equals("V") || disp_stage.equals("AS")){
						//result.add(checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));
					//}
					result.add("");
					//code added to get IN_FORMULARY_YN from ph_drug....added on 26/4/2004
					result.add("Y");
					result.add(checkForNull(resultSet.getString("IV_PREP_YN")));
					result.add(checkForNull(resultSet.getString("DRUG_CLASS")));	
					result.add(checkForNull(resultSet.getString("BL_INCL_EXCL_OVERRIDE_VALUE")));
					result.add(checkForNull(resultSet.getString("BL_INCL_EXCL_OVERRIDE_REASON")));	
					result.add(checkForNull(resultSet.getString("EXPIRED_YN")));
					result.add("N");
					result.add(resultSet.getString("ORDER_LINE_STATUS"));
					result.add("");
					result.add("");
					result.add("");
					//added during PE By Naveen
					result.add("");
					result.add("");
					result.add(checkForNull(resultSet.getString("VERIFY_REMARKS"),""));
					result.add("");
					result.add("");
					result.add("");
					result.add("");
					result.add("");
					result.add("");
					result.add("");	
					result.add("");
					result.add("");
					result.add(checkForNull(resultSet.getString("DISCHARGE_IND"),"N"));
					result.add("N");// Added for [IN:045295]  
					result.add(checkForNull(resultSet.getString("HOME_LEAVE_MEDN_YN")));//Added for Bru-HIMS-CRF-093-DD1 [IN047223]
					result.add(checkForNull(resultSet.getString("DRUG_DESC")));//Added for Bru-HIMS-CRF-414 ML-BRU-SCF-1454 [IN:052271]
					last_dispensed_date = checkForNull(resultSet.getString("LAST_DISPENSED_DATE")); //Added for HSA-CRF-0138 [IN:048414]- start
					disc_cancelled_orders = "";
					if(last_dispensed_date.equals(""))
						disc_cancelled_orders = checkForNull(resultSet.getString("DISC_CANCELLED_ORDERS"));
					result.add(disc_cancelled_orders); //Added for HSA-CRF-0138 [IN:048414] -End
					result.add("");// APPL_FOR_COMPOUNDING_RX_YN Added for Bru-HIMS-CRF-080
					if(disp_stage.equals("V")){//added for ml-mmoh-scf-1304 start
						result.add("");
						result.add("");
						result.add("");
						result.add("");
					}//added for ml-mmoh-scf-1304 end
					result.add(checkForNull(resultSet.getString("ABUSE_DRUG_OVERRIDE_REASON"))); //aakh-crf-0140
					result.add(checkForNull(resultSet.getString("ABUSE_EXISTS"))); //aakh-crf-0140
					result.add(checkForNull(resultSet.getString("DRUG_INDICATION")));//jd-crf-0220
					/*result.add(checkForNull(resultSet.getString("TAPERED_YN"),"N")); // Commented for RUT-CRF-0088 [IN036978]
					result.add(checkForNull(resultSet.getString("TAPER_ORDER_ID"),""));
					result.add(checkForNull(resultSet.getString("TAPER_ORDER_LINE_NUM"),""));*/
					if(disp_stage.equals("V") && (disp_locn_catg.equals("I") || disp_locn_catg.equals("IAE")))//Added for TH-KW-CRF-0002
						 result.add(checkForNull(resultSet.getString("PATIENT_BROUGHT_MEDICATION_YN")));//Added for ml-mmoh-scf-2227
						//added for IN070605 end
			              result.add("");//Added for ml-mmoh-scf-2227
					      result.add("");//Added for ml-mmoh-scf-2227
			          result.add(category_code);//added for mms-dm-crf-0209.1
						result.add(alternate_yn);//added for mms-dm-crf-0209.1hmAllowMoreQty.put(checkForNull(resultSet.getString("DRUG_CODE")),"N"); 
					
					hmAllowMoreQty.put(checkForNull(resultSet.getString("DRUG_CODE")),"N"); 
					if(hmAltDrugRemarks.containsKey(order_id+"~"+resultSet.getString("ORDER_LINE_NUM")))
						objAllStages.setAltDrugRemarks(order_id+"~"+resultSet.getString("ORDER_LINE_NUM") ,checkForNull(resultSet.getString("ALT_DRUG_REMARKS")));// Added For Bru-HIMS-CRF-082 [IN:029948]-end
					//ended...
				//added for GHL-SCF-1268
					if(disp_stage.equals("A") || (disp_stage.equals("F") && !fill_list.equals("AF"))){
					setPrintValue(order_id,resultSet.getString("ORDER_LINE_NUM"),checkForNull(resultSet.getString("PRINT_VALUE")));	System.err.println("DispMedicationBean.java=13175===PRINT_VALUE==>"+checkForNull(resultSet.getString("PRINT_VALUE")));
				}
				}
			}
		}
		catch ( Exception e ) {
			System.err.println( "Error loading getOrderLineDetails sbMainSql = "+sbMainSql+ " result=" +result) ;
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeResultSet( rset_1);
				closeStatement(pstmt_1);
				closeResultSet( rset_2);
			    closeResultSet( rset_3); //AAKH-CRF-0117
				closeStatement(pstmt_3);//AAKH-CRF-0117
				closeStatement(pstmt_4);//added for mms-dm-crf-0209.1
				closeStatement(pstmt_2);
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace() ;
			}
		}
		return result;
	}

	private String checkNullResult(String inputString, String defaultValue) {
		return (inputString==null) ? defaultValue : inputString;
	}

	public String getOrderComments(String order_id) throws Exception{
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		String order_comment = "";
		try{
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT24") ) ;
			pstmt.setString(1,order_id);
			resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				order_comment	=	resultSet.getString("ORDER_COMMENT");
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}
		return order_comment;
	}

	public void setTodaysDate(){
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try{
			connection	= getConnection() ;
			// pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT25") ) ;
			pstmt		=connection.prepareStatement("SELECT TO_CHAR(SYSDATE,'DD/MM/YYYY') TODAY,TO_CHAR(SYSDATE,'DD/MM/YYYY hh24:mi') TODAY_DATE_TIME,TO_CHAR(SYSDATE+365,'DD/MM/YYYY') DATE_PLUS_365 , TO_CHAR(SYSDATE+30,'DD/MM/YYYY') DATE_PLUS_30, TO_CHAR(SYSDATE-30,'DD/MM/YYYY') DATE_minus_30 FROM DUAL");
			resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				this.today_date			=	resultSet.getString("TODAY");
				this.today_date_time	= resultSet.getString("TODAY_DATE_TIME");
				this.date_plus_365		= resultSet.getString("DATE_PLUS_365");
				this.date_plus_30		= resultSet.getString("DATE_PLUS_30");
				this.date_minus_30		= resultSet.getString("DATE_minus_30");
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}
	}

	public boolean validateThePassword()throws Exception{
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try{
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT27") ) ;
			pstmt.setString(1,login_by_id.trim());
			resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				if((resultSet.getString("PASSWORD")).equals(getPassword().trim())){
					return true;
				}
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}
		return false;
	}

	public ArrayList getCollectorDetails(String patient_id,String sort_records_by){
		ArrayList collectorDetails = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		ArrayList arrList = new ArrayList();//Added for HSA-CRF-0136 [IN:048412]
	//	String token_no=""; Removed for IN063877
		String append="";
		try{
			if(sort_records_by.equals("Order"))	{		
				//token_no=getTokenDetails(getDispLocnCode().trim(),patient_id.trim(),getTokenSeriesCode().trim(),getOrderID()); //commented for HSA-CRF-0136 [IN:048412] 
				//setTokenNo(token_no);//commented for for HSA-CRF-0136 [IN:048412] 
				arrList=getTokenDetails(getDispLocnCode().trim(),patient_id.trim(),getTokenSeriesCode().trim(),getOrderID());//Changed for HSA-CRF-0136 [IN:048412]
				if(arrList!=null && arrList.size()>0)//Added for HSA-CRF-0136 [IN:048412]
					setTokenNo((String)arrList.get(1));//Changed for HSA-CRF-0136 [IN:048412]
				append=" AND C.TOKEN_SERIAL_NO =? ";
			}
			else if(sort_records_by.equals("Patient")){
				append=" and ROWNUM =1 ";
			}

			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT29")+append ) ;

			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,getDispLocnCode().trim());
			pstmt.setString(3,this.queue_date);	
			pstmt.setString(4,getTokenSeriesCode().trim());			
			pstmt.setString(5,patient_id.trim());
			pstmt.setString(6,getLanguageId());

			if(sort_records_by.equals("Order"))	{	
				pstmt.setString(7,getTokenNo().trim());
			}

			resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				collectorDetails.add(resultSet.getString("TOKEN_SERIES_CODE"));
				collectorDetails.add(resultSet.getString("TOKEN_SERIAL_NO"));
				collectorDetails.add(resultSet.getString("COLLECTOR_NAME"));
				collectorDetails.add(resultSet.getString("COLLECTOR_NATIONALITY"));
				collectorDetails.add(resultSet.getString("COLLECTOR_GENDER"));
				token_series_description=resultSet.getString("DESCRIPTION");
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}
		return collectorDetails;
	}

	/*
		This function is used to get the Country Code and Description
	*/
	public ArrayList getNationalityDetails()throws Exception{
		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT30") ) ;
			pstmt.setString(1,getLanguageId());

			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("COUNTRY_CODE"));
				result.add(resultSet.getString("SHORT_DESC"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}
/*
	public String checkDeliveryApplicability()throws Exception{
		String result="";
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT34") ) ;
			pstmt.setString(1,getDispLocnCode());
			pstmt.setString(2,login_facility_id.trim());
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				if(getDispLocnCatg().equals("I")) {
					result = resultSet.getString("IP_DELV_REQD_YN");
				} else {
					result = resultSet.getString("DISP_DELV_REQD_YN");					
				}
			}
		}
			catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		setDeliveryApplicable(result);
		return result;
	}
*/
	public void checkForStockInstallation()throws Exception{
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT40") ) ;
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				if(resultSet.getInt("COUNT")==0){
					//stock_installed = false;
					setStockInstalled(false);
				}else{
					setStockInstalled(true);
					//stock_installed = true;
				}
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
	}

	public String getStoreDesc(String store_code) throws Exception {
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String store_desc		=	"";
		try {

			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT39")) ;
			pstmt.setString(1,store_code);
			pstmt.setString(2,login_facility_id);
			pstmt.setString(3,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				store_desc		=	resultSet.getString("STORE_DESC");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return store_desc;
	}


	public String getDrugForm(String drug_code) throws Exception {

		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String result="";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT42")) ;
			pstmt.setString(1,drug_code);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result = resultSet.getString("PHYSICAL_FORM");
			}

		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return result;
	}

	public Hashtable getLegendsFromParam()throws Exception{
		Hashtable param_legends = new Hashtable();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
		// pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT35") ) ;

			pstmt = connection.prepareStatement( "SELECT InitCap(REGN_STAGE_PROMPT) REGN_STAGE_PROMPT, InitCap(VERIFY_STAGE_PROMPT) VERIFY_STAGE_PROMPT, InitCap(FILL_STAGE_PROMPT) FILL_STAGE_PROMPT, InitCap(ALLOCATE_STAGE_PROMPT) ALLOCATE_STAGE_PROMPT, InitCap(BILL_RECEIPT_STAGE_PROMPT) BILL_RECEIPT_STAGE_PROMPT, InitCap(DELIVER_STAGE_PROMPT) DELIVER_STAGE_PROMPT,iSSUE_UOM_BY FROM PH_PARAM_LANG_VW PH_PARAM WHERE MODULE_ID='PH' AND LANGUAGE_ID = ?");
			pstmt.setString(1,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				param_legends.put("V",resultSet.getString("VERIFY_STAGE_PROMPT"));
				param_legends.put("A",resultSet.getString("ALLOCATE_STAGE_PROMPT"));
				param_legends.put("F",resultSet.getString("FILL_STAGE_PROMPT"));
				param_legends.put("B",resultSet.getString("BILL_RECEIPT_STAGE_PROMPT"));
				param_legends.put("D",resultSet.getString("DELIVER_STAGE_PROMPT"));
				this.issue_by_uom	=	resultSet.getString("iSSUE_UOM_BY");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return param_legends;
	}

	public StringBuffer replaceStockQuery(StringBuffer sb,String sql_stock_append) throws Exception{
		//check stock status
		if(getStockInstalled()){//stock_installed
			int index = sb.indexOf("#");
			//StringBuffer sb = new StringBuffer(sql_str);
			sb.replace(index,index+1,sql_stock_append);
			//sql_str = sb.toString();
		}
		else{
			int index = sb.indexOf("#");
			//StringBuffer sb = new StringBuffer(sql_str);
			sb.replace(index,index+1," ");
			//sql_str = sb.toString();
		}
		return sb;
	}

	public StringBuffer replaceLocnQuery(String sql_str,String sql_locn_append) throws Exception{
			int index = sql_str.indexOf("#");
			StringBuffer sb = new StringBuffer(sql_str);
			sb.replace(index,index+1,sql_locn_append);
			//sql_str = sb.toString();		
		return sb;
	}

	public int getRfQty(){
		return this.rf_qty;
	}

	public String getRfQtyUOM(){
		return this.rf_qty_uom;
	}

	public String getStabilityInfo(String drug_code,String rf_id) throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String result="";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT43")) ;
			pstmt.setString(1,drug_code);
			pstmt.setString(2,rf_id);
			pstmt.setString(3,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result = resultSet.getString("STABILITY_INFO");
				rf_qty = resultSet.getInt("RF_QTY");
				rf_qty_uom = resultSet.getString("RF_QTY_UOM");
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return result;
	}

	public Hashtable showWSOrderDetails(String order_id)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		ArrayList ingredients	= new ArrayList();
		ArrayList fluids		= new ArrayList();
		Hashtable result		= new Hashtable();
		String iv_prep_yn		= "";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT4")) ;
			pstmt.setString(1,order_id);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet != null && resultSet.next()){
				iv_prep_yn = resultSet.getString("IV_PREP_YN");
			}

			closeStatement(pstmt);
			closeResultSet(resultSet);
 //pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT52")) ;
			pstmt		= connection.prepareStatement( "SELECT a.order_id, a.order_line_num, b.drug_code, b.drug_desc, b.iv_ingredient_yn, b.iv_fluid_yn, a.order_qty, a.order_uom,b.physical_form, ph_get_ext_prod_drug_code (b.drug_code, ?) external_product_id, comp_rx_based_on, ratio_perc_factor, pres_qty_value, pres_qty_uom, cmp_rx_final_prod_uom, cmp_rx_final_prod_qty, cmp_rx_reqd_qty FROM or_order_line a, ph_drug_lang_vw b, or_order_line_ph c WHERE a.order_id = ? AND a.order_catalog_code = b.drug_code AND a.order_id = c.order_id AND a.order_line_num = c.order_line_num AND b.language_id = ?") ;
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,order_id);
			pstmt.setString(3,getLanguageId());

			resultSet	= pstmt.executeQuery() ;

			String ingredient =	null;
			String fluid	=	null;
			while(resultSet.next()){
				ingredient = resultSet.getString("IV_INGREDIENT_YN");
				fluid		= resultSet.getString("IV_FLUID_YN");

				if(ingredient != null && fluid != null ){
					if(!iv_prep_yn.equals("6")){
						if((ingredient.equals("Y") && fluid.equals("N"))||(ingredient.equals("Y") && fluid.equals("Y"))){
							ingredients.add(resultSet.getString("DRUG_CODE"));
							ingredients.add(resultSet.getString("DRUG_DESC"));
							ingredients.add(resultSet.getString("ORDER_ID"));
							ingredients.add(resultSet.getString("ORDER_LINE_NUM"));
							ingredients.add(resultSet.getString("ORDER_QTY"));
							ingredients.add(resultSet.getString("ORDER_UOM"));
							ingredients.add(resultSet.getString("PHYSICAL_FORM"));
							ingredients.add(checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));
							ingredients.add("");
							ingredients.add("");
							ingredients.add("");
							ingredients.add("");
							ingredients.add("");
							ingredients.add(resultSet.getString("PRES_QTY_VALUE"));
							ingredients.add(resultSet.getString("PRES_QTY_UOM"));
						}
						else if(ingredient.equals("N") && fluid.equals("Y")){
							fluids.add(resultSet.getString("DRUG_CODE"));
							fluids.add(resultSet.getString("DRUG_DESC"));
							fluids.add(resultSet.getString("ORDER_ID"));
							fluids.add(resultSet.getString("ORDER_LINE_NUM"));
							fluids.add(resultSet.getString("ORDER_QTY"));
							fluids.add(resultSet.getString("ORDER_UOM"));
							fluids.add(resultSet.getString("PHYSICAL_FORM"));
							fluids.add(checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));
							fluids.add(resultSet.getString("PRES_QTY_VALUE"));
							fluids.add(resultSet.getString("PRES_QTY_UOM"));
						}
					}
					else{
						ingredients.add(resultSet.getString("DRUG_CODE"));
						ingredients.add(resultSet.getString("DRUG_DESC"));
						ingredients.add(resultSet.getString("ORDER_ID"));
						ingredients.add(resultSet.getString("ORDER_LINE_NUM"));
						ingredients.add(resultSet.getString("ORDER_QTY"));
						ingredients.add(resultSet.getString("ORDER_UOM"));
						ingredients.add(resultSet.getString("PHYSICAL_FORM"));
						ingredients.add(checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));
						ingredients.add(checkForNull(resultSet.getString("COMP_RX_BASED_ON")));
						ingredients.add(checkForNull(resultSet.getString("RATIO_PERC_FACTOR")));
						ingredients.add(checkForNull(resultSet.getString("CMP_RX_REQD_QTY")));
						ingredients.add(checkForNull(resultSet.getString("CMP_RX_FINAL_PROD_QTY")));
						ingredients.add(checkForNull(resultSet.getString("CMP_RX_FINAL_PROD_UOM")));
						ingredients.add(resultSet.getString("PRES_QTY_VALUE"));
						ingredients.add(resultSet.getString("PRES_QTY_UOM"));
					}
				}
			}
			result.put("ingredients",ingredients);
			result.put("fluids",fluids);
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return result;
	}

	public String getItemCodeForDrug(String drug_code)throws Exception{
		String item_code = "";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT55")) ;
			pstmt.setString(1,drug_code.trim());
			resultSet = pstmt.executeQuery();
			if(resultSet != null && resultSet.next()){
				item_code = resultSet.getString("INVENTORY_ITEM_CODE");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return item_code;
	}

	public void setItemDetails(String drug_code) throws Exception {
		item_details = new ArrayList();
		item_count	= 0;
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {

			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT41")) ;
			pstmt.setString(1,drug_code);
			pstmt.setString(2,drug_code);
			pstmt.setString(3,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				item_count = resultSet.getInt("COUNT1");
				item_details.add(resultSet.getString("ITEM_CODE"));
				item_details.add(resultSet.getString("SHORT_DESC"));
			}

		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
	}

	public void setRFItemDetails(String rf_id) throws Exception {

		rf_item_details = new ArrayList();
		rf_item_count = 0;
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT53")) ;
			pstmt.setString(1,rf_id);
			pstmt.setString(2,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				++rf_item_count;
				rf_item_details.add(resultSet.getString("ITEM_CODE"));
				rf_item_details.add(resultSet.getString("SHORT_DESC"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
	}
	public int getItemCount(){
		return this.item_count;
	}
	public ArrayList getItemDetails(){
		return this.item_details;
	}
	public int getRFItemCount(){
		return this.rf_item_count;
	}
	public ArrayList getRFItemDetails(){
		return this.rf_item_details;
	}

	public void setWSAllocateBatches(String retVal,String drug_code,String drug_desc,String order_line_no,String rf_drug_flag){
		if(!retVal.equals("")){
			StringTokenizer st		= new StringTokenizer(retVal,"~");
			StringTokenizer st_ws_allocate_batches=	null;
			String item_code		= null;
			ArrayList arrListBatches = new ArrayList();
			String batch_id			=	null;
			String item_desc		=	null;
			String disp_locn		=	null;
			String disp_store		= null;
			String expiry_date		=	null;
			String bin_locn_code	=	null;
			String bin_locn_desc	=	null;
			String trade_id			=	null;	
			String trade_name		=	null;
			String manufacturer_id	=	null;
			String manufacturer_name =	null;
			String avail_qty		=	null;

			while(st.hasMoreTokens()){
				st_ws_allocate_batches= new StringTokenizer(st.nextToken(),"`");
				item_code ="";
//				int i = 1;

				while (st_ws_allocate_batches.hasMoreTokens()){
					batch_id = st_ws_allocate_batches.nextToken();
					item_code = st_ws_allocate_batches.nextToken();
					item_desc = st_ws_allocate_batches.nextToken();
					disp_locn = st_ws_allocate_batches.nextToken();
					disp_store = st_ws_allocate_batches.nextToken();

					st_ws_allocate_batches.nextToken();

					expiry_date	=	st_ws_allocate_batches.nextToken();
					bin_locn_code	=	st_ws_allocate_batches.nextToken();
					bin_locn_desc	= st_ws_allocate_batches.nextToken();
					trade_id		= st_ws_allocate_batches.nextToken();
					trade_name		= st_ws_allocate_batches.nextToken();

					st_ws_allocate_batches.nextToken();
					st_ws_allocate_batches.nextToken();
					manufacturer_id = st_ws_allocate_batches.nextToken();
					manufacturer_name = st_ws_allocate_batches.nextToken();
					avail_qty			= st_ws_allocate_batches.nextToken();
					st_ws_allocate_batches.nextToken();
					if(ws_allocate_batches.containsKey(item_code+drug_code)){
						arrListBatches.add(item_code);
						arrListBatches.add(batch_id);
						arrListBatches.add(drug_code);
						arrListBatches.add(drug_desc);
						arrListBatches.add(item_desc);
						arrListBatches.add(disp_locn);
						arrListBatches.add(disp_store);
						arrListBatches.add(expiry_date);
						arrListBatches.add(bin_locn_code);
						arrListBatches.add(bin_locn_desc);
						arrListBatches.add(trade_id);
						arrListBatches.add(trade_name);
						arrListBatches.add(manufacturer_id);
						arrListBatches.add(manufacturer_name);
						arrListBatches.add(avail_qty);
						if(rf_drug_flag.equals("RF") && (arrListBatches.size() % 16 != 0)){	
							arrListBatches.add("");
						}
					}
					else{
						arrListBatches = new ArrayList();
						arrListBatches.add(item_code);
						arrListBatches.add(batch_id);
						arrListBatches.add(drug_code);
						arrListBatches.add(drug_desc);
						arrListBatches.add(item_desc);
						arrListBatches.add(disp_locn);
						arrListBatches.add(disp_store);
						arrListBatches.add(expiry_date);
						arrListBatches.add(bin_locn_code);
						arrListBatches.add(bin_locn_desc);
						arrListBatches.add(trade_id);
						arrListBatches.add(trade_name);
						arrListBatches.add(manufacturer_id);
						arrListBatches.add(manufacturer_name);
						arrListBatches.add(avail_qty);
						if(rf_drug_flag.equals("RF") && (arrListBatches.size() % 16 != 0)){			
							arrListBatches.add("");
						}
					}
				}
				ws_allocate_batches.put(item_code+drug_code,arrListBatches);
			}
			if(!rf_drug_flag.equals("RF")){
				ht_ws_allocate_batches.put(order_line_no,arrListBatches);
			}else{
				Hashtable ht_allocate_batches = getHTWSFluidAllocateBatches();
				ht_allocate_batches.put(order_line_no,arrListBatches);			
			}
		}
	}

	
	public Hashtable getWSAllocateBatches(){
		return ws_allocate_batches;
	}

	public Hashtable getHTWSAllocateBatches(){
		return ht_ws_allocate_batches;
	}
	public void clearHTWSAllocateBatches(){
		ht_ws_allocate_batches = new Hashtable();
	}

	public Hashtable getHTWSFluidAllocateBatches(){
		return ht_ws_fluid_allocate_batches;
	}

	public void setHTWSFluidAllocateBatches(Hashtable ht_ws_fluid_allocate_batches){
		this.ht_ws_fluid_allocate_batches =ht_ws_fluid_allocate_batches;
	}

	public void wsAllocateQty(String item_code,String drug_code,String alloc_qty,String order_line_num){

		ArrayList qty = new ArrayList();
		if(ws_allocated_qty.containsKey(item_code+drug_code)){
			qty = (ArrayList)ws_allocated_qty.get(item_code+drug_code);
			qty.set(0,alloc_qty);
		}else{
			qty.add(alloc_qty);
			ws_allocated_qty.put(item_code+drug_code,qty);
		}
		ht_ws_allocated_qty.put(order_line_num,ws_allocated_qty);
	}

	public Hashtable getWSAllocatedQty(){
		return ws_allocated_qty;
	}
	public Hashtable getHTWSAllocatedQty(){
		return ht_ws_allocated_qty;
	}
	public void clearWSAllocatedQty(){
		ws_allocated_qty = new Hashtable();
	}

	public void setDrugDetails(String drug_code,String drug_desc){
		if(!ws_drug_details.contains(drug_code)){
			ws_drug_details.add(drug_code);
			ws_drug_details.add(drug_desc);
		}
	}
	public ArrayList getDrugDetails(){
		return ws_drug_details;
	}

	public void setAllocatedStatus(String allocated_status){
		this.allocated_status = allocated_status;
	}

	public String getAllocatedStatus(){
		return this.allocated_status;
	}

	public void addDrugDetails(String order_line_num,ArrayList drug_details){		
		ht_drug_details.put(order_line_num,drug_details);
	}

	public Hashtable getAllDrugDetails(){
		return ht_drug_details;
	}

	public void addAllocatedDrugs(String drug_code,String order_line_num){
		if(!ht_ws_allocated_drugs.containsKey(drug_code)){
			ht_ws_allocated_drugs.put(drug_code,order_line_num); 
		}		
	}
	
	public HashMap getAllAllocatedDrugs(){
		return ht_ws_allocated_drugs;
	}

	public void setOrderedQty(String order_line_num,String ordered_qty){
		ht_ordered_qty.put(order_line_num,ordered_qty);
	}

	public Hashtable getOrderedQty(){
		return ht_ordered_qty;
	}

	public void clearOrderedQty(){
		ht_ordered_qty= new Hashtable();
	}

	public String getSpillQtyYN(){
		//return ((String)ht_spill_qty_yn.get(patient_class));
		return allow_usage_of_spil_qty_yn;
	}

	/*public void setSpillQtyYN(String disp_locn_code) throws Exception {

		Connection connection	= null;
 PreparedStatement pstmt	= null;
 ResultSet resultSet		= null;
		try {
	connection	= getConnection() ;
 pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_SPILL_SELECT")) ;
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,disp_locn_code);
			pstmt.setString(3,getLanguageId());

 resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				//ht_spill_qty_yn.put("I",resultSet.getString("ALLOW_USAGE_OF_SPIL_QTY_YN"));
				//ht_spill_qty_yn.put("O",resultSet.getString("ALLOW_USAGE_OF_SPIL_QTY_YN"));
				allow_usage_of_spil_qty_yn =resultSet.getString("ALLOW_USAGE_OF_SPIL_QTY_YN");
			}

		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
	}*/
	
	public void setStockQtyUOM(String qty_drawn_stock,String rf_id) throws Exception {
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_STOCK_UOM")) ;
			pstmt.setString(1,qty_drawn_stock.trim());
			pstmt.setString(2,rf_id.trim());
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				this.stock_qty = resultSet.getString("STOCKQTY");
				this.stock_qty_uom = resultSet.getString("STOCK_UOM");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
	}

	public String getStockQty(){
		return this.stock_qty;
	}

	public String getStockQtyUOM(){
		return this.stock_qty_uom;
	}
	
	public String getDrugType(String drug_code)throws Exception{
		String result = "";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DRUG_TYPE")) ;
			pstmt.setString(1,drug_code.trim());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result=resultSet.getString("DRUG_TYPE");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return result;
	}

	public String getRFName(String rf_id)throws Exception{
		String result = "";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_RF_NAME")) ;
			pstmt.setString(1,rf_id.trim());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result=resultSet.getString("RF_NAME");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return result;
	}

	public String getDrugDesc(String drug_code)throws Exception{
		String result = "";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;

		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_DRUG_NAME")) ;
			pstmt.setString(1,drug_code.trim());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result=resultSet.getString("DRUG_DESC");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return result;
	}	
	/*
		This method will be executed if batches are allocated partially ...
	*/
	public void setWSDrugDetails(String order_id,String worksheet_id)throws Exception{
		
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		boolean	bEntered		= false;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT61")) ;
			pstmt.setString(1,order_id.trim());
			pstmt.setString(2,worksheet_id.trim());
			resultSet	= pstmt.executeQuery() ;

			String order_line_num	=	null;
			ArrayList arr			=	null;
			String physical_form	=	null;

			while(resultSet.next()){
				order_line_num = (String)resultSet.getString("ORDER_LINE_NUM");
				arr				= new ArrayList();
				physical_form	= (String)resultSet.getString("PHYSICAL_FORM");								
				if(physical_form.equals("P")){
					arr.add("");arr.add("");arr.add("");arr.add("");arr.add("");
					arr.add("");arr.add("");arr.add("");arr.add("");arr.add("");				
				}
				else{
					arr.add("");arr.add("");arr.add("");arr.add("");arr.add("");
				}
				if(ht_drug_details.containsKey(order_line_num) ){
					arr = (ArrayList)ht_drug_details.get(order_line_num);
				}				
				if(physical_form.equals("F")){
					arr.set(5,(String)resultSet.getString("DISP_DRUG_CODE"));
					arr.set(6,(String)resultSet.getString("PREPARED_QTY"));
					arr.set(7,(String)resultSet.getString("PREPARED_QTY"));
					arr.set(8,(String)resultSet.getString("SPILL_QTY"));
					arr.set(9,(String)resultSet.getString("DRUG_QTY_DRAWN"));
				}
				else{
					arr.set(0,(String)resultSet.getString("DISP_DRUG_CODE"));
					arr.set(1,(String)resultSet.getString("ORDER_QTY"));
					arr.set(2,(String)resultSet.getString("PREPARED_QTY"));
					arr.set(3,(String)resultSet.getString("SPILL_QTY"));
					arr.set(4,(String)resultSet.getString("DRUG_QTY_DRAWN"));
				}		
				addDrugDetails(order_line_num,arr);
				ws_first_yn.put(order_line_num+(String)resultSet.getString("DISP_DRUG_CODE"),"Y");
				bEntered = true;
			}
			if(!bEntered){
				addDrugDetails(order_line_num,new ArrayList());
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
	}

	public void setWSBatchDetails(String order_id)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String order_line_num	= null; 
		String drug_code		= null;
		String drug_desc		= null;
		String batch_id			= null;
		String item_code		= null;
		String item_desc		= null;
		String disp_locn		= null;
		String disp_store		= null;
		String expiry_date		= null;
		String bin_locn_code	= null;
		String bin_locn_desc	= null;
		String trade_id			= null;
		String trade_name		= null;
		String manufacturer_id = null;
		String manufacturer_name = null;
		String avail_qty		= null;
		String disp_qty			= null;
		ArrayList alDispQty		= new ArrayList();
		//Hashtable htDispQty		= new Hashtable();
		String sOldOrderLineNo	= "";
		String sOldDrugCode		= "";
		String sOldItemCode		= "";
		ws_allocate_batches		= new Hashtable();
		ht_ws_allocate_batches	= new Hashtable();
		ht_ws_allocated_qty		= new Hashtable();
		ws_allocated_qty		= new Hashtable();
		setHTWSFluidAllocateBatches(new Hashtable());

		int i=0;
		try {
			connection	= getConnection() ;
			//if(criteriaOrderType.equals("CDR") && order_type.equals("CA")) // if else block added for ML-MMOH-CRF-0435 [IN:057357]  
			//	pstmt		= connection.prepareStatement("SELECT   a.order_line_num, a.drug_code, g.short_desc item_desc, NVL (qty_on_hand, 0) - NVL (committed_qty, 0) avail_qty, a.item_code, a.batch_id, a.disp_locn_code,TO_CHAR (a.expiry_date, 'DD/MM/YYYY') expiry_date, disp_qty, disp_qty_uom, order_id, order_line_num, b.bin_location_code, e.trade_id,(SELECT short_desc   FROM mm_bin_location_lang_vw mm_bin_location WHERE bin_location_code = b.bin_location_code AND b.store_code = store_code AND language_id = ?) bin_desc, f.drug_desc, g.manufacturer_id, (SELECT short_name FROM am_manufacturer_lang_vw am_manufacturer WHERE manufacturer_id = g.manufacturer_id AND language_id = ?) manufacturer_name,e.short_name trade_name, b.store_code FROM ph_disp_drug_batch_tmp a, st_item_batch b, (SELECT dflt_trade_id trade_id, dflt_trade_id short_name  FROM mm_parameter  UNION SELECT trade_id, short_name FROM am_trade_name_lang_vw WHERE language_id = ?) e, ph_drug_lang_vw f,  mm_item_lang_vw g WHERE g.item_code = a.item_code AND b.trade_id = e.trade_id  AND f.drug_code = a.drug_code  AND a.store_code = b.store_code AND a.item_code = b.item_code AND a.batch_id = b.batch_id   AND b.expiry_date_or_receipt_date = a.expiry_date AND order_id = ? AND f.language_id = ?  AND g.language_id = ? ORDER BY order_id, a.order_line_num desc ") ;
			//else
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_ITEM_SELECT")) ;
			pstmt.setString(1,getLanguageId());
			pstmt.setString(2,getLanguageId());
			pstmt.setString(3,getLanguageId());
			pstmt.setString(4,order_id.trim());
			pstmt.setString(5,getLanguageId());
			pstmt.setString(6,getLanguageId());

			resultSet	= pstmt.executeQuery() ;
			ArrayList arrListBatches= new ArrayList();
			while(resultSet.next()){
				order_line_num = resultSet.getString("ORDER_LINE_NUM");
				drug_code		= resultSet.getString("DRUG_CODE");
				drug_desc		= resultSet.getString("DRUG_DESC");
				batch_id		= resultSet.getString("BATCH_ID");
				item_code		= resultSet.getString("ITEM_CODE");
				if(i==0){
					i++;
					sOldOrderLineNo = order_line_num;
					sOldItemCode	= item_code;
					sOldDrugCode	= drug_code;
				}

				item_desc		= resultSet.getString("ITEM_DESC");
				disp_locn		= resultSet.getString("DISP_LOCN_CODE");
				disp_store		= resultSet.getString("STORE_CODE");
				expiry_date	= resultSet.getString("EXPIRY_DATE");
				bin_locn_code	= resultSet.getString("BIN_LOCATION_CODE");
				bin_locn_desc	= resultSet.getString("BIN_DESC");
				trade_id		= resultSet.getString("TRADE_ID");
				trade_name		= resultSet.getString("TRADE_NAME");
				manufacturer_id = resultSet.getString("MANUFACTURER_ID");
				manufacturer_name = resultSet.getString("MANUFACTURER_NAME");
				avail_qty		= resultSet.getString("AVAIL_QTY");
				disp_qty		= resultSet.getString("DISP_QTY");

				if(ws_allocate_batches.containsKey(item_code+drug_code)){
					if(ht_ws_allocate_batches.containsKey(order_line_num)){
						arrListBatches = (ArrayList)ht_ws_allocate_batches.get(order_line_num);
					}
					else{
						arrListBatches= new ArrayList();
					}
					arrListBatches.add(item_code);
					arrListBatches.add(batch_id);
					arrListBatches.add(drug_code);
					arrListBatches.add(drug_desc);
					arrListBatches.add(item_desc);
					arrListBatches.add(disp_locn);
					arrListBatches.add(disp_store);
					arrListBatches.add(expiry_date);
					arrListBatches.add(bin_locn_code);
					arrListBatches.add(bin_locn_desc);
					arrListBatches.add(trade_id);
					arrListBatches.add(trade_name);
					arrListBatches.add(manufacturer_id);
					arrListBatches.add(manufacturer_name);
					arrListBatches.add(avail_qty);
				}
				else{
					arrListBatches = new ArrayList();
					arrListBatches.add(item_code);
					arrListBatches.add(batch_id);
					arrListBatches.add(drug_code);
					arrListBatches.add(drug_desc);
					arrListBatches.add(item_desc);
					arrListBatches.add(disp_locn);
					arrListBatches.add(disp_store);
					arrListBatches.add(expiry_date);
					arrListBatches.add(bin_locn_code);
					arrListBatches.add(bin_locn_desc);
					arrListBatches.add(trade_id);
					arrListBatches.add(trade_name);
					arrListBatches.add(manufacturer_id);
					arrListBatches.add(manufacturer_name);
					arrListBatches.add(avail_qty);
				}
				ws_allocate_batches.put(item_code+drug_code,arrListBatches);				
				ht_ws_allocate_batches.put(order_line_num,arrListBatches);	
				//wsAllocateQty(item_code,drug_code,disp_qty,order_line_num);

				if(!sOldOrderLineNo.equals(order_line_num)){
					ws_allocated_qty.put(sOldItemCode+sOldDrugCode,alDispQty);
					ht_ws_allocated_qty.put(sOldOrderLineNo,ws_allocated_qty);
					alDispQty = new ArrayList();
				}
				sOldOrderLineNo = order_line_num;
				sOldItemCode	= item_code;
				sOldDrugCode	= drug_code;
				alDispQty.add(disp_qty);
			}
			ws_allocated_qty.put(item_code+drug_code,alDispQty);
			ht_ws_allocated_qty.put(order_line_num,ws_allocated_qty);

			// This block is used to search the already stored (in non finalize mode of IP) Reconst Fluid values and store in the bean values
			pstmt		= connection.prepareStatement("SELECT a.order_line_num, a.disp_drug_code drug_code, g.short_desc item_desc, NVL (qty_on_hand, 0) - NVL (committed_qty, 0) avail_qty, a.disp_item_code, a.batch_id1 batch_id, a.disp_locn, TO_CHAR (a.EXPIRY_DATE1, 'DD/MM/YYYY') expiry_date, used_qty,DISP_DRUG_BASE_UNIT,order_id, order_line_num, b.bin_location_code,e.trade_id,(SELECT short_desc FROM mm_bin_location_lang_vw mm_bin_location WHERE bin_location_code = b.bin_location_code AND b.store_code = store_code AND language_id = ?) bin_desc, f.drug_desc, g.manufacturer_id, (SELECT short_name FROM am_manufacturer_lang_vw am_manufacturer WHERE manufacturer_id = g.manufacturer_id AND language_id = ?) manufacturer_name, e.short_name trade_name, b.store_code FROM PH_WORKSHEET_DTL a, st_item_batch b, (SELECT dflt_trade_id trade_id, dflt_trade_id short_name FROM mm_parameter UNION SELECT trade_id, short_name FROM am_trade_name_lang_vw WHERE language_id = ?) e, ph_drug_lang_vw f, mm_item_lang_vw g WHERE g.item_code = b.item_code AND b.trade_id = e.trade_id AND f.drug_code = a.DISP_ITEM_CODE AND a.DISP_LOCN = b.store_code and a.PHYSICAL_FORM = 'F' AND a.DISP_ITEM_CODE = b.item_code AND a.batch_id1 = b.batch_id AND b.expiry_date_or_receipt_date = a.EXPIRY_DATE1 AND order_id = ? AND f.language_id = ? AND g.language_id = ?") ;
			
			pstmt.setString(1,getLanguageId());
			pstmt.setString(2,getLanguageId());
			pstmt.setString(3,getLanguageId());
			pstmt.setString(4,order_id.trim());
			pstmt.setString(5,getLanguageId());
			pstmt.setString(6,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			arrListBatches= new ArrayList();
			
			Hashtable htFluidAllocBatches = getHTWSFluidAllocateBatches();
			while(resultSet.next()){
				order_line_num = resultSet.getString("ORDER_LINE_NUM") == null?"":resultSet.getString("ORDER_LINE_NUM");
				if(htFluidAllocBatches != null && htFluidAllocBatches.containsKey(order_line_num)){
					arrListBatches = (ArrayList)htFluidAllocBatches.get(order_line_num);
				}
				else{
					arrListBatches= new ArrayList();
				}
				arrListBatches.add(resultSet.getString("DISP_ITEM_CODE"));
				arrListBatches.add(resultSet.getString("BATCH_ID"));
				arrListBatches.add(resultSet.getString("DRUG_CODE"));
				arrListBatches.add(resultSet.getString("DRUG_DESC"));
				arrListBatches.add(resultSet.getString("ITEM_DESC"));
				arrListBatches.add(resultSet.getString("DISP_LOCN"));
				arrListBatches.add(resultSet.getString("STORE_CODE"));
				arrListBatches.add(resultSet.getString("EXPIRY_DATE"));
				arrListBatches.add(resultSet.getString("BIN_LOCATION_CODE"));
				arrListBatches.add(resultSet.getString("BIN_DESC"));
				arrListBatches.add(resultSet.getString("TRADE_ID"));
				arrListBatches.add(resultSet.getString("TRADE_NAME"));
				arrListBatches.add(resultSet.getString("MANUFACTURER_ID"));
				arrListBatches.add(resultSet.getString("MANUFACTURER_NAME"));
				arrListBatches.add(resultSet.getString("AVAIL_QTY"));
				arrListBatches.add(resultSet.getString("USED_QTY"));
				htFluidAllocBatches.put(order_line_num,arrListBatches);
			}
			setHTWSFluidAllocateBatches(htFluidAllocBatches);
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}	
	}

	public String getDefaultLanguageForDispenseLabel(String patient_id) throws Exception{
		String result			= "";
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		//if(patient_class==null){patient_class="";}
		//if(!patient_class.equals("IP"))patient_class="OP";
		try {
			connection	= getConnection() ;
 /* pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DFLT_LANG")) ;
			pstmt.setString(1,login_facility_id.trim());
 resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				if(patient_class.equals("OP")){
					result=resultSet.getString("DFLT_LANG_FOR_DISP_LABEL");
				}else{
					result=resultSet.getString("DFLT_LANG_FOR_DISP_LABEL_IP");
				}
			}*/
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DFLT_LANG1")) ;
			pstmt.setString(1,patient_id);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){				
				result=resultSet.getString("LOCAL_YN");				
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return result;
	}

	public String getPatientIDLength(){
		Connection connection	=	null ;
		PreparedStatement pstmt =	null ;
		ResultSet resultSet		=	null ; 
		String	pat_txt_length	=	null ;
		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_COMMON_SELECT1") ) ;
			resultSet	= pstmt.executeQuery(); 
			if( resultSet != null && resultSet.next() ) {
				pat_txt_length	=	checkForNull(resultSet.getString("PATIENT_ID_LENGTH"));
			}						
		}
		catch(Exception e){
				pat_txt_length	=e.toString();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return pat_txt_length;	
	}

	public ArrayList loadTokenSeries(String disp_locn_code) {
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList	token_series	=	new ArrayList() ;

		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT73") ) ;
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,disp_locn_code);
			pstmt.setString(3,login_at_ws_no);
			pstmt.setString(4,getLanguageId());
			resultSet	= pstmt.executeQuery();
			
			while( resultSet != null && resultSet.next() ) {
				token_series.add(checkForNull(resultSet.getString("TOKEN_SERIES_CODE")));
				token_series.add(checkForNull(resultSet.getString("DEFAULT_TOKEN_YN"))); //added for [IN:037465]
				token_series.add(checkForNull(resultSet.getString("DESCRIPTION")));
			}						
		}
		catch(Exception e){
			e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return token_series;	
	}

	public ArrayList getTokenDetails(String disp_locn_code,String patient_id,String token_series,String order_id) {//Changed as ArrayList for HSA-CRF-0136 [IN:048412]
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList 	arrList			=	new ArrayList() ;//Added for HSA-CRF-0136 [IN:048412]
		StringBuilder sbSql = new StringBuilder();

		try{
			connection			= getConnection() ;
			//pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT74") ) ;
			sbSql.append( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT74"));
			if(token_series!=null && !token_series.equals(""))
				sbSql.append( " AND TOKEN_SERIES_CODE=? ");
			sbSql.append( "  GROUP BY TOKEN_SERIES_CODE ");
			pstmt				= connection.prepareStatement( sbSql.toString());
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,disp_locn_code);
			pstmt.setString(3,this.queue_date);
			pstmt.setString(4,patient_id);
			pstmt.setString(5,order_id);
			if(token_series!=null && !token_series.equals(""))
				pstmt.setString(6,token_series);
			resultSet	= pstmt.executeQuery();
			
			if( resultSet != null && resultSet.next() ) {
				arrList.add(checkForNull(resultSet.getString("TOKEN_SERIES_CODE")));//Added for HSA-CRF-0136 [IN:048412]
				arrList.add(checkForNull(resultSet.getString("TOKEN_SERIAL_NO")));//Added for HSA-CRF-0136 [IN:048412]
				//token_no	=	checkForNull(resultSet.getString("TOKEN_SERIAL_NO"));				
			}						
		}
		catch(Exception e){
				e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return arrList;	//Changed as ArrayList for HSA-CRF-0136 [IN:048412]
	}

	public ArrayList getRoutineFillDateTime(String disp_locn_code) {
		Connection connection	=	null ;
		PreparedStatement pstmt	=	null ;
		ResultSet resultSet		=	null ; 
		ArrayList result		= new ArrayList() ;
		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT82") ) ;
			pstmt.setString(1,disp_locn_code);
			resultSet	= pstmt.executeQuery();
			while( resultSet != null && resultSet.next() ) {
				//result.add(resultSet.getString("FILL_INT_START_DATE_TIME"));				
				result.add(resultSet.getString("FILL_INT"));				
			}						
		}
		catch(Exception e){
				e.printStackTrace();
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return result;	
	}

	public boolean isWorkSheetOrder(String order_id) {
		Connection connection	=	null ;
		PreparedStatement pstmt	=	null ;
		ResultSet resultSet		=	null ; 
		boolean result			= false;
		String flag				=	"";
		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_WORKSHEET_SELECT1") ) ;
			pstmt.setString(1,order_id);

			resultSet	= pstmt.executeQuery();
			if( resultSet != null && resultSet.next() ) {
				flag	=	checkForNull(resultSet.getString("IV_PREP_YN"));
				if(flag.equals("2") || flag.equals("4")) {
					result	=	true;
				}
			}						
		}
		catch(Exception e){
				e.printStackTrace();
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return result;	
	}

	public ArrayList getIncrementalFillDateTime(String disp_locn_code) {
		Connection connection	=	null ;
		PreparedStatement pstmt	=	null ;
		ResultSet resultSet		=	null ; 
		ArrayList result		= new ArrayList() ;
		//int count				= 0;
		try{
			connection			= getConnection() ;
			/*pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT83") ) ;
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,disp_locn_code);
			resultSet	= pstmt.executeQuery();
			if( resultSet != null && resultSet.next() ) {
				count	= resultSet.getInt("COUNT");
			}						
			closeStatement(pstmt);
			closeResultSet(resultSet);
			if(count==0){*/
				pstmt	= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT85") ) ;
				//pstmt.setString(1,login_facility_id);
				pstmt.setString(1,disp_locn_code);
				resultSet	= pstmt.executeQuery();
				while (resultSet!=null && resultSet.next()){
					result.add(resultSet.getString("FILL_INT"));
					//result.add(resultSet.getString("FILL_INT_START_DATE_TIME"));
				}
				closeStatement(pstmt);
				closeResultSet(resultSet);
			/*}else{
				pstmt	= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT84") ) ;				
				resultSet	= pstmt.executeQuery();
				while (resultSet!=null && resultSet.next()){
					result.add(resultSet.getString("FILL_INT_END_DATE_TIME"));
				}
				closeStatement(pstmt);
				closeResultSet(resultSet);
			}*/
		}
		catch(Exception e){
				e.printStackTrace();
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return result;	
	}

/*=============FUNCTION FOR GETTING DEFAULT RECONSTITUENT FLUID OF THE DRUG======================*/
	public HashMap getRFFluidDetails(String drug_code)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		HashMap record = null;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT90")) ;

			pstmt.setString(1,drug_code.trim());
			pstmt.setString(2,"Y");
			pstmt.setString(3,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				record=new HashMap();
				record.put("RF_ID",resultSet.getString("RF_ID"));
				record.put("DRUG_QTY",resultSet.getString("DRUG_QTY"));
				record.put("DRUG_QTY_UOM",resultSet.getString("DRUG_QTY_UOM"));
				record.put("RF_QTY",resultSet.getString("RF_QTY"));
				record.put("RF_QTY_UOM",resultSet.getString("RF_QTY_UOM"));
				record.put("DRUG_DESC",resultSet.getString("DRUG_DESC"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return record;
	}
// function getOtherOrders returns the available other orders for a patient at this dispense location
	public ArrayList getOtherOrders(String disp_locn_code,String patient_id)throws Exception{

		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet 	= null;
		PreparedStatement pstmt1= null;
		ResultSet resultSet1	= null;
		PreparedStatement pstmt2= null;
		ResultSet resultSet2	= null;
		PreparedStatement pstmt3= null;
		ResultSet resultSet3	= null;
		ArrayList otherorders = new ArrayList();
		ArrayList orders = new ArrayList();
		HashMap record = null;
		String issue_token_on_regn="";
		String regn_date_time="";
		String order_id="";
		connection	= getConnection() ;
		pstmt= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT95"));
		pstmt1= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT96")) ;
		pstmt2= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT97")) ;
		pstmt3= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT98")) ;

		try {
			pstmt.setString(1,disp_locn_code);
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				issue_token_on_regn=resultSet.getString("ISSUE_TOKEN_ON_REGN_YN");
			}

			if(issue_token_on_regn.equals("Y")){	
				pstmt1.setString(1,patient_id);
				resultSet1	= pstmt1.executeQuery() ;
				while(resultSet1.next()){
					regn_date_time=resultSet1.getString("REGN_DATE_TIME");
				}
			}

			pstmt2.setString(1,regn_date_time);
			resultSet2	= pstmt2.executeQuery() ;
			
			if(resultSet2 != null){
				
				while(resultSet2.next()){
					order_id=resultSet2.getString("ORDER_ID");
					orders.add(order_id);
				}
			}

			for(int i=0;i<orders.size();i++){
				pstmt3.setString(1,(String)orders.get(i));
				pstmt3.setString(2,getLanguageId());
				pstmt3.setString(3,getLanguageId());
				pstmt3.setString(4,getLanguageId());
				pstmt3.setString(5,getLanguageId());
				pstmt3.setString(6,getLanguageId());

				resultSet3	= pstmt3.executeQuery() ;
				while(resultSet3.next()){
					record=new HashMap();
					record.put("drug_name",resultSet3.getString("drug_name"));
					record.put("start_date",resultSet3.getString("start_date"));
					record.put("end_date",resultSet3.getString("end_date"));
					record.put("order_catalog_code",resultSet3.getString("order_catalog_code"));
					record.put("qty_value",resultSet3.getString("qty_value"));
					record.put("qty_unit",resultSet3.getString("qty_unit"));
					record.put("freq_code",resultSet3.getString("freq_code"));
					record.put("ordered_practioner",resultSet3.getString("ordered_practioner"));
					record.put("locn_code",resultSet3.getString("locn_code"));
					record.put("ordering_location",resultSet3.getString("ordering_location"));
					record.put("performing_deptloc_code",resultSet3.getString("performing_deptloc_code"));
					record.put("performing_location",resultSet3.getString("performing_location"));
					record.put("facility_id",resultSet3.getString("ordering_facility_id"));
					record.put("facility_name",resultSet3.getString("facility_name"));
					otherorders.add(record);
			}
			closeResultSet(resultSet3);
			}	
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeResultSet( resultSet1 ) ;
			closeStatement( pstmt1 ) ;
			closeResultSet( resultSet2 ) ;
			closeResultSet( resultSet3 ) ;
			closeStatement( pstmt2 ) ;
			closeStatement( pstmt3 ) ;
			closeConnection( connection );
		}
		return otherorders;
	}

// Function getFillProcId() fetches the Proc ids added on the given date

	public ArrayList getFillProcId(String proc_date, String proc_type,String OrderingFacility) throws Exception{

		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
		// pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT100") ) ;
			pstmt = connection.prepareStatement( "SELECT distinct A.FILL_PROC_ID FROM PH_FILL_PROCESS_PARAM A,PH_DISP_HDR_TMP B, or_order c WHERE trunc(FILL_PROC_DATE_TIME) = to_date(?,'dd/mm/yyyy') and a.fill_proc_id = b.fill_proc_id AND PROC_TYPE=? and A.DISP_LOCN_CODE =? and b.ORDERING_FACILITY_ID =? AND b.order_id = c.order_id AND order_status != 'DC' and b.patient_id in (select patient_id from ip_open_encounter where patient_id = b.patient_id and encounter_id = B.encounter_id and facility_id = b.facility_id) order by A.FILL_PROC_ID" ) ;
			pstmt.setString(1,proc_date);
			pstmt.setString(2,proc_type);
			pstmt.setString(3,getDispLocnCode().trim());
			pstmt.setString(4,OrderingFacility);
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("FILL_PROC_ID"));
			}
		}
		catch ( Exception e ) {
			System.err.println( "Error loading values from database FOR FILL_PROC_IDS proc_date="+proc_date+" proc_type="+proc_type+" getDispLocnCode()="+getDispLocnCode()+" OrderingFacility="+OrderingFacility) ;
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}

// Function getNursingUnit() fetches the corresponding Nursing Units 

	public ArrayList getNursingUnit(String added_date, String fill_proc_id, String facility_id) throws Exception{
		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT101A") ) ;
			pstmt.setString(1,fill_proc_id);
			//pstmt.setString(2,login_facility_id);
			pstmt.setString(2,facility_id);
			pstmt.setString(3,getLanguageId());

			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(checkForNull(resultSet.getString("NURSING_UNIT_CODE")));
				result.add(checkForNull(resultSet.getString("NURSING_UNIT_NAME")));
			}
		}
		catch ( Exception e ) {
			System.err.println( "Error loading values from database FOR NURSING_UNITS fill_proc_id="+fill_proc_id+" facility_id="+facility_id+" getLanguageId()="+ getLanguageId()) ;
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}

	public String getresultlinestatus(String order_id, String order_line_num) throws Exception{

		String result_line_status		= "";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
//		HashMap nursing_units			= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_ORDER_LINE_SELECT1") ) ;
			pstmt.setString(1,order_id);
			pstmt.setString(2,order_line_num);			
			resultSet = pstmt.executeQuery() ;

			if ( resultSet != null && resultSet.next() ) {
				result_line_status=resultSet.getString("RESULT_LINE_STATUS");
			}
		}
		catch ( Exception e ) {
			System.err.println( "Error loading values from database FOR NURSING_UNITS order_id="+order_id+" order_line_num="+order_line_num ) ;
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result_line_status;
	}

	public ArrayList getPatientDtl(String patient_id) {
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList	ptdtls	=	new ArrayList() ;

		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT103") ) ;
			pstmt.setString(1,patient_id);
			resultSet	= pstmt.executeQuery();
			
			while( resultSet != null && resultSet.next() ) {
				ptdtls.add(checkForNull(resultSet.getString("PATIENT_NAME")));
				ptdtls.add(checkForNull(resultSet.getString("AGE")));
				ptdtls.add(checkForNull(resultSet.getString("SEX")));
				ptdtls.add(checkForNull(resultSet.getString("ORD_PRACT_ID")));
				ptdtls.add(checkForNull(resultSet.getString("Source_code")));
				
			}						
		}catch(Exception e){
				e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return ptdtls;	
	}

	public ArrayList getDrugDtl(String order_id,String order_line_no) {
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList	drug_dtl	=	new ArrayList() ;
		HashMap drug_dtls =null;
		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT102") ) ;
			pstmt.setString(1,order_id);
			pstmt.setString(2,order_line_no);
			pstmt.setString(3,order_id);
			pstmt.setString(4,order_line_no);
			pstmt.setString(5,getLanguageId());
			resultSet	= pstmt.executeQuery();
			
			while( resultSet != null && resultSet.next() ) {
				drug_dtls=new HashMap();
				drug_dtls.put("DRUG_DESC",(String)(resultSet.getString("DRUG_DESC")));
				drug_dtls.put("ORDER_CATALOG_CODE",(String)(resultSet.getString("ORDER_CATALOG_CODE")));
				drug_dtls.put("ORDER_QTY",(String)(resultSet.getString("ORDER_QTY")));
				drug_dtls.put("order_uom",(String)(resultSet.getString("order_uom")));
				drug_dtls.put("disp_qty",(String)(resultSet.getString("disp_qty"))); 
				drug_dtl.add(drug_dtls);
				
			}						
		}
		catch(Exception e){
			e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return drug_dtl;	
	}

	public ArrayList getRefFacility() { 
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList	ref_facility	=	new ArrayList() ;
		HashMap ref_fac =null;

		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT104") ) ;
			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,getLanguageId());
			resultSet	= pstmt.executeQuery();
			
			while( resultSet != null && resultSet.next() ) {
				ref_fac=new HashMap();
				ref_fac.put("FACILITY_ID",(String)(resultSet.getString("FACILITY_ID")));
				ref_fac.put("FACILITY_NAME",(String)(resultSet.getString("FACILITY_NAME")));
				ref_facility.add(ref_fac);
			}						
		}
		catch(Exception e){
				e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		return ref_facility;	
	}

// Function getOrderLineNumFrRefrl() fetches the available order line numbers for the given order id.
	public ArrayList getOrderLineNumFrRefrl(String order_id) throws Exception{

		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT105") ) ;
			pstmt.setString(1,order_id);
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("ORDER_LINE_NUM"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	} 

// function getManufactureDetails returns the drug details of the order.
	public ArrayList getManufactureDetails(String order_id)throws Exception{
		
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet 	= null;
		PreparedStatement pstmt1= null;
		ResultSet resultSet1	= null;
		PreparedStatement pstmt2= null;
		ResultSet resultSet2	= null;
		
		ArrayList ORDER_CATALOG_CODE = new ArrayList();
		ArrayList order_drugs		= new ArrayList();
		
		ArrayList manufacture_details = new ArrayList();
		ArrayList drug_values = new ArrayList();
	//	HashMap record = null;
		HashMap drug_dtls = null;

		String generic_name = "";
	//	String STABILITY_HRS="";
	//	String PRES_BASE_UOM="";
		
		connection	= getConnection() ;
		pstmt= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT1"));
		pstmt1= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT2")) ;

		pstmt2= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT3")) ;
		
		try {
			pstmt.setString(1,order_id);
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				
				ORDER_CATALOG_CODE.add(resultSet.getString("ORDER_CATALOG_CODE"));
				order_drugs.add(resultSet.getString("ORDER_CATALOG_CODE"));
				order_drugs.add(resultSet.getString("ORDER_LINE_NUM"));
				order_drugs.add(resultSet.getString("QTY_VALUE"));
				
			}
			
			manufacture_details.add(order_drugs);

			if(ORDER_CATALOG_CODE.size() == 1){
				pstmt1.setString(1,(String)ORDER_CATALOG_CODE.get(0));
				pstmt1.setString(2,getLanguageId());
				resultSet1	= pstmt1.executeQuery() ;
				while(resultSet1.next()){
					generic_name=resultSet1.getString("GENERIC_NAME");
				}
			}
			else if(ORDER_CATALOG_CODE.size()> 0)
			{	
				pstmt1.setString(1,(String)ORDER_CATALOG_CODE.get(1));				
				pstmt1.setString(2,getLanguageId());
				resultSet1	= pstmt1.executeQuery() ;
				while(resultSet1.next()){
						generic_name=resultSet1.getString("GENERIC_NAME");
				}
			}
			manufacture_details.add(generic_name);	
	//		record.put("generic_name",generic_name);

			if(ORDER_CATALOG_CODE.size()!= 0){
				for(int i=0; i<ORDER_CATALOG_CODE.size();i++){
					pstmt2.setString(1,(String)ORDER_CATALOG_CODE.get(i));
					pstmt2.setString(2,getLanguageId());
					resultSet2	= pstmt2.executeQuery() ;
					
					if(resultSet2 != null){
						while(resultSet2.next()){
							drug_dtls = new HashMap();
							drug_dtls.put("STABILITY_HRS",resultSet2.getString("STABILITY_HRS"));
							drug_dtls.put("PRES_BASE_UOM",resultSet2.getString("PRES_BASE_UOM"));
							drug_values.add(drug_dtls);
						}
					}
					closeResultSet( resultSet2 ) ;
				}
				manufacture_details.add(drug_values);

			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeResultSet( resultSet1 ) ;
			closeStatement( pstmt1 ) ;
			closeResultSet( resultSet2 ) ;
			closeStatement( pstmt2 ) ;
			closeConnection( connection );
		}
		return manufacture_details;
	}

// Function getExpireDateMixture to generate the expiry date of mixture.
	public String getExpireDateMixture(String stability_hrs) throws Exception{
		
		String expire_date				= "";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
//		HashMap nursing_units			= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MF_EXPDATE_SELECT4") ) ;
			pstmt.setString(1,stability_hrs);
//			pstmt.setString(2,order_line_num);			
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				expire_date=resultSet.getString("EXPIRE_DATE");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return expire_date;
	}

// Function getIvprepynFrManufacture to generate the expiry date of mixture.
	public String getIvprepynFrManufacture(String order_id) throws Exception{
		String iv_prep_yn				= "";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT4") ) ;
			pstmt.setString(1,order_id);
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				iv_prep_yn=resultSet.getString("IV_PREP_YN");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return iv_prep_yn;
	}

// Function getMfctrLabelDtls() fetches the manufacturing label details for the given order id from the table ph_worksheer_hdr.
	public ArrayList getMfctrLabelDtls(String order_id) throws Exception{

		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT5") ) ;

			pstmt.setString(1,order_id);
			pstmt.setString(2,order_id);
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("FACILITY_ID"));
				result.add(resultSet.getString("DISP_LOCN"));
				result.add(resultSet.getString("WORKSHEET_ID"));
				result.add(resultSet.getString("MFG_UNIT"));
				result.add(resultSet.getString("BATCH_ID"));
				result.add(resultSet.getString("EXPIRY_DATE"));
				result.add(resultSet.getString("QTY_VOLUME"));
				result.add(resultSet.getString("QTY_UOM"));
				result.add(resultSet.getString("admin_instruction"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}
// modifyMfctDetails() is to update the ph_worksheet_hdr table in delivery mode in disp medication
	public HashMap modifyMfctDetails(ArrayList arr_list){
		HashMap map=new HashMap();
//		DispMedicationWorkSheetHome home=null;
//		DispMedicationWorkSheetRemote remote=null;
		map.put( "result", new Boolean( false ) ) ;
		map.put( "message", "in modify.." ) ;
		map.put( "flag", "0" ) ;
		HashMap tabData = new HashMap() ;
		HashMap sqlMap = new HashMap() ;
		String ord_type=(String)arr_list.get(8);
		if(ord_type==null) ord_type="";
		tabData.put( "properties", getProperties());
		tabData.put( "facility_id", arr_list.get(0));
		tabData.put( "disp_locn", arr_list.get(1));
		tabData.put( "worksheet_id", arr_list.get(2));
		tabData.put( "mfg_unit", arr_list.get(3));
		tabData.put( "batch_id",arr_list.get(4));
		tabData.put( "expiry_date",arr_list.get(5));
		tabData.put( "qty_volume",arr_list.get(6));
		tabData.put( "qty_uom",arr_list.get(7));
		tabData.put( "login_facility_id", login_facility_id.trim() );
		tabData.put( "login_by_id", login_by_id.trim() );
		tabData.put( "login_at_ws_no",login_at_ws_no.trim());
		tabData.put( "ord_type",arr_list.get(8));
		tabData.put( "Admin_Instruction",arr_list.get(9));
		tabData.put( "infusion_line",arr_list.get(11));
		tabData.put( "approvalNo",getApprovalNo());//AAKH-CRF-0117

		try{
			sqlMap.put("SQL_PH_DISP_MEDICATION_MFCTR_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_UPDATE1"));
			sqlMap.put("SQL_PH_TPN_WORKSHEET_HDR_UPDATE1",PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_HDR_UPDATE1"));
			

			/*InitialContext context = new InitialContext() ;
			Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION_WORK_SHEET") ) ;
			home = (DispMedicationWorkSheetHome) PortableRemoteObject.narrow( object, DispMedicationWorkSheetHome.class ) ;
			remote = home.create() ;
	
			HashMap result = remote.modifyManufacturLabel( tabData, sqlMap ) ;

 			InitialContext context = new InitialContext() ;
			Object object = context.lookup( PhRepository.getPhKeyValue("JNDI_PH_DISP_MEDICATION") ) ;
			home = (DispMedicationHome) PortableRemoteObject.narrow( object, DispMedicationHome.class ) ;
			remote = home.create() ;
			HashMap result = remote.insertRefDetails( tabData, sqlMap ) ; */
			
			Object home = com.ehis.eslp.ServiceLocator.getInstance().getHome(PhRepository.getPhKeyValue( "JNDI_PH_DISP_MEDICATION_WORK_SHEET" ),DispMedicationWorkSheetHome.class,getLocalEJB());
			Object busObj = (home.getClass().getMethod("create",null)).invoke(home,null);
			Object argArray[] = new Object[2];
			argArray[0] = tabData;
			argArray[1] = sqlMap;

			Class [] paramArray = new Class[2];
			paramArray[0] = tabData.getClass(); ;
			paramArray[1] = sqlMap.getClass();

			HashMap result = (HashMap)(busObj.getClass().getMethod("modifyManufacturLabel",paramArray)).invoke(busObj,argArray);
			(busObj.getClass().getMethod("remove",null)).invoke(busObj,null);

			if( ((Boolean) result.get( "result" )).booleanValue() )	{
				map.put( "result", new Boolean( true ) ) ;
				map.put( "message", getMessage(getLanguageId(),(String) result.get( "msgid" ),"PH") ) ;
				map.put("flag","0");
			}
			else{
				map.put( "message", result.get("msgid") ) ;
				map.put("flag","0");
			}
		}
		catch(Exception e){
			e.printStackTrace();
			System.err.println("error in manufactureUpdate tabData"+tabData);
		}
		map.put("flag","0");
		return map;
	}

	public ArrayList getDeliveryPatientFillListDtls(){

		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		ArrayList patient_dtls	= new ArrayList();
		//System.out.println("getDeliveryPatientFillListDtls" + "getNursingUnit=" + getNursingUnit() + "---" + "login_facility_id ==" + login_facility_id + "---" + "getFillProcessID==" + getFillProcessID() + "--" + getFillType() + "--" + "getDispLocnCode==" + getDispLocnCode() );

		try {
			//String sSQL				= PhRepository.getPhKeyValue("SQL_DISP_MEDN_DEL_FILLLIST_PATIENT_SELECT") +" ORDER BY MIN(a.PATIENT_ID)";
			
			StringBuffer sbConstructSql	= new StringBuffer( "SELECT A.PATIENT_ID,E.LONG_DESC NURSING_UNIT,nvl(decode(?,'en',c.patient_Name,c.PATIENT_NAME_LOC_LANG),c.patient_Name)PATIENT_NAME,COUNT(DISTINCT A.ORDER_ID) ORDERS,GET_AGE(DATE_OF_BIRTH) AGE,DECODE (sex,'M', 'male','F', 'female','U', 'unknown') sex ,COUNTRY_CODE,SHORT_NAME NATIONALITY_DESC,C.NATIONAL_ID_NO,A.ENCOUNTER_ID,I.ADT_STATUS,k.BED_NUM BED_NO,(select long_desc  from ip_nursing_unit_lang_vw where nursing_unit_code =k.NURSING_UNIT_CODE and language_id =? and facility_id =a.ordering_facility_id) n_unit , DECODE(I.PATIENT_CLASS, 'IP','I','DC','D','OP','O','EM','E','XT','R') ENC_PATIENT_CLASS FROM OR_ORDER_LINE B,OR_ORDER A,MP_PATIENT C,MP_COUNTRY_LANG_VW D,IP_NURSING_UNIT_LANG_VW E,OR_ORDER_STATUS_CODE_LANG_VW F,PH_DISP_HDR_TMP G,PH_FILL_PROCESS_PARAM H ,PR_ENCOUNTER I, ph_drug j,ip_open_encounter k WHERE E.NURSING_UNIT_CODE =  G.LOCN_CODE AND E.FACILITY_ID=A.ORDERING_FACILITY_ID AND I.facility_id = a.ordering_facility_id AND I.ENCOUNTER_ID =A.ENCOUNTER_ID and k.facility_id = a.ordering_facility_id AND k.encounter_id = a.encounter_id AND C.PATIENT_ID=A.PATIENT_ID AND B.ORDER_ID=A.ORDER_ID AND C.NATIONALITY_CODE=D.COUNTRY_CODE(+) AND F.ORDER_STATUS_CODE=B.ORDER_LINE_STATUS AND B.ORDER_ID=G.ORDER_ID AND H.FILL_PROC_ID=G.FILL_PROC_ID AND E.NURSING_UNIT_CODE = ? AND F.ORDER_STATUS_TYPE ='35' AND G.PATIENT_CLASS='IP' AND A.PATIENT_CLASS='IP' AND b.order_catalog_code = j.drug_code AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND A.ORDER_CATEGORY='PH' AND G.FILL_PROC_ID=? AND H.PROC_TYPE=? AND g.disp_locn_code=?");  // E.NURSING_UNIT_CODE=A.SOURCE_CODE -- changed to  E.NURSING_UNIT_CODE = G1.LOCN_CODE
			if(getDispExpOrders().equals("N"))       //if block Added for ML-BRU-SCF-0636 [IN:036826]
				sbConstructSql.append(" AND trunc(B.END_DATE_TIME) >= TRUNC(SYSDATE) "); 
			 sbConstructSql.append(" AND E.LANGUAGE_ID = F.LANGUAGE_ID AND E.LANGUAGE_ID = ? AND D.LANGUAGE_ID(+) = ? GROUP BY A.PATIENT_ID, PATIENT_NAME,c.PATIENT_NAME_LOC_LANG, DATE_OF_BIRTH, SEX,COUNTRY_CODE, SHORT_NAME, C.NATIONAL_ID_NO,A.ENCOUNTER_ID,E.LONG_DESC,I.ADT_STATUS,k.BED_NUM,k.NURSING_UNIT_CODE,a.ordering_facility_id, I.PATIENT_CLASS ORDER BY MIN(a.PATIENT_ID)");
			connection = getConnection() ;
			pstmt = connection.prepareStatement(sbConstructSql.toString()) ;
			int count=0;
			pstmt.setString(++count,getLanguageId()); 
			pstmt.setString(++count,getLanguageId()); 
			pstmt.setString(++count,getNursingUnit().trim());
			pstmt.setString(++count,login_facility_id.trim());
			pstmt.setString(++count,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(++count,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(++count,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(++count,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(++count,getFillProcessID().trim());
			pstmt.setString(++count,getFillType().trim());
			pstmt.setString(++count,getDispLocnCode().trim());
			pstmt.setString(++count,getLanguageId());
			pstmt.setString(++count,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			while( resultSet.next() ) {
				HashMap patient_dtl = new HashMap();
				patient_dtl.put("PATIENT_ID" , resultSet.getString("PATIENT_ID"));
				patient_dtl.put("PATIENT_NAME" , resultSet.getString("PATIENT_NAME"));
				patient_dtl.put("ORDERS" , resultSet.getString("ORDERS"));
				patient_dtl.put("AGE" , resultSet.getString("AGE"));
				patient_dtl.put("SEX" , resultSet.getString("SEX"));
				patient_dtl.put("NATIONALITY_DESC" , resultSet.getString("NATIONALITY_DESC"));
				patient_dtl.put("ENCOUNTER_ID",resultSet.getString("ENCOUNTER_ID"));
				patient_dtl.put("ADT_STATUS",resultSet.getString("ADT_STATUS"));
				patient_dtl.put("BED_NO",resultSet.getString("BED_NO"));
				patient_dtl.put("NURSING_UNIT",resultSet.getString("n_unit"));
				patient_dtl.put("ENC_PATIENT_CLASS",resultSet.getString("ENC_PATIENT_CLASS"));
				patient_dtls.add(patient_dtl);
			}
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return patient_dtls;
	}

	public ArrayList getDeliveryPatientOrderDtls(String patient_id){

		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		ArrayList patient_order_dtls	= new ArrayList();
		setSalDocDtls(new ArrayList());//Added for MMS-RY-SCF-0088
		//System.out.println("getDeliveryPatientOrderDtls" + "getNursingUnit=" + getNursingUnit() + "---" + "login_facility_id ==" + login_facility_id + "---" + "getFillProcessID==" + getFillProcessID() + "--" + getFillType() + "--" + "getDispLocnCode==" + getDispLocnCode() + "patient_id===" + patient_id);
		try {
			connection = getConnection() ;
 //pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_DISP_MEDN_DEL_FILLLIST_PAT_ORDER_SELECT") ) ;
			
			pstmt = connection.prepareStatement("SELECT A.PRIORITY,A.IV_PREP_YN,E.LONG_DESC LOCATION,A.ORDER_ID,TO_CHAR(A.ORD_DATE_TIME, 'DD/MM/YYYY HH24:MI') ORD_DATE_TIME ,F.PRACTITIONER_NAME,DECODE(A.ORDERING_FACILITY_ID, A.PERFORMING_FACILITY_ID,'',G.FACILITY_NAME) FACILITY_NAME,F.PRACTITIONER_ID,F.PRACTITIONER_NAME,G1.ENCOUNTER_ID,(select distinct disp_trn_seq_no from ph_disp_cons_dtl where DISP_TRN_SEQ_NO =g1.disp_trn_seq_no)disp_trn_seq_no FROM OR_ORDER_LINE B, OR_ORDER A,IP_NURSING_UNIT_LANG_VW E ,SM_FACILITY_PARAM_LANG_VW G,AM_PRACTITIONER_LANG_VW F,PH_DISP_HDR_TMP G1,PH_FILL_PROCESS_PARAM H,ph_drug j WHERE E.FACILITY_ID=A.ORDERING_FACILITY_ID AND B.ORDER_ID=A.ORDER_ID AND G.FACILITY_ID=A.ORDERING_FACILITY_ID AND A.ORD_PRACT_ID=F.PRACTITIONER_ID(+) AND E.NURSING_UNIT_CODE=G1.LOCN_CODE AND B.ORDER_ID=G1.ORDER_ID AND H.FILL_PROC_ID=G1.FILL_PROC_ID AND E.NURSING_UNIT_CODE = ? AND A.PATIENT_ID = ? AND PH_CHECK_ORD_DATE_DISPENSING(B.START_DATE_TIME,B.END_DATE_TIME,?,?,?,?,?)=1 AND b.order_line_status IN  ('IP','DC') AND A.PATIENT_CLASS='IP' AND A.ORDER_CATEGORY='PH' and b.order_catalog_code = j.drug_code AND g1.disp_locn_code=? AND G1.FILL_PROC_ID = ? AND H.PROC_TYPE = ? AND E.LANGUAGE_ID = G.LANGUAGE_ID AND E.LANGUAGE_ID = ? AND F.LANGUAGE_ID(+) = ? group by a.priority, a.iv_prep_yn, e.long_desc , a.order_id,a.ord_date_time, f.practitioner_name, a.ordering_facility_id,a.performing_facility_id,g.facility_name,f.practitioner_id, f.practitioner_name, g1.encounter_id ,g1.DISP_TRN_SEQ_NO order by a.order_id"); // E.NURSING_UNIT_CODE=A.SOURCE_CODE -- changed to  E.NURSING_UNIT_CODE = G1.LOCN_CODE

			pstmt.setString(1,getNursingUnit().trim());
			pstmt.setString(2,patient_id.trim());
			pstmt.setString(3,login_facility_id.trim());
			pstmt.setString(4,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(5,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(6,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(7,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(8,getDispLocnCode().trim());
			pstmt.setString(9,getFillProcessID().trim());
			pstmt.setString(10,getFillType().trim());
			pstmt.setString(11,getLanguageId());
			pstmt.setString(12,getLanguageId());
			
			resultSet = pstmt.executeQuery() ;
			while( resultSet.next() ) {
				HashMap patient_order_dtl = new HashMap();
				patient_order_dtl.put("ORDER_ID" , resultSet.getString("ORDER_ID"));
				patient_order_dtl.put("PRACTITIONER_NAME" , resultSet.getString("PRACTITIONER_NAME"));
				patient_order_dtl.put("LOCATION" , resultSet.getString("LOCATION"));
				patient_order_dtl.put("DISP_TRN_SEQ_NO" , checkForNull(resultSet.getString("DISP_TRN_SEQ_NO"),""));
				patient_order_dtls.add(patient_order_dtl);
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {

			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return patient_order_dtls;
	}

	public ArrayList getDeliveryPatOrderLineDtls(String patient_id,String order_id){

		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		ArrayList patient_order_line_dtls	= new ArrayList();		
		ArrayList alPatientOrderLineDtls	= new ArrayList();
		//ArrayList alOrderLineNumbers		= new ArrayList();
		HashMap hmAltDrugRemarks		= new HashMap(); // Added For Bru-HIMS-CRF-082 [IN:029948]
		if(objAllStages!=null)
			hmAltDrugRemarks=objAllStages.getAltDrugRemarks();// Added For Bru-HIMS-CRF-082 [IN:029948]
		try {
			HashMap patient_order_line_dtl = new HashMap();
			ArrayList multi_drug_detail	=	new ArrayList();
			//checkForStockInstallation();
			connection = getConnection() ;
			//String sql_str	=	PhRepository.getPhKeyValue("SQL_DISP_MEDN_DEL_FILLLIST_PAT_ORD_LINE_SELECT");
			//	String sql_str	="SELECT H.PATIENT_ID,B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GETMINDOSEDETAILS(B.DRUG_CODE, ?) MINDOSEDETAILS ,PH_ISDUPLICATEDRUG(B.DRUG_CODE, ? ) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE,B.IN_FORMULARY_YN, H.IV_PREP_YN, F.GENERIC_NAME, B.DRUG_CLASS, B.DRUG_DESC,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID , A.ORDER_LINE_NUM ,A.ORDER_QTY, A.QTY_VALUE, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, I.FORM_DESC, D.FREQ_DESC, A.DURN_VALUE, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, NVL(PH_CALCULATEBALANCE(A.ORDER_ID,A.ORDER_LINE_NUM),(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2)) BMS_QTY,A.ORDER_CATALOG_CODE,PH_DRUGDOSEINLIMIT(B.DRUG_CODE,?,A.QTY_VALUE,A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT, H.SOURCE_CODE,H.SOURCE_TYPE,H.ORDERING_FACILITY_ID,TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME, H.ORD_PRACT_ID PERFORMING_PRACT_ID ,(SELECT COUNT(*) FROM PH_DISP_DRUG_BATCH_TMP WHERE FACILITY_ID = g2.FACILITY_ID AND DISP_LOCN_CODE = g2.DISP_LOCN_CODE AND ORDER_ID = g2.ORDER_ID AND ORDER_LINE_NUM = g1.ORDER_LINE_NO) filled_batch_count # FROM OR_ORDER_LINE A,OR_ORDER H,PH_DRUG_LANG_VW B,OR_ORDER_LINE_PH G,AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D,AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F,OR_ORDER_STATUS_CODE_LANG_VW G1,PH_DISP_HDR_TMP G2,PH_DISP_DTL_TMP G1,PH_FILL_PROCESS_PARAM H,PH_FORM_LANG_VW I WHERE H.ORDER_ID=A.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND A.ORDER_ID=G2.ORDER_ID AND A.ORDER_ID=G1.ORDER_ID AND A.ORDER_LINE_NUM=G1.ORDER_LINE_NO AND G1.ORDER_ID=G2.ORDER_ID AND H.FILL_PROC_ID=G2.FILL_PROC_ID AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME, ?)=1 AND G2.FILL_PROC_ID=NVL( ? ,G2.FILL_PROC_ID) AND H.PROC_TYPE=NVL(?,PROC_TYPE) AND G1.ORDER_STATUS_TYPE = '35' AND A.ORDER_ID = ? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? order by a.order_id ,a.ORDER_LINE_NUM ";
			StringBuffer sbMainSql	= new StringBuffer("SELECT H.PATIENT_ID,B.STRENGTH_VALUE,(SELECT SHORT_DESC FROM AM_UOM_LANG_VW AM_UOM WHERE UOM_CODE=B.STRENGTH_UOM AND LANGUAGE_ID = ?) STRENGTH_UOM, PH_GETMINDOSEDETAILS(B.DRUG_CODE, ?) MINDOSEDETAILS ,PH_ISDUPLICATEDRUG(B.DRUG_CODE, ? ) ISDUPLICATE, (SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2) ALLOC_QTY, B.DRUG_CODE,B.IN_FORMULARY_YN, H.IV_PREP_YN, F.GENERIC_NAME, B.DRUG_CLASS, B.DRUG_DESC,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID , A.ORDER_LINE_NUM ,A.ORDER_QTY, A.QTY_VALUE, A.QTY_UNIT, C.SHORT_DESC QTY_UNIT_DESC, I.FORM_DESC, D.FREQ_DESC, A.DURN_VALUE, E.DURN_DESC, TO_CHAR(A.START_DATE_TIME, 'DD/MM/YYYY') START_DATE_TIME, TO_CHAR(A.END_DATE_TIME, 'DD/MM/YYYY') END_DATE_TIME, A.ORDER_QTY PRES_QTY_VALUE, A.ORDER_UOM PRES_QTY_UOM, G.ALLERGY_OVERRIDE_REASON, G.DUPLICATE_DRUG_OVERRIDE_REASON, G.DOSAGE_LIMIT_OVERRIDE_REASON, G.ORDER_LINE_NUM, A.ORDER_LINE_STATUS, B.GENERIC_ID, NVL(PH_CALCULATEBALANCE(A.ORDER_ID,A.ORDER_LINE_NUM),(SELECT DISP_QTY FROM PH_DISP_DTL_TMP WHERE ORDER_ID=A.ORDER_ID AND ORDER_LINE_NO=A.ORDER_LINE_NUM AND ROWNUM<2)) BMS_QTY,A.ORDER_CATALOG_CODE,PH_DRUGDOSEINLIMIT(B.DRUG_CODE,?,A.QTY_VALUE,A.DURN_VALUE,A.ORDER_QTY) DRUG_DOSAGE_LIMIT, H.SOURCE_CODE,H.SOURCE_TYPE,H.ORDERING_FACILITY_ID,TO_CHAR(H.ORD_DATE_TIME,'DD/MM/YYYY HH24:MI') ORD_DATE_TIME, H.ORD_PRACT_ID PERFORMING_PRACT_ID ,(SELECT COUNT(*) FROM PH_DISP_DRUG_BATCH_TMP WHERE FACILITY_ID = g2.FACILITY_ID AND DISP_LOCN_CODE = g2.DISP_LOCN_CODE AND ORDER_ID = g2.ORDER_ID AND ORDER_LINE_NUM = a.ORDER_LINE_Num) filled_batch_count # FROM OR_ORDER_LINE A,OR_ORDER H,PH_DRUG_LANG_VW B,OR_ORDER_LINE_PH G,AM_UOM_LANG_VW C,AM_FREQUENCY_LANG_VW D,AM_DURATION_TYPE_LANG_VW E,PH_GENERIC_NAME_LANG_VW F,OR_ORDER_STATUS_CODE_LANG_VW G1,PH_DISP_HDR_TMP G2,PH_FILL_PROCESS_PARAM H,PH_FORM_LANG_VW I WHERE H.ORDER_ID=A.ORDER_ID AND A.ORDER_ID= G.ORDER_ID AND A.ORDER_LINE_NUM=G.ORDER_LINE_NUM AND A.ORDER_CATALOG_CODE=B.DRUG_CODE AND A.FORM_CODE=I.FORM_CODE AND B.FORM_CODE=I.FORM_CODE AND G.PRES_QTY_UOM=C.UOM_CODE(+) AND A.FREQ_CODE=D.FREQ_CODE(+) AND A.DURN_TYPE=E.DURN_TYPE(+) AND F.GENERIC_ID=B.GENERIC_ID AND G1.ORDER_STATUS_CODE=A.ORDER_LINE_STATUS AND A.ORDER_ID=G2.ORDER_ID AND H.FILL_PROC_ID=G2.FILL_PROC_ID AND PH_CHECK_ORD_DATE_DISPENSING(A.START_DATE_TIME,A.END_DATE_TIME, ?,?,?,?,?)=1 AND G2.FILL_PROC_ID=NVL( ? ,G2.FILL_PROC_ID) AND H.PROC_TYPE=NVL(?,PROC_TYPE) AND G1.ORDER_STATUS_TYPE = '35' AND A.ORDER_ID = ? AND B.LANGUAGE_ID = F.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = I.LANGUAGE_ID AND B.LANGUAGE_ID = G1.LANGUAGE_ID AND B.LANGUAGE_ID = ? AND C.LANGUAGE_ID(+) = ? AND D.LANGUAGE_ID(+) = ? AND E.LANGUAGE_ID(+) = ? order by a.order_id ,a.ORDER_LINE_NUM ");

			String sql_stock_append = ",PH_RET_TOT_STOCK_AVAIL (B.DRUG_CODE,G.BMS_QTY,H.PERFORMING_DEPTLOC_CODE,TO_CHAR(A.END_DATE_TIME,'DD/MM/YYYY HH24:MI')) STKAVAILABLE ";
			sbMainSql =	replaceStockQuery(sbMainSql,sql_stock_append);
			pstmt = connection.prepareStatement( sbMainSql.toString() ) ;
			pstmt.setString(1,getLanguageId());
			pstmt.setString(2,patient_id.trim());
			pstmt.setString(3,patient_id.trim());
			pstmt.setString(4,login_facility_id.trim());
			pstmt.setString(5,patient_id.trim());
			pstmt.setString(6,login_facility_id.trim());
			pstmt.setString(7,getDisp_before_start_date_yn());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(8,getDisp_before_no_of_days());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(9,getDisp_beyond_earliest_start_yn());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(10,getDisp_beyond_no_of_days());//Added for COMMON-ICN-0116 [39681]
			pstmt.setString(11,getFillProcessID().trim());
			pstmt.setString(12,getFillType().trim());
			pstmt.setString(13,order_id.trim());
			pstmt.setString(14,getLanguageId());
			pstmt.setString(15,getLanguageId());
			pstmt.setString(16,getLanguageId());
			pstmt.setString(17,getLanguageId());
			resultSet = pstmt.executeQuery() ;

			while( resultSet.next() ) {
				patient_order_line_dtl = new HashMap();
				patient_order_line_dtl.put("DRUG_CODE" , resultSet.getString("DRUG_CODE"));
				patient_order_line_dtl.put("DRUG_DESC" , resultSet.getString("DRUG_DESC"));
				patient_order_line_dtl.put("PERFORMING_PRACT_ID" , resultSet.getString("PERFORMING_PRACT_ID"));
				patient_order_line_dtl.put("ORDER_QTY" , resultSet.getString("ORDER_QTY"));
				patient_order_line_dtl.put("BMS_QTY" , resultSet.getString("BMS_QTY"));
				patient_order_line_dtl.put("ALLOC_QTY" , resultSet.getString("ALLOC_QTY"));
				patient_order_line_dtl.put("STKAVAILABLE" ,checkForNull(resultSet.getString("STKAVAILABLE")));
				patient_order_line_dtl.put("EXTERNAL_PRODUCT_ID",checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));
				patient_order_line_dtl.put("FILLED_BATCH_COUNT",resultSet.getString("filled_batch_count"));
				patient_order_line_dtl.put("ORDER_LINE_NUM",resultSet.getString("ORDER_LINE_NUM"));
				//alOrderLineNumbers.add(resultSet.getString("ORDER_LINE_NUM"));
				alPatientOrderLineDtls.add(patient_order_line_dtl);
			}
			closeResultSet(resultSet);
			closeStatement(pstmt);
			//pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT134")) ;
			//String sSQL = "SELECT A.DISP_QTY,A.DISP_DRUG_CODE,A.PRES_DRUG_CODE,B.DRUG_DESC,A.DISP_UOM_CODE FORM_CODE,B.STRENGTH_VALUE,B.STRENGTH_UOM ,a.DISP_UOM_CODE,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID FROM PH_DISP_DTL_TMP A,PH_DRUG_LANG_VW B WHERE A.PRES_DRUG_CODE<>A.DISP_DRUG_CODE AND A.ORDER_ID=? AND A.DISP_DRUG_CODE=B.DRUG_CODE AND B.LANGUAGE_ID = ?";
			String sSQL = "SELECT A.DISP_QTY,A.DISP_DRUG_CODE,A.PRES_DRUG_CODE,B.DRUG_DESC,A.DISP_UOM_CODE FORM_CODE,B.STRENGTH_VALUE,B.STRENGTH_UOM ,a.DISP_UOM_CODE,ph_get_ext_prod_drug_code(b.drug_code,?)EXTERNAL_PRODUCT_ID, A.ORDER_LINE_NO, A.ALT_DRUG_REMARKS FROM PH_DISP_DTL_TMP A,PH_DRUG_LANG_VW B WHERE (a.pres_drug_code <> a.disp_drug_code OR (SELECT COUNT (*) FROM ph_disp_dtl_tmp WHERE order_id = a.order_id AND order_line_no = a.order_line_no) >1 ) AND A.ORDER_ID=? AND A.DISP_DRUG_CODE=B.DRUG_CODE AND B.LANGUAGE_ID = ?";
			pstmt		= connection.prepareStatement(sSQL) ;
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,order_id);
			//pstmt.setString(3,"1");
			pstmt.setString(3,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				multi_drug_detail.add(checkForNull(resultSet.getString("DISP_DRUG_CODE")));
				multi_drug_detail.add(checkForNull(resultSet.getString("DRUG_DESC")));
				multi_drug_detail.add(checkForNull(resultSet.getString("FORM_CODE")));
				multi_drug_detail.add(checkForNull(resultSet.getString("STRENGTH_VALUE")));
				multi_drug_detail.add(checkForNull(resultSet.getString("STRENGTH_UOM")));
				multi_drug_detail.add(checkForNull(resultSet.getString("DISP_QTY")));
				multi_drug_detail.add(checkForNull(resultSet.getString("DISP_UOM_CODE")));
				multi_drug_detail.add(checkForNull(resultSet.getString("EXTERNAL_PRODUCT_ID")));
                if(hmAltDrugRemarks!=null && !hmAltDrugRemarks.containsKey(order_id+"~"+resultSet.getString("ORDER_LINE_NO")))// Added For Bru-HIMS-CRF-082 [IN:029948]
					objAllStages.setAltDrugRemarks(order_id+"~"+resultSet.getString("ORDER_LINE_NO"), checkForNull(resultSet.getString("ALT_DRUG_REMARKS")));
			}
			//if(multi_drug_detail.size()>0){
			patient_order_line_dtl.put("AlterDrugDtls",multi_drug_detail);
			//}
			patient_order_line_dtls.add(alPatientOrderLineDtls);
			patient_order_line_dtls.add(multi_drug_detail);
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return patient_order_line_dtls;
	}

	public String getItemCost(String item_code,String store_code, String qty_reqd,String eff_date) throws Exception {
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		CallableStatement cstmt = null ;
		String item_cost		=	"";
		try{
			connection	= getConnection() ;
			cstmt=connection.prepareCall("{call st_stock_availability_status (?,?,?,?,TO_DATE(?,'dd/mm/yyyy hh24:mi'),?,?,?,?,?,?,?,?,?,?,?,?,?,?)}");
			cstmt.setString( 1, item_code );
			cstmt.setString( 2, store_code );
			cstmt.setString( 3, qty_reqd );
			cstmt.setString( 4, "N" );
			cstmt.setString( 5, eff_date);
			cstmt.setString( 6, "Y");
			cstmt.setString( 7, "");
			cstmt.registerOutParameter(8, Types.VARCHAR );
			cstmt.registerOutParameter(9, Types.VARCHAR );
			cstmt.registerOutParameter(10, Types.VARCHAR );
			cstmt.registerOutParameter(11, Types.INTEGER );
			cstmt.registerOutParameter(12, Types.VARCHAR );
			cstmt.registerOutParameter(13, Types.VARCHAR );
			cstmt.registerOutParameter(14, Types.VARCHAR );
			cstmt.registerOutParameter(15, Types.VARCHAR );
			cstmt.registerOutParameter(16, Types.VARCHAR );
			cstmt.registerOutParameter(17, Types.VARCHAR );
			cstmt.registerOutParameter(18, Types.VARCHAR );
			cstmt.registerOutParameter(19, Types.VARCHAR );
			
			cstmt.execute() ;		
			item_cost	=	(String)(cstmt.getString(10));
		}
		catch ( Exception e ){
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeStatement( cstmt ) ;
			closeConnection( connection ); 
		}	
		return item_cost;
	}

/*========function for loading referal facilities from AM_REFERAL TABLE==========*/
	public ArrayList getAmRefFacility() { 
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList	ref_facility	=	new ArrayList() ;
		HashMap ref_fac =null;

		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT110") ) ;
			pstmt.setString(1,getLanguageId());
			resultSet	= pstmt.executeQuery();
			
			while( resultSet != null && resultSet.next() ) {
				ref_fac=new HashMap();
				ref_fac.put("REFERRAL_CODE",(String)(resultSet.getString("code")));
				ref_fac.put("SHORT_DESC",(String)(resultSet.getString("SHORT_DESC")));
				ref_facility.add(ref_fac);
				
			}						
		}catch(Exception e){
				e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){es.printStackTrace();
			}
		}
		return ref_facility;	
	}	


	public ArrayList getManufactureDetailsTPN(String order_id ,String disp_locn1)throws Exception{
	
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet 	= null;
		PreparedStatement pstmt1	= null;
		ResultSet resultSet1 	= null;
		String tpn_worksheet_id	="";

		ArrayList batchDetails = new ArrayList();
		try {
			connection	= getConnection() ;
			pstmt1= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_DTL_SELECT4"));
			pstmt1.setString(1,order_id);
			resultSet1	= pstmt1.executeQuery() ;
			while(resultSet1.next()){
				tpn_worksheet_id=resultSet1.getString("TPN_WORKSHEET_ID");
			}
			pstmt= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_TPN_WORKSHEET_HDR_SELECT4"));
			pstmt.setString(1,tpn_worksheet_id);
			pstmt.setString(2,disp_locn1);
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				batchDetails.add(resultSet.getString("FACILITY_ID"));
				batchDetails.add(resultSet.getString("DISP_LOCN_CODE"));
				batchDetails.add(resultSet.getString("TPN_WORKSHEET_ID"));
				batchDetails.add(resultSet.getString("MFG_UNIT"));
				batchDetails.add(resultSet.getString("BATCH_ID"));
				batchDetails.add(resultSet.getString("EXPIRY_DATE1"));
				batchDetails.add(resultSet.getString("QTY_VOLUME"));
				batchDetails.add(resultSet.getString("QTY_UOM"));
				batchDetails.add(resultSet.getString("ADMIN_INSTRUCTION"));
				batchDetails.add(resultSet.getString("INFUSION_LINE"));
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeResultSet( resultSet1 ) ;
			closeStatement( pstmt1 ) ;
			closeConnection( connection );
		}
		return batchDetails;
	}
/*=====================================ENDS HERE==================================*/

	public String getautharizedyn(String pin) throws Exception{
		int result				=0;
		String flag = "N";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT91") ) ;
			pstmt.setString(1,pin);
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				result=resultSet.getInt("resu");
			}

			if(result>0){
				flag="Y";
			}else{
				flag="N";
			}

		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return flag;
	}
//METHOD FOR GETTING OP_DISP_PERIOD FROM PH_DISP_LOCN
	public int getopdispperiod(String displocn) throws Exception{
		
		int op_disp_period				= 0;		
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT114") ) ;
			
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,displocn);		
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				op_disp_period=resultSet.getInt("OP_DISP_PERIOD");				
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return op_disp_period;
	}

	public String getNxtWrkshtId(String order_type,String Disp_locn_code) throws Exception{
	
		Connection		connection	= null;
		PreparedStatement pstmt			= null;
		ResultSet		resultSet		= null;

		String nxtWrkshtId = "";
		try{
			connection = getConnection();
			if(order_type.equals("IVRCA")){
				pstmt = connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT116"));
			}else if(order_type.equals("TPN")){
				pstmt = connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT117"));
			}

			pstmt.setString(1,Disp_locn_code);
			pstmt.setString(2,login_facility_id.trim());
			
		
			resultSet = pstmt.executeQuery();
			if(resultSet != null && resultSet.next()){
				nxtWrkshtId = checkForNull(resultSet.getString("WRKSHTID"));
			}
		}catch(Exception e){
			e.printStackTrace() ;
			throw e ;
		}
		finally{
			try{
				closeResultSet(resultSet);
				closeStatement(pstmt);
				closeConnection(connection);
			}catch(Exception es){
				es.printStackTrace();
			}
		}
		return nxtWrkshtId;
	}

	public ArrayList getDurnValue(String worksheet_id, String ws_type,String disp_locn_code) throws Exception{
	
		Connection		connection	= null;
		PreparedStatement pstmt			= null;
		ResultSet		resultSet		= null;

		ArrayList durn_values = new ArrayList();
		String durn_value = "";
		String infuse_over = "";
		String iv_value = "";
		String repeat_value = "";
		try{
			connection = getConnection();
			if(ws_type.equals("WS_FINALIZE") || ws_type.equals("CYTO_WS_FINALIZE")){ //modified for MMS-KH-CRF-0017.1
				//pstmt = connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT118")+" AND A.DISP_LOCN = ?");
				pstmt = connection.prepareStatement("SELECT DISTINCT B.DURN_VALUE DURN_VALUE, ceil(D.INFUSE_OVER) INFUSE_OVER, C.IV_PREP_YN IV_PREP_YN,E.REPEAT_VALUE REPEAT_VALUE FROM PH_WORKSHEET_DTL A, OR_ORDER_LINE B, OR_ORDER C, OR_ORDER_LINE_PH D,AM_FREQUENCY E WHERE A.ORDER_ID = B.ORDER_ID AND A.ORDER_LINE_NUM = B.ORDER_LINE_NUM AND B.ORDER_ID = C.ORDER_ID AND C.ORDER_ID = D.ORDER_ID AND B.ORDER_LINE_NUM = D.ORDER_LINE_NUM AND B.FREQ_CODE = E.FREQ_CODE AND A.WORKSHEET_ID = ? AND A.DISP_LOCN = ?");

			}else if(ws_type.equals("TPN_WS_FINALIZE")){
				pstmt = connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT119")+" AND A.DISP_LOCN = ?");
			}
			pstmt.setString(1,worksheet_id);
			pstmt.setString(2,disp_locn_code);

			resultSet = pstmt.executeQuery();

			if(resultSet != null && resultSet.next()){
				durn_value = checkForNull(resultSet.getString("DURN_VALUE"));
				if(ws_type.equals("WS_FINALIZE") || ws_type.equals("CYTO_WS_FINALIZE")){//modified for MMS-KH-CRF-0017.1
					infuse_over		= checkForNull(resultSet.getString("INFUSE_OVER"));
					iv_value		= checkForNull(resultSet.getString("IV_PREP_YN"));
					repeat_value = checkForNull(resultSet.getString("REPEAT_VALUE"));
				}
			}

			if(iv_value.equals("2")){
				durn_value	= Math.ceil(Integer.parseInt(durn_value)/Integer.parseInt(infuse_over))+"";
				repeat_value = "1";

			}else if(iv_value.equals("4")){
				durn_value		= Math.ceil(Integer.parseInt(durn_value)/24)+"";
			}else if(iv_value.equals("0")){
				durn_value		=	durn_value;
				repeat_value	=	repeat_value;
			}else {
				repeat_value = "1";
			}

			durn_values.add(durn_value);
			if(iv_value.equals("2")){
				durn_values.add("1");
			}else if(iv_value.equals("4")){
				durn_values.add("2");
			}else if(iv_value.equals("0")){
				durn_values.add("4");
			}else{
				durn_values.add("3");
			}
			durn_values.add(repeat_value);
		}catch(Exception e){
			e.printStackTrace() ;
			throw e ;
		}
		finally{
			try{
				closeResultSet(resultSet);
				closeStatement(pstmt);
				closeConnection(connection);
			}catch(Exception es){
				es.printStackTrace();
			}
		}
		return durn_values;
	}

	public String getorderlinestatus(String order_id,String order_line_num) throws Exception{
		
		String order_line_status = "N";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT120") ) ;
			pstmt.setString(1,order_id);
			pstmt.setString(2,order_line_num);
		
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				order_line_status=resultSet.getString("ORDER_LINE_STATUS");				
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return order_line_status;
	}

	public ArrayList getDosageDtls(String order_id,String order_line_num) throws Exception{
		String dosage_dtls				= "";
		String FREQ_DESC				= "";
		String DURN_TYPE				= "";
		String DURN_VALUE				= "";
		String END_DATE_TIME			= "";
		String START_DATE_TIME			= "";
		String QTY_VALUE				= "";
		String QTY_UNIT					= "";
		String drug_yn					= "";
		String sliding_scale_yn			= "";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		ArrayList result				= new ArrayList();
		try {
			connection = getConnection() ;
		// pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_AM_FREQ_SELECT") ) ;
			pstmt = connection.prepareStatement( "SELECT DECODE (INSTR (a.qty_value, '.'),0, TO_CHAR (a.qty_value),RTRIM (TO_CHAR (a.qty_value, '9999999990.00000000'),'0')) qty_value,QTY_UNIT,TO_CHAR(A.START_DATE_TIME,'DD/MM/YYYY HH24:MI')START_DATE_TIME, A.FREQ_CODE, decode(e.MFR_YN,'Y',(floor(A.DURN_VALUE*60/60)||':'||round( mod(A.DURN_VALUE*60,60),0)),A.DURN_VALUE) DURN_VALUE, DURN_DESC DURN_TYPE, TO_CHAR(A.END_DATE_TIME,'DD/MM/YYYY HH24:MI') END_DATE_TIME,B.FREQ_DESC ,d.drug_yn drug_yn,e.SLIDING_SCALE_YN FROM OR_ORDER_LINE A,AM_FREQUENCY_LANG_VW B , am_duration_type_lang_vw c,ph_drug d,or_order_line_ph e WHERE A.FREQ_CODE=B.FREQ_CODE and a.DURN_TYPE =c.DURN_TYPE and b.language_id =c.LANGUAGE_ID and a.order_catalog_code =d.Drug_code and a.order_id =e.order_id AND a.ORDER_LINE_NUM = e.ORDER_LINE_NUM AND a.ORDER_ID=? AND a.ORDER_LINE_NUM=? AND B.LANGUAGE_ID = ?" ) ;
			pstmt.setString(1,order_id);
			pstmt.setString(2,order_line_num);
			pstmt.setString(3,getLanguageId());

			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
					
				START_DATE_TIME		=	resultSet.getString("START_DATE_TIME")==null?"":resultSet.getString("START_DATE_TIME");		
				QTY_VALUE			=	resultSet.getString("QTY_VALUE")==null?"":resultSet.getString("QTY_VALUE");		
				QTY_UNIT			=	resultSet.getString("QTY_UNIT")==null?"":resultSet.getString("QTY_UNIT");		
				END_DATE_TIME		=	resultSet.getString("END_DATE_TIME")==null?"":resultSet.getString("END_DATE_TIME");	
				DURN_VALUE			=	resultSet.getString("DURN_VALUE")==null?"":resultSet.getString("DURN_VALUE");		
				DURN_TYPE			=	resultSet.getString("DURN_TYPE")==null?"":resultSet.getString("DURN_TYPE");	
				FREQ_DESC			=	resultSet.getString("FREQ_DESC")==null?"":resultSet.getString("FREQ_DESC");			
				drug_yn				=	resultSet.getString("DRUG_YN")==null?"":resultSet.getString("DRUG_YN");			
				sliding_scale_yn	=	resultSet.getString("SLIDING_SCALE_YN")==null?"N":resultSet.getString("SLIDING_SCALE_YN");			
			} 
			if(drug_yn.equals("Y")){
				dosage_dtls=FREQ_DESC+" For "+DURN_VALUE+" "+DURN_TYPE;		
			}else{
				dosage_dtls ="";		
			}
			result.add(dosage_dtls);
			result.add(START_DATE_TIME);
			result.add(END_DATE_TIME);
			result.add(QTY_VALUE);
			result.add(QTY_UNIT);
			result.add(sliding_scale_yn);
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}

	public String getDispAutharizationYN(String drug_code) throws Exception{		
		
		String disp_auth_yn = "N";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT125") ) ;
			pstmt.setString(1,drug_code);
			
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				disp_auth_yn=resultSet.getString("DISP_AUTH_REQD_YN");				
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return disp_auth_yn;
	}

	public ArrayList getIVLegends() throws Exception{	
		
		
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
			ArrayList iv_legends			= new ArrayList();

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT127") ) ;
			pstmt.setString(1,getLanguageId());
			resultSet = pstmt.executeQuery() ;
			while( resultSet.next() ) {
				iv_legends.add("IVAD");
				iv_legends.add(resultSet.getString("iv_drug_fluid_continuous_dir"));
				iv_legends.add("IVAA");
				iv_legends.add(resultSet.getString("iv_drug_fluid_continuous_adm"));
				iv_legends.add("IVID");
				iv_legends.add(resultSet.getString("IV_DRUG_FLUID_INTERMITTENT_dir"));
				iv_legends.add("IVIA");
				iv_legends.add(resultSet.getString("IV_DRUG_FLUID_INTERMITTENT_adm"));
				iv_legends.add("IVWA");
				iv_legends.add(resultSet.getString("IV_WITHOUT_ADDITIVES_LG")); 
			} 	
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}
		return iv_legends;
	}

	public String getTPNWorksheetID(String order_id) throws Exception{		
		
		String worksheet_id = "";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT128") ) ;
			pstmt.setString(1,order_id);
			
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				worksheet_id=resultSet.getString("TPN_WORKSHEET_ID");				
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return worksheet_id;
	}

	public double getSPILQTYAVAIL(String order_id,String order_line_no,String ordering_facility_id,String worksheet_id) throws Exception{		
		
		double spil_qty_avail = 0;
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT129") ) ;
			pstmt.setString(1,order_id);
			pstmt.setString(2,order_line_no);
			pstmt.setString(3,ordering_facility_id);
			pstmt.setString(4,worksheet_id);
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				spil_qty_avail=resultSet.getDouble("SPIL_QTY_AVAIL");				
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return spil_qty_avail;
	}
//this method is used to get total qty dispensed for regular prescription in case of admixture
	public int getTotalDispQtyForWorkSheet(String order_id,String order_line_no,String facility_id) throws Exception{		
		
		int tot_disp_qty_for_ws = 0;
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;

		try {
				connection = getConnection() ;
			// pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT130") ) ;
			pstmt = connection.prepareStatement( "SELECT SUM (used_qty) tot_disp_qty FROM ph_worksheet_dtl a, ph_worksheet_hdr b WHERE A.WORKSHEET_ID=B.WORKSHEET_ID AND a.order_id = ? AND a.order_line_num = ? AND a.facility_id = ? AND A.disp_locn = ? AND A.ORDER_ID=B.ORDER_ID AND A.FACILITY_ID=B.FACILITY_ID AND A.DISP_LOCN=B.DISP_LOCN AND B.FINALIZED_YN ='Y' ");
			pstmt.setString(1,order_id);
			pstmt.setString(2,order_line_no);
			pstmt.setString(3,facility_id);
			pstmt.setString(4,getDispLocnCode().trim());
			
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				tot_disp_qty_for_ws	=	resultSet.getInt("TOT_DISP_QTY");				
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return tot_disp_qty_for_ws;
	}

	public String getHealthCardNo() throws Exception {
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String healthcard_no		= "";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_REG_PRESCRIPTIONS_SELECT22")) ;
			pstmt.setString(1,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				healthcard_no = checkForNull(resultSet.getString("alt_id1_desc"));
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return healthcard_no;
	}

	public String getNationID() throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String national_id		= "";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_REG_PRESCRIPTIONS_SELECT21")) ;
			pstmt.setString(1,getLanguageId());
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				national_id = checkForNull(resultSet.getString("NAT_ID_PROMPT"));
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return national_id;
	}
//this method is used to check whether lipid is used while preparing tpn worksheet
	 public int CheckForLipid(String facility_id,String TPN_worksheet_id,String disp_locn) throws Exception{		
		
		int count						= 0;
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_TPN_DISP_MEDICATION_SELECT2") ) ;
			pstmt.setString(1,facility_id);
			pstmt.setString(2,TPN_worksheet_id);
			pstmt.setString(3,disp_locn);			
			
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				count	=	resultSet.getInt("cnt");				
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return count;
	}

	public String getTPNNonStdRegimenDesc(String order_id) throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String product_name		= "";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_TPN_NON_STD_REGIMEN_SELECT5")) ;
			pstmt.setString(1,order_id);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				product_name = checkForNull(resultSet.getString("CATALOG_DESC"));
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
		}
		return product_name;
	}

//code added to get data for un finalised worksheets
	public ArrayList getDataForUnFinalisedWorksheets(String worksheet_id,String disp_locn_code,String order_line_num,String facility_id) { 
		Connection connection		=	null ;
		PreparedStatement pstmt		=	null ;
		ResultSet resultSet			=	null ; 
		ArrayList	unfinalised_val	=	new ArrayList() ;
		
		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT142") ) ;
			pstmt.setString(1,worksheet_id);
			pstmt.setString(2,disp_locn_code.trim());
			pstmt.setString(3,order_line_num);
			pstmt.setString(4,facility_id.trim());
			
			resultSet	= pstmt.executeQuery();
			
			while( resultSet != null && resultSet.next() ) {				
				
				unfinalised_val.add((String)(resultSet.getString("used_qty")));
				unfinalised_val.add((String)(resultSet.getString("spil_qty_avail")));
				unfinalised_val.add((String)(resultSet.getString("qty_used_from_stock")));
				
			}						
		}catch(Exception e){
				e.printStackTrace();
		}
 		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){es.printStackTrace();
			}
		}
		return unfinalised_val;	

	}	
	public String getWorksheetFinalisedYN(String worksheet_id,String disp_locn_code,String facility_id) throws Exception{

		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		finalized_yn			= "Y";

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT143") ) ;
			pstmt.setString(1,worksheet_id);
			pstmt.setString(2,facility_id);
			pstmt.setString(3,disp_locn_code);
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				finalized_yn=resultSet.getString("finalized_yn");
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		setFinalized_yn(finalized_yn);
		return finalized_yn;
	}

	public String getInfusionLine(String orderId) throws Exception{

		Connection connection			= null ;
		PreparedStatement pstmt			= null ;
		ResultSet resultSet				= null;
		String infusion_line			= "";

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_MFCTR_SELECT6") ) ;
			pstmt.setString(1,orderId);
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				infusion_line=resultSet.getString("TPN_ADMIN_ROUTE");
			} 
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return infusion_line;
	}

	public ArrayList getTPNQtyUom(String order_id)throws Exception{
		ArrayList result = new ArrayList();
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null;
		try {
			connection = getConnection() ;
			//pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_TPN_DISP_MEDICATION_SELECT3") ) ;
			pstmt = connection.prepareStatement( "SELECT sum(DISP_QTY) DISP_QTY , DISP_QTY_UOM FROM PH_TPN_WORKSHEET_DTL WHERE ORDER_ID= ? and DISP_QTY_UOM is not null group by DISP_QTY_UOM ") ;
			pstmt.setString(1,order_id.trim());
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				result.add(resultSet.getString("DISP_QTY") == null ? "":resultSet.getString("DISP_QTY"));
				result.add(resultSet.getString("DISP_QTY_UOM") == null ? "":resultSet.getString("DISP_QTY_UOM"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
			throw e ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
		return result;
	}

	public String getFunctRollID(String login_by_id)throws Exception{
		String funct_role_id	="";
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT146") ) ;
			pstmt.setString(1,login_by_id);
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				funct_role_id=resultSet.getString("func_role_id") == null ? "":resultSet.getString("func_role_id");
				
			}
		}
		 catch ( Exception e ) {
			 e.printStackTrace() ;
			 throw e ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			 catch(Exception es) { es.printStackTrace();}
		 }
		return funct_role_id;
	}

/*
	public String getDispBillingStage()throws Exception{
		String disp_bill_stage	="";
 Connection connection	= null ;
 PreparedStatement pstmt = null ;
 ResultSet resultSet		= null;
 try {
			connection = getConnection() ;
		pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT155") ) ;
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,getDispLocnCode().trim());
		resultSet = pstmt.executeQuery() ;
 while ( resultSet != null && resultSet.next() ) {
				disp_bill_stage=resultSet.getString("DISP_BILL_STAGE");
			}
		}
 catch ( Exception e ) {
 e.printStackTrace() ;
 throw e ;
 }
 finally {
 try {
 closeResultSet( resultSet ) ;
 closeStatement( pstmt ) ;
 closeConnection( connection );
 }
 catch(Exception es) { es.printStackTrace();}
 }
		return disp_bill_stage;
}
*/
	public String getPendngOrderCnt(String patient_id){
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		String pndng_order_cnt	= "";
		try {
			connection = getConnection() ;
		//pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT156") ) ;
			pstmt = connection.prepareStatement("SELECT COUNT(*) POCNT FROM OR_ORDER A WHERE PATIENT_ID = ? AND ORDER_CATEGORY = 'PH' /*AND ORDER_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('00','03','05'))*/ AND EXISTS (SELECT ORDER_ID FROM OR_ORDER_LINE WHERE ORDER_ID =A.ORDER_ID AND ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN ('00','03','05')) AND END_DATE_TIME >= SYSDATE)"); //OR_ORDER_STATUS_CODE part of SQL Commented for HSA-CRF-0136 [IN:048412]- [IN:049363]
			pstmt.setString(1,patient_id);
			//pstmt.setString(2,disp_locn);
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				pndng_order_cnt = resultSet.getString("POCNT") == null ? "":resultSet.getString("POCNT");
			}
		}
		 catch ( Exception e ) {
			e.printStackTrace() ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			 catch(Exception es) { es.printStackTrace();}
		 }

		return pndng_order_cnt;
	}

	public HashMap getAdmxPrepChargeDetails(String disp_locn_code, String worksheet_id,String order_type){
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		HashMap Admix_prep_charge_det	= new HashMap(); 
		try {
			connection = getConnection() ;
			if(order_type.equals("TA")){
				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT171") ) ;
				pstmt.setString(1,login_facility_id.trim());
				pstmt.setString(2,disp_locn_code);
				pstmt.setString(3,worksheet_id);
			}
			else{
				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT166") ) ;
				pstmt.setString(1,login_facility_id.trim());
				pstmt.setString(2,disp_locn_code);
				pstmt.setString(3,worksheet_id);
			}
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				Admix_prep_charge_det.put("ADMX_PREP_CHARGE_ITEM_CODE", resultSet.getString("ADMX_PREP_CHARGE_ITEM_CODE") == null ? "":resultSet.getString("ADMX_PREP_CHARGE_ITEM_CODE"));
				Admix_prep_charge_det.put("ADMX_PREP_CHARGE_UNITS", resultSet.getString("ADMX_PREP_CHARGE_UNITS") == null ? "":resultSet.getString("ADMX_PREP_CHARGE_UNITS"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}

		return Admix_prep_charge_det;
	}

	public void updateTokenStatus(String token_series_code) throws Exception {
		Connection connection	= null; 
		CallableStatement cstmt = null ;
		try {
			connection	= getConnection() ;
			cstmt=connection.prepareCall("{call ph_update_token_status (?,?,?,?,?,?)}");
			cstmt.setString( 1, login_facility_id );
			cstmt.setString( 2, this.disp_locn_code );
			cstmt.setString( 3, this.queue_date );
			cstmt.setString( 4, "*ALL" );
			cstmt.setString( 5, token_series_code);
			cstmt.setString( 6, "");	
			cstmt.execute();
		}
		catch ( Exception e ){
			e.printStackTrace() ;
		}
		finally{
			closeStatement( cstmt ) ;
			closeConnection( connection ); 
		}	
	}

	public ArrayList getPendingTokenDetails(String token_series_code,String token_no){
		Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null;
		ArrayList pending_token_det	= new ArrayList(); 
		HashMap temp = null;
		try {
			connection		= getConnection() ;
			//pstmt = connection.prepareStatement( "SELECT A.ORDER_ID ORDER_ID,A.ORDER_LINE_NUM ORDER_LINE_NUM, D.DRUG_DESC DRUG_DESC,c.short_DESC ORDER_LINE_STATUS FROM OR_ORDER_LINE A ,PH_ORD_FOR_DISP_QUEUE B,OR_ORDER_STATUS_CODE_LANG_VW C,PH_DRUG_LANG_VW D WHERE A.ORDER_ID = B.ORDER_ID AND B.FACILITY_ID=? AND B.DISP_LOCN_CODE=? AND QUEUE_DATE=TO_DATE(?,'DD/MM/YYYY') AND QUEUE_SHIFT='*ALL' AND TOKEN_SERIES_CODE=? AND TOKEN_SERIAL_NO=? AND A.ORDER_LINE_STATUS =C.ORDER_STATUS_CODE AND C.LANGUAGE_ID =? AND A.ORDER_CATALOG_CODE=D.DRUG_CODE AND D.LANGUAGE_ID =?" ) ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT173") ) ;

			pstmt.setString(1,login_facility_id);
			pstmt.setString(2,this.disp_locn_code);
			pstmt.setString(3,this.queue_date);
			pstmt.setString(4,token_series_code);
			pstmt.setString(5,token_no);
			pstmt.setString(6,getLanguageId());
			pstmt.setString(7,getLanguageId());
		
			resultSet = pstmt.executeQuery() ;
			while ( resultSet != null && resultSet.next() ) {
				temp = new HashMap(); 
				temp.put("ORDER_ID",resultSet.getString("ORDER_ID"));
				temp.put("ORDER_LINE_NUM",resultSet.getString("ORDER_LINE_NUM"));
				temp.put("DRUG_DESC",resultSet.getString("DRUG_DESC"));
				temp.put("ORDER_LINE_STATUS",resultSet.getString("ORDER_LINE_STATUS"));
				pending_token_det.add(temp);
			}
		}
		 catch ( Exception e ) {
			 e.printStackTrace() ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			 catch(Exception es) { es.printStackTrace();}
		 }

		return pending_token_det;
	}


	public String CheckForAppointments(String patient_id) throws Exception{		
		
		String next_appt_days			= "";
		Connection connection			= null ;
		PreparedStatement pstmt			= null ;		
		ResultSet resultSet				= null;
		try {
			
			connection = getConnection() ;
		// pstmt = connection.prepareStatement( "select count(*) cnt from oa_appt where FACILITY_ID =? and trunc(APPT_DATE)>=trunc(sysdate) and PATIENT_ID=? and APPT_STATUS='1'" ) ;
		// pstmt = connection.prepareStatement( "select (APPT_DATE-trunc(sysdate)) next_appt_days from oa_appt where FACILITY_ID =? and trunc(APPT_DATE)>=trunc(sysdate) and PATIENT_ID=? and APPT_STATUS='1' AND ROWNUM<2 order by APPT_DATE " ) ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT174") ) ;
			//pstmt.setString(1,login_facility_id); //commented for  ML-BRU-SCF-1387 [IN:049916]
			pstmt.setString(1,patient_id);
			resultSet = pstmt.executeQuery() ;
			if ( resultSet != null && resultSet.next() ) {
				next_appt_days	=	checkForNull(resultSet.getString("next_appt_days"));				
			} 
		 }
		 catch ( Exception e ) {
			 e.printStackTrace() ;
			 throw e ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			catch(Exception es) { es.printStackTrace();}
		 }
		return next_appt_days;
	}

	public void getFromToDate(String facility_id, String patient_class){// Change return type String to void and function name getToDate to getFromToDate for SRR20056-SCF-7807[28329] //patient_class added for  AMS-CRF-0009[IN:030935]
		Connection connection	= null ;
		 PreparedStatement pstmt = null ;
		 ResultSet resultSet		= null;
		String to_date		=	"";
		String from_date	= ""; //add this variable for SRR20056-SCF-7807[28329]

		try{
			connection	= getConnection() ;
			if(patient_class.equals("IP")) //if block and else condition added for  AMS-CRF-0009[IN:030935]
				pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_SELECT_DISP_ORDER_DATE_RANGE_IP") ) ;
			else
				pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_REG_PRESCRIPTIONS_SELECT20") ) ;
			pstmt.setString(1,facility_id);
			resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				//Comment and add following lines for SRR20056-SCF-7807[28329]
			// to_date	=	resultSet.getString("SYS_DATE_TIME");
				from_date	=	resultSet.getString("FROM_DATE");
				to_date		=	resultSet.getString("TO_DATE");
				setDispExpOrders(checkForNull(resultSet.getString("DISP_EXPIRIED_ORDERS"),"Y")); //Added for ML-BRU-SCF-0636 [IN:036826]
				setFromDate(from_date);
				setToDate(to_date);		
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}
		// return to_date;	//Comment this lines for SRR20056-SCF-7807[28329]
	}

	public void getModified_date(String order_id){
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		String to_date		=	"";

		try{
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement( "select TO_CHAR(MODIFIED_DATE,'DDMMYYYYHH24MISS') MODIFIED_DATE_TIME from or_order where order_id =?" ) ;
			pstmt.setString(1,order_id);
			resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				to_date	=	resultSet.getString("MODIFIED_DATE_TIME");	
				this.order_id_modified_date.put(order_id,to_date);
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace();
			}
		}		
	}

/*public void getAllowShortexpiary_yn(){
		Connection connection	= null ;
 PreparedStatement pstmt = null ;
 ResultSet resultSet		= null;
		String allow_short_expiry_drugs_yn		=	"";

		try{
			connection	= getConnection() ;
		// pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_REG_PRESCRIPTIONS_SELECT20") ) ;
 pstmt		= connection.prepareStatement("select ALLOW_SHORT_EXPIRY_DRUGS_YN from ph_facility_param where facility_id=?");
			pstmt.setString(1,login_facility_id);
 resultSet	= pstmt.executeQuery() ;
			if (resultSet.next()){
				this.allow_short_expiry_drugs_yn	=	resultSet.getString("ALLOW_SHORT_EXPIRY_DRUGS_YN");				
			}
		}
		catch(Exception e){
			System.out.println(e);
		}finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				System.err.println("Error::"+es);
			}
		}
	}*/

	public HashMap getDispensePeriod(String strDispenseLocation) throws Exception{
		
		HashMap hmDispensePeriod = null;
		Connection connection	= null ;
		PreparedStatement pstmt	= null ;
		ResultSet resultSet		= null;

		try {
			connection = getConnection() ;
// SQL -> REP
			pstmt = connection.prepareStatement("SELECT OP_DISP_PERIOD,IP_FILL_PRD_AHEAD, IP_FILL_PRD_UNIT, IP_FILL_DISP_PRD, IP_FILL_DISP_PRD_UNIT FROM PH_DISP_LOCN WHERE FACILITY_ID=? AND DISP_LOCN_CODE=? ") ; // added , IP_FILL_DISP_PRD, IP_FILL_DISP_PRD_UNIT for SRR20056-CRF-0663
			
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,strDispenseLocation);		
			resultSet = pstmt.executeQuery() ;

			if ( resultSet != null && resultSet.next() ) {
				hmDispensePeriod = new HashMap();
				hmDispensePeriod.put("OP_DISP_PERIOD",resultSet.getString("OP_DISP_PERIOD"));
				hmDispensePeriod.put("IP_FILL_PRD_AHEAD",resultSet.getString("IP_FILL_PRD_AHEAD"));
				hmDispensePeriod.put("IP_FILL_PRD_UNIT",resultSet.getString("IP_FILL_PRD_UNIT"));				
				hmDispensePeriod.put("IP_FILL_DISP_PRD",resultSet.getString("IP_FILL_DISP_PRD")); //added for SRR20056-CRF-0663		
				hmDispensePeriod.put("IP_FILL_DISP_PRD_UNIT",resultSet.getString("IP_FILL_DISP_PRD_UNIT"));	//added for SRR20056-CRF-0663
			}
		 }
		 catch ( Exception e ) {
			 e.printStackTrace() ;
			 throw e ;
		 }
		 finally {
			 try {
				 closeResultSet( resultSet ) ;
				 closeStatement( pstmt ) ;
				 closeConnection( connection );
			 }
			 catch(Exception es) { es.printStackTrace();}
		 }
		return hmDispensePeriod;
	}

	public ArrayList getOrderingFacilityId(String p_user_name) {
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null ;
		ArrayList result=new ArrayList();
		try {
			connection = getConnection() ;
			//pstmt = connection.prepareStatement( PhRepository.getPhKeyValue( "SQL_PH_DISPLOCN_SELECT" )) ;
			//pstmt = connection.prepareStatement("SELECT B.FACILITY_ID FACILITY_ID,B.FACILITY_NAME FACILITY_NAME FROM SM_FACILITY_FOR_USER A, SM_FACILITY_PARAM_LANG_VW B WHERE A.FACILITY_ID = B.FACILITY_ID AND B.STATUS ='E' AND APPL_USER_ID = ? AND B.LANGUAGE_ID= ?") ; //commented and added below sql for 033992 - [PH -> ReRoute -> Ordering Facility is not shown in Verification stage]
			pstmt = connection.prepareStatement("SELECT FACILITY_ID ,FACILITY_NAME  FROM  SM_FACILITY_PARAM_LANG_VW  WHERE STATUS ='E'AND LANGUAGE_ID= ? order by FACILITY_NAME") ;
			//pstmt.setString(1,p_user_name); //Commented for 033992 //order by added for ML-BRU-SCF-1517 [IN:053108]
			pstmt.setString(1,getLanguageId());

			resultSet = pstmt.executeQuery() ;
			while (resultSet.next()) {
				result.add(resultSet.getString("FACILITY_ID"));
				result.add(resultSet.getString("FACILITY_NAME"));
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
			result.add(e.toString());
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es) {
				es.printStackTrace() ;
			}
		}
		return result;
	}
	
	public ArrayList getNextCollectionDate(String strOrderId){
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null ;

		//String strNextCollectionDate = null;
		ArrayList alBMSdtl = new ArrayList();
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement("select (CASE WHEN next_collection_date is not null and trunc(next_collection_date) < trunc(sysdate)  THEN to_char((sysdate+1),'dd/mm/yyyy') when next_collection_date is null then to_char((sysdate+1),'dd/mm/yyyy') else to_char(next_collection_date,'dd/mm/yyyy') END) next_collection_date,BMS_REASON_CODE from OR_ORDER_LINE_PH WHERE ORDER_ID = ? ") ;//Query changed for ML-BRU-SCF-1224 [IN:046574]
			pstmt.setString(1,strOrderId);

			resultSet = pstmt.executeQuery() ;
			while (resultSet.next()) {
				alBMSdtl.add(resultSet.getString("NEXT_COLLECTION_DATE"));
				alBMSdtl.add(resultSet.getString("BMS_REASON_CODE"));
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es) {
				es.printStackTrace() ;
			}
		}
		return alBMSdtl;
	}

	public ArrayList getTokenNumberDetails(String sPatientId){
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null ;
		ArrayList alReturnValues = null;

		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement("SELECT to_char( a.queue_date,'dd/mm/yyyy') QUEUE_DATE, a.token_series_code TOKEN_SERIES_CODE, token_serial_no TOKEN_SERIAL_NO, b.description TOKEN_SERIES_DESC, d.short_desc TOKEN_STATUS FROM ph_disp_queue a, ph_token_series_lang_vw b, ph_disp_locn_lang_vw c, or_order_status_code_lang_vw d WHERE patient_id = ? AND a.token_series_code = b.token_series_code AND a.queue_date = to_date(?,'dd/mm/yyyy') AND a.facility_id = b.facility_id AND a.disp_locn_code = b.disp_locn_code AND A.queue_shift = '*ALL' and a.disp_locn_code = ? AND a.disp_locn_code = c.disp_locn_code AND a.facility_id = c.facility_id AND d.order_status_code(+) = a.token_status And token_status not in('DP','DF') and a.DELIVER_DATE_TIME is null AND b.language_id = ? AND c.language_id = ? AND d.language_id(+) = ? and ph_check_dc_token_status(a.facility_id,a.disp_locn_code,a.queue_date, a.queue_shift,a.token_series_code,a.token_serial_no)='N' ORDER BY c.short_desc,a.queue_date, a.token_serial_no") ;
			pstmt.setString(1,sPatientId);
			pstmt.setString(2,this.queue_date);
			pstmt.setString(3,disp_locn_code);
			pstmt.setString(4,getLanguageId());
			pstmt.setString(5,getLanguageId());
			pstmt.setString(6,getLanguageId());

			resultSet = pstmt.executeQuery() ;
			alReturnValues = new ArrayList();
			while (resultSet.next()) {
				alReturnValues.add(resultSet.getString("QUEUE_DATE"));
				alReturnValues.add(resultSet.getString("TOKEN_SERIES_DESC"));
				alReturnValues.add(resultSet.getString("TOKEN_SERIAL_NO"));
				alReturnValues.add(resultSet.getString("TOKEN_STATUS"));
				//alReturnValues.add(resultSet.getString("TOKEN_SERIES_CODE"));

			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es) {
				es.printStackTrace() ;
			}
		}
		return alReturnValues;
	
	}

	public String getLockStatus(String patient_id,String disp_locn_code,String login_user,String disp_stage)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		String Lock_status="";
		try {
			connection	= getConnection() ;
			pstmt = connection.prepareStatement(" SELECT COUNT(*) COUNT_PATIENT FROM PH_LOCK_DISP_RECORDS WHERE PATIENT_ID=? and DISP_LOCN_CODE=? and STAGE_ID=? AND USER_ID <> ?") ; //added "AND USER_ID <> ?" for SKR-SCF-0330 ICN 29789

			// pstmt = connection.prepareStatement("SELECT (CASE WHEN COUNT(*)>0 THEN 0 ELSE 1 END) COUNT_PATIENT FROM PH_LOCK_DISP_RECORDS WHERE PATIENT_ID=? and DISP_LOCN_CODE=? AND USER_ID=? and STAGE_ID=?") ;
				pstmt.setString(1, patient_id.trim());
				pstmt.setString(2, disp_locn_code);
				pstmt.setString(3, disp_stage);
				pstmt.setString(4, login_user); //added for	SKR-SCF-0330 ICN 29789

				resultSet = pstmt.executeQuery() ;
				if(resultSet!=null && resultSet.next()){
					Lock_status =resultSet.getString("COUNT_PATIENT");
				}
				

		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
		}
		return Lock_status;		
	}

	public String getLockStatus_Delivery_stage(String patient_id,String disp_locn_code,String login_user,String disp_stage)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		String Lock_status="";
		try {
			connection	= getConnection() ;
			pstmt = connection.prepareStatement(" SELECT COUNT(*) COUNT_PATIENT FROM PH_LOCK_DISP_RECORDS WHERE PATIENT_ID=? and DISP_LOCN_CODE=? and STAGE_ID=? AND USER_ID <> ?") ;
			// pstmt = connection.prepareStatement("SELECT (CASE WHEN COUNT(*)>0 THEN 0 ELSE 1 END) COUNT_PATIENT FROM PH_LOCK_DISP_RECORDS WHERE PATIENT_ID=? and DISP_LOCN_CODE=? AND USER_ID=? and STAGE_ID=?") ;
				pstmt.setString(1, patient_id.trim());
				pstmt.setString(2, disp_locn_code);
				pstmt.setString(3, disp_stage);
				pstmt.setString(4, login_user);
				
				resultSet = pstmt.executeQuery() ;
				if(resultSet!=null && resultSet.next()){
					Lock_status =resultSet.getString("COUNT_PATIENT");
				}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection ); 
		}
		return Lock_status;		
	}

	public String getLockStatus1(String login_user,String patient_id,String disp_locn_code,String disp_stage,String patient_id_status)throws Exception{
		Connection connection	= null;
		CallableStatement cstmt =null;
		ResultSet resultSet		= null;
		String Lock_status="";

		try {
			connection	= getConnection() ;
			cstmt=connection.prepareCall("{call PH_DISP_TRAN_LOCK_STATUS(?,?,?,?,?,?,?,?,?)}");
			cstmt.setString(1, login_user.trim());
				cstmt.setString(2, patient_id.trim());
				cstmt.setString(3, disp_locn_code);
				cstmt.setString(4, disp_stage);
				cstmt.setString(5, login_user);
				cstmt.setString(6, login_at_ws_no);
				cstmt.setString(7, patient_id_status);
				cstmt.setString(8, "N");
				cstmt.registerOutParameter(9,Types.VARCHAR);
				
				cstmt.execute();
				Lock_status = cstmt.getString(9);
				

		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( cstmt ) ;
				closeConnection( connection ); 
		}
		return Lock_status;		
	}

 public String geticonUnlock(String login_user,String patient_id,String disp_locn_code,String disp_stage,String patient_id_status,String p_delivery_fill_yn)throws Exception{
		
		Connection connection	= null;
		CallableStatement cstmt =null;
		String Lock_status="";

		try {
			connection	= getConnection() ;
				cstmt=connection.prepareCall("{call PH_DISP_TRAN_LOCK_STATUS(?,?,?,?,?,?,?,?,?)}");
			cstmt.setString(1, login_user.trim());
				cstmt.setString(2, patient_id.trim());
				cstmt.setString(3, disp_locn_code);
				cstmt.setString(4, disp_stage);
				cstmt.setString(5, login_user);
				cstmt.setString(6, login_at_ws_no);
				cstmt.setString(7, patient_id_status);
				cstmt.setString(8, p_delivery_fill_yn); 
				cstmt.registerOutParameter(9,Types.VARCHAR);
				cstmt.execute();
				Lock_status = cstmt.getString(9);
				

		}catch ( Exception e ) {
			e.printStackTrace() ;
			e.getMessage();
		}
		finally {
				closeStatement( cstmt ) ;
				closeConnection( connection ); 
		}
		return Lock_status;		
	}


	public String getUnlockRecordsDelivery(String login_user,String patient_id,String disp_locn_code,String disp_stage,String patient_id_status,String p_delivery_fill_yn)throws Exception{
		
		Connection connection	= null;
		CallableStatement cstmt =null;
		PreparedStatement pstmt = null ;
		ResultSet resultSet1	= null;
		ResultSet resultSet 	= null;
		String Lock_status ="";
		String patient_id_status_yn="";	
		try {
			connection	= getConnection() ;
				pstmt = connection.prepareStatement("SELECT COUNT (*) count FROM ph_lock_disp_records WHERE patient_id = ? AND disp_locn_code = ? AND stage_id = ?") ;
				pstmt.setString(1, patient_id.trim());
				pstmt.setString(2, disp_locn_code);
				pstmt.setString(3, disp_stage);
								
				resultSet1 = pstmt.executeQuery() ;
				if(resultSet1!=null && resultSet1.next()){
					patient_id_status_yn =resultSet1.getString("count");
				}
				if(patient_id_status_yn.equals("1")){
					patient_id_status="Y";
				}
				else if(patient_id_status_yn.equals("0")){
					patient_id_status="N";
				}
 
			cstmt=connection.prepareCall("{call PH_DISP_TRAN_LOCK_STATUS(?,?,?,?,?,?,?,?,?)}");
			cstmt.setString(1, login_user.trim());
				cstmt.setString(2, patient_id.trim());
				cstmt.setString(3, disp_locn_code);
				cstmt.setString(4, disp_stage);
				cstmt.setString(5, login_user);
				cstmt.setString(6, login_at_ws_no);
				cstmt.setString(7, patient_id_status);
				cstmt.setString(8, p_delivery_fill_yn); 
				cstmt.registerOutParameter(9,Types.VARCHAR);
				cstmt.execute();
				Lock_status = cstmt.getString(9);
				

		}catch ( Exception e ) {
			e.printStackTrace() ;
			e.getMessage();
		}
		finally {
				closeResultSet( resultSet ) ;
				closeResultSet( resultSet1 ) ;
				closeStatement( cstmt ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
		}
		return Lock_status;		
	}
 
	public ArrayList getAccessRightStatus(String login_user,String patient_id,String disp_locn_code,String disp_stage)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		ArrayList AccessRightStatus = new ArrayList();
		try {
			connection	= getConnection() ;
			pstmt = connection.prepareStatement("SELECT USER_ID,TO_CHAR(LOCKED_DATE_TIME,'DD/MM/YYYY HH24:MI') LOCKED_DATE_TIME FROM PH_LOCK_DISP_RECORDS WHERE PATIENT_ID=? and DISP_LOCN_CODE=? and STAGE_ID=?");
				pstmt.setString(1, patient_id.trim());
				pstmt.setString(2, disp_locn_code);
				pstmt.setString(3, disp_stage);
				
				resultSet = pstmt.executeQuery() ;
				if(resultSet!=null && resultSet.next()){
					HashMap rec		=	new HashMap();
					String user_id,locked_date_time;
				user_id					=	resultSet.getString("USER_ID");
				locked_date_time		=	resultSet.getString("LOCKED_DATE_TIME");
				rec.put("user_id",user_id);
				rec.put("locked_date_time",locked_date_time);
				AccessRightStatus.add(rec);
			}
		
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
		}
		return AccessRightStatus;		
	}

 /* public String getUnLockRecordsYN(String login_user,String disp_locn_code)throws Exception{
		Connection connection	= null;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null;
		String unlock_all_records_yn="";
		try {
 connection	= getConnection() ;
			pstmt = connection.prepareStatement("SELECT UNLOCK_ALL_RECORDS_YN FROM PH_DISP_RIGHTS WHERE APPL_USER_ID=? AND DISP_LOCN_CODE=?") ;
				pstmt.setString(1, login_user.trim());
				pstmt.setString(2, disp_locn_code);
								
				resultSet = pstmt.executeQuery() ;
				if(resultSet!=null && resultSet.next()){
					unlock_all_records_yn =resultSet.getString("UNLOCK_ALL_RECORDS_YN");
				}
				

		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
		}
		return unlock_all_records_yn;		
	}
 */
 /* public String getAllowdisprecordlock(String facility_id)throws Exception{
		Connection connection	= null;
 PreparedStatement pstmt	= null;
 ResultSet resultSet		= null;
		String allow_disp_record_lock_yn = "";
		try {
 connection	= getConnection() ;
			//pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_IP_FILL_PROCESS_SELECT37"));
			pstmt		= connection.prepareStatement("SELECT DECODE(ALLOW_DISP_RECORD_LOCK_YN,NULL,'N',ALLOW_DISP_RECORD_LOCK_YN) ALLOW_DISP_RECORD_LOCK_YN FROM PH_FACILITY_PARAM WHERE FACILITY_ID=?");
			pstmt.setString(1,facility_id);
			resultSet	= pstmt.executeQuery() ;
			if (resultSet!=null && resultSet.next()){
				allow_disp_record_lock_yn = resultSet.getString("ALLOW_DISP_RECORD_LOCK_YN");
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
		}
		return allow_disp_record_lock_yn;		
	}	*/

	public String getFreqRepeatCode(String sOrderId, String sOrderLineNo){
		String PH_GET_FREQ_REPEAT_CODE = "select  REPEAT_DURN_TYPE, DURN_TYPE,REPEAT_VALUE,b.FREQ_CODE,DURN_VALUE,ROUTE_CODE,QTY_VALUE,QTY_UNIT from am_frequency a, or_order_line b where B.ORDER_ID = ? and B.ORDER_LINE_NUM = ? and A.FREQ_CODE = B.FREQ_CODE"; //repeat-value addedf or  ML-MMOH-CRF-1408,modified for MOHE-CRF-0026.1
		Connection oConnection			= null;
		ResultSet oResultSet				= null;
		PreparedStatement oPrepStatement	= null;
		String sFreqRepeatCode				= "D~D";
		try {
			oConnection	= getConnection() ;
			oPrepStatement	= oConnection.prepareStatement(PH_GET_FREQ_REPEAT_CODE);

			oPrepStatement.setString(1,sOrderId);
			oPrepStatement.setString(2,sOrderLineNo);
			oResultSet	= oPrepStatement.executeQuery();

			if(oResultSet!=null && oResultSet.next()){
				sFreqRepeatCode	= oResultSet.getString("REPEAT_DURN_TYPE")+"~"+oResultSet.getString("DURN_TYPE")+"~"+oResultSet.getString("REPEAT_VALUE")+"~"+oResultSet.getString("FREQ_CODE")+"~"+oResultSet.getString("DURN_VALUE")+"~"+oResultSet.getString("ROUTE_CODE")+"~"+oResultSet.getString("QTY_VALUE")+"~"+oResultSet.getString("QTY_UNIT"); //repeat-value added for  ML-MMOH-CRF-1408,MODIFIED FOR MOHE-CRF-0026.1 
			}
		}
		catch ( Exception e ){
			e.printStackTrace() ;
		}
		finally{
			try{
				closeResultSet( oResultSet ) ;
				closeStatement( oPrepStatement ) ;
				closeConnection( oConnection ); 
			}catch ( Exception e ){
				e.printStackTrace() ;
			}
		}
		return sFreqRepeatCode;		
	}

	public boolean checkValidFlow(String sDispLocnCategory, String sDispLocn){
		boolean bValidFlow = false;

		String PH_VALID_FOR_VERIFICATION = "";

		String PH_VALID_FOR_VERIFICATION_OP = "SELECT 'VALID' FROM ph_disp_locn_lang_vw a, ph_disp_rights b WHERE a.facility_id = ? AND b.facility_id = a.facility_id AND a.disp_locn_code = ? AND upper(b.appl_user_id) = upper(?) AND a.disp_locn_code = b.disp_locn_code AND a.language_id = ? and DISP_VERF_STAGE != 'C' AND VERIFY_YN = 'Y'";

		String PH_VALID_FOR_VERIFICATION_IP = "SELECT 'VALID' FROM ph_disp_locn_lang_vw a, ph_disp_rights b, PH_facility_param c WHERE a.facility_id = ? AND b.facility_id = a.facility_id AND b.facility_id = c.facility_id AND a.disp_locn_code = ? AND upper(b.appl_user_id) = upper(?) AND a.disp_locn_code = b.disp_locn_code AND a.language_id = ? and IP_VERIFY_YN = 'Y' AND c.IP_VERF_YN = 'Y' and a.IP_VERF_YN = 'Y'";

		Connection oConnection			= null;
		ResultSet oResultSet				= null;
		PreparedStatement oPrepStatement	= null;

		if(sDispLocnCategory != null){
			if( sDispLocnCategory.equals("I")){
				PH_VALID_FOR_VERIFICATION = PH_VALID_FOR_VERIFICATION_IP;
			}
			else if( sDispLocnCategory.equals("O")){
				PH_VALID_FOR_VERIFICATION = PH_VALID_FOR_VERIFICATION_OP;
			}
			else 
				return bValidFlow;
			try{
				oConnection	= getConnection() ;
				oPrepStatement	= oConnection.prepareStatement(PH_VALID_FOR_VERIFICATION);
				oPrepStatement.setString(1,login_facility_id.trim());
				oPrepStatement.setString(2,sDispLocn);
				oPrepStatement.setString(3,login_by_id); // getApplPassword() actually returning appl_user_id 
				oPrepStatement.setString(4,getLanguageId());
				oResultSet	= oPrepStatement.executeQuery();
				if(oResultSet!=null && oResultSet.next())
					bValidFlow = true;
			}
			catch ( Exception e ){
				e.printStackTrace() ;
			}
			finally{
				try{
					closeResultSet( oResultSet ) ;
					closeStatement( oPrepStatement ) ;
					closeConnection( oConnection ); 
				}
				catch ( Exception e ){
					e.printStackTrace() ;
				}
			}
		}
		return bValidFlow;
	}

	public HashMap getPPNIOrderValues(String OrderId, String sPatientId, String sDispLocnCode,String dischargeIND){
		Connection			oConnection				= null;
		PreparedStatement	oPreparedStmt			= null; 		
		ResultSet			oResultSet				= null;
		HashMap				hmPPNStoredValues				= null;
		sDispLocnCode = sDispLocnCode==null?getDispLocnCode().trim():sDispLocnCode;
		try {
			oConnection	= getConnection() ;
			String sSQL = "select A.ITEM_CODE ITEM_CODE ,SHORT_NAME, BATCH_ID, DISP_QTY, TRADE_ID, DISP_NO,DISP_QTY_UOM,TO_CHAR(EXPIRY_DATE,'DD/MM/YYYY') EXPIRY_DATE ,BIN_LOCATION_CODE, ORDER_ID, (select ORD_PRACT_ID from OR_ORDER where ORDER_id = a.order_id) ORD_PRACT_ID from ph_ppn_orders A, PH_TPN_REGIMEN B where facility_id = ? AND order_id =? and patient_id =? AND B.TPN_REGIMEN_CODE= A.ITEM_CODE"; // , (select ORD_PRACT_ID from OR_ORDER where ORDER_id = a.order_id) ORD_PRACT_ID added for SRR20056-SCF-7373
			oPreparedStmt		= oConnection.prepareStatement(sSQL);
			oPreparedStmt.setString(1,login_facility_id);			
			oPreparedStmt.setString(2,OrderId);			
			oPreparedStmt.setString(3,sPatientId);			
			//oPreparedStmt.setString(4,getDispLocnCode().trim());			
			oResultSet	= oPreparedStmt.executeQuery() ;
			if(oResultSet !=null && oResultSet.next()){		
				hmPPNStoredValues = new HashMap();
				StringBuffer sbBatchString = new StringBuffer();
				HashMap hmItemCost	= null;

				hmPPNStoredValues.put("itemCode",oResultSet.getString("ITEM_CODE"));
				hmPPNStoredValues.put("itemDesc",oResultSet.getString("SHORT_NAME"));
				hmPPNStoredValues.put("batchId",oResultSet.getString("BATCH_ID"));
				hmPPNStoredValues.put("tradeId",oResultSet.getString("TRADE_ID"));
				hmPPNStoredValues.put("mfgId",oResultSet.getString("SHORT_NAME"));
				hmPPNStoredValues.put("UOMCode",oResultSet.getString("DISP_QTY_UOM"));
				hmPPNStoredValues.put("orderId",OrderId);
				hmPPNStoredValues.put("patientId",sPatientId);
				hmPPNStoredValues.put("selectedQty",oResultSet.getString("DISP_QTY"));
				hmPPNStoredValues.put("expiryDate",oResultSet.getString("EXPIRY_DATE"));
				hmPPNStoredValues.put("binLocation",oResultSet.getString("BIN_LOCATION_CODE"));
				hmPPNStoredValues.put("ORD_PRACT_ID",oResultSet.getString("ORD_PRACT_ID")); // added for SRR20056-SCF-7373

				float fGrossPatPayable	= 0;
				float fItemCost			= 0;
				if(objAllStages.getBLInterfaceYN().equals("Y")){//checkforbillinginterface
					sbBatchString.append(oResultSet.getString("TRADE_ID")).append(";").append(oResultSet.getString("BATCH_ID")).append(";").append(oResultSet.getString("EXPIRY_DATE")).append(";").append(oResultSet.getString("BIN_LOCATION_CODE")).append(";").append(oResultSet.getString("DISP_QTY")).append(";");

					hmItemCost = objAllStages.callItemChargeDtls(sPatientId,encounter_id,objAllStages.getEncounterPatientClass(encounter_id, sPatientId),oResultSet.getString("ITEM_CODE"),Double.parseDouble(oResultSet.getString("DISP_QTY")),sbBatchString.toString(),getTodaysDate(),getDispLocnCode().trim(),"","",oResultSet.getString("ORDER_ID"),"1",getDispStage(),dischargeIND); // sPatientId for getEncounterPatientClass added for [IN:035667] 

					if(hmItemCost!=null && hmItemCost.get("error_msg").equals("")){
					//	String sFormatString	= (String)hmItemCost.get("BL_DECIMAL_FORMAT_STRING"); Removed for IN063877
						//DecimalFormat dfTest = new DecimalFormat(sFormatString);
						if(!hmItemCost.get("patnetamt").equals("null")){
							fGrossPatPayable = Float.parseFloat(((String)hmItemCost.get("patnetamt")).trim());
							if(fGrossPatPayable >0){
								fItemCost		= fGrossPatPayable/ Float.parseFloat(oResultSet.getString("DISP_QTY"));
							}
						}
					}
				}
				hmPPNStoredValues.put("itemCost",fItemCost+"");
				hmPPNStoredValues.put("grossCost",fGrossPatPayable+"");
				hmPPNStoredValues.put("billingError",hmItemCost.get("error_msg"));
			}
		}

		catch ( Exception e ) {
			e.printStackTrace() ;			
		}
		finally {
			try{
			closeResultSet( oResultSet ) ;
			closeStatement( oPreparedStmt ) ;			
			closeConnection( oConnection ); 
			}
			catch(Exception ex)
			{
				ex.printStackTrace() ;			
			}
		}
		setHmPPNValues(hmPPNStoredValues);
		return hmPPNStoredValues;
	}

	public String getDispNoFromWorksheetId(String sWorksheetId, String sLocnCode){
		Connection oConnection		= null;
		ResultSet oResultSet			= null;
		Statement oStatement			= null;
		StringBuffer sbQuery			= new StringBuffer("select disp_no disp_no, patient_id patient_id FROM ph_disp_hdr where ");
		sbQuery.append(" WORKSHEET_ID = '"+sWorksheetId+"'");
		sbQuery.append(" and disp_locn_code = '"+sLocnCode+"' ");
		sbQuery.append(" union select to_char(DISP_TMP_NO) disp_no, patient_id patient_id FROM ph_disp_hdr_tmp where ");
		sbQuery.append(" WORKSHEET_ID = '"+sWorksheetId+"'");
		sbQuery.append(" and disp_locn_code = '"+sLocnCode+"' ");	
		String sDispNoPatId				= null;
		
		try {
			oConnection	= getConnection() ;
			oStatement	= oConnection.createStatement();
			oResultSet	= oStatement.executeQuery(sbQuery.toString());
			if(oResultSet!=null && oResultSet.next()){
				sDispNoPatId = oResultSet.getString("DISP_NO")+"~"+oResultSet.getString("PATIENT_ID");
			}
		}
		catch ( Exception e ){
			e.printStackTrace() ;
		}
		finally {
			try	{
				closeResultSet( oResultSet ) ;
				closeStatement( oStatement ) ;
				closeConnection( oConnection ); 
			}
			catch ( Exception e ){
				e.printStackTrace() ;
			}
		}

		return sDispNoPatId;
	}

	public boolean checkBMS(String sOrderId, HashMap hmOrderLineBMS){
		Connection oConnection		= null;
		ResultSet oResultSet			= null;
		PreparedStatement oPreparedStmt	= null;
		boolean bBMSAvailable			= true;
		String sQuery					= "select ((b.order_qty * d.CONTENT_IN_PRES_BASE_UOM) - pres_qty_value) DIFFERENCE, b.ORDER_LINE_NUM order_line_num from or_order a, or_order_line b, or_order_line_ph c, ph_drug d where a.order_id = b.order_id and a.order_id = c.order_id and b.ORDER_LINE_NUM = c.ORDER_LINE_NUM and b.ORDER_CATALOG_CODE = d.drug_code and a.order_id = ?";
		String sOrderLineNo				= "";
		
		try{
			oConnection	= getConnection() ;
			oPreparedStmt	= oConnection.prepareStatement(sQuery);
			oPreparedStmt.setString(1,sOrderId);	

			oResultSet	= oPreparedStmt.executeQuery();

			if(oResultSet!=null){
				while(oResultSet.next()){
					sOrderLineNo = oResultSet.getString("ORDER_LINE_NUM");
					if(hmOrderLineBMS.get(sOrderLineNo)!=null){
						if(	Double.parseDouble(hmOrderLineBMS.get(sOrderLineNo).toString()) <= Double.parseDouble(oResultSet.getString("DIFFERENCE"))){
							bBMSAvailable = false;
							break;
						}
					}
				}
			}
		}
		catch ( Exception e ){
			e.printStackTrace() ;
		}
		finally{
			try{
				closeResultSet( oResultSet ) ;
				closeStatement( oPreparedStmt ) ;
				closeConnection( oConnection ); 
			}
			catch ( Exception e ){
				e.printStackTrace() ;
			}
		}

		return bBMSAvailable;
	}

	public void setDurations(String sOrderId){
		Connection oConnection						= null;
		ResultSet oResultSet						= null;
		ResultSet oResultSetForDuration				= null;
		ResultSet oResultSetForOrderIds				= null;
		PreparedStatement oPreparedStmt				= null;
		PreparedStatement oPreparedStmtForDuration	= null;
		PreparedStatement oPreparedStmtForOrderIds	= null;
		String sQuery								= "";
		StringBuffer sbOrderIds						= new StringBuffer("'");
		String sDurnType							= "D";
		int iDurnValue								= 999;
		Set stTrxIds								= new HashSet();
		boolean bProceed							= true;
		String sTransSeqNo							= "";
		try{
			oConnection	= getConnection() ;
			if(getDispLevelValue().equals("P"))	{
				// Get the order ids in a list and convert to a set to remove duplicates
				List lstTrxIds = getAlTrxOrderIds();
				stTrxIds = new HashSet(lstTrxIds);
				Iterator iteTrxIds = stTrxIds.iterator();

				while(iteTrxIds.hasNext()){
					sOrderId = (String)iteTrxIds.next();
					sbOrderIds.append(sOrderId).append("','");
				}
				sbOrderIds.delete(sbOrderIds.length()-2,sbOrderIds.length());
				sQuery = "SELECT distinct disp_trn_seq_no IDS FROM ph_disp_hdr_tmp WHERE order_id IN ( "+sbOrderIds.toString()+" ) and rownum<2 order by disp_trn_seq_no desc";
			}
			else{
				sQuery	= "SELECT order_id IDS FROM ph_disp_hdr_tmp WHERE disp_trn_seq_no = (SELECT disp_trn_seq_no FROM ph_disp_hdr_tmp WHERE order_id ='"+sOrderId+"' and rownum<2 order by disp_trn_seq_no desc)";
			}
			if(sbOrderIds.length() == 0)
				sbOrderIds.append("'").append(sOrderId).append("'");

			oPreparedStmt	= oConnection.prepareStatement(sQuery);
			oResultSet	= oPreparedStmt.executeQuery();

			if(oResultSet!=null && oResultSet.next()){
				if(getDispLevelValue().equals("P")) {
					sTransSeqNo = oResultSet.getString("IDS");
				}

				if(oResultSet.next()){ // means its returning more than one order id or transaction seq no.
					this.bEditValues = false;
					bProceed		= false;
				}
				else if(getDispLevelValue().equals("P")){
					oPreparedStmtForOrderIds = oConnection.prepareStatement("Select order_id from ph_disp_hdr_tmp where DISP_TRN_SEQ_NO = '"+sTransSeqNo+"'");
					oResultSetForOrderIds = oPreparedStmtForOrderIds.executeQuery();

					if(oResultSetForOrderIds!= null){
						while(oResultSetForOrderIds.next())	{
							if(stTrxIds.size() == 0){
								this.bEditValues = false;
								bProceed		= false;
								break;
							}
							if(!stTrxIds.remove(oResultSetForOrderIds.getString("ORDER_ID"))){
								this.bEditValues = false;
								bProceed		= false;
								break;
							}
						}
					}
				}
			}
			if(stTrxIds.size() == 0 && bProceed){
				oPreparedStmtForDuration = oConnection.prepareStatement("SELECT alloc_for_durn_unit, alloc_for_durn FROM ph_disp_hdr_tmp WHERE order_id in ("+sbOrderIds.toString()+") and alloc_for_durn is not null ");
				oResultSetForDuration = oPreparedStmtForDuration.executeQuery();

				if(oResultSetForDuration != null){
					if(oResultSetForDuration.next()){
						sDurnType = oResultSetForDuration.getString("ALLOC_FOR_DURN_UNIT");
						iDurnValue = Integer.parseInt(oResultSetForDuration.getString("ALLOC_FOR_DURN"));
					}
					else{
						sDurnType = "D";
						iDurnValue = 1;
					}
				}

				// This values used to set the values in the Header page
				setStrChangedDispenseUnit(sDurnType);
				setStrChangedDispensePeriod(iDurnValue+"");

				if(sDurnType.equals("W")){
					iDurnValue = iDurnValue * 7;
				}
				else if(sDurnType.equals("M")){
					iDurnValue = iDurnValue * 30;
				}
				else if(sDurnType == "H"){
					iDurnValue = Integer.parseInt(Math.ceil(iDurnValue/24)+"");
				}
				// Fill period in terms of Days
				setFillPeriod(iDurnValue+"");
				setFillUnit("D");

				this.bEditValues = true;
			}
			else
				this.bEditValues = false;
		}
		catch ( Exception e ){
			e.printStackTrace() ;
		}
		finally {
			try{
				closeResultSet( oResultSet ) ;
				closeResultSet( oResultSetForDuration ) ;
				closeStatement( oPreparedStmt ) ;
				closeStatement( oPreparedStmtForDuration ) ;
				closeConnection( oConnection ); 
			}
			catch ( Exception e ){
				e.printStackTrace() ;
			}
		}
	}

	public String getCustomerID()throws Exception	{
		Connection connection		= null;
		PreparedStatement pstmt		= null;
		ResultSet rsCustomerID		= null;
		String customer_id			= "";
		try {
			connection	= getConnection() ;
			pstmt = connection.prepareStatement("SELECT CUSTOMER_ID FROM SM_SITE_PARAM WHERE SITE_ID = 'DS'");
			rsCustomerID = pstmt.executeQuery();
			if(rsCustomerID.next()){
				customer_id = rsCustomerID.getString("CUSTOMER_ID")==null?"":rsCustomerID.getString("CUSTOMER_ID");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( rsCustomerID ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection ); 
		}
		return customer_id;
	}
//this function is used to check whether some drugs are already allocated?
// commented for SKR-SCF-0105
/*	public String Check_applicable_orders(HashMap OrderIDS)throws Exception{

		Connection connection		= null;
		PreparedStatement pstmt		= null;
		ResultSet rs				= null;
		String allow_yn				="Y";	
		try {
			connection	= getConnection() ;
			if((this.disp_stage.equals("F")&& this.fillingStatus.equals("B"))){
				pstmt = connection.prepareStatement("SELECT COUNT(*) cnt FROM OR_ORDER_LINE WHERE ORDER_ID =? and order_line_status in ('IP','AL')");
			}else if((this.disp_stage.equals("F")&& this.fillingStatus.equals("A"))){
				pstmt = connection.prepareStatement("SELECT COUNT(*)cnt FROM OR_ORDER_LINE WHERE ORDER_ID =? and order_line_status ='IP'");
				
			}else if(this.disp_stage.equals("A")&& this.fillingStatus.equals("B")){
				pstmt = connection.prepareStatement("SELECT COUNT(*)cnt FROM OR_ORDER_LINE WHERE ORDER_ID =? and order_line_status in ('AL')");				
			}else if(this.disp_stage.equals("A")&& this.fillingStatus.equals("A")){
				pstmt = connection.prepareStatement("SELECT COUNT(*)cnt FROM OR_ORDER_LINE WHERE ORDER_ID =? and order_line_status in ('IP','AL')");

			}else{
				return allow_yn;

			}
						
			Iterator iteKeys			= OrderIDS.keySet().iterator();
			while (iteKeys.hasNext()){
				pstmt.setString(1, (String)iteKeys.next());
				rs = pstmt.executeQuery() ;
				if(rs!=null && rs.next()){
					if(Integer.parseInt(rs.getString("cnt"))>0){					
						allow_yn="N";
						break;
					}				
				}	
			}
		}catch ( Exception e ) {
			e.printStackTrace() ;
		}finally {
			closeResultSet( rs ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection ); 
		}
		return allow_yn;
	}
*/
	//method added for Delivery against Fill List medical items.
	public ArrayList getDispensedConsumableOrderDetailsForFillDelivery(String order_ids,String disp_locn_code ) { 
		Connection connection					=	null ;
		PreparedStatement pstmt					=	null ;
		ResultSet resultSet						=	null ; 
		PreparedStatement pstmt1				=	null ;
		ResultSet resultSet1					=	null ; 
		PreparedStatement pstmt2				=	null ;
		ResultSet resultSet2					=	null ; 
		HashMap item_det = new HashMap();
		HashMap batch_det = new HashMap();
		String order_id							=	"";
		String order_line_no					=	"";
		StringBuffer disp_trn_seq_nos			=	new StringBuffer();
		ArrayList cons_item_det					=	new ArrayList();
		String item_cost						= "", disp_trn_seq_no="";
 
		try{
			connection		= getConnection() ;
			String sql_str3="select DISP_TRN_SEQ_NO from ph_disp_hdr_tmp where order_id in(#) and facility_id=? and disp_locn_code=?" ;
			int index1 = sql_str3.indexOf("#");
			StringBuffer sb1 = new StringBuffer(sql_str3);
			sb1.replace(index1,index1+1,order_ids);
			sql_str3 = sb1.toString(); 

			pstmt1		= connection.prepareStatement( sql_str3) ;
			pstmt1.setString(1,login_facility_id);
			pstmt1.setString(2,disp_locn_code);
			resultSet1	= pstmt1.executeQuery() ;
			while( resultSet1.next()){
				if(disp_trn_seq_nos.length()!=0){
					disp_trn_seq_nos.append(",");
				}
				disp_trn_seq_no = checkForNull(resultSet1.getString("DISP_TRN_SEQ_NO"));
				if(!disp_trn_seq_no.equals(""))
					disp_trn_seq_nos.append("'").append(disp_trn_seq_no).append("'");
			}
			closeResultSet( resultSet1 ) ;
			closeStatement( pstmt1 ) ;

			if(disp_trn_seq_nos.length()>0){

				String sql_str ="SELECT a.DISP_TRN_SEQ_NO,b.order_id,a.doc_no doc_no ,b.ORDER_LINE_NO,b.ORDER_CONS_CODE,b.disp_no disp_no ,b.STATUS,b.SRL_NO SRL_NO,b.DISP_UOM_CODE DISP_UOM_CODE,c.SRL_NO_BATCH,d.long_desc long_desc,c.BATCH_ID BATCH_ID, TO_CHAR(c.EXPIRY_DATE, 'DD/MM/YYYY') EXPIRY_DATE, c.TRADE_ID TRADE_ID, c.DISP_QTY DISP_QTY, c.DISP_QTY_UOM, c.BIN_LOCATION_CODE BIN_LOCATION_CODE,c.store_code store_code, (SELECT short_name FROM am_trade_name_lang_vw WHERE trade_id = c.trade_id AND language_id = 'en') trade_name,(F.QTY_ON_HAND-F.COMMITTED_QTY) AVL_QTY FROM ph_disp_hdr_tmp a ,ph_disp_cons_dtl b ,ph_disp_cons_batch c,mm_item_lang_vw d,am_trade_name_lang_vw e, ST_ITEM_BATCH f WHERE a.facility_id = ? AND a.disp_locn_code = ? AND A. DISP_TRN_SEQ_NO IN (#) AND B.DISP_TRN_SEQ_NO =A.DISP_TRN_SEQ_NO AND C.FACILITY_ID = B.FACILITY_ID AND C.DISP_NO = B.DISP_NO AND C.SRL_NO = B.SRL_NO AND d.item_code = B.ORDER_CONS_CODE AND D.language_id =? AND f.STORE_CODE = C.STORE_CODE AND f.ITEM_CODE = C.CONS_CODE AND f.BATCH_ID = C.BATCH_ID AND f.BIN_LOCATION_CODE = C.BIN_LOCATION_CODE AND f.EXPIRY_DATE_OR_RECEIPT_DATE = C.EXPIRY_DATE and b.status <> 'DL' GROUP BY a.DISP_TRN_SEQ_NO,b.order_id,a.doc_no,b.ORDER_LINE_NO,b.ORDER_CONS_CODE,b.disp_no, b.STATUS,b.SRL_NO,b.DISP_UOM_CODE,c.SRL_NO_BATCH,d.long_desc ,c.BATCH_ID, c.EXPIRY_DATE, c.TRADE_ID, c.DISP_QTY, c.DISP_QTY_UOM, c.BIN_LOCATION_CODE,c.store_code, (f.qty_on_hand - f.committed_qty) ";		

				//String sql_str_2 ="select ORDER_QTY from or_order_line where order_id=? and ORDER_LINE_NUM =?";
				//pstmt2		= connection.prepareStatement( sql_str_2) ;

				int index = sql_str.indexOf("#");
				StringBuffer sb = new StringBuffer(sql_str);
				sb.replace(index,index+1,disp_trn_seq_nos.toString());
				sql_str = sb.toString(); 

				pstmt		= connection.prepareStatement( sql_str) ;
				pstmt.setString(1,login_facility_id);
				pstmt.setString(2,disp_locn_code);
				pstmt.setString(3,getLanguageId());

				resultSet	= pstmt.executeQuery() ;
				while(resultSet!=null && resultSet.next()){
					item_det = new HashMap();
					batch_det = new HashMap();

					order_id = resultSet.getString("order_id");
					order_line_no = resultSet.getString("ORDER_LINE_NO"); 
					/* pstmt2.setString(1,order_id);
					pstmt2.setString(2,order_line_no);
					resultSet2	= pstmt2.executeQuery() ;
					if(resultSet2!=null && resultSet2.next()){
						item_det.put("ORDER_QTY",resultSet2.getString("ORDER_QTY"));
					}else{*/
					item_det.put("ORDER_QTY","");
					// }
					item_det.put("DISP_NO",resultSet.getString("disp_no"));
					item_det.put("ORDER_ID",order_id);
					item_det.put("ORDER_LINE_NO",order_line_no);
					item_det.put("ORDER_CATALOG_CODE",resultSet.getString("ORDER_CONS_CODE"));
					item_det.put("ORDER_STATUS",resultSet.getString("STATUS"));				
					item_det.put("DISP_SRL_NO",resultSet.getString("SRL_NO"));
					item_det.put("ORDER_UOM",resultSet.getString("DISP_UOM_CODE"));
					item_det.put("TRADE_CODE",resultSet.getString("TRADE_ID"));
					item_det.put("BATCH_SRL_NO",resultSet.getString("SRL_NO_BATCH"));
					item_det.put("LONG_DESC",resultSet.getString("long_desc"));
					item_det.put("SELECTED_YN","Y");
					item_det.put("ALLOC_QTY",resultSet.getString("DISP_QTY"));
					item_det.put("FROM_ORDER_YN","N");
					item_det.put("DOC_NO",resultSet.getString("doc_no"));
					item_det.put("SELECTED_FROM_DISP_DAT_YN","Y");
					item_det.put("SELECTED_YN","Y");
					item_det.put("DISP_TRN_SEQ_NO",resultSet.getString("DISP_TRN_SEQ_NO"));
					batch_det.put("BATCH_ID",resultSet.getString("BATCH_ID"));
					batch_det.put("EXPIRY_DATE",resultSet.getString("EXPIRY_DATE"));
					batch_det.put("ITEM_CODE",resultSet.getString("ORDER_CONS_CODE"));				
					batch_det.put("TRADE_ID",resultSet.getString("TRADE_ID"));
					batch_det.put("BIN_LOCN_CODE",resultSet.getString("BIN_LOCATION_CODE"));
					batch_det.put("AVAIL_QTY",resultSet.getString("AVL_QTY"));
					batch_det.put("TRADE_DESC",checkForNull(resultSet.getString("trade_name")));
					batch_det.put("STORE_CODE",resultSet.getString("store_code"));
					item_cost = getItemCost(resultSet.getString("ORDER_CONS_CODE"),resultSet.getString("store_code"),resultSet.getString("DISP_QTY"),this.getTodaysDate());
					batch_det.put("ITEM_COST",item_cost);
					
					item_det.put("BATCH_DET",batch_det); 
					cons_item_det.add(item_det);
				}
			}
		}catch(Exception e){
			e.printStackTrace() ;	
		}finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;

				closeResultSet( resultSet1 ) ;
				closeStatement( pstmt1 ) ;

				closeResultSet( resultSet2 ) ;
				closeStatement( pstmt2 ) ;


				closeConnection( connection ); 
				}catch(Exception es){es.printStackTrace();}
		}
		return cons_item_det;
	}

	public String getPatient_name(String patient_id,String langid )throws Exception	{
		Connection connection		= null;
		PreparedStatement pstmt		= null;
		ResultSet rsCustomerID		= null;
		String patient_name			= "";
		try {
			connection	= getConnection() ;
			pstmt = connection.prepareStatement("select nvl(decode(?,'en',patient_name,PATIENT_NAME_LOC_LANG),patient_name) patient_name from mp_patient where patient_id =?");
			
			pstmt.setString(1,langid);
			pstmt.setString(2,patient_id);
			rsCustomerID = pstmt.executeQuery();
			
			if(rsCustomerID.next()){
				patient_name = rsCustomerID.getString("patient_name");
			}
				

			}catch ( Exception e ) {
					e.printStackTrace() ;
				}
				finally {
							closeResultSet( rsCustomerID ) ;
							closeStatement( pstmt ) ;
							closeConnection( connection ); 
						}
		return patient_name;
	}

	/* added for SRR20056-CRF-0663 --Start */

	public String getDispDfltDisplay( String sdisp_stage, String sfill_list, String sdisp_locn_code )throws Exception	{
		Connection connection		= null;
		PreparedStatement pstmt		= null;
		ResultSet rsDfltDisplayDtl		= null;
		String sfunction_id 	= null;
		String sDftDispDtl 	= null;

		if(sdisp_stage == null)
			sdisp_stage = "";
		if(sfill_list ==null)
			sfill_list = "";
		if(sdisp_locn_code == null)
			sdisp_locn_code = "";

		if(sdisp_stage.equals("V"))
			sfunction_id = "DISP_VERIFICATION";
		else if(sdisp_stage.equals("F") && sfill_list.equals("AF")) // Fill against fill list
			sfunction_id = "DISP_AGNST_FILL_LIST";
		else if(sdisp_stage.equals("F") && sfill_list.equals("WF"))	// Fill with out fill list
			sfunction_id = "DISP_WITHOUT_FILL_LIST";
		else if(sdisp_stage.equals("D") && sfill_list.equals("DWF"))	// Delivery with fill list
			sfunction_id = "DISP_AGNST_DELIVERY_LIST";
		else if(sdisp_stage.equals("D") && sfill_list.equals("DF"))	// Delivery without fill list
			sfunction_id = "DISP_WITHOUT_DELIVERY_LIST";

		try {
			connection	= getConnection() ;
			pstmt = connection.prepareStatement("SELECT PH_GET_DISP_DFLT_DISPLAY(?,?,?,?,?) DFLT_DISPLAY FROM dual");

			pstmt.setString(1,sfunction_id);
			pstmt.setString(2,login_facility_id);
			pstmt.setString(3,login_by_id);
			pstmt.setString(4,sdisp_locn_code);
			pstmt.setString(5,"IP");
			rsDfltDisplayDtl = pstmt.executeQuery();
			
			if(rsDfltDisplayDtl.next()){
				sDftDispDtl = rsDfltDisplayDtl.getString("DFLT_DISPLAY");
			}
		}catch ( Exception e ) {
				e.printStackTrace() ;
		}
		finally {
			closeResultSet( rsDfltDisplayDtl ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection ); 
		}
		if(sDftDispDtl==null || sDftDispDtl.equals("") || sDftDispDtl.equals("X"))
			setDispDfltDisplay_YN("N");
		else
			setDispDfltDisplay_YN("Y");
		return sDftDispDtl;
	}
	/* added for SRR20056-CRF-0663 --End*/

//added for SRR20056-SCF-7639 ICN027720 -start
	public void setBillingParams(String disp_locn_code, String patient_class){
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			 connection = getConnection() ;
			 pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT155") ) ;
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,disp_locn_code.trim());
			resultSet = pstmt.executeQuery() ;
			if ( resultSet.next() ) {
				if(patient_class!=null && patient_class.equals("OP")){
					setDispCashCollStage(resultSet.getString("DISP_CASH_COLL_STAGE_OP")==null?"X":resultSet.getString("DISP_CASH_COLL_STAGE_OP"));
					setDispBillStage(resultSet.getString("DISP_BILL_STAGE_OP")==null?"X":resultSet.getString("DISP_BILL_STAGE_OP"));
				}
				else{
					setDispCashCollStage(resultSet.getString("DISP_CASH_COLL_STAGE")==null?"X":resultSet.getString("DISP_CASH_COLL_STAGE"));
					setDispBillStage(resultSet.getString("DISP_BILL_STAGE")==null?"X":resultSet.getString("DISP_BILL_STAGE"));
									
				}
				setChargePatForSpillQtyYN( resultSet.getString("CHARGE_PAT_FOR_SPILL_QTY_YN")==null?"N":resultSet.getString("CHARGE_PAT_FOR_SPILL_QTY_YN"));

			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
	}
	//added for SRR20056-SCF-7639 ICN027720 -END

	// Added for ICN-30405
	public ArrayList getDefaultValues(String dispenseLocation){
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		ArrayList dflt_values	= new ArrayList();
		try {
				connection = getConnection() ;
  				pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_DISPENSING_RIGHTS_SELECT") ) ;
				pstmt.setString(1,login_facility_id.trim());
				pstmt.setString(2,login_by_id.trim());
				pstmt.setString(3,dispenseLocation.trim());
				resultSet = pstmt.executeQuery() ;
				while(resultSet!=null && resultSet.next()){		   // only one record
					dflt_values.add(checkForNull(resultSet.getString("DFLT_IP_FILL"),"AF"));
					dflt_values.add(checkForNull(resultSet.getString("DFLT_IP_DELIVER"),"DWF"));
				}
			}
			catch(Exception e){
				e.printStackTrace();
			}
			finally {
				try {
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}
				catch(Exception es) {
					es.printStackTrace();
				}
			}
			return dflt_values; 
	}
	// Till here  Added for ICN-30405
	//added for CRF
	public void setTabBasegGroupSortDisp(){
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_TAB_BASED_GROUP_SORT") ) ;
			pstmt.setString(1,login_facility_id.trim());
			resultSet = pstmt.executeQuery() ;
			if(resultSet!=null && resultSet.next()){
				this.tab_based_group_sort_disp =(checkForNull(resultSet.getString("TAB_BASED_GROUP_SORT_DISP"),"N")); //TAB_BASED_GROUP_SORT_DISP
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) { es.printStackTrace();}
		}
	}
	/*Added newly for the  ML-BRU-CRF-072[Inc:29938] start */
	public String getDrugIndication(String orig_order_id,String orig_order_line_no) {
		Connection connection	=	null ;
		PreparedStatement pstmt =	null ;
		ResultSet resultSet		=	null ;        
		String drug_indication	=   "";
		
		try{
			String sql_query ="select DRUG_INDICATION from or_order_line_ph where order_id=? and order_line_num=?"; 
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement(sql_query) ;
			pstmt.setString(1,orig_order_id);
			pstmt.setString(2,orig_order_line_no);
			resultSet			=   pstmt.executeQuery();
			while( resultSet != null && resultSet.next() ) {
				if(resultSet.getString("DRUG_INDICATION")!=null) {
						drug_indication=resultSet.getString("DRUG_INDICATION");
					}
			} 
			}catch(Exception e){
				 e.printStackTrace();
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){es.printStackTrace();
			}
		}
		return drug_indication;	
	}
	public String getAlternateDrugIndication(String drug_code) {
		Connection connection	=	null ;
		PreparedStatement pstmt =	null ;
		ResultSet resultSet		=	null ;        
		String drug_indication	=   "";
		
		try{
			String sql_query ="select DRUG_INDICATION from ph_drug_lang_vw where drug_code=?"; 
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement(sql_query) ;
			pstmt.setString(1,drug_code);
			resultSet			=   pstmt.executeQuery();
			while( resultSet != null && resultSet.next() ) {
				if(resultSet.getString("DRUG_INDICATION")!=null) {
						drug_indication=resultSet.getString("DRUG_INDICATION");
					}
			} 
			}catch(Exception e){
				 e.printStackTrace();
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){es.printStackTrace();
			}
		}
		return drug_indication;	
	}
/*Added newly for the  ML-BRU-CRF-072[Inc:29938] end */

//Added for RUT-CRF-0036 -start
	public ArrayList getPatientPrevVisitOrders(String patient_id,String encounter_id)	{//ADDED FOR KDAH-ICN-0006
		Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;
		String sql_str				=	"";
		String	start_date			=	"";
		String	end_date			=	"";
		ArrayList alPrevVisitOrderstmp	= new ArrayList();
		HashMap	record			= null;
		String locale= getLanguageId()==null?"en":getLanguageId();
		
		try{
			connection			= getConnection() ;

			sql_str			="SELECT a.discont_date_time, a.patient_id, a.allergy_override_reason, a.dosage_limit_override_reason, a.duplicate_drug_override_reason, a.orig_order_id, a.orig_order_line_no, a.dosage, a.dosage_uom_code, a.split_dose_preview, a.freq_code, g.freq_desc, a.pres_practitioner_id, b.practitioner_name, h.discharge_ind, a.drug_code, c.drug_desc, c.in_formulary_yn, a.strength, c.strength_uom, c.form_code, TO_CHAR (a.start_date, 'DD/MM/YYYY hh24:mi') start_date, TO_CHAR (a.end_date, 'DD/MM/YYYY hh24:mi') end_date, a.dosage, a.dosage_uom_code, a.prescribed_qty PRESCRIBED_QTY,K.PRES_QTY_UOM PRES_BASE_UOM, a.tot_issued_qty dispensed_qty, OL.ORDER_UOM DISP_UOM,a.diag_text, d.facility_name, a.patient_class, DECODE (a.patient_class, 'IP', f.long_desc, 'EA', f.long_desc, DECODE (h.discharge_ind, 'D', f.long_desc, e.long_desc) ) LOCATION, i.short_desc perf_locn, h.iv_prep_yn, j.facility_name per_facility_name, a.split_yn, k.sliding_scale_yn,  RT.route_desc route_desc, OL.ORDER_LINE_STATUS,R.SHORT_DESC LINE_STATUS_DESC ,ph_get_alternates(A.ORIG_ORDER_ID, A.ORIG_ORDER_LINE_NO) alternates, CONTENT_IN_PRES_BASE_UOM, g.FREQ_NATURE, k.DOSAGE_TYPE dosage_type  FROM ph_patient_drug_profile a, am_practitioner_lang_vw b, sm_facility_param_lang_vw d, op_clinic_lang_vw e, ip_nursing_unit_lang_vw f, (SELECT drug_desc drug_desc, drug_code drug_code, in_formulary_yn in_formulary_yn, strength_uom strength_uom, form_code form_code, CONTENT_IN_PRES_BASE_UOM FROM ph_drug_lang_vw WHERE language_id = ? UNION SELECT NVL (short_name, long_name) drug_desc, tpn_regimen_code drug_code, 'Y' in_formulary_yn, NULL strength_uom, NULL form_code, 1 CONTENT_IN_PRES_BASE_UOM FROM ph_tpn_regimen_lang_vw WHERE language_id = ?) c, am_frequency_lang_vw g, or_order h, ph_disp_locn_lang_vw i, sm_facility_param_lang_vw j, or_order_line_ph k, PH_ROUTE_LANG_VW RT,OR_ORDER_LINE OL, OR_ORDER_STATUS_CODE_LANG_VW R WHERE a.patient_id = ? AND a.pres_practitioner_id = b.practitioner_id(+) AND a.facility_id = d.facility_id AND a.facility_id = e.facility_id(+) AND a.locn_code = e.clinic_code(+) AND a.facility_id = f.facility_id(+) AND a.locn_code = f.nursing_unit_code(+) AND a.drug_code = c.drug_code AND a.freq_code = g.freq_code AND a.orig_order_id = h.order_id AND a.orig_order_id = k.order_id AND a.orig_order_line_no = k.order_line_num AND i.disp_locn_code = h.performing_deptloc_code AND h.performing_facility_id = i.facility_id AND h.performing_facility_id = j.facility_id AND a.patient_id = h.patient_id AND h.order_type_code != 'MS' AND OL.order_id = k.order_id AND OL.order_line_num = k.order_line_num AND OL.ORDER_LINE_STATUS = R.ORDER_STATUS_CODE AND j.LANGUAGE_ID = R.LANGUAGE_ID AND RT.route_code = a.route_code AND RT.language_id =  g.language_id AND d.language_id = g.language_id AND d.language_id = i.language_id AND d.language_id = ? AND e.language_id(+) = ? AND f.language_id(+) = ? AND b.language_id(+) = ? AND j.language_id(+) = ? and (a.facility_id,a.encounter_id) in (select facility_id,encounter_id from (select facility_id,encounter_id,VISIT_ADM_DATE_TIME from (select row_number() over (partition by patient_id order by VISIT_ADM_DATE_TIME desc) srl_no , facility_id,encounter_id,patient_id, VISIT_ADM_DATE_TIME from pr_encounter a where patient_id = ? ) A where ( ? is not null and VISIT_ADM_DATE_TIME <= (select VISIT_ADM_DATE_TIME from pr_encounter x where patient_id =? AND x.facility_id = a.facility_id and x.encounter_id =NVL (?, x.encounter_id)) OR ? IS NULL and VISIT_ADM_DATE_TIME = (select max(VISIT_ADM_DATE_TIME) from pr_encounter y  where patient_id = ? and facility_id =a.facility_id  ) ) order by VISIT_ADM_DATE_TIME desc ) where rownum <=1) ORDER BY a.end_date DESC, a.orig_order_id, a.orig_order_line_no";
			//VISIT_ADM_DATE_TIME < to VISIT_ADM_DATE_TIME <= for BSP-SCF-0065
			pstmt				= connection.prepareStatement(sql_str) ;
			pstmt.setString(1,locale);
			pstmt.setString(2,locale);
			pstmt.setString(3,patient_id);
			pstmt.setString(4,locale);
			pstmt.setString(5,locale);
			pstmt.setString(6,locale);
			pstmt.setString(7,locale);
			pstmt.setString(8,locale);
			pstmt.setString(9,patient_id);
			pstmt.setString(10,encounter_id);
			pstmt.setString(11,patient_id);
			pstmt.setString(12,encounter_id);
			pstmt.setString(13,encounter_id);
			pstmt.setString(14,patient_id);

			resultSet	= pstmt.executeQuery();
			while ( resultSet != null && resultSet.next() ) {
				record	=	new HashMap();
				start_date			=	resultSet.getString("START_DATE");
				end_date			=	resultSet.getString("END_DATE");
				//discont_date_time	=	resultSet.getString("DISCONT_DATE_TIME");
				if(!locale.equals("en")){
					start_date			= com.ehis.util.DateUtils.convertDate(start_date, "DMYHM","en",locale);
					end_date			= com.ehis.util.DateUtils.convertDate(end_date, "DMYHM","en",locale);
					//discont_date_time	= com.ehis.util.DateUtils.convertDate(discont_date_time, "DMYHM","en",locale);
				}
				record.put("start_date",start_date);
				record.put("end_date",end_date);
				record.put("drug_desc",resultSet.getString("DRUG_DESC"));
				record.put("strength",resultSet.getString("STRENGTH"));
				record.put("strength_uom_desc",resultSet.getString("STRENGTH_UOM"));
				record.put("form_desc",resultSet.getString("FORM_CODE"));
				record.put("practitioner_name",resultSet.getString("PRACTITIONER_NAME"));
				record.put("location",resultSet.getString("LOCATION"));
				record.put("facility_name",resultSet.getString("FACILITY_NAME"));
				record.put("diag_text",resultSet.getString("DIAG_TEXT"));
				record.put("split_dose_prev",resultSet.getString("SPLIT_DOSE_PREVIEW"));
				record.put("order_id",resultSet.getString("ORIG_ORDER_ID"));
				record.put("order_line_no",resultSet.getString("ORIG_ORDER_LINE_NO"));
				record.put("iv_prep_yn",resultSet.getString("IV_PREP_YN"));
				record.put("freq_code",resultSet.getString("FREQ_CODE"));
				record.put("freq_desc",resultSet.getString("FREQ_DESC"));
				record.put("allergy_reason",resultSet.getString("ALLERGY_OVERRIDE_REASON"));
				record.put("dosage_reason",resultSet.getString("DOSAGE_LIMIT_OVERRIDE_REASON"));
				record.put("duplicate_reason",resultSet.getString("DUPLICATE_DRUG_OVERRIDE_REASON"));
				//record.put("discont_date_time",discont_date_time);
				record.put("perf_locn",resultSet.getString("PERF_LOCN"));
				record.put("discharge_ind",resultSet.getString("DISCHARGE_IND"));
				record.put("in_formulary_yn",resultSet.getString("IN_FORMULARY_YN"));
				record.put("dosage",resultSet.getString("DOSAGE"));
				record.put("dosage_uom_code",resultSet.getString("DOSAGE_UOM_CODE"));
				record.put("per_facility_name",resultSet.getString("PER_FACILITY_NAME"));
				record.put("split_yn",resultSet.getString("split_yn"));
				record.put("sliding_scale_yn",resultSet.getString("SLIDING_SCALE_YN"));
				record.put("prescribed_qty",resultSet.getString("PRESCRIBED_QTY"));
				record.put("pres_uom",resultSet.getString("PRES_BASE_UOM"));
				record.put("dispensed_qty",resultSet.getString("DISPENSED_QTY"));
				record.put("disp_uom",resultSet.getString("DISP_UOM"));
				record.put("route_desc",resultSet.getString("ROUTE_DESC"));
				record.put("order_line_status",resultSet.getString("ORDER_LINE_STATUS"));
				record.put("line_status_desc",resultSet.getString("LINE_STATUS_DESC"));
				record.put("content_in_pres_base_uom",resultSet.getString("CONTENT_IN_PRES_BASE_UOM"));
				record.put("freq_nature",resultSet.getString("FREQ_NATURE"));
				record.put("dosage_type",resultSet.getString("dosage_type"));
				record.put("alternates",resultSet.getString("alternates"));
				alPrevVisitOrderstmp.add(record);
			}
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
			}
			catch(Exception es){
				es.printStackTrace() ;
			}
			setPrevVisitOrders(alPrevVisitOrderstmp);
		}
		catch(Exception e){
			e.printStackTrace() ;
			alPrevVisitOrderstmp.add(e.toString());
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){
				es.printStackTrace() ;
			}
		}
		return alPrevVisitOrderstmp; //Un commented  KDAH-ICN-0006
	}

	public String getPrevVisitEncounter(String patient_id,String encounter_id)	{
		Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;
		String sql				=	"";
	//	String sql_str				=	""; Removed for IN063877
		String prevEncounterID	=   "";
		try{
			connection			= getConnection() ;

			sql="SELECT encounter_id  FROM (SELECT   facility_id, encounter_id, visit_adm_date_time FROM (SELECT ROW_NUMBER () OVER (PARTITION BY patient_id ORDER BY visit_adm_date_time DESC)srl_no,facility_id, encounter_id, patient_id, visit_adm_date_time FROM pr_encounter WHERE patient_id =?) a  WHERE (? IS NOT NULL AND visit_adm_date_time <(SELECT visit_adm_date_time FROM pr_encounter x WHERE patient_id =? AND x.facility_id = a.facility_id AND x.encounter_id = NVL (?, x.encounter_id))OR ? IS NULL AND visit_adm_date_time = (SELECT MAX (visit_adm_date_time) FROM pr_encounter y WHERE y.patient_id =? AND y.facility_id =a.facility_id))ORDER BY visit_adm_date_time DESC) where rownum <=1" ;

			pstmt				= connection.prepareStatement(sql) ;
			pstmt.setString(1,patient_id);
			pstmt.setString(2,encounter_id);
			pstmt.setString(3,patient_id);
			pstmt.setString(4,encounter_id);
			pstmt.setString(5,encounter_id);
			pstmt.setString(6,patient_id);

			resultSet	= pstmt.executeQuery();
			if (resultSet!=null && resultSet.next()) {
				prevEncounterID=resultSet.getString("encounter_id");
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace();
			}
		}
		/*if(prevEncounterID!=null && !prevEncounterID.equals("")){ commented for //kdah-icn-0006
			getPatientPrevVisitOrders(patient_id, encounter_id);
		}*/
		return prevEncounterID;	
	}//Added for RUT-CRF-0036 -end

	//new method getAlternateHmAllowMoreQty(String drug_code,String language_id) added for IN035407 ML-BRU-SCF-0474
	public String getAlternateHmAllowMoreQty(String drug_code,String language_id)	{
		Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;
		String sql				=	"";
		String allow_morethan_pres_qty_YN	="N";
		try{
			connection			= getConnection() ;

			sql="select ALLOW_MORETHAN_PRES_QTY_YN from PH_DRUG_LANG_VW where drug_code=? and language_id=?" ;

			pstmt				= connection.prepareStatement(sql) ;
			pstmt.setString(1,drug_code);
			pstmt.setString(2,language_id);
			
			resultSet	= pstmt.executeQuery();
			if (resultSet!=null && resultSet.next()) {
				allow_morethan_pres_qty_YN=resultSet.getString("ALLOW_MORETHAN_PRES_QTY_YN");
			}
		}
		catch(Exception e){
			 e.printStackTrace();
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){
				es.printStackTrace();
			}
		}
	
		return allow_morethan_pres_qty_YN;	
	}
	/* below code added for ML-BRU-SCF-0340[IN:034556] -- Start */ 
	public String getOrderingFacilityForToken(String queue_date,String token_series,String token_no)	{
		Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;		
		String facility_id	="";		
		try{
			connection			= getConnection() ;
			pstmt = connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_SELECT_GET_ORDERING_FACILITY_ID") );		
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,queue_date);
			pstmt.setString(3,token_series);
			pstmt.setString(4,token_no);				
				
			resultSet	= pstmt.executeQuery();
			if (resultSet!=null && resultSet.next()) {
				facility_id=resultSet.getString("ORDERING_FACILITY_ID");
			}
			else
			   facility_id = login_facility_id.trim();
			  
		}
		catch(Exception e){
			e.printStackTrace();
			System.err.println("=login_facility_id="+login_facility_id+" queue_date="+queue_date+" token_series="+token_series+" token_no="+token_no);
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){
				es.printStackTrace();
			}
		}	
		return facility_id;	
	}
	/* code added for ML-BRU-SCF-0340[IN:034556] -- End */ 
	// Added for Bru-HIMS-CRF-076 [IN:029942] -start
	public void setQMSDtl(String disp_locn_code, String token_series_code){ 
		Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;		
		try{
			connection			= getConnection() ;
			pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_REG_PRESCRIPTIONS_SELECT23")) ;
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,disp_locn_code);
			pstmt.setString(3,token_series_code);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				setQMSRequiredYN(checkForNull(resultSet.getString("QMS_REQUIRED_YN"))); 
			}
		}
		catch(Exception e){
			e.printStackTrace();
			System.err.println("=login_facility_id="+login_facility_id+" disp_locn_code="+disp_locn_code+" token_series_code="+token_series_code);
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){
				es.printStackTrace();
			}
		}	
	}

	public String[] callQMSToken( String session_id, String token_no, String queue_date) throws Exception{
		String  customer_id="";// ext_queue_id="", errText="",  Removed for IN063877
		String disp_locn_code = getDispLocnCode();
		//String token_series_code = getTokenSeriesCode();  Removed for IN063877 
		HashMap<String,String> additionalParams=new HashMap<String,String>();

		customer_id = getCustomerID();
		String QMSResult[] = null;
		try {
			QueueManager ext_interface = new QueueManager(); 
			additionalParams.put("siteID",customer_id);
			additionalParams.put("loggedUser",login_by_id);
			additionalParams.put("clientMachine",login_at_ws_no);
			additionalParams.put("facilityID",login_facility_id);
			additionalParams.put("sessionID",session_id);//session_id
			additionalParams.put("scheduledTime",queue_date);
			additionalParams.put("userName",login_by_id);
			additionalParams.put("workStation ",login_at_ws_no);
			additionalParams.put("patientID", patient_id); //Added for ML-BRU-SCF-0786 [IN:039204]
			additionalParams.put("encounterID",encounter_id); //Added for ML-BRU-SCF-0786 [IN:039204]
//			String extRoomNum=p_locn_code+"|"+room_num;
			try{
				//System.err.println("DispMedication Deliver callQMSToken Parameters passed to the QMS external interface for Mark Arrival disp_locn_code="+disp_locn_code+" token_no="+token_no+"patient_id="+patient_id+" =="+additionalParams.toString());
				QMSResult = ext_interface.callTicket(token_no, additionalParams);
				//System.err.println("QMSResult================>"+QMSResult.toString());
			}
			catch(Exception e){
				e.printStackTrace();
				if(QMSResult == null){
					QMSResult = new String[3];
					QMSResult[0] = "1";
					QMSResult[1] = null;
					QMSResult[2] = getMessage(getLanguageId(),"EXT_QUEUE_NO_CONTACT", "OP");
				}
			}	
		}
		catch ( Exception e ) {
			System.err.println("DispMedication Deliver callQMSToken Parameters passed to the QMS external interface for Mark Arrival disp_locn_code="+disp_locn_code+" token_no="+token_no+additionalParams.toString()+" QMSResult="+QMSResult);
			e.printStackTrace() ;
		}
		return QMSResult;
	}// added for Bru-HIMS-CRF-076 [IN029942] -end
	
	public String getStorageLocnApplYN(String disp_locn_code) throws Exception{	//added for Bru_HIMS-CRF-142[IN030195]  Start
		Connection connection	= null;
        PreparedStatement pstmt	= null;
        ResultSet resultSet		= null;
		String storage_locn_appl_yn	= "N";
		try {
            connection	= getConnection() ;
            //pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_DISP_MEDICATION_SELECT160")) ;
			pstmt		= connection.prepareStatement( "SELECT STORAGE_LOCN_APPL_YN FROM PH_DISP_LOCN WHERE DISP_LOCN_CODE = ? AND FACILITY_ID=?") ;
			pstmt.setString(1,disp_locn_code);
			pstmt.setString(2,login_facility_id.trim());
            resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				storage_locn_appl_yn = checkForNull(resultSet.getString("STORAGE_LOCN_APPL_YN"),"N");
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return storage_locn_appl_yn;
	}	//added for Bru_HIMS-CRF-142[IN030195]  End

	public void setFacilityParamValues(){	//added for Bru-HIMS-CRF-082 [IN:029948]
		Connection connection	= null;
        PreparedStatement pstmt	= null;
        ResultSet resultSet		= null;
		String Alt_drug_remarks_ind	= "N";
		try {
            connection	= getConnection() ;
			pstmt		= connection.prepareStatement( "select ALT_DRUG_REMARKS_IND FROM ph_facility_param where facility_id =?") ;
			pstmt.setString(1,login_facility_id.trim());
            resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				Alt_drug_remarks_ind = checkForNull(resultSet.getString("ALT_DRUG_REMARKS_IND"));
			}
			setAltDrugRemarksInd(Alt_drug_remarks_ind);
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch ( Exception es ) {
				es.printStackTrace() ;
			}
		}
	}	

	public void getDispMednDefltValues(){	//added for JD-CRF-0170.1 [IN:040204]
		Connection connection	= null;
        PreparedStatement pstmt	= null;
        ResultSet resultSet		= null;
		String crit_field_id = "";
		boolean barcode_2d_applicable =false;//Added for MMS-DM-CRF-0174.5
		try {
            connection	= getConnection() ;
			//Adding start for MMS-DM-CRF-0174.5
			barcode_2d_applicable  = eCommon.Common.CommonBean.isSiteSpecific(connection, "ST","2D_BARCODE_APPLICABLE");//Added for MMS-DM-CRF-0174.5
			System.err.println("barcode_2d_applicable@@@ bean==="+barcode_2d_applicable);
			if(barcode_2d_applicable)
				barcode_2d_applicable_yn="Y";
			else
				barcode_2d_applicable_yn ="N";
			set2DBarcodeApplicable(barcode_2d_applicable_yn);//Adding end for MMS-DM-CRF-0174.5

            pstmt		= connection.prepareStatement( "SELECT CRIT_FIELD_ID, CRIT_FIELD_VAL  FROM PH_DISP_MEDN_DFLT WHERE FACILITY_ID = DECODE (?, FACILITY_ID, FACILITY_ID, '*A')   AND CRIT_FIELD_ID IN( 'DISP_DRUG_PENALTY', 'ALLOW_DELIVER_WITHOUT_BL','DISPLAY_DMS_LINK', 'TOTALTAPERQTY','GET_FILL_PERSON_NAME','ALLOC_VS_PRES_QTY_ALERT','INCLUDE_BMS_DEFLT_CHECK','DISP_MEDN_DRUG_PROFILE','AUTO_COMPLETE_PATIAL_DISP','ALLOW_LABEL_ZERO_COPY', 'PAT_PAID_YN_FOR_ZERO_BILL','FILTER_ON_NEXT_FILL_DATE', 'ALLOW_EDIT_DISP_LABEL','DISP_MEDN_PLAN', 'FILTER_BASED_ON_ORD_DATE_YN', 'DISP_DOC_NO','RETN_DISP_MED_FOR_OUTSTANDING', 'TPN_ADMIXTURE_LABEL_YN','PH_ALT_DISP_LOCN_YN','PH_ST_DECIMAL_RESTR') ") ;// GET_FILL_PERSON_NAME Added for AMS-CRF-0009[IN:030935] AND ALLOW_LABEL_ZERO_COPY Added for ML-BRU-SCF-1122[IN:44833] // FILTER_ON_NEXT_FILL_DATE Added for ML-BRU-SCF-1147 [IN045177]// PH_ALT_DISP_LOCN added for ML-MMOH-SCF-0330.1[IN058994]  
			pstmt.setString(1,login_facility_id.trim());
            resultSet	= pstmt.executeQuery() ;
			if(resultSet!=null){
				while(resultSet.next()){
					crit_field_id = checkForNull(resultSet.getString("CRIT_FIELD_ID"));
					if(crit_field_id.equals("ALLOW_DELIVER_WITHOUT_BL"))
						setDeliverWithoutBL(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("DISP_DRUG_PENALTY"))
						setDispDrugPenalty(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("DISPLAY_DMS_LINK")) //added for RUT-CRF-0083.5 [IN:041511]
						setDispDMSLink(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("TOTALTAPERQTY")) 
						setTotalTaperQtyDisplay(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("GET_FILL_PERSON_NAME")) //Added for AMS-CRF-0009[IN:030935]
						setFillPersonName(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"Y"));
					else if(crit_field_id.equals("ALLOC_VS_PRES_QTY_ALERT")) //added for AMS-CRF-0035[IN033551]
						setPresQtyAlert(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));	
					else if(crit_field_id.equals("INCLUDE_BMS_DEFLT_CHECK")) //added for [IN:045055](Bru-HIMS-CRF-281[IN:033166])
						setIncludeBMSDefCheck(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));	
					else if(crit_field_id.equals("DISP_MEDN_DRUG_PROFILE")) //added for Bru-HIMS-CRF-081[IN:029947]
						setDispMednDrugProfile(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("AUTO_COMPLETE_PATIAL_DISP")) //Added for JD-CRF-0179 [IN:41211]
						setAutoCompletePartialDisp(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("ALLOW_LABEL_ZERO_COPY")) //Added for ML-BRU-SCF-1122[IN:44833]
						setAllow_Label_Zero_Copy(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"Y"));
					else if(crit_field_id.equals("PAT_PAID_YN_FOR_ZERO_BILL")) //Added for SKR-SCF-0979 [IN:048119]
						setPatPaidYNForZeroBill(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"Y"));
					else if(crit_field_id.equals("FILTER_ON_NEXT_FILL_DATE"))//Added for ML-BRU-SCF-1147 [IN045177]
						setFilter_on_next_fill_date(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("ALLOW_EDIT_DISP_LABEL"))//Added for Bru-HIMS-CRF-414 [IN045554]
						setAllowEditDispLabel(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("DISP_MEDN_PLAN"))//Added for Bru-HIMS-CRF-072.1 [IN:049144]
						setMedicationPlannerYN(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("FILTER_BASED_ON_ORD_DATE_YN"))//Added for Bru-HIMS-CRF-072.1 [IN:049144]
						setFilterBasedOnOrdDateYN(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("PH_ALT_DISP_LOCN_YN"))// PH_ALT_DISP_LOCN added for ML-MMOH-SCF-0330.1[IN058994]
						setPhAltDispLocnYN(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));// PH_ALT_DISP_LOCN added for ML-MMOH-SCF-0330.1[IN058994]
					else if(crit_field_id.equals("DISP_DOC_NO"))//Added for AMS-CRF-0079 [IN:050762]
						setDispDocNo(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("RETN_DISP_MED_FOR_OUTSTANDING"))//Added for MMS-QH-CRF-0201 [IN:052255]
						setRetnDispMedForOutStanding(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("TPN_ADMIXTURE_LABEL_YN"))//Added for ML-MMOH-CRF-0430 [IN:057336]
						setTpnAdmixtureLabelYN(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
					else if(crit_field_id.equals("PH_ST_DECIMAL_RESTR"))//Added for MMS-DM-SCF-0210 [IN:059660]
						setPhStDecimalRestrictionYN(checkForNull(resultSet.getString("CRIT_FIELD_VAL"),"N"));
				}
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch ( Exception es ) {
				es.printStackTrace() ;
			}
		}
	}	
	
	public boolean getPolicyExp(String encounter_id,String patient_class,String patient_id) {        	
        	CallableStatement callableStatement = null;
        	Connection connection = null;
        	try{        		
    			connection = getConnection();
    			callableStatement	= connection.prepareCall("{ call or_bl_patient_check (?,?,?,?,?,?) }");
    			callableStatement.setString(1, login_facility_id.trim());
    			callableStatement.setString(2, encounter_id);
    			callableStatement.setString(3, patient_class);
    			callableStatement.registerOutParameter(4, Types.VARCHAR);
    			callableStatement.registerOutParameter(5, Types.VARCHAR);
    			callableStatement.setString(6, patient_id);
    			callableStatement.execute();
    			if(!checkForNull(callableStatement.getString(4)).equals("")){  
	    			return false;
    			}
    		}
    		catch(Exception exception){
    			exception.printStackTrace();
    		}
    		finally{
    			try{
    				closeStatement(callableStatement);
    				closeConnection(connection);
    			}
				catch(Exception e){
    				e.printStackTrace();
    			}
    		}
        	return true;
    } //code added for JD-CRF-0156[IN041737]--End

	public ArrayList getEpisodeDetails( String patient_id, String encounter_id){  
		Connection connection	= null ;
		PreparedStatement pstmt	= null ;
		ResultSet resultSet		= null ;
		ArrayList encounter_details = new ArrayList();
		try{
			connection = getConnection() ;
			pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_SELECT_ENCOUNTER_EPISODE_DTL"));
			pstmt.setString(1, patient_id);
			pstmt.setString(2, encounter_id);
			pstmt.setString(3, login_facility_id);
			resultSet			= pstmt.executeQuery();
			if(resultSet!=null){
				if(resultSet.next()){
					encounter_details.add(checkForNull(resultSet.getString("EPISODE_ID")));					
					encounter_details.add(checkForNull(resultSet.getString("PATIENT_CLASS")));				
				}
			}  
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		} 
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace() ;
			}
		}		
		return encounter_details;
	}//code added for JD-CRF-0156[IN041737] --End
	public ArrayList getAppoinmentDetails(String patientid,String apptfromdate,String appttodate,String locale){  //code added for ML-BRU-SCF-1387[IN049916] -- Start
		Connection connection				= null;
		PreparedStatement pstmt				= null;
		ResultSet resultSet					= null;	
		ArrayList result			    = new ArrayList();
		try {
		connection	= getConnection() ;
			pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_PATIENT_APPOINTMENT_DETAILS_SELECT")) ;
			pstmt.setString(1,locale);
			pstmt.setString(2,locale);
			pstmt.setString(3,locale);
			pstmt.setString(4,locale);
			pstmt.setString(5,locale);
			pstmt.setString(6,locale);
			pstmt.setString(7,locale);
			pstmt.setString(8,locale);
			pstmt.setString(9,locale);
			pstmt.setString(10,locale);
			pstmt.setString(11,locale);
			pstmt.setString(12,locale);
			pstmt.setString(13,patientid);			
			pstmt.setString(14,apptfromdate);
			pstmt.setString(15,appttodate);

			resultSet			= pstmt.executeQuery();	
			while(resultSet.next()){
				result.add(checkForNull(resultSet.getString("RULE_APPL_YN")));
				result.add(checkForNull(resultSet.getString("DECEASED_YN")));
				result.add(checkForNull(resultSet.getString("REFERRAL_ID")));
				result.add(checkForNull(resultSet.getString("PATIENT_ID")));
				result.add(checkForNull(resultSet.getString("PATIENTCATDESC")));
				result.add(checkForNull(resultSet.getString("COLOR_INDICATOR")));
				result.add(checkForNull(resultSet.getString("OTH_CONTACT_NO")));
				result.add(checkForNull(resultSet.getString("APPT_REF_NO")));
				result.add(checkForNull(resultSet.getString("RESOURCE_CLASS")));
				result.add(checkForNull(resultSet.getString("PRACTITIONER_FULL_NAME")));
				result.add(checkForNull(resultSet.getString("APPT_STATUS")));
				result.add(checkForNull(resultSet.getString("GENDER")));
				result.add(checkForNull(resultSet.getString("APPT_DATE1")));
				result.add(checkForNull(resultSet.getString("ADDED_DATE")));
				result.add(checkForNull(resultSet.getString("MODIFIED_DATE")));
				result.add(checkForNull(resultSet.getString("PATIENT_NAME")));
				result.add(checkForNull(resultSet.getString("ORDER_CATALOG_CODE")));
				result.add(checkForNull(resultSet.getString("TRANSLATOR_OVERRIDE_REASON")));
				result.add(checkForNull(resultSet.getString("AGE")));
				result.add(checkForNull(resultSet.getString("APPT_SLAB_FROM_TIME")));
				result.add(checkForNull(resultSet.getString("APPT_SLAB_TO_TIME")));
				result.add(checkForNull(resultSet.getString("APPT_DURATION")));
				result.add(checkForNull(resultSet.getString("CARE_LOCN_TYPE_DESC")));
				result.add(checkForNull(resultSet.getString("SPECIALITY_DESC")));
				result.add(checkForNull(resultSet.getString("ADDED_BY")));
				result.add(checkForNull(resultSet.getString("MODIFIED_BY")));
				result.add(checkForNull(resultSet.getString("VISIT_TYPE_SHORT_DESC")));
				result.add(checkForNull(resultSet.getString("CLINIC_SHORT_DESC")));				
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;			
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
			}
			catch(Exception es){
				es.printStackTrace();
			}
		} 		
		return result;
	}	
	 public String showInstructions(String appt_no, String patient_id) throws Exception{	
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String showInstructionsYN = "N";
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_SHOW_INSTRUCTION_SELECT")) ;
			pstmt.setString(1,appt_no);
			pstmt.setString(2,patient_id);
			pstmt.setString(3,appt_no);	
			pstmt.setString(4,appt_no);
			pstmt.setString(5,patient_id);
			pstmt.setString(6,appt_no);	
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				showInstructionsYN = "Y";
			}			
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;			
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return showInstructionsYN;
	}	
	
	public String orderCatalogDesc(String patient_id ,String order_catalog_code,String locale, String appt_no) throws Exception{	
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String order_Catalog_Desc = "" ;
		try {
			connection	= getConnection() ;           
			pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_ORDER_CATALOG_SELECT")) ;
			pstmt.setString(1,order_catalog_code);						
			pstmt.setString(2,locale);						
			pstmt.setString(3,appt_no);						
			pstmt.setString(4,patient_id);						
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				order_Catalog_Desc = resultSet.getString("short_desc");
			}			
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return order_Catalog_Desc;
	}
	
	public String patientInstruction(String appt_refno , String patient_id) throws Exception{	
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;		
		String patient_instruction = ""  ;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_PATIENT_INSTRUCTION_SELECT")) ;
			pstmt.setString(1,appt_refno);						
			pstmt.setString(2,patient_id);						
			pstmt.setString(3,appt_refno);						
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				patient_instruction = patient_instruction+ resultSet.getString("instruction_desc") +"\n";
			}			
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return patient_instruction;
	}
	
	public String procedureInstruction(String appt_refno , String patient_id) throws Exception{	
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;		
		String procedure_instruction = ""  ;
		try {
			connection	= getConnection() ;
			pstmt		= connection.prepareStatement(PhRepository.getPhKeyValue("SQL_PH_PROCEDURE_INSTRUCTION_SELECT")) ;
			pstmt.setString(1,appt_refno);						
			pstmt.setString(2,patient_id);						
			pstmt.setString(3,appt_refno);						
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				procedure_instruction = procedure_instruction+ resultSet.getString("INSTRUCTION_DESC") +"\n";
			}			
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return procedure_instruction;
	} //code added for ML-BRU-SCF-1387[IN049916] --End

	public ArrayList getDiscCancelledOrderDetails(String disc_cancelled_orders) throws Exception{	//Added for HSA-CRF-0138 [IN:048414]
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;		
		ArrayList discCancelledOrderDetails = new ArrayList();
		try {
			connection	= getConnection() ;
			String stSql = PhRepository.getPhKeyValue("SQL_PH_DISC_CANCELLED_DRUG_DTL_SELECT");
			stSql = stSql+" AND (A.ORDER_ID, A.ORDER_LINE_NUM) IN ("+disc_cancelled_orders+") ORDER BY A.ORDER_ID || A.ORDER_LINE_NUM";
			pstmt		= connection.prepareStatement(stSql) ;
			pstmt.setString(1,getLanguageId());						
			pstmt.setString(2,getLanguageId());						
			pstmt.setString(3,getLanguageId());						
			resultSet	= pstmt.executeQuery() ;
			while(resultSet.next()){
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("ORDER_ID"))); //0
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("DRUG_DESC")));
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("START_DATE_TIME")));
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("END_DATE_TIME")));
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("ORD_PRACT_NAME")));
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("ORD_PRACT_ID"))); //5
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("DISC_CAN_PRACT_NAME")));
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("DISC_CAN_PRACT_ID")));
				discCancelledOrderDetails.add(checkForNull(resultSet.getString("CAN_LINE_REASON")));//8
			}			
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return discCancelledOrderDetails;
	} 
	public String getDispStatusType(String disp_status) throws Exception{  // Added for JD-CRF-0198 - Start
		Connection connection	= null;
		PreparedStatement pstmt	= null;
		ResultSet resultSet		= null;
		String result			= "";
		try {
			connection	= getConnection() ;
			pstmt	= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_IP_FILL_PROCESS_SELECT5")) ;
			pstmt.setString(1,disp_status);
			resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				result = checkForNull(resultSet.getString("ORDER_STATUS_TYPE"));
			}
		}
		catch ( Exception e ) {
			System.err.println("Error in getting ORDER_STATUS_TYPE for disp_status"+disp_status) ;
			e.printStackTrace() ;
		}
		finally {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		return result;
	}  // Added for JD-CRF-0198 - End
		
	public String getSysdatePlusDays(String days){  // Added for ML-MMOH-SCF-0690 - Start
		Connection connection       = null ;
		PreparedStatement pstmt     = null ;
		ResultSet resultSet         = null ;
		String sys_date_plus_days="";
		try{
			connection				= getConnection() ;
			String str_qry			= "SELECT TO_CHAR(SYSDATE+?,'DD/MM/YYYY') SYS_DATE_PLUS_DAYS FROM DUAL";
			pstmt					= connection.prepareStatement(str_qry) ;
			pstmt.setString(1, days);
			resultSet				= pstmt.executeQuery();
			if(resultSet!=null && resultSet.next()){
				sys_date_plus_days	= resultSet.getString("SYS_DATE_PLUS_DAYS");	
			}
		
		}catch ( Exception e ) {
			sys_date_plus_days+=e.toString();
			System.err.println( "Error sys_date_plus_days  :"+e ) ;
			e.printStackTrace() ;
		}finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){}
		}
		return sys_date_plus_days;
	} // Added for ML-MMOH-SCF-0690 - End
	public String getwORKsHEETIdSTD(String order_id){  // Added for ML-MMOH-crf-1089 - Start
		Connection connection       = null ;
		PreparedStatement pstmt     = null ;
		ResultSet resultSet         = null ;
		
		String workSheetId="";
		try{
			connection				= getConnection() ;
			String str_qry			= "select distinct TPN_WORKSHEET_ID from PH_TPN_WORKSHEET_HDR where order_id=? and WS_TYPE='7'";
			pstmt					= connection.prepareStatement(str_qry) ;
			pstmt.setString(1, order_id);
			resultSet				= pstmt.executeQuery();
			if(resultSet!=null && resultSet.next()){
				workSheetId	= resultSet.getString("TPN_WORKSHEET_ID");	
			}
		
		}catch ( Exception e ) {
			
			System.err.println( "Error sys_date_plus_days  :"+e ) ;
			e.printStackTrace() ;
		}finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){}
		}
		return workSheetId;
	} // Added for ML-MMOH-CRF-1089 - End
//Adding start for ML-BRU-SCF-1870
	public void getOrderlingFacilityID(String pat_id){
		//ArrayList result		= new ArrayList(); //Commented for COMMON-ICN-0048
		Connection connection	= null;
		PreparedStatement pstmt=null;
		ResultSet resultSet=null;
		String disp_stage		= getDispStage();
		String disp_regn_reqd_yn = getDispRegnReqdYN();
		String	unallocdrugs = this.display_unallocDrugs;
		StringBuffer sbStagesCondition =new StringBuffer();
		StringBuffer sbAppendSql = new StringBuffer();
		StringBuffer sbMainSql = new StringBuffer();
		String order_facility_id ="";
try{

	    connection				= getConnection() ;
		if(disp_stage.equals("AS")){
					if(verf_combined_with_alloc.equals("C")){
						if(disp_regn_reqd_yn.equals("Y"))
							sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE IN('58','94'))");
						else 
							sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='58') ");
					}	
					else
						sbStagesCondition.append(" AND (B.ORDER_LINE_STATUS NOT IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE  IN('10','25','58','94')) ");
							
					if (!scope.equals("D") && !scope.equals("A")){
						sbStagesCondition.append(" OR A.DISCHARGE_IND='D') ");
					} 
					else {
						sbStagesCondition.append(")");
					}
				}
				else if(disp_stage.equals("V") && getIssueTokenOnRegnYN().equals("Y")){
					
					if(scope.equals("H")) {				
						sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");

					} 
					else {
						if(scope.equals("EX")) {						
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS = 'XT'");
						} 
						else {						
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='25' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
					}
				}
				else if((getDispStage().equals("A") && (getFillingStatus().equals("A") )) ||(getDispStage().equals("F") && (getFillingStatus().equals("B") || getFillingStatus().equals("X")))){
					sbAppendSql = new StringBuffer();
							if(verf_combined_with_alloc.equals("C")){
								sbAppendSql.append(" AND e.ORDER_STATUS_TYPE ='25' ");
							}
							else{
								sbAppendSql.append(" AND e.ORDER_STATUS_TYPE ='30' ");
							}

						sbStagesCondition = new StringBuffer();
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
						else if(scope.equals("EX")) { 
							sbStagesCondition.append(sbAppendSql);
							sbStagesCondition.append(" AND A.PATIENT_CLASS ='XT'");
						} 
						else {
							sbStagesCondition.append(sbAppendSql);
							sbStagesCondition.append(" AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
				}
				else if(getDispStage().equals("F") && getFillingStatus().equals("A")){
					//	Dispense Stage is Filling and Filling is after Allocation
					sbStagesCondition = new StringBuffer();
						if(scope.equals("H")) {
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						} 
						else if(scope.equals("EX")) {
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS ='XT'");
						} 
						else {
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
				}
				else if(getDispStage().equals("A") && (getFillingStatus().equals("B")|| getFillingStatus().equals("X"))){
					sbAppendSql = new StringBuffer();
					//	Dispense Stage is Allocation and Filling is before Allocation
					if(getDispStage().equals("A") && getFillingStatus().equals("B")){
						sbAppendSql.append(" and e.ORDER_STATUS_TYPE ='35' ");
					}
					else{
							if(verf_combined_with_alloc.equals("C")){
								sbAppendSql.append(" AND e.ORDER_STATUS_TYPE ='25' ");
							}
							else{
								sbAppendSql.append(" AND e.ORDER_STATUS_TYPE ='30' ");
							}
					}

					if(scope.equals("H")) {
						sbStagesCondition.append(" and e.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(scope.equals("EX")) { 
						sbAppendSql.append(" and A.PATIENT_CLASS ='XT'");
						sbStagesCondition.append(sbAppendSql.toString());
					}
					else {
						sbAppendSql.append(" AND A.PATIENT_CLASS IN ('OP','EM','XT') ");
						sbStagesCondition.append(sbAppendSql.toString() );
					}
				}
				else if((getDispStage().equals("D") && (getFillingStatus().equals("B") || (getFillingStatus().equals("X"))))){
					//	Dispense Stage is Delivery and Filling is before Allocation
					
					if(scope.equals("H")) {
						sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE ='50' AND A.PATIENT_CLASS IN ('OP','EM','XT')");
					} 
					else if(unallocdrugs.equals("Y")) {
						if(scope.equals("EX")){
							sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE IN ('36','56','10','30','25') AND A.PATIENT_CLASS = 'XT'");
						}
						else{
								sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE IN ('36','56','10','30','25') AND A.PATIENT_CLASS IN('OP','EM','XT')");
						}
					} 
					else {
							if(scope.equals("EX")){
								sbStagesCondition.append("AND e.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS = 'XT'");
							}
							else{
								sbStagesCondition.append("AND e.ORDER_STATUS_TYPE ='36' AND A.PATIENT_CLASS IN('OP','EM','XT')");
							}
					}
				}
				else if((getDispStage().equals("D") && getFillingStatus().equals("A"))){
					//	Dispense Stage is Delivery and Filling is after Allocation
					if(scope.equals("H")) {
						sbStagesCondition = new StringBuffer(" AND B.ORDER_LINE_STATUS IN (SELECT ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE WHERE ORDER_STATUS_TYPE ='50') ");
					} 
					else if(unallocdrugs.equals("Y")) {
						if(scope.equals("EX")){
							sbStagesCondition.append( "AND e.ORDER_STATUS_TYPE IN ('10', '35','30','56','25') AND A.PATIENT_CLASS = 'XT'");
						}
						else{
								sbStagesCondition.append(" AND e.ORDER_STATUS_TYPE IN ('10', '35','30','56','25') AND A.PATIENT_CLASS IN('OP','EM','XT') ");
						}
					}
					else {
							if(scope.equals("EX")){
								sbStagesCondition.append("AND e.ORDER_STATUS_TYPE = '35' AND A.PATIENT_CLASS = 'XT'");
							}
							else{
								sbStagesCondition.append( "AND e.ORDER_STATUS_TYPE = '35' AND A.PATIENT_CLASS IN('OP','EM','XT')");
							}
					}
				}

				sbMainSql.append(" select a.ordering_facility_id FROM or_order_line b, or_order a, or_order_status_code e, ph_ord_for_disp_queue dq, ph_disp_queue dispq WHERE a.patient_id = ? AND b.order_id = a.order_id AND a.patient_id = dq.patient_id AND a.order_id = dq.order_id AND dq.facility_id = ? AND dq.disp_locn_code = ? AND dq.queue_date = TO_DATE (?, 'DD/MM/YYYY') AND dq.queue_shift = '*ALL'  AND dq.token_series_code = ? AND dq.token_serial_no = NVL (?, dq.token_serial_no) AND dq.queue_date = dispq.queue_date AND dq.facility_id = dispq.facility_id AND dq.disp_locn_code = dispq.disp_locn_code AND dq.queue_date = dispq.queue_date AND dq.queue_shift = dispq.queue_shift AND dq.token_series_code = dispq.token_series_code AND dq.token_serial_no = dispq.token_serial_no AND dispq.token_status NOT IN ('XX')  AND e.order_status_code = b.order_line_status  AND e.order_status_code NOT IN ('00', '05', '95', '03', '93', '97', '99', '58') AND a.order_category = 'PH' AND a.performing_deptloc_code = ? " +sbStagesCondition+" ");//handle null NVL (?, dq.token_serial_no) for ML-MMOH-SCF-1870.1


				pstmt = connection.prepareStatement(sbMainSql.toString());


					pstmt.setString(1,pat_id);
					pstmt.setString(2,login_facility_id);
					pstmt.setString(3,getDispLocnCode());
					pstmt.setString(4,this.queue_date);
					pstmt.setString(5,getTokenSeriesCode());
					pstmt.setString(6,getTokenNo());
					pstmt.setString(7,getDispLocnCode());

					resultSet = pstmt.executeQuery() ;
			
			        if(resultSet.next()){
						order_facility_id =resultSet.getString("ordering_facility_id")==null?"":resultSet.getString("ordering_facility_id");
					}

                 if(!order_facility_id.equals(""))
					  setOrderingFacility(order_facility_id);

		}catch ( Exception e ) {
			e.printStackTrace() ;
		}finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch ( Exception es ) {
			  es.printStackTrace() ;
		  }
		}

	}//Adding end for ML-BRU-SCF-1870
	public String getPrimaryBillingGroup(String patient_class,String encounter_id,String patient_id){ // Added for GHL-CRF-0548 [IN:068345] - Start - Devindra
		Connection connection = null;		
		PreparedStatement pstm_group_type = null;
		ResultSet resultSet = null;
		String sql = "";		
		String billing_group ="";
		String insuranse_sql ="";
		String episode_id ="";
		String visit_id ="";
		String insurance_patient_yn ="";
	  try{
		  connection = getConnection();
		            
		if(patient_class.equals("OP") || patient_class.equals("EM")){
			  patient_class = objAllStages.getEncounterPatientClass(encounter_id, patient_id);
			  episode_id =encounter_id.substring(0,(encounter_id.length()-4));  
			  visit_id =encounter_id.substring(encounter_id.length()-4);  
		}
		else if(patient_class.length()>0)
			patient_class = patient_class.substring(0,1);
		 if(patient_class.equals("IP") || patient_class.equals("DC")){
			        episode_id =encounter_id;  
					visit_id ="1";  
		 }
		 if(patient_class.equalsIgnoreCase("O") || patient_class.equalsIgnoreCase("E"))
			 sql = "SELECT short_desc FROM bl_blng_grp_lang_vw WHERE blng_grp_id IN ( SELECT blng_grp_id FROM bl_visit_fin_dtls WHERE operating_facility_id = ? AND episode_type = ? AND episode_id = ? AND language_id=?)";
		 else
		     sql =  "SELECT short_desc FROM bl_blng_grp_lang_vw WHERE blng_grp_id IN ( SELECT blng_grp_id FROM bl_episode_fin_dtls WHERE operating_facility_id = ? AND episode_type = ? AND episode_id = ? and language_id=?)";
		 pstm_group_type	= connection.prepareStatement(sql) ;
		 if(checkForNull(patient_class).equalsIgnoreCase("O") || patient_class.equalsIgnoreCase("E")){
			 pstm_group_type.setString(1,login_facility_id);
			 pstm_group_type.setString(2, patient_class);
			 pstm_group_type.setString(3, checkForNull(encounter_id.substring(0,encounter_id.length()-4)));
			 pstm_group_type.setString(4,getLanguageId());
		 }
		 else{
			 pstm_group_type.setString(1,login_facility_id);
			 pstm_group_type.setString(2, patient_class);
			 pstm_group_type.setString(3, checkForNull(encounter_id)); 
			 pstm_group_type.setString(4,getLanguageId());
		 }
		  resultSet    = pstm_group_type.executeQuery();
		  if(resultSet!=null && resultSet.next()) {
			  billing_group = resultSet.getString("SHORT_DESC");			 
			}
                closeResultSet( resultSet ) ;
				closeStatement( pstm_group_type ) ;
				//System.err.println("getDisplayInsStatus@@before patient check==="+objAllStages.getDisplayInsStatus());
          if(objAllStages.getDisplayInsStatus()){//Adding start for TH-KW-CRF-0012
			  if(patient_class.equals("O") || patient_class.equals("E")){
				  if(encounter_id.length()<=0){
					  episode_id="";
					  visit_id="";
					}    
			  else {episode_id =encounter_id.substring(0,(encounter_id.length()-4));  
			        visit_id =encounter_id.substring(encounter_id.length()-4);  }
				}
			  if(patient_class.equals("I") || patient_class.equals("D")){
				  if(encounter_id.length()<=0){
					  episode_id="";
					  visit_id="";
					}
				  else{episode_id =encounter_id;  
							visit_id ="1";  }
				 }

              insuranse_sql="SELECT DECODE (cust_code, NULL,'Cash','Insurance')Insurance_patient_yn FROM bl_visit_fin_dtls WHERE operating_facility_id = ? AND patient_id = ? AND episode_type = ? AND episode_id = ? AND visit_id = ? AND episode_type IN ('O', 'E') UNION SELECT DECODE (cust_code,NULL,'Cash','Insurance')Insurance_patient_yn FROM bl_episode_fin_dtls WHERE operating_facility_id = ? AND patient_id = ? AND episode_type = ? AND episode_id = ? AND episode_type IN ('I', 'D') ";

//System.err.println("login_facility_id@@=="+login_facility_id+"patient_id=="+patient_id+"patient_class=="+patient_class+"episode_id=="+episode_id+"visit_id"+visit_id);
			  pstm_group_type	= connection.prepareStatement(insuranse_sql) ;
			  pstm_group_type.setString(1,login_facility_id);
			  pstm_group_type.setString(2,patient_id);
			  pstm_group_type.setString(3, patient_class);
			  pstm_group_type.setString(4, episode_id); 
			  pstm_group_type.setString(5,visit_id);
			  pstm_group_type.setString(6,login_facility_id);
			  pstm_group_type.setString(7,patient_id);
			  pstm_group_type.setString(8, patient_class);
			  pstm_group_type.setString(9, episode_id); 
			  

			  resultSet    = pstm_group_type.executeQuery();
		  if(resultSet!=null && resultSet.next()) {
			  String insurance_patient = resultSet.getString("Insurance_patient_yn");
			  System.err.println("insurance_patient inside Result@@@==="+insurance_patient);
			  if(insurance_patient.equals("Insurance"))
                insurance_patient_yn ="Y";
			   objAllStages.setInsurancePatient(insurance_patient_yn);
               objAllStages.setIuranceStatus(patient_id,episode_id,visit_id,patient_class);
			}
		  }//Adding end for TH-KW-CRF-0012
	  }
	  catch (Exception e) {
		e.printStackTrace();
	  }
	  finally{
		  try{				
				closeResultSet( resultSet ) ;
				closeStatement( pstm_group_type ) ;
				closeConnection( connection );				
			}
			catch(Exception e){
				e.printStackTrace();
			}		   
		  return billing_group; 
	  }
	}
	public String getBLInterfaceYN(){		
		String bl_interface_yn="";
		try{			
			bl_interface_yn = objAllStages.getBLInterfaceYN();
	} // Added for GHL-CRF-0548 [IN:068345] - End
		catch (Exception e) {
			e.printStackTrace();
		}
		finally{
			return checkForNull(bl_interface_yn);
		}
	} // Added for GHL-CRF-0548 [IN:068345] - End - Devindra
// added ML-MMOH-CRF-1408 - start
	public ArrayList getMinMaxCeilingDose(String drugCode,String patient_id,String repeat_value,String order_id,String order_line_no){
		
		Connection connection       = null ;
		CallableStatement cstmt		= null;
		PreparedStatement pstmt		= null;
		HashMap pat_dtls			= null;
		ResultSet resultSet			= null;
		ResultSet resultSet1		= null ;
		ResultSet result			= null;
		ArrayList dose	= new ArrayList();
		String age ="",sex="",age_in_mints="",calc_by_ind="",age_group="",factor="",weight="",dosage="";
		String  max_daily_ceiling_dose = "",min_daily_ceiling_dose = "",max_unit_ceiling_dose="",min_unit_ceiling_dose = "",bsa ="",dosage_type ="",sql_query="";
		try{
				connection				= getConnection() ;
				pat_dtls	=	getPatientDetails(patient_id,drugCode);
				age			=	(String)pat_dtls.get("age");
				sex			=	((String)pat_dtls.get("sex"));
				age_in_mints=	((String)pat_dtls.get("age_in_mints"));
				age_group	= ((String)pat_dtls.get("age_group"));

				age_in_mints	=	age_in_mints.trim();
				age	=	age.trim();
				sex	=	sex.substring(0,1);

				pstmt	= connection.prepareStatement("select DOSAGE,PRESCRIBED_MODE,WEIGHT,BSA from ph_patient_drug_profile where PATIENT_ID = ? and ORIG_ORDER_ID = ? and ORIG_ORDER_LINE_NO = ?") ;
				pstmt.setString(1,patient_id);
				pstmt.setString(2,order_id);
				pstmt.setString(3,order_line_no);
				resultSet1		= pstmt.executeQuery();
				
				while(resultSet1!=null && resultSet1.next() ) {
					dosage		= resultSet1.getString("DOSAGE");
					dosage_type	=	resultSet1.getString("PRESCRIBED_MODE");
					weight		=   resultSet1.getString("WEIGHT");
					bsa			=   resultSet1.getString("BSA");
				}
				try{
					closeResultSet( resultSet1 ) ;
					closeStatement( pstmt ) ;
				}
				catch(Exception es){
					es.printStackTrace() ;
				}
				if(age_group!=null && !age_group.equals("")) {
					sql_query		= PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT81");
					pstmt			= connection.prepareStatement(sql_query) ;
					pstmt.setString(1,drugCode);
					pstmt.setString(2,age_group);
					result			= pstmt.executeQuery();
					if(result!=null && result.next()) {
						
						 calc_by_ind = result.getString("CALC_BY_IND");
						
					} 
					try{
						closeResultSet( result ) ;
						closeStatement( pstmt ) ;
					}catch(Exception es){
						es.printStackTrace() ;
					}
				}
				if(calc_by_ind.equalsIgnoreCase("W")){
					if(weight!=null && !weight.equals(""))
						factor =weight;
					else
						factor ="1";
				}
				else if(calc_by_ind.equalsIgnoreCase("B")){
					if(bsa!=null && !bsa.equals(""))
						factor =bsa;
					else
						factor ="1";
					 
				}
				else{
					factor ="1";
				}

			cstmt=connection.prepareCall("{call PH_PKG_BASE.PH_DrugDoseInLimit1(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)}");
			cstmt.setString( 1, drugCode);
			cstmt.setString( 2, patient_id);
			cstmt.setString( 3, dosage);
			cstmt.setString( 4, repeat_value);
			cstmt.setString( 5, dosage_type);
			cstmt.registerOutParameter(6, Types.VARCHAR );
			cstmt.registerOutParameter(7, Types.VARCHAR );
			cstmt.registerOutParameter(8, Types.VARCHAR );
			cstmt.registerOutParameter(9, Types.VARCHAR );
			cstmt.registerOutParameter(10, Types.VARCHAR );
			cstmt.registerOutParameter(11, Types.VARCHAR );
			cstmt.registerOutParameter(12, Types.VARCHAR );
			cstmt.registerOutParameter(13, Types.VARCHAR );
			cstmt.registerOutParameter(14, Types.VARCHAR );
			cstmt.registerOutParameter(15, Types.VARCHAR );
			cstmt.registerOutParameter(16, Types.VARCHAR );
			cstmt.setString( 17, factor);
			cstmt.execute() ;

		   max_daily_ceiling_dose = cstmt.getString(13)==null ? "":cstmt.getString(13);
		   min_daily_ceiling_dose = cstmt.getString(14)==null ? "":cstmt.getString(14);
		   max_unit_ceiling_dose = cstmt.getString(15)==null ? "":cstmt.getString(15);
		   min_unit_ceiling_dose = cstmt.getString(16)==null ? "":cstmt.getString(16);
		   
		   dose.add(min_unit_ceiling_dose);
		   dose.add(max_unit_ceiling_dose);
		   dose.add(min_daily_ceiling_dose);
		   dose.add(max_daily_ceiling_dose);
		
		}catch ( Exception e ) {
			
			System.err.println( "Error sys_date_plus_days  :"+e ) ;
			e.printStackTrace() ;
		}finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeStatement( cstmt ) ;
				
				closeConnection( connection );
			}catch(Exception es){}
		}
		return dose;
	}

	public HashMap getPatientDetails(String patient_id,String drug_code)	{
		Connection connection	= null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet		= null ;
		String	patient_name	=	"";
		String	sex				=	"";
		String	age				=	"";
		String	age_in_mints	=	"";
		String age_group		= "";
		HashMap	 pat_details	=	new HashMap();
		try{
			connection			= getConnection() ;
			pstmt				= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT43A") ) ;
			pstmt.setString(1,patient_id);
			resultSet	= pstmt.executeQuery();
			if ( resultSet != null && resultSet.next() ) {
				patient_name	=	resultSet.getString("PATIENT_NAME");
				sex				=	resultSet.getString("SEX");
				age				=	resultSet.getString("AGE");
				age_in_mints				=	resultSet.getString("AGE_IN_MINTS");
			}
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;

			pat_details.put("patient_name",patient_name);
			pat_details.put("sex",sex);
			pat_details.put("age",age);
			pat_details.put("age_in_mints",age_in_mints);
			age_in_mints	=	age_in_mints.trim();
			sex	=	sex.substring(0,1);
			pstmt	= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_PRESCRIPTION_SELECT80A") ) ;
			pstmt.setString(1,sex);
			pstmt.setString(2,age_in_mints);
			pstmt.setString(3,drug_code);
			resultSet	= pstmt.executeQuery();
			
			while(resultSet!=null && resultSet.next() ) {
				age_group	=	resultSet.getString("AGE_GROUP_CODE");
			}
			
			pat_details.put("age_group",age_group);

		}
		catch(Exception e){
			pat_details.put("error",e.toString());
			e.printStackTrace() ;
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es){
				es.printStackTrace() ;
			}
		}
		return pat_details;
	}
	//added for ML-MMOH-CRF-1408 - end
//added for SKR-SCF-1512 - start
	public String getPrintValueForOrders(String order_id){

		Connection connection	= null;
        PreparedStatement pstmt	= null;
        ResultSet resultSet		= null;	
		String min_value		= "";
		String max_value		= "";
		try {
            connection	= getConnection() ;
            pstmt		= connection.prepareStatement("SELECT MIN (NVL (print_value, 0)) min_value,MAX (NVL (print_value, 0)) max_value FROM or_order_line_ph  WHERE order_id = ?") ;

			pstmt.setString(1,order_id);
            resultSet	= pstmt.executeQuery() ;
			if(resultSet!=null && resultSet.next()){
				max_value		=	resultSet.getString("max_value")==null?"":resultSet.getString("max_value");
				min_value		=	resultSet.getString("min_value")==null?"":resultSet.getString("min_value");
			}
			if(min_value==null)
				min_value = "";
			if(max_value==null)
				max_value = "";

		}
		catch ( Exception e ) {
			e.printStackTrace() ;			
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
				}catch(Exception es){
					es.printStackTrace();
				}
		}
		return min_value+"~"+max_value;
}
//added for SKR-SCF-1467 - end	
	public String getIVFlag(String order_id) {
		Connection connection	= null;
        PreparedStatement pstmt	= null;
        ResultSet resultSet		= null;	
		String iv_prep_yn		= "";
		try {
            connection	= getConnection() ;
            pstmt		= connection.prepareStatement( PhRepository.getPhKeyValue("SQL_PH_MED_ADMIN_FT_SELECT27")) ;
			pstmt.setString(1,order_id);
            resultSet	= pstmt.executeQuery() ;
			while (resultSet.next()){
				iv_prep_yn		=	resultSet.getString("iv_prep_yn")==null?"":resultSet.getString("iv_prep_yn");				
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;			
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection ); 
				}catch(Exception es){es.printStackTrace();}
		}
		return iv_prep_yn;
	}
//Adding start for MMS-DM-CRF-0170
	public ArrayList getScanCountReqForPatientClass(String patient_class,String function_id) throws Exception{
        Connection connection 		= null;
		PreparedStatement pstmt 	= null;
		ResultSet resultSet 		= null;
		ArrayList scanCountSetup    = new ArrayList();

		try
		{
			connection =getConnection();
			pstmt = connection.prepareStatement("SELECT SCAN_REQUIRED_YN,ALERT_REQUIRED_YN,REMARKS_REQUIRED_YN FROM PR_BARCODE_SCAN_SETUP WHERE FUNCTION_ID = ? AND PATIENT_CLASS =? ") ;
			pstmt.setString(1, function_id.trim());
			pstmt.setString(2, patient_class.trim());
			resultSet = pstmt.executeQuery() ;
			if(resultSet.next())
			{ 
				scanCountSetup.add(resultSet.getString("SCAN_REQUIRED_YN")==null?"N":resultSet.getString("SCAN_REQUIRED_YN"));
				scanCountSetup.add(resultSet.getString("ALERT_REQUIRED_YN")==null?"N":resultSet.getString("ALERT_REQUIRED_YN"));
				scanCountSetup.add(resultSet.getString("REMARKS_REQUIRED_YN")==null?"N":resultSet.getString("REMARKS_REQUIRED_YN"));
			}
		}
		catch(Exception e)
		{
			e.printStackTrace() ;
		}
		finally
		{
			if(resultSet != null) resultSet.close();
			if(pstmt != null) pstmt.close();
			if(connection != null) connection.close();
		}
		return scanCountSetup;	
		
	}
	//Adding end for MMS-DM-CRF-0170
	//Modified for 12c - start
public String retunFormatedInt(String sValue){
	DecimalFormat dfToInteger = new DecimalFormat("#.####");
		if(sValue != null && !sValue.equals("")){
			return dfToInteger.format(Double.parseDouble(sValue));
		}
			return "";
	}
public HashMap getHMEditLabelValues(String order_id,String order_line_no,String drug_code,String ord_date_time,String drug_name,String drug_desc,String pres_qty,String uom){
			 HashMap hmEditLabelValues = new HashMap();
			 hmEditLabelValues.put("order_id",order_id);
			 hmEditLabelValues.put("pres_drug_code",drug_code);
			 hmEditLabelValues.put("drug_code",drug_code);
			 hmEditLabelValues.put("order_line_no",order_line_no);
			 hmEditLabelValues.put("ord_date_time",ord_date_time);
			 hmEditLabelValues.put("drug_name_1",drug_name);
			 hmEditLabelValues.put("drug_desc",drug_desc); 
			 hmEditLabelValues.put("pres_qty",pres_qty);
			 hmEditLabelValues.put("uom",uom);
			 hmEditLabelValues.put("alt_drug_flag","N");	
			 hmEditLabelValues.put("alt_drug_count", "0");
	return hmEditLabelValues;
}
public HashMap getHMEditLabelValuesAlt(String order_id,String order_line_no,String drug_code,String alt_drug_code,String ord_date_time,String drug_name,String drug_desc,String alt_drug_desc,String qty,String form_code,String size){
			 HashMap hmEditLabelValues = new HashMap();
									hmEditLabelValues.put("order_id",order_id);
						hmEditLabelValues.put("pres_drug_code",drug_code);
						hmEditLabelValues.put("drug_code",alt_drug_code);
						hmEditLabelValues.put("order_line_no",order_line_no);
						hmEditLabelValues.put("ord_date_time",ord_date_time);
						hmEditLabelValues.put("drug_name_1",drug_name);
						hmEditLabelValues.put("drug_desc",drug_desc); 
						hmEditLabelValues.put("alt_drug_desc",alt_drug_desc);
						hmEditLabelValues.put("pres_qty",qty);
						hmEditLabelValues.put("uom",form_code);
						hmEditLabelValues.put("alt_drug_flag","Y");
						hmEditLabelValues.put("alt_drug_count", size);  
	return hmEditLabelValues;
}


public ArrayList getColors(){
		ArrayList colors = new ArrayList();
			colors.add("#FF0000");
			colors.add("#669900");
			colors.add("#FF9966");
			colors.add("#6699CC");
			colors.add("#FF0000");
			colors.add("#669900");
			colors.add("#FF9966");

	return colors;
}

public ArrayList getAllocBatchDetails(HashMap batch_det,String item_code,String store_code,String tmp_unit_qty,String end_date, String qty_uom, String base_uom,String issue_qty,double base_to_disp_uom_equl,double base_to_def_uom_equl,String item_cost)
{
		
		ArrayList alloc_drug_detail = new ArrayList();
		alloc_drug_detail.add(batch_det.get("ITEM_CODE"));
		alloc_drug_detail.add(batch_det.get("BATCH_ID"));
		alloc_drug_detail.add(batch_det.get("EXPIRY_DATE"));
		if(base_to_disp_uom_equl!=base_to_def_uom_equl){
			alloc_drug_detail.add(issue_qty); 
			alloc_drug_detail.add(qty_uom);
		}else{ 
			if(!qty_uom.equals(base_uom)){
				alloc_drug_detail.add(issue_qty);
				alloc_drug_detail.add(qty_uom);
			}
			else{
				alloc_drug_detail.add((String)batch_det.get("QTY"));
				alloc_drug_detail.add(base_uom);
			}
		}
		
		alloc_drug_detail.add("");
		alloc_drug_detail.add(batch_det.get("TRADE_ID"));
		alloc_drug_detail.add(batch_det.get("BIN_LOCATION_CODE"));
		alloc_drug_detail.add(item_cost);                
		alloc_drug_detail.add(base_uom); 
	return alloc_drug_detail;
}
public float getOPDispperiod(String sRepeatFreqCode,String sOrigDispUnit,String sOrigDispPeriod,float opdispperiod){

		if(sRepeatFreqCode.equals("W")){
			if(sOrigDispUnit.equals("H")){
				opdispperiod = new Float(Math.ceil((opdispperiod/7)*7));//Added for ARYU-SCF-0077 removed 24 because opdispperiod already converted to day in Bean file
			}else if(sOrigDispUnit.equals("D")){
				opdispperiod = new Float(Math.ceil((opdispperiod/7)*7));//Added for ARYU-SCF-0077
			}else if(sOrigDispUnit.equals("M"))
				opdispperiod = new Float(Integer.parseInt(sOrigDispPeriod)*4*7);
		}
		else if(sRepeatFreqCode.equals("M")){
			if(sOrigDispUnit.equals("H"))
				opdispperiod = new Float(Math.ceil((opdispperiod/(24*30)))*30); 
			else if(sOrigDispUnit.equals("D"))
				opdispperiod = new Float(Math.ceil((opdispperiod/30))*30);
			else if(sOrigDispUnit.equals("W"))
				opdispperiod = new Float(Math.ceil((opdispperiod/4))*30);
		}
	return opdispperiod;
}
public float getTotalDuration(String sFreqCode,float fTotalDuration){

			if(sFreqCode.equals("H")){
				fTotalDuration = fTotalDuration/24;
			}
			else if(sFreqCode.equals("W")){
				fTotalDuration = fTotalDuration*7;
			}
			else if(sFreqCode.equals("L")){
				fTotalDuration = fTotalDuration*30;
			}
			else if(sFreqCode.equals("Y")){
				fTotalDuration = fTotalDuration*365;
			}
	return fTotalDuration;
}

public String getItemTypeStyle(String bl_grp_app,String mm_item_low_cost_yn,String mm_item_high_margin_yn,String mm_item_Innovator_yn){
		String low_cost_green_style ="visibility:hidden";
		String high_margin_green_style ="visibility:hidden";
		String high_margin_red_style   ="visibility:hidden";
		String low_cost_red_style	="visibility:hidden";
		String low_cost_grey_style ="visibility:hidden";
		String innovator_style		="visibility:hidden"; 
		String high_margin_grey_style = "visibility:hidden"; 
		String return_val = "";

		if(mm_item_low_cost_yn.equals("Y")) {
				if(bl_grp_app.equals("L")){
						low_cost_green_style ="visibility:visible";
						low_cost_red_style = "visibility:hidden";
						low_cost_grey_style = "visibility:hidden";
						
					if(mm_item_high_margin_yn.equals("Y")){
						high_margin_red_style = "visibility:visible";
						high_margin_green_style ="visibility:hidden";
						high_margin_grey_style = "visibility:hidden";
					}else{
						high_margin_grey_style = "visibility:hidden";
					}
				}else{
					if(bl_grp_app.equals("H")){
						low_cost_green_style ="visibility:hidden";
						low_cost_red_style = "visibility:visible";
						low_cost_grey_style = "visibility:hidden";
					}
				} 
			}else{
					low_cost_green_style ="visibility:hidden";
					low_cost_red_style = "visibility:hidden";
					low_cost_grey_style = "visibility:hidden";
			}
			if(mm_item_high_margin_yn.equals("Y")){
					if(bl_grp_app.equals("H")){
						high_margin_green_style ="visibility:visible";
						high_margin_red_style = "visibility:hidden";
						high_margin_grey_style = "visibility:hidden";
						if(mm_item_low_cost_yn.equals("Y")) {
						low_cost_red_style ="visibility:visible";
						low_cost_green_style = "visibility:hidden";
						low_cost_grey_style = "visibility:hidden";
						}

					}else{
						if(bl_grp_app.equals("L")){
							high_margin_red_style = "visibility:visible";
						}
					}
			}else{
				
					high_margin_green_style ="visibility:hidden";
					high_margin_red_style = "visibility:hidden";
					high_margin_grey_style = "visibility:hidden";
			}
			if(mm_item_Innovator_yn.equals("Y")){
					innovator_style		="visibility:visible";		
			}else{
					innovator_style		="visibility:hidden";		
			}
		return_val = high_margin_green_style+"~"+high_margin_red_style+"~"+high_margin_grey_style+"~"+low_cost_red_style+"~"+low_cost_green_style+"~"+low_cost_grey_style+"~"+innovator_style;

		return return_val;
	}
	public String getItemTypeStyle1(String mm_item_low_cost_yn,String mm_item_high_margin_yn,String mm_item_Innovator_yn){
	
			String low_cost_grey_style = "visibility:hidden";
			String high_margin_grey_style ="visibility:hidden";
			String innovator_style = "visibility:hidden";
			String return_val = "";		
			if(mm_item_low_cost_yn.equals("Y")){
				low_cost_grey_style = "visibility:visible";
			}else{
				low_cost_grey_style = "visibility:hidden";
			}
			if(mm_item_high_margin_yn.equals("Y")){
				high_margin_grey_style = "visibility:visible";								
			}else{
				high_margin_grey_style = "visibility:hidden";
			}
			if(mm_item_Innovator_yn.equals("Y")){
				innovator_style		="visibility:visible";
			}else{
				innovator_style		="visibility:hidden";
			}
	return_val = low_cost_grey_style+"~"+high_margin_grey_style+"~"+innovator_style;

	return return_val;
	}

public LinkedHashMap getMedPlanDosageDtls(String order_id,String order_line_no, String disp_no, String disp_srl_no, String qty,String drug_code,String drug_desc,String pres_drug_code,String disp_drug_code,String  qty_issuelocal,String qty_issue,String impnote,String impnotelocal,String howtotakelocal,String drug_name_local,String howtotake,String[] dosedetlocal,String[] dosedet){

			LinkedHashMap hsh_med_plan = new LinkedHashMap();
			hsh_med_plan.put("qty",qty);
			hsh_med_plan.put("drug_name",drug_desc);
			hsh_med_plan.put("drug_code",drug_code);
			hsh_med_plan.put("morning",dosedet[0]==null?"":dosedet[0]);
			hsh_med_plan.put("afternoon",dosedet[1]==null?"":dosedet[1]);
			hsh_med_plan.put("evening",dosedet[2]==null?"":dosedet[2]);
			hsh_med_plan.put("night",dosedet[3]==null?"":dosedet[3]);
			hsh_med_plan.put("morninglocal",dosedetlocal[0]==null?"":dosedetlocal[0]);
			hsh_med_plan.put("afternoonlocal",dosedetlocal[1]==null?"":dosedetlocal[1]);
			hsh_med_plan.put("eveninglocal",dosedetlocal[2]==null?"":dosedetlocal[2]);
			hsh_med_plan.put("nightlocal",dosedetlocal[3]==null?"":dosedetlocal[3]);
			hsh_med_plan.put("qty_issuelocal",qty_issuelocal); 
			hsh_med_plan.put("qty_issue",qty_issue);
			hsh_med_plan.put("curr_disp_yn","Y");
			hsh_med_plan.put("merge_yn","N");
			hsh_med_plan.put("plan_recorded","N");
			hsh_med_plan.put("pres_drug_code",pres_drug_code);
			hsh_med_plan.put("disp_drug_code",disp_drug_code);
			hsh_med_plan.put("impnote",impnote);
			hsh_med_plan.put("impnotelocal",impnotelocal);
			hsh_med_plan.put("howtotakelocal",howtotakelocal);
			hsh_med_plan.put("drug_name_local",drug_name_local);
			hsh_med_plan.put("howtotake",howtotake);
			hsh_med_plan.put("disp_no",disp_no);
			hsh_med_plan.put("disp_srl_no",disp_srl_no);
			hsh_med_plan.put("checked","checked");
			hsh_med_plan.put("order_id",order_id);
			hsh_med_plan.put("order_line_no",order_line_no);


return hsh_med_plan;
}

public String getBMSQtyFill(int alt_size,String fractroundupyn,double ws_tot_qty,String bms_qty,String qty,double tot_qty){
 
 		if(alt_size > 1 ) {
			if(fractroundupyn.equals("Y")){
				if(ws_tot_qty != 0){
				     bms_qty	=	Float.parseFloat(bms_qty)- ws_tot_qty +"";
				}
			}
		} 
		else {
			if(ws_tot_qty != 0){
				bms_qty	=	(Double.parseDouble(bms_qty)- ws_tot_qty)+"";
			}
			else if(!qty.equals("") && !qty.equals("0")){
				if( !getBarcode_multi_id().equals("Y"))
					bms_qty	=	Float.parseFloat(bms_qty)- tot_qty +"";
			}
		}

 return bms_qty;
 }
//added 12C - end

public String getBarcodeID(String item_code,String store_code,String batch_id,String expiry_date){

		Connection connection 		= null;
		PreparedStatement pstmt 	= null;
		ResultSet resultSet 		= null;
		String barcode_id = "";

		try
		{
			connection =getConnection();
			pstmt = connection.prepareStatement("SELECT BARCODE_ID FROM ST_ITEM_BATCH WHERE STORE_CODE=? AND ITEM_CODE=? AND BATCH_ID=? AND  EXPIRY_DATE_OR_RECEIPT_DATE=TO_DATE(?,'DD/MM/YYYY')") ;
			pstmt.setString(1, store_code.trim());
			pstmt.setString(2, item_code.trim());
			pstmt.setString(3, batch_id.trim());
			pstmt.setString(4, expiry_date.trim());

			resultSet = pstmt.executeQuery() ;
			if(resultSet!=null && resultSet.next())
			{ 
				barcode_id = resultSet.getString("BARCODE_ID")==null?"":resultSet.getString("BARCODE_ID");

			}
		}
		catch(Exception e)
		{
			e.printStackTrace() ;
		}
 	    finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}catch(Exception es){
				es.printStackTrace() ;
			}
		}

		return barcode_id;	
   

}

//Added for MOHE-CRF-0074
	public ArrayList getRegionCheckExt(String region_code) {
		Connection connection = null ;
		PreparedStatement pstmt = null ;
		ResultSet resultSet = null ;
		ArrayList result=new ArrayList();
		try {
			connection = getConnection() ;
			pstmt = connection.prepareStatement("SELECT facility_id, facility_name FROM sm_facility_param_lang_vw sm_facility_param WHERE facility_id <> ? AND REGION_CODE= ? AND language_id = ? ORDER BY 2");
			
			pstmt.setString(1,login_facility_id.trim());
			pstmt.setString(2,region_code);
			pstmt.setString(3,getLanguageId());
			resultSet = pstmt.executeQuery() ;			

			while (resultSet!=null && resultSet.next()) {
				result.add(resultSet.getString("FACILITY_ID")==null?"":resultSet.getString("FACILITY_ID"));
				result.add(resultSet.getString("FACILITY_NAME")==null?"":resultSet.getString("FACILITY_NAME"));
			}
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try {
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch(Exception es) {
				es.printStackTrace() ;
			}
		}
		return result;
	}
	//Added for MOHE-CRF-0074
	
	//added for MOHE-CRF-0026.1
public String getBillingGrp(String patientid,String locale) throws Exception{ 
	//int count = 0;
	Connection connection = null ;
	PreparedStatement pstmt = null ;
	ResultSet resultSet = null;
	String settlement_id ="";
	try {
		connection = getConnection() ;
		pstmt		= connection.prepareStatement("SELECT a.SETTLEMENT_IND  from bl_blng_grp_lang_vw a, bl_visit_fin_dtls b where PATIENT_ID=? and a.BLNG_GRP_ID=b.BLNG_GRP_ID and a.LANGUAGE_ID=?");

		pstmt.setString(1,patientid);
		pstmt.setString(2,locale);
		resultSet	= pstmt.executeQuery();
		if(resultSet.next()) {				
			settlement_id = checkForNull(resultSet.getString("SETTLEMENT_IND"));

 		}
	}
		catch ( Exception e ) {
		e.printStackTrace() ;
		throw e ;
	}
	finally {
		try {
			closeResultSet( resultSet ) ;
			closeStatement( pstmt ) ;
			closeConnection( connection );
		}
		catch(Exception es) { es.printStackTrace();}
	}

	return settlement_id;
} 
public ArrayList getDispTmpNoAndSrlNo(String drug_code,String order_id,String order_line_no){ // Added for TTMWM-SCF-0184 -Start
	Connection conn = null;
	PreparedStatement pstm = null;
	ResultSet resultSet = null;
	ArrayList dispNoAndSrlNos = new ArrayList();
	String sql = "";
	 
		sql   = "SELECT disp_tmp_no disp_no, dtl_serial_num srl_no FROM ph_disp_dtl_tmp WHERE order_id = ? AND order_line_no = ? AND disp_drug_code = ? and facility_id=?";
	
	try{
		conn = getConnection();
		pstm = conn.prepareStatement(sql);
		pstm.setString(1, order_id);
		pstm.setString(2, order_line_no);
		pstm.setString(3, drug_code);
		pstm.setString(4, login_facility_id);
		resultSet = pstm.executeQuery();
		
		if(resultSet!=null && resultSet.next()){
			dispNoAndSrlNos.add(resultSet.getString("disp_no")==null?"":resultSet.getString("disp_no"));
			dispNoAndSrlNos.add(resultSet.getString("srl_no")==null?"":resultSet.getString("srl_no"));
		}
	}
	catch (Exception e) {
		e.printStackTrace();
	} 
	finally{ 
		try{
			closeResultSet(resultSet);
			closeStatement(pstm);
			closeConnection(conn);
		}
		catch (Exception es) {
			es.printStackTrace();
		}
	}
	return dispNoAndSrlNos;
	
}

//Added for ML-MMOH-SCF-1904 - Start
		public String getPatientLocation(String patient_id, String encounter_id) {
			Connection connection = null ;
			PreparedStatement pstmt = null ;
			ResultSet resultSet = null ;
			String locn_desc ="";
			try {
				connection = getConnection() ;
				pstmt = connection.prepareStatement(" SELECT B.SHORT_DESC FROM IP_OPEN_ENCOUNTER A, IP_NURSING_UNIT_LANG_VW B WHERE A.FACILITY_ID = B.FACILITY_ID AND A.NURSING_UNIT_CODE = B.NURSING_UNIT_CODE AND A.PATIENT_ID = NVL (?, A.PATIENT_ID) AND A.ENCOUNTER_ID = NVL (?, A.ENCOUNTER_ID) AND B.LANGUAGE_ID=? ");
				
				pstmt.setString(1,patient_id);
				pstmt.setString(2,encounter_id);
				pstmt.setString(3,getLanguageId());
				resultSet = pstmt.executeQuery() ;			

				if (resultSet!=null && resultSet.next()) {
					locn_desc = resultSet.getString("SHORT_DESC")==null?"":resultSet.getString("SHORT_DESC");
				}
				
			}
			catch ( Exception e ) {
				e.printStackTrace() ;
			}
			finally {
				try {
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}
				catch(Exception es) {
					es.printStackTrace() ;
				}
			}
			return locn_desc;
		}
	//Added for ML-MMOH-SCF-1904 - End
	
	//Added for GHL-CRF-0627.2
		public String getPatientClass(String patient_id,String encounter_id)	{
			Connection connection		= null ;
			PreparedStatement pstmt		= null ;
			ResultSet resultSet			= null ;
			String sql				=	"";
			String patient_class	="";
			try{
				connection			= getConnection() ;

				sql=" select distinct a.patient_class from pr_encounter a, or_order b where a.patient_id = b.patient_id and a.patient_id=? and a.encounter_id=? and a.encounter_id = b.encounter_id " ;

				pstmt				= connection.prepareStatement(sql) ;
				pstmt.setString(1,patient_id);
				pstmt.setString(2,encounter_id);
				
				resultSet	= pstmt.executeQuery();
				if (resultSet!=null && resultSet.next()) {
					patient_class=resultSet.getString("PATIENT_CLASS");
				}
			}
			catch(Exception e){
				 e.printStackTrace();
			}
	 	    finally {
				try{
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}catch(Exception es){
					es.printStackTrace();
				}
			}

		return 	patient_class;
	}
	//Added for GHL-CRF-0627.2
	//Added for jd-crf-0221
		public String getBmsCode(String strOrderId,String order_line_num){
			Connection connection = null ;
			PreparedStatement pstmt = null ;
			ResultSet resultSet = null ;
	String label_bms_remarks_code="";
			//String strNextCollectionDate = null;
			//ArrayList alBMSdtl = new ArrayList();
			try {
				connection = getConnection() ;
				pstmt = connection.prepareStatement("select LABEL_BMS_REMARKS_CODE from OR_ORDER_LINE_PH WHERE ORDER_ID = ? and ORDER_LINE_NUM=?") ;//Query changed for ML-BRU-SCF-1224 [IN:046574]
				pstmt.setString(1,strOrderId);
				pstmt.setString(2,order_line_num);

				resultSet = pstmt.executeQuery() ;
				while (resultSet.next()) {
					label_bms_remarks_code=(String)resultSet.getString("LABEL_BMS_REMARKS_CODE")==null?"":(String)resultSet.getString("LABEL_BMS_REMARKS_CODE");
					
				}
			}catch ( Exception e ) {
				e.printStackTrace() ;
			}
			finally {
				try {
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}catch(Exception es) {
					es.printStackTrace() ;
				}
			}
			return label_bms_remarks_code;
		}
		
		public void setDispDrugRights(String disp_locn_code){//Adding start for Performance Issue by chandra 17072022

        Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;
		String sql = "";
    
	try{
				connection			= getConnection() ;
		 sql ="SELECT DISP_AUTH_REQD_DRUG_YN,DISP_NARCOTIC_YN,DISP_CONTROLLED_DRUG_YN FROM PH_DISP_RIGHTS WHERE FACILITY_ID =? AND DISP_LOCN_CODE =? AND APPL_USER_ID=?";

		 pstmt				= connection.prepareStatement(sql) ;
				pstmt.setString(1,login_facility_id.trim());
				pstmt.setString(2,disp_locn_code);
				pstmt.setString(3,login_by_id);

				System.err.println("login_facility_id@@==="+login_facility_id+"disp_locn_code==="+disp_locn_code+"getUserName---"+getUserName()+"login_by_id=="+login_by_id);
				
				resultSet	= pstmt.executeQuery();
				if (resultSet!=null && resultSet.next()) {
					 setDispGenralDrug(resultSet.getString("DISP_AUTH_REQD_DRUG_YN")==null?"N":resultSet.getString("DISP_AUTH_REQD_DRUG_YN"));
					 setDispNarcoDrug(resultSet.getString("DISP_NARCOTIC_YN")==null?"N":resultSet.getString("DISP_NARCOTIC_YN"));
					 setDispControlDrug(resultSet.getString("DISP_CONTROLLED_DRUG_YN")==null?"N":resultSet.getString("DISP_CONTROLLED_DRUG_YN"));
					 System.err.println("General_yn ==="+getDispGenralDrug()+"Narco Yn=="+getDispNarcoDrug()+"control yn ==="+getDispControlDrug());
				}
			}
			catch(Exception e){
				 e.printStackTrace();
			}
	 	    finally {
				try{
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}catch(Exception es){
					es.printStackTrace();
				}
			}
	}//Adding end for Performance Issue by chandra 17072022

		//(String pres_remarks,String slidingscaleremarks,String allergy_override_reason,String duplicate_drug_override_reason,String drug_db_product_id,String dosage_limit_override_reason,String interaction_override_reason,String lab_interaction_override_reason,String food_interaction_override_reason,String contraind_override_reason,String drug_remarks,String prn_remarks,String pharma_remarks,String verificationremarks,String abuse_drug_override_reason,String drugIndication){
			public StringBuffer getremarks(String pres_remarks,String slidingscaleremarks,String allergy_override_reason,String duplicate_drug_override_reason,String drug_db_product_id,String dosage_limit_override_reason,String interaction_override_reason,String lab_interaction_override_reason,String food_interaction_override_reason,String contraind_override_reason,String drug_remarks,String prn_remarks,String pharma_remarks,String verificationremarks,String abuse_drug_override_reason,String drugIndication){

			StringBuffer ret_drug_remarks;
			String locale = getLanguageId();
		     java.util.Locale loc = new java.util.Locale(locale);
		     java.util.ResourceBundle ph_labels = java.util.ResourceBundle.getBundle( "ePH.resources.Labels",loc);
		    
			ret_drug_remarks = new StringBuffer( ph_labels.getString("ePH.PractitionerPharmacistInstructions.label")+" : \n"); //code added for Bru-HIMS-CRF-416[IN045566]-- Start								
			
			if(!pres_remarks.trim().equals(""))
				ret_drug_remarks.append( ph_labels.getString("ePH.PrescriptionInstructions.label")+" : "+pres_remarks.trim()+"\n");
			
			if(!allergy_override_reason.trim().equals(""))
				ret_drug_remarks.append("Allergy Override Reason : "+allergy_override_reason.trim()+"\n");		
			if(!duplicate_drug_override_reason.trim().equals("")){
				
				if(drug_db_product_id != null  && !drug_db_product_id.equals(""))
				   ret_drug_remarks.append( ph_labels.getString("ePH.DuplicateTheraphyOverrideReason.label")+" : "+duplicate_drug_override_reason.trim()+"\n");
				else
					ret_drug_remarks.append( ph_labels.getString("ePH.DuplicateDrugOverrideReason.label")+" : "+duplicate_drug_override_reason.trim()+"\n");
			} 
			if(!dosage_limit_override_reason.trim().equals(""))
				ret_drug_remarks.append(ph_labels.getString("ePH.DosageOverrideReason.label")+" : "+dosage_limit_override_reason.trim()+"\n");
		
			if(!interaction_override_reason.trim().equals(""))
				ret_drug_remarks.append(	ph_labels.getString("ePH.Drug-DrugInteractionOverrideReason.label")+" : "+interaction_override_reason.trim()+"\n"); //modified for MMS-KH-CRF-0029
			
			if(!lab_interaction_override_reason.trim().equals(""))
				ret_drug_remarks.append(ph_labels.getString("ePH.Drug-LabInteractionOverrideReason.label")+" : "+lab_interaction_override_reason.trim()+"\n");
			if(!food_interaction_override_reason.trim().equals(""))
				ret_drug_remarks.append(ph_labels.getString("ePH.Drug-FoodInteractionOverrideReason.label")+" : "+food_interaction_override_reason.trim()+"\n");
			
			if(!contraind_override_reason.trim().equals(""))
				ret_drug_remarks.append(	ph_labels.getString("ePH.ContraIndicationOverrideReason.label")+" : "+contraind_override_reason.trim()+"\n");								
			if(!drug_remarks.equals(""))
				ret_drug_remarks.append(ph_labels.getString("ePH.DrugInstructions.label")+" : "+ret_drug_remarks+"\n");
			
			if(!prn_remarks.trim().equals(""))
				ret_drug_remarks.append(ph_labels.getString("ePH.PRNInstructions.label")+" : "+prn_remarks.trim()+"\n");						
			if(!pharma_remarks.trim().equals(""))
			{
				ret_drug_remarks.append(ph_labels.getString("ePH.PharmacistsInstructions.label")+" : "+pharma_remarks.trim()+"\n");//ML-bru-SCF-2213 
			}
			 if(!verificationremarks.trim().equals(""))
				ret_drug_remarks.append(ph_labels.getString("ePH.VerificationRemarks.label")+" : "+verificationremarks.trim()+"\n");			//code added for Bru-HIMS-CRF-416[IN045566]-- End
				//!abuse_drug_override_reason.trim().equals("") added for aakh-crf-0140
				if(!abuse_drug_override_reason.trim().equals(""))
					ret_drug_remarks.append("DrugAbuse Remarks : "+abuse_drug_override_reason.trim()+"\n");	
				if(drugIndication !=null && !drugIndication.equals("")){
					ret_drug_remarks.append("Drug Indications : "+drugIndication.trim()+"\n");
				}
		System.out.println("abuse_drug_override_reason"+abuse_drug_override_reason+"drugs_remarks"+ret_drug_remarks);
		//abuse_drug_override_reason.trim().equals("") added for aakh-crf-0140
		//added for file split
			return ret_drug_remarks;
		}
		
		public float remarksHight(String prn_remarks,String drug_remarks,String pres_remarks,String pharma_remarks,String slidingscaleremarks,String verificationremarks,String show_remarks){
			float dialog_height		=	0;
			if(!prn_remarks.trim().equals(""))
				dialog_height	 += 6.5;

			if(!drug_remarks.trim().equals(""))
				dialog_height	 += 6.5;
		
			if(!pres_remarks.trim().equals(""))
				dialog_height	 += 6.5;
		
			if(!pharma_remarks.trim().equals(""))
				dialog_height	 += 6.5;

			if(!slidingscaleremarks.trim().equals(""))
				dialog_height	 += 6.5;
			if(!verificationremarks.trim().equals(""))
				dialog_height	 += 6.5;
			if(show_remarks.equals("Y"))
				dialog_height	 += 13;

		
			if(dialog_height>18) 
				dialog_height = dialog_height-4;
			if(dialog_height==18) 
				dialog_height = dialog_height-3;
			if(dialog_height==12) 
				dialog_height = dialog_height-1;
			
			dialog_height	 += 1.4;	
		
			return dialog_height;
		}
      
	public void setDispBeyondBeforeValues(){//Added for COMMON-ICN-0116 [39681]

	        Connection connection		= null ;
			PreparedStatement pstmt		= null ;
			ResultSet resultSet			= null ;
			String sql = "";
	    
		try{
					connection			= getConnection() ;
			 sql ="SELECT disp_before_start_date_yn, disp_before_no_of_days, disp_beyond_earliest_start_yn, disp_beyond_no_of_days FROM ph_facility_param WHERE facility_id = ?";
			 pstmt				= connection.prepareStatement(sql) ;
					pstmt.setString(1, login_facility_id.trim());
					System.err.println("login_facility_id=="+login_facility_id.trim());
					resultSet	= pstmt.executeQuery();
					if (resultSet!=null && resultSet.next()) {
						setDisp_before_start_date_yn(resultSet.getString("disp_before_start_date_yn")==null?"":resultSet.getString("disp_before_start_date_yn"));
						setDisp_before_no_of_days(resultSet.getString("disp_before_no_of_days")==null?"":resultSet.getString("disp_before_no_of_days"));
						setDisp_beyond_earliest_start_yn(resultSet.getString("disp_beyond_earliest_start_yn")==null?"":resultSet.getString("disp_beyond_earliest_start_yn"));
						setDisp_beyond_no_of_days(resultSet.getString("disp_beyond_no_of_days")==null?"":resultSet.getString("disp_beyond_no_of_days"));
						
						 System.err.println("disp_before_start_date_yn ==="+getDisp_before_start_date_yn()+"disp_before_no_of_days=="+getDisp_before_no_of_days()+"disp_beyond_earliest_start_yn==="+getDisp_beyond_earliest_start_yn()+"disp_beyond_no_of_days==="+getDisp_beyond_no_of_days());	 
					}
				}
				catch(Exception e){
					 e.printStackTrace(); 
				}
		 	    finally {
					try{
						closeResultSet( resultSet ) ;
						closeStatement( pstmt ) ;
						closeConnection( connection );
					}catch(Exception es){
						es.printStackTrace();
					}
				}
		}//Added for COMMON-ICN-0116 [39681]
	
	public void setExclOrdLocnDispenseYN(){//Added for ML-MMOH-CRF-2085
        Connection connection		= null ;
		PreparedStatement pstmt		= null ;
		ResultSet resultSet			= null ;
		String sql = "";
	try{
				connection			= getConnection() ;
		 sql ="SELECT excl_ord_locn_dispense_yn FROM ph_facility_param WHERE facility_id = ?";
		 pstmt				= connection.prepareStatement(sql) ;
				pstmt.setString(1, login_facility_id.trim());
				resultSet	= pstmt.executeQuery();
				if (resultSet!=null && resultSet.next()) {
					setExclOrdLocnDispenseYN(resultSet.getString("excl_ord_locn_dispense_yn")==null?"":resultSet.getString("excl_ord_locn_dispense_yn"));	 
				}
			}
			catch(Exception e){
				 e.printStackTrace();
			}
	 	    finally {
				try{
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}catch(Exception es){
					es.printStackTrace();
				}
			}
	}//Added for ML-MMOH-CRF-2085	
	public void setTokenNoDefaultDispMed(){	//Added by Himanshu for ML-MMOH-CRF-2094
		Connection connection	= null;
        PreparedStatement pstmt	= null;
        ResultSet resultSet		= null;
		String Token_No_Default_DispMed_yn	= "N";
		System.out.println("login_facility_id.trim()====> 1"+login_facility_id.trim());
		System.out.println("select Token_No_Default_DispMed_yn FROM ph_facility_param where facility_id ='"+login_facility_id.trim()+"'");
		
		
		try {
            connection	= getConnection() ;
			pstmt		= connection.prepareStatement( "select Token_No_Default_DispMed_yn FROM ph_facility_param where facility_id =?") ;
			pstmt.setString(1,login_facility_id.trim());
            resultSet	= pstmt.executeQuery() ;
			if(resultSet.next()){
				Token_No_Default_DispMed_yn = checkForNull(resultSet.getString("Token_No_Default_DispMed_yn"));
			}
			setToken_No_Default_DispMed(Token_No_Default_DispMed_yn);
		}
		catch ( Exception e ) {
			e.printStackTrace() ;
		}
		finally {
			try{
				closeResultSet( resultSet ) ;
				closeStatement( pstmt ) ;
				closeConnection( connection );
			}
			catch ( Exception es ) {
				es.printStackTrace() ;
			}
		}
	}
	//below methods added for MO-MCMSS-CRF-0009	start
	public boolean getPhIssueSite() throws Exception {
	  boolean ph_integration_ip_ph_device =false;
	  java.sql.Connection connection = null;
	  try
	  {	
	  	connection = getConnection() ;
	  	ph_integration_ip_ph_device = eCommon.Common.CommonBean.isSiteSpecific(connection, "PH","PH_INTEGRATION_IP_PH_DEVICE");
	  	System.out.println("PH_INTEGRATION_IP_PH_DEVICE---->"+ph_integration_ip_ph_device);
	  }
	  finally
	  {
	  	if(connection != null)
	  		closeConnection(connection) ;
	  }return ph_integration_ip_ph_device;
	}
	
	
	public void createFile(HashMap<String, Object> details) {
	    String patientId = (String) details.get("patientId");
	    System.out.println("patientId from " + patientId);
	    String doc_no = (String) details.get("doc_no");
	    System.out.println("doc_no from " + doc_no);
	    String orderfromOrderdata = null;
	    ArrayList<String> orderIdData = getOrderIdFromDoc(doc_no);

	    ArrayList arrList = getExcelData(orderIdData);

	    String filePath = getFilePath();
	    System.out.println("Doc_no from the delivey stager" + doc_no);
	    FileOutputStream out = null;
	    try {     
	        StringBuilder csvContent = new StringBuilder();
	        String[] headers = new String[] { "PrescriptionNo", "Seqno", "MachineNo", "PatientID", "PatientName", "EnglishName", "BirthDay", "Sex", "IOFlg", "WardCd", "WardName", "RoomNo", "BedNo", "DoctorCd", "DoctorName", "PrescriptionDate", "TakeDate", "TakeTime", "LastTime", "Presc_Class", "Drugcd", "DrugName", "DrugShape", "PrescriptionDose", "PrescriptionUnit", "DispensedDose", "DispensedUnit", "Amount_per_package", "Firm_id", "Dispense_days", "Freq_desc_code", "Freq_desc", "Freq_counter", "Freq_desc_Detail_code", "Freq_desc_Detail", "Explanation_code", "Explanation", "Administration_name", "DoctorComment", "BagOrderby", "MakeRecTime", "Order_No", "Order_Sub_No", "BagPrintFmt", "BagLen", "TicketNo", "BagPrintPatientNm", "FreePrintItem_Presc1", "FreePrintItem_Presc2", "FreePrintItem_Presc3", "FreePrintItem_Presc4", "FreePrintItem_Presc5", "FreePrintItem_Drug1", "FreePrintItem_Drug2", "FreePrintItem_Drug3", "FreePrintItem_Drug4", "FreePrintItem_Drug5", "SyntheticFlg", "CutFlg", "PharmacyTime", "CarvedSeal", "CarvedSealAbb", "PreBarcode1", "PreBarcode2", "PreDrugBarcode", "PreBarcodeFmt", "DrugBarcode1", "DrugBarcode2", "DrugBarcode3", "DrugBarcode4", "DrugBarcode5", "DrugBarcode6", "DrugBarcode7", "DrugBarcode8", "DrugBarcode9", "DrugBarcode10", "MassPrint1", "MassPrint2", "MassPrint3", "MassPrint4", "MassPrint5", "MassPrint6", "FreePrintItem_Drug6", "FreePrintItem_Drug7", "FreePrintItem_Drug8", "FreePrintItem_Drug9", "FreePrintItem_Drug10", "InsertMessageFlg", "InsertMessageBagPrintFmt", "InsertMessageBagLen", "InsertMessageTakeDate", "InsertMessage1", "InsertMessage2", "InsertMessage3", "DrugPac", "DrugTouchPanel", "FreePrintItem_Drug11", "FreePrintItem_Drug12", "FreePrintItem_Drug13", "FreePrintItem_Drug14", "FreePrintItem_Drug15", "FreePrintItem_Drug16", "FreePrintItem_Drug17", "FreePrintItem_Drug18", "FreePrintItem_Drug19", "FreePrintItem_Drug20" };
	        for (int i = 0; i < headers.length; i++) {
	            csvContent.append(headers[i]);
	            if (i < headers.length - 1) {
	                csvContent.append(",");
	            }
	        }
	        csvContent.append("\n");
	        for (int i = 0; i < arrList.size(); i++) {
	            String[] record = (String[]) arrList.get(i);
	            for (int j = 0; j < record.length; j++) {
	                csvContent.append(record[j]);
	                if (j < record.length - 1) {
	                    csvContent.append(",");
	                }
	            }
	            csvContent.append("\n");
	        }
	        
	        Timestamp timestamp = new Timestamp(System.currentTimeMillis());
		    SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd-HH-mm-ss");
		    String dateString = dateFormat.format(timestamp);         
	      
	        out = new FileOutputStream(filePath + doc_no + "_" + patientId +"_"+dateString+ ".csv");
	        out.write(csvContent.toString().getBytes("UTF-8"));
	        System.out.println("CSV file created successfully: " + filePath + doc_no + "_" + patientId+"_"+dateString + ".csv");
	    } catch (Exception e) {
	        e.printStackTrace();
	    } finally {
	        if (out != null) {
	            try {
	                out.close();
	            } catch (IOException e) {
	                e.printStackTrace();
	            }
	        }
	    }
	}
	
	public java.util.ArrayList getExcelData(ArrayList orderIdData) {
		ArrayList excelData = new ArrayList();
		java.sql.Connection connection = null;
		java.sql.PreparedStatement  pstmt = null;
		java.sql.ResultSet  resultSet = null;	
		try {
			 for (int k = 0; k < orderIdData.size(); k++) {
			    connection = getConnection();     
			    pstmt = connection.prepareStatement("select TO_CHAR(sysdate,'YYYYMMDD')||LPAD(substr(b.order_id,5),22,'0') PrescriptionNo,b.order_line_num Seqno,'1' MachineNo,a.patient_id PatientID,c.patient_name PatientName,c.patient_name_loc_lang EnglishName,TO_CHAR(c.DATE_OF_BIRTH,'YYYYMMDD') BirthDay,decode(c.sex,'M','1','F','2','U','9') Sex,decode(a.patient_class,'OP','1','IP','2') IOFlg,d.locn_code WardCd,decode(a.patient_class,'OP',op_get_desc.op_clinic(?,d.locn_code,?,'2'),'IP',ip_get_desc.ip_nursing_unit(?,d.LOCN_CODE,?,'2')) WardName,NULL RoomNo,NULL BedNo,NULL DoctorCd,NULL DoctorName,TO_CHAR(d.DISPENSED_DATE_TIME, 'YYYYMMDD hhmmss') PrescriptionDate,TO_CHAR(b.START_DATE_TIME,'YYYYMMDD') TakeDate,(select replace(order_line_field_value,':','') from OR_ORDER_LINE_FIELD_VALUES k where k.order_id = a.order_id order by ORDER_LINE_SEQ_NUM asc FETCH FIRST 1 ROW ONLY) TakeTime,(select replace(order_line_field_value,':','') from OR_ORDER_LINE_FIELD_VALUES k where k.order_id = a.order_id order by ORDER_LINE_SEQ_NUM desc FETCH FIRST 1 ROW ONLY) LastTime,decode(b.priority,'R','0','U','1') Presc_Class,e.disp_drug_code Drugcd,(select drug_desc from ph_drug where drug_code=e.disp_drug_code) DrugName,(SELECT EXT_PK_ID FROM xh_oth_appl_data_skey WHERE table_id = 'PH_FORM' AND application_id = 'CONSISRD' AND PK_VALUE like e.disp_uom_code ||'%') DrugShape,NULL PrescriptionDose,NULL PrescriptionUnit,e.disp_qty DispensedDose,e.disp_uom_code DispensedUnit,NULL Amount_per_package,NULL Firm_id,round((TO_NUMBER(e.disp_qty) * ((TO_NUMBER(f.interval_value)/DECODE(f.repeat_durn_type,'D',1,'L',30,'H',24,'W',7))/(TO_NUMBER(f.repeat_value)))),2) Dispense_days,NULL Freq_desc_code,am_get_desc.am_frequency(b.freq_code,?,1) Freq_desc,((f.repeat_value||'/' ||f.interval_value)||': '|| am_get_desc.am_frequency(b.freq_code,?,1)) Freq_counter,(SELECT REPLACE(REGEXP_REPLACE(ph_get_dosage_display(a.order_id,'1',?), '^Timings:\\s+([^Dosage]+)\\s+Dosage\\s+:.*$', '\\1'), ':',  '' ) from dual) Freq_desc_Detail_code,(SELECT REPLACE(REGEXP_REPLACE(ph_get_dosage_display(a.order_id,'1',?), '^Timings:\\s+([^Dosage]+)\\s+Dosage\\s+:.*$', '\\1'), ':00',  '' ) FROM dual) Freq_desc_Detail,NULL Explanation_code,NULL Explanation,NULL Administration_name,NULL DoctorComment,NULL BagOrderby,NULL MakeRecTime,NULL Order_No,NULL Order_Sub_No,NULL BagPrintFmt,NULL BagLen,NULL TicketNo,NULL BagPrintPatientNm,NULL FreePrintItem_Presc1,NULL FreePrintItem_Presc2,NULL FreePrintItem_Presc3,NULL FreePrintItem_Presc4,NULL FreePrintItem_Presc5,NULL FreePrintItem_Drug1,NULL FreePrintItem_Drug2,NULL FreePrintItem_Drug3,NULL FreePrintItem_Drug4,NULL FreePrintItem_Drug5,NULL SyntheticFlg,NULL CutFlg,NULL PharmacyTime,NULL CarvedSeal,NULL CarvedSealAbb,NULL PreBarcode1,NULL PreBarcode2,NULL PreDrugBarcode,NULL PreBarcodeFmt,NULL DrugBarcode1,NULL DrugBarcode2,NULL DrugBarcode3,NULL DrugBarcode4,NULL DrugBarcode5,NULL DrugBarcode6,NULL DrugBarcode7,NULL DrugBarcode8,NULL DrugBarcode9,NULL DrugBarcode10,NULL MassPrint1,NULL MassPrint2,NULL MassPrint3,NULL MassPrint4,NULL MassPrint5,NULL MassPrint6,NULL FreePrintItem_Drug6,NULL FreePrintItem_Drug7,NULL FreePrintItem_Drug8,NULL FreePrintItem_Drug9,NULL FreePrintItem_Drug10,NULL InsertMessageFlg,NULL InsertMessageBagPrintFmt,NULL InsertMessageBagLen,NULL InsertMessageTakeDate,NULL InsertMessage1,NULL InsertMessage2,NULL InsertMessage3,NULL DrugPac,NULL DrugTouchPanel,NULL FreePrintItem_Drug11,NULL FreePrintItem_Drug12,NULL FreePrintItem_Drug13,NULL FreePrintItem_Drug14,NULL FreePrintItem_Drug15,NULL FreePrintItem_Drug16,NULL FreePrintItem_Drug17,NULL FreePrintItem_Drug18,NULL FreePrintItem_Drug19,NULL FreePrintItem_Drug20 from or_order a, or_order_line b, mp_patient c,ph_disp_hdr d,ph_disp_dtl e,AM_FREQUENCY f where a.order_id =b.order_id and a.patient_id =c.patient_id and b.order_id = e.order_id and b.order_line_num =e.order_line_no and d.facility_id = e.facility_id and d.disp_no = e.disp_no and f.freq_code = b.freq_code and a.order_id =?");
			    pstmt.setString(1, getOrderingFacility());
				pstmt.setString(2, getLanguageId());
				pstmt.setString(3, getOrderingFacility());
				pstmt.setString(4, getLanguageId());
				pstmt.setString(5, getLanguageId());
				pstmt.setString(6, getLanguageId());
				pstmt.setString(7, getOrderingFacility());
			    pstmt.setString(8, getOrderingFacility());
				pstmt.setString(9, (String)orderIdData.get(k));
			    resultSet = pstmt.executeQuery();
			    while (resultSet != null && resultSet.next()) {
			        String[] record = new String[106];    
			        System.out.println(record.length);
			        for (int i = 0; i < record.length; i++) {
			            record[i] = resultSet.getString(i + 1);
			        }
			        excelData.add(record);
			    }
			}
		} 
		catch (Exception e) {
		    e.printStackTrace();
		} 
		finally {
		    try{
		        closeResultSet(resultSet);
		        closeStatement(pstmt);
		        closeConnection(connection);
		    }catch(Exception es){
				es.printStackTrace();
		    }
		}
		return excelData;
		}
	
	public String getFilePath(){
	    java.sql.Connection connection = null;
	    java.sql.PreparedStatement  pstmt = null;
	    java.sql.ResultSet  resultSet = null;
	    String filePath ="";
	    try {
	        connection = getConnection();          
	         pstmt = connection.prepareStatement("select ITEM_IMAGE_PATH from ph_param");
	         resultSet = pstmt.executeQuery();
	         
	         while (resultSet != null && resultSet.next()) {       
	        	 filePath = resultSet.getString("ITEM_IMAGE_PATH");           	 
	         }             
	    } 
		catch (Exception e) {
	        e.printStackTrace();
	    } 
		finally {
	        try{
	            closeResultSet(resultSet);
	            closeStatement(pstmt);
	            closeConnection(connection);
	        }catch(Exception es){
				es.printStackTrace();
	        }
	    }
		return filePath;
	}
	public ArrayList getOrderIdFromDoc(String docNo){
	    java.sql.Connection connection = null;
	    java.sql.PreparedStatement  pstmt = null;
	    java.sql.ResultSet  resultSet = null;
	    ArrayList orderIdData = new ArrayList();
	    try {
	        connection = getConnection();          
	         pstmt = connection.prepareStatement("select order_id from ph_disp_hdr where doc_no = ? ");
	         pstmt.setString(1,docNo);
	         resultSet = pstmt.executeQuery();
	         
	         while (resultSet != null && resultSet.next()) { 	        
	 	       orderIdData.add(resultSet.getString("order_id"));
	 	    }            
	    } 
		catch (Exception e) {
	        e.printStackTrace();
	    } 
		finally {
	        try{
	            closeResultSet(resultSet);
	            closeStatement(pstmt);
	            closeConnection(connection);
	        }catch(Exception es){
				es.printStackTrace();
	        }
	    }
		return orderIdData;
	}
	//below methods added for MO-MCMSS-CRF-0009	end by Kishore
	
	
	public String getPrintType(String disp_locn_code)	{
			Connection connection		= null ;
			PreparedStatement pstmt		= null ;
			ResultSet resultSet			= null ;
			String sql				=	"";
			String print_type	="";
			try{
				connection			= getConnection() ;

				sql=" select IP_PRINT_FILL_SHEET_FLAG from ph_disp_locn WHERE DISP_LOCN_CODE = ? AND FACILITY_ID=? " ;

				pstmt				= connection.prepareStatement(sql) ;
				pstmt.setString(1,disp_locn_code);
				pstmt.setString(2,login_facility_id.trim());
				
				resultSet	= pstmt.executeQuery();
				if (resultSet!=null && resultSet.next()) {
					print_type=checkForNull(resultSet.getString("IP_PRINT_FILL_SHEET_FLAG"),"O");
				}
			}
			catch(Exception e){
				 e.printStackTrace();
			}
	 	    finally {
				try{
					closeResultSet( resultSet ) ;
					closeStatement( pstmt ) ;
					closeConnection( connection );
				}catch(Exception es){
					es.printStackTrace();
				}
			}
		
			return print_type;	
		}

		
		
		//methods added for RBU-GHL-CRF-0047 start by Kishore
		public int getStatCount(String patientId,String dispLocationCode,String languageId,String fromdate,String toDate,String freqDurnYn,String freq_nature,String disp_stage,String prescription_number){
			
		    java.sql.Connection connection = null;
		    java.sql.PreparedStatement  pstmt = null;
		    java.sql.ResultSet  resultSet = null;
		    StringBuffer sbMainSql = new StringBuffer();
		    int statCount = 0;
		    try {
		        connection = getConnection();  
		        sbMainSql.append("SELECT SUM(yellow) as cnt FROM (SELECT (SELECT COUNT(ROUTINE_ORDER_ID) FROM or_order_line_ph WHERE ROUTINE_ORDER_ID=a.order_id) yellow FROM or_order_line b, or_order a, ip_nursing_unit_lang_vw e, or_order_status_code c, sm_facility_param_lang_vw g, am_practitioner_lang_vw f, ph_drug i, or_order_line_ph j WHERE b.order_id = a.order_id AND b.order_id = j.order_id AND b.order_line_num = j.order_line_num AND g.facility_id = a.ordering_facility_id AND a.ord_pract_id = f.practitioner_id AND e.nursing_unit_code = a.source_code AND c.order_status_code = b.order_line_status /* CHECK FOR PATIENT ID HERE */ AND a.patient_id = ? and a.ORDER_STATUS!='DF'");
		        if(disp_stage.equals("V"))
		        {
		        sbMainSql.append(" AND c.order_status_type = '10' ");
		        }
		        if(disp_stage.equals("F"))
		        {
		        sbMainSql.append(" AND c.order_status_type IN ('10', '94', '25', '30','56','62') ");
		        }
		        if(disp_stage.equals("D"))
		        {
				sbMainSql.append(" AND c.order_status_type = '35'");
				}
		        if(!prescription_number.equals(""))
		        {
		        	sbMainSql.append(" AND a.TRN_GROUP_REF='"+prescription_number+"'");	
		        }
		         sbMainSql.append(" AND ph_check_ord_date_dispensing(b.start_date_time, b.end_date_time, ?) = 1 AND a.patient_class = 'IP' AND a.order_category = 'PH' AND ph_disp_locn_appl_yn(a.orig_performing_deptloc_code, ?, a.source_type, a.source_code, a.added_facility_id, a.performing_facility_id, a.performing_deptloc_code, i.drug_class, i.drug_code, b.order_type_code, a.patient_class, a.priority, a.discharge_ind, DECODE(i.drug_yn, 'Y', 'D', 'N', 'M'), a.iv_prep_yn, a.orig_performing_deptloc_code, a.order_id, a.home_leave_medn_yn, a.patient_id, a.encounter_id) = 'Y' AND e.nursing_unit_code = a.source_code AND e.facility_id = a.ordering_facility_id AND e.language_id = g.language_id AND e.language_id = f.language_id AND e.language_id = ? AND b.order_catalog_code = i.drug_code AND NVL(a.iv_prep_yn, 'X') NOT IN ('7', '8') AND EXISTS (SELECT 'X' FROM ip_open_encounter ioen WHERE facility_id = a.ordering_facility_id AND encounter_id = a.encounter_id) AND a.ordering_facility_id = ? AND b.start_date_time BETWEEN TO_DATE(?, 'DD/MM/YYYY') AND TO_DATE(?, 'DD/MM/YYYY') + .99999 AND (i.calc_dosg_by_freq_durn_yn = DECODE(?, 'Y', 'N', i.calc_dosg_by_freq_durn_yn) OR ('Y' = (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature = 'O'))) AND EXISTS (SELECT 'Y' FROM am_frequency WHERE freq_code = b.freq_code AND freq_nature NOT IN (DECODE(?, 'Y', 'P', 'X'))) GROUP BY a.iv_prep_yn, a.trn_group_ref, a.priority, a.order_id, a.ord_date_time, f.practitioner_name, g.facility_name, a.source_code, a.patient_class, a.ordering_facility_id, a.performing_facility_id, f.practitioner_id, e.long_desc, a.encounter_id, a.modified_date, tapered_yn, taper_order_id) tab");
		         System.out.println("sbMainSql.toString()==>20319 "+sbMainSql.toString());
		         pstmt = connection.prepareStatement(sbMainSql.toString());
		         pstmt.setString(1,patientId);
		         pstmt.setString(2,login_facility_id);
		         pstmt.setString(3,dispLocationCode);
		         pstmt.setString(4,languageId);
		         pstmt.setString(5,login_facility_id);
		         pstmt.setString(6,fromdate);
		         pstmt.setString(7,toDate);
		         pstmt.setString(8,freqDurnYn);
		         pstmt.setString(9,freq_nature);
		        // pstmt.setString(10,login_facility_id);
		        // pstmt.setString(11,login_by_id);      
		         resultSet = pstmt.executeQuery();
		         while (resultSet != null && resultSet.next()) { 	        
		 	       statCount = resultSet.getInt("cnt");
		 	    }            
		    } 
			catch (Exception e) {
		        e.printStackTrace();
		    } 
			finally {
		        try{
		            closeResultSet(resultSet);
		            closeStatement(pstmt);
		            closeConnection(connection);
		        }catch(Exception es){
					es.printStackTrace();
		        }
		    }
		    System.out.println("statCount=> "+statCount);
			return statCount;
		}
		//methods added for RBU-GHL-CRF-0047 start by Kishore
		
		public int getStatCount_emergency(String patientId,String dispLocationCode,String languageId,String fromdate,String toDate,String freqDurnYn,String freq_nature,String disp_stage,String prescription_number){
			
		    java.sql.Connection connection = null;
		    java.sql.PreparedStatement  pstmt = null;
		    java.sql.ResultSet  resultSet = null;
		    StringBuffer sbMainSql = new StringBuffer();
		    int statCount = 0;
		    int position=0;
		    try {
		    	System.out.println("disp_stage==>"+disp_stage);
		        connection = getConnection();  
		        sbMainSql.append("SELECT SUM (yellow) AS cnt FROM (SELECT   (SELECT COUNT (routine_order_id)  FROM or_order_line_ph  WHERE routine_order_id = a.order_id) yellow FROM or_order_line b,  or_order a, sm_facility_param_lang_vw g,am_practitioner_lang_vw f,  or_order_line_ph k,or_order_status_code h,ph_drug i WHERE b.order_id = a.order_id AND b.order_id = k.order_id AND a.order_id = k.order_id AND b.order_line_num = k.order_line_num AND g.facility_id = a.ordering_facility_id AND a.ord_pract_id = f.practitioner_id");
		        if(disp_stage.equals("V"))
		        {
		        sbMainSql.append(" AND c.order_status_type = '10' ");
		        }
		        else if(disp_stage.equals("F") || disp_stage.equals("A"))
		        {
		        sbMainSql.append(" AND a.order_type_code IN (SELECT order_type_code FROM ph_order_type_for_drug_class)");
		        if(disp_stage.equals("A")){
		        	sbMainSql.append(" AND h.order_status_type = '35' ");
		        }else{
		        	sbMainSql.append(" AND h.order_status_type = '25' ");
		        }
		        sbMainSql.append(" AND NVL (a.iv_prep_yn, 'X') NOT IN ('7', '8') ");
		        }
		        else if(disp_stage.equals("D"))
		        {
				sbMainSql.append(" AND h.order_status_type IN ('36', '10', '30', '25')  AND NVL (a.iv_prep_yn, 'X') NOT IN ('7', '8') ");
				}
		        else if(disp_stage.equals("AS"))
		        {
				sbMainSql.append(" AND a.order_type_code IN (SELECT order_type_code FROM ph_order_type_for_drug_class)  AND (b.order_line_status NOT IN (SELECT order_status_code FROM or_order_status_code WHERE order_status_type IN  ('58', '94')) ) AND b.order_line_status IN ( SELECT order_status_code  FROM or_order_status_code WHERE order_status_type IN ('10', '25', '30', '50', '94') AND (b.order_line_status NOT IN (  SELECT order_status_code FROM or_order_status_code WHERE order_status_type IN ('58', '94')) )) AND NVL (a.iv_prep_yn, 'X') NOT IN ('7', '8') ");
				}
		        else
		        {
		        	sbMainSql.append(" AND h.order_status_type = '00'");
		        }
		        sbMainSql.append(" AND  TRUNC (b.start_date_time) BETWEEN TO_DATE (?, 'DD/MM/YYYY') AND  TO_DATE (?, 'DD/MM/YYYY') + .99999   AND a.patient_id = ? and ph_check_ord_date_dispensing (b.start_date_time, b.end_date_time, ?,  ?, ?,  ?, ? ) = 1 AND   a.order_category = 'PH' AND a.performing_deptloc_code = ? AND h.order_status_code = b.order_line_status AND f.language_id = g.language_id AND f.language_id = ? AND a.patient_class IN ('OP', 'EM') AND EXISTS ( SELECT 'Y'  FROM am_frequency WHERE freq_code = b.freq_code  AND freq_nature NOT IN (DECODE (?, 'Y', 'P', 'X'))) AND a.performing_deptloc_code = ? GROUP BY a.trn_group_ref, a.encounter_id, a.priority,  a.order_id, a.ord_date_time, f.practitioner_name, g.facility_name, a.source_code, a.source_type, a.patient_class, a.ordering_facility_id, a.performing_facility_id, f.practitioner_id, a.iv_prep_yn, a.modified_date ORDER BY a.priority ) tab");
		        System.out.println("===> "+sbMainSql.toString());
		        pstmt = connection.prepareStatement(sbMainSql.toString());
		        pstmt.setString(++position,order_date_from);						
				pstmt.setString(++position,order_date_to);
				pstmt.setString(++position,patientId);
				//ph_check_ord_date_dispensing starts
				pstmt.setString(++position,login_facility_id);
				pstmt.setString(++position,getDisp_before_start_date_yn());
				pstmt.setString(++position,getDisp_before_no_of_days());
				pstmt.setString(++position,getDisp_beyond_earliest_start_yn());
				pstmt.setString(++position,getDisp_beyond_no_of_days());
				//ph_check_ord_date_dispensing ends
				pstmt.setString(++position,getDispLocnCode());
				pstmt.setString(++position,getLanguageId());
				
				pstmt.setString(++position,freq_nature);
				pstmt.setString(++position,dispLocationCode);
				resultSet = pstmt.executeQuery();
		         while (resultSet != null && resultSet.next()) { 	        
		 	       statCount = resultSet.getInt("cnt");
		 	    }            
		    } 
			catch (Exception e) {
		        e.printStackTrace();
		    } 
			finally {
		        try{
		            closeResultSet(resultSet);
		            closeStatement(pstmt);
		            closeConnection(connection);
		        }catch(Exception es){
					es.printStackTrace();
		        }
		    }
		    System.out.println("statCount=> "+statCount);
			return statCount;
		}
		//Added for MMS-DM-CRF-0273
	public boolean getOrderStatus(String patientId, String encounterId){
	    java.sql.Connection connection = null;
	    java.sql.PreparedStatement  pstmt = null;
	    java.sql.ResultSet  resultSet = null;
	    int or_count=0;
	    boolean or_flag=false;
	    try {
	        connection = getConnection();          
	         pstmt = connection.prepareStatement("select count(*) as or_count from or_order where  PATIENT_ID = ? and ENCOUNTER_ID = ?");
			    pstmt.setString(1, patientId);
				pstmt.setString(2, encounterId);
	         resultSet = pstmt.executeQuery();
	         
	         while (resultSet != null && resultSet.next()) {       
	        	 or_count = resultSet.getInt("or_count");           	 
	         }          
	         if(or_count>0){
	        	 or_flag=true;
	         }else{
	        	 or_flag=false;
	         }
	    } 
		catch (Exception e) {
	        e.printStackTrace();
	    } 
		finally {
	        try{
	            closeResultSet(resultSet);
	            closeStatement(pstmt);
	            closeConnection(connection);
	        }catch(Exception es){
				es.printStackTrace();
	        }
	    }
		return or_flag;
	}
	
	public String getPrEncounterPatientClass(String patient_id, String encounter_id)
	{ 
		Connection connection	= null;
		PreparedStatement pstmt = null;
		ResultSet resultSet		= null;
		String actual_patient_class="";
		try {
			connection			= getConnection();
		
		pstmt = connection.prepareStatement( "SELECT DECODE(PATIENT_CLASS, 'IP','I','DC','D','OP','O','EM','E','XT','R') ENC_PATIENT_CLASS FROM PR_ENCOUNTER WHERE PATIENT_ID=? AND ENCOUNTER_ID = ? ");
		pstmt.setString(1,patient_id);
		pstmt.setString(2,encounter_id); 
		
		resultSet = pstmt.executeQuery() ;
							
		if(resultSet!=null && resultSet.next()){					
			
			actual_patient_class = resultSet.getString("ENC_PATIENT_CLASS");	
			if(actual_patient_class==null)
				actual_patient_class="";
			
			
		}
		} catch(Exception e) {
			e.printStackTrace();
		}
		    finally {
			try {
				closeResultSet(resultSet);
				closeStatement(pstmt);
				closeConnection(connection);
			}
			catch(Exception es){ 
				es.printStackTrace();
			}
		}

		return actual_patient_class;
	}
	
}	
