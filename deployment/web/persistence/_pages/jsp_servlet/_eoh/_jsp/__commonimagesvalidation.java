package jsp_servlet._eoh._jsp;

import java.io.*;
import java.util.*;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;
import java.sql.*;
import webbeans.eCommon.ConnectionManager;

public final class __commonimagesvalidation extends  weblogic.servlet.jsp.JspBase  implements weblogic.servlet.jsp.StaleIndicator {

    private static void _releaseTags(javax.servlet.jsp.PageContext pageContext, javax.servlet.jsp.tagext.JspTag t) {
        while (t != null) {
            weblogic.servlet.jsp.DependencyInjectionHelper.preDestroy(pageContext, t);
            if(t instanceof javax.servlet.jsp.tagext.Tag) {
                javax.servlet.jsp.tagext.Tag tmp = (javax.servlet.jsp.tagext.Tag)t;
                t = ((javax.servlet.jsp.tagext.Tag) t).getParent();
                try {
                    tmp.release();
                } catch(java.lang.Exception ignore) {}
            }
            else {
                t = ((javax.servlet.jsp.tagext.SimpleTag)t).getParent();
            }
        }
    }

    public boolean _isStale(){
        boolean _stale = _staticIsStale((weblogic.servlet.jsp.StaleChecker) getServletConfig().getServletContext());
        return _stale;
    }

    public static boolean _staticIsStale(weblogic.servlet.jsp.StaleChecker sci) {
        if (sci.isResourceStale("/eoh/jsp/CommonImagesValidation.jsp", 1709117114935L ,"10.3.6.0","Asia/Calcutta")) return true;
        if (sci.isResourceStale("/eOH/jsp/StringUtil.jsp", 1724302706763L ,"10.3.6.0","Asia/Calcutta")) return true;
        return false;
    }

    private static boolean _WL_ENCODED_BYTES_OK = true;
    private static final java.lang.String _WL_ORIGINAL_ENCODING = "UTF-8".intern();

    private static byte[] _getBytes(java.lang.String block){
        try {
            return block.getBytes(_WL_ORIGINAL_ENCODING);
        } catch (java.io.UnsupportedEncodingException u){
            _WL_ENCODED_BYTES_OK = false;
        }
        return null;
    }

    private final static java.lang.String  _wl_block0 ="<!DOCTYPE html>\n";
    private final static byte[]  _wl_block0Bytes = _getBytes( _wl_block0 );

    private final static java.lang.String  _wl_block1 ="\n";
    private final static byte[]  _wl_block1Bytes = _getBytes( _wl_block1 );

    private final static java.lang.String  _wl_block2 ="\n\n";
    private final static byte[]  _wl_block2Bytes = _getBytes( _wl_block2 );
 
// instead of using CommonBean.checkForNull use StringUtil.jsp  to filter null values
public String checkForNull(String str){
	return (str!=null && str.intern()!="null")?str:"";
}
public String checkForNull(String inputString,String defaultValue){
        return ( inputString == null || inputString.equals("") )    ?   defaultValue    :   inputString;
	}

public String format_decimal(Double gs_val, int no_of_decimal){
		 
		String gs_val_str = gs_val+"";
		String restrict_gs_val = gs_val_str;
		int index = gs_val_str.indexOf(".");
		int len = (gs_val_str.substring(index+1)).length();
		if(index != -1 && len>no_of_decimal){
			restrict_gs_val = gs_val_str.substring(0,index+no_of_decimal+1);
		}

		return restrict_gs_val;
	}


    static private weblogic.jsp.internal.jsp.JspFunctionMapper _jspx_fnmap = weblogic.jsp.internal.jsp.JspFunctionMapper.getInstance();

    public void _jspService(javax.servlet.http.HttpServletRequest request, javax.servlet.http.HttpServletResponse response) 
    throws javax.servlet.ServletException, java.io.IOException {

        javax.servlet.ServletConfig config = getServletConfig();
        javax.servlet.ServletContext application = config.getServletContext();
        javax.servlet.jsp.tagext.JspTag _activeTag = null;
        java.lang.Object page = this;
        javax.servlet.jsp.PageContext pageContext = javax.servlet.jsp.JspFactory.getDefaultFactory().getPageContext(this, request, response, null, true , 8192 , true );
        response.setHeader("Content-Type", "text/html;charset=UTF-8");
        javax.servlet.jsp.JspWriter out = pageContext.getOut();
        weblogic.servlet.jsp.ByteWriter _bw = (weblogic.servlet.jsp.ByteWriter)out;
        _bw.setInitCharacterEncoding(_WL_ORIGINAL_ENCODING, _WL_ENCODED_BYTES_OK);
        javax.servlet.jsp.JspWriter _originalOut = out;
        javax.servlet.http.HttpSession session = request.getSession( true );
        try {;
            response.setContentType("text/html;charset=UTF-8");
            _bw.write(_wl_block0Bytes, _wl_block0);
            _bw.write(_wl_block1Bytes, _wl_block1);
            _bw.write(_wl_block1Bytes, _wl_block1);
            _bw.write(_wl_block1Bytes, _wl_block1);

	
	
	request.setCharacterEncoding("UTF-8");
	Connection con = null;
	PreparedStatement pstmt = null;
	ResultSet rst = null;

	String facility_id      = (String) session.getAttribute("facility_id");
    String locale = (String)session.getAttribute("LOCALE"); 


	String func_mode = request.getParameter( "func_mode" ) ;
	try{
		con = ConnectionManager.getConnection();
	
		if(func_mode.equalsIgnoreCase("getAllImagesFromDB")){
			String patient_id = checkForNull(request.getParameter( "patient_id" )) ;
			String chart_num = checkForNull(request.getParameter( "chart_num" )) ;
			
			String tooth_numbering_system = checkForNull(request.getParameter( "tooth_numbering_system" )) ;
			String treatment_condition_tab_flag = checkForNull(request.getParameter( "treatment_condition_tab_flag" )) ;
			//commented and added by parul on 29/04/2010 for IN021055
			//String asOnDate = checkForNull(request.getParameter( "asOnDate" )) ;
			String asOnDate = com.ehis.util.DateUtils.convertDate(checkForNull(request.getParameter("asOnDate")),"DMY",locale,"en");  
			String baseline_chart_yn  = checkForNull(request.getParameter( "baseline_chart_yn" )) ;
			String chart_status_from_view  = checkForNull(request.getParameter( "chart_status_from_view" )) ;
			String oh_chart_level  = checkForNull(request.getParameter( "oh_chart_level" )) ;
			String tooth_no  = checkForNull(request.getParameter( "tooth_no" )) ; //Added By Sridevi Joshi for SUPRTH on 12/4/2009
			String super_tooth_no  = checkForNull(request.getParameter( "super_tooth_no" )) ;//Added By Sridevi Joshi for SUPRTH on 12/4/2009
			String refresh_cell  = checkForNull(request.getParameter( "refresh_cell" )) ;//Added By Sridevi Joshi for SUPRTH on 12/4/2009
			String exfolth_count  = checkForNull(request.getParameter( "exfolth_count" )) ;//Added By Sridevi Joshi for SUPRTH on 12/14/2009
			String retained_tooth_no  = checkForNull(request.getParameter( "retained_tooth_no" )) ;//Added By Sridevi Joshi for SUPRTH on 12/14/2009
			//added by parul  for other facility chart CRF#0423
			String other_chart_facility_id  = checkForNull(request.getParameter( "other_chart_facility_id" )) ;			
			if (other_chart_facility_id.equals("")||other_chart_facility_id.equals("null")||other_chart_facility_id.equals(null)){
					other_chart_facility_id=facility_id;
			}
			if (super_tooth_no.equals("undefined")){
				super_tooth_no="";
			}
			if (retained_tooth_no.equals("undefined")){
				retained_tooth_no="";
			}
			//String sql				= "";
			String site_type = "";
			String image_id = "";
			String  DB_tooth_no = "";
			String display_tooth_no = "";
			String condition_type = "";
			String surface_code = "";
			String treatment_condition = "";
			String status = "";
			String status_code = "";
			String hide_image_yn = "";
			String mixed_dent_deciduous_yn = "";
			String cusp_tip_code = "";
			String treatments_outcome = "";
			String image_id_new = "";
			String treatment_int_ext = "";
			String super_key_num = ""; //Added by Sridevi Joshi on 1/21/2010 for CRF-481(IN010894)
			StringBuffer concatImage = new StringBuffer();
			StringBuffer sql_append = new StringBuffer();
			int chart_line_num = 0;
			
			//changed only the order by clause that is, changed the order of chart_line_num from last entry to last but one
			// 26/09/07: an extra condition SITE_TYPE IS NOT NULL is added in the where clause. This only for the Treatment Category type 'OTHERS'( For OTHERS there is no site type) 
			if (oh_chart_level.equals("E")){
				if(baseline_chart_yn.equals("Y")){
					if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/4/2009
							if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart

								sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID,decode(instr((SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE),'..'),0,'',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");

								//	sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
								sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

								sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							}
							else{
								//commented by parul on 22/02/2010 for CRF-477 & 496
								//	sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION, FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");
									sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID,decode(instr((SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE),'..'),0,'',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_NEW A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION, FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");

								//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
								sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

								sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							}

							pstmt = con.prepareStatement(sql_append.toString());
							pstmt.setString(1,tooth_numbering_system);
							pstmt.setString(2,patient_id);
							pstmt.setString(3,chart_num);
							pstmt.setString(4,tooth_no);
							pstmt.setString(5,super_tooth_no);
							pstmt.setString(6,retained_tooth_no);
						}
						else{
							//commented by parul on 22/02/2010 for CRF-477 & 496

							//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");
							sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");

							//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
							sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

							sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

							pstmt = con.prepareStatement(sql_append.toString());
							pstmt.setString(1,tooth_numbering_system);
							pstmt.setString(2,patient_id);
							pstmt.setString(3,chart_num);
							pstmt.setString(4,null);
							pstmt.setString(5,null);
						}
					}
					else{//Added by Sharon Crasta on 11/4/2009 for IN015376
						if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/4/2009
							if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT, A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							
							}
							else{
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							}

							pstmt = con.prepareStatement(sql_append.toString());
							pstmt.setString(1,tooth_numbering_system);
							pstmt.setString(2,patient_id);
							pstmt.setString(3,chart_num);
							pstmt.setString(4,tooth_no);
							pstmt.setString(5,super_tooth_no);
							pstmt.setString(6,retained_tooth_no);
							pstmt.setString(7,tooth_numbering_system);
							pstmt.setString(8,patient_id);
							pstmt.setString(9,chart_num);
							pstmt.setString(10,tooth_no);
							pstmt.setString(11,super_tooth_no);
							pstmt.setString(12,retained_tooth_no);
						}else{
							//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
							// The missing icon should be shown once the extraction treatment is completed.
							//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

							pstmt = con.prepareStatement(sql_append.toString());
							pstmt.setString(1,tooth_numbering_system);
							pstmt.setString(2,patient_id);
							pstmt.setString(3,chart_num);
							pstmt.setString(4,null);
							pstmt.setString(5,null);
							pstmt.setString(6,tooth_numbering_system);
							pstmt.setString(7,patient_id);
							pstmt.setString(8,chart_num);
							pstmt.setString(9,null);
							pstmt.setString(10,null);
						}
					}
				}  
				else{
					if(chart_status_from_view.equals("A")){
						if(treatment_condition_tab_flag.equals("T")){
							if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/9/2009
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
									//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}else{
								 	//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

								//	sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								pstmt.setString(3,chart_num);
								pstmt.setString(4,tooth_no);
								pstmt.setString(5,super_tooth_no);
								pstmt.setString(6,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(7,asOnDate);
								}
							}
							else{

								//commented by parul on 22/02/2010 for CRF-477 & 496

								//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
								sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

								//	sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
								sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

								sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								pstmt.setString(3,chart_num);
								pstmt.setString(4,null);
								pstmt.setString(5,null);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(6,asOnDate);
								}
							}
						}else{//Added by Sharon Crasta on 11/4/2009 for IN015376
							if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/9/2009
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE  AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}
								else{
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT, A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE  AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								pstmt.setString(3,chart_num);
								pstmt.setString(4,tooth_no);
								pstmt.setString(5,super_tooth_no);
								pstmt.setString(6,retained_tooth_no);
								pstmt.setString(7,tooth_numbering_system);
								pstmt.setString(8,patient_id);
								pstmt.setString(9,chart_num);
								pstmt.setString(10,tooth_no);
								pstmt.setString(11,super_tooth_no);
								pstmt.setString(12,retained_tooth_no);
							}
							else{
								//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
								// The missing icon should be shown once the extraction treatment is completed.
								//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE  AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE  AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								pstmt.setString(3,chart_num);
								pstmt.setString(4,null);
								pstmt.setString(5,null);
								pstmt.setString(6,tooth_numbering_system);
								pstmt.setString(7,patient_id);
								pstmt.setString(8,chart_num);
								pstmt.setString(9,null);
								pstmt.setString(10,null);
							}
						}
					} 
					else{
						if(treatment_condition_tab_flag.equals("T")){
							if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/9/2009
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
									//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic is changed to pick up the appropriate chart_num.
									//sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}
								else{
									//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic is changed to pick the appropriate chart_num.
									//sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(3,chart_num);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,asOnDate);
								//End
								pstmt.setString(5,tooth_no);
								pstmt.setString(6,super_tooth_no);
								pstmt.setString(7,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(8,asOnDate);
								}
							}
							else{
								//commented by parul on 22/02/2010 for CRF-477 & 496
								//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
								//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic is changed to pick the appropriate Chart_num
								//sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ?  AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
								sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

								//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
								sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

								sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(3,chart_num);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,asOnDate);
								//End
								pstmt.setString(5,null);
								pstmt.setString(6,null);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(7,asOnDate);
								}
							}
						}else{//Added by Sharon Crasta on 11/4/2009 for IN015376
							if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/9/2009
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic is changed to pick the appropriate chart_num
									//sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}
								else{
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 to pick the appropriate chart_num for asOnDate.
									//sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(3,chart_num);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,asOnDate);
								//End
								pstmt.setString(5,tooth_no);
								pstmt.setString(6,super_tooth_no);
								pstmt.setString(7,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(8,asOnDate);
								}
								pstmt.setString(9,tooth_numbering_system);
								pstmt.setString(10,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(10,chart_num);
								pstmt.setString(11,patient_id);
								pstmt.setString(12,asOnDate);
								//End
								pstmt.setString(13,tooth_no);
								pstmt.setString(14,super_tooth_no);
								pstmt.setString(15,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(16,asOnDate);
								}
							}
							else{
								//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
								// The missing icon should be shown once the extraction treatment is completed.
								//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								//commented by parul on 22/02/2010 for CRF-477 & 496
								//sql_append.append("SELECT SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								//Commented by Sharon Crasta on 3/30/2010 for IN018302 to change the asOnDate Logic in picking up the chart_num.
								//sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION, IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT, A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D  WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE  D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION, (SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S', SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1, (INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S', E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM  OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_new FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE , (SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?)  NS_TOOTH_NO,'C' TREATMENT_CONDITION, (SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S', SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID, SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_new FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID =? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X')AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND  NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND  TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T'  AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90')))  ORDER BY ARCH_SNO DESC,  QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION, IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT, A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D  WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE  D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION, (SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S', SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1, (INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S', E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM  OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_new FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE , (SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?)  NS_TOOTH_NO,'C' TREATMENT_CONDITION, (SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S', SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID, SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_new FROM OH_RESTORATIVE_CHART_DTL A WHERE PATIENT_ID =? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X')AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND  NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND  TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T'  AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90')))  ORDER BY ARCH_SNO DESC,  QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,patient_id);
								//Added by Sharon Crasta on 1/22/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(3,chart_num);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,asOnDate);
								//End
								pstmt.setString(5,super_tooth_no);
								pstmt.setString(6,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(7,asOnDate);
								}
								pstmt.setString(8,tooth_numbering_system);
								pstmt.setString(9,patient_id);
								//Added by Sharon Crasta on 1/22/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(9,chart_num);
								pstmt.setString(10,patient_id);
								pstmt.setString(11,asOnDate);
								//End
								pstmt.setString(12,super_tooth_no);
								pstmt.setString(13,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(14,asOnDate);
								}
							}
						} 
					}
				}
			}else{
				if(baseline_chart_yn.equals("Y")){
					if(treatment_condition_tab_flag.equals("T")){ 
						//commented by parul on 22/02/2010 for CRF-477 & 496
						//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");
						sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' ");

						//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

						sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

						pstmt = con.prepareStatement(sql_append.toString());
						pstmt.setString(1,tooth_numbering_system);
						pstmt.setString(2,other_chart_facility_id);
						pstmt.setString(3,patient_id);
						pstmt.setString(4,chart_num);
					}
					else{ //Added by Sharon Crasta on 11/4/2009 for IN015376
						if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/4/2009
							if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							}
							else{
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							}

							pstmt = con.prepareStatement(sql_append.toString());
							pstmt.setString(1,tooth_numbering_system);
							pstmt.setString(2,other_chart_facility_id);
							pstmt.setString(3,patient_id);
							pstmt.setString(4,chart_num);
							pstmt.setString(5,tooth_no);
							pstmt.setString(6,super_tooth_no);
							pstmt.setString(7,retained_tooth_no);
							pstmt.setString(8,tooth_numbering_system);
							pstmt.setString(9,other_chart_facility_id);
							pstmt.setString(10,patient_id);
							pstmt.setString(11,chart_num);
							pstmt.setString(12,tooth_no);
							pstmt.setString(13,super_tooth_no);
							pstmt.setString(14,retained_tooth_no);
						}
						else{
							//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
							// The missing icon should be shown once the extraction treatment is completed.
							//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
							sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

							pstmt = con.prepareStatement(sql_append.toString());
							pstmt.setString(1,tooth_numbering_system);
							pstmt.setString(2,other_chart_facility_id);
							pstmt.setString(3,patient_id);
							pstmt.setString(4,chart_num);
							pstmt.setString(5,null);
							pstmt.setString(6,null);
							pstmt.setString(7,tooth_numbering_system);
							pstmt.setString(8,other_chart_facility_id);
							pstmt.setString(9,patient_id);
							pstmt.setString(10,chart_num);
							pstmt.setString(11,null);
							pstmt.setString(12,null);
						}
					}
				} 
				else{
					if(chart_status_from_view.equals("A")){
						if(treatment_condition_tab_flag.equals("T")){ 
							if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/9/2009
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
								//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}
								else{
									//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//	sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,chart_num);
								pstmt.setString(5,tooth_no);
								pstmt.setString(6,super_tooth_no);
								pstmt.setString(7,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(8,asOnDate);
								}
							}else{
								//commented by parul on 22/02/2010 for CRF-477 & 496
								//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
								sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

								//	sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
								sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

								sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,chart_num);
								pstmt.setString(5,null);
								pstmt.setString(6,null);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(7,asOnDate);
								}
							}
						}else{	//Added by Sharon Crasta on 11/4/2009 for IN015376
							if(refresh_cell.equals("Y")){//Added By Sridevi Joshi for SUPRTH on 12/4/2009
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
									//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
									// The missing icon should be shown once the extraction treatment is completed.
									//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}else{
									//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
									// The missing icon should be shown once the extraction treatment is completed.
									//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT, A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}
								pstmt = con.prepareStatement(sql_append.toString());

								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,chart_num);
								pstmt.setString(5,tooth_no);
								pstmt.setString(6,super_tooth_no);
								pstmt.setString(7,retained_tooth_no);
								pstmt.setString(8,tooth_numbering_system);
								pstmt.setString(9,other_chart_facility_id);
								pstmt.setString(10,patient_id);
								pstmt.setString(11,chart_num);
								pstmt.setString(12,tooth_no);
								pstmt.setString(13,super_tooth_no);
								pstmt.setString(14,retained_tooth_no);
							}
							else{
								//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
								// The missing icon should be shown once the extraction treatment is completed.
								//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT, A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= SYSDATE AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								pstmt.setString(4,chart_num);
								pstmt.setString(5,null);
								pstmt.setString(6,null);
								pstmt.setString(7,tooth_numbering_system);
								pstmt.setString(8,other_chart_facility_id);
								pstmt.setString(9,patient_id);
								pstmt.setString(10,chart_num);
								pstmt.setString(11,null);
								pstmt.setString(12,null);
							}
						}
					}	
					else{
						if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
							if(refresh_cell.equals("Y")){ //Added by Sridevi Joshi on 12/9/2009 for SUPRTH new Changes
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
								//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic has been changed to get the appropriate chart_num.
									//sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE )))  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}
								else{
									//commented by parul on 22/02/2010 for CRF-477 & 496
									//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X')  AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic changed to get the chart_num.
									//sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ?  AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X')  AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
									sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X')  AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

									//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
									sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

									sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}		

								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(4,chart_num);
								pstmt.setString(4,patient_id);
								pstmt.setString(5,asOnDate);
								//End
								pstmt.setString(6,tooth_no);
								pstmt.setString(7,super_tooth_no);
								pstmt.setString(8,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(9,asOnDate);
								}
							}else{
								//commented by parul on 22/02/2010 for CRF-477 & 496
								//sql_append.append("SELECT A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ?  AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
								//Commented by Sharon Crasta on 3/30/2010 for In018302 - asOnDate logic changed to get the chart_num.
								//sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ?  AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
								sql_append.append("SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N'");

								//sql_append.append(" AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
								sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

								sql_append.append(" ORDER BY A.ARCH_SNO DESC, A.QUADRANT_SNO DESC, A.TOOTH_NO , A.CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");

								
								pstmt = con.prepareStatement(sql_append.toString());
								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(4,chart_num);
								pstmt.setString(4,patient_id);
								pstmt.setString(5,asOnDate);
								//End
								pstmt.setString(6,null);
								pstmt.setString(7,null);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(8,asOnDate);
								}
							}
						}
						else{//Added by Sharon Crasta on 11/4/2009 for IN015376
							if(refresh_cell.equals("Y")){ //Added by Sridevi Joshi on 12/9/2009 for SUPRTH new Changes
								if(exfolth_count.equals("3")){ //Added by Sridevi Joshi on 12/14/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
									//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
									// The missing icon should be shown once the extraction treatment is completed.
								//if(!flag.equals("D") && !flag.equals("MR") && !flag.equals("M") && !flag.equals("MRP") && !flag.equals("RD")){
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - asOnDatelogic is changed to get the chart num.
									//sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X')) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X')) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}else{
									//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
									// The missing icon should be shown once the extraction treatment is completed.
									//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									//Commented by Sharon Crasta on 3/30/2010 for IN018302 - chart_num logic is changed for asOnDate.
									//sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
									sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND TOOTH_NO = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								}

								pstmt = con.prepareStatement(sql_append.toString());

								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(4,chart_num);
								pstmt.setString(4,patient_id);
								pstmt.setString(5,asOnDate);
								//End
								pstmt.setString(6,tooth_no);
								pstmt.setString(7,super_tooth_no);
								pstmt.setString(8,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(9,asOnDate);
								}
								pstmt.setString(10,tooth_numbering_system);
								pstmt.setString(11,other_chart_facility_id);
								pstmt.setString(12,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(13,chart_num);
								pstmt.setString(13,patient_id);
								pstmt.setString(14,asOnDate);
								//End
								pstmt.setString(15,tooth_no);
								pstmt.setString(16,super_tooth_no);
								pstmt.setString(17,retained_tooth_no);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(18,asOnDate);
								}
							}else{

								//Commented and Added by sharon Crasta on 12/8/2009 for IN016953
								// The missing icon should be shown once the extraction treatment is completed.
								//sql_append.append("SELECT CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION FROM (SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('10','15','25','52','54','55','60','65','70','75','80','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								//Commented and Added by Sharon Crasta on 3/30/2010 for IN018302 - asOnDate logic changed.
								//sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = ? AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								sql_append.append("SELECT TREATMENT_INT_EXT,SUPER_KEY_NUM, CHART_LINE_NUM, SITE_TYPE, TOOTH_NO, TOOTH_RANGE, ARCH_SNO, QUADRANT_SNO, HIDE_IMAGE_YN, MIXED_DENT_DECIDUOUS_YN, STATUS, STATUS_CODE , IMAGE_ID, SURFACE_CODE,CUSP_TIP_CODE,TREATMENTS_OUTCOME, CONDITION_OR_TREATMENT_TYPE, NS_TOOTH_NO,TREATMENT_CONDITION,IMAGE_ID_NEW FROM (SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.STATUS STATUS_CODE ,DECODE(A.TRMT_CATEGORY_TYPE,NULL,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE A.CONDITION_TYPE=D.CONDITION_TYPE), (SELECT D.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE D WHERE D.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM= ?) NS_TOOTH_NO,TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E'))  UNION ALL SELECT A.TREATMENT_INT_EXT,A.SUPER_KEY_NUM, A.CHART_LINE_NUM, A.SITE_TYPE, A.TOOTH_NO, A.TOOTH_RANGE, A.ARCH_SNO, A.QUADRANT_SNO, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, '' STATUS,A.STATUS STATUS_CODE ,(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE='MISSTH') IMAGE_ID, A.SURFACE_CODE,A.CUSP_TIP_CODE,A.TREATMENTS_OUTCOME, 'MISSTH' CONDITION_OR_TREATMENT_TYPE, (SELECT C.NS_TOOTH_NO FROM OH_TOOTH_BY_NUMBERING_SYSTEM C WHERE C.TOOTH_NO=A.TOOTH_NO AND NUMBERING_SYSTEM=?) NS_TOOTH_NO,'C' TREATMENT_CONDITION,(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE) IMAGE_ID_NEW FROM OH_RESTORATIVE_CHART_DTL A WHERE OPERATING_FACILITY_ID = ? AND PATIENT_ID = ? AND CHART_NUM = (SELECT MAX (CHART_NUM) FROM OH_RESTORATIVE_CHART_HDR WHERE PATIENT_ID = ? AND TO_DATE (?, 'DD/MM/YYYY') BETWEEN TRUNC (CHART_DATE)  AND TRUNC (NVL(CHART_CLOSE_DATE, SYSDATE ))) AND (NVL(SUPER_TOOTH_NO,'X') = NVL(?,'X') ) AND (NVL(RETAINED_TOOTH_NO,'X') = NVL(?,'X') ) AND NVL(A.STATUS,'X')!='E' AND SITE_TYPE IS NOT NULL AND TREATMENT_CONDITION_DATE <= TO_DATE(? ||' 23:59','DD/MM/YYYY HH24:MI') AND (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I')  AND TRMT_CATEGORY_TYPE = 'EXTRACT' AND A.STATUS IN (SELECT E.ORDER_STATUS_CODE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_TYPE IN ('25','52','54','55','60','70','75','85','90'))) ORDER BY ARCH_SNO DESC, QUADRANT_SNO DESC, TOOTH_NO , CHART_LINE_NUM DESC, TREATMENT_CONDITION DESC");
								pstmt = con.prepareStatement(sql_append.toString());

								pstmt.setString(1,tooth_numbering_system);
								pstmt.setString(2,other_chart_facility_id);
								pstmt.setString(3,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(4,chart_num);
								//Rameez against 37414 - Changed the column index
								pstmt.setString(4,patient_id);
								pstmt.setString(5,asOnDate);
								//End
								pstmt.setString(6,null);
								pstmt.setString(7,null);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(8,asOnDate);
								}
								pstmt.setString(9,tooth_numbering_system);
								pstmt.setString(10,other_chart_facility_id);
								pstmt.setString(11,patient_id);
								//Added by Sharon Crasta on 3/30/2010 for IN018302
								//Changed the asOnDate Logic
								//pstmt.setString(13,chart_num);
								pstmt.setString(12,patient_id);
								pstmt.setString(13,asOnDate);
								//End
								pstmt.setString(14,null);
								pstmt.setString(15,null);
								if(!chart_status_from_view.equals("A")){
									pstmt.setString(16,asOnDate);
								//Rameez against 37414
								}
							}
						}  
					}
				}
			}
	
			rst = pstmt.executeQuery();
			while(rst!= null && rst.next()){
				chart_line_num = Integer.parseInt(checkForNull(rst.getString("CHART_LINE_NUM")));
				site_type = checkForNull(rst.getString("SITE_TYPE"));
				//image_id = checkForNull(rst.getString("IMAGE_ID"));
				image_id = rst.getString("IMAGE_ID");
				status = checkForNull(rst.getString("STATUS")); //This is to get the status from OR table with respect to the status is stored in the chart_dtl table..
				status_code = rst.getString("STATUS_CODE"); // This is to get the status which is stored in the chart_dtl table..
				image_id_new = rst.getString("IMAGE_ID_NEW"); 
				treatment_int_ext = rst.getString("TREATMENT_INT_EXT"); 
					if(site_type.equals("ARCH")){
						DB_tooth_no = checkForNull(rst.getString("ARCH_SNO"));
						treatment_condition = checkForNull(rst.getString("TREATMENT_CONDITION")); // CONDITION OR TREATMENT TYPE	
						condition_type = checkForNull(rst.getString("CONDITION_OR_TREATMENT_TYPE")); // CONDITION OR TREATMENT TYPE
						treatments_outcome = checkForNull(rst.getString("TREATMENTS_OUTCOME")); 

						concatImage.append(image_id+"##"+DB_tooth_no+"##"+site_type+"##"+display_tooth_no+"##"+condition_type+"##"+treatment_condition+"##"+status+"##"+status_code+"##"+treatments_outcome+"##"+image_id_new+"##"+treatment_int_ext);
					}else if(site_type.equals("QUAD")){
						DB_tooth_no = checkForNull(rst.getString("QUADRANT_SNO"));
						treatment_condition = checkForNull(rst.getString("TREATMENT_CONDITION")); // CONDITION OR TREATMENT TYPE	
						condition_type = checkForNull(rst.getString("CONDITION_OR_TREATMENT_TYPE")); // CONDITION OR TREATMENT TYPE
						treatments_outcome = checkForNull(rst.getString("TREATMENTS_OUTCOME")); 

						concatImage.append(image_id+"##"+DB_tooth_no+"##"+site_type+"##"+display_tooth_no+"##"+condition_type+"##"+treatment_condition+"##"+status+"##"+status_code+"##"+treatments_outcome+"##"+image_id_new+"##"+treatment_int_ext);

					}else if(site_type.equals("TOOTH") || site_type.equals("THRNG")){
						DB_tooth_no = checkForNull(rst.getString("TOOTH_NO"));
						display_tooth_no = checkForNull(rst.getString("NS_TOOTH_NO"));
						condition_type = checkForNull(rst.getString("CONDITION_OR_TREATMENT_TYPE")); // CONDITION OR TREATMENT TYPE
						treatment_condition = checkForNull(rst.getString("TREATMENT_CONDITION")); // CONDITION OR TREATMENT TYPE	
						hide_image_yn = checkForNull(rst.getString("HIDE_IMAGE_YN")); // CONDITION OR TREATMENT TYPE	
						mixed_dent_deciduous_yn = checkForNull(rst.getString("MIXED_DENT_DECIDUOUS_YN")); // CONDITION OR TREATMENT TYPE	
						super_key_num = checkForNull(rst.getString("SUPER_KEY_NUM")); // super_key_num
						surface_code = checkForNull(rst.getString("SURFACE_CODE"));
						treatments_outcome = checkForNull(rst.getString("TREATMENTS_OUTCOME")); 


					    concatImage.append(image_id+"##"+DB_tooth_no+"##"+site_type+"##"+display_tooth_no+"##"+condition_type+"##"+treatment_condition+"##"+status+"##"+hide_image_yn+"##"+mixed_dent_deciduous_yn+"##"+super_key_num+"##"+surface_code+"##"+treatments_outcome+"##"+image_id_new+"##"+treatment_int_ext);

					}else if(site_type.equals("CROWN")){
						DB_tooth_no = checkForNull(rst.getString("TOOTH_NO"));
						display_tooth_no = checkForNull(rst.getString("NS_TOOTH_NO"));
						surface_code = checkForNull(rst.getString("SURFACE_CODE"));
						condition_type = checkForNull(rst.getString("CONDITION_OR_TREATMENT_TYPE")); // CONDITION OR TREATMENT TYPE	
						treatment_condition = checkForNull(rst.getString("TREATMENT_CONDITION")); // CONDITION OR TREATMENT TYPE	
						cusp_tip_code = checkForNull(rst.getString("CUSP_TIP_CODE")); 
						super_key_num = checkForNull(rst.getString("SUPER_KEY_NUM")); // super_key_num
						treatments_outcome = checkForNull(rst.getString("TREATMENTS_OUTCOME")); 
                        if(!surface_code.equals("*A")){
							image_id = "";
						}
						concatImage.append(image_id+"##"+DB_tooth_no+"##"+display_tooth_no+"##"+site_type+"##"+condition_type+"##"+surface_code+"##"+treatment_condition+"##"+status+"##"+cusp_tip_code+"##"+super_key_num+"##"+""+"##"+treatments_outcome+"##"+image_id_new+"##"+treatment_int_ext);

					}else if(site_type.equals("ROOT")){
						DB_tooth_no = checkForNull(rst.getString("TOOTH_NO"));
						display_tooth_no = checkForNull(rst.getString("NS_TOOTH_NO"));
						surface_code = checkForNull(rst.getString("SURFACE_CODE"));
						condition_type = checkForNull(rst.getString("CONDITION_OR_TREATMENT_TYPE")); // CONDITION OR TREATMENT TYPE			
						treatment_condition = checkForNull(rst.getString("TREATMENT_CONDITION")); // CONDITION OR TREATMENT TYPE	
						super_key_num = checkForNull(rst.getString("SUPER_KEY_NUM")); // super_key_num
						treatments_outcome = checkForNull(rst.getString("TREATMENTS_OUTCOME")); 

						concatImage.append(image_id+"##"+DB_tooth_no+"##"+site_type+"##"+display_tooth_no+"##"+condition_type+"##"+treatment_condition+"##"+status+"##"+hide_image_yn+"##"+surface_code+"##"+chart_line_num+"##"+super_key_num+"##"+treatments_outcome+"##"+image_id_new+"##"+treatment_int_ext);
					}

                   
					concatImage.append("~");
					
			}
			out.println(concatImage);
			sql_append.setLength(0);
		}else if(func_mode.equalsIgnoreCase("getImageFromDB")){
			String treatment_condition_tab_flag = checkForNull(request.getParameter( "treatment_condition_tab_flag" )) ;
			String patient_id = checkForNull(request.getParameter( "patient_id" )) ;
			String site_type = checkForNull(request.getParameter( "site_type" )) ;
			String tooth_no = checkForNull(request.getParameter( "tooth_no" )) ;
			String chart_num = checkForNull(request.getParameter( "chart_num" )) ;
			String tooth_numbering_system = checkForNull(request.getParameter( "tooth_numbering_system" )) ;
			String oh_chart_level  = checkForNull(request.getParameter( "oh_chart_level" )) ;
			//String status  = checkForNull(request.getParameter( "status" )) ;
			String super_tooth_no  = checkForNull(request.getParameter( "super_tooth_no" )) ; //Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
			String retained_tooth_no  = checkForNull(request.getParameter( "retained_tooth_no" )) ; //Added by Sridevi Joshi on 12/14/2009 for SUPRTH new changes
			String status  = checkForNull(request.getParameter( "status" )) ; //Added by Sridevi Joshi on 1/26/2010 for SUPRTH new changes
			String isSuprthError  = checkForNull(request.getParameter( "isSuprthError" )) ; //Added by Sridevi Joshi on 1/26/2010 for SUPRTH new changes
			String isExfolthError  = checkForNull(request.getParameter( "isExfolthError" )) ; //Added by Sridevi Joshi on 1/26/2010 for SUPRTH new changes
			String isRetainedError  = checkForNull(request.getParameter( "isRetainedError" )) ; //Added by Sridevi Joshi on 1/26/2010 for SUPRTH new changes
			String[] tooth_no_arr = null;
			StringBuffer concatImage = new StringBuffer();
			StringBuffer sql_append = new StringBuffer();

			int record_exfolth_count = 0;

			if(site_type.equals("ARCH") || site_type.equals("QUAD")){
				if(oh_chart_level.equals("E")){
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.ARCH_SNO,A.QUADRANT_SNO, A.SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN,(SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.TRMT_CATEGORY_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT NVL(E.IMAGE_ID,'null') IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, B.CHART_STATUS FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B ");
				//	sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.ARCH_SNO,A.QUADRANT_SNO, A.SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN,(SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.TRMT_CATEGORY_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT NVL(E.IMAGE_ID,'null') IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID,decode(instr((SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE),'..'),0,'',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_NEW, B.CHART_STATUS FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B ");


					sql_append.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.ARCH_SNO,A.QUADRANT_SNO, A.SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN,(SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.TRMT_CATEGORY_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT NVL(E.IMAGE_ID,'null') IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, B.CHART_STATUS FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B");

					sql_append.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
					if(site_type.equals("QUAD")){
						sql_append.append(" AND A.QUADRANT_SNO = ? ");
					}
					if(site_type.equals("ARCH")){
						sql_append.append(" AND A.ARCH_SNO = ? ");
					}
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
					/*if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}*/

	                 if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}

					sql_append.append(" ORDER BY A.CHART_LINE_NUM DESC ");

					pstmt = con.prepareStatement(sql_append.toString());
					pstmt.setString(1,patient_id);
					pstmt.setString(2,chart_num);
					pstmt.setString(3,tooth_no);	//QUADRANT OR ARCH SNO

					rst = pstmt.executeQuery();
				}
				else{
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.ARCH_SNO,A.QUADRANT_SNO, A.SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN,(SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.TRMT_CATEGORY_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, B.CHART_STATUS FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B ");
					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.ARCH_SNO,A.QUADRANT_SNO, A.SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN,(SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.TRMT_CATEGORY_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT NVL(E.IMAGE_ID,'null') IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID,decode(instr((SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE),'..'),0,'',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR (E.IMAGE_ID,'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_NEW, B.CHART_STATUS FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B");

					sql_append.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.ARCH_SNO,A.QUADRANT_SNO, A.SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN,(SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.TRMT_CATEGORY_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT NVL(E.IMAGE_ID,'null') IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, B.CHART_STATUS FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B ");

					sql_append.append(" WHERE A.OPERATING_FACILITY_ID=? AND A.PATIENT_ID = ? AND A.CHART_NUM=? AND B.OPERATING_FACILITY_ID = A.OPERATING_FACILITY_ID AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N'");
					if(site_type.equals("QUAD")){
						sql_append.append(" AND A.QUADRANT_SNO = ? ");
					}
					if(site_type.equals("ARCH")){
						sql_append.append(" AND A.ARCH_SNO = ? ");
					}
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
					/*if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='I' AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')) OR A.TREATMENT_CONDITION = 'C')");
					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}*/
					  if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}

					sql_append.append(" ORDER BY A.CHART_LINE_NUM DESC ");

					pstmt = con.prepareStatement(sql_append.toString());
					pstmt.setString(1,facility_id);
					pstmt.setString(2,patient_id);
					pstmt.setString(3,chart_num);
					pstmt.setString(4,tooth_no);	//QUADRANT OR ARCH SNO

					rst = pstmt.executeQuery();
				}
				String entered_yn = "N";
				while(rst!= null && rst.next()){
					entered_yn = "Y";
					concatImage.append(rst.getString("IMAGE_ID"));
					concatImage.append("##");
					concatImage.append(rst.getString("STATUS"));
					concatImage.append("##");
					concatImage.append(rst.getString("TRMT_CATEGORY_TYPE"));
					concatImage.append("##");
					concatImage.append(rst.getString("SURFACE_CODE"));
					concatImage.append("##");
					concatImage.append(rst.getString("QUADRANT_SNO"));
					concatImage.append("##");
					concatImage.append(rst.getString("ARCH_SNO"));
					concatImage.append("##");
					concatImage.append(rst.getString("MIXED_DENT_DECIDUOUS_YN"));
					concatImage.append("##");
					concatImage.append(rst.getString("IMAGE_ID_NEW"));
					concatImage.append("##");
					concatImage.append(rst.getString("TREATMENTS_OUTCOME"));
					concatImage.append("##");
					concatImage.append(rst.getString("TREATMENT_INT_EXT"));
					concatImage.append("~");
				}
				
				if(entered_yn.equals("N")){
					concatImage.append("##");
					concatImage.append("~");
				}
			}
			else if((site_type.equals("TOOTH") && tooth_no.indexOf(",") == -1 || site_type.equals("ROOT") || site_type.equals("CROWN"))){
				if(oh_chart_level.equals("E")){

				//commented and added by parul on 15/02/2010 for CRF-477 & 496
					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM, A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B, OH_TOOTH_BY_NUMBERING_SYSTEM C ");

					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.GIF')-1))||'_E.GIF',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.GIF')-1))||'_F.GIF'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.GIF')-1))||'_EF.GIF')) FROM OH_TREATMENT_CATEGORY_TYPE E  WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID  FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C"); 
					sql_append.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A,  OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C "); 

					sql_append.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");


					//sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
					
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
					//sql_append.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");

					if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E')  AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E')OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}

					sql_append.append(" ORDER BY A.CHART_LINE_NUM DESC ");
					
					pstmt=con.prepareStatement(sql_append.toString());
					pstmt.setString(1,patient_id.trim());
					pstmt.setString(2,chart_num.trim());
					pstmt.setString(3,tooth_no.trim());
					if(isExfolthError.equals("Y")){
						pstmt.setString(4,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
						pstmt.setString(5,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
					}
					else{
						pstmt.setString(4,super_tooth_no.trim());//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
						pstmt.setString(5,retained_tooth_no.trim());//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
					}
					pstmt.setString(6,tooth_numbering_system.trim());
					
					rst = pstmt.executeQuery();
				}
				else{				
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM, A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS, A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B, OH_TOOTH_BY_NUMBERING_SYSTEM C ");
					sql_append.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A,  OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C"); 

					sql_append.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");


					//sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

					/*sql_append.append(" WHERE A.OPERATING_FACILITY_ID=? AND A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.OPERATING_FACILITY_ID = A.OPERATING_FACILITY_ID AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");*/
					
					if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}
					sql_append.append(" ORDER BY A.CHART_LINE_NUM DESC ");

					pstmt=con.prepareStatement(sql_append.toString());
					pstmt.setString(1,facility_id.trim());
					pstmt.setString(2,patient_id.trim());
					pstmt.setString(3,chart_num.trim());
					pstmt.setString(4,tooth_no.trim());
					if(isExfolthError.equals("Y")){
						pstmt.setString(5,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
						pstmt.setString(6,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
					}
					else{
						pstmt.setString(5,super_tooth_no.trim());//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
						pstmt.setString(6,retained_tooth_no.trim());//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
					}
					pstmt.setString(7,tooth_numbering_system.trim());
					
					rst = pstmt.executeQuery();
				}
				String entered_yn = "N";
				while(rst.next()){
					entered_yn = "Y";
					concatImage.append(rst.getString("IMAGE_ID"));
					concatImage.append("##");
					concatImage.append(rst.getString("NS_TOOTH_NO"));
					concatImage.append("##");
					concatImage.append(rst.getString("CONDITION_OR_TREATMENT_TYPE"));
					concatImage.append("##");
					concatImage.append(rst.getString("STATUS"));
					concatImage.append("##");
					concatImage.append(rst.getString("SURFACE_CODE"));
					concatImage.append("##");
					concatImage.append(rst.getString("SITE_TYPE"));
					concatImage.append("##");
					concatImage.append(rst.getString("HIDE_IMAGE_YN"));
					concatImage.append("##");
					concatImage.append(rst.getString("MIXED_DENT_DECIDUOUS_YN"));
					concatImage.append("##");
					concatImage.append(rst.getString("CHART_LINE_NUM"));
					concatImage.append("##");
					concatImage.append(rst.getString("CUSP_TIP_CODE"));
					concatImage.append("##");
					concatImage.append(rst.getString("SUPERNUMERARY_YN"));
					concatImage.append("##");
					concatImage.append(rst.getString("SUPER_KEY_NUM"));
					concatImage.append("##");
					concatImage.append(rst.getString("TREATMENTS_OUTCOME"));
					concatImage.append("##");
					concatImage.append(rst.getString("IMAGE_ID_NEW"));
					concatImage.append("##");
					concatImage.append(rst.getString("TREATMENT_INT_EXT"));
					concatImage.append("~");


					
				}

				if(entered_yn.equals("N")){
					if(status.equals("E") && (isSuprthError.equals("Y") || isExfolthError.equals("Y") || (isRetainedError.equals("Y") || isExfolthError.equals("Y")))){
						 concatImage = new StringBuffer();
						StringBuffer sql_append1 = new StringBuffer();
						if(oh_chart_level.equals("E")){
							//commented and added by parul on 15/02/2010 for CRF-477 & 496
							//sql_append1.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM, A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B, OH_TOOTH_BY_NUMBERING_SYSTEM C ");
							sql_append1.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A,  OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C"); 

							sql_append1.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");


							//sql_append1.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

							/*sql_append1.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");*/

							if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
								sql_append1.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
							}else{
								sql_append1.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
							}
							sql_append1.append(" ORDER BY A.CHART_LINE_NUM DESC ");

							pstmt=con.prepareStatement(sql_append1.toString());
							pstmt.setString(1,patient_id.trim());
							pstmt.setString(2,chart_num.trim());
							pstmt.setString(3,tooth_no.trim());
							pstmt.setString(4,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
							pstmt.setString(5,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
							pstmt.setString(6,tooth_numbering_system.trim());
							
							rst = pstmt.executeQuery();
						}
						else{
                             //commented and added by parul on 15/02/2010 for CRF-477 & 496
							//sql_append1.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM, A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS, A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B, OH_TOOTH_BY_NUMBERING_SYSTEM C ");
							sql_append1.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_NEW,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A,  OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C"); 

							sql_append1.append("WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");


							//sql_append1.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

							//sql_append1.append(" WHERE A.OPERATING_FACILITY_ID=? AND A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND NVL(A.SUPER_TOOTH_NO,'X') = NVL(? ,'X') AND NVL(A.RETAINED_TOOTH_NO,'X') = NVL(? ,'X') AND B.OPERATING_FACILITY_ID = A.OPERATING_FACILITY_ID AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");

							
							if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
								sql_append1.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");
							}else{
								sql_append1.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
							}
							sql_append1.append(" ORDER BY A.CHART_LINE_NUM DESC ");

							pstmt=con.prepareStatement(sql_append1.toString());
							pstmt.setString(1,facility_id.trim());
							pstmt.setString(2,patient_id.trim());
							pstmt.setString(3,chart_num.trim());
							pstmt.setString(4,tooth_no.trim());
							pstmt.setString(5,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
							pstmt.setString(6,null);//Added by Sridevi Joshi on 12/7/2009 for SUPRTH new changes
							pstmt.setString(7,tooth_numbering_system.trim());

							rst = pstmt.executeQuery();
						}

						while(rst.next()){
							concatImage.append(rst.getString("IMAGE_ID"));
							concatImage.append("##");
							concatImage.append(rst.getString("NS_TOOTH_NO"));
							concatImage.append("##");
							concatImage.append(rst.getString("CONDITION_OR_TREATMENT_TYPE"));
							concatImage.append("##");
							concatImage.append(rst.getString("STATUS"));
							concatImage.append("##");
							concatImage.append(rst.getString("SURFACE_CODE"));
							concatImage.append("##");
							concatImage.append(rst.getString("SITE_TYPE"));
							concatImage.append("##");
							concatImage.append(rst.getString("HIDE_IMAGE_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("MIXED_DENT_DECIDUOUS_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("CHART_LINE_NUM"));
							concatImage.append("##");
							concatImage.append(rst.getString("CUSP_TIP_CODE"));
							concatImage.append("##");
							concatImage.append(rst.getString("SUPERNUMERARY_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("SUPER_KEY_NUM"));
							concatImage.append("##");
							concatImage.append(rst.getString("TREATMENTS_OUTCOME"));
							concatImage.append("##");
							concatImage.append(rst.getString("IMAGE_ID_NEW"));
							concatImage.append("##");
							concatImage.append(rst.getString("TREATMENT_INT_EXT"));
							concatImage.append("~");
						}
					}
					else{
						concatImage.append("##");
						concatImage.append("~");
					}
				}

			}
			else if(site_type.equals("THRNG") || (site_type.equals("TOOTH") && tooth_no.indexOf(",") != -1)){
				String entered_yn = "N";
				if(oh_chart_level.equals("E")){
                    //commented and added by parul on 15/02/2010 for CRF-477 & 496
					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.TOOTH_NO, A.HIDE_IMAGE_YN, SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.SITE_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B, OH_TOOTH_BY_NUMBERING_SYSTEM C ");

					//sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.GIF')-1))||'_E.GIF',SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.GIF')-1))||'_F.GIF'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(E.IMAGE_ID,'.GIF')-1))||'_EF.GIF')) FROM OH_TREATMENT_CATEGORY_TYPE E  WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_NEW,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID  FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C");
					sql_append.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A,  OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C");


					sql_append.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");

					if((record_exfolth_count == 3)){
						sql_append.append("AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' ");//Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
					}

					if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}
					//sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

					sql_append.append(" ORDER BY A.ARCH_SNO, A.QUADRANT_SNO, A.TOOTH_NO, A.CHART_LINE_NUM DESC ");

					tooth_no_arr = tooth_no.split(",");
					for(int i=0;i<tooth_no_arr.length;i++){
						pstmt = con.prepareStatement(sql_append.toString());

						pstmt.setString(1,patient_id);
						pstmt.setString(2,chart_num);
						pstmt.setString(3,tooth_no_arr[i]);
						pstmt.setString(4,tooth_numbering_system);
						rst = pstmt.executeQuery();
						while(rst!= null && rst.next()){
							entered_yn = "Y";
							concatImage.append(rst.getString("IMAGE_ID"));
							concatImage.append("##");
							concatImage.append(rst.getString("TOOTH_NO"));
							concatImage.append("##");
							concatImage.append(rst.getString("NS_TOOTH_NO"));
							concatImage.append("##");
							concatImage.append(rst.getString("CONDITION_OR_TREATMENT_TYPE"));
							concatImage.append("##");
							concatImage.append(rst.getString("STATUS"));
							concatImage.append("##");
							concatImage.append(rst.getString("SITE_TYPE"));
							concatImage.append("##");
							concatImage.append(rst.getString("HIDE_IMAGE_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("SURFACE_CODE"));
							concatImage.append("##");
							concatImage.append(rst.getString("MIXED_DENT_DECIDUOUS_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("SUPER_KEY_NUM"));
							concatImage.append("##");
							concatImage.append(rst.getString("TREATMENTS_OUTCOME"));
							concatImage.append("##");
							concatImage.append(rst.getString("IMAGE_ID_NEW"));
							concatImage.append("##");
							concatImage.append(rst.getString("TREATMENT_INT_EXT"));
							concatImage.append("~");
						}
					}
				}
				else{
					//commented and added by parul on 15/02/2010 for CRF-477 & 496
				//	sql_append.append("SELECT A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.TOOTH_NO, A.HIDE_IMAGE_YN, SURFACE_CODE, A.MIXED_DENT_DECIDUOUS_YN, (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) STATUS, A.SITE_TYPE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID, NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO FROM OH_RESTORATIVE_CHART_DTL A, OH_RESTORATIVE_CHART_HDR B, OH_TOOTH_BY_NUMBERING_SYSTEM C ");
					sql_append.append("SELECT A.TREATMENT_INT_EXT,A.TREATMENTS_OUTCOME,A.SUPER_KEY_NUM, A.SUPERNUMERARY_YN,A.CUSP_TIP_CODE,A.CHART_LINE_NUM,A.TOOTH_NO, A.SITE_TYPE, A.HIDE_IMAGE_YN, A.MIXED_DENT_DECIDUOUS_YN, (SELECT D.ORDER_STATUS_TYPE  FROM OR_ORDER_STATUS_CODE D WHERE D.ORDER_STATUS_CODE = A.STATUS) STATUS,A.SURFACE_CODE, DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT DECODE(TREATMENT_INT_EXT,'E',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_E.gif',SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_EF.gif'),'I',DECODE(NVL(TREATMENTS_OUTCOME,'S'),'S',E.IMAGE_ID,SUBSTR(E.IMAGE_ID,1,(INSTR(NVL(E.IMAGE_ID,'null'),'.gif')-1))||'_F.gif')) FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID_new,DECODE(TREATMENT_CONDITION,'C',(SELECT D.IMAGE_ID FROM OH_CONDITION_TYPE D WHERE D.CONDITION_TYPE = A.CONDITION_TYPE),'T',(SELECT E.IMAGE_ID FROM OH_TREATMENT_CATEGORY_TYPE E WHERE E.TRMT_CATEGORY_TYPE = A.TRMT_CATEGORY_TYPE)) IMAGE_ID ,NVL(A.CONDITION_TYPE,A.TRMT_CATEGORY_TYPE) CONDITION_OR_TREATMENT_TYPE, B.CHART_STATUS,C.NS_TOOTH_NO  FROM OH_RESTORATIVE_CHART_DTL A,  OH_RESTORATIVE_CHART_HDR B,OH_TOOTH_BY_NUMBERING_SYSTEM C");


					sql_append.append(" WHERE A.PATIENT_ID = ? AND A.CHART_NUM=? AND A.TOOTH_NO =? AND B.PATIENT_ID = A.PATIENT_ID AND B.CHART_NUM=A.CHART_NUM AND B.CHART_STATUS = 'A' AND NVL(A.STATUS,'X')!='E' AND NVL(A.COND_CLOSED_YN,'N') = 'N' AND A.TOOTH_NO = C.TOOTH_NO AND C.NUMBERING_SYSTEM= ? ");

					if((record_exfolth_count == 3)){
						sql_append.append("AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='D' AND NVL(A.MIXED_DENT_DECIDUOUS_YN,'X')!='M' ");//Added by Sridevi Joshi on 12/15/2009 ..not to get the cond/trmts recorded on Deciduous tooth once it got exfoliated in MP/MD chart
					}

					if(treatment_condition_tab_flag.equals("T")){ //When Clicked on Top Treatment Tab
						sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

					}else{
						sql_append.append("AND (A.TREATMENT_CONDITION = 'C' OR (A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT='E')) ");
					}
					//sql_append.append("AND ((A.TREATMENT_CONDITION = 'T' AND A.TREATMENT_INT_EXT IN('I','E') AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) IS NOT NULL AND (SELECT E.ORDER_STATUS_TYPE FROM OR_ORDER_STATUS_CODE E WHERE E.ORDER_STATUS_CODE = A.STATUS) NOT IN ('E') OR A.STATUS ='C') OR A.TREATMENT_CONDITION = 'C')");

					sql_append.append(" ORDER BY A.ARCH_SNO, A.QUADRANT_SNO, A.TOOTH_NO, A.CHART_LINE_NUM DESC ");

					tooth_no_arr = tooth_no.split(",");
					for(int i=0;i<tooth_no_arr.length;i++){
						pstmt = con.prepareStatement(sql_append.toString());
						pstmt.setString(1,facility_id);
						pstmt.setString(2,patient_id);
						pstmt.setString(3,chart_num);
						pstmt.setString(4,tooth_no_arr[i]);
						pstmt.setString(5,tooth_numbering_system);
						rst = pstmt.executeQuery();

						while(rst!= null && rst.next()){
							entered_yn = "Y";
							concatImage.append(rst.getString("IMAGE_ID"));
							concatImage.append("##");
							concatImage.append(rst.getString("TOOTH_NO"));
							concatImage.append("##");
							concatImage.append(rst.getString("NS_TOOTH_NO"));
							concatImage.append("##");
							concatImage.append(rst.getString("CONDITION_OR_TREATMENT_TYPE"));
							concatImage.append("##");
							concatImage.append(rst.getString("STATUS"));
							concatImage.append("##");
							concatImage.append(rst.getString("SITE_TYPE"));
							concatImage.append("##");
							concatImage.append(rst.getString("HIDE_IMAGE_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("SURFACE_CODE"));
							concatImage.append("##");
							concatImage.append(rst.getString("MIXED_DENT_DECIDUOUS_YN"));
							concatImage.append("##");
							concatImage.append(rst.getString("SUPER_KEY_NUM"));
							concatImage.append("##");
							concatImage.append(rst.getString("TREATMENTS_OUTCOME"));
							concatImage.append("##");
							concatImage.append(rst.getString("IMAGE_ID_NEW"));
							concatImage.append("##");
							concatImage.append(rst.getString("TREATMENT_INT_EXT"));
							concatImage.append("~");
						}
					}
				}

				if(entered_yn.equals("N")){
					concatImage.append("##");
					concatImage.append("~");
				}
			}

			out.println(concatImage);
			sql_append.setLength(0);
		}
	}catch(Exception e){
		System.err.println("Err Msg from CommonImagesValidation.jsp "+e);
		System.err.println("func_mode== "+func_mode);
	}
	finally{
		if(rst!=null) rst.close();
		if(pstmt!=null)pstmt.close();
		if(con!=null)
			ConnectionManager.returnConnection(con,request);
	}

            _bw.write(_wl_block2Bytes, _wl_block2);
        } catch (java.lang.Throwable __ee){
            if(!(__ee instanceof javax.servlet.jsp.SkipPageException)) {
                while ((out != null) && (out != _originalOut)) out = pageContext.popBody(); 
                _releaseTags(pageContext, _activeTag);
                pageContext.handlePageException(__ee);
            }
        }
    }
}
