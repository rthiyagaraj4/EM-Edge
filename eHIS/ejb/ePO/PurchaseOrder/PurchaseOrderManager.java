/*******************************************************************************
 * Copyright 1999-2015, Computer Sciences Corporation. All rights reserved.
 *  
 * Warning: This computer program is protected by copyright law and international treaties.
 * Unauthorized reproduction or distribution of this program, or any portion of it, 
 * may result in severe civil and criminal penalties, and will be prosecuted to 
 * the maximum extent possible under the law.
 ******************************************************************************/
package ePO.PurchaseOrder;
import javax.ejb.SessionContext;
import javax.ejb.EJBException;
import eCommon.Common.*;
import ePO.Common.PoEJBSessionAdapter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Properties;
import java.util.HashMap;

/**
*
* @ejb.bean
*	name="PurchaseOrder"
*	type="Stateless"
*	transaction-type="Bean"
*	view-type="both" 
*	jndi-name="PurchaseOrder"
*	local-jndi-name="PurchaseOrder"
*	impl-class-name="ePO.PurchaseOrder.PurchaseOrderManager"
*	
*
* @ejb.interface
*	extends="javax.ejb.EJBObject"
*	local-extends="javax.ejb.EJBLocalObject" 
*	local-class="ePO.PurchaseOrder.PurchaseOrderLocal"
*	remote-class="ePO.PurchaseOrder.PurchaseOrderRemote"
*	generate= "local,remote"
*
* @ejb.home
*	extends="javax.ejb.EJBHome" 
*	local-extends="javax.ejb.EJBLocalHome"
*	local-class="ePO.PurchaseOrder.PurchaseOrderLocalHome"
*	remote-class="ePO.PurchaseOrder.PurchaseOrderHome"
*	generate= "local,remote"
*
*
*/


public class  PurchaseOrderManager extends PoEJBSessionAdapter {
//	public SessionContext context = null;
	public void setSessionContext( SessionContext sessionContext) {
		super.setSessionContext(sessionContext);
		this.context = sessionContext;
	}
	///Function for handling generic operation..
	String SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE;	

	/**
	* @ejb.interface-method
	*	 view-type="both"
	*/

	public HashMap insert(HashMap hmData, HashMap hmSQL)	{
		Connection	connection = null;
		HashMap hmReturn = new HashMap();
		PreparedStatement preparedStatement	=	null;
		String sql =	"";
		ArrayList alData = null;
		ArrayList alRecord = null;
		ArrayList alDevlRecord = null;
		ArrayList alBillDevlRecord = null;
		Properties properties = null;
		ArrayList doc_no = new ArrayList();
		String doc_no_temp = "";
		//String   trn_type		=	"PO";
		int      sizeOfTrn		=	1;
		int      trnRecords		=	1;

		boolean isUpdateSuccessful = true;
		boolean isDocNoAutoGenerated	=	false;
		boolean isPurUnitPrefix			=	false;
		boolean isFacilityPrefix		=	false;
		boolean isYearPrefix			=	false;
		int iResult = 0;
		int failedRecordIndex = -1;
		int[] iaResult = null;
		//int iBillResult = 0;
		int[] devlResult = null;
		int[] billdevlResult = null;
		String do_no = "";
		//int sResult = 0;
		hmReturn.put(RESULT,FALSE);
		//	ArrayList	alDtlData1			=	(ArrayList)	hmData.get("InsertDTLData");
			System.out.flush();
			//ArrayList	alStatusData			=	null;

		try {
			properties =	(Properties) hmData.get("properties");
			connection = getConnection(properties);
			connection.setAutoCommit(false);

			int records_per_trn = 0;
			

			ArrayList final_dtl=(ArrayList) hmData.get("FINAL_DTL");
			
							
			// Insert Header Value
			for(int j=0,k=0;j<sizeOfTrn;j++){
			
				alData =	(ArrayList) hmData.get("InsertHDRData");
				SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE	=	(String)hmSQL.get ("SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE");
				
				HashMap hmRecord	=	fetchRecord(connection, SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE);
				
				
			isDocNoAutoGenerated	=	checkForNull((String)hmRecord.get("PO_DOC_NO_GEN_METHOD"),"N").equals("A");
			isPurUnitPrefix			=	checkForNull((String)hmRecord.get("PO_PURUNIT_PREFIX_YN"),"N").equals("Y");
			isFacilityPrefix		=	checkForNull((String)hmRecord.get("PO_FACILITY_PREFIX_YN"),"N").equals("Y");
			isYearPrefix			=	checkForNull((String)hmRecord.get("PO_YEAR_PREFIX_YN"),"N").equals("Y");
		
			// Insert Header Value
			
				if (isDocNoAutoGenerated) {
					if(isPurUnitPrefix){
						doc_no_temp = (String)alData.get(2);
					}
					if(isFacilityPrefix){
						doc_no_temp = doc_no_temp +  (String)alData.get(3);
					}
					if(isYearPrefix){
						doc_no_temp = doc_no_temp +  (String)fetchRecord(connection, SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE).get("CURRENT_YEAR");
					}
				//	doc_no_temp = 	doc_no_temp + (String)fetchRecord(connection, SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE).get("PO_NEXT_SRLNO");
				do_no = (String)fetchRecord(connection, SQL_PO_DOC_TYPE_SELECT_FLAG_FROM_CONTROL_TABLE).get("PO_NEXT_SRLNO") ; 
					if( do_no != null && do_no != ""){
						doc_no_temp = 	doc_no_temp + do_no;
					}else{
						hmReturn.put(RESULT,FALSE);
						hmReturn.put(MSGID,DOCNO_NULL);
						return hmReturn;
												
					}	
				}else{
				doc_no_temp=(String)alData.get(0);		
				}

				alData.set(0,doc_no_temp);
			
				doc_no.add((String)alData.get(0));
				sql = (String) hmSQL.get	("InsertHDRSQL");
				
				preparedStatement = connection.prepareStatement(sql);
				setData(preparedStatement,alData);
				iResult = preparedStatement.executeUpdate();
				if(preparedStatement!=null)
						preparedStatement.close();
				if(iResult != 0) {
					hmReturn.put(RESULT,TRUE);
					hmReturn.put(MSGID,RECORD_INSERTED);
				}
				else {
					connection.rollback();
					throw new EJBException("Insert failed in header");
				}

				// Insert Detail Value
				sql = null;
				alData =null;
		
				
				alData = final_dtl;
				sql = (String)	hmSQL.get	("InsertDTLSQL");
				preparedStatement = connection.prepareStatement(sql);
				trnRecords = alData.size();
			
				for (int index = k; index < trnRecords; index++) {
					alRecord = (java.util.ArrayList) alData.get(index);
					alRecord.set(1,doc_no_temp);
					setData(preparedStatement, alRecord);
					preparedStatement.addBatch();
				}
				try{
				iaResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<iaResult.length ;i++){
					if((iaResult[i] != -2) && (iaResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting detail record " + failedRecordIndex);
				}
				
				
				// Update Commitment Code Balance Budget Amount
			
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateCOMMTData") && hmSQL.containsKey("UpdateCOMMTSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateCOMMTData");
				sql = (String)	hmSQL.get	("UpdateCOMMTSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
			
			// Update Commitment Code Balance Budget Amount
			
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateBlockData") && hmSQL.containsKey("UpdateBlockSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateBlockData");
				sql = (String)	hmSQL.get	("UpdateBlockSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
			
			
			
			// Update MM_ITEM 
			
			if (hmData.containsKey("UpdateMMITEMData") && hmSQL.containsKey("UpdateMMITEMSQL")) {			
				ArrayList mm_item=(ArrayList) hmData.get("UpdateMMITEMData");
				sql = null;
				alData =null;
				alData = mm_item;
				sql = (String)	hmSQL.get	("UpdateMMITEMSQL");
				preparedStatement = connection.prepareStatement(sql);
				trnRecords = alData.size();
			
				for (int index = k; index < trnRecords; index++) {
					alRecord = (java.util.ArrayList) alData.get(index);
					setData(preparedStatement, alRecord);
					preparedStatement.addBatch();
				}
				try{
				iaResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<iaResult.length ;i++){
					if((iaResult[i] != -2) && (iaResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting detail record " + failedRecordIndex);
				}
			}
				
				// Update Request Detail Value
			if (hmData.containsKey("UpdateREQDTLData") && hmSQL.containsKey("UpdateREQDTLSQL")) {				
				ArrayList req_dtl=(ArrayList) hmData.get("UpdateREQDTLData");
				sql = null;
				alData =null;
				
				
				alData = req_dtl;
				sql = (String)	hmSQL.get	("UpdateREQDTLSQL");
				preparedStatement = connection.prepareStatement(sql);
				trnRecords = alData.size();
			
				for (int index = k; index < trnRecords; index++) {
					alRecord = (java.util.ArrayList) alData.get(index);
					setData(preparedStatement, alRecord);
					preparedStatement.addBatch();
				}
				try{
				iaResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<iaResult.length ;i++){
					if((iaResult[i] != -2) && (iaResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting detail record " + failedRecordIndex);
				}
				
			}	
				// Update Request Header Value
			if (hmData.containsKey("UpdateREQHDRData") && hmSQL.containsKey("UpdateREQHDRSQL")) {					
				ArrayList req_hdr=(ArrayList) hmData.get("UpdateREQHDRData");
				sql = null;
				alData =null;
				
				
				alData = req_hdr;
				sql = (String)	hmSQL.get	("UpdateREQHDRSQL");
				preparedStatement = connection.prepareStatement(sql);
				trnRecords = alData.size();
			
				for (int index = k; index < trnRecords; index++) {
					alRecord = (java.util.ArrayList) alData.get(index);
					setData(preparedStatement, alRecord);
					preparedStatement.addBatch();
				}
				try{
				iaResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<iaResult.length ;i++){
					if((iaResult[i] != -2) && (iaResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting detail record " + failedRecordIndex);
				}
				
			}	
			
				// Insert Delivery Detail Value
			if (hmData.containsKey("InsertDELVData") && hmSQL.containsKey("InsertDELVSQL")) {						
				sql = null;
				alData =null;
		
				alData =	(ArrayList) hmData.get("InsertDELVData");

				if(alData.size()>0){
				sql = (String)	hmSQL.get	("InsertDELVSQL");
				preparedStatement = connection.prepareStatement(sql);
				trnRecords = alData.size();
			
				for (int index = k; index < trnRecords; index++) {
					alDevlRecord = (java.util.ArrayList) alData.get(index);
					alDevlRecord.set(0,doc_no_temp);
					setData(preparedStatement, alDevlRecord);
					preparedStatement.addBatch();
				}
				try{
				devlResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<devlResult.length ;i++){
					if((devlResult[i] != -2) && (devlResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting Delivery detail record " + failedRecordIndex);
				}
				}
			}
			
			// Insert Bill Delivery Details Value
			if (hmData.containsKey("InsertBILLDELVData") && hmSQL.containsKey("InsertBILLDELVSQL")) {						
				sql = null;
				alData =null;
			
				alData =	(ArrayList) hmData.get("InsertBILLDELVData");
				if(alData.size()>0){
				sql = (String)	hmSQL.get	("InsertBILLDELVSQL");
				preparedStatement = connection.prepareStatement(sql);
				trnRecords = alData.size();
			
				for (int index = k; index < trnRecords; index++) {
					alBillDevlRecord = (java.util.ArrayList) alData.get(index);
					alBillDevlRecord.set(0,doc_no_temp);
					setData(preparedStatement, alBillDevlRecord);
					preparedStatement.addBatch();
				}
				try{
				billdevlResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<billdevlResult.length ;i++){
					if((billdevlResult[i] != -2) && (billdevlResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting Delivery detail record " + failedRecordIndex);
				}
				}
			
				
			}
				iaResult = null;
				sql = null;
				alData = null;
			
						
				//Update the document no
				ArrayList allanguageData			=	(ArrayList)	hmData.get("LANGUAGE_DATA");
				String locale=(String)allanguageData.get(0);
				if (isDocNoAutoGenerated) {
					String s  = "";
					String s1 = "";
					sql = (String)	hmSQL.get	("UpdateSQL");
					alData = (ArrayList)	hmData.get ("UpdateData");
					preparedStatement = connection.prepareStatement(sql);
					setData(preparedStatement,alData);
					iResult = preparedStatement.executeUpdate();
					if(doc_no.size()>1){
						java.util.Locale loc = new java.util.Locale(locale);
						java.util.ResourceBundle common_labels = java.util.ResourceBundle.getBundle( "eCommon.resources.Labels",loc);
						s = getPOMessage(locale, "DOC_NOS_GEN_FROM", "PO") ;
					
						s1=s+"  "+doc_no.get(0)+" "+common_labels.getString("Common.to.label")+" "+doc_no.get(doc_no.size()-1);
					}else{
						s = getPOMessage(locale, "DOC_NO", "PO") ;
						s1=s+":  "+doc_no.get(0);
					}
					hmReturn.put("flag",s1);
					if(preparedStatement!=null)
							preparedStatement.close();
					if(iResult<=0){
						connection.rollback();
						throw new SQLException("Update of Document No failed");
					}
				}
				// After successful insertion and updation 
			k=k+records_per_trn;
			}
				connection.commit();
				hmReturn.put(RESULT,TRUE);
				hmReturn.put(MSGID,RECORD_INSERTED);
				if (connection!=null) {
						closeConnection(connection,properties);	
				}
		}catch(SQLException sqlException) {
			try {
				connection.rollback();
				hmReturn.put(RESULT,FALSE);
				if(sqlException.getErrorCode()==1) {
					hmReturn.put(MESSAGE,CODE_ALREADY_EXISTS);
					hmReturn.put(MSGID,CODE_ALREADY_EXISTS);

				}
				else {
					hmReturn.put(MESSAGE,sqlException.toString());
				}
				sqlException.printStackTrace();
			}
			catch (Exception exception) {
				exception.printStackTrace(); 
			}
        }
		catch(Exception exception) {
			try {
				connection.rollback();
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MESSAGE,exception.toString());
				hmReturn.put(MSGID,exception.toString());
				exception.printStackTrace();
			}
			catch (Exception subexception) {
				subexception.printStackTrace(); 
			}
        }
		finally{
			try{
				if(preparedStatement!=null)
					preparedStatement.close();
				if (connection!=null) {
					closeConnection(connection,(Properties)hmData.get(properties));	
				}
			}
			catch (Exception exception){
				exception.printStackTrace();
			}
		} 
	
		hmReturn.put("doc_no",doc_no);

		return hmReturn;
	}

	/**
	* @ejb.interface-method
	*	 view-type="both"
	*/

	public HashMap modify(HashMap hmData, HashMap hmSQL)	 {
		Connection	connection = null;
		HashMap hmReturn = new HashMap();
		PreparedStatement preparedStatement	=	null;
		ArrayList alData =	new ArrayList();
		ArrayList	 alRecord =	new ArrayList();
		Properties properties = null;
		String sql =	"";
		int iResult =	0;
//		ArrayList	alStatusData			=	null;
	
		int iaResult[] = null;
	//	int sResult = 0;
		boolean isUpdateSuccessful = true;
		hmReturn.put(RESULT,FALSE);
		hmReturn.put(MESSAGE,"No records found to be modified..");
		properties =	(Properties) hmData.get("properties");
		//25/06/2012 below
		 ArrayList alDevlRecord = null;  
		 int[] devlResult = null;  
		 int failedRecordIndex = -1;
		
		try {
			connection = getConnection(properties);
			connection.setAutoCommit(false);
			
			if (hmData.containsKey("UpdateData") && hmSQL.containsKey("UpdateSQL")) {
			alData =	(ArrayList)	hmData.get ("UpdateData");
			sql = (String)	hmSQL.get	("UpdateSQL");
			
			preparedStatement = connection.prepareStatement(sql);
			setData(preparedStatement,alData);
			iResult	 =	preparedStatement.executeUpdate();
			if(preparedStatement!=null)
					preparedStatement.close();
			if(iResult!=0){
				hmReturn.put(RESULT,TRUE);
				hmReturn.put(MSGID,RECORD_MODIFIED);
			}
			}
			alData = null;
			sql = null;
			
			//Update Bill dvly detail data
		if (hmData.containsKey("UpdateBillDvlyData") && hmSQL.containsKey("UpdateBillDvlySQL")) {	
			alData =	(ArrayList)	hmData.get ("UpdateBillDvlyData");
			sql = (String)	hmSQL.get	("UpdateBillDvlySQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			
			}
			
				//Insert Bill dvly detail data
		if (hmData.containsKey("InsertBillDvlyData") && hmSQL.containsKey("InsertBillDvlySQL")) {	
			alData =	(ArrayList)	hmData.get ("InsertBillDvlyData");
			sql = (String)	hmSQL.get	("InsertBillDvlySQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			
			}
			
			
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("DeleteDTLData") && hmSQL.containsKey("DeleteDTLSQL")) {
				alData = (ArrayList)	hmData.get ("DeleteDTLData");
				sql = (String)	hmSQL.get	("DeleteDTLSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
			
			// Update Commitment Code Balance Budget Amount
			
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateCOMMTData") && hmSQL.containsKey("UpdateCOMMTSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateCOMMTData");
				sql = (String)	hmSQL.get	("UpdateCOMMTSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
			
			
	// Update Commitment Code Blocked Budget Amount
			
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateBlockData") && hmSQL.containsKey("UpdateBlockSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateBlockData");
				sql = (String)	hmSQL.get	("UpdateBlockSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}			
			
			// Update MM_ITEM 
			
						
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateMMITEMData") && hmSQL.containsKey("UpdateMMITEMSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateMMITEMData");
				sql = (String)	hmSQL.get	("UpdateMMITEMSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
				
				
				// Update Request Detail Value
				
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateREQDTLData") && hmSQL.containsKey("UpdateREQDTLSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateREQDTLData");
				sql = (String)	hmSQL.get	("UpdateREQDTLSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
				
				
				
				// Update Request Header Value
				
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("UpdateREQHDRData") && hmSQL.containsKey("UpdateREQHDRSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateREQHDRData");
				sql = (String)	hmSQL.get	("UpdateREQHDRSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++){
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
				
				
			// Update po order fcy detail				
			
			alData = null;
			sql = null;
			if (hmData.containsKey("UpdateDTLData") && hmSQL.containsKey("UpdateDTLSQL")) {
				alData = (ArrayList)	hmData.get ("UpdateDTLData");
				sql = (String)	hmSQL.get	("UpdateDTLSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alRecord);
						preparedStatement.addBatch();
					}
					iaResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<iaResult.length ;i++) {
						if((iaResult[i] != -2) && (iaResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}	
				}
			}
			if (hmData.containsKey("InsertDTLData") && hmSQL.containsKey("InsertDTLSQL")) {
				alData = (ArrayList)	hmData.get ("InsertDTLData");
				sql = (String)	hmSQL.get	("InsertDTLSQL");
				preparedStatement = connection.prepareStatement(sql);
				for (int index = 0; index < alData.size(); index++) {
					alRecord = (java.util.ArrayList) alData.get(index);
					setData(preparedStatement, alRecord);
					preparedStatement.addBatch();
				}
				iaResult = preparedStatement.executeBatch();
				if(preparedStatement!=null)
					preparedStatement.close();
				//preparedStatement.clearParameters();
				for (int i=0;i<iaResult.length ;i++){
					if((iaResult[i] != -2) && (iaResult[i]<0)){
						isUpdateSuccessful = false;
						break;
					}	
				}
			}
			
				// delete Delivery Detail Value
			alData = null;
			sql = null;
			
			
			if (hmData.containsKey("DeleteDevlDTLData") && hmSQL.containsKey("DeleteDevlDTLSQL")) {
				alData = (ArrayList)	hmData.get ("DeleteDevlDTLData");
				sql = (String)	hmSQL.get	("DeleteDevlDTLSQL");
				if (alData.size() >0) {
					preparedStatement = connection.prepareStatement(sql);
					for (int index = 0; index < alData.size(); index++) {
						alDevlRecord = (java.util.ArrayList) alData.get(index);
						setData(preparedStatement, alDevlRecord);
						preparedStatement.addBatch();
					}
					devlResult = preparedStatement.executeBatch();
					if(preparedStatement!=null)
					preparedStatement.close();
					for (int i=0;i<devlResult.length ;i++){
						if((devlResult[i] != -2) && (devlResult[i]<0)){
							isUpdateSuccessful = false;
							break;
						}	
					}
					if(!isUpdateSuccessful){
						connection.rollback();
						throw new EJBException("Update failed while inserting detail record");
					}
				}
			}
			
			
			
			// Insert Delivery Detail Value
				sql = null;
				alData =null;
			if (hmData.containsKey("InsertDELVData") && hmSQL.containsKey("InsertDELVSQL")) {
				alData =	(ArrayList) hmData.get("InsertDELVData");

				if(alData.size()>0){
				sql = (String)	hmSQL.get	("InsertDELVSQL");
				preparedStatement = connection.prepareStatement(sql);
				//trnRecords = alData.size();
			
				for (int index = 0; index < alData.size(); index++) {
					alDevlRecord = (java.util.ArrayList) alData.get(index);
					setData(preparedStatement, alDevlRecord);
					preparedStatement.addBatch();
				}
				try{
				devlResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<devlResult.length ;i++){
					if((devlResult[i] != -2) && (devlResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting Delivery detail record " + failedRecordIndex);
				}
				}
			}
			
		// Update Delivery Details

			
			// Insert Delivery Detail Value
				sql = null;
				alData =null;
			if (hmData.containsKey("UpdateDELVData") && hmSQL.containsKey("UpdateDELVSQL")) {
				alData =	(ArrayList) hmData.get("UpdateDELVData");

				if(alData.size()>0){
				sql = (String)	hmSQL.get	("UpdateDELVSQL");
				preparedStatement = connection.prepareStatement(sql);
				//trnRecords = alData.size();
			
				for (int index = 0; index < alData.size(); index++) {
					alDevlRecord = (java.util.ArrayList) alData.get(index);
					setData(preparedStatement, alDevlRecord);
					preparedStatement.addBatch();
				}
				try{
				devlResult = preparedStatement.executeBatch();
				}catch(Exception exception){
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				connection.rollback();
				return hmReturn;
				}
				if(preparedStatement!=null)
						preparedStatement.close();
				for (int i=0;i<devlResult.length ;i++){
					if((devlResult[i] != -2) && (devlResult[i]<0)){
						failedRecordIndex = i;
						isUpdateSuccessful = false;
						break;
					}	
				}
				if(!isUpdateSuccessful){
					connection.rollback();
					throw new EJBException("Update failed while inserting Delivery detail record " + failedRecordIndex);
				}
				}
			}		
			
			alData = null;
			sql = null;
		
			if(isUpdateSuccessful){
				connection.commit();
				hmReturn.put(RESULT,TRUE);
				hmReturn.put(MSGID,RECORD_MODIFIED);
			}

			closeConnection(connection,properties);	
}
		catch(Exception exception) {
			try {
				connection.rollback();
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MSGID,exception.toString());
				hmReturn.put(MESSAGE,exception.toString());
				exception.printStackTrace();
			}
			catch (Exception subexception) {
				subexception.printStackTrace();
			}
        }
		finally{
 			try{
				if(preparedStatement!=null)
					preparedStatement.close();
				closeConnection(connection,(Properties)hmData.get(properties));	
			}
			catch (Exception subexception){
				subexception.printStackTrace();
			}
		}
		return hmReturn;
	}

	/**
	* @ejb.interface-method
	*	 view-type="both"
	*/

	public HashMap delete(HashMap hmData, HashMap hmSQL)	{
		Connection connection = null;
		HashMap hmReturn = new HashMap();
		PreparedStatement preparedStatement	=	null;
		String sql = "";
		Properties properties = null;
		ArrayList alData =	new ArrayList();
//		ArrayList alRecords =	new ArrayList();
//		ArrayList alRecord =	new ArrayList();
//		int iaResult[] = null;
//		boolean isUpdateSuccessful = true;
		int iResult = 0;
		properties =	(Properties) hmData.get("properties");
		hmReturn.put(RESULT,FALSE);
		hmReturn.put(MESSAGE,"No record found to be deleted..");
		try {
			connection = getConnection(properties);
			connection.setAutoCommit(false);

			//Delete Details
			alData = (ArrayList)	hmData.get("DeleteDTLData");
			sql = (String)	hmSQL.get	("DeleteDTLSQL");
			preparedStatement = connection.prepareStatement(sql);
			setData(preparedStatement,alData);
			iResult		=	preparedStatement.executeUpdate();
			if(iResult<=0) {
				connection.rollback();
				throw new Exception("Delete failed in Detail !");
			}
			/*Commented by suresh.r on 10-09-2014 against ML-BRU-SCF-1430 beg
			//Delete Header
			alData = (ArrayList)	hmData.get("DeleteHDRData");
			sql = (String)	hmSQL.get	("DeleteHDRSQL");
			preparedStatement = connection.prepareStatement(sql);
			setData(preparedStatement,alData);
			iResult		=	preparedStatement.executeUpdate();
			if(preparedStatement!=null)
					preparedStatement.close();
			if(iResult<=0) {
				connection.rollback();
				throw new Exception("Delete failed in header !");
			}Commented by suresh.r on 10-09-2014 against ML-BRU-SCF-1430 end*/
			//Delete Delivery Schedule
			alData = (ArrayList)	hmData.get("DeleteDELVData");
			sql = (String)	hmSQL.get	("DeleteDELVSQL");
			preparedStatement = connection.prepareStatement(sql);
			setData(preparedStatement,alData);
			iResult		=	preparedStatement.executeUpdate();
			if(iResult<=0) {
				connection.rollback();
				throw new Exception("Delete failed in delivery sch !");
			}
			//Delete Bill Delivery Details
			alData = (ArrayList)	hmData.get("DeleteBILLDELVData");
			sql = (String)	hmSQL.get	("DeleteBILLDELVSQL");
			preparedStatement = connection.prepareStatement(sql);
			setData(preparedStatement,alData);
			iResult		=	preparedStatement.executeUpdate();
			if(iResult<=0) {
				connection.rollback();
				throw new Exception("Delete failed in bill delivery !");
			}
			//Added by suresh.r on 10-09-2014 against ML-BRU-SCF-1430 beg
			//Delete Header
			alData = (ArrayList)	hmData.get("DeleteHDRData");
			sql = (String)	hmSQL.get	("DeleteHDRSQL");
			preparedStatement = connection.prepareStatement(sql);
			setData(preparedStatement,alData);
			iResult		=	preparedStatement.executeUpdate();
			if(preparedStatement!=null)
					preparedStatement.close();
			if(iResult<=0) {
				connection.rollback();
				throw new Exception("Delete failed in header !");
			}
			//Added by suresh.r on 10-09-2014 against ML-BRU-SCF-1430 end
			connection.commit();
			hmReturn.put(RESULT,TRUE);
			hmReturn.put(MSGID,RECORD_DELETED);
			if (connection!=null) {
						closeConnection(connection,properties);	
			}		
		}
		catch(Exception exception) {
			try {
				connection.rollback();
				hmReturn.put(RESULT,FALSE);
				hmReturn.put(MESSAGE,exception.toString());
				exception.printStackTrace();
			}
			catch (Exception subexception) {
					subexception.printStackTrace();
			}
        }
		finally{
			try{
				if(preparedStatement!=null) {
					preparedStatement.close();
				}
				closeConnection(connection,(Properties)hmData.get(properties));	
			}
			catch (Exception exception){
				exception.printStackTrace();
			}
		}
		return hmReturn;
	}
	protected final String MESSAGE = "message";
	protected final String RESULT = "result";
	protected final Boolean TRUE = new Boolean(true);
	protected final Boolean FALSE =	new Boolean(false);
	private final String CODE_ALREADY_EXISTS = "CODE_ALREADY_EXISTS";
    private final String RECORD_INSERTED = "RECORD_INSERTED";
    private final String RECORD_MODIFIED = "RECORD_MODIFIED";
    private final String RECORD_DELETED  =	"RECORD_DELETED";
	private final String DOCNO_NULL  	=	"DOCNO_NULL";
}
