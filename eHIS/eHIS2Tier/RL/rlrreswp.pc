/***************************************************************************** 
  
*  File	         : rlrreswp.pc
   Author        : Sheelvant
   Date Created  : 03/02/1997
   Last Modified : 16/08/1997    ( Sheelvant )   

*  Ver 1.10.01
   
   Modified by   : HAMEED  

*  Purpose : To Create Worklist Date for the given Specimen Range     
            
*  Input Parameters : 
                      Command line inputs
		              1. Usr_id/Password
                      2. Session id
		              3. Program Date

                      Parameters from SY_PROG_PARAM table 
                      4. Preferred range of Specimen Numbers            
                      5. Criteria Flag                                  
                      6. Section Code                                   
                      7. Worklist_name                                  
                      8. Worklist Number                                
                      9. Worklist Date                                  
                      9. User Id                                        
  
*  Table Accessed : RL_WORKLIST_FMT_HDR,RL_WORKLIST_FMT_DTL,RL_TEST_RESULT,
		            RL_WORKLIST_DTL

*****************************************************************************/  

#include <stdio.h>
#include <string.h>
#include <math.h>

#define MAX_LINES 58
#define OERROR (sqlca.sqlcode < 0)
#define NODATAFOUND sqlca.sqlcode==1403
#define LAST_ROW 	(sqlca.sqlcode == 1403)
#define VER  "VER : 1.10.01\n"
#define REP_WIDTH 80
/*#define ONLINE_PRINTING 0*/

#define ESC 0x1B

/*
#define DEBUG   
*/

EXEC SQL BEGIN DECLARE SECTION;

       /* increased the length all varchar variables by one to take care */
       /* for null termination */
	VARCHAR nd_operating_facility_id   [3],
	        uid_pwd		               [91],
		    nd_file_name               [150], 
 
    /* From RL_WORKLIST_QLTY_CUP_SEQ */
		d_qlty_code             [5],

	/* from RL_WORKLIST_FMT_HDR */
		d_worklist_name         [11],
        d_criteria_flag   	    [2],
		d_cup_indicators_1      [51],
		d_cup_indicators_2      [51],
		d_cup_indicators_3      [51],
		d_cup_indicators_4      [51],
		d_cup_indicators_5      [51],
		d_added_by_id           [51],
		rowid_wrk               [31],
		
        /* from RL_WORKLIST_FMT_DTL */
		d_worklist_test_code	[11],
		d_test_indicator	[2],

        /* from RL_TEST_RESULT */     
		d_specimen_no           [21],
		nd_specimen_no			[21],
		d_prt_cup_no			[30],
		d_patient_id            [31],
		d_req_test_code		[11],
		d_num_result		[16],
		d_comm_result		[16],
		d_test_result		[16],
		
		/*** To print the Previous Result ***/
		d_test_prv_result		[16],
                
		/* from RL_REQUEST_DETAIL*/
		d_req_dtl_test		[11],

        /* from RL_QC_MATERIAL_TEST */
		d_qc_test_code		[11],

        /* from PATIENT MASTERS     */
		d_date_of_birth		[11],
		d_short_name   		[240],
        d_nation                [5],
        d_sex                   [2],
		d_pat_mark              [2],
		d_worklist_marker       [11],

        /* from RL_REQUEST_HEADER   */
		d_source_code 		    [7],
		d_episode_type          [2],
		d_spec_regd_date_time   [17],
		d_l_spec_regd_date_time [17], /*Added by Durai Rajkumar for Age Calculation on 05-Feb-08 */
		d_consultant_code		[16],
		d_urgent_indicator      [2],
		d_request_comment_code1 [5],
		d_request_comment_code2 [5],
		d_request_comment_code3 [5],

		/*   from RL_REQUEST_COMMENT_CODE   */
		d_request_comment_desc1 [42],  
		d_request_comment_desc2 [42],  
		d_request_comment_desc3 [42],  

        /* from RL_WORKLIST_DTL for printing only     */
		d_prt_specimen_no	[21],
		d_prt_patient_id	[31],
		d_print_cup_indicator   [2],

        /* from RL_TEST_QUALITY_MAST */
		d_qlty_test             [11],

        /* Dummy Variable */     
	    nd_chk_test_code	[11],
		nd_ins_specimen_no      [21], 
		nd_ins_patient_id       [31], 


		/*  For Patient Age SYSDATE, MTHS */
			today				[30],
			t_days				[30],
			mths				[30],
			mths1				[30],
			t_age				[30],

		
		/* input parameters to main() */
        nd_session_id           [16],
		nd_pgm_date	            [20],

	
		/************* newly added variable for KN EHNANCMENTS ******/
		d_section_name		[60],
		d_added_date		[21],
		d_added_date1		[21],
		d_added_time		[21],
	
		/******** parameters from SY_PROG_PARAM table ***********/
		nd_section_code    	[2],
		nd_worklist_name   	[11],
		nd_worklist_date   	[11],
		nd_worklist_date1   	[11],
		nd_criteria_flag   	[2],
		nd_fr_specimen_no  	[21],
		nd_to_specimen_no  	[21],
		nd_print_yn             [2],
		nd_user_id              [31],
		rp_worklist_name        [11],     
		rp_worklist_date        [11],
		rp_reprint              [8],
		nd_assign_to		[31],
		rp_assign_to		[31],
		nd_field_type		[2],

        /* variable for cursor */
		nd_cur_specimen_no      [21],
		nd_cur_patient_id       [31],
        nd_file_no              [15],

	       /* for header routine */
	       //d_acc_entity_name         [61],
		   d_acc_entity_name         [300],
	       d_user                    [31],
	       d_sysdate                 [20],

           /* Fields from table RL_SECTION__CODE */
	       d_printer_name            [16],

/*  New Fields from RL_WORKLIST_FMT_HDR  */
		nd_cup_number		    [32],
		nd_cup_indr				[32],
		nd_spec_no				[32],
		nd_wl_marker			[32],
		nd_pat_id			    [32],
		nd_pat_name	     		[61],
		nd_age					[32],
		nd_dob					[32],
		nd_sex					[32],
		nd_source				[32],
		nd_consultant			[32],
		nd_urgency				[32],
		nd_comm_1				[32],
		nd_comm_2				[32],
		nd_comm_3				[32],
		nd_spec_date			[32],
		nd_ref_location			[32],
		nd_collect_date			[32], 
		nd_category_no			[32], 
		nd_race					[32],
		nd_heading				[20],
		
		/* Added on 26/01/2004 to get the Print Previouos Result flag */
		d_prv_result_yn			[3],
		nd_prv_result_dt        [30],
		d_past_result_unit      [6],
		nd_modified_dt			[30],

		d_test_code				[11],
		/*****variables added for conversion*********/
		l_translated_value		 [100],
		language_id			[5];


		int		d_past_result_period;
		int		d_past_result_no;

float mt;

/* Fields from table SY_PROG_PARAM*/                          

int  		nd_worklist_no;
int             rp_worklist_no;

/* Fields from table RL_WORKLIST_FMT_HDR */                          

int  		d_worklist_no, d_no_of_cups,d_line_spacing;

/* Fields from table RL_WORKLIST_FMT_DTL */                          
/* int  	d_prt_cup_no;      */
int  		d_seq_no; 
int         d_no_of_tests;
int		    tests ;

/* Fields from table RL_WORKLIST_DTL */                          
char            d_prt_test_1_yn,d_prt_test_2_yn,d_prt_test_3_yn,
                d_prt_test_4_yn,d_prt_test_5_yn,d_prt_test_6_yn,
                d_prt_test_7_yn,d_prt_test_8_yn,d_prt_test_9_yn,
                d_prt_test_10_yn,d_prt_test_11_yn,d_prt_test_12_yn,
                d_prt_test_13_yn,d_prt_test_14_yn,d_prt_test_15_yn,
                d_prt_test_16_yn,d_prt_test_17_yn,d_prt_test_18_yn,
                d_prt_test_19_yn,d_prt_test_20_yn,d_prt_test_21_yn,
                d_prt_test_22_yn,d_prt_test_23_yn,d_prt_test_24_yn,
                d_prt_test_25_yn;
  
  
/* Dummy Fields  */                                                  
int  		ic,cup_no = 0,pending_tests = 0;
int  		line_no,page_no,no_of_tests,tests_on_page;
char            test_exists_in_specimen;
char            sql_stmt[5000];
char 		cup_ind;                                  
char		nd_qc_code;
char            dummy_test_array[25];
char            cup_indicator[251];
char            file_name[30],
		file_name2[30];


/************** NEWLY ADDED FOR KNDV ENHANCEMENTS	**************/

	VARCHAR		d_tst_test_code		    [11],
				d_tst_numeric_result    [16],
				d_num_prefix			[2],
				d_tst_test_name		    [41],
				d_curr_date			    [11],
				d_curr_date1			[11],
				d_curr_time			    [6],
				d_assign_to			    [21],
				d_category			    [25],
				d_spec_colltd_date_time [20],
				d_race_code				[5],
				d_location				[21],
				d_comm_result1			[16],
				d_comm_result2			[16],
				d_comm_result3			[16],
				d_comm_result4			[16],
				d_status				[2],
				d_comm_result_desc1			[41],
				d_comm_result_desc2			[41],
				d_comm_result_desc3			[41],
				d_comm_result_desc4			[41];

/*** Added to get the print the Previous results ***/

	VARCHAR		d_prv_specimen_no			[30],
				d_tst_prv_test_code		    [11],
				d_tst_prv_numeric_result    [16],
				d_num_prv_prefix			[2],
				d_tst_prv_test_name		    [41],
				d_curr_prv_date			    [11],
				d_curr_prv_time			    [6],
				d_assign_prv_to			    [21],
				d_category_prv			    [25],
				d_spec_prv_colltd_date_time [20],
				d_race_code_prv				[5],
				d_location_prv				[21],
				d_comm_prv_result1			[16],
				d_comm_prv_result2			[16],
				d_comm_prv_result3			[16],
				d_comm_prv_result4			[16],
				d_status_prv				[2],
				d_comm_prv_result_desc1			[41],
				d_comm_prv_result_desc2			[41],
				d_comm_prv_result_desc3			[41],
				d_comm_prv_result_desc4			[41],
				d_prv_specimen_regd_date        [30];


int stimulate = 0;
int num[22];
int cou[22];
char word[22][32];
char str_word[22][32];
char temp_word[32];
char detail[22][44];
int largest_row = 0;
int header_printed = 0;

int l_count = 0;

char	print_temp_line[100];
char	print_test_line[100];

//Added for conversion
int i;
char local_legend[100][100];
char hdr_line1[REP_WIDTH+1],
     hdr_line2[REP_WIDTH+1],
     hdr_line3[REP_WIDTH+1];
int col;
char rep_title1[100] ;
char rep_title2[60];
int rec_len;




EXEC SQL END DECLARE SECTION;

EXEC SQL INCLUDE SQLCA.H;
EXEC SQL INCLUDE SQLDA.H;

#include <winproc.h>

int       rec_inserted;
int       atleast_one_specimen_found;
int       specimen_over;
int       mandatory_tests_exist;
int       worklist_mandatory_tests_exist;
char      worklist_test[26][11];
char      worklist_ind[26][2];
char      mandatory_ind[26];
int       print_line;
char      chk_mand_test[26];
char      string_var[1000];
int       test_ctr;
int       maxx = 0;

int i =  0;
int j = 0 ;
int k = 0;
int ctr = 0;
int str_len = 0 ;
int total = 0 ;
int tot_tests = 0;

char cup_type;

FILE *f1;

void proc_main(argc, argv)
int argc;
char *argv[];
{
  void  get_params(),
  	get_header_dtls(),
	dclr_request_detail_cur(),
    dclr_worklist_dtl_cur(),
    dclr_worklist_prt_dtl_cur(),
  	dclr_specimen_cur(),
  	get_worklist_hdr(),
	get_worklist_specimen_range(),
	dclr_qlty_tests_cur(),
  	do_report(),
	//get_dept_printer(),
	get_worklist_marker(),
	get_prvrslt_flag();

	void print_hyphen(FILE *);
	void patient_age();
	void print_dtl(FILE *);
	void sorting();
	void reverse_sort();
	void prepare_heading(FILE *);

   if(argc < 4) {
     disp_message(ERR_MESG,"Usage rlrcrewl uid/passwd session_id pgm_date\n");
     proc_exit();
   }

   strcpy(uid_pwd.arr, argv[1]);
   uid_pwd.len = strlen(uid_pwd.arr); 

   strcpy(nd_session_id.arr, argv[2]);
   nd_session_id.len = strlen(nd_session_id.arr); 

   strcpy(nd_pgm_date.arr, argv[3]);
   nd_pgm_date.len = strlen(nd_pgm_date.arr); 

   strcpy(OUTPUT_FILE_NAME, argv[5]);

//disp_message(ERR_MESG, uid_pwd.arr);

   EXEC SQL CONNECT :uid_pwd;  

   if(OERROR)
      disp_message(ORA_MESG,"Failed to connect using : %s\n");

#ifdef DEBUG
    printf("Connected to ORACLE as user: %s \n", uid_pwd.arr);
#endif  
    
    set_meduser_role();
	  strcpy(language_id.arr,l_language_id.arr);
	language_id.len =l_language_id.len;
	language_id.arr[l_language_id.len]='\0';
	
   get_legend_value(26);



   /*printf("RLRCREWL : Program Started.\n\n"); */

   get_params();

   get_prvrslt_flag();

   if(strcmp(rp_reprint.arr,"REPRINT") == 0)
   {
      strcpy(nd_worklist_name.arr,rp_worklist_name.arr);
      nd_worklist_name.len = strlen(rp_worklist_name.arr);
      nd_worklist_no = rp_worklist_no;
      strcpy(nd_worklist_date.arr,rp_worklist_date.arr);
      nd_worklist_date.len = strlen(rp_worklist_date.arr);
      get_worklist_specimen_range();
   }
   gen_file_name();
     
   get_worklist_marker();
     
   get_worklist_hdr();
  
   dclr_worklist_dtl_cur();
//   dclr_specimen_cur();
   dclr_worklist_prt_dtl_cur();
   
   get_header_dtls();
   dclr_qlty_tests_cur();

   do_report();

   //get_dept_printer();

   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL COMMIT WORK RELEASE;

   fclose(f1);
   return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at main() occured....\n");
   proc_exit();
}   

void get_worklist_specimen_range() 
{
   nd_fr_specimen_no.arr[0] = '\0';
   nd_fr_specimen_no.len = 0;
   nd_to_specimen_no.arr[0] = '\0';
   nd_to_specimen_no.len = 0;
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT MAX(SPECIMEN_NO),MIN(SPECIMEN_NO)
	        INTO :nd_to_specimen_no,:nd_fr_specimen_no
	        FROM RL_WORKLIST_DTL
            WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			AND SECTION_CODE = :nd_section_code
	        AND WORKLIST_NAME = :nd_worklist_name
	        AND WORKLIST_NO   = :nd_worklist_no 
            AND WORKLIST_DATE = 
  	                TRUNC(TO_DATE(:nd_worklist_date,'DD/MM/YYYY'));
   nd_fr_specimen_no.arr[nd_fr_specimen_no.len] = '\0';
   nd_to_specimen_no.arr[nd_to_specimen_no.len] = '\0';
   return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_worklist_specimen_range() occured....\n");
   proc_exit();
}

/* get the printer name */
void get_dept_printer()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   /**************COMMENTED ON 16.01.2008 SINCE IT IS NOT USED
   EXEC SQL SELECT  printer_name INTO :d_printer_name
            FROM    RL_SECTION_CODE
	    WHERE   SECTION_CODE = :nd_section_code;
		******************END COMMENTS**********************/

  d_printer_name.arr[d_printer_name.len] = '\0';

#ifdef DEBUG
   printf("d_printer_name = %s\n", d_printer_name.arr);
#endif

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_dept_printer() occured....\n");
   proc_exit();
}


/************get_legend_value*******************/
get_legend_value(int cou)
 {
     
   
	EXEC SQL EXECUTE
	BEGIN
	  SM_POPULATE_REPORT_LEGEND.FETCH_LEGEND (:nd_operating_facility_id,:language_id,'RLRRESWP.LEGEND_');
	END;
	END-EXEC;




 for (i=1; i<=cou; i++)
	{


	l_translated_value.arr[0]		= '\0';
	
	EXEC SQL EXECUTE
	BEGIN
               :l_translated_value :=    GET_LEGEND(LTRIM(RTRIM('RLRRESWP.LEGEND_'||LTRIM(RTRIM(TO_CHAR(:i,'009'))))));
	END;
	END-EXEC;
	
	l_translated_value.arr[l_translated_value.len] = '\0';

	//sp_message(ERR_MESG,l_translated_value.arr);

	strcpy(local_legend[i],l_translated_value.arr);

	

	}
	

 }
/****************End****************/
/**********PRINT SPACE*************/
print_space(int aa, int bb, int cc)
{
	if (cc ==1)
	{
  		for(i=1;i <= (aa - bb) ;i++)
		{
			fprintf(f1,"%s"," ");
		}	
	}
	else if (cc ==0)
	{
  		for(i= (aa - bb);i <= aa ;i++)
		{
			fprintf(f1,"%s","-");
		}	
	}
}
/***********end***************/

/* get the parameters from the SY_PROG_PARM table and */
/* delete the record after reading it.                 */
void get_params()
{
		rp_worklist_name.arr[0] = '\0';
		rp_worklist_name.len = 0;
		rp_worklist_date.arr[0] = '\0';
		rp_worklist_date.len = 0;
		rp_reprint.arr[0] = '\0';
		rp_reprint.len = 0;
		rp_assign_to.arr[0]	= '\0';
		rp_assign_to.len		= 0;

   /* read the parameter record */
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT 
           OPERATING_FACILITY_ID,
		   PARAM1,
		   PARAM2,
		   PARAM3,
		   PARAM4,
		   PARAM5,
		   PARAM6,
		   PARAM7,
		   PARAM8,
		   UPPER(PARAM9),
		   PARAM10,
		   PARAM11,
		   PARAM12,
		   PARAM13,
		   PARAM14
            INTO 
		:nd_operating_facility_id,
		:nd_section_code ,  
		:nd_worklist_name,  
		:nd_worklist_no  ,
		:nd_worklist_date,
		:nd_criteria_flag,
		:nd_fr_specimen_no,
		:nd_to_specimen_no,
		:nd_print_yn,
		:nd_user_id,
		:rp_worklist_name,     
		:rp_worklist_no,
		:rp_worklist_date,
		:rp_reprint,
		:rp_assign_to
            FROM SY_PROG_PARAM
	    WHERE   PGM_ID = 'RLRRESWP'
		    AND SESSION_ID = TO_NUMBER(:nd_session_id)
		    AND PGM_DATE = :nd_pgm_date;


  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';
  nd_section_code.arr[nd_section_code.len] 	  = '\0';
  nd_worklist_name.arr[nd_worklist_name.len]  = '\0';
  nd_worklist_date.arr[nd_worklist_date.len]  = '\0';
  nd_criteria_flag.arr[nd_criteria_flag.len]  = '\0';
  nd_fr_specimen_no.arr[nd_fr_specimen_no.len] 	= '\0';
  nd_to_specimen_no.arr[nd_to_specimen_no.len] 	= '\0';
  nd_print_yn.arr[nd_print_yn.len] 				= '\0';
  nd_user_id.arr[nd_user_id.len] 				= '\0';
  rp_worklist_name.arr[rp_worklist_name.len]	= '\0';     
  rp_worklist_date.arr[rp_worklist_date.len]	= '\0';
  rp_reprint.arr[rp_reprint.len]				= '\0';
  rp_assign_to.arr[rp_assign_to.len]			= '\0';


#ifdef DEBUG
   printf("**********Parameters from SY_PROG_PARAM *******************\n");
   printf(" nd_section_code = %s\n",nd_section_code.arr);
   printf(" nd_worklist_name = %s\n",nd_worklist_name.arr);
   printf(" nd_worklist_no = %d\n",nd_worklist_no);
   printf(" nd_worklist_date = %s\n",nd_worklist_date.arr);
   printf(" nd_criteria_flag = %s\n",nd_criteria_flag.arr);
   printf(" nd_fr_specimen_no = %s\n",nd_fr_specimen_no.arr);
   printf(" nd_to_specimen_no = %s\n",nd_to_specimen_no.arr);
   printf(" nd_print_yn = %s\n",nd_print_yn.arr);
   printf(" nd_user_id = %s\n",nd_user_id.arr);
   printf(" rp_worklist_name = %s\n",rp_worklist_name.arr);     
   printf(" rp_worklist_no = %d\n",rp_worklist_no);
   printf(" rp_worklist_date = %s\n",rp_worklist_date.arr);
   printf(" rp_reprint = %s\n",rp_reprint.arr);
   getchar();  
#endif

  /* delete the parameter record */
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL DELETE SY_PROG_PARAM
	   WHERE PGM_ID = 'RLRRESWP'
	         AND SESSION_ID = :nd_session_id
		 AND PGM_DATE = :nd_pgm_date;
  
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_params() occured....\n");
   proc_exit();
}

/*** To get the Previous result flag from section Control parameters ***/

void get_prvrslt_flag()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT  print_prev_results_yn INTO :d_prv_result_yn
            FROM    RL_SECTION_CTL
	    WHERE   SECTION_CODE = :nd_section_code
		AND OPERATING_FACILITY_ID = :nd_operating_facility_id;

  d_prv_result_yn.arr[d_prv_result_yn.len] = '\0';

#ifdef DEBUG
   printf("d_prv_result_yn = %s\n", d_prv_result_yn.arr);
#endif

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_prvrslt_flag() occured....\n");
   proc_exit();
}

/* get the header details */
void get_header_dtls()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT SUBSTR(acc_entity_name, 1, 60), 
   /*
   SUBSTR(LPAD(ACC_ENTITY_NAME_LONG,
		       TRUNC(15 + 0.5*LENGTH(ACC_ENTITY_NAME_LONG))),1,60),
   */
		   USER,
		   TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI')
	    INTO :d_acc_entity_name,
		 :d_user,
		 :d_sysdate
            FROM SY_ACC_ENTITY_LANG_VW
            WHERE ACC_ENTITY_ID = :nd_operating_facility_id
			AND   LANGUAGE_ID = :language_id;

  d_acc_entity_name.arr[d_acc_entity_name.len] = '\0';
  d_user.arr[d_user.len]                       = '\0';
  d_sysdate.arr[d_sysdate.len]                 = '\0';

#ifdef DEBUG
   printf("d_acc_entity_name = %s\n", d_acc_entity_name.arr);
   printf("d_user = %s\n", d_user.arr);
   printf("d_sysdate = %s\n", d_sysdate.arr);
#endif

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_header_dtls() occured....\n");
   proc_exit();
}
 

/* get the WORKLIST Header detail from RL_WORKLIST_FMT_HDR */
/* delete the record after reading it.                     */
void get_worklist_hdr()
{

   nd_field_type.arr[0] = '\0';
   nd_field_type.len 	= 0;
   nd_cup_number.arr[0] = '\0';
   nd_cup_number.len = 0 ;
   nd_cup_indr.arr[0] = '\0';
   nd_cup_indr.len = 0 ;
   nd_spec_no.arr[0] = '\0';
   nd_spec_no.len = 0 ;
   nd_wl_marker.arr[0] = '\0';
   nd_wl_marker.len = 0 ;
   nd_pat_id.arr[0] = '\0';
   nd_pat_id.len = 0 ;
   nd_pat_name.arr[0] = '\0';
   nd_pat_name.len = 0 ;
   nd_source.arr[0] = '\0';
   nd_source.len = 0 ;
   nd_consultant.arr[0] = '\0';
   nd_consultant.len = 0 ;
   nd_urgency.arr[0] = '\0';
   nd_urgency.len = 0 ;	
   nd_comm_1.arr[0] = '\0';
   nd_comm_1.len = 0 ;	
   nd_comm_2.arr[0] = '\0';
   nd_comm_2.len = 0 ;	
   nd_comm_3.arr[0] = '\0';
   nd_comm_3.len = 0 ;	
   nd_spec_date.arr[0] = '\0';
   nd_spec_date.len = 0 ;	

    for (i=0;i<21;i++)
    {
	   num[i] = 0;
	   cou[i] = 0;
	  
	   strcpy(word[i],"0");
    }

   /* read the parameter record */
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT NO_OF_CUPS,
		   LINE_SPACING,
		   CUP_INDICATOR_1,
		   CUP_INDICATOR_2,
		   CUP_INDICATOR_3,
		   CUP_INDICATOR_4,
		   CUP_INDICATOR_5, 
		 NVL(row_cup_number,0), NVL(col_cup_number,0),
		 NVL(l_cup_number,'0'), NVL(row_cup_indr,0), NVL(col_cup_indr,0),
		 NVL(l_cup_indr,'0'),NVL(row_wl_marker,0), NVL(col_wl_marker,0),
		 NVL(l_wl_marker,'0'), NVL(row_spec_no,0), NVL(col_spec_no,0),
		 NVL(l_spec_no,'0'),  NVL(row_patient_id,0), NVL(col_patient_id,0),
		 NVL(l_patient_id,'0'), NVL(row_pat_name,0), NVL(col_pat_name,0),
		 NVL(l_pat_name,'0'),NVL(row_age,0), NVL(col_age,0), NVL(l_age,'0'),
		 NVL(row_dob,0), NVL(col_dob,0), NVL(l_dob,'0'), NVL(row_sex,0), NVL(col_sex,0),
		 NVL(l_sex,'0'), NVL(row_source,0), NVL(col_source,0), NVL(l_source,'0'),
		 NVL(row_consultant,0), NVL(col_consultant,0), NVL(l_consultant,'0'),
		 NVL(row_urgency,0), NVL(col_urgency,0), NVL(l_urgency,'0'),
		 NVL(row_comm_1,0), NVL(col_comm_1,0),NVL(l_comm_1,'0'), NVL(row_comm_2,0),
		 NVL(col_comm_2,0), NVL(l_comm_2,0), NVL(row_comm_3,0), NVL(col_comm_3,0),
 	     NVL(l_comm_3,'0'), NVL(row_spec_date,0), NVL(col_spec_date,0),
  	     NVL(l_spec_date,'0'), NVL(field_type, 'A'),
		 NVL(row_assign_to, 0), NVL(col_assign_to, 0), NVL(l_assign_to, '0'),
		 NVL(row_ref_location, 0), NVL(col_ref_location, 0), NVL(l_ref_location, '0'),
		 NVL(row_category_no, 0), NVL(col_category_no, 0), NVL(l_category_no, '0'),
		 NVL(row_collect_date, 0), NVL(col_collect_date, 0), NVL(l_collect_date, '0'),
		 NVL(row_race, 0), NVL(col_race, 0), NVL(l_race, '0')
            INTO 
		:d_no_of_cups,
		:d_line_spacing,
		:d_cup_indicators_1,
		:d_cup_indicators_2,
		:d_cup_indicators_3,
		:d_cup_indicators_4,
		:d_cup_indicators_5,
 :num[0], :cou[0], :nd_cup_number,
 :num[1], :cou[1], :nd_cup_indr,
 :num[2], :cou[2], :nd_wl_marker,
 :num[3], :cou[3], :nd_spec_no,
 :num[4], :cou[4], :nd_pat_id,
 :num[5], :cou[5], :nd_pat_name,
 :num[6], :cou[6], :nd_age,
 :num[7], :cou[7], :nd_dob,
 :num[8], :cou[8], :nd_sex,
 :num[9], :cou[9], :nd_source,
 :num[10], :cou[10], :nd_consultant,
 :num[11], :cou[11], :nd_urgency,
 :num[12], :cou[12], :nd_comm_1,
 :num[13], :cou[13], :nd_comm_2,
 :num[14], :cou[14], :nd_comm_3,
 :num[15], :cou[15], :nd_spec_date, :nd_field_type,
 :num[16], :cou[16], :nd_assign_to,
 :num[17], :cou[17], :nd_ref_location,
 :num[18], :cou[18], :nd_category_no,
 :num[19], :cou[19], :nd_collect_date,
 :num[20], :cou[20], :nd_race
        FROM RL_WORKLIST_FMT_HDR
	    WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
		AND SECTION_CODE  = :nd_section_code 
	    AND WORKLIST_NAME = :nd_worklist_name;

  d_cup_indicators_1.arr[d_cup_indicators_1.len]		= '\0';
  d_cup_indicators_2.arr[d_cup_indicators_2.len]		= '\0';
  d_cup_indicators_3.arr[d_cup_indicators_3.len]		= '\0';
  d_cup_indicators_4.arr[d_cup_indicators_4.len]		= '\0';
  d_cup_indicators_5.arr[d_cup_indicators_5.len]		= '\0';

  strcpy(cup_indicator,d_cup_indicators_1.arr);
  strcat(cup_indicator,d_cup_indicators_2.arr);
  strcat(cup_indicator,d_cup_indicators_3.arr);
  strcat(cup_indicator,d_cup_indicators_4.arr);
  strcat(cup_indicator,d_cup_indicators_5.arr);

  /*strncpy(cup_indicator,d_cup_indicators_1.arr,d_cup_indicators_1.len);
  strncpy(cup_indicator+d_cup_indicators_2.len,d_cup_indicators_1.arr,d_cup_indicators_2.len);
  strncpy(cup_indicator+d_cup_indicators_2.len,d_cup_indicators_1.arr,d_cup_indicators_3.len);
  strncpy(cup_indicator+d_cup_indicators_2.len,d_cup_indicators_1.arr,d_cup_indicators_4.len);
  strncpy(cup_indicator+d_cup_indicators_2.len,d_cup_indicators_1.arr,d_cup_indicators_5.len); */

  nd_cup_number.arr[nd_cup_number.len] = '\0';
  nd_cup_indr.arr[nd_cup_indr.len]	   = '\0';
  nd_spec_no.arr[nd_spec_no.len]	   = '\0';
  nd_wl_marker.arr[nd_wl_marker.len]   = '\0';
  nd_pat_id.arr[nd_pat_id.len] = '\0';
  nd_pat_name.arr[nd_pat_name.len]     = '\0';
  nd_age.arr[nd_age.len]			   = '\0';
  nd_dob.arr[nd_dob.len]			   = '\0';
  nd_sex.arr[nd_sex.len]			   = '\0';
  nd_source.arr[nd_source.len]		   = '\0';
  nd_consultant.arr[nd_consultant.len] = '\0';
  nd_urgency.arr[nd_urgency.len]	   = '\0';
  nd_comm_1.arr[nd_comm_1.len]	       = '\0';
  nd_comm_2.arr[nd_comm_2.len]	       = '\0';
  nd_comm_3.arr[nd_comm_3.len]	       = '\0';
  nd_spec_date.arr[nd_spec_date.len]   	 = '\0';
  nd_field_type.arr[nd_field_type.len]	 = '\0';
  nd_assign_to.arr[nd_assign_to.len]	 = '\0';
  nd_ref_location.arr[nd_ref_location.len]	= '\0';
  nd_category_no.arr[nd_category_no.len]	= '\0';
  nd_collect_date.arr[nd_collect_date.len]	= '\0';
  nd_race.arr[nd_race.len]					= '\0';
  
  
#ifdef DEBUG
   printf("**********Parameters from SY_PROG_PARAM *******************\n");
   printf(" d_cup_indicators_1 = %s\n",d_cup_indicators_1.arr);
   printf(" d_cup_indicators_2 = %s\n",d_cup_indicators_2.arr);
   printf(" d_cup_indicators_3 = %s\n",d_cup_indicators_3.arr);
   printf(" d_cup_indicators_4 = %s\n",d_cup_indicators_4.arr);
   printf(" d_cup_indicators_5 = %s\n",d_cup_indicators_5.arr);
   printf(" cup_indicator = %s\n",cup_indicator);

#endif

   strcpy(word[0], nd_cup_number.arr);
   strcpy(word[1], nd_cup_indr.arr);
   strcpy(word[2], nd_wl_marker.arr);
   strcpy(word[3], nd_spec_no.arr);
   strcpy(word[4], nd_pat_id.arr);
   strcpy(word[5], nd_pat_name.arr);
   strcpy(word[6], nd_age.arr);
   strcpy(word[7], nd_dob.arr);
   strcpy(word[8], nd_sex.arr);
   strcpy(word[9], nd_source.arr);
   strcpy(word[10], nd_consultant.arr);
   strcpy(word[11], nd_urgency.arr);
   strcpy(word[12], nd_comm_1.arr);
   strcpy(word[13], nd_comm_2.arr);
   strcpy(word[14], nd_comm_3.arr);
   strcpy(word[15], nd_spec_date.arr);
   strcpy(word[16], nd_assign_to.arr);
   strcpy(word[17], nd_ref_location.arr);
   strcpy(word[18], nd_category_no.arr);
   strcpy(word[19], nd_collect_date.arr);
   strcpy(word[20], nd_race.arr);

   strcpy(str_word[0], "nd_cup_number");
   strcpy(str_word[1], "nd_cup_indr");
   strcpy(str_word[2], "nd_wl_marker");
   strcpy(str_word[3], "nd_spec_no");
   strcpy(str_word[4], "nd_pat_id");
   strcpy(str_word[5], "nd_pat_name");
   strcpy(str_word[6], "nd_age");
   strcpy(str_word[7], "nd_dob");
   strcpy(str_word[8], "nd_sex");
   strcpy(str_word[9], "nd_source");
   strcpy(str_word[10], "nd_consultant");
   strcpy(str_word[11], "nd_urgency");
   strcpy(str_word[12], "nd_comm_1");
   strcpy(str_word[13], "nd_comm_2");
   strcpy(str_word[14], "nd_comm_3");
   strcpy(str_word[15], "nd_spec_date");
   strcpy(str_word[16], "nd_assign_to");
   strcpy(str_word[17], "nd_ref_location");
   strcpy(str_word[18], "nd_category_no");
   strcpy(str_word[19], "nd_collect_date");
   strcpy(str_word[20], "nd_race");
  

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_worklist_hdr() occured....\n");
   proc_exit();
}
 
void dclr_request_detail_cur()
{
    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL DECLARE REQUEST_DETAIL CURSOR FOR
         SELECT TEST_CODE              
          FROM RL_REQUEST_DETAIL
          WHERE PATIENT_ID = :d_prt_patient_id
	      AND SPECIMEN_NO = :d_prt_specimen_no
		  AND OPERATING_FACILITY_ID = :nd_operating_facility_id
          ORDER BY TEST_CODE;
#ifdef DEBUG
    printf("leaving dclr_request_detail_cur()\n");
    fflush(stdout);
#endif
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at dclr_request_detail_cur() occured....\n");
   proc_exit();
}

void open_request_detail_cur()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL OPEN REQUEST_DETAIL;
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error while open_request_detail_cur occured...\n");
   proc_exit();
}

int fetch_request_detail_cur()
{
  d_req_dtl_test.arr[0]    = '\0';
  d_req_dtl_test.len       = 0;

  EXEC SQL WHENEVER SQLERROR GOTO err_exit;
  EXEC SQL FETCH REQUEST_DETAIL INTO :d_req_dtl_test;

#ifdef DEBUG
         printf("SQLCA code after fetch :%d\n", sqlca.sqlcode);
#endif

  if (NODATAFOUND)
    return 0;
  d_req_dtl_test.arr[d_req_dtl_test.len]		= '\0';
#ifdef DEBUG
   printf("********* Details from RL_REQUEST_DETAIL**************\n");
   printf(" d_req_dtl_test= %s\n", d_req_dtl_test.arr);
#endif

  return 1;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at fetch_request_detail_cur() occured....\n");
   proc_exit();
}

void close_request_detail_cur()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL CLOSE REQUEST_DETAIL;
   return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error while Close_request_detail_Cur() occured....\n");
   proc_exit();
}


/* function declares cursor RL_WORKLIST_FMT_DTL */
void dclr_worklist_dtl_cur()
{

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL DECLARE WORKLIST_DTL_CUR CURSOR FOR
         SELECT TEST_CODE,              
         	SEQ_NO,                        
	        TEST_INDICATOR             
           FROM RL_WORKLIST_FMT_DTL                        
          WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
		  AND SECTION_CODE  = :nd_section_code 
	      AND WORKLIST_NAME = :nd_worklist_name              
          ORDER BY SEQ_NO ;                                     

   /*  Done in Do Report   */
   /*EXEC SQL WHENEVER SQLERROR GOTO err_exit;
     EXEC SQL OPEN TRN_ITEMS_CUR; */

#ifdef DEBUG
    printf("leaving dclr_worklist_dtl_cur()\n");
    fflush(stdout);
#endif
 
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at dclr_worklist_dtl_cur() occured....\n");
   proc_exit();
}

/* function declares cursor RL_WORKLIST_DTL */
/* Used for Printing Worklist               */
void dclr_worklist_prt_dtl_cur()
{

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
	
    EXEC SQL DECLARE WORKLIST_PRT_DTL_CUR CURSOR FOR
         SELECT TO_CHAR(WORKLIST_CUP_NO),        
         	TO_CHAR(SPECIMEN_NO),                   
	        PATIENT_ID,              
		    WORKLIST_CUP_INDICATOR,
	    	TEST_1_YN,
	    	TEST_2_YN,
	    	TEST_3_YN,
	    	TEST_4_YN,
	    	TEST_5_YN,
	    	TEST_6_YN,
	    	TEST_7_YN,
	    	TEST_8_YN,
	    	TEST_9_YN,
	    	TEST_10_YN,
	    	TEST_11_YN,
	    	TEST_12_YN,
	   	    TEST_13_YN,
	    	TEST_14_YN,
	   	    TEST_15_YN,
	    	TEST_16_YN,
	    	TEST_17_YN,
	    	TEST_18_YN,
	    	TEST_19_YN,
	   	    TEST_20_YN,
	    	TEST_21_YN,
	    	TEST_22_YN,
	  	    TEST_23_YN,
	    	TEST_24_YN,
	    	TEST_25_YN,
			QLTY_CODE
          FROM RL_WORKLIST_DTL                        
          WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
		  AND SECTION_CODE  = :nd_section_code
	      AND WORKLIST_NAME = :nd_worklist_name
	      AND WORKLIST_NO   = :nd_worklist_no
          AND WORKLIST_DATE = 
  	      TRUNC(TO_DATE(:nd_worklist_date,'DD/MM/YYYY'))
          ORDER BY WORKLIST_CUP_NO;                             

	    /*AND SPECIMEN_NO IS NOT NULL*/

   /*  Done in Do Report   */
   /*EXEC SQL WHENEVER SQLERROR GOTO err_exit;
     EXEC SQL OPEN TRN_ITEMS_CUR; */

#ifdef DEBUG
    printf("leaving dclr_worklist_prt_dtl_cur()\n");
    fflush(stdout);
#endif
 
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at dclr_worklist_prt_dtl_cur() occured....\n");
   proc_exit();
}

void dclr_qlty_tests_cur()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL DECLARE QLTY_TESTS_CUR CURSOR FOR
         SELECT TEST_CODE              
         FROM   RL_TEST_QUALITY_MAST                        
         WHERE  OPERATING_FACILITY_ID = :nd_operating_facility_id
		 AND SECTION_CODE = :nd_section_code
	     AND qlty_code = :d_qlty_code;
		 
		 //AND  QLTY_CODE    = :nd_qc_code;

   #ifdef DEBUG
       printf("leaving dclr_qlty_tests_cur()\n");
       fflush(stdout);
   #endif
   return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at dclr_qlty_tests_cur() occured....\n");
   proc_exit();
}
      
/* function declares SPECIMEN_CUR  cursor on the RL_TEST_RESULT */
/* And RL_WORKLIST_FMT_HDR */
void dclr_specimen_cur()
{
    
	EXEC SQL WHENEVER SQLERROR GOTO err_exit;

	if (strcmp(nd_field_type.arr, "B") == 0)
	{
	    strcpy(sql_stmt, 
		   "SELECT A.SPECIMEN_NO,A.PATIENT_ID,A.TEST_CODE, \
			   A.NUMERIC_RESULT, A.numeric_prefix, A.RESULT_COMMENT_CODE1  \
	              FROM RL_TEST_RESULT A \
      	       WHERE A.SPECIMEN_NO BETWEEN NVL(:nd_fr_specimen_no,0) \
                                     AND NVL(:nd_to_specimen_no, 999999999999999) \
            	   AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id \
				   AND 0 < ( \
	           SELECT NVL(COUNT(*),0) FROM RL_TEST_RESULT B \
		       WHERE B.PATIENT_ID=A.PATIENT_ID AND B.SPECIMEN_NO=A.SPECIMEN_NO \
	      	   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND B.TEST_CODE IN ( \
					  SELECT TEST_CODE FROM RL_WORKLIST_FMT_DTL \
					   WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id \
					   AND SECTION_CODE=:nd_section_code \
					     AND WORKLIST_NAME=:nd_worklist_name \
                                 ) \
      	        AND NVL(B.STATUS,'O') IN ('O','H') \
			       ) "); 
	}
	else if (strcmp(nd_field_type.arr, "N") == 0)
	{
	    strcpy(sql_stmt, 
		   "SELECT A.SPECIMEN_NO,A.PATIENT_ID,A.TEST_CODE, \
			   A.NUMERIC_RESULT,A.numeric_prefix, A.RESULT_COMMENT_CODE1  \
	              FROM RL_TEST_RESULT A, RL_REQUEST_HEADER B \
      	       WHERE A.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND A.SPECIMEN_NO BETWEEN NVL(:nd_fr_specimen_no,0) \
                                     AND NVL(:nd_to_specimen_no, 999999999999999) \
			   AND A.SPECIMEN_NO = B.SPECIMEN_NO \
			   AND B.SPECIMEN_NO BETWEEN NVL(:nd_fr_specimen_no,0) \
                                     AND NVL(:nd_to_specimen_no, 999999999999999) \
			   AND B.ASSIGN_TO IS NULL \
            	   AND 0 < ( \
	           SELECT NVL(COUNT(*),0) FROM RL_TEST_RESULT B \
		       WHERE B.PATIENT_ID=A.PATIENT_ID AND B.SPECIMEN_NO=A.SPECIMEN_NO \
	      	   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND B.TEST_CODE IN ( \
					  SELECT TEST_CODE FROM RL_WORKLIST_FMT_DTL \
					   WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id \
					   AND SECTION_CODE=:nd_section_code \
					     AND WORKLIST_NAME=:nd_worklist_name \
                                 ) \
      	        AND NVL(B.STATUS,'O') IN ('O','H') \
			       ) "); 

	}
	else if (strcmp(nd_field_type.arr, "A") == 0)
	{
	  
//sprintf(string_var, "%s   %s  %s   %s  %s", nd_fr_specimen_no.arr, nd_to_specimen_no.arr,
///					nd_assign_to.arr, nd_section_code.arr, nd_worklist_name.arr);
//disp_message(ERR_MESG, string_var);


	    strcpy(sql_stmt, 
		   "SELECT A.SPECIMEN_NO,A.PATIENT_ID,A.TEST_CODE, \
			   A.NUMERIC_RESULT,A.numeric_prefix, A.RESULT_COMMENT_CODE1  \
	              FROM RL_TEST_RESULT A, RL_REQUEST_HEADER B \
      	       WHERE A.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND A.SPECIMEN_NO BETWEEN NVL(:nd_fr_specimen_no,0) \
                                     AND NVL(:nd_to_specimen_no, 999999999999999) \
			   AND A.SPECIMEN_NO = B.SPECIMEN_NO \
			   AND B.SPECIMEN_NO BETWEEN NVL(:nd_fr_specimen_no,0) \
                                     AND NVL(:nd_to_specimen_no, 999999999999999) \
			   AND B.ASSIGN_TO = :rp_assign_to \
            	   AND 0 < ( \
	           SELECT NVL(COUNT(*),0) FROM RL_TEST_RESULT B \
		       WHERE B.PATIENT_ID=A.PATIENT_ID AND B.SPECIMEN_NO=A.SPECIMEN_NO \
	      	   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id \
			   AND B.TEST_CODE IN ( \
					  SELECT TEST_CODE FROM RL_WORKLIST_FMT_DTL \
					   WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id \
					   AND SECTION_CODE=:nd_section_code \
					     AND WORKLIST_NAME=:nd_worklist_name \
                                 ) \
      	        AND NVL(B.STATUS,'O') IN ('O','H') \
			       ) "); 

	}

    strcat(sql_stmt, " ORDER BY A.SPECIMEN_NO ");


    EXEC SQL PREPARE S FROM :sql_stmt;


    EXEC SQL DECLARE SPECIMEN_CUR CURSOR FOR S;

    if (strcmp(nd_field_type.arr, "B") == 0)
    {
	   EXEC SQL OPEN SPECIMEN_CUR USING :nd_fr_specimen_no,  
                                     :nd_to_specimen_no,  
                                     :nd_operating_facility_id,
									 :nd_operating_facility_id,
									 :nd_operating_facility_id,
									 :nd_section_code,  
                                     :nd_worklist_name;  
    }
    else if (strcmp(nd_field_type.arr, "A") == 0)

    { 
	    EXEC SQL OPEN SPECIMEN_CUR USING :nd_operating_facility_id,
		                             :nd_operating_facility_id,
		                             :nd_fr_specimen_no,  
                                     :nd_to_specimen_no,  
									 :nd_fr_specimen_no,  
                                     :nd_to_specimen_no,  
						             :rp_assign_to,
                                     :nd_operating_facility_id,
									 :nd_operating_facility_id,
									 :nd_section_code,  
                                     :nd_worklist_name;  

    }

    else if (strcmp(nd_field_type.arr, "N") == 0)

    { 
	    EXEC SQL OPEN SPECIMEN_CUR USING :nd_operating_facility_id,
		                             :nd_operating_facility_id,
		                             :nd_fr_specimen_no,  
                                     :nd_to_specimen_no,  
									 :nd_fr_specimen_no,  
                                     :nd_to_specimen_no,  
						             :nd_operating_facility_id,
									 :nd_operating_facility_id,
									 :nd_section_code,  
                                     :nd_worklist_name;  

    }
   /*  Done in Do Report   */
   /*EXEC SQL WHENEVER SQLERROR GOTO err_exit;
     EXEC SQL OPEN SPECIMEN_CUR; */

#ifdef DEBUG
    printf("leaving dclr_specimen_cur()\n");
    fflush(stdout);
#endif
 
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at dclr_specimen_cur() occured....\n");
   proc_exit();
}


/* prints the master-detail record until the cursor is empty */
void do_report()
{
  int fetch_specimen_cur();
  int fetch_worklist_dtl_cur();
  int fetch_qlty_tests_cur();
  int still_wrk_test_left;
  int still_specimen_left;
  int still_qc_left;
  int still_qlty_tests_left =0;
  int rec_no;
  int broken = 0;

       print_worklist();

}

/* function to check if all the mandatory tests exist in the specimen */
void check_mandatory_tests_exist()
{
  int w = 0;
  for(w=0;w<d_no_of_tests;w++)
  {
     if(worklist_ind[w][0] == 'M')
        if(mandatory_ind[w] != 'M')
	   mandatory_tests_exist = 0;
  } 
}
void check_if_any_test_pending()
{
  EXEC SQL WHENEVER SQLERROR GOTO err_exit;
  pending_tests = 0;
  EXEC SQL SELECT NVL(COUNT(*),0) INTO :pending_tests
	     FROM RL_TEST_RESULT
	    WHERE PATIENT_ID  = :d_patient_id    
	      AND SPECIMEN_NO = :d_specimen_no
	      AND OPERATING_FACILITY_ID = :nd_operating_facility_id
		  AND TEST_CODE IN (SELECT TEST_CODE
				  FROM RL_WORKLIST_FMT_DTL
				 WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND SECTION_CODE = :nd_section_code
				   AND WORKLIST_NAME = :nd_worklist_name
                               )
              AND NVL(STATUS,'O') IN('O','H');
#ifdef DEBUG
  printf("p_id = %s sp_no = %s pending_tests = [%d] \n",
	 d_patient_id.arr,d_specimen_no.arr,pending_tests);getchar();
  return;
#endif
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at check_if_any_test_pending()...\n");
   proc_exit();
}
	 
/* function to print the worklist */
print_worklist()
{  
     int still_prt_specimen_left;
     void open_wrklst_prt_dtl_cur();
     void print_master_rec(FILE *);
     void print_col_heading(FILE *); 
     int fetch_specimen_prt_cur();
     void prepare_new_page(FILE *);
     void print_footer_rec(FILE *);
     void end_report(FILE *);                   
     void print_detl_rec();
	 void get_request_comment1();
	 void get_request_comment2();
	 void get_request_comment3();
	 void spacing(FILE *);
	 

     line_no = 0;
     if (rec_inserted == 0 || strcmp(rp_reprint.arr,"REPRINT")==0)
     {
       page_no +=1;
       no_of_tests = 0;
       if(strcmp(rp_reprint.arr,"REPRINT") == 0)
       {
             strcpy(nd_worklist_name.arr,rp_worklist_name.arr);
	     nd_worklist_name.len = strlen(rp_worklist_name.arr);
	     nd_worklist_no = rp_worklist_no;
	     strcpy(nd_worklist_date.arr,rp_worklist_date.arr);
	     nd_worklist_date.len = strlen(rp_worklist_date.arr);
       }
       open_wrklst_prt_dtl_cur();
       
       tests_on_page = 16;
       
       tests_on_page = 25;

		header_printed = 0;
		print_title();

		if (header_printed == 0)
		{
			prepare_heading(f1);
			header_printed++;
		}


        /*** newly added for kndv enhancements to get the maxmimum line no for header ***/
	    sorting();

		for (i=0;i<21;i++)
		{

			if (num[i] > 0)
				largest_row = num[i];
			else
				break;
	    }	  
       /*** upto here newly added for kndv enhancements to get the maxmimum line no for header ***/

		cup_type = '\0';

        still_prt_specimen_left = fetch_specimen_prt_cur();

        /* process until first level break group arises */
        while(still_prt_specimen_left) 
        {

         /***** newly added for KNDV EHNAHCEMENTS *****/
		 if (strcmp(d_print_cup_indicator.arr, "P") ==0)
		 {
			chk_break(largest_row);		
            
			/*****************
			if (header_printed == 0)
			{
				prepare_heading(f1);
				header_printed++;
			}
            ******************/

		    //	fprintf(f1, "\n");
		    //	line_no++;

			if (cup_type == 'Q')
			{
		 		fprint_repeat(f1, '_', 79);
				fprintf(f1, "\n");
				line_no++;
			}

			print_detl_rec();

			cup_type = 'P';
		 }
		 else
		 {
			if (cup_type == 'P')
			{
		 		fprint_repeat(f1, '_', 79);
				fprintf(f1, "\n");
				line_no++;
			}

			chk_break(4);
			print_quality_hdr();
			cup_type = 'Q';
		  }

          
          line_no += d_line_spacing;
		
 		  spacing(f1);

          still_prt_specimen_left = fetch_specimen_prt_cur();
       }

	}
	
}

/*This Procedure to open Quality Tests Cursor */
void open_qlty_tests_cur()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL OPEN QLTY_TESTS_CUR;
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error while Opening qlty tests cur occured...\n");
   proc_exit();
}


/*This Procedure to open Worklist Cursor */
void open_wrklst_dtl_cursor()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL OPEN WORKLIST_DTL_CUR;
   EXEC SQL SELECT NVL(COUNT(*),0) INTO :d_no_of_tests
	      FROM RL_WORKLIST_FMT_DTL
             WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			 AND WORKLIST_NAME = :nd_worklist_name
			 AND SECTION_CODE = :nd_section_code ;

  
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error while Opening work list dtl cur occured...\n");
   proc_exit();
}


/*This Procedure to open Specimen Cursor */ 
void open_specimen_cursor()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL OPEN SPECIMEN_CUR;

  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"oracle error while Opening Specimen Cur() occured....\n");
   proc_exit();
}

/*This Procedure to open Worklist Detail Printing Cursor */
void open_wrklst_prt_dtl_cur()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL OPEN WORKLIST_PRT_DTL_CUR;

  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error while Opening Wrklst prt dtl Cur() occured....\n");
   proc_exit();
}

/*This Procedure to Qlty Tests Cursor */
void close_qlty_tests_cur()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL CLOSE QLTY_TESTS_CUR;
   return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error while Close Qlty Tests Cur() occured....\n");
   proc_exit();
}

/* prepares for the new page */
void prepare_new_page(afp)
FILE *afp;
{
   fprintf(afp,"");
   line_no = 0;
}


/* fetches the next record from CUR  */
/* returns 0 if the end of cursor is reached */
/* else returns 1.                           */
int fetch_worklist_dtl_cur()
{

  d_worklist_test_code.arr[0]                                   = '\0';
  d_test_indicator.arr[0]                                       = '\0';
 
  d_worklist_test_code.len                                      = 0;
  d_test_indicator.len                                          = 0;

  EXEC SQL WHENEVER SQLERROR GOTO err_exit;
  EXEC SQL FETCH WORKLIST_DTL_CUR INTO
		:d_worklist_test_code,  
		:d_seq_no ,             
		:d_test_indicator;

#ifdef DEBUG
         printf("SQLCA code after fetch :%d\n", sqlca.sqlcode);
#endif


  if (NODATAFOUND)
    return 0;


  d_worklist_test_code.arr[d_worklist_test_code .len]		= '\0';
  d_test_indicator.arr[d_test_indicator.len]			= '\0';


#ifdef DEBUG
   printf("********* Details from RL_WORKLIST_FMT_DTL**************\n");
   printf(" d_worklist_test_code= %s\n", d_worklist_test_code.arr);
   printf(" d_test_indicator= %s\n", d_test_indicator.arr);
#endif

  return 1;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG, "Oracle error at fetch_wrklst_dtl_cur() occured....\n");
   proc_exit();

}

/* Function to fetch data from QLTY_TEST_CUR  */
int fetch_qlty_tests_cur()
{
  d_qlty_test.arr[0]                         = '\0';
  d_qlty_test.len                            = 0;

  EXEC SQL WHENEVER SQLERROR GOTO err_exit;
  EXEC SQL FETCH QLTY_TESTS_CUR INTO
		:d_qlty_test;


  if (NODATAFOUND)
    return 0;

  d_qlty_test.arr[d_qlty_test .len]	 		= '\0';

  return 1;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at fetch_qlty_test_cur() occured....\n");
   proc_exit();

}

/* fetches the next record from CUR  */
/* returns 0 if the end of cursor is reached */
/* else returns 1.                           */
int fetch_specimen_prt_cur()
{

 
  d_prt_cup_no.arr[0]				    = '\0';
  d_prt_cup_no.len						= 0;

  d_prt_specimen_no.arr[0]		 		= '\0';
  d_prt_patient_id.arr[0]		 		= '\0';

  d_prt_specimen_no.len		 			= 0;
  d_prt_patient_id.len                		    	= 0;

  EXEC SQL WHENEVER SQLERROR GOTO err_exit;
  /*
    EXEC SQL FETCH WORKLIST_PRT_DTL_CUR INTO
	 	:d_prt_cup_no,       
		:d_prt_specimen_no,  
		:d_prt_patient_id,
		:d_print_cup_indicator,
		:d_prt_test_1_yn,
		:d_prt_test_2_yn,
		:d_prt_test_3_yn,
		:d_prt_test_4_yn,
		:d_prt_test_5_yn,
		:d_prt_test_6_yn,
		:d_prt_test_7_yn,
		:d_prt_test_8_yn,
		:d_prt_test_9_yn,
		:d_prt_test_10_yn,
		:d_prt_test_11_yn,
		:d_prt_test_12_yn,
		:d_prt_test_13_yn,
		:d_prt_test_14_yn,
		:d_prt_test_15_yn,
		:d_prt_test_16_yn,
		:d_prt_test_17_yn,
		:d_prt_test_18_yn,
		:d_prt_test_19_yn,
		:d_prt_test_20_yn,
		:d_prt_test_21_yn,
		:d_prt_test_22_yn,
		:d_prt_test_23_yn,
		:d_prt_test_24_yn,
		:d_prt_test_25_yn;
	*/

    EXEC SQL FETCH WORKLIST_PRT_DTL_CUR INTO
	 	:d_prt_cup_no,       
		:d_prt_specimen_no,  
		:d_prt_patient_id,
		:d_print_cup_indicator,
		:d_prt_test_1_yn,
		:d_prt_test_2_yn,
		:d_prt_test_3_yn,
		:d_prt_test_4_yn,
		:d_prt_test_5_yn,
		:d_prt_test_6_yn,
		:d_prt_test_7_yn,
		:d_prt_test_8_yn,
		:d_prt_test_9_yn,
		:d_prt_test_10_yn,
		:d_prt_test_11_yn,
		:d_prt_test_12_yn,
		:d_prt_test_13_yn,
		:d_prt_test_14_yn,
		:d_prt_test_15_yn,
		:d_prt_test_16_yn,
		:d_prt_test_17_yn,
		:d_prt_test_18_yn,
		:d_prt_test_19_yn,
		:d_prt_test_20_yn,
		:d_prt_test_21_yn,
		:d_prt_test_22_yn,
		:d_prt_test_23_yn,
		:d_prt_test_24_yn,
		:d_prt_test_25_yn,
		:d_qlty_code;

	   
#ifdef DEBUG
         printf("SQLCA code after fetch :%d\n", sqlca.sqlcode);
#endif


  if (NODATAFOUND)
    return 0;


  d_prt_specimen_no.arr[d_prt_specimen_no.len]			= '\0';
  d_prt_patient_id.arr[d_prt_patient_id.len]			= '\0';
  d_print_cup_indicator.arr[d_print_cup_indicator.len]          = '\0';
  d_prt_cup_no.arr[d_prt_cup_no.len]					= '\0';


  strcpy(d_pat_mark.arr,"");
  if(d_print_cup_indicator.arr[0] == 'P')
     get_patient_marker();

#ifdef DEBUG 
   printf("********* Details from RL_WORKLIST_DTL******************\n");
   printf(" d_prt_cup_no        = %d\n",d_prt_cup_no);
   printf(" d_prt_specimen_no   = <%s>\n",d_prt_specimen_no.arr);
   printf(" d_prt_patient_id    = %s\n",d_prt_patient_id.arr);
   printf(" d_prt_test_1_yn     = %c\n",d_prt_test_1_yn);
   printf(" d_prt_test_2_yn     = %c\n",d_prt_test_2_yn);
   printf(" d_prt_test_3_yn     = %c\n",d_prt_test_3_yn);
   printf(" d_prt_test_4_yn     = %c\n",d_prt_test_4_yn);
   printf(" d_prt_test_5_yn     = %c\n",d_prt_test_5_yn);
   printf(" d_prt_test_6_yn     = %c\n",d_prt_test_6_yn);
   printf(" d_prt_test_7_yn     = %c\n",d_prt_test_7_yn);
   printf(" d_prt_test_8_yn     = %c\n",d_prt_test_8_yn);
   printf(" d_prt_test_9_yn     = %c\n",d_prt_test_9_yn);
   printf(" d_prt_test_10_yn     = %c\n",d_prt_test_10_yn);
   printf(" d_prt_test_11_yn     = %c\n",d_prt_test_11_yn);
   printf(" d_prt_test_12_yn     = %c\n",d_prt_test_12_yn);
   printf(" d_prt_test_13_yn     = %c\n",d_prt_test_13_yn);
   printf(" d_prt_test_14_yn     = %c\n",d_prt_test_14_yn);
   printf(" d_prt_test_15_yn     = %c\n",d_prt_test_15_yn);
   printf(" d_prt_test_16_yn     = %c\n",d_prt_test_16_yn);
   printf(" d_prt_test_17_yn     = %c\n",d_prt_test_17_yn);
   printf(" d_prt_test_18_yn     = %c\n",d_prt_test_18_yn);
   printf(" d_prt_test_19_yn     = %c\n",d_prt_test_19_yn);
   printf(" d_prt_test_20_yn     = %c\n",d_prt_test_20_yn);
   printf(" d_prt_test_21_yn     = %c\n",d_prt_test_21_yn);
   printf(" d_prt_test_22_yn     = %c\n",d_prt_test_22_yn);
   printf(" d_prt_test_23_yn     = %c\n",d_prt_test_23_yn);
   printf(" d_prt_test_24_yn     = %c\n",d_prt_test_24_yn);
   printf(" d_prt_test_25_yn     = %c\n",d_prt_test_25_yn);
#endif

#ifdef DEBUG
   printf("********* Details from RL_WORKLIST_DTL******************\n");
   printf(" length of specimen  = %d\n",d_prt_specimen_no.len);
#endif

  return 1;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at fetch_prt_specimen_cur() occured....\n");
   proc_exit();

}



/* to initialize worklist array with some default value */
void initialize_worklist_array()
{
  int    i;

  for (i=0;i<25;i++)
  {
    strcpy(worklist_test[i], "     ");
    strcpy(worklist_ind[i]," ");
    chk_mand_test[i]=' ';
  }

}


/* to copy the worklist test indicators array to some dummy array     */
/* before checking whether all tests is there in specimen     */
void copy_dummy_array()                 
{
  int    i;

  for (i=0;i<d_no_of_tests;i++)
  {
    /*dummy_test_array[i]=chk_mand_test[i]; */
    mandatory_ind[i] = ' ';
    dummy_test_array[i]='N';
  }

}


/* to Check specimen test exist in worklist test */            
/* If it exist then updates intermediary array with 'Y' in the respective */
/* position    */
void check_test_exist()
{
  int    w;

  for (w=0;w<d_no_of_tests;w++)
  {


    if (strcmp(worklist_test[w], nd_chk_test_code.arr) == 0)
    {
      mandatory_ind[w] = 'M'; 
      test_exists_in_specimen = 1;
      dummy_test_array[w] = 'Y';
      break;
    }
  }



}



/* INSERT RL_WORKLIST_DTL */
void insert_worklist_data()    
{
  void update_worklist_fmt_hdr()    ;
  void insert_worklist_hdr()    ;
  cup_ind=cup_indicator[ic];
  if (rec_inserted == 1)
  {
     insert_worklist_hdr();
     update_worklist_fmt_hdr() ;
     rec_inserted=0;
  }
  cup_no++;
  
  EXEC SQL WHENEVER SQLERROR GO TO err_exit;
  EXEC SQL INSERT INTO RL_WORKLIST_DTL         
	   (OPERATING_FACILITY_ID,
	    SECTION_CODE,
	    WORKLIST_NAME,
	    WORKLIST_NO,
	    WORKLIST_DATE,           
	    WORKLIST_CUP_NO,
	    WORKLIST_CUP_INDICATOR,
	    PATIENT_ID,
	    SPECIMEN_NO,
	    TEST_1_YN,
	    TEST_2_YN,
	    TEST_3_YN,
	    TEST_4_YN,
	    TEST_5_YN,
	    TEST_6_YN,
	    TEST_7_YN,
	    TEST_8_YN,
	    TEST_9_YN,
	    TEST_10_YN,
	    TEST_11_YN,
	    TEST_12_YN,
	    TEST_13_YN,
	    TEST_14_YN,
	    TEST_15_YN,
	    TEST_16_YN,
	    TEST_17_YN,
	    TEST_18_YN,
	    TEST_19_YN,
	    TEST_20_YN,
	    TEST_21_YN,
	    TEST_22_YN,
	    TEST_23_YN,
	    TEST_24_YN,
	    TEST_25_YN) 
	   VALUES 
	   (:nd_operating_facility_id,
	    :nd_section_code,
	    :nd_worklist_name,
	    :nd_worklist_no,
	    TO_DATE(:nd_worklist_date,'DD/MM/YYYY'),
	    :cup_no,
	    :cup_ind,
	    :nd_ins_patient_id,
	    TO_NUMBER(:nd_ins_specimen_no),
	    substr(:dummy_test_array,1,1),
	    substr(:dummy_test_array,2,1),
	    substr(:dummy_test_array,3,1),
	    substr(:dummy_test_array,4,1),
        substr(:dummy_test_array,5,1),
	    substr(:dummy_test_array,6,1),
	    substr(:dummy_test_array,7,1),
	    substr(:dummy_test_array,8,1),
	    substr(:dummy_test_array,9,1),
	    substr(:dummy_test_array,10,1),
	    substr(:dummy_test_array,11,1),
	    substr(:dummy_test_array,12,1),
	    substr(:dummy_test_array,13,1),
	    substr(:dummy_test_array,14,1),
	    substr(:dummy_test_array,15,1),
	    substr(:dummy_test_array,16,1),
	    substr(:dummy_test_array,17,1),
	    substr(:dummy_test_array,18,1),
	    substr(:dummy_test_array,19,1),
	    substr(:dummy_test_array,20,1),
	    substr(:dummy_test_array,21,1),
	    substr(:dummy_test_array,22,1),
	    substr(:dummy_test_array,23,1),
	    substr(:dummy_test_array,24,1),
	    substr(:dummy_test_array,25,1)
	    ) ;

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at Insert Worklist Detail occured....\n");
   proc_exit();

}

/* INSERT RL_WORKLIST_HDR */
void insert_worklist_hdr()    
{
  EXEC SQL WHENEVER SQLERROR GO TO err_exit;
  EXEC SQL INSERT INTO RL_WORKLIST_HDR         
	   (OPERATING_FACILITY_ID,
	    WORKLIST_NAME,
	    WORKLIST_NO,
	    SECTION_CODE,   
	    WORKLIST_DATE,
		ASSIGN_TO,           
	    ADDED_BY_ID,
	    MODIFIED_BY_ID,
	    ADDED_DATE,
	    MODIFIED_DATE,
		ADDED_AT_WS_NO,
        ADDED_FACILITY_ID,
        MODIFIED_AT_WS_NO,
        MODIFIED_FACILITY_ID) 
	   VALUES 
	   (:nd_operating_facility_id,
	    :nd_worklist_name,
	    :nd_worklist_no,
	    :nd_section_code,
	    TO_DATE(:nd_worklist_date,'DD/MM/YYYY'),
		:rp_assign_to,
	    user,
	    user,
	    SYSDATE,
	    SYSDATE,
		sys_context('USERENV','IP_ADDRESS'),
		:nd_operating_facility_id,
		sys_context('USERENV','IP_ADDRESS'),
		:nd_operating_facility_id
	    ) ;
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at Insert Worlist HDR occured....\n");
   proc_exit();
}


update_last_spec_no()
{
 
  EXEC SQL SELECT rowid INTO :rowid_wrk  
           FROM RL_WORKLIST_FMT_HDR                 
	       WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
	       AND WORKLIST_NAME  = :nd_worklist_name
	       AND SECTION_CODE   = :nd_section_code
           FOR UPDATE OF LAST_NUMBER_USED NOWAIT;

    EXEC SQL UPDATE RL_WORKLIST_FMT_HDR         
	 	     SET LAST_SPECIMEN_NO = TO_NUMBER(:nd_specimen_no)
             WHERE rowid = :rowid_wrk;

}


/* UPDATE RL_WORKLIST_FMT_HDR */
void update_worklist_fmt_hdr()    
{
 
  EXEC SQL SELECT rowid INTO :rowid_wrk  
           FROM RL_WORKLIST_FMT_HDR                 
	   WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
	   AND WORKLIST_NAME        = :nd_worklist_name        
	   AND SECTION_CODE         = :nd_section_code 
           FOR UPDATE OF LAST_NUMBER_USED NOWAIT;

  EXEC SQL WHENEVER SQLERROR GO TO err_exit;
  EXEC SQL UPDATE RL_WORKLIST_FMT_HDR         
	   SET LAST_NUMBER_USED = :nd_worklist_no,
		   LAST_SPECIMEN_NO = TO_NUMBER(:nd_specimen_no),
	       MODIFIED_BY_ID   = user,
	       MODIFIED_DATE    = SYSDATE 
           WHERE rowid = :rowid_wrk;

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at UPDATE Worlist FMT HDR occured....\n");
   proc_exit();

}

/* print the master record */
void print_master_rec(afp)
FILE *afp;
{
  int get_col_length(int col_no);
  int    i;
  int    j;
  char l_str[2];
  fprintf(afp,"\n");
  //fprintf(afp,"%-10s WORKLIST",nd_worklist_name.arr);
  fprintf(afp,".%-10s %-8.8s",nd_worklist_name.arr,local_legend[2]);
  fprintf(afp,"\n");
  //fprintf(afp,"WORKLIST NUMBER : %-5d   ", nd_worklist_no);
  fprintf(afp,"%-15.15s : %-5d   ", local_legend[3],nd_worklist_no);
  //fprintf(afp,"DATE : %-10s        ", nd_worklist_date.arr);
	fprintf(afp,"%-4.4s : %-10s        ",local_legend[4], nd_worklist_date.arr);
  d_added_date.arr[0]		= '\0';
  d_added_date.len			= 0;
  d_added_time.arr[0]		= '\0';
  d_added_time.len			= 0;
  d_added_by_id.arr[0]		= '\0';
  d_added_by_id.len			= 0;
  d_curr_date.arr[0]		= '\0';
  d_curr_date.len			= 0;
  d_curr_time.arr[0]		= '\0';
  d_curr_time.len			= 0;

  EXEC SQL WHENEVER SQLERROR GO TO err_exit;
  /*******
  EXEC SQL SELECT ADDED_BY_ID, TO_CHAR(added_date, 'DD/MM/YYYY'),
				TO_CHAR(added_time, 'HH24:MI'), TO_CHAR(SYSDATE, 'DD/MM/YYYY'), 
				TO_CHAR(SYSDATE, 'HH24:MI')
		   INTO :d_added_by_id, :d_added_date, :d_added_time,
				:d_curr_date, :d_curr_time	
	       FROM RL_WORKLIST_HDR
           WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
		   AND SECTION_CODE  = :nd_section_code 
	       AND WORKLIST_NAME = :nd_worklist_name
	       AND WORKLIST_NO   = :nd_worklist_no
	       AND TRUNC(WORKLIST_DATE) = TO_DATE(:nd_worklist_date,'DD/MM/YYYY');
*********/
  d_added_by_id.arr[d_added_by_id.len]  = '\0';
  d_added_date.arr[d_added_date.len]	= '\0';
  d_added_time.arr[d_added_time.len]	= '\0';
  d_curr_date.arr[d_curr_date.len]		= '\0';
  d_curr_time.arr[d_curr_time.len]		= '\0';

  //fprintf(afp,"CREATED BY : %-20s ", d_added_by_id.arr);
  fprintf(afp,"%-10.10s : %-20s ", local_legend[5],d_added_by_id.arr);

  if(strcmp(rp_reprint.arr,"REPRINT") == 0)
     //fprintf(afp,"REPRINTED ON : %-10s",d_sysdate.arr);
	 fprintf(afp,"%-12.12s : %-10s",local_legend[6],d_sysdate.arr);

  else
     //fprintf(afp,"  PRINTED ON : %-10s",d_sysdate.arr);
     fprintf(afp,"  %-10.10s : %-10s",local_legend[7],d_sysdate.arr);
  fprintf(afp," ");
  fprintf(afp,"%-4.4s : %4d",local_legend[1], page_no);               
  fprintf(afp,"\n\n");
  line_no += 12;
  i = no_of_tests;

sorting();
j = 21;
while(j >= 0)
{
	
	if (num[j] == 1)
	{
	    tests = 0;
		tests = cou[j];
		tot_tests = get_col_length(j);
		tests = tests + tot_tests + 1;
		break;
	
	}

	j--;

}



  for (j=0;j<10;j++)
  {
	
    fprintf(afp, "%*.*s", tests, tests, "");

    for (no_of_tests = i ; no_of_tests < tests_on_page ; no_of_tests++)
    {
      sprintf(l_str,"%c",worklist_test[no_of_tests][j]);
      fprintf(afp,"%1s     ",l_str);
    }
    fprintf(afp,"\n");

  }

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at print_master_rec() occured....\n");
   proc_exit();
}

/******** GETTING COLUMN LENGTH   ********/
int get_col_length(col_no)
int col_no ;
{

 int str_len = 0;
 
 if (strcmp(str_word[col_no],"nd_cup_number") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 3)
   	   return str_len;
	else 
	   return 3 ;
 }
 else if (strcmp(str_word[col_no],"nd_cup_indr") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 1)
   	   return str_len;
	else 
	   return 1 ;
 }
 else if (strcmp(str_word[col_no],"nd_wl_marker") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 1)
   	   return str_len;
	else 
	   return 1 ;
 }
 
 else if (strcmp(str_word[col_no],"nd_spec_no") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 9)
   	   return str_len;
	else 
	   return 9 ;
 }
 else if (strcmp(str_word[col_no],"nd_pat_id") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 30)
   	   return str_len;
	else 
	   return 30 ;
 }
 else if (strcmp(str_word[col_no],"nd_pat_name") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 30)
   	   return str_len;
	else 
	   return 30 ;
 }
 else if (strcmp(str_word[col_no],"nd_age") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 9)
   	   return str_len;
	else 
	   return 9 ;
 }
 else if (strcmp(str_word[col_no],"nd_dob") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 10)
   	   return str_len;
	else 
	   return 10 ;
 }
 else if (strcmp(str_word[col_no],"nd_sex") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 1)
   	   return str_len;
	else 
	   return 1 ;
 }
 else if (strcmp(str_word[col_no],"nd_source") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 4)
   	   return str_len;
	else 
	   return 4 ;
 }
 else if (strcmp(str_word[col_no],"nd_consultant") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 6)
   	   return str_len;
	else 
	   return 6 ;
 }
 else if (strcmp(str_word[col_no],"nd_urgency") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 1)
   	   return str_len;
	else 
	   return 1 ;
 }
 else if (strcmp(str_word[col_no],"nd_comm_1") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 40)
   	   return str_len;
	else 
	   return 40 ;
 }
 else if (strcmp(str_word[col_no],"nd_comm_2") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 40)
   	   return str_len;
	else 
	   return 40 ;
 }
 else if (strcmp(str_word[col_no],"nd_comm_3") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 40)
   	   return str_len;
	else 
	   return 40 ;
 }
 else if (strcmp(str_word[col_no],"nd_spec_date") == 0)
 {
    str_len = strlen(word[col_no]);
    if (str_len > 19)
   	   return str_len;
	else 
	   return 19 ;
 }
 /***added **/
 else if (strcmp(str_word[col_no],"nd_assign_to") == 0)
  {
    str_len = strlen(word[col_no]);
    if (str_len > 20)
   	   return str_len;
	else 
	   return 20 ;
 }
 else if (strcmp(str_word[col_no],"nd_ref_location") == 0)
  {
    str_len = strlen(word[col_no]);
    if (str_len > 10)
   	   return str_len;
	else 
	   return 10 ;
 }
 else if (strcmp(str_word[col_no],"nd_collect_date") == 0)
  {
    str_len = strlen(word[col_no]);
    if (str_len > 19)
   	   return str_len;
	else 
	   return 19;
 }
 else if (strcmp(str_word[col_no],"nd_category_no") == 0)
  {
    str_len = strlen(word[col_no]);
    if (str_len > 20)
   	   return str_len;
	else 
	   return 20 ;
 }
 else if (strcmp(str_word[col_no],"nd_race") == 0)
  {
    str_len = strlen(word[col_no]);
    if (str_len > 4)
   	   return str_len;
	else 
	   return 4 ;
 }


}


/* to print the detailed record */
void print_detl_rec()
{ 
    void print_detl_line(FILE *);
	void print_detl(FILE *);
	void print_all_tests(FILE *);		
    int i;
    int j = 0;
    int  get_in_patient_dtl();
	void get_general_patient_dtl(),
	 get_referral_patient_dtl();



    d_source_code.arr[0]		 		= '\0';
    d_source_code.len		 			= 0;
	d_consultant_code.arr[0]				= '\0';
	d_consultant_code.len				= 0;
	d_urgent_indicator.arr[0]				= '\0';
	d_urgent_indicator.len				= 0;
	d_request_comment_code1.arr[0] 		= '\0';
	d_request_comment_code1.len			= 0;
	d_request_comment_code2.arr[0] 		= '\0';
	d_request_comment_code2.len			= 0;
	d_request_comment_code3.arr[0] 		= '\0';
	d_request_comment_code3.len			= 0;

    d_episode_type.arr[0]                               = '\0';
    d_episode_type.len                                  = 0;
    d_spec_regd_date_time.arr[0]                        = '\0';
    d_spec_regd_date_time.len                           = 0;
	d_l_spec_regd_date_time.arr[0]						= '\0'; /*Added by Durai Rajkumar for Age Calculation on 05-Feb-08 */
	d_l_spec_regd_date_time.len                         = 0;    /*Added by Durai Rajkumar for Age Calculation on 05-Feb-08 */
	d_assign_to.arr[0]					= '\0';
	d_assign_to.len						=  0;
	d_spec_colltd_date_time.arr[0]		= '\0';
	d_spec_colltd_date_time.len			= 0;
	d_category.arr[0]					= '\0';
	d_category.len						= 0;

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL SELECT SOURCE_CODE,
		    EPISODE_TYPE,
			CONSULTANT_CODE,
			URGENT_INDICATOR,
			REQUEST_COMMENT_CODE1,
			REQUEST_COMMENT_CODE2,
			REQUEST_COMMENT_CODE3,
			REQUEST_COMMENT_DESC1,
			REQUEST_COMMENT_DESC2,
			REQUEST_COMMENT_DESC3,
		    TO_CHAR(SPEC_REGD_DATE_TIME,'DD/MM/YYYY HH24:MI'),
			TO_CHAR(SPEC_COLLTD_DATE_TIME,'DD/MM/YYYY HH24:MI'),
			assign_to,
			category_code || '/' || category_year  || '/' || SUBSTR(category_number, 1, 8),
	        TO_CHAR(SPEC_REGD_DATE_TIME,'DD/MM/YYYY')
		   INTO :d_source_code,
		    :d_episode_type,
			:d_consultant_code,
			:d_urgent_indicator,
			:d_request_comment_code1,
			:d_request_comment_code2,
			:d_request_comment_code3,
 		    :d_request_comment_desc1,    
		    :d_request_comment_desc2,  
		    :d_request_comment_desc3,  
		    :d_spec_regd_date_time,
			:d_spec_colltd_date_time, 
			:d_assign_to,
			:d_category,
			:d_l_spec_regd_date_time
	      FROM RL_REQUEST_HEADER   
	      WHERE PATIENT_ID  = :d_prt_patient_id  
		  AND SPECIMEN_NO = :d_prt_specimen_no
		  AND OPERATING_FACILITY_ID = :nd_operating_facility_id;
    
    d_source_code.arr[d_source_code.len] 		= '\0';
    d_episode_type.arr[d_episode_type.len]              = '\0';
    d_spec_regd_date_time.arr[d_spec_regd_date_time.len]= '\0';
	d_l_spec_regd_date_time.arr[d_l_spec_regd_date_time.len] = '\0'; /*Added by Durai Rajkumar for Age Calculation on 05-Feb-08 */
/*	d_4_code.arr[d_consultant_code.len] = '\0'; */
	d_urgent_indicator.arr[d_urgent_indicator.len] ='\0';
	d_request_comment_code1.arr[d_request_comment_code1.len] = '\0';
	d_request_comment_code2.arr[d_request_comment_code2.len] = '\0';
	d_request_comment_code3.arr[d_request_comment_code3.len] = '\0';
/*ADDED FOR PRINTING REQUEST_COMMENT DESCRIPTION  25/06/2002   */
	d_request_comment_desc1.arr[d_request_comment_desc1.len] = '\0';
	d_request_comment_desc2.arr[d_request_comment_desc2.len] = '\0';
	d_request_comment_desc3.arr[d_request_comment_desc3.len] = '\0';

/*********** ADDED ON 28/07/2002 FOR KNDV ENHANCEMENTS *************/
	d_assign_to.arr[d_assign_to.len]							= '\0';
	d_category.arr[d_category.len]								= '\0';
	d_spec_colltd_date_time.arr[d_spec_colltd_date_time.len]	= '\0';

    d_short_name.arr[0]		 			= '\0';
    d_date_of_birth.arr[0]		 		= '\0';
    d_nation.arr[0]                                     = '\0';

    d_short_name.len		 			= 0;
    d_date_of_birth.len                		    	= 0;
    d_nation.len                                        = 0;

	/*get_request_comment1();
	get_request_comment2(); 
 	get_request_comment3(); 
*/

/** ACTUAL S.A VERSION  ****/
if(   strcmp(d_episode_type.arr,"I")==0 
	   || strcmp(d_episode_type.arr,"O")==0
	   || strcmp(d_episode_type.arr,"H")==0 )
    {
       i = get_in_patient_dtl();
       
    }
    else
       if(strcmp(d_episode_type.arr,"R")==0) 
         get_referral_patient_dtl();


    no_of_tests = 16;
    test_ctr=0;
    print_detl_line(f1);
    no_of_tests = 25;

    print_all_tests(f1);
	
	/* Added to Print the Specimen Tests */
	print_spec_tests();

return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at print_detl_rec() occured....\n");
   proc_exit();
}

void get_request_comment1()
{

 d_request_comment_desc1.arr[0] = '\0';
 d_request_comment_desc1.len = 0;
                                                                                                            
    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL SELECT request_comment
               INTO :d_request_comment_desc1
			   FROM RL_REQUEST_COMMENT_CODE
               WHERE section_code = :nd_section_code
			   AND request_comment_code = :d_request_comment_code1 ;
						

    d_request_comment_desc1.arr[d_request_comment_desc1.len] = '\0';

	
	return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_request_comment1() occured....\n");
   proc_exit();
}

void get_request_comment2()
{

 d_request_comment_desc2.arr[0] = '\0';
 d_request_comment_desc2.len = 0;

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL SELECT REQUEST_COMMENT
               INTO :d_request_comment_desc2
			FROM RL_REQUEST_COMMENT_CODE
			WHERE request_comment_code = 
                                :d_request_comment_code2
                         AND section_code =  :nd_section_code;

    d_request_comment_desc2.arr[d_request_comment_desc2.len] = '\0';

	return ;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_request_comment2() occured....\n");
   proc_exit();
}

void get_request_comment3()
{

 d_request_comment_desc3.arr[0] = '\0';
 d_request_comment_desc3.len = 0;

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL SELECT REQUEST_COMMENT
               INTO :d_request_comment_desc3
			FROM RL_REQUEST_COMMENT_CODE
			WHERE request_comment_code = 
                                :d_request_comment_code3
                         AND section_code =  :nd_section_code;

    d_request_comment_desc3.arr[d_request_comment_desc3.len] = '\0';

	return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_request_comment3() occured....\n");
   proc_exit();
}

int space_or_line(prt_yn,ind)
char prt_yn;
char ind;
{
    test_ctr++;
    if(prt_yn == 'Y')
       return 1;
    else
    {
       if(prt_yn == 'N') 
       {
    	  if(ind == 'O' || ind == 'M')
	     return 0;
          else
             return 1;
       }
    }
}

void print_detl_line(afp)
FILE *afp;
{
      
	print_dtl(afp);


}

/* Function to fetch the GENERAL PATIENT details */
void get_general_patient_dtl()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;

   /***********************commented on 16.01.2008 since it is not used
   EXEC SQL SELECT SUBSTR(SHORT_NAME,1,30),
		   TO_CHAR(DATE_OF_BIRTH,'DD/MM/YYYY'),
		   NATIONALITY_CODE,
		   SEX
	      INTO :d_short_name, 
		   :d_date_of_birth,
		   :d_nation,
		   :d_sex
              FROM MP_PATIENT_MAST_OTHERS 
	     WHERE PATIENT_ID = :d_prt_patient_id;
**************************end comments****************************/


  d_short_name.arr[d_short_name.len]     = '\0';
  d_date_of_birth.arr[d_date_of_birth.len]                       = '\0';
  d_nation.arr[d_nation.len]                 = '\0';
  d_sex.arr[d_sex.len] = '\0';

  
  patient_age();

  #ifdef DEBUG
   printf("d_short_name= %s\n", d_short_name.arr);
  #endif

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_general_patient_dtl() occured....\n");
   proc_exit();
}

/* Function to fetch the REFERRAL PATIENT details */
void get_referral_patient_dtl()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT SUBSTR(DECODE (:language_id, 'en',  SHORT_NAME,  NVL(SHORT_NAME_loc_lang, SHORT_NAME)) ,1,30), 
		   TO_CHAR(DATE_OF_BIRTH,'DD/MM/YYYY'),
		   NATIONALITY_CODE,
		   SEX, 
		   location,
		   race_code
	      INTO :d_short_name,
		   :d_date_of_birth,
		   :d_nation,
		   :d_sex,
		   :d_location,
		   :d_race_code
         FROM RL_PATIENT_MAST 
	     WHERE PATIENT_ID = :d_prt_patient_id;
		 /* AND OPERATING_FACILITY_ID = :nd_operating_facility_id; */

  d_short_name.arr[d_short_name.len]		 = '\0';
  d_date_of_birth.arr[d_date_of_birth.len]   = '\0';
  d_nation.arr[d_nation.len]                 = '\0';
  d_sex.arr[d_sex.len]						 = '\0';
  d_location.arr[d_location.len]			 = '\0';
  d_race_code.arr[d_race_code.len]			 = '\0';

    patient_age();

  #ifdef DEBUG
   printf("d_short_name= %s\n", d_short_name.arr);
  #endif

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_referral_patient_dtl() occured....\n");
   proc_exit();
}

/* Function to fetch the INPATIENT details */
int get_in_patient_dtl()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT SUBSTR(DECODE (:language_id, 'en',  SHORT_NAME,  NVL(SHORT_NAME_loc_lang, SHORT_NAME)) ,1,30),
		   TO_CHAR(DATE_OF_BIRTH,'DD/MM/YYYY'),
		   NATIONALITY_CODE,
		   SEX,
		   race_code
	      INTO :d_short_name,
		   :d_date_of_birth,
		   :d_nation,
		   :d_sex,
		   :d_race_code
              FROM MP_PATIENT_MAST 
	     WHERE PATIENT_ID = :d_prt_patient_id;

  if (NODATAFOUND)
    return 0;
  d_short_name.arr[d_short_name.len]     = '\0';
  d_date_of_birth.arr[d_date_of_birth.len]                       = '\0';
  d_nation.arr[d_nation.len]                 = '\0';
  d_sex.arr[d_sex.len]                 = '\0';
  d_race_code.arr[d_race_code.len]		   = '\0';

   patient_age();

  #ifdef DEBUG
   printf("d_short_name= %s\n", d_short_name.arr);
  #endif

  return 1;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_in_patient_dtl() occured....\n");
   proc_exit();
}


/* print the heading */
void print_col_heading(afp)
FILE *afp;
{
 prepare_heading(afp);

}



/* to print the last line of the report */
void print_footer_rec(afp)
FILE *afp;
{

  fprintf(afp, "--------------------------------------------");
  fprintf(afp, "------------------------------------");
  
  fprintf(afp,"\n\n");
  //fprintf(afp,"ENTERED BY : ________________________________________       ");
  fprintf(afp,"%-10.10s : ________________________________________       ",local_legend[8]);
  //fprintf(afp,"DATE : _________");
  fprintf(afp,"%-4.4s : _________",local_legend[4]);
  fprintf(afp,"\n");
  fprintf(afp, "--------------------------------------------");
  fprintf(afp, "------------------------------------");

}



/* to print the last line of the report */
void end_report(afp)
FILE *afp;
{
  fprintf(afp,"\n");
  fprintf(afp,"");
}

/* fetches the next record from CUR  */
/* returns 0 if the end of cursor is reached */
/* else returns 1.                           */
int fetch_specimen_cur()
{

  d_specimen_no.arr[0]		 		= '\0';
  d_patient_id.arr[0]		 		= '\0';
  d_req_test_code.arr[0] 			= '\0';
  d_test_result.arr[0] 				= '\0';
  d_num_result.arr[0] 				= '\0';
  d_comm_result.arr[0] 				= '\0';

  d_specimen_no.len		 		= 0;
  d_patient_id.len		 		= 0;
  d_req_test_code.len                           = 0;
  d_test_result.len 				= '\0';
  d_num_result.len 				= '\0';
  d_comm_result.len 				= '\0';
  d_num_prefix.arr[0]				= '\0';
  d_num_prefix.len					= 0;

  EXEC SQL WHENEVER SQLERROR GOTO err_exit;
  EXEC SQL FETCH SPECIMEN_CUR INTO
		:d_specimen_no,  
		:d_patient_id,
		:d_req_test_code,
		:d_num_result,
		:d_num_prefix,
		:d_comm_result;
   
#ifdef DEBUG
         printf("SQLCA code after fetch :%d\n", sqlca.sqlcode);
#endif


  if (NODATAFOUND)
    return 0;
  
  d_specimen_no.arr[d_specimen_no.len]		 		= '\0';
  d_patient_id.arr[d_patient_id.len]		 		= '\0';
  d_req_test_code.arr[d_req_test_code .len]	 		= '\0';
  d_num_result.arr[d_num_result .len]		 		= '\0';
  d_comm_result.arr[d_comm_result .len]		 		= '\0';
  d_num_prefix.arr[d_num_prefix.len]				= '\0';

  d_test_result.arr[0] = '\0';
  d_test_result.len = 0;

  if(strlen(d_num_result.arr))
  {
	 if (strlen(d_num_prefix.arr))
	 {
		strcpy(d_test_result.arr, d_num_prefix.arr);
		d_test_result.len = strlen(d_test_result.arr);
		strcat(d_test_result.arr,d_num_result.arr);
	 }
	 else
	 {
		strcpy(d_test_result.arr,d_num_result.arr);
	 }
  }
/* commented 30.09.2002 since result comments to be shown seperately
  else
     strcpy(d_test_result.arr,d_comm_result.arr);
*/
  d_test_result.len = strlen(d_test_result.arr);


/***** for updation of last specimen no *****/
	strcpy(nd_specimen_no.arr, d_specimen_no.arr);
	nd_specimen_no.len = strlen(nd_specimen_no.arr);

#ifdef DEBUG
   printf("********* Details from RL_TEST_RESULT ******************\n");
   printf(" d_specimen_no   = %s\n",d_specimen_no.arr);
   printf(" d_patient_id    = %s\n",d_patient_id.arr);
   printf(" d_req_test_code = %s\n", d_req_test_code.arr);
#endif

  return 1;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at fetch_specimen_cur() occured....\n");
   proc_exit();

}

gen_file_name() 
{
	 	 /* For a constant file name (4 lines) */
  	 strcpy(nd_file_name.arr,WORKING_DIR) ;
     nd_file_name.len = strlen(nd_file_name.arr);
//	 strcat(nd_file_name.arr,"rlrwlre1.lis");
	 //strcat(nd_file_name.arr,"rlrreswp.lis");  
	 strcat(nd_file_name.arr,OUTPUT_FILE_NAME);  
	 nd_file_name.len = strlen(nd_file_name.arr);
	 if ((f1 = fopen(nd_file_name.arr,"w")) == NULL)
     {
       sprintf(string_var,"Error while opening file %s\n",nd_file_name.arr);
	   disp_message(ERR_MESG,string_var) ;
       proc_exit();
     }
}

increment_file_no()
{
/***
EXEC SQL UPDATE RL_PARAM
		SET PRINT_FILE_NO = NVL(PRINT_FILE_NO,0) + 1;
		***/
if (OERROR)
       disp_message(ERR_MESG,"Update failed on table RL_PARAM");

EXEC SQL COMMIT WORK;
      if (OERROR)
         disp_message(ERR_MESG,"COMMIT failed");
}

get_patient_marker()
{
   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   d_pat_mark.arr[0] = '\0';
   d_pat_mark.len = 0;
   EXEC SQL SELECT TEST_RESULT INTO :d_pat_mark
	      FROM RL_PATIENT_MARKERS
             WHERE PATIENT_ID = :d_prt_patient_id
	       AND TEST_CODE  = :d_worklist_marker;
  if (NODATAFOUND)
    return 0;
  d_pat_mark.arr[d_pat_mark.len] = '\0';


  return 1;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_patient_marker() occured....\n");
   proc_exit();
}

void get_worklist_marker()
{
   d_worklist_marker.arr[0] = '\0';
   d_worklist_marker.len = 0;
	
   d_section_name.arr[0] = '\0';
   d_section_name.len = 0;

   EXEC SQL WHENEVER SQLERROR GOTO err_exit;
   EXEC SQL SELECT  
            //WORKLIST_MARKER, 
			LONG_NAME
			INTO 
			//:d_worklist_marker, 
			:d_section_name
            FROM    RL_SECTION_CODE_LANG_VW
	    WHERE   SECTION_CODE = :nd_section_code
		AND     LANGUAGE_ID = :language_id;
  d_printer_name.arr[d_printer_name.len] = '\0';
  d_section_name.arr[d_section_name.len] = '\0';
#ifdef DEBUG
   printf("d_worklist_marker = %s\n", d_worklist_marker.arr);
#endif
  return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   EXEC SQL ROLLBACK WORK RELEASE;
   disp_message(ORA_MESG,"Oracle error at get_worklist_marker() occured....\n");
   proc_exit();
}


/*------------------ REVERSE SORT ARRAY ------------------*/
void reverse_sort()
{

  for(i=0;i<21;i++)
  {
    if (strcmp(str_word[i],"nd_cup_number") == 0)
		strcpy(detail[i], d_prt_cup_no.arr);	
	else if(strcmp(str_word[i],"nd_cup_indr") == 0) 
		strcpy(detail[i], d_print_cup_indicator.arr);
    else if(strcmp(str_word[i],"nd_wl_marker") == 0) 
		strcpy(detail[i], d_pat_mark.arr);
	else if(strcmp(str_word[i],"nd_spec_no") == 0) 
		strcpy(detail[i], d_prt_specimen_no.arr);
	else if(strcmp(str_word[i],"nd_pat_id") == 0) 
		strcpy(detail[i], d_prt_patient_id.arr);
	else if(strcmp(str_word[i],"nd_pat_name") == 0) 
		strcpy(detail[i], d_short_name.arr);
	else if(strcmp(str_word[i],"nd_age") == 0) 
		strcpy(detail[i], t_age.arr);
	else if(strcmp(str_word[i],"nd_dob") == 0) 
		strcpy(detail[i], d_date_of_birth.arr);
	else if(strcmp(str_word[i],"nd_sex") == 0) 
		strcpy(detail[i], d_sex.arr);
	else if(strcmp(str_word[i],"nd_source") == 0) 
		strcpy(detail[i], d_source_code.arr);
	else if(strcmp(str_word[i],"nd_consultant") == 0) 
		strcpy(detail[i], d_consultant_code.arr);
	else if(strcmp(str_word[i],"nd_urgency") == 0) 
		strcpy(detail[i], d_urgent_indicator.arr);
	else if(strcmp(str_word[i],"nd_comm_1") == 0) 
		strcpy(detail[i], d_request_comment_desc1.arr);
	else if(strcmp(str_word[i],"nd_comm_2") == 0) 
		strcpy(detail[i], d_request_comment_desc2.arr);
	else if(strcmp(str_word[i],"nd_comm_3") == 0) 
		strcpy(detail[i], d_request_comment_desc3.arr);
	else if(strcmp(str_word[i],"nd_spec_date") == 0) 
		strcpy(detail[i], d_spec_regd_date_time.arr);
	else if(strcmp(str_word[i],"nd_assign_to") == 0) 
		strcpy(detail[i], d_assign_to.arr);
	else if(strcmp(str_word[i],"nd_ref_location") == 0) 
		strcpy(detail[i], d_location.arr);
	else if(strcmp(str_word[i],"nd_category_no") == 0) 
		strcpy(detail[i], d_category.arr);
	else if(strcmp(str_word[i],"nd_collect_date") == 0) 
		strcpy(detail[i], d_spec_colltd_date_time.arr);
	else if(strcmp(str_word[i],"nd_race") == 0) 
		strcpy(detail[i], d_race_code.arr);

  }


}

/*------------------ S O R T I N G ------------------*/
void sorting()
{

	maxx = num[0] ;

	for(i=0;i<21;i++)
	{
		for(j=i+1;j<21;j++)
		{
			if (((num[j] < num[i]) || (num[i] == 0))  && (num[j] > 0))
			{
				total  = num[i];
				num[i] = num[j];
				num[j] = total;

				total  = cou[i];
				cou[i] = cou[j];
				cou[j] = total;
			
				strcpy(temp_word,word[i]);
				strcpy(word[i], word[j]);
				strcpy(word[j], temp_word);

				strcpy(temp_word,detail[i]);
				strcpy(detail[i], detail[j]);
				strcpy(detail[j], temp_word);

				strcpy(temp_word,str_word[i]);
				strcpy(str_word[i], str_word[j]);
				strcpy(str_word[j], temp_word);

			}
			else if (num[j] > num[i])
			{
			  if (maxx < num[j])
				maxx = num[j];
			}

		
		}	
	
	}


	for(i=0;i<21;i++)
	{
		for(j=i+1;j<21;j++)
		{
			if ((num[j] == num[i]) && (num[j] > 0))
			{
				if (((cou[j] < cou[i]) || (cou[i] == 0)) && (cou[j] > 0))
				{
				   total = cou[i];
				   cou[i] = cou[j];
				   cou[j] = total;

				   strcpy(temp_word,word[i]);
				   strcpy(word[i], word[j]);
				   strcpy(word[j], temp_word);

				   strcpy(temp_word,detail[i]);
				   strcpy(detail[i], detail[j]);
				   strcpy(detail[j], temp_word);

				   strcpy(temp_word,str_word[i]);
			  	   strcpy(str_word[i], str_word[j]);
				   strcpy(str_word[j], temp_word);

				}

			}
		
		}	
	
	}

	
}

/*-----------------------------------------------------*/
void print_dtl(afp)
FILE *afp;
{

	char fl_ag[3];
	total = 0;
	ctr   = 1;
	strcpy(fl_ag, "F");
	reverse_sort();
	sorting();

	for(i=1;i<=21;i++)
	{

	 
	   k = i;

	   for (j=0;j<21;j++)
	   {
		
		  
	      if (num[j] == ctr)
	      {

			  str_len = strlen(detail[j])  ;


			  if ((strcmp(fl_ag,"F") == 0))
			  	strcpy(fl_ag, "T");
			
			  									 		
			  if ((j > 0) && (num[j - 1] == num[j]))
			  {
			      total = cou[j - 1] ;
			       str_len = strlen(detail[j - 1])  ;
			  }
			
			  if ((j > 0) && (num[j - 1] == num[j]) > 0)
			  {
			     fprintf(afp,"%*s",(cou[j]   - (total + str_len)),"");
  		         fprintf(afp,"%s", detail[j]);
                 tot_tests = get_col_length(j);
                 stimulate = (cou[j]   + tot_tests);


                 stimulate = stimulate - (cou[j] + strlen(detail[j]));
                                                
			  }
			  else
			  {
				fprintf(afp,"%*s", cou[j] - 1, "");
				fprintf(afp,"%s", detail[j]);
                tot_tests = get_col_length(j);
                stimulate = (cou[j]   + tot_tests);

                stimulate = stimulate - (cou[j] + strlen(detail[j]));

			  }
			  

			  k = j ;		   
			  str_len = 0;


			  
	      }
		
      }
	
	   i = k;
	   
	   if ((num[i] > 0) && (maxx >= num[i]))
	   {

/******** not required for kndv enhancments ************
		  if (num[i] == 1)
		  {

			print_hyphen(afp);
			stimulate = 0;
		  }
************ upto here   **************/
		  	
	      if (strcmp(fl_ag,"T") == 0)
		  {
			fprintf(afp,"\n");
		    line_no++;
			strcpy(fl_ag, "F");
		  }
	      total = 0;


	  }

	   ctr = ctr + 1 ;
	   strcpy(fl_ag,"F");

	}

}

void print_hyphen(afp)
FILE *afp;
{
	int space_or_line();
    int i=0,r=0;

  fprintf(afp," ");

  fprintf(afp," ");

  tests = stimulate ;

  fprintf(afp, "%*.*s", tests, tests, "");
  

  if( no_of_tests < 25 )
  { 
  	print_line = 0;
    print_line = space_or_line(d_prt_test_1_yn,worklist_ind[0][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
	      fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_2_yn,worklist_ind[1][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_3_yn,worklist_ind[2][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_4_yn,worklist_ind[3][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_5_yn,worklist_ind[4][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_6_yn,worklist_ind[5][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_7_yn,worklist_ind[6][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_8_yn,worklist_ind[7][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_9_yn,worklist_ind[8][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_10_yn,worklist_ind[9][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_11_yn,worklist_ind[10][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_12_yn,worklist_ind[11][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_13_yn,worklist_ind[12][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_14_yn,worklist_ind[13][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_15_yn,worklist_ind[14][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
	print_line = space_or_line(d_prt_test_16_yn,worklist_ind[15][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-5s","_____");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-5s","     ");
	
   }
   else
   {
    print_line = 0;
    print_line = space_or_line(d_prt_test_17_yn,worklist_ind[16][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_18_yn,worklist_ind[17][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_19_yn,worklist_ind[18][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_20_yn,worklist_ind[19][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_21_yn,worklist_ind[20][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_22_yn,worklist_ind[21][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_23_yn,worklist_ind[22][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_24_yn,worklist_ind[23][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
    print_line = 0;
    print_line = space_or_line(d_prt_test_25_yn,worklist_ind[24][0]);
    if(print_line  &&  test_ctr <= d_no_of_tests)
       fprintf(afp,"%-6s","_____ ");
    else
	   if (d_no_of_tests >= test_ctr)
          fprintf(afp,"%-6s","      ");
  }
  

}


/* ------------ P R I N T T E S T S --------*/
void print_all_tests(f1)
FILE *f1;
{

	int print_line = 0;
    int i=0,r=0;
	int p_count = 0;

    dclr_test_result_cur();
	
    while(fetch_test_result_cur())
    {
	   chk_break(1);
	   get_test_desc();
	   fprintf(f1,"    ");
/*** modified TEST NAME and TEST RESULT removed 22.10.2002   
       //fprintf(f1,"TEST NAME. %-40.40s ",d_tst_test_name.arr);
	   fprintf(f1,"%-10.10s %-40.40s ",local_legend[10],d_tst_test_name.arr);
	   //fprintf(f1,"TEST RESULT. ");
	   fprintf(f1,"%-12.12s ",local_legend[11]);
***/
       fprintf(f1,"%-52.52s",d_tst_test_name.arr);
	   fprintf(f1,": ");

//	   fprint_repeat(f1, '_', 10);
	   fprintf(f1, "%s", d_test_result.arr);
	   fprintf(f1,"\n");
	   line_no++;
// added 30.09.2002
       if (result_comments_yn())
	   {
		   chk_break(1);
		   fprintf(f1,"               ");
		   //fprintf(f1,"Result Comments:\n");
		   fprintf(f1,"%-15.15s:\n",local_legend[13]);
		   line_no++;
		   if (result_comments_1_yn())
		   {
			   chk_break(1);
			   fprintf(f1,"               ");
			   //fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_result1.arr,d_comm_result_desc1.arr);
			   fprintf(f1,"%-4.4s:%-4.4s  %-4.4s.:%-40.40s\n",local_legend[21],d_comm_result1.arr,local_legend[22],d_comm_result_desc1.arr);
			   line_no++;
		   }
		   if (result_comments_2_yn())
		   {
			   chk_break(1);
			   fprintf(f1,"               ");
			   //fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_result2.arr,d_comm_result_desc2.arr);
			   fprintf(f1,"%-4.4s:%-4.4s  %-4.4s.:%-40.40s\n",local_legend[21],d_comm_result2.arr,local_legend[22],d_comm_result_desc2.arr);
			   line_no++;
		   }
		   if (result_comments_3_yn())
		   {
			   chk_break(1);
			   fprintf(f1,"               ");
			   //fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_result3.arr,d_comm_result_desc3.arr);
			   fprintf(f1,"%-4.4s:%-4.4s  %-4.4s.:%-40.40s\n",local_legend[21],d_comm_result3.arr,local_legend[22],d_comm_result_desc3.arr);
			   line_no++;
		   }
		   if (result_comments_4_yn())
		   {
			   chk_break(1);
			   fprintf(f1,"               ");
			   //fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_result4.arr,d_comm_result_desc4.arr);
			   fprintf(f1,"%-4.4s:%-4.4s  %-4.4s.:%-40.40s\n",local_legend[21],d_comm_result4.arr,local_legend[21],d_comm_result_desc4.arr);
			   line_no++;
		   }
	   }

	/*** Code added to check and Print the Previous results based on setup ***/

	if (strcmp(d_prv_result_yn.arr, "Y") == 0 )
	{
		EXEC SQL SELECT NVL(PERIOD_FOR_PAST_RESULTS,0),NVL(NO_OF_PAST_RESULTS,0),
		                PAST_RESULT_UNITS
				 INTO :d_past_result_period, :d_past_result_no, :d_past_result_unit
				 FROM RL_WORKLIST_FMT_DTL 
				 WHERE operating_facility_id = :nd_operating_facility_id
				 AND   section_code = :nd_section_code
				 AND   worklist_name = :nd_worklist_name
				 AND   test_code = :d_tst_test_code;
		if (d_past_result_period)
		{
			if (strcmp(d_past_result_unit.arr, "YRS") == 0)
			{
				EXEC SQL SELECT TO_CHAR(ADD_MONTHS(TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI'), -12*:d_past_result_period),
					                    'DD/MM/YYYY HH24:MI')
						 INTO :nd_prv_result_dt
						FROM DUAL;
			}
			if (strcmp(d_past_result_unit.arr, "MTHS") == 0)
			{
				EXEC SQL SELECT TO_CHAR(ADD_MONTHS(TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI'), -1*:d_past_result_period),
										'DD/MM/YYYY HH24:MI')
						 INTO :nd_prv_result_dt
						 FROM DUAL;
			}
			if (strcmp(d_past_result_unit.arr, "WKS") == 0)
			{
				EXEC SQL SELECT TO_CHAR(TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI') - 7*:d_past_result_period, 'DD/MM/YYYY HH24:MI')
						 INTO :nd_prv_result_dt
						 FROM DUAL;
			}
			if (strcmp(d_past_result_unit.arr, "DAY") == 0)
			{
				EXEC SQL SELECT TO_CHAR(TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI') - 1*:d_past_result_period, 'DD/MM/YYYY HH24:MI')
						 INTO :nd_prv_result_dt
						 FROM DUAL;
			}
			if (strcmp(d_past_result_unit.arr, "HRS") == 0)
			{
				EXEC SQL SELECT TO_CHAR(TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI') - (1/24)*:d_past_result_period, 'DD/MM/YYYY HH24:MI')
						 INTO :nd_prv_result_dt
						 FROM DUAL;
			}

			fprintf(f1,"    ");
			//fprintf(f1,"[Previous Results]\n");
			fprintf(f1,"[%-16.16s]\n",local_legend[12]);
			line_no++;

			/***
			nd_modified_dt.arr[0] = '\0';
			nd_modified_dt.len = 0;

			EXEC SQL SELECT TO_CHAR(MODIFIED_DATE,'DD/MM/YYYY HH24:MI') 
					 INTO :nd_modified_dt FROM RL_TEST_RESULT
					 WHERE patient_id = :d_prt_patient_id
					 AND specimen_no = TO_NUMBER(:d_prt_specimen_no)
					 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
					 AND test_code = :d_tst_test_code;

			nd_modified_dt.arr[nd_modified_dt.len] = '\0';
            ***/
			
			dclr_test_result_prv_cur();
	
			while(fetch_test_result_prv_cur())
			{
					/***
					EXEC SQL SELECT TO_CHAR(spec_regd_date_time,'DD/MM/YYYY HH24:MI:SS') 
					         INTO :d_prv_specimen_regd_date
							 FROM RL_REQUEST_HEADER
							 WHERE specimen_no = :d_prv_specimen_no
							 AND   operating_facility_id = :nd_operating_facility_id;
					***/

				p_count++;

				chk_break(1);
				get_test_prv_desc();
				fprintf(f1,"    ");
				fprintf(f1,"%-20.20s  %-30.30s", d_prv_specimen_no.arr, d_prv_specimen_regd_date.arr);
				fprintf(f1,": ");
				fprintf(f1, "%s", d_test_prv_result.arr);
				fprintf(f1,"\n");
				line_no++;
			
				/*** Commented since result Comment is not required to get printed 
				     for Previous Results

				if (result_prv_comments_yn())
				{
					chk_break(1);
					fprintf(f1,"               ");
					//fprintf(f1,"Result Comments:\n");
					fprintf(f1,"%-15.15s:\n",local_legend[13]);
					line_no++;
					if (result_prv_comments_1_yn())
					{
						chk_break(1);
						fprintf(f1,"               ");
						fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_prv_result1.arr,d_comm_prv_result_desc1.arr);
						
						line_no++;
					}
					if (result_prv_comments_2_yn())
					{
						chk_break(1);
						fprintf(f1,"               ");
						fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_prv_result2.arr,d_comm_prv_result_desc2.arr);
						
						line_no++;
					}
					if (result_prv_comments_3_yn())
					{
						chk_break(1);
						fprintf(f1,"               ");
						fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_prv_result3.arr,d_comm_prv_result_desc3.arr);
						line_no++;
					}
					if (result_prv_comments_4_yn())
					{
						chk_break(1);
						fprintf(f1,"               ");
						fprintf(f1,"Code:%-4.4s  Desc.:%-40.40s\n",d_comm_prv_result4.arr,d_comm_prv_result_desc4.arr);
						line_no++;
					}
				}
				***/

				if (p_count == d_past_result_no)
				{
					break;
				}
			}
		fprintf(f1,"\n");
		line_no++;
		}
	}

// upto here
    }

	chk_break(1);
    
    close_test_result_cur();
	return;
}


/*------------------ H E A D I N G ------------------*/
void prepare_heading(afp)
FILE *afp;
{

    int i = 0, j = 0, k = 0;
	char heading[60] ;
	int length = 0;

	sorting();

		
    total = 0;
	ctr   = 1;

	for(i=1;i<=21;i++)
	{
	 
	   k = i;

	   for (j=0;j<21;j++)
	   {
		
          		
	      if (num[j] == ctr) 
	      {

			  if ((j > 0) && (num[j - 1] == num[j]) > 0)
			  {

			      total = cou[j - 1] ;
				  str_len = strlen(word[j - 1])  ;
				  
			  }
			
			  if ((j > 0) && (num[j - 1] == num[j]) > 0)
			  {
			     fprintf(afp,"%*s",(cou[j]   - (total + str_len)),"");
  		         fprintf(afp,"%s", word[j]);
			  }
			  else
			  {
				fprintf(afp,"%*s", cou[j] - 1, "");
				fprintf(afp,"%s", word[j]);
			  }

			  k = j ;		   
			  str_len = 0;
			  
	      }

		  

      }

	   i = k;

	   if ((num[i] > 0) && (num[i] <= maxx))
	   {
		  
	  	  fprintf(afp, "\n");
		  fprint_repeat(f1, '_', 79);
		  fprintf(afp, "\n");
		  line_no += 2;
		  total = 0;
		  
 	    }

	   ctr = ctr + 1 ;

	}


	return ;
}


/*----------- S P A C I N G ------------*/
void spacing(afp)
FILE *afp;
{
	 
    for (i=0;i<d_line_spacing;i++)
      fprintf(afp,"\n");
}

/*-------------   Age of Patient in Years, Months, Days --------------*/

 void patient_age()
 {

		 float  lone = 0;
		 float  num1 = 0, yrs = 0, 
				tmp_mths = 0, 
				tmp_days = 0;

		 char st_r[50];

	/*today.arr[0] = '\0';
	today.len = 0;  --Commented by Durai Rajkumar for Age Calculation on 05-Feb-08*/

	mths.arr[0]  = '\0';
	mths.len  = 0;

	
	/*EXEC SQL SELECT TO_CHAR(SYSDATE,'DD/MM/YYYY') INTO :today
            FROM DUAL;  --Commented by Durai Rajkumar for Age Calculation on 05-Feb-08 */                                        

    EXEC SQL SELECT ABS(MONTHS_BETWEEN(
		/*TO_DATE(:today,'DD/MM/YYYY'),  --Commented by Durai Rajkumar for Age Calculation on 05-Feb-08*/ 
		TO_DATE(:d_l_spec_regd_date_time ,'DD/MM/YYYY'), /*Added by Durai Rajkumar for Age Calculation on 05-Feb-08 */
		TO_DATE(:d_date_of_birth, 'DD/MM/YYYY')))
			INTO :mt FROM DUAL;

			sprintf(mths.arr,"%f",mt);
			strcpy(mths1.arr, mths.arr);

        	/*today.arr[today.len] = '\0';   --Commented by Durai Rajkumar for Age Calculation on 05-Feb-08*/
							
			lone = atoi(strtok(mths1.arr, ".")) ;

		   if (lone > 0) 
		   {
			  num1 = lone/12 ;
			  sprintf(t_age.arr, "%f", num1);
			  yrs = atoi(strtok(t_age.arr, ".")) ;
		   }
		   else
			  yrs = 0;
            
			tmp_mths   = atoi(mths1.arr) - (yrs * 12) ;
			sprintf(t_age.arr, "%f", tmp_mths);
			tmp_mths   = atoi(strtok(t_age.arr, "."));

			if ((tmp_mths == 0)  && (yrs ==0))
			{

				/*EXEC SQL SELECT TO_CHAR(ROUND((TO_DATE(:today,'DD/MM/YYYY') -      --Commented by Durai Rajkumar for Age Calculation on 05-Feb-08*/
					EXEC SQL SELECT TO_CHAR(ROUND((TO_DATE(:d_l_spec_regd_date_time,'DD/MM/YYYY') -  /*Added by Durai Rajkumar for Age Calculation on 05-Feb-08 */
					TO_DATE(:d_date_of_birth, 'DD/MM/YYYY')),3))
					INTO :t_days FROM DUAL;

					tmp_days = atoi(strtok(t_days.arr,"."));
			}
			else
				tmp_days = (atof(mths.arr) - atoi(mths1.arr)) * 31 ;
				
			sprintf(st_r, "%f", yrs);
			strcpy(t_age.arr, strtok(st_r, "."));
			sprintf(st_r, " %f", tmp_mths);
			strcat(t_age.arr, strtok(st_r, "."));
			sprintf(st_r, " %f", tmp_days);
			strcat(t_age.arr, strtok(st_r, "."));
				
 }

/*----------------------------------------------------------------------------*/
print_title()
{
	int l_pos = 0;
	int l_rem_pos = 0;
	int l_len = 0;
	int l_page_pos = 0;
	char l_string[100];
	int page_pos = 0;


	
	line_no = 0;

	/**** first line ***********/	
	fprintf(f1,"\n");
	l_pos = (int)(((80 - d_acc_entity_name.len)/2));
	sprintf(string_var, "%-*s%s", l_pos, " ", 
						d_acc_entity_name.arr);
	fprintf(f1, "%s\n", string_var);


	/**** second line ***********/	
	l_rem_pos = 68 - 22;
	l_len = 22 + l_rem_pos + d_acc_entity_name.len;
	l_page_pos = 62 - l_len;    /*changed to print page number within 80 char (25/06/2002) */

	get_date_time();

//	sprintf(string_var, "RUN DATE : %-10.10s%-*s%s%-*sPAGE NO. %d", d_curr_date.arr,l_rem_pos, " ", 
//						d_acc_entity_name.arr, l_page_pos, " ", page_no);

	//sprintf(string_var, "RUN DATE : %-10.10s%-*sPAGE NO. %d", d_curr_date.arr,l_rem_pos, " ", 
	//					page_no);

	//Added by babu for globalization

	rec_len = strlen(local_legend[1]);
	page_pos = 80-(rec_len + 6);
	rec_len = strlen(local_legend[23]);
    page_pos = page_pos -(rec_len + 6 + 10);
	        EXEC SQL EXECUTE
				DECLARE
				t_date   date;
				
				BEGIN
				t_date:=GET_LOCALE_DATE.GET_CURRENT_DATE(:language_id);
				:d_curr_date1 := to_char(t_date,'DD/MM/YYYY HH24:MI');
				END;
			END-EXEC;


	sprintf(string_var, "%s : %-10.10s%-*s%s : %d",local_legend[23], d_curr_date1.arr,page_pos, " ",local_legend[1], page_no++);
	fprintf(f1, "%s\n", string_var);


	/**** Third line ***********/	
	/*****************COMMENTED BY BABU FOR GLOBALIZATION
	l_rem_pos = l_pos - 7;
	strcpy(l_string, "DEPT OF ");
	strcat(l_string, d_section_name.arr);
	sprintf(string_var, "RUN TIME : %-5.5s%-*s%s", d_curr_time.arr, l_rem_pos, " ", 
				l_string);
				****************END ********************/

	strcpy(l_string, local_legend[24]);
	strcat(l_string, " ");
	strcat(l_string, d_section_name.arr);
	sprintf(string_var, "%s : %-5.5s  %s",local_legend[25], d_curr_time.arr,  
				l_string);

	fprintf(f1, "%s\n", string_var);

	/**** Fourth line ***********/	
	/**************commented by babu for globalization
	sprintf(string_var, "Worklist Name:%s    Date:%s    Worklist No:%d", nd_worklist_name.arr, 
							nd_worklist_date.arr, nd_worklist_no);
	l_pos = (int)(((80 - strlen(string_var))/2) - 1);

	
	fprintf(f1, "%-*s%s\n", l_pos, " ", string_var);

	fprintf(f1, "%-10.10s/%-5.5s/%s\n", d_added_date.arr, d_added_time.arr, d_added_by_id.arr);
	*****************end***************/
	/********Addded by babu***************/
	        
		EXEC SQL EXECUTE
				DECLARE
				t_date   date;
				
				BEGIN
				GET_LOCALE_DATE.CONVERT_TO_LOCALE_DATE (to_date(:nd_worklist_date,'DD/MM/YYYY'), :language_id , t_date);
				
				:nd_worklist_date1 := to_char(t_date,'DD/MM/YYYY');
				END;
			END-EXEC;

		//End
/*****************end************************/   
	
	sprintf(string_var, "%-13.13s:%s    %-4.4s:%s    %-15.15s:%d",local_legend[26] ,nd_worklist_name.arr, 
						local_legend[4],	nd_worklist_date1.arr,local_legend[3] ,nd_worklist_no);
	l_pos = (int)(((80 - strlen(string_var))/2) - 1);

	fprintf(f1, "%-*s%s\n", l_pos, " ", string_var);

	/********Addded by babu***************/
	        
		EXEC SQL EXECUTE
				DECLARE
				t_date   date;
				
				BEGIN
				GET_LOCALE_DATE.CONVERT_TO_LOCALE_DATE (to_date(:d_added_date,'DD/MM/YYYY'), :language_id , t_date);
				
				:d_added_date1 := to_char(t_date,'DD/MM/YYYY');
				END;
			END-EXEC;

		//End
/*****************end************************/   
	
	
	fprintf(f1, "%-10.10s/%-5.5s/%s\n", d_added_date1.arr, d_added_time.arr, d_added_by_id.arr);


	fprint_repeat(f1, '_', 79);
	fprintf(f1, "\n");

	line_no = 6;

}
/*----------------------------------------------------------------------------*/
fprint_repeat(l_fp,l_prn_chr,l_no)
FILE *l_fp;
char l_prn_chr;
int  l_no;
{
   int l_i = 0;

   for (l_i = 0;l_i < l_no;l_i++)
        fputc(l_prn_chr,l_fp);
}
/*-----------------------------------------------------*/

print_quality_hdr()
{
/**********************************commented for globalization
	fprintf(f1, "CUP#");
	fprintf(f1, "     QC");
	fprintf(f1, "            LOT#\n");
	fprintf(f1, "         EXPIRY DATE\n");
	fprintf(f1, "         QC RANGE\n\n");
	fprintf(f1, "         QC RESULT\n");
	*****************************end*********************/

		fprintf(f1, "%-3.3s#",local_legend[14]);
	fprintf(f1, "     %-2.23s",local_legend[15]);
	fprintf(f1, "            %-3.3s#\n,local_legend[16]");
	fprintf(f1, "         %-11.11s\n",local_legend[17]);
	fprintf(f1, "         %-8.8s\n\n",local_legend[18]);
	fprintf(f1, "         %-10.10s\n",local_legend[19]);


//	fprint_repeat(f1, '_', 79);
//	fprintf(f1, "\n");
	line_no += 4;
}
/*-----------------------------------------------------*/
chk_break(int nol, char l_char)
{
	if((line_no + nol) >= MAX_LINES) 
	{
       line_no = 1;
	   fprintf(f1, "\f");
	
	   print_title();	   
	   prepare_heading(f1);
	   
 	}
}

/*-----------------------------------------------------*/
dclr_spec_test_dtl_cur()
{
	EXEC SQL DECLARE spec_test_dtl_cur CURSOR FOR
		SELECT test_code
		FROM RL_REQUEST_DETAIL 
		WHERE patient_id = :d_prt_patient_id
		AND specimen_no = TO_NUMBER(:d_prt_specimen_no)
		AND operating_facility_id = :nd_operating_facility_id
		ORDER BY line_no;

	EXEC SQL OPEN spec_test_dtl_cur;
}
/*-----------------------------------------------------*/
fetch_spec_test_dtl_cur()
{
	d_test_code.arr[0] = '\0';
	d_test_code.len	   = 0;

	EXEC SQL FETCH spec_test_dtl_cur
	INTO d_test_code;

	d_test_code.arr[d_test_code.len] = '\0';

	return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/
print_spec_tests()
{
	dclr_spec_test_dtl_cur();
	
	strcpy(print_temp_line ,"");
	strcpy(print_test_line, "");

	while(fetch_spec_test_dtl_cur())
	{

		strcpy(print_temp_line, d_test_code.arr);
		
		if (strlen(print_test_line) > 61)
			break;
		else
			if (strlen(print_test_line) == 0 ) 
			{
				strcpy(print_test_line, print_temp_line);
			}
			else
			{
				strcat(print_test_line, ",");
				strcat(print_test_line, print_temp_line);
			}
	}
	chk_break(1);
	fprintf(f1,"\n");
	line_no++;
	//fprintf(f1,"Requested Tests : ");
	fprintf(f1,"%-15.15s : ",local_legend[20]);
	fprintf(f1, print_test_line);
	line_no++;
	fprintf(f1,"\n");
	line_no++;
	
	close_spec_test_dtl_cur();
	return;
}
/*-----------------------------------------------------*/
close_spec_test_dtl_cur()
{
	EXEC SQL CLOSE spec_test_dtl_cur;
}

/*-----------------------------------------------------*/
dclr_test_result_cur()
{
// modified 30.09.2002 result comments also taken

    EXEC SQL DECLARE test_result_cur CURSOR FOR
         SELECT A.test_code, A.numeric_result, A.numeric_prefix, 
				A.result_comment_code1, A.result_comment_code2,
				A.result_comment_code3, A.result_comment_code4,
				A.status,
				A.result_comment_desc1, A.result_comment_desc2,
				A.result_comment_desc3, A.result_comment_desc4
           FROM RL_TEST_RESULT A, RL_WORKLIST_FMT_DTL B
           WHERE A.patient_id = :d_prt_patient_id
	       AND A.specimen_no = TO_NUMBER(:d_prt_specimen_no)
		   AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id
		   AND B.section_code = :nd_section_code
		   AND B.worklist_name = :nd_worklist_name
		   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id
		   AND A.test_code = B.test_code
           ORDER BY B.seq_no;

	EXEC SQL OPEN test_result_cur;

}

/*** Cursor declared to get the previous results of the Test Code  in the work List ***/
dclr_test_result_prv_cur()
{

    EXEC SQL DECLARE test_result_prv_cur CURSOR FOR
         SELECT TO_CHAR(A.specimen_no), A.test_code, A.numeric_result, A.numeric_prefix, 
				A.result_comment_code1, A.result_comment_code2,
				A.result_comment_code3, A.result_comment_code4,
				A.status,
				A.result_comment_desc1, A.result_comment_desc2,
				A.result_comment_desc3, A.result_comment_desc4,
				TO_CHAR(D.spec_regd_date_time,'DD/MM/YYYY HH24:MI:SS')
           FROM RL_TEST_RESULT A, RL_WORKLIST_FMT_DTL B, RL_WORKLIST_DTL C,
		        RL_REQUEST_HEADER D
           WHERE A.patient_id = :d_prt_patient_id
		   AND A.patient_id = D.patient_id
	       AND A.specimen_no = c.specimen_no
		   AND A.specimen_no = D.specimen_no
		   AND A.specimen_no != TO_NUMBER(:d_prt_specimen_no)
		   AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id
		   AND B.section_code = :nd_section_code
		   AND B.worklist_name = :nd_worklist_name
		   AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id
		   AND A.test_code = B.test_code
		   AND A.test_code = :d_tst_test_code
           AND NVL(A.reviewed_date,TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI')) >= 
		       TO_DATE(:nd_prv_result_dt,'DD/MM/YYYY HH24:MI')
		   AND D.spec_regd_date_time < TO_DATE(:d_spec_regd_date_time,'DD/MM/YYYY HH24:MI')
		   ORDER BY A.reviewed_date desc;

	EXEC SQL OPEN test_result_prv_cur;

}

/*-----------------------------------------------------*/
fetch_test_result_cur()
{

  d_tst_test_code.arr[0]		= '\0';
  d_tst_test_code.len			= 0;
  
  d_tst_numeric_result.arr[0]	= '\0';
  d_tst_numeric_result.len		= 0;

  d_num_prefix.arr[0]			= '\0';
  d_num_prefix.len				= 0;

  d_comm_result1.arr[0]			= '\0';
  d_comm_result1.len			= 0;
  d_comm_result2.arr[0]			= '\0';
  d_comm_result2.len			= 0;
  d_comm_result3.arr[0]			= '\0';
  d_comm_result3.len			= 0;
  d_comm_result4.arr[0]			= '\0';
  d_comm_result4.len			= 0;
  d_status.arr[0]				= '\0';
  d_status.len					= 0;
//added following 30.09.2002
  d_comm_result_desc1.arr[0]			= '\0';
  d_comm_result_desc1.len			= 0;
  d_comm_result_desc2.arr[0]			= '\0';
  d_comm_result_desc2.len			= 0;
  d_comm_result_desc3.arr[0]			= '\0';
  d_comm_result_desc3.len			= 0;
  d_comm_result_desc4.arr[0]			= '\0';
  d_comm_result_desc4.len			= 0;
// upto here

  EXEC SQL FETCH test_result_cur
		   INTO :d_tst_test_code,
				:d_tst_numeric_result,
				:d_num_prefix,
				:d_comm_result1,
				:d_comm_result2,
				:d_comm_result3,
				:d_comm_result4,
				:d_status,
				:d_comm_result_desc1,
				:d_comm_result_desc2,
				:d_comm_result_desc3,
				:d_comm_result_desc4;

  d_tst_numeric_result.arr[d_tst_numeric_result.len]	= '\0';
  d_tst_test_code.arr[d_tst_test_code.len]				= '\0';
  d_num_prefix.arr[d_num_prefix.len]					= '\0';
  d_comm_result1.arr[d_comm_result1.len]	 			= '\0';
  d_comm_result2.arr[d_comm_result2.len]	 			= '\0';
  d_comm_result3.arr[d_comm_result3.len]	 			= '\0';
  d_comm_result4.arr[d_comm_result4.len]	 			= '\0';
  d_status.arr[d_status.len]							= '\0';
// added 30.09.2002
  d_comm_result_desc1.arr[d_comm_result_desc1.len]	 			= '\0';
  d_comm_result_desc2.arr[d_comm_result_desc2.len]	 			= '\0';
  d_comm_result_desc3.arr[d_comm_result_desc3.len]	 			= '\0';
  d_comm_result_desc4.arr[d_comm_result_desc4.len]	 			= '\0';
//upto here




  d_test_result.arr[0] = '\0';
  d_test_result.len    = 0;

  if(strlen(d_tst_numeric_result.arr))
  {
	 if (strlen(d_num_prefix.arr))
	 {
		strcpy(d_test_result.arr, d_num_prefix.arr);
		d_test_result.len = strlen(d_test_result.arr);
		strcat(d_test_result.arr,d_tst_numeric_result.arr);
	 }
	 else
	 {
		strcpy(d_test_result.arr,d_tst_numeric_result.arr);
	 }
  }
/* commented 30.09.2002,since the result comments to be shown seperately
  else
  {
	 if (strlen(d_comm_result1.arr))
		strcpy(d_test_result.arr,d_comm_result1.arr);
	 else if (strlen(d_comm_result2.arr))
		strcpy(d_test_result.arr,d_comm_result2.arr);
 	 else if (strlen(d_comm_result3.arr))
		strcpy(d_test_result.arr,d_comm_result3.arr);
 	 else if (strlen(d_comm_result4.arr))
		strcpy(d_test_result.arr,d_comm_result4.arr);

  }
*/
  d_test_result.len = strlen(d_test_result.arr);


   return (LAST_ROW?0:1);
}

/*** Added to fetch the Previous results for the Work List ***/

fetch_test_result_prv_cur()
{
  d_prv_specimen_no.arr[0]          = '\0';
  d_prv_specimen_no.len				= 0;

  d_tst_prv_test_code.arr[0]		= '\0';
  d_tst_prv_test_code.len			= 0;
  
  d_tst_prv_numeric_result.arr[0]	= '\0';
  d_tst_prv_numeric_result.len		= 0;

  d_num_prv_prefix.arr[0]			= '\0';
  d_num_prv_prefix.len				= 0;

  d_comm_prv_result1.arr[0]			= '\0';
  d_comm_prv_result1.len			= 0;
  d_comm_prv_result2.arr[0]			= '\0';
  d_comm_prv_result2.len			= 0;
  d_comm_prv_result3.arr[0]			= '\0';
  d_comm_prv_result3.len			= 0;
  d_comm_prv_result4.arr[0]			= '\0';
  d_comm_prv_result4.len			= 0;
  d_status_prv.arr[0]				= '\0';
  d_status_prv.len					= 0;

  d_comm_prv_result_desc1.arr[0]		= '\0';
  d_comm_prv_result_desc1.len			= 0;
  d_comm_prv_result_desc2.arr[0]		= '\0';
  d_comm_prv_result_desc2.len			= 0;
  d_comm_prv_result_desc3.arr[0]		= '\0';
  d_comm_prv_result_desc3.len			= 0;
  d_comm_prv_result_desc4.arr[0]		= '\0';
  d_comm_prv_result_desc4.len			= 0;

  d_prv_specimen_regd_date.arr[0]       = '\0';
  d_prv_specimen_regd_date.len          = 0;

// upto here

  EXEC SQL FETCH test_result_prv_cur
		   INTO :d_prv_specimen_no,	
				:d_tst_prv_test_code,
				:d_tst_prv_numeric_result,
				:d_num_prv_prefix,
				:d_comm_prv_result1,
				:d_comm_prv_result2,
				:d_comm_prv_result3,
				:d_comm_prv_result4,
				:d_status_prv,
				:d_comm_prv_result_desc1,
				:d_comm_prv_result_desc2,
				:d_comm_prv_result_desc3,
				:d_comm_prv_result_desc4,
				:d_prv_specimen_regd_date;

  d_prv_specimen_no.arr[d_prv_specimen_no.len] = '\0';
  d_tst_prv_numeric_result.arr[d_tst_prv_numeric_result.len]	= '\0';
  d_tst_prv_test_code.arr[d_tst_prv_test_code.len]		= '\0';
  d_num_prv_prefix.arr[d_num_prv_prefix.len]			= '\0';
  d_comm_prv_result1.arr[d_comm_prv_result1.len]	 	= '\0';
  d_comm_prv_result2.arr[d_comm_prv_result2.len]	 	= '\0';
  d_comm_prv_result3.arr[d_comm_prv_result3.len]	 	= '\0';
  d_comm_prv_result4.arr[d_comm_prv_result4.len]	 	= '\0';
  d_status_prv.arr[d_status_prv.len]				= '\0';

  d_comm_prv_result_desc1.arr[d_comm_prv_result_desc1.len]	= '\0';
  d_comm_prv_result_desc2.arr[d_comm_prv_result_desc2.len]	= '\0';
  d_comm_prv_result_desc3.arr[d_comm_prv_result_desc3.len]	= '\0';
  d_comm_prv_result_desc4.arr[d_comm_prv_result_desc4.len]	= '\0';

  d_prv_specimen_regd_date.arr[d_prv_specimen_regd_date.len] = '\0';

//upto here

  d_test_prv_result.arr[0] = '\0';
  d_test_prv_result.len    = 0;

  if(strlen(d_tst_prv_numeric_result.arr))
  {
	 if (strlen(d_num_prv_prefix.arr))
	 {
		strcpy(d_test_prv_result.arr, d_num_prefix.arr);
		d_test_prv_result.len = strlen(d_test_result.arr);
		strcat(d_test_prv_result.arr,d_tst_prv_numeric_result.arr);
	 }
	 else
	 {
		strcpy(d_test_prv_result.arr,d_tst_prv_numeric_result.arr);
	 }
  }
  d_test_prv_result.len = strlen(d_test_prv_result.arr);

   return (LAST_ROW?0:1);
}

/*-----------------------------------------------------*/
close_test_result_cur()
{

	EXEC SQL CLOSE test_result_cur;

}
/*-----------------------------------------------------*/
get_test_desc()
{
	d_tst_test_name.arr[0]	= '\0';
	d_tst_test_name.len		= 0;
	
	EXEC SQL SELECT long_desc
			 INTO :d_tst_test_name
			 FROM RL_TEST_CODE_LANG_VW
			 WHERE test_code = :d_tst_test_code
			 AND LANGUAGE_ID = :language_id;
	
	d_tst_test_name.arr[d_tst_test_name.len]	= '\0';

	if (NODATAFOUND);


}

get_test_prv_desc()
{
	d_tst_prv_test_name.arr[0]	= '\0';
	d_tst_prv_test_name.len		= 0;
	
	EXEC SQL SELECT long_desc
			 INTO :d_tst_prv_test_name
			 FROM RL_TEST_CODE_LANG_VW
			 WHERE test_code = :d_tst_prv_test_code
			 AND   LANGUAGE_ID = :language_id;
	
	d_tst_prv_test_name.arr[d_tst_prv_test_name.len]	= '\0';

	if (NODATAFOUND);

}

/*-----------------------------------------------------*/
get_date_time()
{

  d_added_date.arr[0]		= '\0';
  d_added_date.len			= 0;
  d_added_time.arr[0]		= '\0';
  d_added_time.len			= 0;
  d_added_by_id.arr[0]		= '\0';
  d_added_by_id.len			= 0;
  d_curr_date.arr[0]		= '\0';
  d_curr_date.len			= 0;
  d_curr_time.arr[0]		= '\0';
  d_curr_time.len			= 0;

  EXEC SQL SELECT ADDED_BY_ID, TO_CHAR(added_date, 'DD/MM/YYYY'),
				TO_CHAR(added_date, 'HH24:MI'), TO_CHAR(SYSDATE, 'DD/MM/YYYY'), 
				TO_CHAR(SYSDATE, 'HH24:MI')
			INTO :d_added_by_id, :d_added_date, :d_added_time,
					:d_curr_date, :d_curr_time	
			FROM RL_WORKLIST_HDR
			WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			AND SECTION_CODE  = :nd_section_code 
			AND WORKLIST_NAME = :nd_worklist_name
			AND WORKLIST_NO   = :nd_worklist_no
			AND WORKLIST_DATE = TO_DATE(:nd_worklist_date, 'DD/MM/YYYY');

  d_added_by_id.arr[d_added_by_id.len]  = '\0';
  d_added_date.arr[d_added_date.len]	= '\0';
  d_added_time.arr[d_added_time.len]	= '\0';
  d_curr_date.arr[d_curr_date.len]		= '\0';
  d_curr_time.arr[d_curr_time.len]		= '\0';



}

#undef DEBUG
#undef NODATAFOUND
#undef MAX_LINES
#undef VER

#undef DEBUG
#undef NODATAFOUND
#undef MAX_LINES
#undef VER

/* ----------------added 30.09.2002 -------------------*/
int result_comments_yn()
{
	 if (strlen(d_comm_result1.arr) || strlen(d_comm_result2.arr) ||
	     strlen(d_comm_result3.arr) || strlen(d_comm_result4.arr) ||
		 strlen(d_comm_result_desc1.arr) || strlen(d_comm_result_desc2.arr) ||
		 strlen(d_comm_result_desc3.arr) || strlen(d_comm_result_desc4.arr))
         {
		 return 1;
		 }
	 else
	     return 0;	 	
}

int result_comments_1_yn()
{
	if (strlen(d_comm_result_desc1.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
int result_comments_2_yn()
{
	if (strlen(d_comm_result_desc2.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
int result_comments_3_yn()
{
	if (strlen(d_comm_result_desc3.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
int result_comments_4_yn()
{
	if (strlen(d_comm_result_desc4.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
/*----------------------------------upto here--------------*/

/*** Added to print the Previous Results Comments ***/

int result_prv_comments_yn()
{
	 if (strlen(d_comm_prv_result1.arr) || strlen(d_comm_prv_result2.arr) ||
	     strlen(d_comm_prv_result3.arr) || strlen(d_comm_prv_result4.arr) ||
		 strlen(d_comm_prv_result_desc1.arr) || strlen(d_comm_prv_result_desc2.arr) ||
		 strlen(d_comm_prv_result_desc3.arr) || strlen(d_comm_prv_result_desc4.arr))
         {
		 return 1;
		 }
	 else
	     return 0;	 	
}

int result_prv_comments_1_yn()
{
	if (strlen(d_comm_prv_result_desc1.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
int result_prv_comments_2_yn()
{
	if (strlen(d_comm_prv_result_desc2.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
int result_prv_comments_3_yn()
{
	if (strlen(d_comm_prv_result_desc3.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}
int result_prv_comments_4_yn()
{
	if (strlen(d_comm_prv_result_desc4.arr))
	 {
	  return 1;
	 }
	else
	  return 0;
}