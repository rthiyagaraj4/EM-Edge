/************************************************************************/
/* OCS MEDICOM VER 1.6                                                  */
/************************************************************************/
/* PROGRAM NAME          : RLRSENQ3                                     */
/* DESCRIPTION		     : Test Results report 					        */
/* AUTHOR                : S. Sheelvant                                 */
/* DATE WRITTEN          : 11-SEP-1998                                  */
/* MODIFIED BY           : S.SHEELVANT 						            */
/* MODIFIED ON		     : 12-DEC-1998                                  */
/* Last Modified by      : HAMEED - For eHIS upgrade					*/
/* Last Modified by      : Srinivas - For enhancements     				*/
/************************************************************************/

#include <stdio.h>      
#include <string.h>
#include <process.h> 
#include "rl.h"
#define NODATAFOUND				(sqlca.sqlcode == 1403)
#define OERROR 					(sqlca.sqlcode < 0)
#define LAST_ROW                (sqlca.sqlcode == 1403)
#define NOT_FOUND 				(sqlca.sqlerrd[2] == 0)
#define TABLE_ALREADY_EXISTS	(sqlca.sqlcode == -955)
#define RESOURCE_BUSY			(sqlca.sqlcode == -54)    

#define VIEW_LOG_FILE 1
#define ONLINE_PRINTING 1
#define RESTART_INTERVAL 2
#define RESTART_TIME 500
#define INIT_MESG ""

#define SPOOL_DIR			""	
#define ESC 0x1B
#define SEP 0xFA   

#define MAX_ORGANISMS	100

EXEC SQL BEGIN DECLARE SECTION;

#define MAX_ANTIBIOTICS	1000


   VARCHAR nd_operating_facility_id         [5],
		   nd_facility_id					[5],
   		   nd_priority						[5],
           uid_pwd                          [132],
           d_curr_pgm_name                  [15],
           nd_file_name                     [151],
           nd_file_name_fax                 [151],
		   today			                [20],
           nd_file_no                       [15];

   VARCHAR s_org							[MAX_ANTIBIOTICS][5],
           s_ant							[MAX_ANTIBIOTICS][5],
           s_ind							[MAX_ANTIBIOTICS][2];

   VARCHAR nd_hosp_no                       [21],	 /* Patient ID */
           nd_spec_no                       [21],
           nd_cntrl_rowid                   [31],

		   nd_rowid							[31],

		   nd_result_printed_date			[21],
	       er_msg                           [71],
		   er_msg_num						[10],
   
             c_req_dtl_test_code              [11],/* Used in */ 
             c_group_test_yn                  [2],/* Update_rl_request_detail*/
             c_count                          [3],/*-----*/
             c_spec_no                        [21],

             p_print_name_yn                  [2],
             p_test_desc                      [41],
             p_function_yn                    [2], 

             rl_lab_title                     [101],
			 rl_lab_title_2					  [201],
			 rl_lab_title_3					  [201],
			 rl_lab_title_4					  [201],
			 rl_lab_title_5					  [201],
			 rl_actual_dob_yn				  [2], 
			 rl_race_code					  [11],
			 rl_report_format				  [3],
			 rl_age_years					  [3], 
			 rl_location					  [21], 
			 d_race_desc					  [31], 
			 d_clinical_text_code			  [5],
			 d_clinical_text				  [4001],
			 d_clinical_spec_no				  [21], 
			 rl_test_requested_yn			  [2],
			 d_inhibit_yn					  [2],
			 inhibit_test_code				  [11], 
			 rl_message_line				  [500],
			 rl_name_on_report_yn			  [2],
			 rl_footer_line_1				  [500],
			 rl_footer_line_2				  [500],
			 rl_category_code				  [5],
			 rl_category_year				  [5],
			 rl_category_number				  [21], 
			 rl_ordered_facility_id			  [3],
			 v_test_code					  [11],
			 rl_high_low_ind			      [10],
			 rl_cancelled_yn				  [2],
			 can_spec_no					  [21],
			 can_group_test					  [11],
			 can_test_name					  [41], 
			 can_test_code				      [11],
			 cancel_reason					  [41],
			 print_name_yn					  [2],
			 first_user						  [31],
			 rl_released_by_id				  [31],
			 p_user_id						  [31],
			 rl_released_date				  [17],
			 v_numeric_result				  [21],
			 sy_user						  [31],
			 sy_user_name					  [50],

             or_order_date_time             [17],

			rl_print_result_sect_yn			[2],
			rl_section_tel_num				[16],

           rl_hdr_source_code               [11],
           rl_hdr_consultant_code           [16],
           rl_hdr_spec_recd_date_time       [17],
           rl_hdr_spec_regd_date_time       [17],
  	       rl_hdr_spec_colltd_date_time     [17],
           rl_hdr_current_date_time         [17],
           rl_hdr_section_code              [2],
           rl_hdr_request_comment_code1     [5],
           rl_hdr_request_comment_code2     [5],
           rl_hdr_request_comment_code3     [5],
           rl_hdr_request_comment_desc1     [41],
           rl_hdr_request_comment_desc2     [41],
           rl_hdr_request_comment_desc3     [41],
           rl_hdr_extra_copies_to           [16],
           rl_hdr_specimen_type_code        [5],
           rl_hdr_added_by_id               [31],
           rl_hdr_added_date                [16],
           rl_hdr_modified_by_id            [31],
           rl_hdr_modified_date             [16],
 	       rl_hdr_episode_type		    [2],
 	       rl_hdr_urgent_indicator	    [2],
		   rl_hdr_source_type		    [2],
		   rl_hdr_released_by_id		[31],
		   rl_hdr_released_date			[21],

           rl_dtl_test_code_reqd	    [11],
           rl_dtl_test_code                 [7][11],
           rl_dtl_result_status             [7][2],
           rl_dtl_group_test_flag           [7][2],

           rl_tst_group_test_code           [11],
           rl_tst_test_code                 [11],
           rl_tst_numeric_prefix            [2],
           rl_tst_numeric_result            [16],
           rl_tst_result_comment_desc1      [41],
           rl_tst_result_comment_desc2      [41],
           rl_tst_result_comment_desc3      [41],
           rl_tst_result_comment_desc4      [41],
           rl_tst_rowid                     [31],
		   rl_tst_hide_rslt_comm_yn			[2],

           rl_loc_test_code                 [11],
           rl_loc_long_desc                 [41],

	       rl_pat_title                     [9],
           rl_pat_long_name                 [61],
           rl_pat_short_name                [61],
           rl_pat_sex                       [2],
           rl_pat_nationality               [4],
           rl_pat_dob_no_of_days            [10],
           rl_pat_date_of_birth             [16],
	       rl_pat_actual_id                 [31],
           rl_pat_blood_group               [3],
           rl_pat_g6pd                      [11],
           rl_pat_sicc                      [11],
           rl_pat_hbl4_1                    [11],
           rl_pat_hbl4_2                    [11],

           rl_spc_specimen_desc             [41],

           rl_source_short_name             [41],    	 /* long name */
           rl_consultant_short_name         [41], 	 /* long name */
           rl_section_short_name            [41],  

           rl_tst_cd_short_desc             [41],
           rl_tst_cd_numeric_result_yn      [2],
           rl_tst_cd_age_sex_range_yn       [2],
           rl_tst_cd_function_yn            [2],
           rl_tst_cd_print_report_yn        [2],
           rl_tst_cd_low_value_normal       [16],
           rl_tst_cd_high_value_normal      [16],
           rl_tst_cd_result_name_text       [11],
           rl_tst_cd_group_test_yn          [2],
           rl_tst_cd_text_block_yn          [2],
           rl_tst_cd_culture_test_yn        [2],
           rl_tst_cd_snomed_yn              [2],
           rl_tst_cd_test_units             [11],
		   rl_tst_cd_test_units_2           [11],
           rl_tst_cd_range_cmt              [41],
		   rl_tst_cd_range_cmt_2            [41],
		   rl_tst_cd_inh_rep_yn				[2],
		   rl_tst_cd_conf_yn				[2],

		   rl_tst_ran_low_val_nor    [16],
           rl_tst_ran_high_val_nor   [16],
		
		   l_low_val				 [16],
		   l_high_val				 [16],
           rl_tst_rng_lvn            [16],
           rl_tst_rng_hvn            [16],

           rl_comm_tst_comm_txt      [41],

		   rl_res_modify_reason		 [41],
		   rl_modify_reason_rel_by   [31],
		   rl_modify_reason_rel_dt   [31],

           rl_res_result_text				[2000],

           rl_func_operand_1                [11],
           rl_func_operand_1_type           [2],
           rl_func_operator_1               [2],
           rl_func_operand_2                [11],
           rl_func_operand_2_type           [2],
           rl_func_operator_2               [2],
  
           rl_func_value                    [16],

           rl_calc_str                      [400],
           rl_func_str                      [400],

           rl_res_organism_code             [5],
           rl_res_comment_desc              [41],

           rl_res_organism_code_desc        [41],

		   d_user_id_pwd					[91],

		   rl_res_dtl_organism_code			[5],
           rl_res_dtl_antibiotic_code       [5],
           rl_res_dtl_antibiotic_desc       [41],
           rl_res_dtl_sensitivity_ind       [2],
	   
	      // sy_acc_entity_name 		        [81],
		   sy_acc_entity_name 		        [300],
           rl_res_snomed_code               [21],
		   rl_res_snomed_code2				[21],
           
		   rl_prn_ctrl_hdr_pat_no	        [16],
		   rl_prn_ctrl_hdr_sp_no	        [21],
	       rl_prn_ctrl_hdr_source_code	    [11],
	       rl_prn_ctrl_hdr_user		        [21],
	       rl_prn_ctrl_hdr_section_code	    [2],
           rl_prn_ctrl_hdr_rp_yn            [2],

	       rl_snomed_desc1                  [301],
           rl_snomed_desc2                  [41],
           rl_snomed_desc3                  [41],
           rl_snomed_desc4                  [41],
           rl_snomed_desc5                  [41],
           rl_snomed_print_yn               [2],
           rl_snomed2_desc1                  [301],
           rl_snomed2_desc2                  [41],
           rl_snomed2_desc3                  [41],
           rl_snomed2_desc4                  [41],
           rl_snomed2_desc5                  [41],
           rl_snomed2_print_yn               [2],
		   r_rslt							 [20], 


  	       d_loc_str 			    [20], 
  	       d_l_str 					[20], 
  	       d_dec_part			    [20],
  	       d_int_part			    [20],
  	       d_sig_part			    [20],

		   a_antibiotic_code		[5],

		   d_sleep_secs		[10],
		   d_machine_name   [40],
		   d_started_by_id  [31],
		   
		   sy_user_id			[31],
           sy_session_id		[30],
           sy_req_date			[30],
		   sy_machine_name      [16],
           sy_ws_no             [15],
		   sy_rowid				[31],
           
		   p_uid_pwd            [151], 
		   p_print_name         [100], 
		   p_loc_type           [10],
           p_loc_code           [100],
		   p_rep_file           [151],
		   p_rep_file_fax       [151],
		   p_rep_file_fax_ext   [151],
		   p_print_mode         [10],
		   
		   p_param7				        [2],
		   prg_start_date		        [30],
		   d_next_start_date            [30],
		   d_cmd_line                   [200],

		   l_print_disch_pat_result     [2],
		   rl_printer_for_urgent_yn		[2],
		   rl_print_inpatient_yn		[2],
		   rl_print_outpatient_yn		[2],
		   rl_print_referral_yn			[2],
		   rl_print_external_yn			[2],

		   l_rep_disch_pat_result		[2],
		   rl_rep_inpatient_yn			[2],
		   rl_rep_outpatient_yn			[2],
		   rl_rep_referral_yn			[2],
		   rl_rep_external_yn			[2],

		   l_fax_disch_pat_result		[2],
		   rl_fax_inpatient_yn			[2],
		   rl_fax_outpatient_yn			[2],
		   rl_fax_referral_yn			[2],
		   rl_fax_external_yn			[2],

		   l_command_line				[225],

		   nd_status					[2],
		   d_specimen_no				[21],
		   d_group_test_code			[11],
		   d_test_code					[11],
		   d_no							[21],
		   p_param8						[2],
		   actual_specimen				[21],
		   interval_description			[41],
		   first_specimen_no			[21],
		   sql_stmt						[2000];
       int l_count = 0; /* To get count */
	   int i_count = 0, u_count = 0, l_seq_no = 0;

       int no_of_dtl_recs = 0,
		   d_time_interval =0,
		   d_starting_time =0,
           rl_tst_cd_no_of_decimals = 0,
	       sy_ref_no_of_copies = 0,
           rl_tst_cd_significant_digit = 0, 
   	       p_significant_digit,
   	       p_no_of_decimals,  
           er_msg_type = 0,
  	       d_dec_pos = 0,
           d_after_sig_digit = 0;

   int     page_length = 0;

   int l_low = 0, l_high = 0;

   long l_episode = 0;

   int l_restart_time = 0;

   int d_seq_no = 0, rl_seq_no = 0;
   int l_exist_decimals = 0;
   int l_inst_decimals = 0;

   int signif;


		/*  For Patient Age SYSDATE, MTHS */
   VARCHAR  tday				[30],
			t_days				[30],
			mths				[30],
			mths1				[30],
			t_age				[30],
			rl_regd_date		[11];

/*********** NEWLY ADDED FOR KNDV LAB ENHANCEMENTS OF SNOMED CODE TO PRINT Y/N**********/
VARCHAR		 rl_print_snomed_code_yn		  [2],
			 rl_print_snomed2_code_yn		  [2],
			 d_found						  [2];

	float mt;

/*********** NEWLY ADDED (23/12/2002) FOR KNDV LAB ENHANCEMENTS of PRINT PENDING BY SOURCE**********/
	VARCHAR	c_session_id					[50],
		    c_pgm_date						[21],
			nd_trx_ind						[2],
			c_pgm_type						[2],
			c_user_id						[50],
			c_next_start_date				[21];

	int		v_count = 0;

/***** FOR QATAR **********/
   VARCHAR 		   nd_new_medicom_no			[21];

/***** FOR MAFRAQ **********/
    VARCHAR		  rl_health_card_num            [15],
				  rl_health_num				    [15],
				  l_print_health_card_yn         [2],
				  rl_health_exp_date		    [20];


	VARCHAR		rl_alt_id_for_pat_id		    [51],
	            test_desc_fill_for_report        [2],
				rl_hmc_no						[31];

	  int other_than_comments = 0;

EXEC SQL END DECLARE SECTION;

EXEC SQL INCLUDE SQLCA.H;
EXEC SQL INCLUDE SQLDA.H;

#include<winproc.h>

FILE *fp;
int  status_prn   = 0, pgm_flg  = 0,tst_cd_ind = 1,  err_flag = 0;
int copy = 0;
int numeric_value_flag = FALSE;
int  MAX_LINES = 27;

char nd_repo_file_name[151], extra_file_name[151], lab_file_name[151];

char prev_group_test [11],
     rl_curr_status  [4];

int i = 0, rec_ctr = 0, lctr = 0, pctr = 0, 
    spc_first = 0,    ind_test_prn   = 0,
    group_printed = 0, group = 0,print_c_hist = 0,
    test_printed = 0, test_result_found = 0,
    source_copies = 0, local_copies = 0;

DWORD sleep_sec = 0;

char text_line[100], test_description[41], nd_e_name[151], nd_f_name[151];

char *to_day();

int no_of_sensitivities = 0;
int something_to_print = 0;
int qq = 0, cntr = 0, z = 0, hell = 0, clt = 0, cmp = 0, t_rue = 0;

int last_page = 0;

char word1[2];
char string_var[200];
char err_num[10];
/****** ADDED FOR GTT SPECIMENS ************/
char l_should_print_yn = 'N';
char nd_test_code[11];
char d_interval_specimen_yn = 'N';

char l_numeric_result[30];

char footer_released_date[20];

int request_count = 0;

char l_destn_rep_yn;
char l_destn_fax_yn;
//char l_command_line[225];
char g_facility_id[50];

void proc_main(argc,argv)
char *argv[];
int argc;
{
   int rec_found = 0;     

   if (argc < 6)
   {
      disp_message(ERR_MESG,"Usage : rlrsenq3 uid/password ");
      proc_exit();
   }

   strcpy(d_user_id_pwd.arr,argv[1]);
   d_user_id_pwd.len = strlen(d_user_id_pwd.arr);

   strcpy(c_session_id.arr, argv[2]);
   c_session_id.len = strlen(c_session_id.arr);

   strcpy(c_session_id.arr, argv[3]);
   c_session_id.len = strlen(c_session_id.arr);

   strcpy(nd_facility_id.arr, argv[4]);
   nd_facility_id.len = strlen(nd_facility_id.arr);

   strcpy(g_facility_id, nd_facility_id.arr);

   
   strcpy(nd_priority.arr, argv[5]);
   nd_priority.len = strlen(nd_priority.arr);

   if (argc == 8)
   { 


/****************** commented and moved to above  23.06.2003	
		strcpy(c_session_id.arr, argv[3]);
		c_session_id.len = strlen(c_session_id.arr);
********************************/

		strcpy(c_user_id.arr, argv[6]);
		c_user_id.len = strlen(c_user_id.arr);

		strcpy(c_pgm_type.arr, argv[7]);
		c_pgm_type.len = strlen(c_pgm_type.arr);
	}

	strcpy(g_pgm_id,"RLRSENQ3");
	strcpy(d_curr_pgm_name.arr,g_pgm_id); 


   if(sql_connect(argv[1]) == -1)
   {
      ins_message(ORA_MESG,"Error in connecting to Oracle");
      proc_exit();
   }

   set_meduser_role();

   if (strcmp(c_pgm_type.arr, "R") == 0)
   {

	  process_rec1();
	  delete_error_record();

   }
   else if (strcmp(c_pgm_type.arr, "F") == 0)
   {

      patch_sy_table();  
   }
   else
   {

	  process_rec(); 
   }


   EXEC SQL COMMIT WORK RELEASE;


   if (OERROR)
     ins_message(ORA_MESG,"ROLLBACK WORK RELEASE failed");
   return;
}
/*----------------------------------------------------*/
/*************************** this is not required
get_restart_time()
{
    
	 l_restart_time = 0;

     EXEC SQL SELECT NVL(TO_NUMBER(TO_CHAR(restart_time, 'HH24MI')), 500)
     INTO :l_restart_time
	 FROM RL_PARAM;
  
     if (OERROR)
        ins_message(ORA_MESG,"Error Found in RL_PARAM 2");

	  if(NOT_FOUND) 
         ins_message(ORA_MESG,"Select failed on RL_PARAM 2 --> No Data Found");  


 }
 **************************/
/*------------------------------------------------------*/
 /*------------------------------------------------------*/
 
 get_len_from_param()
 {

     page_length = 0;

     l_print_disch_pat_result.arr[0]                = '\0';
	 rl_print_inpatient_yn.arr[0]					= '\0';
	 rl_print_outpatient_yn.arr[0]					= '\0';
	 rl_print_referral_yn.arr[0]					= '\0';
	 rl_print_external_yn.arr[0]					= '\0';

     l_rep_disch_pat_result.arr[0]					= '\0';
	 rl_rep_inpatient_yn.arr[0]						= '\0';
	 rl_rep_outpatient_yn.arr[0]					= '\0';
	 rl_rep_referral_yn.arr[0]						= '\0';
	 rl_rep_external_yn.arr[0]						= '\0';

     l_fax_disch_pat_result.arr[0]					= '\0';
	 rl_fax_inpatient_yn.arr[0]						= '\0';
	 rl_fax_outpatient_yn.arr[0]					= '\0';
	 rl_fax_referral_yn.arr[0]						= '\0';
	 rl_fax_external_yn.arr[0]						= '\0';

	 rl_report_format.arr[0]						= '\0';
	 rl_alt_id_for_pat_id.arr[0]					= '\0';

     l_print_disch_pat_result.len                   = 0;
	 rl_print_inpatient_yn.len						= 0;
	 rl_print_outpatient_yn.len						= 0;
	 rl_print_referral_yn.len						= 0;
	 rl_print_external_yn.len						= 0;

     l_rep_disch_pat_result.len						= 0;
	 rl_rep_inpatient_yn.len						= 0;
	 rl_rep_outpatient_yn.len						= 0;
	 rl_rep_referral_yn.len							= 0;
	 rl_rep_external_yn.len							= 0;

     l_fax_disch_pat_result.len						= 0;
	 rl_fax_inpatient_yn.len						= 0;
	 rl_fax_outpatient_yn.len						= 0;
	 rl_fax_referral_yn.len							= 0;
	 rl_fax_external_yn.len							= 0;

	 rl_report_format.len							= 0;
	 rl_alt_id_for_pat_id.len						= 0;

     l_print_health_card_yn.arr[0]                = '\0';
     l_print_health_card_yn.len                   = 0;

     test_desc_fill_for_report.arr[0]		= '\0';
	 test_desc_fill_for_report.len			= 0;

/********************* 22.06.2003 
     EXEC SQL SELECT result_rep_pg_len, NVL(print_disch_pat_result_yn, 'N'),
					NVL(print_inpatient_yn, 'N'), NVL(print_outpatient_yn, 'N'), 
					NVL(print_referral_yn, 'N'), NVL(print_external_yn, 'N'),
					NVL(report_format, '1'), NVL(print_health_card_yn, 'N')
			  INTO :page_length, :l_print_disch_pat_result,
				   :rl_print_inpatient_yn, :rl_print_outpatient_yn,
				   :rl_print_referral_yn, :rl_print_external_yn,
				   :rl_report_format, :l_print_health_card_yn 
			  FROM RL_PARAM;
********************/

     EXEC SQL SELECT NVL(report_format, '1'), NVL(print_health_card_yn, 'N'), test_desc_fill_for_report
			  INTO  :rl_report_format, :l_print_health_card_yn , :test_desc_fill_for_report
			  FROM   RL_PARAM;

     if (OERROR)
        ins_message(ORA_MESG,"Error Found in RL_PARAM");

	  if(NOT_FOUND) 
         ins_message(ORA_MESG,"Select failed on RL_PARAM --> No Data Found");

     {
		 EXEC SQL SELECT nvl(a.result_rep_pg_len,b.result_rep_pg_len),
	 					 nvl(a.print_disch_pat_result_yn,b.print_disch_pat_result_yn), 
						 nvl(a.print_inpatient_yn,b.print_inpatient_yn),
						 nvl(a.print_outpatient_yn,b.print_outpatient_yn),
						 nvl(a.print_referral_yn,b.print_referral_yn),
						 nvl(a.print_external_yn,b.print_external_yn),
						 NVL(B.mapped_alt_id_for_pat_id, '!'),

	 					 nvl(a.REP_PRINT_FOR_DISCH_YN,b.REP_PRINT_FOR_DISCH_YN), 
						 nvl(a.rep_inpatient_yn,b.rep_inpatient_yn),
						 nvl(a.rep_outpatient_yn,b.rep_outpatient_yn),
						 nvl(a.rep_referral_yn,b.rep_referral_yn),
						 nvl(a.rep_external_yn,b.rep_external_yn),

	 					 nvl(a.FAX_FOR_DISCH_YN,b.FAX_FOR_DISCH_YN), 
						 nvl(a.fax_inpatient_yn,b.fax_inpatient_yn),
						 nvl(a.fax_outpatient_yn,b.fax_outpatient_yn),
						 nvl(a.fax_referral_yn,b.fax_referral_yn),
						 nvl(a.fax_external_yn,b.fax_external_yn)
				  INTO  :page_length, :l_print_disch_pat_result,
					    :rl_print_inpatient_yn, :rl_print_outpatient_yn,
					    :rl_print_referral_yn, :rl_print_external_yn,
						:rl_alt_id_for_pat_id,

						:l_rep_disch_pat_result,
					    :rl_rep_inpatient_yn, :rl_rep_outpatient_yn,
					    :rl_rep_referral_yn, :rl_rep_external_yn,

						:l_fax_disch_pat_result,
					    :rl_fax_inpatient_yn, :rl_fax_outpatient_yn,
					    :rl_fax_referral_yn, :rl_fax_external_yn
				  FROM   RL_PARAM_FOR_FACILITY A , RL_PARAM B
				  WHERE  OPERATING_FACILITY_ID = :nd_operating_facility_id;

 		 if(NODATAFOUND)
		 {
		 EXEC SQL SELECT result_rep_pg_len, NVL(print_disch_pat_result_yn, 'N'),
						NVL(print_inpatient_yn, 'N'), NVL(print_outpatient_yn, 'N'), 
						NVL(print_referral_yn, 'N'), NVL(print_external_yn, 'N'),
						NVL(mapped_alt_id_for_pat_id, '!'),

	 					 nvl(REP_PRINT_FOR_DISCH_YN,'N'), 
						 nvl(rep_inpatient_yn,'N'),
						 nvl(rep_outpatient_yn,'N'),
						 nvl(rep_referral_yn,'N'),
						 nvl(rep_external_yn,'N'),

	 					 nvl(FAX_FOR_DISCH_YN,'N'), 
						 nvl(fax_inpatient_yn,'N'),
						 nvl(fax_outpatient_yn,'N'),
						 nvl(fax_referral_yn,'N'),
						 nvl(fax_external_yn,'N')
				  INTO :page_length, :l_print_disch_pat_result,
					   :rl_print_inpatient_yn, :rl_print_outpatient_yn,
					   :rl_print_referral_yn, :rl_print_external_yn,
					   :rl_alt_id_for_pat_id,

						:l_rep_disch_pat_result,
					    :rl_rep_inpatient_yn, :rl_rep_outpatient_yn,
					    :rl_rep_referral_yn, :rl_rep_external_yn,

						:l_fax_disch_pat_result,
					    :rl_fax_inpatient_yn, :rl_fax_outpatient_yn,
					    :rl_fax_referral_yn, :rl_fax_external_yn
				  FROM RL_PARAM;
		 }

     }

     if (OERROR)
        ins_message(ORA_MESG,"Error Found in RL_PARAM");

	  if(NOT_FOUND) 
         ins_message(ORA_MESG,"Select failed on RL_PARAM --> No Data Found");

	 l_print_disch_pat_result.arr[l_print_disch_pat_result.len]      = '\0';
	 rl_print_inpatient_yn.arr[rl_print_inpatient_yn.len]			 = '\0';
	 rl_print_outpatient_yn.arr[rl_print_outpatient_yn.len]			 = '\0';
	 rl_print_referral_yn.arr[rl_print_referral_yn.len]				 = '\0';
	 rl_print_external_yn.arr[rl_print_external_yn.len]				 = '\0';

	 l_rep_disch_pat_result.arr[l_rep_disch_pat_result.len]      = '\0';
	 rl_rep_inpatient_yn.arr[rl_rep_inpatient_yn.len]			 = '\0';
	 rl_rep_outpatient_yn.arr[rl_rep_outpatient_yn.len]			 = '\0';
	 rl_rep_referral_yn.arr[rl_rep_referral_yn.len]				 = '\0';
	 rl_rep_external_yn.arr[rl_rep_external_yn.len]				 = '\0';

	 l_fax_disch_pat_result.arr[l_fax_disch_pat_result.len]      = '\0';
	 rl_fax_inpatient_yn.arr[rl_fax_inpatient_yn.len]			 = '\0';
	 rl_fax_outpatient_yn.arr[rl_fax_outpatient_yn.len]			 = '\0';
	 rl_fax_referral_yn.arr[rl_fax_referral_yn.len]				 = '\0';
	 rl_fax_external_yn.arr[rl_fax_external_yn.len]				 = '\0';

	 rl_report_format.arr[rl_report_format.len]						 = '\0';
	 l_print_health_card_yn.arr[l_print_health_card_yn.len]			 = '\0';
	 rl_alt_id_for_pat_id.arr[rl_alt_id_for_pat_id.len]				 = '\0';
	 test_desc_fill_for_report.arr[test_desc_fill_for_report.len]	 = '\0';


 }

/*----------------------------------------------------------*/
/******************************* 22.06.2003 this is not required
get_sleep_secs()
{
    d_sleep_secs.arr[0] = '\0';
	d_machine_name.arr[0] = '\0';
	d_started_by_id.arr[0] = '\0';
	d_next_start_date.arr[0]='\0';

	d_sleep_secs.len		= 0;
	d_machine_name.len		= 0;
	d_started_by_id.len		= 0;
	d_next_start_date.len	= 0;

	_flushall();

	get_restart_time(); 	

    EXEC SQL  SELECT	processing_interval ,
						floor((sysdate-started_date)*24*60),
						machine_name,
						started_by_id,
						to_char(sysdate,'ddmmyyyyhh24miss'),
						to_number(to_char(sysdate,'hh24mi'))
				INTO	:d_sleep_secs,
						:d_time_interval,
						:d_machine_name,
						:d_started_by_id,
						:d_next_start_date,
						:d_starting_time
				FROM	SY_BG_PROCESS_CONTROL
				WHERE	PGM_ID = 'RLRSENQ3'
				AND		STARTED_DATE IS NOT NULL
				AND		STARTED_DATE = TO_DATE(:prg_start_date,	'DDMMYYHH24MISS');

    d_sleep_secs.arr[d_sleep_secs.len] = '\0';
	d_machine_name.arr[d_machine_name.len] = '\0';
	d_started_by_id.arr[d_started_by_id.len] = '\0';
	d_next_start_date.arr[d_next_start_date.len]='\0';

    
//     if((d_time_interval > RESTART_INTERVAL) && (d_starting_time == RESTART_TIME))

//	if (((d_time_interval > RESTART_INTERVAL) && (d_starting_time == l_restart_time)) || request_count > 25)

	if ((d_time_interval > RESTART_INTERVAL) && (d_starting_time == l_restart_time))
	{
		
		request_count = 1;
	    
		{
////////////////// the below sql commented old
	     EXEC SQL
			INSERT INTO SY_BG_PROCESS_CONTROL
			VALUES(	
			        :nd_operating_facility_id,
					'RL',
					'RLRSENQ3',
					'Lab Print Server',
					:d_machine_name,
					:d_started_by_id,
					TO_DATE(:d_next_start_date, 'ddmmyyyyhh24miss'),
					3000,
					'Y');
////////////////// upto here
	     EXEC SQL
			INSERT INTO SY_BG_PROCESS_CONTROL
			VALUES(	
			        :nd_operating_facility_id,
					'RLRSENQ3',
					:d_machine_name,
					:d_started_by_id,
					TO_DATE(:d_next_start_date, 'ddmmyyyyhh24miss'),
					'Y',
					 '~~');

		  if (OERROR)
		  {
					disp_message(ORA_MESG,"insert failed");  
		  }
 
		}

		EXEC SQL
			DELETE FROM SY_BG_PROCESS_CONTROL 
				WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND PGM_ID='RLRSENQ3'
				AND STARTED_DATE IS NOT NULL
				AND STARTED_DATE=TO_DATE(:prg_start_date,
		                           'DDMMYYHH24MISS');

    	EXEC SQL COMMIT;


		d_cmd_line.arr[0] = '\0';

        strcat(d_cmd_line.arr,"RLRSENQ3");
		strcat(d_cmd_line.arr," ");
		strcat(d_cmd_line.arr,d_user_id_pwd.arr);
		strcat(d_cmd_line.arr," ");
		strcat(d_cmd_line.arr,d_next_start_date.arr);


		d_cmd_line.arr[strlen(d_cmd_line.arr)] = '\0';		
/////// IN WINDOWS 2000 SYSTEM COMMAND WILL NOT GIVE BACK THE CONTROL ////////	
//		system(d_cmd_line.arr);

		WinExec(d_cmd_line.arr, SW_SHOWNORMAL);	        
        exit(0);

		
	}

	if(NOT_FOUND) 
	{
		  return FALSE;
	}
	else 
	{
		d_sleep_secs.arr[d_sleep_secs.len] = '\0';
        sleep_sec = (DWORD) atol(d_sleep_secs.arr);  
	    return TRUE;
	}    
}
**********************************/

/*----------------------------------------------------------*/
char *to_day()
{

today.arr[0]	= '\0';
today.len	= 0;

EXEC SQL SELECT 	to_char(SYSDATE,'DD/MM/YYYY HH24:MI')
	   INTO		:today
	   FROM		DUAL;

   if (OERROR)
     ins_message(ORA_MESG,"Select failed on DUAL in to_day() ");

today.arr[today.len]	= '\0';
return (today.arr);
}
/*----------------------------------------------------------*/
process_rec1()
{  
   int i = 0;
   int j = 0,corr_stat = 0;
   int sy_prg_param_found =0;
   int record_exist = 0;
   char test[11],group_test[11];
   _flushall();

   request_count = 1;

	declare_curs();

	declare_param_curs();

	while(fetch_param_curs())
	{
	      get_len_from_param();

		  if (strcmp(rl_report_format.arr, "1") == 0)
			  MAX_LINES = (page_length - 5) ; 
		  else
			  MAX_LINES = (page_length - 7) ; 

		  l_should_print_yn = 'N';
		  d_interval_specimen_yn = 'N';

//		  if(fetch_sy_prog_param())
		  if(fetch_sy_requests())
		  {
			 err_flag = 0;
             lctr = 0;
             pctr = 0;
             rec_ctr = 0;
	         copy = 0;

			strcpy(actual_specimen.arr, nd_spec_no.arr);
		 	actual_specimen.len = strlen(actual_specimen.arr);

			 if (p_param8.arr[0] == 'P')
			 {
				strcpy(nd_status.arr, "P");
				nd_status.len = strlen(nd_status.arr);
			 }
			 else
			 {
				strcpy(nd_status.arr, "R");
				nd_status.len = strlen(nd_status.arr);
			 }
			 
			 build_table();

			 build_cancelled_tests();

			 declare_tst_result_curs();
			 strcpy(nd_test_code, "");

  		     something_to_print = 0;  
			 other_than_comments = 0;
		
		if (l_should_print_yn == 'Y')
		{

             open_hdr();
			 _flushall();

             while (fetch_hdr() && err_flag == 0)
             {   
				 _flushall();

				 gen_file_name1();

				 print_c_hist = 0;
			     get_departmental_parameters();
                 source_copies = 0;
                 local_copies = 0;
	             strcpy(c_spec_no.arr,nd_spec_no.arr);
                 c_spec_no.len = strlen(nd_spec_no.arr);
                 fetch_other_dtls();
                 fetch_dtl();
                 while(TRUE)
                 {
                     copy++;
					 open_tst_result_curs();

					 strcpy(prev_group_test,"");
                     rec_ctr = 0;
                     fflush(fp);

	                 i = fetch_tst_result();

	                 if(i)
					 {
                       
					   last_page = 0;
					   strcpy(first_user.arr, rl_released_by_id.arr);
					   first_user.len = strlen(first_user.arr);

					   strcpy(footer_released_date, rl_released_date.arr);

					 }

					   if (strcmp(rl_report_format.arr, "1") == 0)
					   {
//qatar
							print_header();
						}
					   else if (strcmp(rl_report_format.arr, "2") == 0)
					   {
//kn
							print_header2();
					   }
					   else
					   {
//mf & su
							print_header3();
					   }

						
					   _flushall();

					 set_printed_date_time();

                     while (i && err_flag == 0)
                     {

	                     group_printed = 0;
	                     group = 0;
                         strcpy(group_test, rl_tst_group_test_code.arr);
                         strcpy(test,rl_tst_test_code.arr);
	                     if(strcmp(group_test,test) !=0)
  		                    group = 1;
                         while(i && strcmp(group_test,rl_tst_group_test_code.arr)==0 && err_flag == 0)
	                     {  

			 	             strcpy(c_spec_no.arr,nd_spec_no.arr);
			                 c_spec_no.len = strlen(c_spec_no.arr);

		                     test_printed = 0;
                             rec_ctr ++;

                             print_dtls();


                            // update_tst_result();
 							// update_interval_specimen();
						    // update_rl_request_detail();
							// update_rl_request_header();

                             i = fetch_tst_result();

							 other_than_comments = 0;
                         }
                      }
                      
                      if (rec_ctr && err_flag == 0)
                      {
						   print_cancelled_tests();

                          for (i=lctr;i<=MAX_LINES;i++)
                               fprintf(fp,"\n");
                          last_page = 1;

						  if (strcmp(rl_report_format.arr, "1") == 0)
								print_footer(0);
						  else if (strcmp(rl_report_format.arr, "2") == 0)
								print_footer2(0);
						  else
								print_footer3(0);

                      }
/***********************
                      if (rl_hdr_extra_copies_to.len && copy == 1 && err_flag == 0)
	                  {   
					      fclose(fp);  
						  _flushall();
						  strcpy(nd_test_code, "");
   	                      gen_extra_file_name1();
	                      pctr = 0;
	                  }
                      else 
	                      break; 
******************************************/

                   }
   	               fclose(fp); /* Close the Main File if no Extra File,
								   else the Extra File */
			       _flushall();



				   if (err_flag == 0)
				   {
						create_lab_file_name();

						print_job1();
					}
				   _flushall();

				   if(err_flag)
				   {
				      update_sy_bg_rep_gen_req();
					}
				   else
				   {

					  delete_sy_bg_rep_gen_req();
					  delete_sy_prog_param(); 
                   }
                }
			 }
			 else
			 {
  			    delete_sy_bg_rep_gen_req();
			    delete_sy_prog_param();

			 }
                close_all_cur(); 
			
				if(err_flag)
					update_sy_bg_rep_gen_req();

				delete_build_table();

                EXEC SQL COMMIT WORK;

		     }
			 else
			 {
				delete_sy_prog_param();
				EXEC SQL COMMIT WORK;
			 }

			 record_exist = 0;

 	

			 request_count++;

		 _flushall();
		 fflush(NULL);	 
		fflush(stdin);
	}
	close_param_curs();

}
/*------------------------------------------------------------*/
process_rec()
{  
   int i = 0;
   int j = 0,corr_stat = 0;
   int sy_prg_param_found =0;
   int record_exist = 0;
   char test[11],group_test[11];
   _flushall();

   request_count = 1;

	declare_curs();

	while(request_count < 20)
	{

      if(strcmp(nd_priority.arr, "1") == 0)
      {
       record_exist = fetch_sy_urgent();
	   close_urgent_curs();

       if (!record_exist)
	   {
	   	  record_exist = fetch_sy_stat();
		  close_stat_curs();
        }
	   }
	  else if (strcmp(nd_priority.arr, "2") == 0 || strcmp(nd_priority.arr, "3") == 0 )
	  {	   
     	  record_exist = fetch_sy_routine();
          close_routine_curs();
	  }
	  else
	  {
       record_exist = fetch_sy_urgent();
	   close_urgent_curs();

       if (!record_exist)
	   {
	   	  record_exist = fetch_sy_stat();
		  close_stat_curs();
		}

	   if (!record_exist)
	   {
	   	   record_exist = fetch_sy_routine();
	       close_routine_curs();
	   }
      }

	   if (record_exist == 0)
			break;

       while (record_exist)
       {

          get_len_from_param();

		  if (strcmp(rl_report_format.arr, "1") == 0)
			  MAX_LINES = (page_length - 5) ; 
		  else
			  MAX_LINES = (page_length - 7) ; 

		  l_should_print_yn = 'N';
		  d_interval_specimen_yn = 'N';

		  if(fetch_sy_prog_param())
		  {
			 err_flag = 0;
             lctr = 0;
             pctr = 0;
             rec_ctr = 0;
	         copy = 0;
 
 			strcpy(actual_specimen.arr, nd_spec_no.arr);
		 	actual_specimen.len = strlen(actual_specimen.arr);

			 if (p_param8.arr[0] == 'P')
			 {
				strcpy(nd_status.arr, "P");
				nd_status.len = strlen(nd_status.arr);
			 }
			 else
			 {
				strcpy(nd_status.arr, "R");
				nd_status.len = strlen(nd_status.arr);
			 }

			 build_table();

			 build_cancelled_tests();

			 declare_tst_result_curs();
			 strcpy(nd_test_code, "");

  		     something_to_print = 0;  
			 other_than_comments = 0;

		if (l_should_print_yn == 'Y')
		{
             open_hdr();
			 _flushall();

             while (fetch_hdr() && err_flag == 0)
             {   
				 _flushall();  

				 gen_file_name();
				 print_c_hist = 0;
			     get_departmental_parameters();
                 source_copies = 0;
                 local_copies = 0;
	             strcpy(c_spec_no.arr,nd_spec_no.arr);
                 c_spec_no.len = strlen(nd_spec_no.arr);
                 fetch_other_dtls();
                 fetch_dtl();

                 while(TRUE)
                 {

                     copy++;
					 open_tst_result_curs();

					 strcpy(prev_group_test,"");
                     rec_ctr = 0;
                     fflush(fp);

	                 i = fetch_tst_result();

	                 if(i)
					 {
                       
					   last_page = 0;
					   strcpy(first_user.arr, rl_released_by_id.arr);
					   first_user.len = strlen(first_user.arr);

					   strcpy(footer_released_date, rl_released_date.arr);

					 }

					   if (strcmp(rl_report_format.arr, "1") == 0)
					   {
//qatar
							print_header();
						}
					   else if (strcmp(rl_report_format.arr, "2") == 0)
					   {
//kn
							print_header2();

					   }
					   else
					   {
//mf & su
							print_header3();
					   }

						
					   _flushall();

					 set_printed_date_time();

                     while (i && err_flag == 0)
                     {

	                     group_printed = 0;
	                     group = 0;

                         strcpy(group_test, rl_tst_group_test_code.arr);
                         strcpy(test,rl_tst_test_code.arr);
	                     if(strcmp(group_test,test) !=0)
  		                    group = 1;
                         while(i && strcmp(group_test,rl_tst_group_test_code.arr)==0 && err_flag == 0)
	                     {  
 
			 	             strcpy(c_spec_no.arr,nd_spec_no.arr);
			                 c_spec_no.len = strlen(c_spec_no.arr);

		                     test_printed = 0;
                             rec_ctr ++;

                             print_dtls();

//                             update_tst_result();
// 							 update_interval_specimen();
//						     update_rl_request_detail();
//							 update_rl_request_header();

                             i = fetch_tst_result();

							 other_than_comments = 0;

                         }
                      }
                      
                      if (rec_ctr && err_flag == 0)
                      {
						   print_cancelled_tests();

                          for (i=lctr;i<=MAX_LINES;i++)
                               fprintf(fp,"\n");
                          last_page = 1;

						  if (strcmp(rl_report_format.arr, "1") == 0)
								print_footer(0);
						  else if (strcmp(rl_report_format.arr, "2") == 0)
								print_footer2(0);
						  else
								print_footer3(0);


                      }
/*********************************
                      if (rl_hdr_extra_copies_to.len && copy == 1 && err_flag == 0)
	                  {   
					      fclose(fp);  
						  _flushall();
						  strcpy(nd_test_code, "");
   	                      gen_extra_file_name();
	                      pctr = 0;
	                  }
                      else 
	                      break; 
*************************************************/
						break; 
                   }
   	               fclose(fp); /* Close the Main File if no Extra File,
								   else the Extra File */
			       _flushall();

				   if (err_flag == 0)
				   {
						create_lab_file_name();

						print_job();
					}
				   _flushall();

				   if(err_flag)
				   {
				      update_sy_bg_rep_gen_req();
					}
				   else
				   {

					  delete_sy_bg_rep_gen_req();
					  delete_sy_prog_param();
                   }

                }
			 }
			 else
			 {
  			    delete_sy_bg_rep_gen_req();
			    delete_sy_prog_param();

			 }
                close_all_cur(); 

				if(err_flag)
					update_sy_bg_rep_gen_req();

				delete_build_table();

                EXEC SQL COMMIT WORK;

		     }
			 else
			 {
				delete_sy_bg_rep_gen_req();
				EXEC SQL COMMIT WORK;
			 }

			 record_exist = 0;

 	

         } 
		 request_count++;
		 break;

		 _flushall();
		 fflush(NULL);	 
		fflush(stdin);
	}

}
/*------------------------------------------------------------*/
update_sy_bg_rep_gen_req()
{
   EXEC SQL UPDATE SY_REPORT_GENERATE_REQUEST
               SET REQUEST_STATUS = 'E'
			 WHERE ROWID = :sy_rowid;
   if(OERROR) 
      ins_message(ERR_MESG,"Failed in upd_sy_bg_rep_gen_req()");       
}
/*------------------------------------------------------------*/
delete_sy_bg_rep_gen_req()
{
   char test[100];
   EXEC SQL DELETE FROM SY_REPORT_GENERATE_REQUEST
             WHERE ROWID = :sy_rowid;
   if(OERROR) 
      ins_message(ERR_MESG,"Failed in delete_sy_bg_rep_gen_req");
}
/*------------------------------------------------------------*/
delete_sy_prog_param()
{

  EXEC SQL DELETE FROM SY_PROG_PARAM
 	         WHERE rowid = :nd_rowid;

   if(OERROR) 
      ins_message(ERR_MESG,"Failed in delete_sy_prog_param");
}

/*------------------------------------------------------------*/

fetch_sy_bg_rep_gen_req_u()
{
sy_user_id.arr[0] 		= '\0';
sy_session_id.arr[0] 	= '\0';
sy_req_date.arr[0]      = '\0';
sy_machine_name.arr[0]  = '\0';
sy_ws_no.arr[0]		    = '\0';
sy_rowid.arr[0]		    = '\0';

sy_session_id.len	    = 0;
sy_user_id.len	        = 0;
sy_req_date.len         = 0;
sy_machine_name.len     = 0;
sy_ws_no.len            = 0;
sy_rowid.len            = 0;

EXEC SQL SELECT
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
	       INTO	
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	PGM_ID = 'RLRSENQ3'
			AND REQUEST_STATUS IS NULL
			AND NVL(URGENT_INDICATOR,' ') = 'U'
	        AND ROWNUM < 2;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      if(NOT_FOUND) 
      	  return FALSE;
      else 
	  {
          sy_user_id.arr[sy_user_id.len] = '\0';
          sy_session_id.arr[sy_session_id.len] = '\0';
          sy_rowid.arr[sy_rowid.len] = '\0';
          sy_req_date.arr[sy_req_date.len] = '\0';
		  sy_machine_name.arr[sy_machine_name.len] = '\0';
		  sy_ws_no.arr[sy_ws_no.len] = '\0';
		  sy_rowid.arr[sy_rowid.len] = '\0';

   	      return TRUE;
	  }
}

fetch_sy_bg_rep_gen_req_s()
{
sy_user_id.arr[0] 		= '\0';
sy_session_id.arr[0] 	= '\0';
sy_req_date.arr[0]      = '\0';
sy_machine_name.arr[0]  = '\0';
sy_ws_no.arr[0]		    = '\0';
sy_rowid.arr[0]		    = '\0';

sy_session_id.len	    = 0;
sy_user_id.len	        = 0;
sy_req_date.len         = 0;
sy_machine_name.len     = 0;
sy_ws_no.len            = 0;
sy_rowid.len            = 0;

EXEC SQL SELECT
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
	       INTO	
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	PGM_ID = 'RLRSENQ3'
			AND REQUEST_STATUS IS NULL
			AND NVL(URGENT_INDICATOR,' ') = 'S'
	        AND ROWNUM < 2;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      if(NOT_FOUND) 
      	  return FALSE;
      else 
	  {
          sy_user_id.arr[sy_user_id.len] = '\0';
          sy_session_id.arr[sy_session_id.len] = '\0';
          sy_rowid.arr[sy_rowid.len] = '\0';
          sy_req_date.arr[sy_req_date.len] = '\0';
		  sy_machine_name.arr[sy_machine_name.len] = '\0';
		  sy_ws_no.arr[sy_ws_no.len] = '\0';
		  sy_rowid.arr[sy_rowid.len] = '\0';

   	      return TRUE;
	  }
}

fetch_sy_bg_rep_gen_req()
{
sy_user_id.arr[0] 		= '\0';
sy_session_id.arr[0] 	= '\0';
sy_req_date.arr[0]      = '\0';
sy_machine_name.arr[0]  = '\0';
sy_ws_no.arr[0]		    = '\0';
sy_rowid.arr[0]		    = '\0';

sy_session_id.len	    = 0;
sy_user_id.len	        = 0;
sy_req_date.len         = 0;
sy_machine_name.len     = 0;
sy_ws_no.len            = 0;
sy_rowid.len            = 0;

EXEC SQL SELECT
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
	       INTO	
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	PGM_ID = 'RLRSENQ3'
			AND REQUEST_STATUS IS NULL
			AND NVL(URGENT_INDICATOR,' ') = 'R'
	        AND ROWNUM < 2;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      if(NOT_FOUND) 
      	  return FALSE;
      else 
	  {
          sy_user_id.arr[sy_user_id.len] = '\0';
          sy_session_id.arr[sy_session_id.len] = '\0';
          sy_rowid.arr[sy_rowid.len] = '\0';
          sy_req_date.arr[sy_req_date.len] = '\0';
		  sy_machine_name.arr[sy_machine_name.len] = '\0';
		  sy_ws_no.arr[sy_ws_no.len] = '\0';
		  sy_rowid.arr[sy_rowid.len] = '\0';

   	      return TRUE;
	  }
}
/*------------------------------------------------------------*/

print_group_test_desc()
{
   int l_len = 0;
   int nctr;
   char group_result[16];
   p_print_name_yn.arr[0] = '\0';
   p_test_desc.arr[0]     = '\0';
   p_function_yn.arr[0]   = '\0';
   p_print_name_yn.len    = 0;
   p_test_desc.len        = 0;
   p_function_yn.len      = 0;

   p_significant_digit    = 0;  
   p_no_of_decimals       = 0;

   EXEC SQL SELECT LONG_DESC,NVL(PRINT_NAME_YN,'N'),NVL(FUNCTION_YN,'N'),
		   SIGNIFICANT_DIGIT,NO_OF_DECIMALS
	    INTO   :p_test_desc,:p_print_name_yn,:p_function_yn,
		   :p_significant_digit,:p_no_of_decimals
	    FROM   RL_TEST_CODE 
	    WHERE  TEST_CODE = :rl_tst_group_test_code;
   if (OERROR)
      ins_message(ORA_MESG,"Select failed on table RL_TEST_CODE in print_group_test_desc");

   p_test_desc.arr[p_test_desc.len]    ='\0';
   p_print_name_yn.arr[p_print_name_yn.len]='\0';
   p_function_yn.arr[p_function_yn.len] = '\0';

   if(p_function_yn.arr[0] == 'Y')
   {
      group_result[0] = '\0';
      calc_func_and_prn(rl_tst_group_test_code.arr,group_result);
   }
      
   l_len = strlen(p_test_desc.arr);

   if(p_print_name_yn.arr[0] == 'Y')
   {
	  fprintf(fp,"%c&d0D",ESC);   /* Set  UnderLine ON*/
      //fprintf(fp,"%-40s",p_test_desc.arr);
	  fprintf(fp, "%s", p_test_desc.arr);
      fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */

	  fprintf(fp, "%-*s", 41 - l_len, " ");
   }

   if(p_function_yn.arr[0] == 'Y')
      if(strlen(group_result))
	  {
		/********* Numeric result is increased to 10 chrs length **/
//		 fprintf(fp,"%-5s",group_result);

		  strcpy(r_rslt.arr, group_result);
		  r_rslt.len = strlen(r_rslt.arr);
		  add_zero_after_result();
		  strcpy(group_result, r_rslt.arr);

         fprintf(fp,"%-10.10s",group_result);
	  }

   if(p_print_name_yn.arr[0] == 'Y' || strlen(group_result))
   {
      fprintf(fp,"\n");
      page_break(1);
   }

/*********** underline is added with printing of group test description ******
   if(p_print_name_yn.arr[0] == 'Y')
   {
      for(nctr = 0; nctr < p_test_desc.len; nctr++)
          fprintf(fp,"_");
	  fprintf(fp,"\n");

      page_break(1);
   } 
**************************** upto here ************/
}
/* Calculate result for the Group Test if a function is set on it.  */
float calculate_function_result(sd,dc)
int sd; int dc;
{
return 0;
}

/*------------------------------------------------------------*/
create_lab_file_name()
{
  source_copies = 1;

  /* Referral Patients and External Patients*/
  if (rl_hdr_episode_type.arr[0] == 'R' || rl_hdr_episode_type.arr[0] == 'H')  
  {
       source_copies = sy_ref_no_of_copies + 1;
       strcpy(rl_prn_ctrl_hdr_source_code.arr,rl_prn_ctrl_hdr_section_code.arr);
       rl_prn_ctrl_hdr_source_code.len = strlen(rl_prn_ctrl_hdr_section_code.arr);
  }

}
/*----------------------------------------------------------*/
print_job1()
{
char er_cd[10];
char print_yn = 'Y';
int i;

if(something_to_print == 1)
{

p_uid_pwd.arr[0] = '\0';
p_print_name.arr[0] = '\0';
p_loc_code.arr[0] = '\0';
p_loc_type.arr[0] = '\0';
p_rep_file.arr[0] = '\0';
p_print_mode.arr[0] = '\0';

p_uid_pwd.len = 0;
p_print_name.len = 0;
p_loc_code.len = 0;
p_loc_type.len = 0;
p_rep_file.len = 0;
p_print_mode.len = 0;


strcpy(p_uid_pwd.arr,uid_pwd.arr);
p_uid_pwd.len = strlen(uid_pwd.arr);

strcpy(p_print_name.arr,"RLRSENQ3");
p_print_name.len = strlen(p_print_name.arr);

if(rl_print_result_sect_yn.arr[0] == 'Y')
{
   strcpy(p_loc_type.arr,"O");
   p_loc_type.len = strlen(p_loc_type.arr);

   strcpy(p_loc_code.arr,rl_hdr_section_code.arr); 
   strcat(p_loc_code.arr,rl_hdr_episode_type.arr);

/***** Newly added for Urgent samples   *******/
   if (rl_printer_for_urgent_yn.arr[0] == 'Y')
   {
		if (rl_hdr_urgent_indicator.arr[0] != 'R')
			strcat(p_loc_code.arr, "U");
   }

   p_loc_code.len = strlen(p_loc_code.arr);

}
else
{

   strcpy(p_loc_code.arr,rl_prn_ctrl_hdr_source_code.arr);
/***** Newly added for Urgent samples   *******/
   if (rl_printer_for_urgent_yn.arr[0] == 'Y')
   {
		if (rl_hdr_urgent_indicator.arr[0] != 'R')
			strcat(p_loc_code.arr, "U");
   }

   p_loc_code.len = strlen(p_loc_code.arr);
	
   l_episode = 0;

   if ( (rl_hdr_episode_type.arr[0] == 'I') ||
		(rl_hdr_episode_type.arr[0] == 'O') )
   {

		EXEC SQL SELECT open_episode_id
		INTO :l_episode
		FROM IP_OPEN_EPISODE
		WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
		  AND patient_id = :nd_hosp_no;

		if(NODATAFOUND)
		{

             if (rl_hdr_episode_type.arr[0] == 'I')
			 {
				if (strcmp(l_print_disch_pat_result.arr, "Y") == 0)
				{

			  	    print_yn = 'Y';
					strcpy(p_loc_type.arr, "W");
					p_loc_type.len = strlen(p_loc_type.arr);
					strcpy(p_loc_code.arr, rl_hdr_source_code.arr);
					p_loc_code.len = strlen(rl_hdr_source_code.arr);
				}
                else
                  print_yn = 'N';
			 }
			 else
			 {
				strcpy(p_loc_type.arr, "C");
				p_loc_type.len = strlen(p_loc_type.arr);
				print_yn = 'Y';

			 }

		}
		else
		{

			EXEC SQL SELECT  'W'
			INTO :p_loc_type
			FROM IP_EPISODE
			WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
			AND episode_id = :l_episode
			AND patient_id = :nd_hosp_no;


			if(NODATAFOUND)
			{
			  strcpy(p_loc_type.arr, "C");
			  p_loc_type.len = strlen(p_loc_type.arr);
			  print_yn = 'Y';

			}

		}
		
		
   }
   else
   {
	  strcpy(p_loc_type.arr,"O");
	  print_yn = 'Y';

   }

/*****
   switch(rl_hdr_source_type.arr[0])
   {
      case 'W': strcpy(p_loc_type.arr,"W");
                break;
      case 'C': strcpy(p_loc_type.arr,"C");
                break;
      case 'E': strcpy(p_loc_type.arr,"O");
                break;
   }
**********/


   p_loc_type.len = strlen(p_loc_type.arr);

}

strcpy(p_rep_file.arr,nd_f_name);
p_rep_file.len = strlen(nd_f_name);

strcpy(p_print_mode.arr,"S");
p_print_mode.len = strlen(p_print_mode.arr);


switch(p_param7.arr[0])
{
   case 'L' :  /*-------To cater to pulling list---------*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr,"L");
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

   case 'X':  /*-----To cater to confidential reports----*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr,"X");
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

   case 'Z':  /*-----To cater to reprinting by Patient----*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr,"Z");
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

   case 'Y' :  /*-------To cater to reprint of results while registration---------*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr, p_param7.arr);
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

}

if (strcmp(rl_hdr_urgent_indicator.arr, "U") == 0)
	print_yn = 'Y';


if (print_yn == 'Y')
{

/*******************/

	get_trans_ind();

	for( i = 0; i < source_copies; i++)
	{

      if (strcmp(nd_trx_ind.arr,"Y") == 0)

/***************** commented on 29.06.2003 and replaced with new standard

		   print_online(uid_pwd.arr,"RLRSENQ3", p_loc_type.arr, p_loc_code.arr,"rlrsenq1.lis","S");

***********************/
////////////////////////////////////////  

					 PrintDocument
						   (
							uid_pwd.arr,		//char	*PUidPwd;
							c_session_id.arr,	//char	*PSessionID;
							nd_operating_facility_id.arr,	//char	*PFacilityID;
							"RL",				//char	*PModuleID;
							"RLRSENQ3",			//char	*PDocumentID;
							nd_file_name.arr,			//char	*POnlinePrintFileNames;
							p_loc_type.arr,				//char	*PLocationTypes;
							p_loc_code.arr,				//char	*PLocationCodes;
							1,					//int		PNumOfCopies;
							1,					//int		PPageFrom;
							9999					//int		PPageTo;
						   );
						   
///////////////////////////////////////

	  else

/******************* commented on 29.06.2003 and replaced with new standard

		   print_online(uid_pwd.arr,"RLRSENQ3", p_loc_type.arr, "", "rlrsenq1.lis","S");

************************/
////////////////////////////////////////  

					 PrintDocument
						   (
							uid_pwd.arr,		//char	*PUidPwd;
							c_session_id.arr,	//char	*PSessionID;
							nd_operating_facility_id.arr,	//char	*PFacilityID;
							"RL",				//char	*PModuleID;
							"RLRSENQ3",			//char	*PDocumentID;
							nd_file_name.arr,			//char	*POnlinePrintFileNames;
							p_loc_type.arr,				//char	*PLocationTypes;
							"",				//char	*PLocationCodes;
							1,					//int		PNumOfCopies;
							1,					//int		PPageFrom;
							9999					//int		PPageTo;
						   );
						   
///////////////////////////////////////


	}
/********************/


/*-------------	EXTRA COPY ----------------*/

	if (rl_hdr_extra_copies_to.len)
	{

		strcpy(p_print_name.arr,"RLRSENQE");
		p_print_name.len = strlen(p_print_name.arr);

		strcpy(p_loc_type.arr,"O");
		p_loc_type.len = strlen(p_loc_type.arr);

		if(rl_print_result_sect_yn.arr[0] == 'Y')
		{
			strcpy(p_loc_code.arr,rl_hdr_section_code.arr); 
			strcat(p_loc_code.arr,rl_hdr_episode_type.arr);
			p_loc_code.len = strlen(p_loc_code.arr);
		}
		else
		{
			strcpy(p_loc_code.arr,rl_prn_ctrl_hdr_section_code.arr);
			p_loc_code.len = strlen(rl_prn_ctrl_hdr_section_code.arr);

		}

		strcpy(p_rep_file.arr,nd_e_name);

//// 12.10.2003		p_rep_file.len = strlen(nd_f_name);

		p_rep_file.len = strlen(p_rep_file.arr);  //// 12.10.2003

      if (strcmp(nd_trx_ind.arr,"Y") == 0)

/***************** commented on 29.06.2003 and replaced with new standard

		   print_online(uid_pwd.arr,"RLRSENQE", p_loc_type.arr, p_loc_code.arr,"rlrsenqe.lis","S");

**************************/

////////////////////////////////////////  

					 PrintDocument
						   (
							uid_pwd.arr,		//char	*PUidPwd;
							c_session_id.arr,	//char	*PSessionID;
							nd_operating_facility_id.arr,	//char	*PFacilityID;
							"RL",				//char	*PModuleID;
							"RLRSENQE",			//char	*PDocumentID;
							nd_file_name.arr,			//char	*POnlinePrintFileNames;
							p_loc_type.arr,				//char	*PLocationTypes;
							p_loc_code.arr,				//char	*PLocationCodes;
							1,					//int		PNumOfCopies;
							1,					//int		PPageFrom;
							9999					//int		PPageTo;
						   );
						   
///////////////////////////////////////

	  else

/************** commented on 29.06.2003 and replaced with new standard

		   print_online(uid_pwd.arr,"RLRSENQE", p_loc_type.arr, "", "rlrsenqe.lis","S");

********************/

////////////////////////////////////////  

					 PrintDocument
						   (
							uid_pwd.arr,		//char	*PUidPwd;
							c_session_id.arr,	//char	*PSessionID;
							nd_operating_facility_id.arr,	//char	*PFacilityID;
							"RL",				//char	*PModuleID;
							"RLRSENQE",			//char	*PDocumentID;
							nd_file_name.arr,			//char	*POnlinePrintFileNames;
							p_loc_type.arr,				//char	*PLocationTypes;
							"",				//char	*PLocationCodes;
							1,					//int		PNumOfCopies;
							1,					//int		PPageFrom;
							9999					//int		PPageTo;
						   );
						   
///////////////////////////////////////



		_flushall();

		if(OERROR)
			ins_message(ERR_MESG,"1.Insert Failed on SY_REPORT_PRINT_REQUEST");
	} 

  }

}

 if(OERROR)
      ins_message(ERR_MESG,"Select failed on DUAL in print_job()");
 
}
/*----------------------------------------------------------*/
print_job()
{
char er_cd[10];
char print_yn = 'Y';
int i;

if(something_to_print == 1)
{

p_uid_pwd.arr[0] = '\0';
p_print_name.arr[0] = '\0';
p_loc_code.arr[0] = '\0';
p_loc_type.arr[0] = '\0';
p_rep_file.arr[0] = '\0';
p_print_mode.arr[0] = '\0';

p_uid_pwd.len = 0;
p_print_name.len = 0;
p_loc_code.len = 0;
p_loc_type.len = 0;
p_rep_file.len = 0;
p_print_mode.len = 0;


strcpy(p_uid_pwd.arr,uid_pwd.arr);
p_uid_pwd.len = strlen(uid_pwd.arr);

strcpy(p_print_name.arr,"RLRSENQ3");
p_print_name.len = strlen(p_print_name.arr);

if(rl_print_result_sect_yn.arr[0] == 'Y')
{
   strcpy(p_loc_type.arr,"O");
   p_loc_type.len = strlen(p_loc_type.arr);

   strcpy(p_loc_code.arr,rl_hdr_section_code.arr); 
   strcat(p_loc_code.arr,rl_hdr_episode_type.arr);

/***** Newly added for Urgent samples   *******/
   if (rl_printer_for_urgent_yn.arr[0] == 'Y')
   {
		if (rl_hdr_urgent_indicator.arr[0] != 'R')
			strcat(p_loc_code.arr, "U");
   }

   p_loc_code.len = strlen(p_loc_code.arr); 

}
else
{

   strcpy(p_loc_code.arr,rl_prn_ctrl_hdr_source_code.arr);
/***** Newly added for Urgent samples   *******/
   if (rl_printer_for_urgent_yn.arr[0] == 'Y')
   {
		if (rl_hdr_urgent_indicator.arr[0] != 'R')
			strcat(p_loc_code.arr, "U");
   }

   p_loc_code.len = strlen(p_loc_code.arr);
	
   l_episode = 0;

/********** commented on 22.07.2003 to handle the ordered facility id properly

   if ( (rl_hdr_episode_type.arr[0] == 'I') ||
		(rl_hdr_episode_type.arr[0] == 'O') )
******************/

   if (( (rl_hdr_episode_type.arr[0] == 'I') ||
		(rl_hdr_episode_type.arr[0] == 'O') ) && 
		(strcmp(nd_operating_facility_id.arr, rl_ordered_facility_id.arr) == 0) ) 
		
   {

		EXEC SQL SELECT open_episode_id
		INTO :l_episode
		FROM IP_OPEN_EPISODE
		WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
		  AND patient_id = :nd_hosp_no;

		if(NODATAFOUND)
		{

             if (rl_hdr_episode_type.arr[0] == 'I')
			 {
				if (strcmp(l_print_disch_pat_result.arr, "Y") == 0)
				{

			  	    print_yn = 'Y';
					strcpy(p_loc_type.arr, "W");
					p_loc_type.len = strlen(p_loc_type.arr);
					strcpy(p_loc_code.arr, rl_hdr_source_code.arr);
					p_loc_code.len = strlen(rl_hdr_source_code.arr);
				}
                else
                  print_yn = 'N';
			 }
			 else
			 {
				strcpy(p_loc_type.arr, "C");
				p_loc_type.len = strlen(p_loc_type.arr);
				print_yn = 'Y';

			 }

		}
		else
		{

			EXEC SQL SELECT  'W'
			INTO :p_loc_type
			FROM IP_EPISODE
			WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
			AND episode_id = :l_episode
			AND patient_id = :nd_hosp_no;


			if(NODATAFOUND)
			{
			  strcpy(p_loc_type.arr, "C");
			  p_loc_type.len = strlen(p_loc_type.arr);
			  print_yn = 'Y';

			}

		}
		
		
   }
   else
   {
	  strcpy(p_loc_type.arr,"O");
	  print_yn = 'Y';

   }

/*****
   switch(rl_hdr_source_type.arr[0])
   {
      case 'W': strcpy(p_loc_type.arr,"W");
                break;
      case 'C': strcpy(p_loc_type.arr,"C");
                break;
      case 'E': strcpy(p_loc_type.arr,"O");
                break;
   }
**********/


   p_loc_type.len = strlen(p_loc_type.arr);

}

strcpy(p_rep_file.arr,nd_f_name);
p_rep_file.len = strlen(nd_f_name);

strcpy(p_print_mode.arr,"S");
p_print_mode.len = strlen(p_print_mode.arr);


switch(p_param7.arr[0])
{
   case 'L' :  /*-------To cater to pulling list---------*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr,"L");
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

   case 'X':  /*-----To cater to confidential reports----*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr,"X");
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

   case 'Z':  /*-----To cater to reprinting by Patient----*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr,"Z");
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

   case 'Y' :  /*-------To cater to reprint of results while registration---------*/

       source_copies = 1;
       rl_hdr_extra_copies_to.arr[0] = '\0';
       rl_hdr_extra_copies_to.len = 0;

       strcpy(p_loc_type.arr,"O");
       p_loc_type.len = strlen(p_loc_type.arr);

       strcpy(p_loc_code.arr, p_param7.arr);
       p_loc_code.len = strlen(p_loc_code.arr);

	   break;

}

if (strcmp(rl_hdr_urgent_indicator.arr, "U") == 0)
	print_yn = 'Y';


if (print_yn == 'Y')
{

//    check_for_print_destn_type();


	for( i = 0; i < source_copies; i++)
	{
	 if (l_destn_rep_yn == 'Y')		
	 {
			 EXEC SQL
				  INSERT INTO SY_REPORT_PRINT_REQUEST
				  (OPERATING_FACILITY_ID,USER_ID,MACHINE_NAME,WS_NO,MODULE_ID,
				   ONLINE_PRINT_NAME,
				   DEST_LOCN_TYPE,DEST_LOCN_CODE,ONLINE_PRINT_FILE_NAME,
				   PRINT_MODE,REQUEST_DATE,PROCESS_TYPE,PRINT_IMMEDIATE_YN,
				   PRINT_PRIORITY,SELECTION_CRITERIA)
				  VALUES
				  (:rl_ordered_facility_id,:sy_user_id,:sy_machine_name,:sy_ws_no,'RL','RLRSENQ3',
				   :p_loc_type,:p_loc_code,:p_rep_file,'S',SYSDATE,'S',
				   'Y',DECODE(:rl_hdr_urgent_indicator,'U','1','S','1','3'),
				   substr('Specimen No:'||:rl_prn_ctrl_hdr_sp_no||' Source:'||:rl_prn_ctrl_hdr_source_code,1,250)
				  );

		if(OERROR)
			ins_message(ERR_MESG,"2.Insert Failed on SY_REPORT_PRINT_REQUEST");

	 }

/************************************* added on 16.05.2004 ************************/

/************************************
	 if (l_destn_fax_yn == 'Y')		
	 {

			//// insert to fax table SM_REPORT_FAX_MAIL_REQUEST
					
				 if (l_destn_rep_yn == 'Y')	 
				 {
					/// copy the .LIS file from WORKING_DIR to FAX directory 

					 l_command_line.arr[0]   = '\0';   
					 l_command_line.len      = 0;

					strcpy(l_command_line.arr, "COPY ");
					strcat(l_command_line.arr, nd_file_name.arr);
					strcat(l_command_line.arr, " ");
					strcat(l_command_line.arr, p_rep_file_fax.arr);

				    l_command_line.len = strlen(l_command_line.arr);

					_flushall;

				//	_spawnlp(_P_WAIT, "CMD", l_command_line.arr, NULL);
					
				//  WinExec(l_command_line, SW_SHOWNORMAL);	        

					system(l_command_line.arr);

				 }   


				 strcpy(p_rep_file.arr,p_rep_file_fax.arr);	
				 p_rep_file.len = strlen(p_rep_file.arr);

				 EXEC SQL EXECUTE 
					  begin
					    declare
						   l_error_text VARCHAR2(200);
						begin
							appfaxmail.fax_mail_report(:rl_ordered_facility_id,          
														'RL',
														'RLRSENQ3',
														:p_loc_type,          
														:p_loc_code,            
														 NULL,             
														:p_rep_file,
														:sy_user_id,  
														:sy_ws_no,    
														NULL,		  
														l_error_text 
													  );
					    end;
					  end;
				 END-EXEC;

				if(OERROR)
					ins_message(ERR_MESG,"1.Insert Failed on SM_REPORT_FAX_MAIL_REQUEST");

	 }
************************************************/

/************************ upto here added on 16.05.2004 ***********************/

		_flushall();


	}

/*-------------	EXTRA COPY ----------------*/

	if (rl_hdr_extra_copies_to.len)
	{

		strcpy(p_print_name.arr,"RLRSENQE");
		p_print_name.len = strlen(p_print_name.arr);

		strcpy(p_loc_type.arr,"O");
		p_loc_type.len = strlen(p_loc_type.arr);

		if(rl_print_result_sect_yn.arr[0] == 'Y')
		{
			strcpy(p_loc_code.arr,rl_hdr_section_code.arr); 
			strcat(p_loc_code.arr,rl_hdr_episode_type.arr); 
			p_loc_code.len = strlen(p_loc_code.arr);
		}
		else
		{
			strcpy(p_loc_code.arr,rl_prn_ctrl_hdr_section_code.arr);
			p_loc_code.len = strlen(rl_prn_ctrl_hdr_section_code.arr);
		}

		strcpy(p_rep_file.arr,nd_e_name);

/// 12.10.2003		p_rep_file.len = strlen(nd_f_name); 

		p_rep_file.len = strlen(p_rep_file.arr);  /// 12.10.2003

	
	   if (l_destn_rep_yn == 'Y')		
	   {	
		EXEC SQL
			  INSERT INTO SY_REPORT_PRINT_REQUEST
				  (OPERATING_FACILITY_ID,USER_ID,MACHINE_NAME,WS_NO,MODULE_ID,
				   ONLINE_PRINT_NAME,DEST_LOCN_TYPE,DEST_LOCN_CODE,ONLINE_PRINT_FILE_NAME,
					PRINT_MODE,REQUEST_DATE,PROCESS_TYPE,PRINT_IMMEDIATE_YN,
					PRINT_PRIORITY,SELECTION_CRITERIA)
				VALUES
					(:rl_ordered_facility_id,:sy_user_id,:sy_machine_name,:sy_ws_no,'RL','RLRSENQE',
					:p_loc_type,:p_loc_code,:p_rep_file,'S',SYSDATE,'S',
					'Y',DECODE(:rl_hdr_urgent_indicator,'U','1','S','1','3'),
					substr('Specimen No:'||:rl_prn_ctrl_hdr_sp_no||' Source:'||:rl_prn_ctrl_hdr_source_code,1,250));

			if(OERROR)
				ins_message(ERR_MESG,"3.Insert Failed on SY_REPORT_PRINT_REQUEST");
		 }

/********************************************
		 if (l_destn_fax_yn == 'Y')		
		 {

				//// insert to fax table SM_REPORT_FAX_MAIL_REQUEST 


					 if (l_destn_rep_yn == 'Y')	 
					 {
						/// copy the .LIS file from WORKING_DIR to FAX directory 

						 l_command_line.arr[0]   = '\0';   
						 l_command_line.len      = 0;

						strcpy(l_command_line.arr, "COPY ");
						strcat(l_command_line.arr, nd_file_name.arr);
						strcat(l_command_line.arr, " ");
						strcat(l_command_line.arr, p_rep_file_fax_ext.arr);

						l_command_line.len = strlen(l_command_line.arr);

						_flushall;

					//	_spawnlp(_P_WAIT, "CMD", l_command_line.arr, NULL);
						
					//  WinExec(l_command_line, SW_SHOWNORMAL);	        

						system(l_command_line.arr);

					 }   



					 strcpy(p_rep_file.arr,p_rep_file_fax_ext.arr);	
					 p_rep_file.len = strlen(p_rep_file.arr);

					 EXEC SQL EXECUTE 
						  begin
							declare
							   l_error_text VARCHAR2(200);
							begin
								appfaxmail.fax_mail_report(:rl_ordered_facility_id,          
															'RL',
															'RLRSENQE',
															:p_loc_type,          
															:p_loc_code,            
															 NULL,             
															:p_rep_file,
															:sy_user_id,  
															:sy_ws_no,    
															NULL,		  
															l_error_text 
														  );
							end;
						  end;
					 END-EXEC;

					if(OERROR)
						ins_message(ERR_MESG,"2.Insert Failed on SM_REPORT_FAX_MAIL_REQUEST");

		 }
*************************************************************/

		_flushall();  

	} 

  }

}

 if(OERROR)
      ins_message(ERR_MESG,"Select failed on DUAL in print_job()");
 
}
/*----------------------------------------------------------*/
fetch_sy_prog_param()
{
rl_prn_ctrl_hdr_pat_no.arr[0] 		= '\0';
rl_prn_ctrl_hdr_sp_no.arr[0] 		= '\0';
rl_prn_ctrl_hdr_source_code.arr[0] 	= '\0';
rl_prn_ctrl_hdr_user.arr[0] 		= '\0';
rl_prn_ctrl_hdr_section_code.arr[0]     = '\0';
rl_prn_ctrl_hdr_rp_yn.arr[0] = '\0';
p_param7.arr[0] = '\0';
p_param8.arr[0]	= '\0';
nd_rowid.arr[0]						= '\0';

rl_prn_ctrl_hdr_pat_no.len 	        = 0;
rl_prn_ctrl_hdr_source_code.len         = 0;
rl_prn_ctrl_hdr_sp_no.len 	        = 0;
rl_prn_ctrl_hdr_section_code.len        = 0;
rl_prn_ctrl_hdr_user.len	        = 0;
rl_prn_ctrl_hdr_rp_yn.len = 0;
p_param7.len = 0;
p_param8.len = 0;
nd_rowid.len						= 0;


EXEC SQL SELECT	PARAM1,
			    PARAM2,
			    PARAM3,
			    PARAM4,
			    PARAM5,
				NVL(PARAM6,'N'),
				PARAM7,
				PARAM8,
				rowid
	       INTO	
			    :rl_prn_ctrl_hdr_pat_no,
	   	   	    :rl_prn_ctrl_hdr_sp_no,
			    :rl_prn_ctrl_hdr_source_code,
			    :rl_prn_ctrl_hdr_user,
			    :rl_prn_ctrl_hdr_section_code,
				:rl_prn_ctrl_hdr_rp_yn,
				:p_param7,
				:p_param8,
				:nd_rowid
	       FROM	SY_PROG_PARAM
	      WHERE	OPERATING_FACILITY_ID = :nd_operating_facility_id
		    AND PGM_ID = 'RLRSENQ3'
	        AND	SESSION_ID = :sy_session_id
			AND PGM_DATE = :sy_req_date
            AND PARAM4 = :sy_user_id
			AND ROWNUM < 2;
	
      if (OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_PROG_PARAM");

      if (NOT_FOUND) 
	      return FALSE;
      else 
	  {
	      rl_prn_ctrl_hdr_pat_no.arr[rl_prn_ctrl_hdr_pat_no.len]           = '\0';
	      rl_prn_ctrl_hdr_sp_no.arr[rl_prn_ctrl_hdr_sp_no.len]             = '\0';
	      rl_prn_ctrl_hdr_source_code.arr[rl_prn_ctrl_hdr_source_code.len] = '\0';
 	      rl_prn_ctrl_hdr_user.arr[rl_prn_ctrl_hdr_user.len]               = '\0';
	      rl_prn_ctrl_hdr_section_code.arr[rl_prn_ctrl_hdr_section_code.len]  = '\0';
          rl_prn_ctrl_hdr_rp_yn.arr[rl_prn_ctrl_hdr_rp_yn.len] = '\0';
		  p_param7.arr[p_param7.len] = '\0';
		  nd_rowid.arr[nd_rowid.len]						   = '\0';
		  p_param8.arr[p_param8.len] = '\0';
		  
	      strcpy(nd_hosp_no.arr,rl_prn_ctrl_hdr_pat_no.arr);
	      strcpy(nd_spec_no.arr,rl_prn_ctrl_hdr_sp_no.arr);
	      nd_hosp_no.arr[rl_prn_ctrl_hdr_pat_no.len] 	= '\0';
	      nd_spec_no.arr[rl_prn_ctrl_hdr_sp_no.len] 	= '\0';
	      nd_hosp_no.len	= rl_prn_ctrl_hdr_pat_no.len;
	      nd_spec_no.len	= rl_prn_ctrl_hdr_sp_no.len;

  	      return TRUE;
	}

}
/*----------------------------------------------------------*/
sql_connect(l_nd_ap_uid_pwd)
char l_nd_ap_uid_pwd[];
{
  strcpy(uid_pwd.arr,l_nd_ap_uid_pwd);
  uid_pwd.len = strlen(uid_pwd.arr);

  EXEC SQL CONNECT :uid_pwd;

  if (sqlca.sqlcode < 0)
      return(-1);
  return(0);
}
get_company_name()
{
    EXEC SQL  SELECT ACC_ENTITY_NAME  
		        INTO :sy_acc_entity_name
	            FROM SY_ACC_ENTITY
			WHERE ACC_ENTITY_ID = :nd_operating_facility_id;	/* Company Name Master */

      if (OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_ACC_ENTITY");

    sy_acc_entity_name.arr[sy_acc_entity_name.len] = '\0'; 
}

/*-----------------------------------------------------*/

get_departmental_parameters()
{
   rl_print_result_sect_yn.arr[0] = '\0';
   rl_print_result_sect_yn.len = 0;
   rl_section_tel_num.arr[0] = '\0';
   rl_section_tel_num.len = 0;
   rl_printer_for_urgent_yn.arr[0]	= '\0';
   rl_printer_for_urgent_yn.len		= 0;
   rl_test_requested_yn.arr[0]		= '\0';
   rl_test_requested_yn.len			= 0;
   rl_message_line.arr[0]			= '\0';
   rl_message_line.len				= 0;
   rl_name_on_report_yn.arr[0]		= '\0';
   rl_name_on_report_yn.len			= 0;
   rl_footer_line_1.arr[0]			= '\0';
   rl_footer_line_2.arr[0]			= '\0';
   rl_footer_line_1.len				= 0;
   rl_footer_line_2.len				= 0;

   EXEC SQL SELECT NVL(PRINT_RESULT_AT_SECTION_YN,'N'),TEL_NUM,
					NVL(printer_for_urgent_yn, 'N'), NVL(test_requested_yn,'N'),
					message_line, NVL(use_name_on_rep_feature_yn, 'N'),
					footer_line_1, footer_line_2
              INTO :rl_print_result_sect_yn,:rl_section_tel_num,
					:rl_printer_for_urgent_yn, :rl_test_requested_yn,
					:rl_message_line, :rl_name_on_report_yn,
					:rl_footer_line_1, :rl_footer_line_2
		      FROM RL_SECTION_CTL
		     WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			 AND SECTION_CODE = :rl_hdr_section_code;

      if (OERROR)
         ins_message(ORA_MESG,"Select failed on table RL_SECTION_CTL");

      rl_print_result_sect_yn.arr[rl_print_result_sect_yn.len] = '\0';
      rl_section_tel_num.arr[rl_section_tel_num.len] = '\0';
	  rl_printer_for_urgent_yn.arr[rl_printer_for_urgent_yn.len]= '\0';
	  rl_test_requested_yn.arr[rl_test_requested_yn.len]		= '\0';
	  rl_message_line.arr[rl_message_line.len]					= '\0';
	  rl_name_on_report_yn.arr[rl_name_on_report_yn.len]		= '\0';
	  rl_footer_line_1.arr[rl_footer_line_1.len]				= '\0';
	  rl_footer_line_2.arr[rl_footer_line_2.len]				= '\0';

}
/*-----------------------------------------------------*/

get_parameters()
{
    rl_lab_title.arr[0] = '\0';
    rl_lab_title.len = 0;
    rl_lab_title_2.arr[0] = '\0';
    rl_lab_title_2.len = 0;
    rl_lab_title_3.arr[0] = '\0';
    rl_lab_title_3.len = 0;
    rl_lab_title_4.arr[0] = '\0';
    rl_lab_title_4.len = 0;

/*********************** 23.06.2003 commented and replaced as per new standard

    EXEC SQL  SELECT LAB_TITLE, lab_title_2, lab_title_3, lab_title_4
		    INTO :rl_lab_title, :rl_lab_title_2, :rl_lab_title_3, :rl_lab_title_4
	            FROM RL_PARAM;	////// Departmental Parameters 

*********************************/

///////////////////////////////////////////////
     {
		 EXEC SQL SELECT nvl(a.lab_title,b.lab_title),
	 					 nvl(a.lab_title_2,b.lab_title_2), 
						 nvl(a.lab_title_3,b.lab_title_3),
						 nvl(a.lab_title_4,b.lab_title_4)
				  INTO :rl_lab_title, :rl_lab_title_2, :rl_lab_title_3, :rl_lab_title_4
				  FROM   RL_PARAM_FOR_FACILITY A , RL_PARAM B
				  WHERE  OPERATING_FACILITY_ID = :nd_operating_facility_id;

 		 if(NODATAFOUND)
		 {
			    EXEC SQL  SELECT LAB_TITLE, lab_title_2, lab_title_3, lab_title_4
						  INTO :rl_lab_title, :rl_lab_title_2, :rl_lab_title_3, :rl_lab_title_4
						  FROM RL_PARAM;

				  if (OERROR)
					 ins_message(ORA_MESG,"Select failed on table RL_PARAM");

		 }
	 }

///////////////////////////////////////////////

      if (OERROR)
         ins_message(ORA_MESG,"Select failed on table RL_PARAM");

    rl_lab_title.arr[rl_lab_title.len] = '\0';
	rl_lab_title_2.arr[rl_lab_title_2.len] = '\0';
	rl_lab_title_3.arr[rl_lab_title_3.len] = '\0';
	rl_lab_title_4.arr[rl_lab_title_4.len] = '\0';

	// The last  title has to be concatenated with the department name

	strcat(rl_lab_title_4.arr, " ");
	strcat(rl_lab_title_4.arr, rl_section_short_name.arr);
	rl_lab_title_4.len = strlen(rl_lab_title_4.arr);


}
/*-----------------------------------------------------*/
declare_curs()
{
    get_company_name();

    EXEC SQL DECLARE RL_REQ_HDR_CUR CURSOR FOR
              SELECT SOURCE_CODE,
                     CONSULTANT_CODE,
                     TO_CHAR(SPEC_RECD_DATE_TIME,'DD/MM/YYYY HH24:MI'),
                     TO_CHAR(SPEC_REGD_DATE_TIME,'DD/MM/YYYY HH24:MI'),
                     TO_CHAR(SPEC_COLLTD_DATE_TIME,'DD/MM/YYYY HH24:MI'),
                     TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI'),
                     SECTION_CODE,
                     REQUEST_COMMENT_CODE1,
                     REQUEST_COMMENT_CODE2,
                     REQUEST_COMMENT_CODE3,
                     REQUEST_COMMENT_DESC1,
                     REQUEST_COMMENT_DESC2,
                     REQUEST_COMMENT_DESC3,
                     EXTRA_COPIES_TO,
                     SPECIMEN_TYPE_CODE,
                     ADDED_BY_ID,
                     TO_CHAR(ADDED_DATE,'DD/MM/YYYY HH24:MI'),
                     MODIFIED_BY_ID,
                     TO_CHAR(MODIFIED_DATE,'DD/MM/YYYY HH24:MI'),
				     URGENT_INDICATOR,
				     EPISODE_TYPE, 
					 SOURCE_TYPE,
					 RELEASED_BY_ID,
					 TO_CHAR(RELEASED_DATE,'DD/MM/YYYY HH24:MI'),
					 category_code,
					 category_year, 
					 category_number,
					 TO_CHAR(SPEC_REGD_DATE_TIME,'DD/MM/YYYY'),
					 ordered_facility_id
                FROM RL_REQUEST_HEADER
               WHERE PATIENT_ID = :nd_hosp_no
                 AND SPECIMEN_NO = :nd_spec_no
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
		 FOR UPDATE OF STATUS NOWAIT;  

    EXEC SQL DECLARE RL_REQ_DTL_CUR CURSOR FOR
              SELECT TEST_CODE,
                     NVL(RESULT_STATUS,'O'),
                     DECODE(GROUP_TEST_YN,'Y','G','I')
                FROM RL_REQUEST_DETAIL
               WHERE PATIENT_ID = :nd_hosp_no
                 AND SPECIMEN_NO = :first_specimen_no
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id;
/****************
    EXEC SQL DECLARE RL_TEST_RESULT_CUR CURSOR FOR
              SELECT GROUP_TEST_CODE,
                     TEST_CODE,
                     NVL(NUMERIC_PREFIX,'+'),
                     NUMERIC_RESULT,
                     RESULT_COMMENT_DESC1,
                     RESULT_COMMENT_DESC2,
                     RESULT_COMMENT_DESC3,
                     RESULT_COMMENT_DESC4,
					 TEST_UNITS,
					 TEST_REF_RANGE_COMMENT,
					 AGE_RANGE_LOW,
					 AGE_RANGE_HIGH,
                     ROWID,
					 NVL(HIDE_RESULT_COMMENTS_YN,'N')
                FROM RL_TEST_RESULT
               WHERE PATIENT_ID = :nd_hosp_no
                 AND SPECIMEN_NO = :nd_spec_no
		         AND OPERATING_FACILITY_ID = :nd_operating_facility_id
		 AND GROUP_TEST_CODE IN
		 (
              SELECT TEST_CODE
                FROM RL_REQUEST_DETAIL
               WHERE PATIENT_ID = :nd_hosp_no
                 AND SPECIMEN_NO = :nd_spec_no
		         AND OPERATING_FACILITY_ID = :nd_operating_facility_id
		 AND NVL(RESULT_STATUS,' ') = 'R'
		 )
         ORDER BY GROUP_SEQ_NO,TEST_SEQ_NO
		 FOR UPDATE OF STATUS;
****************/
/******** INCLUDE AS DYNAMIC SQL ************************
    EXEC SQL DECLARE RL_TEST_RESULT_CUR CURSOR FOR
              SELECT B.specimen_no,
					 B.GROUP_TEST_CODE,
                     B.TEST_CODE,
                     NVL(NUMERIC_PREFIX,'+'),
                     NUMERIC_RESULT,
                     RESULT_COMMENT_DESC1,
                     RESULT_COMMENT_DESC2,
                     RESULT_COMMENT_DESC3,
                     RESULT_COMMENT_DESC4,
					 TEST_UNITS,
					 TEST_REF_RANGE_COMMENT,
					 AGE_RANGE_LOW,
					 AGE_RANGE_HIGH,
                     B.ROWID AS row_id,
					 NVL(HIDE_RESULT_COMMENTS_YN,'N')
                FROM RL_INTERVAL_TEST_TEMP A, RL_TEST_RESULT B
               WHERE B.PATIENT_ID = :nd_hosp_no
                 AND A.specimen_no = B.specimen_no
				 AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND B.test_code = DECODE(A.test_code, NULL, B.test_code, A.test_code)
				 AND B.group_test_code = A.group_test_code
				 AND A.user_id = 'RLRSENQ3'
				 AND A.session_id = 1
         ORDER BY B.test_code, B.specimen_no, B.GROUP_SEQ_NO,B.TEST_SEQ_NO
		 FOR UPDATE OF STATUS;
****************/

/*   changed on 28/01/2002 and made as a implicit select statement

     EXEC SQL DECLARE RL_SPECIMEN_TYPE_CODE_CUR CURSOR FOR
              SELECT SPECIMEN_DESC
                FROM RL_SPECIMEN_TYPE_CODE
               WHERE SPECIMEN_TYPE_CODE = :rl_hdr_specimen_type_code;
*/


/*   changed on 28/01/2002 and made as a implicit select statement

    EXEC SQL DECLARE RL_SECTION_CUR CURSOR FOR
              SELECT SUBSTR(LONG_NAME,1,30)
                FROM RL_SECTION_CODE
               WHERE SECTION_CODE = :rl_hdr_section_code;

*/

/*   changed on 28/01/2002 and made as a implicit select statement
    EXEC SQL DECLARE RL_TEST_CODE_CUR CURSOR FOR
              SELECT LONG_DESC,
                     NUMERIC_RESULT_YN,
                     AGE_SEX_RANGE_YN,
                     FUNCTION_YN,
                     PRINT_NAME_YN,
                     LOW_VALUE_NORMAL,
                     HIGH_VALUE_NORMAL,
                     GROUP_TEST_YN,
                     TEXT_BLOCK_YN,
                     CULTURE_TEST_YN,
                     SNOMED_YN,
                     TEST_UNITS,
                     NVL(NO_OF_DECIMALS,0),
                     NVL(SIGNIFICANT_DIGIT,0),
					 REF_RANGE_COMMENT,
					 NVL(INHIBIT_REPORT_YN,'N'),
					 NVL(CONFIDENTIAL_YN,'N')    
                FROM RL_TEST_CODE
               WHERE TEST_CODE = :rl_loc_test_code
                 AND INHIBIT_REPORT_YN = 'N';

*/

/*   changed on 28/01/2002 and made as a implicit select statement

    EXEC SQL DECLARE RL_AGE_SEX_RANGE_CUR CURSOR FOR
              SELECT LOW_VALUE_NORMAL,
                     HIGH_VALUE_NORMAL
                FROM RL_AGE_SEX_RANGE
               WHERE TEST_CODE = :rl_tst_test_code
                 AND SEX       = :rl_pat_sex
                 AND :rl_pat_dob_no_of_days
                       BETWEEN CALC_MIN_AGE_IN_DAYS  AND 
                          CALC_MAX_AGE_IN_DAYS;
*/

    EXEC SQL DECLARE RL_COMM_FOR_TEST_CUR CURSOR FOR
              SELECT COMMENT_TEXT
                FROM RL_COMMENTS_FOR_TEST
               WHERE TEST_CODE = :rl_tst_test_code
	    ORDER BY SEQ_NO;

    EXEC SQL DECLARE RL_RESULT_TEXT_CUR CURSOR FOR
              SELECT RESULT_TEXT
                FROM RL_RESULT_TEXT
               WHERE PATIENT_ID     = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
				 AND NVL(hide_text_yn, 'N') <> 'Y'
            ORDER BY SERIAL_NO;

/// added the below cursor on 16.05.2004

    EXEC SQL DECLARE RL_RESULT_MODIFY_REASON_CUR CURSOR FOR
              SELECT REMARK_TEXT,RELEASED_BY,TO_CHAR(RELEASED_DATE,'DD/MM/YY HH24:MI')
                FROM RL_RESULT_MODIFY_REASON
               WHERE SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND PATIENT_ID     = :nd_hosp_no
				 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
            ORDER BY MODIFY_LOG_SEQ_NO;


    EXEC SQL DECLARE RL_FUNCTION_CUR CURSOR FOR
              SELECT OPERAND_1,
                     OPERAND_1_TYPE,
                     OPERATOR_1,
                     OPERAND_2,
                     OPERAND_2_TYPE,
                     OPERATOR_2
                FROM RL_FUNCTION
               WHERE TEST_CODE       = :rl_loc_test_code
               ORDER BY SEQ_NUMBER;

/******** Observed this cursor is not using in the program *********
    EXEC SQL DECLARE RL_TEST_RESULT_CUR2 CURSOR FOR
              SELECT NUMERIC_RESULT
                FROM RL_TEST_RESULT
               WHERE PATIENT_ID     = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND TEST_CODE       = :rl_loc_test_code;
**********************/

    EXEC SQL DECLARE RL_RESULT_SNOMED_CUR CURSOR FOR
              SELECT SNOMED_CODE, snomed_code_2
                FROM RL_RESULT_SNOMED
               WHERE PATIENT_ID      = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
	       ORDER BY SNOMED_CODE;

/*   changed on 28/01/2002 and made as a implicit select statement

    EXEC SQL DECLARE RL_SNOMED_CODE_CUR CURSOR FOR
              SELECT DESCRIPTION_1,
                     DESCRIPTION_2,
                     DESCRIPTION_3,
                     DESCRIPTION_4,
                     DESCRIPTION_5,
		     PRINT_YN
                FROM RL_SNOMED_CODE
               WHERE SNOMED_CODE = :rl_res_snomed_code;

*/

    EXEC SQL DECLARE RL_RESULT_ORGANISM_CUR CURSOR FOR
              SELECT ORGANISM_CODE,
                     RESULT_COMMENT_DESC
                FROM RL_RESULT_ORGANISM
               WHERE PATIENT_ID      = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
				 AND NVL(hide_organism_yn, 'N') <> 'Y'
			   ORDER BY ORGANISM_CODE;

    EXEC SQL DECLARE RL_ANTIBIOTIC_CUR CURSOR FOR
              SELECT DISTINCT ANTIBIOTIC_CODE
                FROM RL_RESULT_ORGANISM_DTL
               WHERE PATIENT_ID      = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
                 AND REPORT_YN       = 'Y'
				 AND SENSITIVITY_IND IN('S','R','I')
			   ORDER BY ANTIBIOTIC_CODE;

    EXEC SQL DECLARE RL_SENSITIVITY_CUR CURSOR FOR
              SELECT ORGANISM_CODE,
					 ANTIBIOTIC_CODE,
                     SENSITIVITY_IND
                FROM RL_RESULT_ORGANISM_DTL
               WHERE PATIENT_ID      = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
                 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
                 AND REPORT_YN       = 'Y'
				 AND SENSITIVITY_IND IN('S','R','I')
               ORDER BY ANTIBIOTIC_CODE, ORGANISM_CODE;  

/*   changed on 28/01/2002 and made as a implicit select statement

    EXEC SQL DECLARE RL_ORGANISM_CODE_CUR CURSOR FOR
              SELECT LONG_DESC
                FROM RL_ORGANISM_CODE
               WHERE ORGANISM_CODE = :rl_res_organism_code;
*/

/*   changed on 28/01/2002 and made as a implicit select statement

    EXEC SQL DECLARE RL_ANTIBIOTIC_CODE_CUR CURSOR FOR
              SELECT SUBSTR(LONG_DESC,1,39)
                FROM RL_ANTIBIOTIC_CODE
               WHERE ANTIBIOTIC_CODE = :rl_res_dtl_antibiotic_code;
*/
}

/*-----------------------------------------------------*/
gen_extra_file_name()
{

     p_rep_file_fax_ext.arr[0]   = '\0';   
     p_rep_file_fax_ext.len      = 0;



	 if (l_destn_rep_yn == 'Y')	
			sprintf(extra_file_name,"%srslt_%s.ext",WORKING_DIR,nd_file_no.arr);

	 if (l_destn_fax_yn == 'Y')		
	 {
		 gen_file_name_fax();
		 sprintf(p_rep_file_fax_ext.arr,"%srslt_%s.ext", nd_file_name_fax.arr,nd_file_no.arr);

		 p_rep_file_fax_ext.len  = strlen(p_rep_file_fax_ext.arr);

		 if (l_destn_rep_yn != 'Y') 
			strcpy(extra_file_name, p_rep_file_fax_ext.arr);

	 }



   strcpy(nd_e_name,extra_file_name);

   if ((fp = fopen(extra_file_name,"w")) == NULL)
   {
       ins_message(ERR_MESG,"Error while opening EXTTRA FILE");
       proc_exit();
   }

}
/*-----------------------------------------------------*/
gen_file_name()
{


     nd_file_name.arr[0]   = '\0';   
     nd_file_name.len      = 0;

     p_rep_file_fax.arr[0]   = '\0';   
	 p_rep_file_fax.len      = 0;


     EXEC SQL 
	          SELECT LTRIM(RTRIM(TO_CHAR(RL_PRINT_CTL_SEQ.NEXTVAL,'00000009')))
	            INTO :nd_file_no
	            FROM DUAL;

     if (OERROR)
         ins_message(ORA_MESG,"Fetch failed on while getting file number");
      
     nd_file_no.arr[nd_file_no.len] = '\0';

	 check_for_print_destn_type();   // 17.05.2004

	 if (l_destn_rep_yn == 'Y')	
	     sprintf(nd_file_name.arr,"%srslt_%s.lis", WORKING_DIR,nd_file_no.arr);

	 if (l_destn_fax_yn == 'Y')		
	 {
		 gen_file_name_fax();
		 sprintf(p_rep_file_fax.arr,"%srslt_%s.lis", nd_file_name_fax.arr,nd_file_no.arr);

		 p_rep_file_fax.len  = strlen(p_rep_file_fax.arr);

		 if (l_destn_rep_yn != 'Y') 
			strcpy(nd_file_name.arr, p_rep_file_fax.arr);

     }
	 strcpy(nd_f_name,nd_file_name.arr);

	 nd_file_name.len = strlen(nd_file_name.arr);


     if ((fp = fopen(nd_file_name.arr,"w")) == NULL)
     {
         ins_message(ERR_MESG,"Error while opening file RSLT_FILE in gen_file_name");
         proc_exit();
     }

}
/*-----------------------------------------------------*/
close_hdr()
{
    EXEC SQL CLOSE RL_REQ_HDR_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"CLOSE failed on cursor RL_REQ_HDR_CUR");
}

/*-----------------------------------------------------*/
open_hdr()
{
    EXEC SQL OPEN RL_REQ_HDR_CUR;


	if (RESOURCE_BUSY)
	{
		ins_message(ORA_MESG,"OPEN failed resource busy RL_REQ_HDR_CUR");
	}

    if (OERROR)
	{
         ins_message(ORA_MESG,"OPEN failed on cursor RL_REQ_HDR_CUR");
	}


}
/*-----------------------------------------------------*/

fetch_hdr()
{
  rl_hdr_source_code.arr[0]            = '\0';
  rl_hdr_consultant_code.arr[0]        = '\0';
  rl_hdr_spec_regd_date_time.arr[0]    = '\0';
  rl_hdr_spec_recd_date_time.arr[0]    = '\0';
  rl_hdr_spec_colltd_date_time.arr[0]  = '\0';
  rl_hdr_current_date_time.arr[0]      = '\0';
  rl_hdr_section_code.arr[0]           = '\0';
  rl_hdr_request_comment_code1.arr[0]  = '\0';
  rl_hdr_request_comment_code2.arr[0]  = '\0';
  rl_hdr_request_comment_code3.arr[0]  = '\0';
  rl_hdr_request_comment_desc1.arr[0]  = '\0';
  rl_hdr_request_comment_desc2.arr[0]  = '\0';
  rl_hdr_request_comment_desc3.arr[0]  = '\0';
  rl_hdr_extra_copies_to.arr[0]        = '\0';
  rl_hdr_specimen_type_code.arr[0]     = '\0';
  rl_hdr_added_by_id.arr[0]            = '\0';
  rl_hdr_added_date.arr[0]             = '\0';
  rl_hdr_modified_by_id.arr[0]         = '\0';
  rl_hdr_modified_date.arr[0]          = '\0';
  rl_hdr_episode_type.arr[0]           = '\0';
  rl_hdr_urgent_indicator.arr[0]       = '\0';
  rl_hdr_source_type.arr[0]		       = '\0';
  rl_hdr_released_by_id.arr[0]		   = '\0';
  rl_hdr_released_date.arr[0]		   = '\0';
  rl_category_code.arr[0]			   = '\0';
  rl_category_year.arr[0]			   = '\0';
  rl_category_number.arr[0]			   = '\0';
  rl_regd_date.arr[0]				   = '\0';
  rl_ordered_facility_id.arr[0]		   = '\0';

  rl_hdr_source_code.len               = 0;
  rl_hdr_consultant_code.len           = 0;
  rl_hdr_spec_regd_date_time.len       = 0;
  rl_hdr_spec_recd_date_time.len       = 0;
  rl_hdr_spec_colltd_date_time.len     = 0;
  rl_hdr_current_date_time.len         = 0;
  rl_hdr_section_code.len              = 0;
  rl_hdr_request_comment_code1.len     = 0;
  rl_hdr_request_comment_code2.len     = 0;
  rl_hdr_request_comment_code3.len     = 0;
  rl_hdr_request_comment_desc1.len     = 0;
  rl_hdr_request_comment_desc2.len     = 0;
  rl_hdr_request_comment_desc3.len     = 0;
  rl_hdr_extra_copies_to.len           = 0;
  rl_hdr_specimen_type_code.len        = 0;
  rl_hdr_added_by_id.len               = 0;
  rl_hdr_added_date.len                = 0;
  rl_hdr_modified_by_id.len            = 0;
  rl_hdr_modified_date.len             = 0;
  rl_hdr_episode_type.len	       = 0;
  rl_hdr_urgent_indicator.len	       = 0;
  rl_hdr_source_type.len	       = 0;
  rl_hdr_released_by_id.len = 0;
  rl_hdr_released_date.len = 0;
  rl_category_code.len					= 0;
  rl_category_year.len					= 0;
  rl_category_number.len				= 0;
  rl_regd_date.len						= 0;
  rl_ordered_facility_id.len			= 0;

    EXEC SQL FETCH RL_REQ_HDR_CUR
              INTO :rl_hdr_source_code,
                   :rl_hdr_consultant_code,
                   :rl_hdr_spec_recd_date_time,
                   :rl_hdr_spec_regd_date_time,
			       :rl_hdr_spec_colltd_date_time,
                   :rl_hdr_current_date_time,
                   :rl_hdr_section_code,
                   :rl_hdr_request_comment_code1,
                   :rl_hdr_request_comment_code2,
                   :rl_hdr_request_comment_code3,
                   :rl_hdr_request_comment_desc1,
                   :rl_hdr_request_comment_desc2,
                   :rl_hdr_request_comment_desc3,
                   :rl_hdr_extra_copies_to,
                   :rl_hdr_specimen_type_code,
                   :rl_hdr_added_by_id,
                   :rl_hdr_added_date,
                   :rl_hdr_modified_by_id,
                   :rl_hdr_modified_date,
  				   :rl_hdr_urgent_indicator,
  				   :rl_hdr_episode_type,
				   :rl_hdr_source_type,
				   :rl_hdr_released_by_id,
				   :rl_hdr_released_date,
				   :rl_category_code,
				   :rl_category_year,
				   :rl_category_number,
				   :rl_regd_date,
				   :rl_ordered_facility_id;
    if (OERROR)
        ins_message(ORA_MESG,"FETCH failed on cursor RL_REQ_HDR_CUR");

    rl_hdr_source_code.arr[rl_hdr_source_code.len]		 	= '\0';
    rl_hdr_consultant_code.arr[rl_hdr_consultant_code.len]		= '\0';
    rl_hdr_spec_recd_date_time.arr[rl_hdr_spec_recd_date_time.len] 	= '\0';
    rl_hdr_spec_regd_date_time.arr[rl_hdr_spec_regd_date_time.len] 	= '\0';
    rl_hdr_spec_colltd_date_time.arr[rl_hdr_spec_colltd_date_time.len] = '\0';
    rl_hdr_current_date_time.arr[rl_hdr_current_date_time.len] 		= '\0';
    rl_hdr_section_code.arr[rl_hdr_section_code.len] 			= '\0';
    rl_hdr_request_comment_code1.arr[rl_hdr_request_comment_code1.len] = '\0';
    rl_hdr_request_comment_code2.arr[rl_hdr_request_comment_code2.len] = '\0';
    rl_hdr_request_comment_code3.arr[rl_hdr_request_comment_code3.len] = '\0';
    rl_hdr_request_comment_desc1.arr[rl_hdr_request_comment_desc1.len] = '\0';
    rl_hdr_request_comment_desc2.arr[rl_hdr_request_comment_desc2.len] = '\0';
    rl_hdr_request_comment_desc3.arr[rl_hdr_request_comment_desc3.len] = '\0';
    rl_hdr_extra_copies_to.arr[rl_hdr_extra_copies_to.len]             = '\0';
    rl_hdr_specimen_type_code.arr[rl_hdr_specimen_type_code.len]       = '\0';
    rl_hdr_added_by_id.arr[rl_hdr_added_by_id.len]                     = '\0';
    rl_hdr_added_date.arr[rl_hdr_added_date.len]                       = '\0';
    rl_hdr_modified_by_id.arr[rl_hdr_modified_by_id.len]               = '\0';
    rl_hdr_modified_date.arr[rl_hdr_modified_date.len]                 = '\0';
    rl_hdr_episode_type.arr[rl_hdr_episode_type.len]					= '\0';
    rl_hdr_urgent_indicator.arr[rl_hdr_urgent_indicator.len]			= '\0';
    rl_hdr_source_type.arr[rl_hdr_source_type.len]						= '\0';
    rl_hdr_released_by_id.arr[rl_hdr_released_by_id.len]				= '\0';
    rl_hdr_released_date.arr[rl_hdr_released_date.len]					= '\0';
	rl_category_code.arr[rl_category_code.len]							= '\0';
	rl_category_year.arr[rl_category_year.len]							= '\0';
	rl_category_number.arr[rl_category_number.len]						= '\0';
	rl_regd_date.arr[rl_regd_date.len]									= '\0';
	rl_ordered_facility_id.arr[rl_ordered_facility_id.len]				= '\0';

	/* To Override the Source Code which is sending through SY_PROG_PARAM *****/
/********** This portion is commented on 03/06/2001
		The result report should print in the current location of patient
	 strcpy(rl_prn_ctrl_hdr_source_code.arr, rl_hdr_source_code.arr);
	 rl_prn_ctrl_hdr_source_code.len = strlen(rl_prn_ctrl_hdr_source_code.arr);
********************************************/
	/*******************            *****/

    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/

fetch_dtl()
{
    EXEC SQL OPEN RL_REQ_DTL_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_REQ_DTL_CUR");

    for (i=0;i<6;i++)
    {
        rl_dtl_test_code[i].arr[0]         = '\0';
        rl_dtl_result_status[i].arr[0]     = '\0';
        rl_dtl_group_test_flag[i].arr[0]   = '\0';

        rl_dtl_test_code[i].len            = 0;
        rl_dtl_result_status[i].len        = 0;
        rl_dtl_group_test_flag[i].len      = 0;
    }

    EXEC SQL FETCH RL_REQ_DTL_CUR
              INTO :rl_dtl_test_code,
                   :rl_dtl_result_status,
                   :rl_dtl_group_test_flag;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_REQ_DTL_CUR");

    no_of_dtl_recs = sqlca.sqlerrd[2];

    for (i=0;i<sqlca.sqlerrd[2];i++)
    {
        rl_dtl_test_code[i].arr[rl_dtl_test_code[i].len]         = '\0';
        rl_dtl_result_status[i].arr[rl_dtl_result_status[i].len] = '\0';
        rl_dtl_group_test_flag[i].arr[rl_dtl_group_test_flag[i].len]  = '\0';
    }
}
/*-----------------------------------------------------*/
/******* modified order by on 29.09.2003 *******/
declare_tst_result_curs()
{
    sql_stmt.arr[0]		= '\0';  
	sql_stmt.len		= 0;
	
	strcpy(sql_stmt.arr, "SELECT B.specimen_no, \
					 B.GROUP_TEST_CODE, \
                     B.TEST_CODE, \
                     NVL(NUMERIC_PREFIX,'+'), \
                     NUMERIC_RESULT, \
					 RESULT_COMMENT_DESC1, \
                     RESULT_COMMENT_DESC2, \
                     RESULT_COMMENT_DESC3, \
                     RESULT_COMMENT_DESC4, \
					 TEST_UNITS, \
					 TEST_REF_RANGE_COMMENT, \
					 AGE_RANGE_LOW, \
					 AGE_RANGE_HIGH, \
                     B.ROWID AS row_id, \
					 NVL(HIDE_RESULT_COMMENTS_YN,'N'), \
					 B.high_low_ind, \
					 A.seq_no, \
					 NVL(B.cancelled_yn, 'N'), \
					 B.released_by_id, \
					 TO_CHAR(B.released_date, 'DD/MM/YYYY HH24:MI') \
                FROM RL_INTERVAL_TEST_TEMP A, RL_TEST_RESULT B \
               WHERE B.PATIENT_ID = :nd_hosp_no \
                 AND A.specimen_no = B.specimen_no \
				 AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id \
				 AND B.OPERATING_FACILITY_ID = :nd_operating_facility_id \
				 AND B.test_code = DECODE(A.test_code, NULL, B.test_code, A.test_code) \
				 AND B.group_test_code = A.group_test_code \
				 AND NVL(B.cancelled_yn, 'N') <> 'Y' \
				 AND A.user_id = 'RLRSENQ3' \
				 AND A.session_id = 1 ");
	
	if (d_interval_specimen_yn == 'Y')
		strcat(sql_stmt.arr, " ORDER BY B.test_code, B.specimen_no, B.GROUP_SEQ_NO,B.GROUP_TEST_CODE,B.TEST_SEQ_NO,B.TEST_CODE FOR UPDATE OF STATUS NOWAIT");
	else
		strcat(sql_stmt.arr, " ORDER BY B.GROUP_SEQ_NO,B.GROUP_TEST_CODE,B.TEST_SEQ_NO,B.TEST_CODE FOR UPDATE OF STATUS NOWAIT");

		 
	sql_stmt.len = strlen(sql_stmt.arr);
	EXEC SQL PREPARE sr1 FROM :sql_stmt;

	if (OERROR)
		 ins_message(ORA_MESG,"PREPARE failed on table RL_TEST_RESULT");

    EXEC SQL DECLARE rl_test_result_cur CURSOR FOR sr1;		

}
/*-----------------------------------------------------*/
open_tst_result_curs()
{
/////////////// 22.06.2003 modified added facility id also 

	EXEC SQL OPEN rl_test_result_cur USING :nd_hosp_no,:nd_operating_facility_id,:nd_operating_facility_id;

	if (RESOURCE_BUSY)
	{
		ins_message(ORA_MESG,"OPEN failed resource busy rl_test_result_cur");
	}


}
/*-----------------------------------------------------*/

/********** INCLUDED AS DYNAMIC SQL ***************
open_tst_result()
{
    EXEC SQL OPEN RL_TEST_RESULT_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_TEST_RESULT_CUR");
}
**********************/
/*-----------------------------------------------------*/
fetch_tst_result()
{

  rl_tst_group_test_code.arr[0]      = '\0';
  rl_tst_test_code.arr[0]      = '\0';
  rl_tst_numeric_prefix.arr[0]      = '\0';
  rl_tst_numeric_result.arr[0]      = '\0';
  rl_tst_result_comment_desc1.arr[0]      = '\0';
  rl_tst_result_comment_desc2.arr[0]      = '\0';
  rl_tst_result_comment_desc3.arr[0]      = '\0';
  rl_tst_result_comment_desc4.arr[0]      = '\0';
  rl_tst_rowid.arr[0]                     = '\0';
  rl_tst_cd_test_units.arr[0]			= '\0';
  rl_tst_cd_range_cmt.arr[0]		  = '\0';
  rl_tst_ran_low_val_nor.arr[0]	  = '\0';
  rl_tst_ran_high_val_nor.arr[0]	  = '\0';
  rl_tst_hide_rslt_comm_yn.arr[0] = '\0';
  d_specimen_no.arr[0]			  = '\0';
  rl_high_low_ind.arr[0]		  = '\0';
  rl_cancelled_yn.arr[0]			  = '\0';
  rl_released_by_id.arr[0]			  = '\0';
  rl_released_date.arr[0]			  = '\0';

  rl_tst_group_test_code.len         = 0;
  rl_tst_test_code.len         = 0;
  rl_tst_numeric_prefix.len         = 0;
  rl_tst_numeric_result.len         = 0;
  rl_tst_result_comment_desc1.len         = 0;
  rl_tst_result_comment_desc2.len         = 0;
  rl_tst_result_comment_desc3.len         = 0;
  rl_tst_result_comment_desc4.len         = 0;
  rl_tst_rowid.len                        = 0;
  rl_tst_cd_test_units.len		  = 0;
  rl_tst_cd_range_cmt.len		  = 0;
  rl_tst_ran_low_val_nor.len	  = 0;
  rl_tst_ran_high_val_nor.len	  = 0;
  rl_tst_hide_rslt_comm_yn.len	  = 0;
  d_specimen_no.len				  = 0;
  rl_high_low_ind.len			  = 0;
  rl_cancelled_yn.len			  = 0;
  rl_released_by_id.len			  = 0;
  rl_released_date.len			  = 0;

    EXEC SQL FETCH RL_TEST_RESULT_CUR
              INTO :d_specimen_no,
				   :rl_tst_group_test_code,
                   :rl_tst_test_code,
                   :rl_tst_numeric_prefix,
                   :rl_tst_numeric_result,
                   :rl_tst_result_comment_desc1,
                   :rl_tst_result_comment_desc2,
                   :rl_tst_result_comment_desc3,
                   :rl_tst_result_comment_desc4,
				   :rl_tst_cd_test_units,
				   :rl_tst_cd_range_cmt,
				   :rl_tst_ran_low_val_nor,
				   :rl_tst_ran_high_val_nor,
                   :rl_tst_rowid,
				   :rl_tst_hide_rslt_comm_yn,
				   :rl_high_low_ind, 
				   :rl_seq_no,
				   :rl_cancelled_yn,
				   :rl_released_by_id,
				   :rl_released_date;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_TEST_RESULT_CUR");

    rl_tst_group_test_code.arr[rl_tst_group_test_code.len] = '\0';
    rl_tst_test_code.arr[rl_tst_test_code.len] = '\0';
    rl_tst_numeric_prefix.arr[rl_tst_numeric_prefix.len] = '\0';
    rl_tst_numeric_result.arr[rl_tst_numeric_result.len] = '\0';
    rl_tst_result_comment_desc1.arr[rl_tst_result_comment_desc1.len] = '\0';
    rl_tst_result_comment_desc2.arr[rl_tst_result_comment_desc2.len] = '\0';
    rl_tst_result_comment_desc3.arr[rl_tst_result_comment_desc3.len] = '\0';
    rl_tst_result_comment_desc4.arr[rl_tst_result_comment_desc4.len] = '\0';
    rl_tst_rowid.arr[rl_tst_rowid.len] = '\0';
    rl_tst_cd_test_units.arr[rl_tst_cd_test_units.len]  	      = '\0';
    rl_tst_cd_range_cmt.arr[rl_tst_cd_range_cmt.len]		      = '\0';
    rl_tst_ran_low_val_nor.arr[rl_tst_ran_low_val_nor.len]	  = '\0';
    rl_tst_ran_high_val_nor.arr[rl_tst_ran_high_val_nor.len]	  = '\0';
    rl_tst_hide_rslt_comm_yn.arr[rl_tst_hide_rslt_comm_yn.len] = '\0';
	d_specimen_no.arr[d_specimen_no.len]					   = '\0';
	rl_high_low_ind.arr[rl_high_low_ind.len]				   = '\0';
	rl_cancelled_yn.arr[rl_cancelled_yn.len]				   = '\0';
	rl_released_by_id.arr[rl_released_by_id.len]			   = '\0';
	rl_released_date.arr[rl_released_date.len]				   = '\0';

	strcpy(nd_spec_no.arr, d_specimen_no.arr);
	nd_spec_no.len = strlen(nd_spec_no.arr);

#ifdef DEBUG
    printf("Group is <%s> tst is <%s>\n",rl_tst_group_test_code.arr,
                       rl_tst_test_code.arr);
	printf("In fetch_tst_result, last_row = %d \n",
	LAST_ROW);
#endif
    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/
fetch_tst_result1()
{

  rl_tst_group_test_code.arr[0]      = '\0';
  rl_tst_test_code.arr[0]      = '\0';
  rl_tst_numeric_prefix.arr[0]      = '\0';
  rl_tst_numeric_result.arr[0]      = '\0';
  rl_tst_result_comment_desc1.arr[0]      = '\0';
  rl_tst_result_comment_desc2.arr[0]      = '\0';
  rl_tst_result_comment_desc3.arr[0]      = '\0';
  rl_tst_result_comment_desc4.arr[0]      = '\0';
  rl_tst_rowid.arr[0]                     = '\0';
  rl_tst_cd_test_units.arr[0]			= '\0';
  rl_tst_cd_range_cmt.arr[0]		  = '\0';
  rl_tst_ran_low_val_nor.arr[0]	  = '\0';
  rl_tst_ran_high_val_nor.arr[0]	  = '\0';
  rl_tst_hide_rslt_comm_yn.arr[0] = '\0';

  rl_tst_group_test_code.len         = 0;
  rl_tst_test_code.len         = 0;
  rl_tst_numeric_prefix.len         = 0;
  rl_tst_numeric_result.len         = 0;
  rl_tst_result_comment_desc1.len         = 0;
  rl_tst_result_comment_desc2.len         = 0;
  rl_tst_result_comment_desc3.len         = 0;
  rl_tst_result_comment_desc4.len         = 0;
  rl_tst_rowid.len                        = 0;
  rl_tst_cd_test_units.len		  = 0;
  rl_tst_cd_range_cmt.len		  = 0;
  rl_tst_ran_low_val_nor.len	  = 0;
  rl_tst_ran_high_val_nor.len	  = 0;
  rl_tst_hide_rslt_comm_yn.len = 0;

    EXEC SQL FETCH RL_TEST_RESULT_CUR
              INTO :rl_tst_group_test_code,
                   :rl_tst_test_code,
                   :rl_tst_numeric_prefix,
                   :rl_tst_numeric_result,
                   :rl_tst_result_comment_desc1,
                   :rl_tst_result_comment_desc2,
                   :rl_tst_result_comment_desc3,
                   :rl_tst_result_comment_desc4,
				   :rl_tst_cd_test_units,
				   :rl_tst_cd_range_cmt,
				   :rl_tst_ran_low_val_nor,
				   :rl_tst_ran_high_val_nor,
                   :rl_tst_rowid,
				   :rl_tst_hide_rslt_comm_yn;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_TEST_RESULT_CUR");

    rl_tst_group_test_code.arr[rl_tst_group_test_code.len] = '\0';
    rl_tst_test_code.arr[rl_tst_test_code.len] = '\0';
    rl_tst_numeric_prefix.arr[rl_tst_numeric_prefix.len] = '\0';
    rl_tst_numeric_result.arr[rl_tst_numeric_result.len] = '\0';
    rl_tst_result_comment_desc1.arr[rl_tst_result_comment_desc1.len] = '\0';
    rl_tst_result_comment_desc2.arr[rl_tst_result_comment_desc2.len] = '\0';
    rl_tst_result_comment_desc3.arr[rl_tst_result_comment_desc3.len] = '\0';
    rl_tst_result_comment_desc4.arr[rl_tst_result_comment_desc4.len] = '\0';
    rl_tst_rowid.arr[rl_tst_rowid.len] = '\0';
    rl_tst_cd_test_units.arr[rl_tst_cd_test_units.len]  	      = '\0';
    rl_tst_cd_range_cmt.arr[rl_tst_cd_range_cmt.len]		      = '\0';
    rl_tst_ran_low_val_nor.arr[rl_tst_ran_low_val_nor.len]	  = '\0';
    rl_tst_ran_high_val_nor.arr[rl_tst_ran_high_val_nor.len]	  = '\0';
    rl_tst_hide_rslt_comm_yn.arr[rl_tst_hide_rslt_comm_yn.len] = '\0';

#ifdef DEBUG
    printf("Group is <%s> tst is <%s>\n",rl_tst_group_test_code.arr,
                       rl_tst_test_code.arr);
	printf("In fetch_tst_result, last_row = %d \n",
	LAST_ROW);
#endif
    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/

update_tst_result()
{

     EXEC SQL UPDATE RL_TEST_RESULT
                 SET STATUS = 'P',
		     MODIFIED_BY_ID = USER,
		     MODIFIED_DATE = SYSDATE
               WHERE ROWID       = :rl_tst_rowid;

     if (OERROR)
         ins_message(ORA_MESG,"UPDATE failed on table RL_TEST_RESULT");
}
/*-----------------------------------------------------*/
print_header()
{   char t_patient_id[16];   
    char sex_desc[11];
	char pat_name[60];
	char uline[82];
	char l_str[100];
    int i;

    pctr++;

	if (l_print_health_card_yn.arr[0]=='Y') 
		lctr = 20;
	else
	    lctr = 19;

    get_parameters();

/*---------*/
    fprintf(fp,"%c&a006L",ESC); /* Set the left Margin */
	fprintf(fp,"%c&k12S",ESC);	/* This makes the font size to increase to 12 */
	fprintf(fp,"%c&l6D",ESC);	/* Set the Density */
   	fprintf(fp,"%c(s4B",ESC);   /* Set Bold */
/*---------*/

    fprintf(fp,"\n%-*s%-.40s\n\n",(int)(((80 - sy_acc_entity_name.len)/2) - 6)," ",sy_acc_entity_name.arr);
    fprintf(fp,"%-*s%-.80s\n",(int)(((80 - rl_lab_title.len)/2) - 6)," ",rl_lab_title.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
   	fprintf(fp,"%c(s-3B",ESC);
    fprintf(fp,"%73.73sPage(s) : %3d\n"," ",pctr);
/*----------------------------------------*/


    if(rl_hdr_episode_type.arr[0] == 'R')
       if(strcmp(rl_pat_actual_id.arr,"NULL")==0)
	  strcpy(t_patient_id,nd_hosp_no.arr);
       else
	  strcpy(t_patient_id,rl_pat_actual_id.arr);
    else
       strcpy(t_patient_id,nd_hosp_no.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
//  fprintf(fp,"Patient ID : ");
	fprintf(fp,"HMC No.    : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/
	
	fprintf(fp,"%c&k12S",ESC);	
	fprintf(fp,"%c&l6D",ESC);
   	fprintf(fp,"%c(s4B",ESC);

    fprintf(fp,"%-15.15s",t_patient_id);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Section : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

	fprintf(fp, "%-s - %-s\n",rl_section_short_name.arr,
							  rl_section_tel_num.arr);


/********* added on 27/11/2002 for printing NEW MEDICOM NO FOR HMC ******/
/*----------------------------------------*/
	if(rl_hdr_episode_type.arr[0] == 'R')
	{
		get_new_medicom_no();
		if (strlen(nd_new_medicom_no.arr) > 0)
		{
			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s4B",ESC);
			fprintf(fp,"MEDICOM No.: ");
			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s-3B",ESC);   

			fprintf(fp,"%c&k12S",ESC);	
			fprintf(fp,"%c&l6D",ESC);
   			fprintf(fp,"%c(s4B",ESC);

			fprintf(fp,"%-15.15s\n",nd_new_medicom_no.arr);
	
			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s-3B",ESC);
		}
	}
/*----------------------------------------*/
/********* upto here added on 27/11/2002 for printing NEW MEDICOM NO FOR HMC ******/

/* added by c dinesh to print health card info 21/06/2002 */

if ((l_print_health_card_yn.arr[0]=='Y') && 
			 ( (rl_health_card_num.arr[0]!='\0') ||
			   (rl_health_num.arr[0] != '\0')
			  ))
	{

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Health Card No : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/
	
	fprintf(fp,"%c&k12S",ESC);	
	fprintf(fp,"%c&l6D",ESC);
   	fprintf(fp,"%c(s4B",ESC);

    fprintf(fp,"%-15.15s",rl_health_card_num.arr);


/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"    Health No  : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

	fprintf(fp,"%c&k12S",ESC);	
	fprintf(fp,"%c&l6D",ESC);
   	fprintf(fp,"%c(s4B",ESC);

    fprintf(fp,"%-14.14s\n", rl_health_num.arr);

}
/*--------------till here ----------------------*/
    for(i=0;i<87;i++)
        fprintf(fp,"_");
    fprintf(fp,"\n\n");

    if(rl_pat_sex.arr[0] == 'M')
	   strcpy(sex_desc,"MALE");
	else
	if(rl_pat_sex.arr[0] == 'F')
	   strcpy(sex_desc,"FEMALE");
	else
       strcpy(sex_desc,"");
    
	strcpy(pat_name,rl_pat_title.arr);
	if(strlen(rl_pat_title.arr) > 0)
	   strcat(pat_name," ");
	strcat(pat_name,rl_pat_short_name.arr);
    
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp,"Patient Name         : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-42.42s",pat_name);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Sex : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-8.8s\n",sex_desc);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Location             : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-42.42s",rl_source_short_name.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"DOB : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/
	
	fprintf(fp,"%-16.16s\n",rl_pat_date_of_birth.arr); 

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Clinical Information : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    if (rl_hdr_request_comment_desc1.len)
    {
      fprintf(fp,"%-40s\n",rl_hdr_request_comment_desc1.arr);
      page_break(1);
    }
	else
    {
      fprintf(fp,"\n");
      page_break(1);
    }

    if (rl_hdr_request_comment_desc2.len)
    {
       /*----------------------------------------*/
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s4B",ESC);
       fprintf(fp,"%-23.23s"," ");
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/
      fprintf(fp,"%-40s\n",rl_hdr_request_comment_desc2.arr);
      page_break(1);
    }

    if (rl_hdr_request_comment_desc3.len)
    {
       /*----------------------------------------*/
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s4B",ESC);
       fprintf(fp,"%-23.23s"," ");
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/
      fprintf(fp,"%-40s\n",rl_hdr_request_comment_desc3.arr);
      page_break(1);
    }
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Requesting Doctor    : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-33.33s",rl_consultant_short_name.arr);
				
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Request Date : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-s\n",rl_hdr_spec_recd_date_time.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Specimen Type        : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-33.33s",rl_spc_specimen_desc.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Regn Date    : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%s\n",rl_hdr_spec_regd_date_time.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Tests Requested      : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-33.33s"," ");

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Specimen No  : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

	if (d_interval_specimen_yn == 'Y')
		fprintf(fp,"%-9.9s (I)\n",first_specimen_no.arr);
	else
		fprintf(fp,"%-s\n",nd_spec_no.arr);

	sprintf(l_str,"%-6.6s"," ");

    for (i=0;i < no_of_dtl_recs;i++)
    {
       sprintf(l_str,"%s%-5s  ",l_str, rl_dtl_test_code[i].arr);
    }
    fprintf(fp,"%s\n",l_str);

    for(i=0;i<87;i++)
        fprintf(fp,"_");
    fprintf(fp,"\n\n");
}
/*---------------------------------------------------------*/
print_dtls()
{
  int next_line = 0;
  char range_cmnt_print_flag = 'N';
  char l_str [100],l_str1[100];
  int agesex_range_flag = FALSE;
  int path_review_flag = FALSE;
  numeric_value_flag = FALSE;
  strcpy(l_str,"");
  page_break(0);
  
  fetch_test_code(rl_tst_test_code.arr);
  
  /* Check to see if test result should be printed (Confidential Result) */

   if (rl_tst_cd_conf_yn.arr[0]	== 'N' || p_param7.arr[0] == 'X')
  {
  
  if(rl_tst_cd_inh_rep_yn.arr[0] == 'N')
  {
    spc_first = 1;
    fflush(fp);
    ind_test_prn = 0;

/********* Newly added to print only those reports 
	which is having some component or should print 
	  *********/

/***** changed on 13/04/2002 against scf - 42 of QATAR *********/
//		something_to_print = 1;	

/******** Newly added to print the specimen nos for the GTT Tests ****/
		if (d_interval_specimen_yn == 'Y')
		 {

			if (strcmp(rl_tst_test_code.arr, nd_test_code) != 0)
			{
				strcpy(nd_test_code, rl_tst_test_code.arr);
				l_seq_no = 1;
			}
			else
				l_seq_no++;

				sprintf(l_str,"Specimen No: %-15.15s", nd_spec_no.arr);
				print_line(l_str);
				strcpy(l_str,"");
				page_break(0);
		 }
/******* Upto here *******/ 


    if(rl_tst_cd_print_report_yn.arr[0] == 'Y')
	{
		if (d_interval_specimen_yn == 'Y')
		{
			get_interval_description();
			sprintf(l_str,"%-40.40s",interval_description.arr);
		}
		else
		{
		    if(test_desc_fill_for_report.len)   
			{
				if ((rl_tst_numeric_result.len) ||
					((rl_tst_result_comment_desc1.len || rl_tst_result_comment_desc2.len ||
						rl_tst_result_comment_desc3.len || rl_tst_result_comment_desc4.len)) &&
						(rl_tst_hide_rslt_comm_yn.arr[0] == 'N'))
				{
	
			          EXEC SQL SELECT RPAD(:rl_tst_cd_short_desc,40,:test_desc_fill_for_report) 
					   INTO :rl_tst_cd_short_desc
					   FROM DUAL;
					   rl_tst_cd_short_desc.arr[rl_tst_cd_short_desc.len] = '\0'; 
					   sprintf(l_str,"%-40.40s",rl_tst_cd_short_desc.arr);
				}
				else
     		           sprintf(l_str,"%-40.40s",rl_tst_cd_short_desc.arr);
			}
            else
     		  sprintf(l_str,"%-40.40s",rl_tst_cd_short_desc.arr);
		}
	}
    else
        sprintf(l_str,"%-40s"," ");
    strcpy(text_line,l_str);
    strcpy(test_description,l_str);

/********  added on 21.07.2003 ***/

    if (print_c_hist == 0)
	{    

//sprintf(string_var,"b4 cl.histy. %s",rl_tst_group_test_code.arr);
//disp_message(ERR_MESG,string_var);

	     print_clinical_history();    
		 print_c_hist = 1;
	}
/********  upto here *******/


    if (rl_tst_cd_numeric_result_yn.arr[0] == 'Y')
    {
	if (rl_tst_numeric_result.len)
	{

/****** ADDED ON 14/04/2002 AGAINST SCF - 42 *******/		
		something_to_print = 1;

        if ( (atof(rl_tst_numeric_result.arr) < 1) && 
			(atof(rl_tst_numeric_result.arr) > 0) )
             put_zero_before_decimal();

	  numeric_value_flag = TRUE;

/*********** for adding zero after result if no fraction part **********/

	  strcpy(r_rslt.arr, rl_tst_numeric_result.arr);
	  r_rslt.len = strlen(r_rslt.arr);
	  add_zero_after_result();
	  strcpy(rl_tst_numeric_result.arr, r_rslt.arr);
	  rl_tst_numeric_result.len = strlen(rl_tst_numeric_result.arr);

	  if(rl_tst_numeric_prefix.arr[0] == '+')
	  {
			 sprintf(l_str,"%s %-10s",l_str,rl_tst_numeric_result.arr);
          }
	  else
	  {
	        sprintf(l_str,"%s%c%-10s",l_str,rl_tst_numeric_prefix.arr[0],
					     rl_tst_numeric_result.arr);
          }
          strcpy(l_str1,l_str);
          ltrim(l_str1);
          rtrim(l_str1);

		  /**********
			THE BELOW PORTION IS COMMENTED ON 13/10/2003 BECAUSE
		  IF THE TEST_UNITS IS NOT MENIOTED AT THE TIME OF RELEASE OF RESULTS
			THEN THE TRANSACTION TABLE WILL NOT GET UPDATED WITH  TEST UNITS.
			LATER IF THEY DEFINED IN TEST CODE MASTER IT SHOULD NOT SHOW IN 
			QUERY SINCE IT MAY THE CR REPOSITORY**************


	  if (strlen(rl_tst_cd_test_units.arr) == 0)   
	  {
			strcpy(rl_tst_cd_test_units.arr,rl_tst_cd_test_units_2.arr);
			rl_tst_cd_test_units.len = strlen(rl_tst_cd_test_units.arr);
	  }
**************** upto here is commented **** the abv if commented on 27.10.2003 ***********/

          sprintf(l_str,"%s%-10s",l_str,rl_tst_cd_test_units.arr);

/******** CORRECTED ON 17/02/2004 AGAINST HMC RL-11 *********************
   	  if ((rl_tst_ran_low_val_nor.len  || rl_tst_ran_high_val_nor.len ) &&
		  (rl_pat_sex.arr[0] == 'M'    || rl_pat_sex.arr[0] == 'F'))
******** UPTO HERE CORRECTED ON 17/02/2004 AGAINST HMC RL-11 **************/

	      if ( rl_tst_ran_low_val_nor.len  ||
            rl_tst_ran_high_val_nor.len )
          {
		    get_zero_prefix_for_range();

			  strcpy(r_rslt.arr, rl_tst_ran_low_val_nor.arr);
			  r_rslt.len = strlen(r_rslt.arr);
 			  add_zero_after_result();
			  strcpy(rl_tst_ran_low_val_nor.arr, r_rslt.arr);
			  rl_tst_ran_low_val_nor.len = strlen(rl_tst_ran_low_val_nor.arr);

			  strcpy(r_rslt.arr, rl_tst_ran_high_val_nor.arr);
			  r_rslt.len = strlen(r_rslt.arr);
 			  add_zero_after_result();
			  strcpy(rl_tst_ran_high_val_nor.arr, r_rslt.arr);
			  rl_tst_ran_high_val_nor.len = strlen(rl_tst_ran_high_val_nor.arr);
			

			      sprintf(l_str,"%s %-1s (%s - %s)",l_str,
						rl_high_low_ind.arr,
                     rl_tst_ran_low_val_nor.arr,
                     rl_tst_ran_high_val_nor.arr);

		   				   agesex_range_flag = TRUE;
          }
          else
          {
              if(rl_tst_cd_range_cmt.len)
			  {
				   range_cmnt_print_flag = 'Y';
               }
               else
               {
				 if ((!(rl_tst_ran_low_val_nor.len)  &&	!(rl_tst_ran_high_val_nor.len) && 
					(rl_tst_cd_age_sex_range_yn.arr[0] == 'Y')) &&
					(rl_pat_sex.arr[0] == 'M' || rl_pat_sex.arr[0] == 'F'))
				 {

					fetch_age_sex_range();
					if ( rl_tst_ran_low_val_nor.len && rl_tst_ran_high_val_nor.len )
					{
					   get_zero_prefix_for_range();

						  strcpy(r_rslt.arr, rl_tst_ran_low_val_nor.arr);
						  r_rslt.len = strlen(r_rslt.arr);
						  add_zero_after_result();
						  strcpy(rl_tst_ran_low_val_nor.arr, r_rslt.arr);
						  rl_tst_ran_low_val_nor.len = strlen(rl_tst_ran_low_val_nor.arr);

						  strcpy(r_rslt.arr, rl_tst_ran_high_val_nor.arr);
					   	  r_rslt.len = strlen(r_rslt.arr);
 						  add_zero_after_result();
 						  strcpy(rl_tst_ran_high_val_nor.arr, r_rslt.arr);
						  rl_tst_ran_high_val_nor.len = strlen(rl_tst_ran_high_val_nor.arr);

				      sprintf(l_str,"%s %-1s (%-s - %s)",l_str,
							rl_high_low_ind.arr,
			             rl_tst_ran_low_val_nor.arr,
				         rl_tst_ran_high_val_nor.arr);
					}
					agesex_range_flag = TRUE;
				 }				
				 else if(rl_tst_cd_range_cmt_2.len)
				 {
					strcpy(rl_tst_cd_range_cmt.arr,rl_tst_cd_range_cmt_2.arr);
					rl_tst_cd_range_cmt.len = strlen(rl_tst_cd_range_cmt.arr);
					range_cmnt_print_flag = 'Y';
				 } 
                    }
          }
		
          strcpy(l_str1,l_str);
          ltrim(l_str1);
          rtrim(l_str1);
	    
          if(group && !group_printed)
          {
	       print_group_test_desc();
	       group_printed = 1;
          }
	    
          next_line = 0;

          if(range_cmnt_print_flag == 'Y')
          {
			if(strlen(rl_tst_cd_range_cmt.arr) <= (80 - strlen(l_str)))
			{
				sprintf(l_str,"%s%s",l_str,rl_tst_cd_range_cmt.arr);
			}
			else
				next_line = 1;         
          }
		
/// commented on 21.07.2003 since it should print even if numeric_result_print_yn = N also
//////	  print_clinical_history();

          print_line(l_str);
          test_printed  = 1;

          if(next_line == 1)
          {
	     sprintf(l_str,"%40.40s%40.40s"," ",rl_tst_cd_range_cmt.arr);
	     print_line(l_str);
          } 

	}   /*Endif of rl_tst_numeric_result.len */

    } /* Endif of rl_tst_cd_numeric_result_yn.arr */


    if(rl_tst_hide_rslt_comm_yn.arr[0] == 'N')
        print_comment_desc1234();

     print_test_comments();

     if(rl_tst_cd_culture_test_yn.arr[0] == 'Y')
	    print_culture();

     if (rl_tst_cd_text_block_yn.arr[0] == 'Y')
     {
        open_result_text();
	    splitting();
     }

     if (rl_tst_cd_snomed_yn.arr[0] == 'Y') 

          print_snomed();


	 print_result_modify_reason(); // to print modify reason if any and something_to_print = 1

     fflush(fp); 

  } /* end if of inh_rep_yn */

  } /* end if of confidential report*/
}
/*-----------------------------------------------------*/
print_test_comments()
{

  if (something_to_print ==  0 )
  {
	check_any_res_comp();

  }
  else
    other_than_comments = 1;


  if (other_than_comments > 0)
  {

	open_comments();
	_flushall();
	while(fetch_comments())
  {
    if (rl_comm_tst_comm_txt.len)
    {
	   //something_to_print = 1; 
       if(group && !group_printed)
       {
	      print_group_test_desc();
	      group_printed = 1;
       }
       if(test_printed)
       {  numeric_value_flag = TRUE;
          print_line_check(rl_comm_tst_comm_txt.arr);
       }
       else
       {
	      numeric_value_flag = FALSE;
	      sprintf(text_line,"%-40.40s%-40s",test_description,
			    rl_comm_tst_comm_txt.arr);
	      print_line_check(text_line);
	      test_printed = 1;
       }
     }
   }

   	close_comments_curs();

   _flushall();
 }

}
/*-----------------------------------------------------*/
print_line(char *t_str)
{
         fprintf(fp,"%s\n",t_str);
         page_break(1);

/******COMMENTED AGAINST SCF 42 OF QATAR - ******/
//		 something_to_print = 1;
}
/*-----------------------------------------------------*/
/***** newly added on 07/07/2003 against AL-JAZIRA SCF 85 ***********/
print_line_org_ant(char *t_str)
{
         fprintf(fp,"%s\n",t_str);

		 fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */

         page_break(1);

}
/*-----------------------------------------------------*/
print_line_check(char *t_str)
{
      if (numeric_value_flag == TRUE)
	  {
		fprint_repeat(fp,' ',40);
		print_line(t_str);
		numeric_value_flag = TRUE;
	  }
      else  
      {
		print_line(t_str);
		numeric_value_flag = TRUE;
	  }

/******COMMENTED AGAINST SCF 42 OF QATAR - ******/
//	  something_to_print = 1;
}
/*-----------------------------------------------------*/
print_test_desc(l_str)
char l_str[];
{
   if ((!ind_test_prn) &&
      (rl_tst_cd_group_test_yn.arr[0]  == 'N'))
   {
       if (rl_tst_cd_print_report_yn.arr[0] == 'Y')
           fprintf(fp,"%-40s%-36s%s",rl_tst_cd_short_desc.arr,l_str,
                           rl_curr_status);
       else
           fprintf(fp,"%-40s%-36s%s","",l_str,(tst_cd_ind)?rl_curr_status:"");
       ind_test_prn = 1;
       spc_first = 1;
    }
    else if (strlen(l_str))
           fprintf(fp,"%-40s%-40s","",l_str);

    if (tst_cd_ind) tst_cd_ind = 0;
}
/*-----------------------------------------------------*/

print_snomed()
{
	int ctr = 0;
	char prev_snomed_print_yn = 'N';

    open_result_snomed();
	

	_flushall();
    while (fetch_rl_result_snomed())
    {

        if (fetch_snomed_desc12345())
        {

	/***** NEWLY ADDED   *************/
		get_desc_snomed2();

	        if (rl_snomed_print_yn.arr[0] == 'Y' || rl_snomed2_print_yn.arr[0] == 'Y')
           	    print_snomed_desc12345();
			else
			{
			    something_to_print = 1;

				if(group && !group_printed)
				{
				   print_group_test_desc();
				  group_printed = 1;
				}
				if(!test_printed)
				{
					fprintf(fp,"%-40.40s\n",test_description);
					test_printed = 1;
				}
				print_str('Y');
				fprintf(fp, "\n");
				page_break(1);

/****************************** commented since new procedure print_str is added on 
		//     02/11/2002 for snomed code to be print y/n


					print_snomed_codes('Y');

					fprintf(fp, "\n");
					page_break(1);
******************************/				  


			}

	        ctr++;
        }
    }

	close_snomed_cur();

	_flushall();
}
/*-----------------------------------------------------*/

open_result_snomed()
{
    EXEC SQL OPEN RL_RESULT_SNOMED_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_RESULT_SNOMED_CUR");
}
/*-----------------------------------------------------*/

fetch_rl_result_snomed()
{
#ifdef DEBUG
       printf("In fetch_rl_result_snomed() \n");
#endif
    rl_res_snomed_code.arr[0]     = '\0';
	rl_res_snomed_code2.arr[0]	  = '\0';

    rl_res_snomed_code.len        = 0;
	rl_res_snomed_code2.len		  = 0;

    EXEC SQL FETCH RL_RESULT_SNOMED_CUR
              INTO :rl_res_snomed_code,
				   :rl_res_snomed_code2;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_RESULT_SNOMED_CUR");

    rl_res_snomed_code.arr[rl_res_snomed_code.len] = '\0';
	rl_res_snomed_code2.arr[rl_res_snomed_code2.len]	= '\0';

    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/
print_culture()
{

    char temp_sens_ind;
    char temp_line[81];
	char org[MAX_ORGANISMS][5];
    int still_org_dtl_left;
    int print_anti_flag = 0;
    int change_flag = 0;
	int e = 0;
    int anti_flag = 0;
    int c = 0, s = 0;
	int no_of_organisms = 0;
    int oflag = 1;
	int match_found = 0;

    open_result_organism();
	_flushall();
    while(fetch_result_org())
    {
        something_to_print = 1;

		strcpy(org[no_of_organisms],rl_res_organism_code.arr);
	    no_of_organisms++;

		if(group && !group_printed)
		{
			print_group_test_desc();
			group_printed = 1;
		}
		if(!test_printed)
		{
			sprintf(text_line,"%-40.40s",test_description);
			print_line(text_line);
			test_printed = 1;
		}

		if(oflag)
		{
		   	fprintf(fp,"%c&d0D",ESC);   /* Set  UnderLine ON*/

                        sprintf(text_line,"%-46.46s%-41.41s","ORGANISM","COMMENT");
			print_line_org_ant(text_line);

		   	fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */

			oflag = 0;
		}

		fetch_org_desc();

		sprintf(text_line,"%2d.   %-40.40s%-40.40s",no_of_organisms,
							rl_res_organism_code_desc.arr,
							rl_res_comment_desc.arr);
		print_line_org_ant(text_line);
	} 

	close_organism_cur();

	_flushall();

	if(no_of_organisms)
	{
		something_to_print = 1;
   	    fprintf(fp,"%c&d0D",ESC);   /* Set  UnderLine ON*/
		sprintf(text_line,"");
		for(c=0;c<87;c++)
			sprintf(text_line,"%s%s",text_line," ");
		print_line_org_ant(text_line);
   	    fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */

		sprintf(text_line,"%-46.46s","ANTIBIOTIC ");
		for(c=0;c<no_of_organisms;c++)	/* Print organism codes as column headings*/
			sprintf(text_line,"%s%2d     ",text_line,c+1);  /* c is printed in place of org[c]*/
		print_line_org_ant(text_line);

   	    fprintf(fp,"%c&d0D",ESC);   /* Set  UnderLine ON*/
		sprintf(text_line,"");
		for(c=0;c<87;c++)
			sprintf(text_line,"%s%s",text_line," ");
		print_line_org_ant(text_line);
	   	fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */

		open_sensitivity();
		fetch_sensitivity();

   	    fprintf(fp,"%c&d0D",ESC);   /* Set  UnderLine ON*/
		open_antibiotic();
		_flushall();
		while(fetch_antibiotic())
		{
			something_to_print = 1;
			strcpy(rl_res_dtl_antibiotic_code.arr,a_antibiotic_code.arr);
			rl_res_dtl_antibiotic_code.len = strlen(a_antibiotic_code.arr);
			fetch_antibiotic_desc();
		    sprintf(text_line,"%-47.47s",rl_res_dtl_antibiotic_desc.arr);
			
			for(e=0;e<no_of_organisms;e++)
			{
				match_found = 0;
				for(s=0; s<no_of_sensitivities; s++)
				{
					if( (strcmp(s_ant[s].arr, a_antibiotic_code.arr) == 0) &&
						(strcmp(s_org[s].arr, org[e]) == 0) )
					{
			            sprintf(text_line,"%s%-7.7s",text_line,s_ind[s].arr);
						match_found = 1;
						break;
					}
				}

				if(match_found == 0)
	               sprintf(text_line,"%s       ",text_line);
			}
			sprintf(text_line,"%-87.87s",text_line);			
			print_line_org_ant(text_line);
		}

		close_antibiotic_cur();

		sprintf(text_line,"%-35.35s%-52.52s"," ","S - Sensitive     R - Resistant   I - Intermediate");
		print_line_org_ant(text_line);
	   	fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */

	}
	fprintf(fp,"%c&d@",ESC);   /* Set UnderLine OFF */
}
/*-----------------------------------------------------*/
scan_and_prnt(l_str)
char *l_str;
{
   for(;*l_str != '\0';l_str++)
   {
     fprintf(fp,"%c",*l_str);
     if (*l_str == '\n')
        page_break(1);
   }
   fprintf(fp,"\n");
   page_break(1);
}
/*-----------------------------------------------------*/

open_result_organism()
{
    EXEC SQL OPEN RL_RESULT_ORGANISM_CUR;
    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_RESULT_ORGANISM_CUR");
}
/*-----------------------------------------------------*/

open_antibiotic()
{
    EXEC SQL OPEN RL_ANTIBIOTIC_CUR;
    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_ANTIBIOTIC_CUR");
}

/*-----------------------------------------------------*/
fetch_antibiotic()
{
    a_antibiotic_code.arr[0]   = '\0';
    a_antibiotic_code.len	   = 0;

    EXEC SQL FETCH RL_ANTIBIOTIC_CUR
              INTO a_antibiotic_code;
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_RESULT_ORGANISM_CUR");

    a_antibiotic_code.arr[a_antibiotic_code.len]   = '\0';
    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/
fetch_result_org()
{
    rl_res_organism_code.arr[0]   = '\0';
    rl_res_comment_desc.arr[0]    = '\0';

    rl_res_organism_code.len      = 0;
    rl_res_comment_desc.len       = 0;

    EXEC SQL FETCH RL_RESULT_ORGANISM_CUR
              INTO :rl_res_organism_code,
                   :rl_res_comment_desc;
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_RESULT_ORGANISM_CUR");

    rl_res_organism_code.arr[rl_res_organism_code.len] = '\0';
    rl_res_comment_desc.arr[rl_res_comment_desc.len] = '\0';
    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/

fetch_org_desc()
{
    
//	EXEC SQL OPEN RL_ORGANISM_CODE_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_ORGANISM_CODE_CUR");

    rl_res_organism_code_desc.arr[0] = '\0';
    rl_res_organism_code_desc.len    = 0;

    EXEC SQL SELECT LONG_DESC
			 INTO :rl_res_organism_code_desc
             FROM RL_ORGANISM_CODE
             WHERE ORGANISM_CODE = :rl_res_organism_code;

/*
    EXEC SQL FETCH RL_ORGANISM_CODE_CUR
              INTO :rl_res_organism_code_desc;

*/

    rl_res_organism_code_desc.arr[rl_res_organism_code_desc.len] = '\0';

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_ORGANISM_CODE_CUR");
}
/*-----------------------------------------------------*/

fetch_antibiotic_desc()
{
    
//	EXEC SQL OPEN RL_ANTIBIOTIC_CODE_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_ANTIBIOTIC_CODE_CUR");

    rl_res_dtl_antibiotic_desc.arr[0] = '\0';
    rl_res_dtl_antibiotic_desc.len    = 0;

    EXEC SQL SELECT SUBSTR(LONG_DESC,1,39)
			 INTO :rl_res_dtl_antibiotic_desc
             FROM RL_ANTIBIOTIC_CODE
             WHERE ANTIBIOTIC_CODE = :rl_res_dtl_antibiotic_code;

/*
    EXEC SQL FETCH RL_ANTIBIOTIC_CODE_CUR
              INTO :rl_res_dtl_antibiotic_desc;

*/
    rl_res_dtl_antibiotic_desc.arr[rl_res_dtl_antibiotic_desc.len] = '\0';

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_ANTIBIOTIC_CODE_CUR");
}
/*-----------------------------------------------------*/
open_sensitivity()
{

    EXEC SQL OPEN RL_SENSITIVITY_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_SENSITIVITY_CUR");
}
/*-----------------------------------------------------*/

fetch_sensitivity()
{
   int i;
   char str[100];   

   no_of_sensitivities = 0;

   for(i=0;i<MAX_ANTIBIOTICS;i++)
   {
		s_ant[i].arr[0] = '\0';
		s_org[i].arr[0] = '\0';
		s_ind[i].arr[0] = '\0';

		s_ant[i].len = 0;
		s_org[i].len = 0;
		s_ind[i].len = 0;
   }

   EXEC SQL FETCH RL_SENSITIVITY_CUR
	         INTO :s_org,
			      :s_ant,
			      :s_ind;

   if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_SENSITIVITY_CUR");

   for(i=0;i<MAX_ANTIBIOTICS;i++)
   {
		s_org[i].arr[s_org[i].len] = '\0';
		if(strlen(s_org[i].arr) == 0)
		   break;
		s_ant[i].arr[s_ant[i].len] = '\0';
		s_ind[i].arr[s_ind[i].len] = '\0';
   }
   no_of_sensitivities = i;
}
/*-----------------------------------------------------*/

fetch_other_dtls()
{
	if(strcmp(rl_hdr_episode_type.arr,"I")==0 || 
       strcmp(rl_hdr_episode_type.arr,"O")==0 ||
	   strcmp(rl_hdr_episode_type.arr,"H")==0 )
    { 
        declare_inpat_curs();
	
    }
	else 
		declare_refpat_curs();

   fetch_pat_name();
   fetch_spec_desc();
   fetch_source();
   fetch_consultant();
   fetch_section();
}

/*-----------------------------------------------------*/
declare_inpat_curs()
{
	EXEC SQL DECLARE RL_PAT_MAST_CUR CURSOR FOR
              SELECT TITLE_CODE,
	 	     SHORT_NAME,
                     SEX,
                     NATIONALITY_CODE,
                     ROUND(TRUNC(TO_DATE(:rl_hdr_spec_regd_date_time,
				   'DD/MM/YYYY HH24:MI')) - DATE_OF_BIRTH),
                     TO_CHAR(DATE_OF_BIRTH,'DD/MM/YYYY') ,
					 NVL(actual_dob_yn, 'N'),
					 race_code,
                     ROUND((TRUNC(TO_DATE(:rl_hdr_spec_regd_date_time,
				   'DD/MM/YYYY HH24:MI')) - DATE_OF_BIRTH)/365)
                FROM MP_PATIENT_MAST
               WHERE PATIENT_ID = :nd_hosp_no;
}
/*-----------------------------------------------------*/
declare_refpat_curs()
{
    EXEC SQL DECLARE RL_PAT_MAST3_CUR CURSOR FOR
              SELECT TITLE_CODE,
		     SHORT_NAME,
                     SEX,
                     NATIONALITY_CODE,
                     ROUND(TRUNC(TO_DATE(:rl_hdr_spec_regd_date_time,
				    'DD/MM/YYYY HH24:MI')) - DATE_OF_BIRTH),
                     TO_CHAR(DATE_OF_BIRTH,'DD/MM/YYYY'),
		     SUBSTR(NVL(ACTUAL_PATIENT_ID,'NULL'),1,10),
					NVL(actual_dob_yn, 'N'), 
					race_code,
                     ROUND((TRUNC(TO_DATE(:rl_hdr_spec_regd_date_time,
				   'DD/MM/YYYY HH24:MI')) - DATE_OF_BIRTH)/365),
				   location
                FROM RL_PATIENT_MAST
               WHERE PATIENT_ID = :nd_hosp_no;
			   /* AND OPERATING_FACILITY_ID = :nd_operating_facility_id; */
}
/*-----------------------------------------------------*/
fetch_pat_name()
{
    rl_pat_title.arr[0]     = '\0';
    rl_pat_long_name.arr[0]     = '\0';
    rl_pat_short_name.arr[0]     = '\0';
    rl_pat_sex.arr[0]           = '\0';
    rl_pat_nationality.arr[0]           = '\0';
    rl_pat_dob_no_of_days.arr[0]           = '\0';
    rl_pat_date_of_birth.arr[0]            = '\0';
    rl_pat_blood_group.arr[0]              = '\0';
    rl_pat_g6pd.arr[0]              = '\0';
    rl_pat_sicc.arr[0]              = '\0';
    rl_pat_hbl4_1.arr[0]              = '\0';
    rl_pat_hbl4_2.arr[0]              = '\0';
	rl_actual_dob_yn.arr[0]			  = '\0';
	rl_race_code.arr[0]				  = '\0';
	rl_age_years.arr[0]				  = '\0';
	rl_location.arr[0]				  = '\0';

    rl_pat_title.len     = 0;
    rl_pat_long_name.len         = 0;
    rl_pat_short_name.len         = 0;
    rl_pat_sex.len         = 0;
    rl_pat_nationality.len         = 0;
    rl_pat_dob_no_of_days.len         = 0;
    rl_pat_date_of_birth.len          = 0;
    rl_pat_g6pd.len                   = 0;
    rl_pat_sicc.len                   = 0;
    rl_pat_hbl4_1.len                   = 0;
    rl_pat_hbl4_2.len                   = 0;
	rl_actual_dob_yn.len				= 0;
	rl_race_code.len					= 0;
	rl_age_years.len					= 0;
	rl_location.len						= 0;

	if(strcmp(rl_hdr_episode_type.arr,"I")==0 || 
       strcmp(rl_hdr_episode_type.arr,"O")==0 ||
	   strcmp(rl_hdr_episode_type.arr,"H")==0 )
    { 

		rl_pat_actual_id.arr[0]   = '\0';
		rl_pat_actual_id.len      = 0;

    EXEC SQL OPEN RL_PAT_MAST_CUR;

    if (OERROR)
        ins_message(ORA_MESG,"OPEN failed on cursor RL_PAT_MAST_CUR");

    EXEC SQL FETCH RL_PAT_MAST_CUR
              INTO :rl_pat_title,
		   :rl_pat_short_name,
                   :rl_pat_sex,
                   :rl_pat_nationality,
                   :rl_pat_dob_no_of_days,
                   :rl_pat_date_of_birth, 
				   :rl_actual_dob_yn,
				   :rl_race_code,
				   :rl_age_years;

		

	close_mast_cur();

	if (l_print_health_card_yn.arr[0]=='Y') 
	{
		get_health_card_num();
	}

    if (OERROR)
       ins_message(ORA_MESG,"Error with MP_PATIENT_MAST fetch");
    else
	   if(NODATAFOUND)
	   {    
			rl_pat_actual_id.arr[0]   = '\0';
			rl_pat_actual_id.len      = 0;

                EXEC SQL OPEN RL_PAT_MAST3_CUR;
    		EXEC SQL FETCH RL_PAT_MAST3_CUR
              	         INTO   :rl_pat_title,
			        :rl_pat_short_name,
                   		:rl_pat_sex,
                   		:rl_pat_nationality,
                   		:rl_pat_dob_no_of_days,
                   		:rl_pat_date_of_birth,
						:rl_pat_actual_id,
						:rl_actual_dob_yn,
						:rl_race_code,
						:rl_age_years, 
						:rl_location;
               if (OERROR)
                  ins_message(ORA_MESG,"Error with RL_PATIENT_MAST fetch");	
               else
					if(NODATAFOUND);

			close_mast3_cur();

       }
	}
	else
	{
	    rl_pat_actual_id.arr[0]   = '\0';
		rl_pat_actual_id.len      = 0;
             EXEC SQL OPEN RL_PAT_MAST3_CUR;
    		EXEC SQL FETCH RL_PAT_MAST3_CUR
              	         INTO   :rl_pat_title,
			        :rl_pat_short_name,
                   		:rl_pat_sex,
                   		:rl_pat_nationality,
                   		:rl_pat_dob_no_of_days,
                   		:rl_pat_date_of_birth,
						:rl_pat_actual_id,
						:rl_actual_dob_yn,
						:rl_race_code, 
						:rl_age_years,
						:rl_location;
               if (OERROR)
                  ins_message(ORA_MESG,"Error with RL_PATIENT_MAST fetch");	
               else
	          if(NODATAFOUND);

			close_mast3_cur();


	}
    rl_pat_title.arr[rl_pat_title.len]                   = '\0';
    rl_pat_long_name.arr[rl_pat_long_name.len]           = '\0';
    rl_pat_short_name.arr[rl_pat_short_name.len]         = '\0';
    rl_pat_long_name.arr[rl_pat_long_name.len]           = '\0';
    rl_pat_short_name.arr[rl_pat_short_name.len]         = '\0';
    rl_pat_sex.arr[rl_pat_sex.len]                       = '\0';
    rl_pat_nationality.arr[rl_pat_nationality.len]       = '\0';
    rl_pat_dob_no_of_days.arr[rl_pat_dob_no_of_days.len] = '\0';
    rl_pat_date_of_birth.arr[rl_pat_date_of_birth.len]   = '\0';
    rl_pat_actual_id.arr[rl_pat_actual_id.len]           = '\0';
	rl_actual_dob_yn.arr[rl_actual_dob_yn.len]			 = '\0';
	rl_race_code.arr[rl_race_code.len]					 = '\0';
	rl_age_years.arr[rl_age_years.len]					 = '\0';
	rl_location.arr[rl_location.len]					 = '\0';

}

/*-----------------------------------------------------*/
fetch_spec_desc()
{

//    EXEC SQL OPEN RL_SPECIMEN_TYPE_CODE_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_SPECIMEN_TYPE_CODE_CUR");

    rl_spc_specimen_desc.arr[0] = '\0';
    rl_spc_specimen_desc.len    = 0;

		EXEC SQL SELECT SPECIMEN_DESC
				 INTO :rl_spc_specimen_desc
				 FROM RL_SPECIMEN_TYPE_CODE
				 WHERE SPECIMEN_TYPE_CODE = :rl_hdr_specimen_type_code;

/*
    EXEC SQL FETCH RL_SPECIMEN_TYPE_CODE_CUR
              INTO :rl_spc_specimen_desc;

*/
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_SPECIMEN_TYPE_CODE_CUR");

    rl_spc_specimen_desc.arr[rl_spc_specimen_desc.len] = '\0';

}
/*-----------------------------------------------------*/

fetch_test_code(loc_tst_code)
char loc_tst_code[];
{
    strcpy(rl_loc_test_code.arr,loc_tst_code);
    rl_loc_test_code.len  =  strlen(rl_loc_test_code.arr);

//    EXEC SQL OPEN RL_TEST_CODE_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_TEST_CODE_CUR");

    rl_tst_cd_short_desc.arr[0]         = '\0';
    rl_tst_cd_numeric_result_yn.arr[0]  = '\0';
    rl_tst_cd_age_sex_range_yn.arr[0]   = '\0';
    rl_tst_cd_function_yn.arr[0]        = '\0';
    rl_tst_cd_print_report_yn.arr[0]    = '\0';
    rl_tst_cd_low_value_normal.arr[0]   = '\0';
    rl_tst_cd_high_value_normal.arr[0]  = '\0';
    rl_tst_cd_test_units_2.arr[0]   = '\0';
    rl_tst_cd_group_test_yn.arr[0]      = '\0';
    rl_tst_cd_text_block_yn.arr[0]      = '\0';
    rl_tst_cd_culture_test_yn.arr[0]    = '\0';
    rl_tst_cd_snomed_yn.arr[0]          = '\0';
    rl_tst_cd_range_cmt_2.arr[0]        = '\0';
	rl_tst_cd_inh_rep_yn.arr[0]		    = '\0';
	rl_tst_cd_conf_yn.arr[0]		    = '\0';

    rl_tst_cd_short_desc.len            = 0;
    rl_tst_cd_numeric_result_yn.len     = 0;
    rl_tst_cd_age_sex_range_yn.len      = 0;
    rl_tst_cd_function_yn.len           = 0;
    rl_tst_cd_print_report_yn.len       = 0;
    rl_tst_cd_low_value_normal.len      = 0;
    rl_tst_cd_high_value_normal.len     = 0;
    rl_tst_cd_test_units_2.len      = 0;
    rl_tst_cd_group_test_yn.len         = 0;
    rl_tst_cd_text_block_yn.len         = 0;
    rl_tst_cd_culture_test_yn.len       = 0;
    rl_tst_cd_snomed_yn.len             = 0;
    rl_tst_cd_range_cmt_2.len           = 0;
	rl_tst_cd_inh_rep_yn.len		    = 0;
	rl_tst_cd_conf_yn.len				= 0;

    rl_tst_cd_no_of_decimals = 0;
    rl_tst_cd_significant_digit = 0;

    EXEC SQL SELECT LONG_DESC,
                     NUMERIC_RESULT_YN,
                     AGE_SEX_RANGE_YN,
                     FUNCTION_YN,
                     PRINT_NAME_YN,
                     LOW_VALUE_NORMAL,
                     HIGH_VALUE_NORMAL,
                     GROUP_TEST_YN,
                     TEXT_BLOCK_YN,
                     CULTURE_TEST_YN,
                     SNOMED_YN,
                     TEST_UNITS,
                     NVL(NO_OF_DECIMALS,0),
                     NVL(SIGNIFICANT_DIGIT,0),
					 REF_RANGE_COMMENT,
					 NVL(INHIBIT_REPORT_YN,'N'),
					 NVL(CONFIDENTIAL_YN,'N')    
              INTO :rl_tst_cd_short_desc,
                   :rl_tst_cd_numeric_result_yn,
                   :rl_tst_cd_age_sex_range_yn,
                   :rl_tst_cd_function_yn,
                   :rl_tst_cd_print_report_yn,
                   :rl_tst_cd_low_value_normal,
                   :rl_tst_cd_high_value_normal,
                   :rl_tst_cd_group_test_yn,
                   :rl_tst_cd_text_block_yn,
                   :rl_tst_cd_culture_test_yn,
                   :rl_tst_cd_snomed_yn,
                   :rl_tst_cd_test_units_2,
                   :rl_tst_cd_no_of_decimals,
                   :rl_tst_cd_significant_digit,
                   :rl_tst_cd_range_cmt_2,
				   :rl_tst_cd_inh_rep_yn,
				   :rl_tst_cd_conf_yn
                FROM RL_TEST_CODE
               WHERE TEST_CODE = :rl_loc_test_code
                 AND INHIBIT_REPORT_YN = 'N';

/*
    EXEC SQL FETCH RL_TEST_CODE_CUR
              INTO :rl_tst_cd_short_desc,
                   :rl_tst_cd_numeric_result_yn,
                   :rl_tst_cd_age_sex_range_yn,
                   :rl_tst_cd_function_yn,
                   :rl_tst_cd_print_report_yn,
                   :rl_tst_cd_low_value_normal,
                   :rl_tst_cd_high_value_normal,
                   :rl_tst_cd_group_test_yn,
                   :rl_tst_cd_text_block_yn,
                   :rl_tst_cd_culture_test_yn,
                   :rl_tst_cd_snomed_yn,
                   :rl_tst_cd_test_units_2,
                   :rl_tst_cd_no_of_decimals,
                   :rl_tst_cd_significant_digit,
                   :rl_tst_cd_range_cmt_2,
				   :rl_tst_cd_inh_rep_yn,
				   :rl_tst_cd_conf_yn;

*/

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_TEST_CODE_CUR");

    rl_tst_cd_short_desc.arr[rl_tst_cd_short_desc.len] = '\0';
    rl_tst_cd_numeric_result_yn.arr[rl_tst_cd_numeric_result_yn.len] = '\0';
    rl_tst_cd_age_sex_range_yn.arr[rl_tst_cd_age_sex_range_yn.len] = '\0';
    rl_tst_cd_function_yn.arr[rl_tst_cd_function_yn.len] = '\0';
    rl_tst_cd_print_report_yn.arr[rl_tst_cd_print_report_yn.len] = '\0';
    rl_tst_cd_low_value_normal.arr[rl_tst_cd_low_value_normal.len] = '\0';
    rl_tst_cd_high_value_normal.arr[rl_tst_cd_high_value_normal.len] = '\0';
    rl_tst_cd_test_units_2.arr[rl_tst_cd_test_units_2.len] = '\0';
    rl_tst_cd_group_test_yn.arr[rl_tst_cd_group_test_yn.len] = '\0';
    rl_tst_cd_text_block_yn.arr[rl_tst_cd_text_block_yn.len] = '\0';
    rl_tst_cd_culture_test_yn.arr[rl_tst_cd_culture_test_yn.len] = '\0';
    rl_tst_cd_snomed_yn.arr[rl_tst_cd_snomed_yn.len] = '\0';
    rl_tst_cd_range_cmt_2.arr[rl_tst_cd_range_cmt_2.len] = '\0';
    rl_tst_cd_inh_rep_yn.arr[rl_tst_cd_inh_rep_yn.len] = '\0';
	rl_tst_cd_conf_yn.arr[rl_tst_cd_conf_yn.len]	   = '\0';		

    rl_tst_cd_no_of_decimals = rl_tst_cd_no_of_decimals>9?9:
                         rl_tst_cd_no_of_decimals;
    rl_tst_cd_significant_digit = rl_tst_cd_no_of_decimals>9?9:
                         rl_tst_cd_significant_digit;

    if (sqlca.sqlerrd[2]) tst_cd_ind = 1;
    return (sqlca.sqlerrd[2]);
}
/*-----------------------------------------------------*/

fetch_source()
{
    if (rl_hdr_source_type.arr[0] == 'W') 
      {
      EXEC SQL  SELECT LONG_DESC
		  INTO :rl_source_short_name
                  FROM IP_WARD
                 WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
				   AND WARD_CODE = :rl_hdr_source_code;
      }
    else if (rl_hdr_source_type.arr[0] == 'E') 
      {
      EXEC SQL  SELECT LONG_DESC,
		       NO_OF_COPIES
		  INTO :rl_source_short_name,
		       :sy_ref_no_of_copies
                  FROM RL_REFERRAL
                 WHERE REFERRAL_CODE = :rl_hdr_source_code;
      }
    else if (rl_hdr_source_type.arr[0] == 'C') 
      {
      EXEC SQL  SELECT LONG_DESC
		  INTO :rl_source_short_name
                  FROM OP_CLINIC
                 WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
				   AND CLINIC_CODE = :rl_hdr_source_code;
      }
    else
       ins_message(ORA_MESG,"Invalid Source type in Request Header");
	      
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on SOURCE master ");

    rl_source_short_name.arr[rl_source_short_name.len] = '\0';
}
/*-----------------------------------------------------*/

fetch_consultant()
{
    if (rl_hdr_episode_type.arr[0] == 'I') 
      {
      EXEC SQL  SELECT FULL_NAME
		  INTO :rl_consultant_short_name
                  FROM SY_PHYSICIAN_MAST
                 WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
				   AND PHYSICIAN_ID = :rl_hdr_consultant_code;
      }
    else if (rl_hdr_episode_type.arr[0] == 'R' || rl_hdr_episode_type.arr[0] == 'H')
      {
      EXEC SQL  SELECT LONG_NAME
		  INTO :rl_consultant_short_name
                  FROM RL_CONSULTANTS
                 WHERE REF_CONSULTANT_ID = :rl_hdr_consultant_code;
      }
    else if (rl_hdr_episode_type.arr[0] == 'O') 
      {
      EXEC SQL  SELECT FULL_NAME
		  INTO :rl_consultant_short_name
                  FROM SY_PHYSICIAN_MAST
                 WHERE FACILITY_ID = NVL(:rl_ordered_facility_id, :nd_operating_facility_id)
				   AND PHYSICIAN_ID = :rl_hdr_consultant_code;
      }
    else
       ins_message(ORA_MESG,"Invalid Episode type in Request Header");
	      
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on CONSULTANT Master ");

    rl_consultant_short_name.arr[rl_consultant_short_name.len] = '\0';
}
/*-----------------------------------------------------*/
fetch_section()
{

//    EXEC SQL OPEN RL_SECTION_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_SECTION_CUR");

    rl_section_short_name.arr[0] 	= '\0';
    rl_section_short_name.len		= 0;
  
    EXEC SQL SELECT SUBSTR(LONG_NAME,1,30)
			 INTO :rl_section_short_name
             FROM RL_SECTION_CODE
             WHERE SECTION_CODE = :rl_hdr_section_code;

/*   
    EXEC SQL FETCH RL_SECTION_CUR
              INTO :rl_section_short_name;

*/
    rl_section_short_name.arr[rl_section_short_name.len] = '\0';

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_SECTION_CUR");

}
/*-----------------------------------------------------*/

fetch_age_sex_range()
{

//    EXEC SQL OPEN RL_AGE_SEX_RANGE_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_AGE_SEX_RANGE_CUR",0,"");

    rl_tst_ran_low_val_nor.arr[0]      = '\0';
    rl_tst_ran_high_val_nor.arr[0]      = '\0';

    rl_tst_ran_low_val_nor.len         = 0;
    rl_tst_ran_high_val_nor.len         = 0;

  EXEC SQL SELECT NVL(physician_age_low_value, LOW_VALUE_NORMAL),
                     NVL(physician_age_high_value, HIGH_VALUE_NORMAL)
		   INTO :rl_tst_ran_low_val_nor,
                   :rl_tst_ran_high_val_nor
           FROM RL_AGE_SEX_RANGE
           WHERE TEST_CODE = :rl_tst_test_code
           AND SEX       = :rl_pat_sex
           AND :rl_pat_dob_no_of_days
	          BETWEEN CALC_MIN_AGE_IN_DAYS  AND 
           CALC_MAX_AGE_IN_DAYS;

/*
    EXEC SQL FETCH RL_AGE_SEX_RANGE_CUR
              INTO :rl_tst_ran_low_val_nor,
                   :rl_tst_ran_high_val_nor;
*/
 
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_AGE_SEX_RANGE_CUR",0,"");

    rl_tst_ran_low_val_nor.arr[rl_tst_ran_low_val_nor.len] = '\0';
    rl_tst_ran_high_val_nor.arr[rl_tst_ran_high_val_nor.len] = '\0';
}
/*-----------------------------------------------------*/

open_comments()
{
    EXEC SQL OPEN RL_COMM_FOR_TEST_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_COMM_FOR_TEST_CUR");
}
/*-----------------------------------------------------*/
fetch_comments()
{
#ifdef DEBUG
       printf("In fetch_comments() \n");
#endif

    rl_comm_tst_comm_txt.arr[0]     = '\0';
    rl_comm_tst_comm_txt.len        = 0;

    EXEC SQL FETCH RL_COMM_FOR_TEST_CUR
              INTO :rl_comm_tst_comm_txt;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_COMM_FOR_TEST_CUR");

    rl_comm_tst_comm_txt.arr[rl_comm_tst_comm_txt.len] = '\0';

    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/
print_comment_desc1234()
{
  if (rl_tst_result_comment_desc1.len || rl_tst_result_comment_desc2.len ||
     rl_tst_result_comment_desc3.len || rl_tst_result_comment_desc4.len)
  {  
     something_to_print = 1;
     if(group && !group_printed)
     {   print_group_test_desc();
	     group_printed = 1;
     }
     if(test_printed)
	    numeric_value_flag = TRUE;
     else
	 {
	    numeric_value_flag = FALSE;
        fprintf(fp,"%-40.40s",test_description);
	    test_printed = 1;
     }
     if (rl_tst_result_comment_desc1.len != 0)
         print_line_check(rl_tst_result_comment_desc1.arr);
     if (rl_tst_result_comment_desc2.len != 0)
         print_line_check(rl_tst_result_comment_desc2.arr);
     if (rl_tst_result_comment_desc3.len != 0)
         print_line_check(rl_tst_result_comment_desc3.arr);
     if (rl_tst_result_comment_desc4.len != 0)
         print_line_check(rl_tst_result_comment_desc4.arr);
  }
}
/*-----------------------------------------------------*/

fetch_snomed_desc12345()
{
    
//	EXEC SQL OPEN RL_SNOMED_CODE_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_SNOMED_CODE_CUR");

#ifdef DEBUG
       printf("In fetch_snomed_desc1234() \n");
#endif
    rl_snomed_desc1.arr[0]          = '\0';
    rl_snomed_desc2.arr[0]          = '\0';
    rl_snomed_desc3.arr[0]          = '\0';
    rl_snomed_desc4.arr[0]          = '\0';
    rl_snomed_desc5.arr[0]          = '\0';
    rl_snomed_print_yn.arr[0]       = '\0';
	rl_print_snomed_code_yn.arr[0]  = '\0';

    rl_snomed_desc1.len             = 0;
    rl_snomed_desc2.len             = 0;
    rl_snomed_desc3.len             = 0;
    rl_snomed_desc4.len             = 0;
    rl_snomed_desc5.len             = 0;
    rl_snomed_print_yn.len			= 0;
	rl_print_snomed_code_yn.len		= 0;

/**************** changed on 01/09/2002 
                   :rl_snomed_desc2,
                   :rl_snomed_desc3,
                   :rl_snomed_desc4,
                   :rl_snomed_desc5,

                     DESCRIPTION_2,
                     DESCRIPTION_3,
                     DESCRIPTION_4,
                     DESCRIPTION_5,
**********************************************/

	EXEC SQL SELECT SUBSTR(DESCRIPTION_1, 1, 12),
					 NVL(PRINT_YN, 'N'),
					 NVL(print_code_yn, 'N')
              INTO :rl_snomed_desc1,
    			   :rl_snomed_print_yn,
				   :rl_print_snomed_code_yn
             FROM RL_SNOMED_CODE
             WHERE SNOMED_CODE = :rl_res_snomed_code;

/*
    EXEC SQL FETCH RL_SNOMED_CODE_CUR
              INTO :rl_snomed_desc1,
                   :rl_snomed_desc2,
                   :rl_snomed_desc3,
                   :rl_snomed_desc4,
                   :rl_snomed_desc5,
    		   :rl_snomed_print_yn;

*/

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_SNOMED_CODE_CUR");

    rl_snomed_desc1.arr[rl_snomed_desc1.len] = '\0';
    rl_snomed_desc2.arr[rl_snomed_desc2.len] = '\0';
    rl_snomed_desc3.arr[rl_snomed_desc3.len] = '\0';
    rl_snomed_desc4.arr[rl_snomed_desc4.len] = '\0';
    rl_snomed_desc5.arr[rl_snomed_desc5.len] = '\0';
    rl_snomed_print_yn.arr[rl_snomed_print_yn.len] = '\0';
	rl_print_snomed_code_yn.arr[rl_print_snomed_code_yn.len]	= '\0';

   return (sqlca.sqlerrd[2]);
}
/*-----------------------------------------------------*/
print_snomed_desc12345()
{
  if(rl_snomed_desc1.len  || rl_snomed_desc2.len  ||
     rl_snomed_desc3.len  || rl_snomed_desc4.len  || 
     rl_snomed_desc5.len  || rl_snomed2_desc1.len || 
	 rl_snomed2_desc2.len || rl_snomed2_desc3.len || 
	 rl_snomed2_desc4.len || rl_snomed2_desc5.len ) 
  {
  
    something_to_print = 1;

    if(group && !group_printed)
    {   print_group_test_desc();
	group_printed = 1;
    }
    if(!test_printed)
    {
       fprintf(fp,"%-40.40s\n",test_description);
       test_printed = 1;
    }

/****************************/

//	print_snomed_codes('Y');
	print_str('N');
	fprintf(fp, " - ");
/**************************/

	if (rl_snomed_desc1.len != 0 && rl_snomed_print_yn.arr[0] == 'Y')
    {
		 fprintf(fp,"%-20s",rl_snomed_desc1.arr);
		 fprintf(fp, " | ");
		 if (rl_snomed2_desc1.len == 0 || rl_snomed2_print_yn.arr[0] == 'N')
		 {
			fprintf(fp, "\n");
			page_break(1);
		 }
	}
	else
	{
		if (rl_snomed2_desc1.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
		{
			fprint_repeat(fp,' ',20);	
			fprintf(fp, " | ");
		}
	}

	if (rl_snomed2_desc1.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
	{
			fprintf(fp,"%s\n",rl_snomed2_desc1.arr);
			page_break(1);
	}
	    
/*-----------------------*/    
    if (rl_snomed_desc2.len != 0 && rl_snomed_print_yn.arr[0] == 'Y')
    {
		 print_snomed_codes('N');	
		 fprintf(fp, " - ");
		 fprintf(fp,"%-20s",rl_snomed_desc2.arr);
		 fprintf(fp, " | ");
		 if (rl_snomed2_desc2.len == 0 || rl_snomed2_print_yn.arr[0] == 'N')
		 {
			fprintf(fp, "\n");
			page_break(1);

		 }
	}
	else
	{
		if (rl_snomed2_desc2.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
		{
			print_snomed_codes('N');		
			fprintf(fp, " - ");
			fprint_repeat(fp,' ',20);
			fprintf(fp, " | ");
		}
	}

	if (rl_snomed2_desc2.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
	{
			fprintf(fp,"%s\n",rl_snomed2_desc2.arr);
			page_break(1);
	}
    
/*-----------------------*/    

    if (rl_snomed_desc3.len != 0 && rl_snomed_print_yn.arr[0] == 'Y')
    {

		print_snomed_codes('N');	
		fprintf(fp, " - ");
		fprintf(fp,"%-20s",rl_snomed_desc3.arr);
		fprintf(fp, " | ");
		if (rl_snomed2_desc3.len == 0 || rl_snomed2_print_yn.arr[0] == 'N')
		{
			fprintf(fp, "\n");
			page_break(1);

		}
	}
	else
	{
		if (rl_snomed2_desc3.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
		{
			print_snomed_codes('N');	
			fprintf(fp, " - ");
			fprint_repeat(fp,' ',20);
			fprintf(fp, " | ");
		}
	}

	if (rl_snomed2_desc3.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
	{
	        fprintf(fp,"%s\n",rl_snomed2_desc3.arr);
			page_break(1);
	}

/*-----------------------*/        

    if (rl_snomed_desc4.len != 0 && rl_snomed_print_yn.arr[0] == 'Y')
    {
		 print_snomed_codes('N');	
		 fprintf(fp, " - ");
		 fprintf(fp,"%-20s",rl_snomed_desc4.arr);
		 fprintf(fp, " | ");
		 if (rl_snomed2_desc4.len == 0 || rl_snomed2_print_yn.arr[0] == 'N')
		 {
			fprintf(fp, "\n");
			page_break(1);

		 }
	}
	else
	{
		if (rl_snomed2_desc4.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
		{
			print_snomed_codes('N');	
			fprintf(fp, " - ");
			fprint_repeat(fp,' ',20);
			fprintf(fp, " | ");
		}
	}

	if (rl_snomed2_desc4.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
	{
			fprintf(fp,"%s\n",rl_snomed2_desc4.arr);
			page_break(1);
	}

/*-----------------------*/            

	if (rl_snomed_desc5.len != 0 && rl_snomed_print_yn.arr[0] == 'Y')	
	{
			print_snomed_codes('N');	
			fprintf(fp, " - ");
			fprintf(fp,"%-20s",rl_snomed_desc5.arr);
			fprintf(fp, " | ");
			if (rl_snomed2_desc5.len == 0 || rl_snomed2_print_yn.arr[0] == 'N')
			{
				fprintf(fp, "\n");
				page_break(1);

			}
	}
	else
	{
		if (rl_snomed2_desc5.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
		{
			print_snomed_codes('N');	
			fprintf(fp, " - ");
			fprint_repeat(fp,' ',20);
			fprintf(fp, " | ");
		}
	}

	if (rl_snomed2_desc5.len != 0 && rl_snomed2_print_yn.arr[0] == 'Y')
	{

			fprintf(fp,"%s\n",rl_snomed2_desc5.arr);
			page_break(1);
	}

  
/************* old snomed logic *****************
    if (rl_snomed_desc1.len != 0)
    {
         fprint_repeat(fp,' ',40);
         fprintf(fp,"%s\n",rl_snomed_desc1.arr);
         page_break(1);
    }
    if (rl_snomed_desc2.len != 0)
    {
         fprint_repeat(fp,' ',40);
         fprintf(fp,"%s\n",rl_snomed_desc2.arr);
         page_break(1);
    }
    if (rl_snomed_desc3.len != 0)
    {
         fprint_repeat(fp,' ',40);
         fprintf(fp,"%s\n",rl_snomed_desc3.arr);
         page_break(1);
    }
    if (rl_snomed_desc4.len != 0)
    {
         fprint_repeat(fp,' ',40);
         fprintf(fp,"%s\n",rl_snomed_desc4.arr);
         page_break(1);
    }
    if (rl_snomed_desc5.len != 0)
    {
         fprint_repeat(fp,' ',40);
         fprintf(fp,"%s\n",rl_snomed_desc5.arr);
         page_break(1);
    }
************* UPTO HERE old snomed logic *****************/


  }
}
/*-----------------------------------------------------*/

fprint_repeat(l_fp,l_prn_chr,l_no)
FILE *l_fp;
char l_prn_chr;
int  l_no;
{
   int l_i = 0;

   for (l_i = 0;l_i < l_no;l_i++)
        fputc(l_prn_chr,l_fp);
}
/*-----------------------------------------------------*/

page_break(l_skip)
int l_skip;
{
    lctr+= l_skip;
    if (lctr == 0 || lctr > MAX_LINES)
    {
       if (lctr != 0)
	   {
		   if (strcmp(rl_report_format.arr, "1") == 0)
               print_footer(1);
		  else if (strcmp(rl_report_format.arr, "2") == 0)
				print_footer2(1);
		  else
				print_footer3(2);

		}

					   if (strcmp(rl_report_format.arr, "1") == 0)
					   {
//qatar
							print_header();
						}
					   else if (strcmp(rl_report_format.arr, "2") == 0)
					   {
//kn
							print_header2();
					   }
					   else
					   {
//mf & su
							print_header3();
					   }

    }
}
/*-----------------------------------------------------*/
open_result_text()
{
    EXEC SQL OPEN RL_RESULT_TEXT_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_RESULT_TEXT_CUR");
}
/*-----------------------------------------------------*/

fetch_result_text()
{
#ifdef DEBUG
       printf("In fetch_result_text() \n");
#endif

    rl_res_result_text.arr[0]  = '\0';

    EXEC SQL FETCH RL_RESULT_TEXT_CUR
              INTO rl_res_result_text ;
			  
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_RESULT_TEXT_CUR",0,"");

    rl_res_result_text.arr[rl_res_result_text.len] = '\0';

    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/
calc_func_and_prn(l_str,l_str2)
char l_str[],l_str2[];
{
   int func_ctr = 0;

   strcpy(rl_loc_test_code.arr,l_str);
   rl_loc_test_code.len = strlen(rl_loc_test_code.arr);
   open_function_cur();
   strcpy(rl_func_str.arr,"");
   _flushall();
   while (fetch_function_cur())
   {
        func_ctr ++;
        strcpy(rl_func_value.arr,rl_func_operand_1.arr);

        if (rl_func_operand_1_type.arr[0] == 'T')
             get_rl_test_result(rl_func_operand_1.arr);

	if(test_result_found == 0)
	{
	   l_str2[0] = '\0'; 
	   break;
        }
        strcat(rl_func_str.arr,rl_func_value.arr);
        strcat(rl_func_str.arr," ");

        if (func_ctr != 1)
             calculate_value();

        if (rl_func_operator_1.len == 0)
             break;

        strcat(rl_func_str.arr,rl_func_operator_1.arr);
        strcat(rl_func_str.arr," ");
        strcpy(rl_func_value.arr,rl_func_operand_2.arr);

        if (rl_func_operand_2_type.arr[0] == 'T')
             get_rl_test_result(rl_func_operand_2.arr);

	if(test_result_found == 0)
	{
	   l_str2[0] = '\0'; 
	   break;
        }

        strcat(rl_func_str.arr,rl_func_value.arr);
        strcat(rl_func_str.arr," ");
        calculate_value();

        if (rl_func_operator_2.len == 0)
             break;

        strcat(rl_func_str.arr,rl_func_operator_2.arr);
        strcat(rl_func_str.arr," ");
   }
   ltrim(rl_func_str.arr); 
   rtrim(rl_func_str.arr); 
   
	close_function_cur();

   rl_func_str.arr[9] = '\0';
   if (rl_tst_cd_no_of_decimals != 0 ||
             rl_tst_cd_significant_digit != 0)
      get_deci_sig_dig(rl_func_str.arr, p_no_of_decimals, p_significant_digit);
   rl_func_str.arr[5] = '\0';
   sprintf(l_str2,"%-10s",rl_func_str.arr);
#ifdef DEBUG
    printf("func str is <%s> str is <%s>\n",rl_func_str.arr,l_str2);
#endif
}
/*-----------------------------------------------------*/

open_function_cur()
{
    EXEC SQL OPEN RL_FUNCTION_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_FUNCTION_CUR");
}
/*-----------------------------------------------------*/

fetch_function_cur()
{
    rl_func_operand_1.arr[0]          = '\0';
    rl_func_operand_1_type.arr[0]     = '\0';
    rl_func_operator_1.arr[0]         = '\0';
    rl_func_operand_2.arr[0]          = '\0';
    rl_func_operand_2_type.arr[0]     = '\0';
    rl_func_operator_2.arr[0]         = '\0';

    rl_func_operand_1.len             = 0;
    rl_func_operand_1_type.len        = 0;
    rl_func_operator_1.len            = 0;
    rl_func_operand_2.len             = 0;
    rl_func_operand_2_type.len        = 0;
    rl_func_operator_2.len            = 0;

    EXEC SQL FETCH RL_FUNCTION_CUR
              INTO :rl_func_operand_1,
                   :rl_func_operand_1_type,
                   :rl_func_operator_1,
                   :rl_func_operand_2,
                   :rl_func_operand_2_type,
                   :rl_func_operator_2;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_FUNCTION_CUR");

    rl_func_operand_1.arr[rl_func_operand_1.len]           = '\0';
    rl_func_operand_1_type.arr[rl_func_operand_1_type.len] = '\0';
    rl_func_operator_1.arr[rl_func_operator_1.len]         = '\0';
    rl_func_operand_2.arr[rl_func_operand_2.len]           = '\0';
    rl_func_operand_2_type.arr[rl_func_operand_2_type.len] = '\0';
    rl_func_operator_2.arr[rl_func_operator_2.len]         = '\0';

    return (LAST_ROW?0:1);
}
/*-----------------------------------------------------*/

calculate_value()
{
    sprintf(rl_calc_str.arr,"SELECT %s FROM DUAL",rl_func_str.arr);
    rl_calc_str.len = strlen(rl_calc_str.arr);
    EXEC SQL PREPARE STR1 FROM :rl_calc_str;
    if (OERROR)
         ins_message(ORA_MESG,"PREPARE failed on table DUAL");

    EXEC SQL DECLARE CUR1 CURSOR FOR STR1;

    EXEC SQL OPEN CUR1;
    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor CUR1");

    rl_func_str.arr[0] = '\0';
    rl_func_str.len    = 0;

    EXEC SQL FETCH CUR1
              INTO :rl_func_str;

    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor CUR1");

    rl_func_str.arr[rl_func_str.len] = '\0';
    strcat(rl_func_str.arr," ");

	close_cur1_cur();

}
/*-----------------------------------------------------*/
get_rl_test_result(l_test_code)
char l_test_code[];
{
    test_result_found = 1;
    strcpy(rl_loc_test_code.arr,l_test_code);
    rl_loc_test_code.len = strlen(rl_loc_test_code.arr);

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;

    rl_func_value.arr[0] = '\0';
    rl_func_value.len    = 0;

    EXEC SQL SELECT NUMERIC_RESULT INTO :rl_func_value
               FROM RL_TEST_RESULT
              WHERE PATIENT_ID      = :nd_hosp_no
                AND SPECIMEN_NO     = :nd_spec_no
                AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND TEST_CODE       = :rl_loc_test_code;

    if(NODATAFOUND);
/*
    {
	       ins_message(ORA_MESG,"Error occurred at get_rl_test_result() Test not found.");
       proc_exit();
    }
*/
    rl_func_value.arr[rl_func_value.len] = '\0';

    if(strlen(rl_func_value.arr) == 0)
       test_result_found = 0;

    return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   ins_message(ORA_MESG,"Error occurred at get_rl_test_result()");
   return;

}
/*-----------------------------------------------------*/
print_footer(foot_ind)
int foot_ind;
{
   int fi = 0;
   char l_str[100];
   l_str[0] = '\0'; 

   for(fi=0; fi < 87; fi++)
       fprintf(fp,"%c",'_');

   fprintf(fp,"\n");

   fflush(fp);

   /*----------------------------------------*/
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s4B",ESC);
   fprintf(fp,"Release Date : ");
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s-3B",ESC);   
   sprintf(l_str,"%s",rl_hdr_released_date.arr);
   fprintf(fp,"%-25.25s",l_str);
   /*----------------------------------------*/

   /*----------------------------------------*/
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s4B",ESC);
   fprintf(fp,"Released/Reviewed By : ");
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s-3B",ESC);   
   fprintf(fp,"%-s\n",rl_hdr_released_by_id.arr);
   /*----------------------------------------*/

   /*----------------------------------------*/
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s4B",ESC);
   fprintf(fp,"Reprint Date : ");
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s-3B",ESC);   
   /*----------------------------------------*/
   
   if (rl_prn_ctrl_hdr_rp_yn.arr[0] == 'Y')
       sprintf(l_str,"%-16.16s         ",nd_result_printed_date.arr);
   else
       sprintf(l_str,"%-16.16s         ",nd_result_printed_date.arr);
   fprintf(fp,"%s",nd_result_printed_date.arr);

   /*----------------------------------------*/

   if (rl_hdr_extra_copies_to.len && copy == 2 ) 
   {
      /*----------------------------------------*/
      fprintf(fp,"%c&k4S",ESC); 
      fprintf(fp,"%c(s4B",ESC);
      fprintf(fp,"Copy To : ");
      fprintf(fp,"%c&k4S",ESC); 
      fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/

      sprintf(l_str,"%24.24s",rl_hdr_extra_copies_to.arr);
   }
   else
      sprintf(l_str,"%34.34s"," ");

   fprintf(fp,"%s\n",l_str);

   if(last_page == 0)
      sprintf(l_str,"%-73.73s--CONTINUED--"," ");
   else
      sprintf(l_str,"%-73.73s      --END--"," ");

   fprintf(fp,"%s\f",l_str);

   lctr = 0;
  
}
/*-----------------------------------------------------*/

ltrim(l_str)
char *l_str;
{
   char *ptr;
   ptr = l_str;
   while (*ptr== ' ') ptr++;
   for(;*ptr!='\0';ptr++,l_str++)
    *l_str = *ptr;
   *l_str = '\0';
}
/*-----------------------------------------------------*/

rtrim(l_str)
char *l_str;
{
  while (*l_str != '\0') *l_str++;
  l_str--;
  while (*l_str == ' ') *l_str--;
  *(l_str+1) = '\0';
}

/*-----------------------------------------------------*/
get_deci_sig_dig(loc_str,no_of_dec,signif)

 char *loc_str;
 EXEC SQL BEGIN DECLARE SECTION;
 int no_of_dec;
 EXEC SQL END DECLARE SECTION;
/// int signif;
{
  char significant_digits_applied_yn = 'N';
  signif    = 0;
  d_dec_pos = 0;
  d_after_sig_digit = 0;  

  d_loc_str.arr[0] = '\0';
  d_dec_part.arr[0] = '\0';
  d_int_part.arr[0] = '\0';
  d_sig_part.arr[0] = '\0';

  d_loc_str.len     = 0;
  d_dec_part.len    = 0;
  d_int_part.len    = 0;
  d_sig_part.len    = 0;

  strcpy(d_loc_str.arr,loc_str);
  d_loc_str.len = strlen(d_loc_str.arr);
/*--- The following IF splits the result into two parts : INTEGER & DECIMAL --*/
  EXEC SQL SELECT INSTR(:d_loc_str,'.') INTO :d_dec_pos FROM DUAL;
  if(d_dec_pos > 0)
  {
      EXEC SQL SELECT SUBSTR(:d_loc_str,1,:d_dec_pos - 1) INTO :d_int_part FROM DUAL;
      d_int_part.arr[d_int_part.len] = '\0';
      if(strlen(d_loc_str.arr) > d_dec_pos )
      {
         EXEC SQL SELECT SUBSTR(:d_loc_str,:d_dec_pos + 1,LENGTH(:d_loc_str)) 
			  	    INTO :d_dec_part FROM DUAL;

         d_dec_part.arr[d_dec_part.len] = '\0';
      }
  }
  else
  {
     strcpy(d_int_part.arr,d_loc_str.arr);
     d_int_part.len = strlen(d_int_part.arr);
  }
/*-- This IF is to take care of the INTEGER part of the Result ---------------*/
  if(strlen(d_int_part.arr))
  {
    if(signif > 0)
    {
       if(strlen(d_int_part.arr) <= signif)
       {
          strcpy(d_l_str.arr,d_int_part.arr);
       }
       else
       {
		  significant_digits_applied_yn = 'Y';

		  EXEC SQL SELECT SUBSTR(:d_int_part,1,:signif) INTO :d_sig_part FROM DUAL;


		  d_sig_part.arr[d_sig_part.len] = '\0';

		  EXEC SQL SELECT TO_NUMBER(SUBSTR(:d_int_part,:signif + 1,1)) INTO :d_after_sig_digit FROM DUAL;

		  if(d_after_sig_digit >= 5)
		  {
			 EXEC SQL SELECT TO_CHAR(TO_NUMBER(:d_sig_part) + 1)
								INTO :d_sig_part FROM DUAL;
				 d_sig_part.arr[d_sig_part.len] = '\0'; 
		  }
			  EXEC SQL SELECT RPAD(:d_sig_part,LENGTH(:d_int_part),'0')
				 INTO :d_l_str FROM DUAL;
			  d_l_str.arr[d_l_str.len] = '\0'; 
       }
    }
    else
    {
       strcpy(d_l_str.arr,d_int_part.arr);
    }
  }         
/*-- This IF is to take care of the INTEGER part of the Result ---------------*/
if(strlen(d_dec_part.arr))
{
  if(no_of_dec > 0)
  {
     strcpy(d_l_str.arr,strcat(d_l_str.arr,"."));
     d_l_str.len = strlen(d_l_str.arr);
     if(strlen(d_dec_part.arr) <= no_of_dec) 
     {
        strcpy(d_l_str.arr,strcat(d_l_str.arr,d_dec_part.arr));
	d_l_str.len = strlen(d_l_str.arr);
     }
     else
     {
        EXEC SQL SELECT :d_l_str || SUBSTR(:d_dec_part,1,:no_of_dec)
                   INTO :d_l_str FROM DUAL;
        d_l_str.arr[d_l_str.len] = '\0';
     }
  }
}
  strcpy(loc_str,d_l_str.arr);
}
/*-----------------------------------------------------*/

split_num(l_str,l_var1,l_var2)
char l_str[];
char *l_var1, *l_var2;
{
  int i=0,j=0;
  for (i=0;(l_str[i]!='\0' && l_str[i] != '.');i++,l_var1++)
     *l_var1 = l_str[i];
  *l_var1 = '\0';
  for (i++,j=0;(l_str[i]!='\0');i++,j++,l_var2++)
     *l_var2 = l_str[i];
  *l_var2 = '\0';
}
/*----------------------------------------------------------*/
update_rl_request_header()
{
     EXEC SQL SELECT COUNT(*) INTO :c_count
              FROM   RL_REQUEST_DETAIL
              WHERE  SPECIMEN_NO = TO_NUMBER(:c_spec_no)
	      AND OPERATING_FACILITY_ID = :nd_operating_facility_id
		  AND    NVL(RESULT_STATUS,' ') != 'P';
     if (NODATAFOUND)
	 ;
         if (OERROR)
              ins_message(ORA_MESG,"Failed in function update_rl_request_header()");
         c_count.arr[c_count.len] ='\0';

         if(atoi(c_count.arr) == 0)
		 {
	
			d_found.arr[0]	= '\0';
			d_found.len		= 0;

			EXEC SQL SELECT 'x' 
			INTO :d_found
			FROM RL_REQUEST_HEADER 
			WHERE SPECIMEN_NO = TO_NUMBER(:c_spec_no)
			AND OPERATING_FACILITY_ID = :nd_operating_facility_id
			FOR UPDATE OF STATUS NOWAIT; 

			d_found.arr[d_found.len]		= '\0';

	         if (OERROR)
		          ins_message(ORA_MESG,"Failed in function update_rl_request_header()");
			
	 		if (RESOURCE_BUSY)
			{
				ins_message(ORA_MESG,"OPEN failed resource busy update_rl_request_header()");
			}
			else
			{

					EXEC SQL UPDATE RL_REQUEST_HEADER 
					SET STATUS = 'P',
					RESULT_PRINTED_DATE = to_date(:nd_result_printed_date,'DD/MM/YYYY HH24:MI:SS'),
					MODIFIED_BY_ID = USER,
					MODIFIED_DATE = SYSDATE
					WHERE SPECIMEN_NO = TO_NUMBER(:c_spec_no);
			}
		 }

         if (OERROR)
              ins_message(ORA_MESG,"Failed in function update_rl_request_header()");
}
/*----------------------------------------------------------*/
update_rl_request_detail()
{   
    int fetch_c_rl_request_detail();

/***** changed on 06/04/2003 because of windows shut down problem in oracle 9.2 **/
	/************
    strcpy(sql_stmt.arr,"SELECT TEST_CODE, GROUP_TEST_YN FROM RL_REQUEST_DETAIL WHERE SPECIMEN_NO = TO_NUMBER(:v1) AND OPERATING_FACILITY_ID = :nd_operating_facility_id for update of result_status NOWAIT");
    sql_stmt.len = strlen(sql_stmt.arr);
    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL PREPARE S FROM :sql_stmt;
    EXEC SQL DECLARE C CURSOR FOR S;
    EXEC SQL OPEN C USING :c_spec_no;
	****************/

	EXEC SQL DECLARE c CURSOR FOR 
				SELECT TEST_CODE, GROUP_TEST_YN 
				FROM RL_REQUEST_DETAIL
				WHERE SPECIMEN_NO = TO_NUMBER(:c_spec_no)
				AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				for update of result_status NOWAIT;


	EXEC SQL OPEN c;

	if (RESOURCE_BUSY)
	{
		ins_message(ORA_MESG,"OPEN failed resource busy rl_request_detail");
	}
	else    /// 22.09.2003
	{
		while(1)
		{
			EXEC SQL FETCH C INTO :c_req_dtl_test_code,:c_group_test_yn;
			if(NODATAFOUND)
				return;
		        c_req_dtl_test_code.arr[c_req_dtl_test_code.len] = '\0';
				c_group_test_yn.arr[c_group_test_yn.len] = '\0';
				EXEC SQL SELECT NVL(COUNT(*),0) INTO :c_count
				FROM   RL_TEST_RESULT
				WHERE  SPECIMEN_NO = TO_NUMBER(:c_spec_no)
				AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND GROUP_TEST_CODE = :c_req_dtl_test_code
				AND NVL(STATUS,' ') != 'P';
				if(NODATAFOUND)
					;
				if (OERROR)
					  ins_message(ORA_MESG,"Failed at Select RL_TEST_RESULT in c_request_detail_cur");
				c_count.arr[c_count.len] ='\0';
				if(atoi(c_count.arr) == 0)
				EXEC SQL UPDATE RL_REQUEST_DETAIL 
					     SET RESULT_STATUS = 'P',
						 RESULT_PRINTED_DATE = to_date(:nd_result_printed_date,'DD/MM/YYYY HH24:MI:SS'),
						 MODIFIED_BY_ID = USER,
						 MODIFIED_DATE = SYSDATE
						 WHERE SPECIMEN_NO = TO_NUMBER(:c_spec_no)
						 AND TEST_CODE = :c_req_dtl_test_code;
					if (OERROR)
						ins_message(ORA_MESG,"Failed at update rl_request_detail");
		}

		close_c_cur();
     }    /// 22.09.2003
    return;
err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   ins_message(ORA_MESG,"Error occurred at update_rl_request_detail()");
   return;
}
/*----------------------------------------------------------*/
close_all_cur()
{
    EXEC SQL CLOSE RL_REQ_HDR_CUR;
    EXEC SQL CLOSE RL_REQ_DTL_CUR;
    EXEC SQL CLOSE RL_TEST_RESULT_CUR;
//    EXEC SQL CLOSE RL_PAT_MAST_CUR;
//    EXEC SQL CLOSE RL_SPECIMEN_TYPE_CODE_CUR;
//    EXEC SQL CLOSE RL_SECTION_CUR;
//    EXEC SQL CLOSE RL_TEST_CODE_CUR;
//    EXEC SQL CLOSE RL_AGE_SEX_RANGE_CUR;
//    EXEC SQL CLOSE RL_COMM_FOR_TEST_CUR;
//    EXEC SQL CLOSE RL_RESULT_TEXT_CUR;
//    EXEC SQL CLOSE RL_FUNCTION_CUR;
//    EXEC SQL CLOSE RL_TEST_RESULT_CUR2;
//    EXEC SQL CLOSE RL_RESULT_SNOMED_CUR;
//    EXEC SQL CLOSE RL_SNOMED_CODE_CUR;
//    EXEC SQL CLOSE RL_RESULT_ORGANISM_CUR;
//	  EXEC SQL CLOSE RL_ANTIBIOTIC_CUR;
	EXEC SQL CLOSE RL_SENSITIVITY_CUR;
//    EXEC SQL CLOSE RL_ORGANISM_CODE_CUR;
//    EXEC SQL CLOSE RL_ANTIBIOTIC_CODE_CUR;
//    EXEC SQL CLOSE RL_PAT_MAST3_CUR;
//    EXEC SQL CLOSE CUR1;

}

ins_message(int msg_type,char msg[])
{

   er_msg.arr[0] = '\0';
   er_msg.len = 0;
   
   er_msg_type = 0;

   strcpy(er_msg.arr,msg);
   er_msg.len = strlen(msg);
 
   er_msg_type = msg_type;

   sprintf(err_num,"%d",sqlca.sqlcode);

   strcpy(er_msg_num.arr, err_num);
 	er_msg_num.len = strlen(er_msg_num.arr);


   EXEC SQL
   INSERT INTO SY_PROG_MSG
          (OPERATING_FACILITY_ID,PGM_ID,MSG_TYPE,MSG_NUM,MSG_DESC,MSG_DATE_TIME,SESSION_ID,PGM_DATE)
   VALUES 
          (:nd_operating_facility_id,'RLRSENQ3',:er_msg_type, SUBSTR(:er_msg_num,1,6),:er_msg,SYSDATE,:sy_session_id,
		   :sy_req_date);
   err_flag = 1;
}

/* SPLITTING THE VARCHAR 2000 INTO 70 CHARACTERS   */
/************************************************/
splitting()
{
  
    int fetch_result_text();
	char word[2];

    strcpy(word1,"F");
	_flushall();
    while(fetch_result_text())
    {
		  something_to_print = 1;
          hell = strlen(rl_res_result_text.arr);
		  
			if(group && !group_printed)
			{   print_group_test_desc();
				group_printed = 1;
			}
			if(!test_printed  && strlen(test_description))
			{     numeric_value_flag = FALSE;  
				sprintf(text_line,"%37.37s%-40s",test_description," ");
					print_line_check(text_line);
			    test_printed = 1;
			}

         z = 0;
	     clt = 0;
	     strcpy(word1,"F");
	     cntr = 1;
	     qq = 0;

         while(z<hell)
         {
		 		  	
		 
             word[0] = rl_res_result_text.arr[z];
 		     word[1] = '\0';

		     if (strcmp(word,"\n") == 0)
		     {
   
		       cntr = 0;
		       strcpy(word1,"N");
		       qq = z ;
		      }


  		      if(cntr >= 71)
		      {
		   	
			     cmp = cntr;
			     while((rl_res_result_text.arr[z] != 32) && (cmp > 1))
			     {

			         z--;
				     cmp--;
				  
			      }

				  qq = z;
				  			   
			      word[0] = rl_res_result_text.arr[z];
   			      word[1] = '\0';
		
		  	      if (cmp == 1)
				     strcpy(word1,"W");
			      else
			         strcpy(word1,"T");
			   
		
		       }


				if (((z == hell) || (z == hell - 1)) && (strcmp(word1,"F") == 0))
				{
	
				   fprint_repeat(fp,' ',8);		   
				   for(i=clt;i < z + 1;i++)
		           {
		              fprintf(fp,"%c",rl_res_result_text.arr[i]);
				
			       }
			       fprintf	(fp,"\n");
				   page_break(1);
				   cntr = 0 ;
				   clt = clt + 70 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");


				}

			
		       if (strcmp(word1,"N") == 0) 
		       {
				
		          fprint_repeat(fp,' ',8);		   
				  for(i=clt;i<=qq;i++)
		          {
			         fprintf(fp,"%c",rl_res_result_text.arr[i]);
					
			      }
                              page_break(1);                                 
			      strcpy(word1,"F");
			      cntr = 0 ;
			      clt = qq + 1;
		          qq = 0;
	   	       }

		       if (strcmp(word1,"T") == 0)
		       {
		 										 
			      fprint_repeat(fp,' ',8);		   
				  for(i=clt;i<= qq;i++)
		          {
		             fprintf(fp,"%c",rl_res_result_text.arr[i]);
				
			      }

			       fprintf	(fp,"\n");
				   page_break(1);
			       cntr = 0 ;
				   clt = qq + 1 ;
			       qq = 0;
				   strcpy(word1,"F");

				
		        }


		        if (strcmp(word1,"W") == 0)
		        {
		 										 
			       fprint_repeat(fp,' ',8);		   
				   for(i=clt;i < clt + 70;i++)
		           {
		              fprintf(fp,"%c",rl_res_result_text.arr[i]);
				
			       }

			       fprintf(fp,"\n");
				   page_break(1);
				   cntr = 0 ;
				   clt = clt + 70 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");

				
		        }

		  
            cntr += 1;
	        z++ ;
          }

		
      }

	  close_text_cur();
  
       fflush(fp);

#ifdef DEBUG
   printf("rl_res_result_text = %s\n", rl_res_result_text.arr);
#endif

if (OERROR)
   ins_message(ORA_MESG,"Error occurred at splitting()");

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   ins_message(ORA_MESG,"Error occurred at splitting()");
   return;

}
set_printed_date_time()
{
 /* Trapping the result printed date/time into a variable */
 nd_result_printed_date.arr[0] = '\0';
 nd_result_printed_date.len = 0;
 EXEC SQL SELECT TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS') 
            INTO :nd_result_printed_date
			FROM DUAL;  
 nd_result_printed_date.arr[nd_result_printed_date.len] = '\0';

 return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   ins_message(ORA_MESG,"Error occurred at set_printed_date_time()");
   return;
}
/*------------------------------------------------------------*/
get_zero_prefix_for_range()
{
	l_low_val.arr[0]	= '\0';
	l_low_val.len		= 0;
	l_high_val.arr[0]	= '\0';
	l_high_val.len		= 0;
		
	l_low = 0;
	l_high = 0;


	EXEC SQL SELECT FLOOR(TO_NUMBER(:rl_tst_ran_high_val_nor)),
				FLOOR(TO_NUMBER(:rl_tst_ran_low_val_nor))
		     INTO :l_high, :l_low
			 FROM DUAL;

	strcpy(l_low_val.arr, rl_tst_ran_low_val_nor.arr);
	l_low_val.len = strlen(l_low_val.arr);

	strcpy(l_high_val.arr, rl_tst_ran_high_val_nor.arr);
	l_high_val.len = strlen(l_high_val.arr);

	if (l_low == 0)
	{
		strcpy(rl_tst_ran_low_val_nor.arr, "0");

		if (strcmp(l_low_val.arr, "0") != 0)
			strcat(rl_tst_ran_low_val_nor.arr, l_low_val.arr);

		rl_tst_ran_low_val_nor.len = strlen(rl_tst_ran_low_val_nor.arr);
	}

	if (l_high == 0)
	{
		strcpy(rl_tst_ran_high_val_nor.arr, "0");

		if (strcmp(l_high_val.arr, "0") != 0)
			strcat(rl_tst_ran_high_val_nor.arr, l_high_val.arr);

		rl_tst_ran_high_val_nor.len = strlen(rl_tst_ran_high_val_nor.arr);
	}


    l_low_val.arr[0]		= '\0';
	l_low_val.len			= 0;

	l_high_val.arr[0]		= '\0';
	l_high_val.len			= 0;

	l_low = 0;
	l_high = 0;


}
/*------------------------------------------------------------*/
build_table()
{
	int i;

	l_should_print_yn = 'N';
	d_interval_specimen_yn = 'N';

	i = 1;

	EXEC SQL DECLARE int_curs CURSOR FOR 
				SELECT DISTINCT TO_CHAR(A.interval_test_specimen_no)
				FROM RL_INTERVAL_TEST_SPECIMENS A 
				WHERE A.specimen_no = TO_NUMBER(:nd_spec_no) 
				AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND NVL(A.cancelled_yn, 'N') <> 'Y';
//				AND NVL(A.status, 'O') IN ('R', :nd_status);

	EXEC SQL OPEN int_curs;

	while(fetch_int_curs())
	{

		EXEC SQL SELECT COUNT(1)
				 INTO :i_count
				 FROM RL_INTERVAL_TEST_SPECIMENS
				 WHERE interval_test_specimen_no = TO_NUMBER(:d_no) 
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND NVL(cancelled_yn, 'N') <> 'Y';
//				 AND NVL(status, 'O') NOT IN ('R', 'P');

		if (i_count == 0)
		{
			declare_spec_curs();
			while(fetch_spec_curs())
			{

				if (i == 1)
				{
				   strcpy(first_specimen_no.arr, d_specimen_no.arr);
				   first_specimen_no.len = strlen(first_specimen_no.arr);
				   i++;
				}

				EXEC SQL INSERT INTO RL_INTERVAL_TEST_TEMP
							(operating_facility_id,user_id, session_id, specimen_no, 
							 group_test_code, test_code, seq_no)
						 VALUES
						 	(:nd_operating_facility_id,'RLRSENQ3', 1, 
							 TO_NUMBER(:d_specimen_no), :d_group_test_code, 
							 :d_test_code, :d_seq_no);

				l_should_print_yn = 'Y';
				d_interval_specimen_yn = 'Y';
			}
			close_spec_curs();
		}
	}

	close_int_curs();

	EXEC SQL DECLARE req_curs CURSOR FOR 
				SELECT test_code
				FROM RL_REQUEST_DETAIL
				WHERE specimen_no = TO_NUMBER(:nd_spec_no) 
				AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND NVL(cancelled_yn, 'N') <> 'Y';
//				AND NVL(result_status, 'O') IN ('R', :nd_status);
		   	    

	EXEC SQL OPEN req_curs;

	while(fetch_req_curs())
	{
		EXEC SQL SELECT COUNT(1)
		INTO :i_count
		FROM RL_INTERVAL_TEST_SPECIMENS
		WHERE specimen_no = TO_NUMBER(:nd_spec_no)
		AND OPERATING_FACILITY_ID = :nd_operating_facility_id
		AND NVL(cancelled_yn, 'N') <> 'Y'
		AND group_test_code = :d_group_test_code;

		if (i_count == 0)  
		{
			l_should_print_yn = 'Y';

			EXEC SQL INSERT INTO RL_INTERVAL_TEST_TEMP
							(OPERATING_FACILITY_ID,user_id, session_id, 
							 specimen_no, group_test_code)
					 VALUES
							(:nd_operating_facility_id,'RLRSENQ3', 1, 
							 TO_NUMBER(:nd_spec_no), :d_group_test_code);

		}


	}
	close_req_curs();

	if (d_interval_specimen_yn == 'N')
	{
	   strcpy(first_specimen_no.arr, nd_spec_no.arr);
	   first_specimen_no.len = strlen(first_specimen_no.arr);

	}

}
/*------------------------------------------------------------*/
declare_spec_curs()
{
		EXEC SQL DECLARE spec_curs CURSOR FOR 
				SELECT TO_CHAR(A.specimen_no), A.group_test_code, A.test_code, A.seq_no
				FROM RL_INTERVAL_TEST_SPECIMENS A 
				WHERE A.interval_test_specimen_no= TO_NUMBER(:d_no) 
				AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND NVL(A.cancelled_yn, 'N') <> 'Y'
		   	    ORDER BY A.specimen_no;

		EXEC SQL OPEN spec_curs;

		
}

/*------------------------------------------------------------*/
fetch_spec_curs()
{
	 d_specimen_no.arr[0]		= '\0';
	 d_specimen_no.len			= 0;
	 d_group_test_code.arr[0]	= '\0';
	 d_group_test_code.len		= 0;
	 d_test_code.arr[0]			= '\0';
	 d_test_code.len			= 0;

	EXEC SQL FETCH spec_curs 
				 INTO :d_specimen_no, :d_group_test_code, :d_test_code,
				 :d_seq_no;


		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor specimen_curs");

	
		d_specimen_no.arr[d_specimen_no.len]			= '\0';
		d_group_test_code.arr[d_group_test_code.len]	= '\0';
		d_test_code.arr[d_test_code.len]				= '\0';

	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/
fetch_int_curs()
{
	 d_no.arr[0]		= '\0';
	 d_no.len			= 0;
	 
	EXEC SQL FETCH int_curs 
				 INTO :d_no;


		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor int_curs");

	
		d_no.arr[d_no.len]			= '\0';

	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/
fetch_req_curs()
{
	 d_group_test_code.arr[0]		= '\0';
	 d_group_test_code.len			= 0;
	 
	EXEC SQL FETCH req_curs 
				 INTO :d_group_test_code;


		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor req_curs");

	
		d_group_test_code.arr[d_group_test_code.len]			= '\0';

	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/
close_int_curs()
{
	EXEC SQL CLOSE int_curs;
}
/*------------------------------------------------------------*/

close_spec_curs()
{
	EXEC SQL CLOSE spec_curs;
}
/*------------------------------------------------------------*/
close_req_curs()
{
	EXEC SQL CLOSE req_curs;
}
/*------------------------------------------------------------*/
update_interval_specimen()
{
	EXEC SQL SELECT COUNT(1)
			 INTO :u_count
			 FROM RL_INTERVAL_TEST_SPECIMENS
			 WHERE specimen_no = TO_NUMBER(:nd_spec_no)
			 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
			 AND test_code = :rl_tst_test_code
			 AND NVL(cancelled_yn, 'N') <> 'Y';
	
	if (u_count > 0)
	{
			
			d_found.arr[0]		= '\0';
			d_found.len			= 0;
			
		EXEC SQL SELECT 'x'
				 INTO :d_found
				 FROM RL_INTERVAL_TEST_SPECIMENS
				 WHERE specimen_no = TO_NUMBER(:nd_spec_no)
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				 AND test_code = :rl_tst_test_code
				 AND NVL(cancelled_yn, 'N') <> 'Y'
				 FOR UPDATE OF status NOWAIT;

			d_found.arr[d_found.len]	= '\0';

			 if (OERROR)
		 	 {
		 		ins_message(ORA_MESG,"SELECT failed on RL_INTERVAL_TEST_SPECIMENS");
			 }

			 if (RESOURCE_BUSY)
			 {
				ins_message(ORA_MESG,"OPEN failed resource busy RL_INTERVAL_TEST_SPECIMENS");
			 }
			 else
			 {
				 
				EXEC SQL UPDATE RL_INTERVAL_TEST_SPECIMENS
					 SET status = 'P'
					 WHERE specimen_no = TO_NUMBER(:nd_spec_no)
					 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
					 AND test_code = :rl_tst_test_code
					 AND NVL(cancelled_yn, 'N') <> 'Y';
			 }
	}

}
/*------------------------------------------------------------*/
delete_build_table()
{
	EXEC SQL DELETE FROM RL_INTERVAL_TEST_TEMP
			 WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			 AND user_id = 'RLRSENQ3'
			 AND session_id = 1;

	EXEC SQL DELETE FROM RL_INTERVAL_TEST_TEMP
			 WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			 AND user_id = 'RLRSENQ3'
			 AND session_id = 2;

}
/*------------------------------------------------------------*/

get_interval_description()
{
	interval_description.arr[0]		= '\0';
	interval_description.len		= 0;

	EXEC SQL SELECT description
			 INTO :interval_description
			 FROM RL_INTERVAL_TEST_DESC
			 WHERE test_code = :rl_tst_test_code
			 AND seq_no = :rl_seq_no;

	interval_description.arr[interval_description.len]		= '\0';
}
/*-----------------------------------------------------*/
get_first_specimen_no()
{
	int i;

	EXEC SQL DECLARE first_spec_curs CURSOR FOR 
				SELECT TO_CHAR(A.interval_test_specimen_no)
				FROM RL_INTERVAL_TEST_SPECIMENS A 
				WHERE A.specimen_no = TO_NUMBER(:nd_spec_no) 
				AND A.OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND NVL(A.cancelled_yn, 'N') <> 'Y'
				AND NVL(A.status, 'O') IN ('R', :nd_status)
		   	    ORDER BY A.specimen_no;

	EXEC SQL OPEN first_spec_curs;

	i = fetch_first_spec_curs();

	EXEC SQL CLOSE first_spec_curs;

}

/*------------------------------------------------------------*/
fetch_first_spec_curs()
{
	 first_specimen_no.arr[0]	= '\0';
	 first_specimen_no.len		= 0;

	EXEC SQL FETCH first_spec_curs 
				 INTO :first_specimen_no;


		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor first_specimen_curs");

	
		first_specimen_no.arr[first_specimen_no.len]		= '\0';

	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/

close_comments_curs()
{

	EXEC SQL CLOSE RL_COMM_FOR_TEST_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_COMM_FOR_TEST_CUR");

}

close_text_cur()
{
	EXEC SQL CLOSE RL_RESULT_TEXT_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_RESULT_TEXT_CUR");

}

close_function_cur()
{
	EXEC SQL CLOSE RL_FUNCTION_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_FUNCTION_CUR");

}

close_snomed_cur()
{

	EXEC SQL CLOSE RL_RESULT_SNOMED_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_RESULT_SNOMED_CUR");

}

close_organism_cur()
{

	EXEC SQL CLOSE RL_RESULT_ORGANISM_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_RESULT_ORGANISM_CUR");

}

close_antibiotic_cur()
{
	EXEC SQL CLOSE RL_ANTIBIOTIC_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_ANTIBIOTIC_CUR");

}

close_cur1_cur()
{
	EXEC SQL CLOSE CUR1;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor CUR1");

}

close_mast_cur()
{

	EXEC SQL CLOSE RL_PAT_MAST_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_PAT_MAST_CUR");

}


close_mast3_cur()
{
	
	EXEC SQL CLOSE RL_PAT_MAST3_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_PAT_MAST3_CUR");

}

close_c_cur()
{
	
	EXEC SQL CLOSE C;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor C");

}

put_zero_before_decimal()
{

	if (rl_tst_numeric_result.arr[0] != '0')
	{
		strcpy(l_numeric_result, "0");
		strcat(l_numeric_result, rl_tst_numeric_result.arr);

		strcpy(rl_tst_numeric_result.arr, l_numeric_result);
		rl_tst_numeric_result.len = strlen(rl_tst_numeric_result.arr);
	}
	

}

/******************************************************************************************/
get_race_desc()
{
	
	d_race_desc.arr[0]		= '\0';
	d_race_desc.len			= 0;

	EXEC SQL SELECT short_desc
		     INTO :d_race_desc
			 FROM MP_RACE
			 WHERE race_code = :rl_race_code;

	if (NODATAFOUND);

	d_race_desc.arr[d_race_desc.len]			= '\0';
	
}


/******************************************************************************************/
print_clinical_history()
{

	int ctr = 0;
	int len = 0;
	int r_ctr = 0;

	char l_string[100];     

		EXEC SQL DECLARE rl_clinical_cur CURSOR FOR
				 SELECT specimen_no, clinical_text_code, SUBSTR(clinical_text, 1, 4000) 
				 FROM RL_PATIENT_CLINICAL_TEXT
				 WHERE specimen_no IN (SELECT distinct specimen_no
							FROM RL_INTERVAL_TEST_TEMP
							WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
							AND user_id = 'RLRSENQ3' 
							AND session_id = 1 )
			       AND OPERATING_FACILITY_ID = :nd_operating_facility_id
			       AND NVL(order_questionnaire_yn, 'N') <> 'Y'
				 ORDER BY specimen_no;

		EXEC SQL OPEN rl_clinical_cur;   

		ctr = 0;

/* commented on 14.08.2003 and added another version of splittext in local itself

		while(fetch_clinical_text())
		{

			len = strlen(d_clinical_text.arr);

			if (strlen(d_clinical_text.arr) > 0)
			{

			   split_text(d_clinical_text.arr, 79, l_string, &r_ctr);

  			   if (d_interval_specimen_yn == 'Y')
			   {
			  	  fprintf(fp, "Specimen No : %-15s", d_clinical_spec_no.arr);
			   }

				if (ctr == 0)
				{

					if (strlen(l_string) > 0 )
					{

						page_break(1);
						fprintf(fp,"%c&k4S",ESC); 
						fprintf(fp,"%c(s4B",ESC);
						fprintf(fp, "Clinical History\n");
						fprintf(fp,"%c&k4S",ESC); 
						fprintf(fp,"%c(s-3B",ESC);
						
					}
				}

				fprintf(fp,"       %s\n",l_string);  
				page_break(1);

				while(r_ctr <= len)
				{	
					page_break(1);
					split_text(d_clinical_text.arr, 79, l_string, &r_ctr);
					fprintf(fp,"       %s\n",l_string);  
					page_break(1);

					strcpy(l_string, "");

				}
			
				ctr++;
			}
		}

********************/

		split_hist();   ///////// added on 14.08.2003

		EXEC SQL CLOSE rl_clinical_cur;

}

/******************************************************************************************/
fetch_clinical_text()
{

	d_clinical_text_code.arr[0]		= '\0';
	d_clinical_text_code.len		= 0;
	d_clinical_spec_no.arr[0]		= '\0';
	d_clinical_spec_no.len			= 0;

	d_clinical_text.arr[0]			= '\0';
	d_clinical_text.len				= 0;

    EXEC SQL FETCH rl_clinical_cur
              INTO :d_clinical_spec_no,
				   :d_clinical_text_code, 
				   :d_clinical_text;
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_PATIENT_CLINICAL_TEXT");


	d_clinical_spec_no.arr[d_clinical_spec_no.len]			= '\0';
	d_clinical_text_code.arr[d_clinical_text_code.len]		= '\0';
	d_clinical_text.arr[d_clinical_text.len]				= '\0';

    return (LAST_ROW?0:1);
}
/*******************************************************************************************/
chk_inhibit_yn()
{

	EXEC SQL SELECT NVL(inhibit_report_yn, 'N') 
			INTO :d_inhibit_yn
			FROM RL_TEST_CODE 
			WHERE test_code = :inhibit_test_code;


	d_inhibit_yn.arr[d_inhibit_yn.len]		= '\0';
}

/*******************************************************************************************/
print_header3()
{   char t_patient_id[16];   
    char sex_desc[11];
	char pat_name[60];
	char uline[82];
	char l_str[100];
    int i;

    pctr++;

	if (l_print_health_card_yn.arr[0]=='Y') 
		lctr = 20;
	else
	    lctr = 19;

    get_parameters();

/*---------*/
    fprintf(fp,"%c&a006L",ESC); /* Set the left Margin */
	fprintf(fp,"%c&k12S",ESC);	/* This makes the font size to increase to 12 */
	fprintf(fp,"%c&l6D",ESC);	/* Set the Density */
   	fprintf(fp,"%c(s4B",ESC);   /* Set Bold */
/*---------*/

    fprintf(fp,"\n%-*s%-.40s\n\n",(int)(((80 - sy_acc_entity_name.len)/2) - 6)," ",sy_acc_entity_name.arr);
    fprintf(fp,"%-*s%-.80s\n",(int)(((80 - rl_lab_title.len)/2) - 6)," ",rl_lab_title.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
   	fprintf(fp,"%c(s-3B",ESC);
    fprintf(fp,"%73.73sPage(s) : %3d\n"," ",pctr);
/*----------------------------------------*/


    if(rl_hdr_episode_type.arr[0] == 'R')
       if(strcmp(rl_pat_actual_id.arr,"NULL")==0)
	  strcpy(t_patient_id,nd_hosp_no.arr);
       else
	  strcpy(t_patient_id,rl_pat_actual_id.arr);
    else
       strcpy(t_patient_id,nd_hosp_no.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Patient ID : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/
	
	fprintf(fp,"%c&k12S",ESC);	
	fprintf(fp,"%c&l6D",ESC);
   	fprintf(fp,"%c(s4B",ESC);

    fprintf(fp,"%-15.15s",t_patient_id);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Section : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

	fprintf(fp, "%-s - %-s\n",rl_section_short_name.arr,
							  rl_section_tel_num.arr);

/* added by c shekhar to print health card info 21/06/2002 */

if ((l_print_health_card_yn.arr[0]=='Y') && 
			 ( (rl_health_card_num.arr[0]!='\0') ||
			   (rl_health_num.arr[0] != '\0')
			  ))
	{

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Health Card No : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/
	
	fprintf(fp,"%c&k12S",ESC);	
	fprintf(fp,"%c&l6D",ESC);
   	fprintf(fp,"%c(s4B",ESC);

    fprintf(fp,"%-15.15s",rl_health_card_num.arr);


/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"     Health No : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

	fprintf(fp,"%c&k12S",ESC);	
	fprintf(fp,"%c&l6D",ESC);
   	fprintf(fp,"%c(s4B",ESC);

    fprintf(fp,"%-14.14s\n", rl_health_num.arr);

//	fprintf(fp, "   Exp. Date : ");
//	fprintf(fp, "%-10.10s\n", rl_health_exp_date.arr);
}

/*--------------till here ----------------------*/

    for(i=0;i<87;i++)
        fprintf(fp,"_");
    fprintf(fp,"\n\n");

    if(rl_pat_sex.arr[0] == 'M')
	   strcpy(sex_desc,"MALE");
	else
	if(rl_pat_sex.arr[0] == 'F')
	   strcpy(sex_desc,"FEMALE");
	else
       strcpy(sex_desc,"");
    
	strcpy(pat_name,rl_pat_title.arr);
	if(strlen(rl_pat_title.arr) > 0)
	   strcat(pat_name," ");
	strcat(pat_name,rl_pat_short_name.arr);
    
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp,"Patient Name         : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-42.42s",pat_name);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Sex : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-8.8s\n",sex_desc);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Location             : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-42.42s",rl_source_short_name.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"DOB : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/
	
	fprintf(fp,"%-16.16s\n",rl_pat_date_of_birth.arr); 

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Clinical Information : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    if (rl_hdr_request_comment_desc1.len)
    {
      fprintf(fp,"%-40s\n",rl_hdr_request_comment_desc1.arr);
      page_break(1);
    }
	else
    {
      fprintf(fp,"\n");
      page_break(1);
    }

    if (rl_hdr_request_comment_desc2.len)
    {
       /*----------------------------------------*/
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s4B",ESC);
       fprintf(fp,"%-23.23s"," ");
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/
      fprintf(fp,"%-40s\n",rl_hdr_request_comment_desc2.arr);
      page_break(1);
    }

    if (rl_hdr_request_comment_desc3.len)
    {
       /*----------------------------------------*/
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s4B",ESC);
       fprintf(fp,"%-23.23s"," ");
       fprintf(fp,"%c&k4S",ESC); 
   	   fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/
      fprintf(fp,"%-40s\n",rl_hdr_request_comment_desc3.arr);
      page_break(1);
    }
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Requesting Doctor    : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-33.33s",rl_consultant_short_name.arr);
				
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Request Date : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-s\n",rl_hdr_spec_recd_date_time.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Specimen Type        : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-33.33s",rl_spc_specimen_desc.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Regn Date    : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%s\n",rl_hdr_spec_regd_date_time.arr);

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Tests Requested      : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

    fprintf(fp,"%-33.33s"," ");

/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
    fprintf(fp,"Specimen No  : ");
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
/*----------------------------------------*/

	if (d_interval_specimen_yn == 'Y')
		fprintf(fp,"%-9.9s (I)\n",first_specimen_no.arr);
	else
		fprintf(fp,"%-s\n",nd_spec_no.arr);

	sprintf(l_str,"%-6.6s"," ");

    for (i=0;i < no_of_dtl_recs;i++)
    {
       sprintf(l_str,"%s%-5s  ",l_str, rl_dtl_test_code[i].arr);
    }
    fprintf(fp,"%s\n",l_str);

    for(i=0;i<87;i++)
        fprintf(fp,"_");
    fprintf(fp,"\n\n");
}
/*---------------------------------------------------------*/
print_header2()
{

    char t_patient_id[16];   
    char sex_desc[11];
	char pat_name[60];
	char uline[82];
	char l_str[100];
    int i;
	char l_age_legend[5];

    pctr++;
    
    get_parameters();

/*---------*/
    fprintf(fp,"%c&a006L",ESC); /* Set the left Margin */
	fprintf(fp,"%c&k12S",ESC);	/* This makes the font size to increase to 12 */
	fprintf(fp,"%c&l6D",ESC);	/* Set the Density */
   	fprintf(fp,"%c(s4B",ESC);   /* Set Bold */
/*---------*/

    fprintf(fp,"%-*s%-.80s\n",(int)(((80 - rl_lab_title.len)/2) - 6)," ",rl_lab_title.arr);
	fprintf(fp,"%-*s%-.80s\n",(int)(((80 - rl_lab_title_2.len)/2) - 6)," ",rl_lab_title_2.arr);
	fprintf(fp,"%-*s%-.80s\n",(int)(((80 - rl_lab_title_3.len)/2) - 6)," ",rl_lab_title_3.arr);
	fprintf(fp,"%-*s%-.80s\n",(int)(((80 - rl_lab_title_4.len)/2) - 6)," ",rl_lab_title_4.arr);

/***** for draft copy legend *********/
	fprintf(fp, "Draft Copy\n");
/*----------------------------------------*/
/*----------------------------------------*/
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
   	fprintf(fp,"%c(s-3B",ESC);
    fprintf(fp,"%73.73sPage(s) : %3d\n"," ",pctr);
/*----------------------------------------*/

	lctr = 9;

	/*** NEWLY ADDED ON 28/08/2003 TO PRINT THE HMC NO FOR THE MEDICOM NO 
			BEFORE the detail portion of heading******/
	if(rl_hdr_episode_type.arr[0] != 'R')
		print_hmc_no();


	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);

   for(i=0;i<87;i++)
        fprintf(fp,"_");

	fprintf(fp, "\n");

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
   	fprintf(fp,"%c(s-3B",ESC);

	lctr++;

	if (strcmp(rl_actual_dob_yn.arr, "Y") == 0)
		strcpy(l_age_legend, "");
	else
		strcpy(l_age_legend, "*");

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Patient Name : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp, "%-30.30s                ", rl_pat_short_name.arr);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Age: ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp, "%s ", l_age_legend);

	patient_age();

	fprintf(fp, "%s\n", t_age.arr);
	page_break(1);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Location     : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp, "%s", rl_source_short_name.arr);

	if(rl_hdr_episode_type.arr[0] == 'R')
	{
	    fprintf(fp,"%c&k4S",ESC); 
   		fprintf(fp,"%c(s4B",ESC);
		fprintf(fp, "/");
		fprintf(fp,"%c&k4S",ESC); 
   		fprintf(fp,"%c(s-3B",ESC);   

		fprintf(fp, "%-20.20s\n", rl_location.arr);
		page_break(1);
	}
	else
	{
		fprintf(fp, "\n");
		page_break(1);
		
	}

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Patient  ID  : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
	
	if(rl_hdr_episode_type.arr[0] == 'R')
	{
       if(strcmp(rl_pat_actual_id.arr,"NULL")==0)
	 	   strcpy(t_patient_id,nd_hosp_no.arr);
	   else
		   strcpy(t_patient_id,rl_pat_actual_id.arr);
	}
    else
       strcpy(t_patient_id,nd_hosp_no.arr);

	fprintf(fp, "%-15.15s                          ", t_patient_id);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Sex/Race: ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

    if(rl_pat_sex.arr[0] == 'M')
	   strcpy(sex_desc,"MALE");
	else
		if(rl_pat_sex.arr[0] == 'F')
			strcpy(sex_desc,"FEMALE");
		else
			strcpy(sex_desc,"Unknown");

	fprintf(fp,"%s", sex_desc);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "/");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	get_race_desc();
	fprintf(fp, "%-15.15s\n", d_race_desc.arr);
	page_break(1);

	/*** NEWLY ADDED ON 26/08/2003 TO PRINT THE HMC NO FOR THE MEDICOM NO ******/
//	if(rl_hdr_episode_type.arr[0] != 'R')
//		print_hmc_no();


    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Doctor       : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp,"%-30.30s\n",rl_consultant_short_name.arr);
	page_break(1);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Specimen No  : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	if (d_interval_specimen_yn == 'Y')
	{
		strcpy(l_str, first_specimen_no.arr);
		strcat(l_str, " (I)");
	}
	else
	{
		strcpy(l_str, nd_spec_no.arr);
		strcat(l_str, "    ");
	}
		
	fprintf(fp, "%-19.19s                    ", l_str);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Regd  Date: ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp, "%-16.16s\n", rl_hdr_spec_regd_date_time.arr);
	page_break(1);
	
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Specimen Type: ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp,"%-39.39s",rl_spc_specimen_desc.arr);
	

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Recd  Date: ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp, "%-16.16s\n", rl_hdr_spec_recd_date_time.arr);
	page_break(1);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Category No  : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   

	fprintf(fp, "%-4.4s/%-4.4s/%-15.15s              ", rl_category_code.arr, rl_category_year.arr,
								rl_category_number.arr);

    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Collt Date: ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);   
	
	fprintf(fp, "%-16.16s\n", rl_hdr_spec_colltd_date_time.arr);	
	page_break(1);
	
    fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s4B",ESC);
	fprintf(fp, "Clinical     : ");
	fprintf(fp,"%c&k4S",ESC); 
   	fprintf(fp,"%c(s-3B",ESC);
	   
	if (rl_hdr_request_comment_desc1.len)
    {
      fprintf(fp,"%-40.40s\n",rl_hdr_request_comment_desc1.arr);
      page_break(1);
    }
	else
    {
      fprintf(fp,"\n");
      page_break(1);
    }

	 fprintf(fp,"%c&k4S",ESC); 
   	 fprintf(fp,"%c(s4B",ESC);
	 fprintf(fp, "Comment        ");
	 fprintf(fp,"%c&k4S",ESC); 
   	 fprintf(fp,"%c(s-3B",ESC);

	if (rl_hdr_request_comment_desc2.len)
    {

      fprintf(fp,"%-40.40s\n",rl_hdr_request_comment_desc2.arr);
      page_break(1);
    }
	else
    {
      fprintf(fp,"\n");
      page_break(1);
    }

    
	if (rl_hdr_request_comment_desc3.len)
    {
	  fprintf(fp, "               ");
      fprintf(fp,"%-40.40s\n",rl_hdr_request_comment_desc3.arr);
      page_break(1);
    }

	if (strcmp(rl_test_requested_yn.arr, "Y") == 0)
	{

		 fprintf(fp,"%c&k4S",ESC); 
   		 fprintf(fp,"%c(s4B",ESC);
		 fprintf(fp, "Ordered Tests: ");
		 fprintf(fp,"%c&k4S",ESC); 
   		 fprintf(fp,"%c(s-3B",ESC);
		
		strcpy(l_str, "");

		for (i=0;i < no_of_dtl_recs;i++)
		{
			d_inhibit_yn.arr[0]		= '\0';
			d_inhibit_yn.len		= 0;

			strcpy(inhibit_test_code.arr, rl_dtl_test_code[i].arr);
			inhibit_test_code.len = strlen(inhibit_test_code.arr);

			chk_inhibit_yn();

			if (d_inhibit_yn.arr[0]	== 'N') 
			{
				if (i == 0)
					sprintf(l_str,"%s", rl_dtl_test_code[i].arr);
				else
					sprintf(l_str,"%s,%s",l_str, rl_dtl_test_code[i].arr);
			}

			if (i > 15) 
				break;
		}
		fprintf(fp,"%s\n",l_str);
		page_break(1);
	}


	if(rl_hdr_episode_type.arr[0] == 'R')
	{
		if (strlen(rl_message_line.arr) > 0)
		{
			fprintf(fp, "%70.70s ", rl_message_line.arr);
			fprintf(fp, "%-15.15s\n", nd_hosp_no.arr);
			page_break(1);

		}
	}

    fprintf(fp,"%c&k4S",ESC); 
    fprintf(fp,"%c(s4B",ESC);
    for(i=0;i<87;i++)
        fprintf(fp,"_");
    fprintf(fp,"%c&k4S",ESC); 
    fprintf(fp,"%c(s-3B",ESC);

	page_break(1);
	fprintf(fp, "\n");
    
}
/********************************************************************************************/
print_footer3(foot_ind)
int foot_ind;
{
   int fi = 0;
   char l_str[100];
   l_str[0] = '\0'; 

   for(fi=0; fi < 87; fi++)
       fprintf(fp,"%c",'_');

   fprintf(fp,"\n");

   fflush(fp);

   /*----------------------------------------*/
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s4B",ESC);
   fprintf(fp,"Release Date : ");
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s-3B",ESC);   
   sprintf(l_str,"%s",rl_hdr_released_date.arr);
   fprintf(fp,"%-25.25s",l_str);
   /*----------------------------------------*/

   /*----------------------------------------*/
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s4B",ESC);
   fprintf(fp,"Released/Reviewed By : ");
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s-3B",ESC);   
   fprintf(fp,"%-s\n",rl_hdr_released_by_id.arr);
   /*----------------------------------------*/

   /*----------------------------------------*/
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s4B",ESC);
   fprintf(fp,"Reprint Date : ");
   fprintf(fp,"%c&k4S",ESC); 
   fprintf(fp,"%c(s-3B",ESC);   
   /*----------------------------------------*/
   
   if (rl_prn_ctrl_hdr_rp_yn.arr[0] == 'Y')
       sprintf(l_str,"%-16.16s         ",nd_result_printed_date.arr);
   else
       sprintf(l_str,"%-16.16s         ",nd_result_printed_date.arr);
   fprintf(fp,"%s",nd_result_printed_date.arr);

   /*----------------------------------------*/

   if (rl_hdr_extra_copies_to.len && copy == 2 ) 
   {
      /*----------------------------------------*/
      fprintf(fp,"%c&k4S",ESC); 
      fprintf(fp,"%c(s4B",ESC);
      fprintf(fp,"Copy To : ");
      fprintf(fp,"%c&k4S",ESC); 
      fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/

      sprintf(l_str,"%24.24s",rl_hdr_extra_copies_to.arr);
   }
   else
      sprintf(l_str,"%34.34s"," ");

   fprintf(fp,"%s\n",l_str);

   if(last_page == 0)
      sprintf(l_str,"%-73.73s--CONTINUED--"," ");
   else
      sprintf(l_str,"%-73.73s      --END--"," ");

   fprintf(fp,"%s\f",l_str);

   lctr = 0;
  
}
/*-----------------------------------------------------*/
print_footer2(foot_ind)
int foot_ind;
{
   int fi = 0;
   char l_str[100];
   l_str[0] = '\0'; 

   for(fi=0; fi < 87; fi++)
       fprintf(fp,"%c",'_');

   fprintf(fp,"\n");
   
   fflush(fp);

      if (rl_name_on_report_yn.arr[0] == 'Y')
	  {

		get_print_name(first_user.arr);
	  if (print_name_yn.arr[0]	== 'Y')
	  {

		get_user_name(first_user.arr);

	   /*----------------------------------------*/
		fprintf(fp,"%c&k4S",ESC); 
		fprintf(fp,"%c(s4B",ESC);
//		fprintf(fp,"Released/Reviewed By : ");
		fprintf(fp,"Released By : ");
		fprintf(fp,"%c&k4S",ESC); 
		fprintf(fp,"%c(s-3B",ESC);   
  	    sprintf(l_str,"%s", sy_user_name.arr);
	    fprintf(fp,"%-30.30s",l_str);
		fprintf(fp, "        ");
		/*----------------------------------------*/

	   /*----------------------------------------*/	   
	   fprintf(fp,"%c&k4S",ESC); 
	   fprintf(fp,"%c(s4B",ESC);
	   fprintf(fp,"Released Date : ");
	   fprintf(fp,"%c&k4S",ESC); 
	   fprintf(fp,"%c(s-3B",ESC);   
	   fprintf(fp,"%-s\n",footer_released_date);
	   /*----------------------------------------*/

	   	sy_user_name.arr[0]		= '\0';
		sy_user_name.len			= 0;

	 }

	  get_print_name(rl_hdr_released_by_id.arr);
	  if (print_name_yn.arr[0]	== 'Y')
	  {

		get_user_name(rl_hdr_released_by_id.arr);

	   /*----------------------------------------*/
		fprintf(fp,"%c&k4S",ESC); 
		fprintf(fp,"%c(s4B",ESC);
		fprintf(fp,"Reviewed By : ");
		fprintf(fp,"%c&k4S",ESC); 
		fprintf(fp,"%c(s-3B",ESC);   
  	    sprintf(l_str,"%s", sy_user_name.arr);
	    fprintf(fp,"%-30.30s",l_str);
		fprintf(fp, "        ");
	   /*----------------------------------------*/	   
	   fprintf(fp,"%c&k4S",ESC); 
	   fprintf(fp,"%c(s4B",ESC);
	   fprintf(fp,"Reviewed Date : ");
	   fprintf(fp,"%c&k4S",ESC); 
	   fprintf(fp,"%c(s-3B",ESC);   
	   fprintf(fp,"%-s\n",rl_hdr_released_date.arr);
	   /*----------------------------------------*/

   	   	sy_user_name.arr[0]		= '\0';
		sy_user_name.len			= 0;


	  }

		/*----------------------------------------*/
		/***********************
	    fprintf(fp,"%c&k4S",ESC); 
		fprintf(fp,"%c(s4B",ESC);
		fprintf(fp,"Reprint Date : ");
        fprintf(fp,"%c&k4S",ESC); 
        fprintf(fp,"%c(s-3B",ESC);   
		***********************/
		/*----------------------------------------*/
	/***********************
	   if (rl_prn_ctrl_hdr_rp_yn.arr[0] == 'Y')
		   sprintf(l_str,"%-16.16s         ",nd_result_printed_date.arr);
	   else
		   sprintf(l_str,"%-16.16s         ",nd_result_printed_date.arr);

	   fprintf(fp,"%s",nd_result_printed_date.arr);
	***********************/


	  
	}

/****** FOOTER PRINTING FROM RL_SECTION_CTL  ****************/
   if ( (strlen(rl_footer_line_1.arr) > 0) ||
			(strlen(rl_footer_line_2.arr) > 0) )
   {
		if (strlen(rl_footer_line_1.arr) > 0) 
			fprintf(fp, "%-79.79s\n", rl_footer_line_1.arr);

		if (strlen(rl_footer_line_2.arr) > 0) 
			fprintf(fp, "%-79.79s\n", rl_footer_line_2.arr);
   }


   /*----------------------------------------*/

   if (rl_hdr_extra_copies_to.len && copy == 2 ) 
   {
      /*----------------------------------------*/
      fprintf(fp,"%c&k4S",ESC); 
      fprintf(fp,"%c(s4B",ESC);
      fprintf(fp,"Copy To : ");
      fprintf(fp,"%c&k4S",ESC); 
      fprintf(fp,"%c(s-3B",ESC);   
      /*----------------------------------------*/

      sprintf(l_str,"%24.24s",rl_hdr_extra_copies_to.arr);
   }
   else
      sprintf(l_str,"%34.34s"," ");

   fprintf(fp,"%s\n",l_str);

   if(last_page == 0)
      sprintf(l_str,"%-73.73s--CONTINUED--"," ");
   else
      sprintf(l_str,"%-73.73s      --END--"," ");

   fprintf(fp,"%s\f",l_str);

   lctr = 0;
  
}

/*-----------------------------------------------------*/
build_cancelled_tests()
{

	EXEC SQL DECLARE cancelled_curs CURSOR FOR 
				SELECT DISTINCT specimen_no
				FROM RL_INTERVAL_TEST_TEMP
				WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND user_id = 'RLRSENQ3'
				AND session_id = 1;
	   	    
	EXEC SQL OPEN cancelled_curs;

	while(fetch_cancelled_curs())
	{
		
		declare_can_req_curs();
		while(fetch_can_req_curs())
		{

/************ In Rl_interval_test_temp table in column test code 
			  the system will put the cancel code				   *************/

			EXEC SQL INSERT INTO RL_INTERVAL_TEST_TEMP
							(OPERATING_FACILITY_ID,user_id, session_id, specimen_no, group_test_code, test_code)
					 VALUES
							(:nd_operating_facility_id,'RLRSENQ3', 2, 
							 TO_NUMBER(:can_spec_no), :can_group_test, 
							 :can_test_code);

		}

		close_can_req_curs();
	}
	close_cancelled_curs();

}

/*------------------------------------------------------------*/
fetch_cancelled_curs()
{
	 can_spec_no.arr[0]		= '\0';
	 can_spec_no.len			= 0;

	EXEC SQL FETCH cancelled_curs 
				 INTO :can_spec_no;


		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor specimen_curs");

	 can_spec_no.arr[can_spec_no.len]		= '\0';
	
	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/
close_cancelled_curs()
{
	EXEC SQL CLOSE cancelled_curs;
}
/*------------------------------------------------------------*/
declare_can_req_curs()
{

	EXEC SQL DECLARE can_req_curs CURSOR FOR 
				SELECT test_code, cancel_code
				FROM RL_REQUEST_DETAIL
				WHERE specimen_no = TO_NUMBER(:can_spec_no)
				AND OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND NVL(cancelled_yn, 'N') = 'Y';
	   	    
	EXEC SQL OPEN can_req_curs;

}
/*------------------------------------------------------------*/
close_can_req_curs()
{
	EXEC SQL CLOSE can_req_curs;
}
/*------------------------------------------------------------*/
fetch_can_req_curs()
{
	
	can_test_code.arr[0]		= '\0';
	can_test_code.len			= 0;
    can_group_test.arr[0]		= '\0';
    can_group_test.len			= 0;

	EXEC SQL FETCH can_req_curs 
				 INTO	:can_group_test,
						:can_test_code;


		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor specimen_curs");

	 can_test_code.arr[can_test_code.len]		= '\0';
	 can_group_test.arr[can_group_test.len]		= '\0';
	
	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/
print_cancelled_tests()
{

   int ctr = 0;

/************ in test code the system will put the cancel code *************/
	EXEC SQL DECLARE prn_can_curs CURSOR FOR 
				SELECT TO_CHAR(specimen_no), group_test_code, test_code
				FROM RL_INTERVAL_TEST_TEMP
				WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
				AND user_id = 'RLRSENQ3'
				AND session_id = 2;

	EXEC SQL OPEN prn_can_curs;

	while(fetch_prn_can_curs())
	{

		if (ctr == 0)
		{

			fprintf(fp, "\n");
			page_break(1);

		    fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s4B",ESC);
			fprintf(fp,"%c&d0D",ESC);   /* Set  UnderLine ON*/
			fprintf(fp, "Cancelled Tests\n");
		   	fprintf(fp,"%c&d@",ESC);
			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s-3B",ESC);   
			page_break(1);
		}


		if (d_interval_specimen_yn == 'Y')
		{
			fprintf(fp, "Specimen No : %-15.15s\n", can_spec_no.arr);
			page_break(1);
		}

		if (strlen(can_test_code.arr) > 0)
		{
			get_cancel_reason();
			get_test_desc();

		    if(test_desc_fill_for_report.len)   
			{
              EXEC SQL SELECT RPAD(:can_test_name,40,:test_desc_fill_for_report) 
					   INTO :can_test_name
					   FROM DUAL;

	          can_test_name.arr[can_test_name.len] = '\0'; 
			  fprintf(fp, "%-40.40s %s\n", can_test_name.arr, cancel_reason.arr);
			}
			else
     		  fprintf(fp, "%-40.40s %s\n", can_test_name.arr, cancel_reason.arr);

//			fprintf(fp, "%-10.10s  %-40s\n", can_group_test.arr, cancel_reason.arr);
			page_break(1);
		}

		ctr++;

	}

	close_prn_can_curs();

}

/*------------------------------------------------------------*/
fetch_prn_can_curs()
{
	 can_spec_no.arr[0]			= '\0';
	 can_spec_no.len			= 0;
	 can_group_test.arr[0]		= '\0';
	 can_group_test.len			= 0;
 	 can_test_code.arr[0]		= '\0';
	 can_test_code.len			= 0;

	EXEC SQL FETCH prn_can_curs
				 INTO :can_spec_no,
					  :can_group_test,
					  :can_test_code;

		if (OERROR)
			ins_message(ORA_MESG,"FETCH failed on cursor specimen_curs");

	 can_spec_no.arr[can_spec_no.len]			= '\0';
	 can_test_code.arr[can_test_code.len]		= '\0';
	 can_group_test.arr[can_group_test.len]		= '\0';
	 	
	return (LAST_ROW?0:1);
	 
}
/*------------------------------------------------------------*/
get_cancel_reason()
{
	cancel_reason.arr[0]		= '\0';
	cancel_reason.len			= 0;

	EXEC SQL SELECT long_desc
			 INTO :cancel_reason
		     FROM RL_CANCELLATION_CODE
			 WHERE cancel_code = :can_test_code;


	if (NODATAFOUND);

	cancel_reason.arr[cancel_reason.len]	= '\0';

}
/*------------------------------------------------------------*/
close_prn_can_curs()
{
	EXEC SQL CLOSE prn_can_curs;
}
/*------------------------------------------------------------*/
get_print_name(prn_user_id)
char prn_user_id[];
{
	
	strcpy(p_user_id.arr, prn_user_id);
	p_user_id.len = strlen(p_user_id.arr);

	print_name_yn.arr[0]		= '\0';
	print_name_yn.len			= 0;

	EXEC SQL SELECT NVL(name_on_report_yn, 'Y')
			 INTO :print_name_yn
			 FROM RL_USER_DEPT
			 WHERE OPERATING_FACILITY_ID = :nd_operating_facility_id
			 AND user_id = :p_user_id
			 AND section_code = :rl_hdr_section_code;

	print_name_yn.arr[print_name_yn.len]	= '\0';

}
/*------------------------------------------------------------*/
get_desc_snomed2()
{
    rl_snomed2_desc1.arr[0]          = '\0';
    rl_snomed2_desc2.arr[0]          = '\0';
    rl_snomed2_desc3.arr[0]          = '\0';
    rl_snomed2_desc4.arr[0]          = '\0';
    rl_snomed2_desc5.arr[0]          = '\0';
    rl_snomed2_print_yn.arr[0]       = '\0';
	rl_print_snomed2_code_yn.arr[0]	 = '\0';

    rl_snomed2_desc1.len             = 0;
    rl_snomed2_desc2.len             = 0;
    rl_snomed2_desc3.len             = 0;
    rl_snomed2_desc4.len             = 0;
    rl_snomed2_desc5.len             = 0;
    rl_snomed2_print_yn.len			 = 0;
	rl_print_snomed2_code_yn.arr[0]	 = '\0';

/************************** changed on 01/09/2002   
                     DESCRIPTION_2,
                     DESCRIPTION_3,
                     DESCRIPTION_4,
                     DESCRIPTION_5,

                   :rl_snomed2_desc2,
                   :rl_snomed2_desc3,
                   :rl_snomed2_desc4,
                   :rl_snomed2_desc5,

******************************************/

     EXEC SQL SELECT SUBSTR(DESCRIPTION_1, 1, 12),
					 NVL(PRINT_YN, 'N'),
					 NVL(print_code_yn, 'N')
	           INTO :rl_snomed2_desc1,
    			    :rl_snomed2_print_yn,
					:rl_print_snomed2_code_yn
             FROM RL_SNOMED_CODE
             WHERE SNOMED_CODE = :rl_res_snomed_code2;

    rl_snomed2_desc1.arr[rl_snomed2_desc1.len] = '\0';
    rl_snomed2_desc2.arr[rl_snomed2_desc2.len] = '\0';
    rl_snomed2_desc3.arr[rl_snomed2_desc3.len] = '\0';
    rl_snomed2_desc4.arr[rl_snomed2_desc4.len] = '\0';
    rl_snomed2_desc5.arr[rl_snomed2_desc5.len] = '\0';
    rl_snomed2_print_yn.arr[rl_snomed2_print_yn.len] = '\0';
	rl_print_snomed2_code_yn.arr[rl_print_snomed2_code_yn.len]	= '\0';

}
/*------------------------------------------------------------*/
print_line_snomed1(char *t_str)
{
         fprintf(fp,"%-18.18s",t_str);

}
/*------------------------------------------------------------*/
print_line_snomed2(char *t_str)
{
         fprintf(fp,"%-18.18s",t_str);
}
/*------------------------------------------------------------*/
add_zero_after_result()
{
	int i = 0;
	char rslt[21];
	int l_decimal_position = 0;

	strcpy(rslt, r_rslt.arr);

//	if (atoi(r_rslt.arr) > 1 || atoi(r_rslt.arr) == 1)
//	{

		v_numeric_result.arr[0]		= '\0';
		v_numeric_result.len		= 0;

		l_exist_decimals = 0;
		l_inst_decimals = 0;
		
		EXEC SQL SELECT TO_NUMBER(:r_rslt) - FLOOR(TO_NUMBER(:r_rslt)),
						LENGTH(SUBSTR(:r_rslt, INSTR(:r_rslt, '.') + 1)), INSTR(:r_rslt, '.')
				 INTO :v_numeric_result, :l_exist_decimals, :l_inst_decimals
				 FROM DUAL;

	
		v_numeric_result.arr[v_numeric_result.len]	= '\0';

		if (l_inst_decimals == 0)
			l_exist_decimals = 0;

		l_decimal_position = l_exist_decimals;


//		if (strcmp(v_numeric_result.arr, "0") == 0)
//		{

			for (i = l_exist_decimals;i < rl_tst_cd_no_of_decimals; i++)
			{

/**************  
			if (strcmp(rslt, "4.65") == 0)
			{
				sprintf(string_var, "RESULT  %d  %d  %s", l_exist_decimals, rl_tst_cd_no_of_decimals,
											r_rslt.arr);
				disp_message(ERR_MESG, string_var);
			}
****************/

				
				if (l_decimal_position == 0)
					strcat(r_rslt.arr, ".");				
	
				strcat(r_rslt.arr, "0");

				l_decimal_position++;

			}
	
			r_rslt.len = strlen(r_rslt.arr);
//		}
/*		else
		{

			strcpy(r_rslt.arr, rslt);
			r_rslt.len = strlen(r_rslt.arr);

		}
*/



//	}

	
	for (i = 0; i < 10; i++)
	{
		rslt[i] = r_rslt.arr[i];
	}

	rslt[i] = '\0';

	strcpy(r_rslt.arr, rslt);
	r_rslt.len = strlen(r_rslt.arr);

}
/*------------------------------------------------------------*/
print_str(char l_mode)
{

	if ( rl_snomed_print_yn.arr[0]	== 'Y' || rl_snomed2_print_yn.arr[0]	== 'Y' ||
		rl_print_snomed_code_yn.arr[0] == 'Y' || rl_print_snomed2_code_yn.arr[0] == 'Y' )
	{

		something_to_print = 1;

		fprintf(fp, "SNOMED : ");

		if (rl_print_snomed_code_yn.arr[0] == 'Y' )
		{
			print_line_snomed2(rl_res_snomed_code.arr);
		}
		else
			print_line_snomed2(" ");
	
		fprintf(fp, " | ");

		if (rl_print_snomed2_code_yn.arr[0] == 'Y' && 
				strlen(rl_res_snomed_code2.arr) > 0 )
		{
			print_line_snomed2(rl_res_snomed_code2.arr);
		}
		else
		{
			print_line_snomed2(" ");
		}


	}
	
}
/*------------------------------------------------------------*/
print_snomed_codes(char l_mode)
{
	if (l_mode == 'Y')
		fprintf(fp, "SNOMED : ");
	else
	{
		fprint_repeat(fp, ' ', 9);
	}

	if (strlen(rl_res_snomed_code2.arr) > 0 )
	{
		print_line_snomed2(rl_res_snomed_code.arr);
	}
	else
	{
		print_line_snomed1(rl_res_snomed_code.arr);
	}

	fprintf(fp, " | ");
	print_line_snomed2(rl_res_snomed_code2.arr);
    
}
/*------------------------------------------------------------*/
 patient_age()
 {

		 float  lone = 0;
		 float  num1 = 0, yrs = 0, 
				tmp_mths = 0, 
				tmp_days = 0;

		 char st_r[50];

	tday.arr[0] = '\0';
	tday.len = 0;

	mths.arr[0]  = '\0';
	mths.len  = 0;

	
	EXEC SQL SELECT TO_CHAR(SYSDATE,'DD/MM/YYYY') INTO :tday
            FROM DUAL;                                        

    EXEC SQL SELECT ABS(MONTHS_BETWEEN(
		TO_DATE(:rl_regd_date,'DD/MM/YYYY'), 
		TO_DATE(:rl_pat_date_of_birth, 'DD/MM/YYYY')))
			INTO :mt FROM DUAL;

			sprintf(mths.arr,"%f",mt);
			strcpy(mths1.arr, mths.arr);

        	tday.arr[tday.len] = '\0';
							
			lone = atoi(strtok(mths1.arr, ".")) ;

		   if (lone > 0) 
		   {
			  num1 = lone/12 ;
			  sprintf(t_age.arr, "%f", num1);
			  yrs = atoi(strtok(t_age.arr, ".")) ;
		   }
		   else
			  yrs = 0;
            
			tmp_mths   = atoi(mths1.arr) - (yrs * 12) ;
			sprintf(t_age.arr, "%f", tmp_mths);
			tmp_mths   = atoi(strtok(t_age.arr, "."));

			if ((tmp_mths == 0)  && (yrs ==0))
			{

				EXEC SQL SELECT TO_CHAR(ROUND((TO_DATE(:rl_regd_date,'DD/MM/YYYY') -
					TO_DATE(:rl_pat_date_of_birth, 'DD/MM/YYYY')),3))
					INTO :t_days FROM DUAL;

					tmp_days = atoi(strtok(t_days.arr,"."));
			}
			else
				tmp_days = (atof(mths.arr) - atoi(mths1.arr)) * 31 ;


			sprintf(st_r, "%f", yrs);
			strcpy(t_age.arr, strtok(st_r, "."));
			strcat(t_age.arr, "Y");
			sprintf(st_r, " %f", tmp_mths);
			strcat(t_age.arr, strtok(st_r, "."));
			strcat(t_age.arr, "M");
			sprintf(st_r, " %f", tmp_days);
			strcat(t_age.arr, strtok(st_r, "."));
			strcat(t_age.arr, "D ");
				
 }
/*------------------------------------------------------------*/
get_test_desc()
{
	can_test_name.arr[0]	= '\0';
	can_test_name.len		= 0;
	
	EXEC SQL SELECT long_desc
			 INTO :can_test_name
			 FROM RL_TEST_CODE
			 WHERE test_code = :can_group_test;


	
	can_test_name.arr[can_test_name.len]	= '\0';

	if (NODATAFOUND);


}
/*------------------------------------------------------------*/
get_user_name(char *y_user)
{
	
	strcpy(sy_user.arr, y_user);
	sy_user.len = strlen(sy_user.arr);
	
	sy_user_name.arr[0]		= '\0';
	sy_user_name.len			= 0;
	
	EXEC SQL SELECT username 
			 INTO :sy_user_name
			 FROM SY_USER
			 WHERE FACILITY_ID = :nd_operating_facility_id
			   AND user_id = :sy_user;

	sy_user_name.arr[sy_user_name.len]		= '\0';

	if (NODATAFOUND);

}
/*------------------------------------------------------------*/
fetch_sy_urgent()
{

	EXEC SQL DECLARE urgent_curs CURSOR FOR
		 SELECT OPERATING_FACILITY_ID,
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
		    AND PGM_ID = 'RLRSENQ3'
			AND REQUEST_STATUS IS NULL
			AND NVL(URGENT_INDICATOR,' ') = 'U';

	EXEC SQL OPEN urgent_curs;

sy_user_id.arr[0] 		= '\0';
sy_session_id.arr[0] 	= '\0';
sy_req_date.arr[0]      = '\0';
sy_machine_name.arr[0]  = '\0';
sy_ws_no.arr[0]		    = '\0';
sy_rowid.arr[0]		    = '\0';
nd_operating_facility_id.arr[0]		    = '\0';

sy_session_id.len	     = 0;
sy_user_id.len	         = 0;
sy_req_date.len          = 0;
sy_machine_name.len      = 0;
sy_ws_no.len             = 0;
sy_rowid.len             = 0;
nd_operating_facility_id.len = 0;


	EXEC SQL FETCH urgent_curs 
	       INTO	:nd_operating_facility_id,
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid;
	
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      sy_user_id.arr[sy_user_id.len] = '\0';
      sy_session_id.arr[sy_session_id.len] = '\0';
      sy_rowid.arr[sy_rowid.len] = '\0';
      sy_req_date.arr[sy_req_date.len] = '\0';
	  sy_machine_name.arr[sy_machine_name.len] = '\0';
	  sy_ws_no.arr[sy_ws_no.len] = '\0';
	  sy_rowid.arr[sy_rowid.len] = '\0';
	  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';


    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
fetch_sy_stat()
{

	EXEC SQL DECLARE stat_curs CURSOR FOR
		 SELECT OPERATING_FACILITY_ID,
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
		    AND PGM_ID = 'RLRSENQ3'
			AND REQUEST_STATUS IS NULL
			AND NVL(URGENT_INDICATOR,' ') = 'S';

	EXEC SQL OPEN stat_curs;

sy_user_id.arr[0] 		= '\0';
sy_session_id.arr[0] 	= '\0';
sy_req_date.arr[0]      = '\0';
sy_machine_name.arr[0]  = '\0';
sy_ws_no.arr[0]		    = '\0';
sy_rowid.arr[0]		    = '\0';
nd_operating_facility_id.arr[0]		    = '\0';

sy_session_id.len	    = 0;
sy_user_id.len	        = 0;
sy_req_date.len         = 0;
sy_machine_name.len     = 0;
sy_ws_no.len            = 0;
sy_rowid.len            = 0;
nd_operating_facility_id.len = 0;


	EXEC SQL FETCH stat_curs 
	       INTO	:nd_operating_facility_id,
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid;
			
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      sy_user_id.arr[sy_user_id.len] = '\0';
      sy_session_id.arr[sy_session_id.len] = '\0';
      sy_rowid.arr[sy_rowid.len] = '\0';
      sy_req_date.arr[sy_req_date.len] = '\0';
	  sy_machine_name.arr[sy_machine_name.len] = '\0';
	  sy_ws_no.arr[sy_ws_no.len] = '\0';
	  sy_rowid.arr[sy_rowid.len] = '\0';
	  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';


    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
fetch_sy_routine()
{

	EXEC SQL DECLARE routine_curs CURSOR FOR
		 SELECT OPERATING_FACILITY_ID,
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
		    AND PGM_ID = 'RLRSENQ3'
			AND REQUEST_STATUS IS NULL
			AND NVL(URGENT_INDICATOR,' ') = 'R';

	EXEC SQL OPEN routine_curs;

sy_user_id.arr[0] 		= '\0';
sy_session_id.arr[0] 	= '\0';
sy_req_date.arr[0]      = '\0';
sy_machine_name.arr[0]  = '\0';
sy_ws_no.arr[0]		    = '\0';
sy_rowid.arr[0]		    = '\0';
nd_operating_facility_id.arr[0]		    = '\0';


sy_session_id.len	    = 0;
sy_user_id.len	        = 0;
sy_req_date.len         = 0;
sy_machine_name.len     = 0;
sy_ws_no.len            = 0;
sy_rowid.len            = 0;
nd_operating_facility_id.len = 0;


	EXEC SQL FETCH routine_curs 
	       INTO	:nd_operating_facility_id,
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid;
			
			
      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      sy_user_id.arr[sy_user_id.len] = '\0';
      sy_session_id.arr[sy_session_id.len] = '\0';
      sy_rowid.arr[sy_rowid.len] = '\0';
      sy_req_date.arr[sy_req_date.len] = '\0';
	  sy_machine_name.arr[sy_machine_name.len] = '\0';
	  sy_ws_no.arr[sy_ws_no.len] = '\0';
	  sy_rowid.arr[sy_rowid.len] = '\0';
	  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';


    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
close_urgent_curs()
{
	EXEC SQL CLOSE urgent_curs;

}
/*------------------------------------------------------------*/
close_stat_curs()
{
	EXEC SQL CLOSE stat_curs;

}
/*------------------------------------------------------------*/
close_routine_curs()
{
	EXEC SQL CLOSE routine_curs;


}
/**************************select transaction based or not ***************/
get_trans_ind()
{
	
	nd_trx_ind.arr[0]		= '\0';
	nd_trx_ind.len		= 0;

	EXEC SQL  SELECT NVL(TRANSACTION_BASED_YN, 'N')
	          INTO   :nd_trx_ind
	          FROM   sy_online_print_id
              WHERE  ONLINE_PRINT_NAME = 'RLRSENQ3';

	if(OERROR)
	{
	    ins_message(ORA_MESG,"SELECT failed on  SY_ON_LINE_PRINT_ID");
	}

	nd_trx_ind.arr[nd_trx_ind.len]			= '\0';


    if(NODATAFOUND)
		return 0;

		
	return 1;

}
/*------------------------------------------------------------*/
declare_param_curs()
{

	EXEC SQL DECLARE param_curs CURSOR FOR
			 SELECT	OPERATING_FACILITY_ID,
			    PARAM1,
			    PARAM2,
			    PARAM3,
			    PARAM4,
			    PARAM5,
				NVL(PARAM6,'N'),
				PARAM7,
				PARAM8,
				rowid,
				pgm_date
			FROM SY_PROG_PARAM
			WHERE OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
			AND pgm_id = 'RLRSENQ1'
			AND session_id = TO_NUMBER(:c_session_id)
            AND param4 = :c_user_id
			ORDER BY param9, TO_DATE(param10, 'DD/MM/YYYY HH24:MI');


	EXEC SQL OPEN param_curs;
}

/*------------------------------------------------------------*/
fetch_param_curs()
{

	rl_prn_ctrl_hdr_pat_no.arr[0] 		= '\0';
	rl_prn_ctrl_hdr_sp_no.arr[0] 		= '\0';
	rl_prn_ctrl_hdr_source_code.arr[0] 	= '\0';
	rl_prn_ctrl_hdr_user.arr[0] 		= '\0';
	rl_prn_ctrl_hdr_section_code.arr[0] = '\0';
	rl_prn_ctrl_hdr_rp_yn.arr[0]		= '\0';
	p_param7.arr[0]						= '\0';
	p_param8.arr[0]						= '\0';
	nd_rowid.arr[0]						= '\0';
	c_pgm_date.arr[0]					= '\0';
	nd_operating_facility_id.arr[0]		= '\0';

	rl_prn_ctrl_hdr_pat_no.len 	        = 0;
	rl_prn_ctrl_hdr_source_code.len     = 0;
	rl_prn_ctrl_hdr_sp_no.len 	        = 0;
	rl_prn_ctrl_hdr_section_code.len    = 0;
	rl_prn_ctrl_hdr_user.len	        = 0;
	rl_prn_ctrl_hdr_rp_yn.len			= 0;
	p_param7.len						= 0;
	p_param8.len						= 0;
	nd_rowid.len						= 0;
	c_pgm_date.len						= 0;
	nd_operating_facility_id.len		= 0;


	EXEC SQL FETCH param_curs 
	       INTO	:nd_operating_facility_id,
			    :rl_prn_ctrl_hdr_pat_no,
	   	   	    :rl_prn_ctrl_hdr_sp_no,
			    :rl_prn_ctrl_hdr_source_code,
			    :rl_prn_ctrl_hdr_user,
			    :rl_prn_ctrl_hdr_section_code,
				:rl_prn_ctrl_hdr_rp_yn,
				:p_param7,
				:p_param8,
				:nd_rowid,
				:c_pgm_date;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_PROG_PARAM");

	      rl_prn_ctrl_hdr_pat_no.arr[rl_prn_ctrl_hdr_pat_no.len]           = '\0';
	      rl_prn_ctrl_hdr_sp_no.arr[rl_prn_ctrl_hdr_sp_no.len]             = '\0';
	      rl_prn_ctrl_hdr_source_code.arr[rl_prn_ctrl_hdr_source_code.len] = '\0';
 	      rl_prn_ctrl_hdr_user.arr[rl_prn_ctrl_hdr_user.len]               = '\0';
	      rl_prn_ctrl_hdr_section_code.arr[rl_prn_ctrl_hdr_section_code.len]  = '\0';
          rl_prn_ctrl_hdr_rp_yn.arr[rl_prn_ctrl_hdr_rp_yn.len]		 = '\0';
		  p_param7.arr[p_param7.len]								 = '\0';
		  nd_rowid.arr[nd_rowid.len]								 = '\0';
		  p_param8.arr[p_param8.len]								 = '\0';
		  c_pgm_date.arr[c_pgm_date.len]							 = '\0';
		  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';
		  
	      strcpy(nd_hosp_no.arr,rl_prn_ctrl_hdr_pat_no.arr);
	      strcpy(nd_spec_no.arr,rl_prn_ctrl_hdr_sp_no.arr);
	      nd_hosp_no.arr[rl_prn_ctrl_hdr_pat_no.len] 	= '\0';
	      nd_spec_no.arr[rl_prn_ctrl_hdr_sp_no.len] 	= '\0';
	      nd_hosp_no.len	= rl_prn_ctrl_hdr_pat_no.len;
	      nd_spec_no.len	= rl_prn_ctrl_hdr_sp_no.len;


	    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
close_param_curs()
{
	EXEC SQL CLOSE param_curs;
}
/*------------------------------------------------------------*/
fetch_sy_requests()
{


	sy_user_id.arr[0] 		= '\0';
	sy_session_id.arr[0] 	= '\0';
	sy_req_date.arr[0]      = '\0';
	sy_machine_name.arr[0]  = '\0';
	sy_ws_no.arr[0]		    = '\0';
	sy_rowid.arr[0]		    = '\0';

	sy_session_id.len	    = 0;
	sy_user_id.len	        = 0;
	sy_req_date.len         = 0;
	sy_machine_name.len     = 0;
	sy_ws_no.len            = 0;
	sy_rowid.len            = 0;


		EXEC SQL SELECT
			    SESSION_ID,
				USER_ID,
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'),
				MACHINE_NAME,
				WS_NO,
				ROWID
		   INTO 
                :sy_session_id,
                :sy_user_id,
                :sy_req_date,
				:sy_machine_name,
				:sy_ws_no,
				:sy_rowid
	       FROM	SY_REPORT_GENERATE_REQUEST
	      WHERE	operating_facility_id = :nd_operating_facility_id
		    AND pgm_id = 'RLRSENQ1'
	        AND	session_id = TO_NUMBER(:c_session_id)
			AND request_date = TO_DATE(:c_pgm_date, 'DDMMYYHH24MISS')
            AND user_id = :c_user_id
			AND request_status IS NULL;

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      if (NOT_FOUND) 
	      return FALSE;
	  else
	  {
		sy_user_id.arr[sy_user_id.len] = '\0';
		sy_session_id.arr[sy_session_id.len] = '\0';
		sy_rowid.arr[sy_rowid.len] = '\0';
		sy_req_date.arr[sy_req_date.len] = '\0';
		sy_machine_name.arr[sy_machine_name.len] = '\0';
		sy_ws_no.arr[sy_ws_no.len] = '\0';
		sy_rowid.arr[sy_rowid.len] = '\0';

		return TRUE;
	  }



    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
gen_file_name1()
{
     nd_file_name.arr[0]   = '\0';
     nd_file_name.len      = 0;

     if (OERROR)
         ins_message(ORA_MESG,"Fetch failed on table RL_PARAM");
      
     nd_file_no.arr[nd_file_no.len] = '\0';

     sprintf(nd_file_name.arr,"%srlrsenq1.lis", WORKING_DIR);

	 strcpy(nd_f_name,nd_file_name.arr);

     if ((fp = fopen(nd_file_name.arr,"w")) == NULL)
     {
         ins_message(ERR_MESG,"Error while opening file RSLT_FILE in gen_file_name1");
         proc_exit();
     }
}
/*-----------------------------------------------------*/
gen_extra_file_name1()
{
   sprintf(extra_file_name,"%srlrsenqe.lis",WORKING_DIR);

   strcpy(nd_e_name,extra_file_name);

   if ((fp = fopen(extra_file_name,"w")) == NULL)
   {
       ins_message(ERR_MESG,"Error while opening EXTTRA FILE");
       proc_exit();
   }

}
/*-----------------------------------------------------*/
patch_sy_table()
{


		   EXEC SQL SELECT COUNT(1)
				    INTO  :v_count
				    FROM   SY_REPORT_GENERATE_REQUEST
				    WHERE  OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
				    AND    pgm_id IN ('RLRSENQ3')
				    AND    request_status = 'E';
		
		   if (v_count > 0)
		   {
				declare_sy_curs();
				while(fetch_sy_curs())
				{
					update_sy_curs();
				}	
				close_sy_curs();

				declare_sy_curs_e();
				while(fetch_sy_curs_e())
				{
					delete_sy_curs();
					del_sy_prog_param();
				}	
				close_sy_curs_e();

				EXEC SQL COMMIT WORK;
		   }

}
/*------------------------------------------------------------*/
declare_sy_curs()
{
	EXEC SQL DECLARE sy_curs CURSOR FOR
		SELECT  OPERATING_FACILITY_ID,
				SESSION_ID, USER_ID, 
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'), 
				MACHINE_NAME, WS_NO, ROWID 
	       FROM	SY_REPORT_GENERATE_REQUEST 
	      WHERE	OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
		    AND pgm_id IN ('RLRSENQ3') 
		    AND request_date > (SYSDATE - 2) 
			AND NVL(request_status, 'O') = 'E';


	EXEC SQL OPEN sy_curs;
}
/*------------------------------------------------------------*/
fetch_sy_curs()
{
		sy_user_id.arr[0] 				= '\0';
		sy_session_id.arr[0] 			= '\0';
		sy_req_date.arr[0]				= '\0';
		sy_machine_name.arr[0]			= '\0';
		sy_ws_no.arr[0]					= '\0';
		sy_rowid.arr[0]					= '\0';
		nd_operating_facility_id.arr[0]	= '\0';

		sy_session_id.len	    = 0;
		sy_user_id.len	        = 0;
		sy_req_date.len         = 0;
		sy_machine_name.len     = 0;
		sy_ws_no.len            = 0;
		sy_rowid.len            = 0;
		nd_operating_facility_id.len = 0;


			EXEC SQL FETCH sy_curs
					 INTO :nd_operating_facility_id,	
						  :sy_session_id,
						  :sy_user_id,
						  :sy_req_date,
						  :sy_machine_name,
						  :sy_ws_no,
						  :sy_rowid;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      sy_user_id.arr[sy_user_id.len] = '\0';
      sy_session_id.arr[sy_session_id.len] = '\0';
      sy_rowid.arr[sy_rowid.len] = '\0';
      sy_req_date.arr[sy_req_date.len] = '\0';
	  sy_machine_name.arr[sy_machine_name.len] = '\0';
	  sy_ws_no.arr[sy_ws_no.len] = '\0';
	  sy_rowid.arr[sy_rowid.len] = '\0';
	  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';


    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
close_sy_curs()
{
	EXEC SQL CLOSE sy_curs;

}
/*------------------------------------------------------------*/
update_sy_curs()
{
   EXEC SQL UPDATE SY_REPORT_GENERATE_REQUEST
               SET request_status = NULL
			 WHERE ROWID = :sy_rowid;

   if(OERROR) 
      ins_message(ERR_MESG,"Failed in update_sy_curs()");       

}
/*------------------------------------------------------------*/
declare_sy_curs_e()
{

	EXEC SQL DECLARE sy_curs_e CURSOR FOR 
  		 SELECT OPERATING_FACILITY_ID,SESSION_ID, USER_ID, 
			    TO_CHAR(REQUEST_DATE,'DDMMYYHH24MISS'), 
				MACHINE_NAME, WS_NO, ROWID 
	       FROM	SY_REPORT_GENERATE_REQUEST 
	      WHERE	OPERATING_FACILITY_ID = DECODE(:nd_facility_id,'*A',OPERATING_FACILITY_ID,
         										                   :nd_facility_id)
		    AND pgm_id IN ('RLRSENQ3') 
		    AND request_date < (SYSDATE - 2)
			AND NVL(request_status, 'O') = 'E';


	EXEC SQL OPEN sy_curs_e;
}
/*------------------------------------------------------------*/
fetch_sy_curs_e()
{
		sy_user_id.arr[0] 		= '\0';
		sy_session_id.arr[0] 	= '\0';
		sy_req_date.arr[0]      = '\0';
		sy_machine_name.arr[0]  = '\0';
		sy_ws_no.arr[0]		    = '\0';
		sy_rowid.arr[0]		    = '\0';
		nd_operating_facility_id.arr[0]		    = '\0';

		sy_session_id.len	    = 0;
		sy_user_id.len	        = 0;
		sy_req_date.len         = 0;
		sy_machine_name.len     = 0;
		sy_ws_no.len            = 0;
		sy_rowid.len            = 0;
		nd_operating_facility_id.len = 0;


			EXEC SQL FETCH sy_curs_e
					 INTO :nd_operating_facility_id,	
					 	  :sy_session_id,
						  :sy_user_id,
						  :sy_req_date,
						  :sy_machine_name,
						  :sy_ws_no,
						  :sy_rowid;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      sy_user_id.arr[sy_user_id.len] = '\0';
      sy_session_id.arr[sy_session_id.len] = '\0';
      sy_rowid.arr[sy_rowid.len] = '\0';
      sy_req_date.arr[sy_req_date.len] = '\0';
	  sy_machine_name.arr[sy_machine_name.len] = '\0';
	  sy_ws_no.arr[sy_ws_no.len] = '\0';
	  sy_rowid.arr[sy_rowid.len] = '\0';
	  nd_operating_facility_id.arr[nd_operating_facility_id.len] = '\0';

    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
close_sy_curs_e()
{
	EXEC SQL CLOSE sy_curs_e;

}
/*------------------------------------------------------------*/
delete_sy_curs()
{
   EXEC SQL DELETE FROM SY_REPORT_GENERATE_REQUEST
			 WHERE ROWID = :sy_rowid;

   if(OERROR) 
      ins_message(ERR_MESG,"Failed in delete_sy_curs()");       

}
/*------------------------------------------------------------*/
del_sy_prog_param()
{

	EXEC SQL DELETE FROM SY_PROG_PARAM 
				WHERE operating_facility_id = :nd_operating_facility_id
				AND pgm_id IN ('RLRSENQ3')
				AND session_id = :sy_session_id
				AND pgm_date = :sy_req_date
				AND param4 = :sy_user_id;

	
      if (OERROR)
         ins_message(ORA_MESG,"Delete failed on table SY_PROG_PARAM");

}
/*------------------------------------------------------------*/
delete_error_record()
{

	declare_sy_curs_2();
	while(fetch_sy_curs_2())
	{
		delete_sy_curs2();
		delete_sy_param();

	}
	close_sy_curs_2();

}
/*------------------------------------------------------------*/
declare_sy_curs_2()
{

	EXEC SQL DECLARE sy_curs_2 CURSOR FOR 
			SELECT   TO_CHAR(request_date,'DDMMYYHH24MISS'), ROWID 
	        FROM	SY_REPORT_GENERATE_REQUEST 
		    WHERE	pgm_id IN ('RLRSENQ1') 
		    AND session_id = TO_NUMBER(:c_session_id)
		    AND user_id = :c_user_id
		    AND NVL(request_status, 'O') = 'E';

	EXEC SQL OPEN sy_curs_2;

}
/*------------------------------------------------------------*/
fetch_sy_curs_2()
{
		sy_req_date.arr[0]      = '\0';
		sy_rowid.arr[0]		    = '\0';

		sy_req_date.len         = 0;
		sy_rowid.len            = 0;


			EXEC SQL FETCH sy_curs_2
				INTO	
					:sy_req_date,
					:sy_rowid;
			

      if(OERROR)
         ins_message(ORA_MESG,"Select failed on table SY_REPORT_GENERATE_REQUEST");

      sy_req_date.arr[sy_req_date.len] = '\0';
	  sy_rowid.arr[sy_rowid.len] = '\0';



    return (LAST_ROW?0:1);

}
/*------------------------------------------------------------*/
close_sy_curs_2()
{
	EXEC SQL CLOSE sy_curs_2;

      if(OERROR)
         ins_message(ORA_MESG,"Close failed on cursor sy_curs_2");

}
/*------------------------------------------------------------*/
delete_sy_param()
{

	EXEC SQL DELETE FROM SY_PROG_PARAM
			 WHERE pgm_id = 'RLRSENQ1'
			 AND session_id = TO_NUMBER(:c_session_id)
			 AND pgm_date = :sy_req_date
			 AND param4 = :c_user_id;

      if(OERROR)
         ins_message(ORA_MESG,"Delete failed on table SY_PROG_PARAM");


}
/*------------------------------------------------------------*/
delete_sy_curs2()
{

   EXEC SQL DELETE FROM SY_REPORT_GENERATE_REQUEST
			 WHERE ROWID = :sy_rowid;

   if(OERROR) 
      ins_message(ERR_MESG,"Failed in delete_sy_curs2()");       

}
/*------------------------------------------------------------*/
/*** only for qatar ***/
get_new_medicom_no()
{
	nd_new_medicom_no.arr[0]		= '\0';
	nd_new_medicom_no.len			= 0;


   EXEC SQL SELECT medicom_no
			INTO :nd_new_medicom_no
			FROM RL_PATIENT_TEMP_LINK
			WHERE hmc_no = :nd_hosp_no;

      if(OERROR);

	if (NODATAFOUND);

	nd_new_medicom_no.arr[nd_new_medicom_no.len]	= '\0';

}
/*------------------------------------------------------------*/
get_health_card_num()
{
    rl_health_card_num.arr[0]      = '\0';
	rl_health_num.arr[0]		   = '\0';
	rl_health_exp_date.arr[0]	   = '\0';

    rl_health_card_num.len         = 0;
	rl_health_num.len			   = 0;
	rl_health_exp_date.len		   = 0;
/*
		EXEC SQL 
              SELECT health_card_num, health_num, 
					TO_CHAR(health_card_exp_date, 'DD/MM/YYYY')
			  INTO :rl_health_card_num, :rl_health_num,
				   :rl_health_exp_date
              FROM MP_PATIENT_MAST
             WHERE PATIENT_ID = :nd_hosp_no;
*/

      if(OERROR);

	if (NODATAFOUND);

    rl_health_card_num.arr[rl_health_card_num.len]       = '\0';
	rl_health_num.arr[rl_health_num.len]				 = '\0';
	rl_health_exp_date.arr[rl_health_exp_date.len]		 = '\0';


}
/*------------------------------------------------------------*/

/*------------------------------------------------------------*/
check_any_res_comp()
{

	EXEC SQL SELECT COUNT(1)
				INTO :other_than_comments
                FROM RL_RESULT_TEXT
               WHERE PATIENT_ID     = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
                 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
				 AND NVL(hide_text_yn, 'N') <> 'Y';
	
	if (other_than_comments == 0)
	{
		EXEC SQL SELECT  COUNT(1)
			 INTO :other_than_comments
                FROM RL_RESULT_SNOMED A
               WHERE A.PATIENT_ID     = :nd_hosp_no
                 AND A.SPECIMEN_NO     = :nd_spec_no
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
                 AND A.GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND A.TEST_CODE       = :rl_tst_test_code
				AND (A.SNOMED_CODE
							IN (SELECT SNOMED_CODE
								FROM RL_SNOMED_CODE
								WHERE snomed_code = A.snomed_code
								AND (NVL(print_yn, 'N') = 'Y' 
									OR NVL(print_code_yn, 'N') = 'Y' ))
					 OR A.SNOMED_CODE_2
							IN (SELECT SNOMED_CODE
								FROM RL_SNOMED_CODE
								WHERE snomed_code = A.snomed_code_2
								AND (NVL(print_yn, 'N') = 'Y' 
								OR NVL(print_code_yn, 'N') = 'Y' )));

	
		if (other_than_comments == 0)
		{
			EXEC SQL  SELECT COUNT(1)
               INTO :other_than_comments 
                FROM RL_RESULT_ORGANISM
               WHERE PATIENT_ID      = :nd_hosp_no
                 AND SPECIMEN_NO     = :nd_spec_no
				 AND OPERATING_FACILITY_ID = :nd_operating_facility_id
                 AND GROUP_TEST_CODE = :rl_tst_group_test_code
                 AND TEST_CODE       = :rl_tst_test_code
				 AND NVL(hide_organism_yn, 'N') <> 'Y';

/************
			 if (other_than_comments == 0)
			{

			} 
****************/
		}
	}

}


/*------------------------------------------------------------*/
/* SPLITTING THE VARCHAR 2000 INTO 70 CHARACTERS   */
/************************************************/
split_hist()
{
  
	char word[2];
	char w_flag ;

    strcpy(word1,"F");

	w_flag = 'T';

    while(fetch_clinical_text())
    {
          
		  	/***** ADDED FOR SCF42 OF QATAR *****/		
			something_to_print = 1;

		  hell = strlen(d_clinical_text.arr);


         z = 0;
	     clt = 0;
	     strcpy(word1,"F"); 
	     cntr = 1;
	     qq = 0;

         while(z<hell)
         {
		 		  	
		 
             word[0] = d_clinical_text.arr[z];
 		     word[1] = '\0';

		     if (strcmp(word,"\n") == 0)
		     {
   
		       cntr = 0;
		       strcpy(word1,"N");
		       qq = z ;
		      }


  		      if(cntr >= 71)
		      {
		   	
			     cmp = cntr;
			     while((d_clinical_text.arr[z] != 32) && (cmp > 1))
			     {

			         z--;
				     cmp--;
				  
			      }

				  qq = z;
				  			   
			      word[0] = d_clinical_text.arr[z];
   			      word[1] = '\0';
		
		  	      if (cmp == 1)
				     strcpy(word1,"W");
			      else
			         strcpy(word1,"T");
			   
		
		       }


				if (((z == hell) || (z == hell - 1)) && (strcmp(word1,"F") == 0))
				{
	
				   fprint_repeat(fp,' ',8);		   
				   for(i=clt;i < z + 1;i++)
		           {
			       		
						if(d_clinical_text.arr[i] == '\n')
						{


							    w_flag = 'F';
 						 }

						fprintf(fp,"%c",d_clinical_text.arr[i]);
			
			       }

				   if (w_flag == 'T')
				   {
				   };

			       fprintf	(fp,"\n");
				   cntr = 0 ;
				   clt = clt + 70 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");


				}

			
		       if (strcmp(word1,"N") == 0) 
		       {
				
		          fprint_repeat(fp,' ',8);		   
				  for(i=clt;i<=qq;i++)
		          {
			         if(d_clinical_text.arr[i] == '\n')
					{
						  
								w_flag = 'F';

				    }

				    fprintf(fp,"%c",d_clinical_text.arr[i]);
					
			      }

				  if (w_flag == 'T')
				  {
				  };
					
			      strcpy(word1,"F");
			      cntr = 0 ;
			      clt = qq + 1;
		          qq = 0;
	   	       }

		       if (strcmp(word1,"T") == 0)
		       {
		 										 
			      fprint_repeat(fp,' ',8);		   
				  for(i=clt;i<= qq;i++)
		          {
		             if(d_clinical_text.arr[i] == '\n')
					 {
						 
								w_flag = 'F';

					  }

					  fprintf(fp,"%c",d_clinical_text.arr[i]);
				
			      }

				  if (w_flag == 'T')
				  {
				  };


			       fprintf	(fp,"\n");
			       cntr = 0 ;
				   clt = qq + 1 ;
			       qq = 0;
				   strcpy(word1,"F");

				
		        }


		        if (strcmp(word1,"W") == 0)
		        {
		 										 
			       fprint_repeat(fp,' ',8);		   
				   for(i=clt;i < clt + 70;i++)
		           {
		              if(d_clinical_text.arr[i] == '\n')
						{

								w_flag = 'F';
						}

						fprintf(fp,"%c",d_clinical_text.arr[i]);
				
			       }

				   if (w_flag = 'T')
				   {
				   };

			       fprintf(fp,"\n");
				   cntr = 0 ;
				   clt = clt + 70 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");

				
		        }

			w_flag = 'T';	  
	        cntr += 1;
	        z++ ;
          }

		
      }
  
       fflush(fp);

#ifdef DEBUG
   printf("rl_res_result_text = %s\n", d_clinical_text.arr);
#endif

if (OERROR)
      ins_message(ERR_MESG, "SPLITTING failed on table RL_PATIENT_CLINICAL_TEXT");

}
/*------------------------------------------------------------*/
print_hmc_no()
{
	char v_patient_id [100];

	get_hmc_no();

	if (strlen(rl_hmc_no.arr) > 0)
	{
		
		fprintf(fp,"%c&k4S",ESC); 
	   	fprintf(fp,"%c(s4B",ESC);
		fprintf(fp, "Patient  ID  : ");
		fprintf(fp,"%c&k4S",ESC); 
   		fprintf(fp,"%c(s-3B",ESC);   
	
		if(rl_hdr_episode_type.arr[0] == 'R')
		{
			if(strcmp(rl_pat_actual_id.arr,"NULL")==0)
	 			strcpy(v_patient_id,nd_hosp_no.arr);
			else
				strcpy(v_patient_id,rl_pat_actual_id.arr);
		}
		else
			strcpy(v_patient_id,nd_hosp_no.arr);

		fprintf(fp, "%-15.15s                          ", v_patient_id);
		
			page_break(1);

			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s4B",ESC);
			fprintf(fp, "HMC No. : ");
			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s-3B",ESC);   

			fprintf(fp,"%c&k12S",ESC);	
			fprintf(fp,"%c&l6D",ESC);
   			fprintf(fp,"%c(s4B",ESC);

			fprintf(fp,"%-20.20s\n",rl_hmc_no.arr);
	
			fprintf(fp,"%c&k4S",ESC); 
   			fprintf(fp,"%c(s-3B",ESC);

	}

}
/*------------------------------------------------------------*/
get_hmc_no()
{
	rl_hmc_no.arr[0]		= '\0';
	rl_hmc_no.len			= 0;

	if (strcmp(rl_alt_id_for_pat_id.arr, "!") != 0)
	{
		if (strcmp(rl_alt_id_for_pat_id.arr, "ALT_ID1_NO") == 0 ||
			strcmp(rl_alt_id_for_pat_id.arr, "ALTERNATE_ID_NUM") == 0)
		{
			EXEC SQL SELECT alternate_id_num
					 INTO :rl_hmc_no
					 FROM MP_PATIENT_MAST
					 WHERE patient_id = :nd_hosp_no;
		}
		else if (strcmp(rl_alt_id_for_pat_id.arr, "ALT_ID2_NO") == 0 || 
			strcmp(rl_alt_id_for_pat_id.arr, "ALTERNATE_ID2_NUM") == 0)
		{

			EXEC SQL SELECT alternate_id2_num
					 INTO :rl_hmc_no
					 FROM MP_PATIENT_MAST
					 WHERE patient_id = :nd_hosp_no;

		}
		else if (strcmp(rl_alt_id_for_pat_id.arr, "ALT_ID3_NO") == 0 ||
			strcmp(rl_alt_id_for_pat_id.arr, "ALTERNATE_ID3_NUM") == 0)
		{
			EXEC SQL SELECT alternate_id3_num
					 INTO :rl_hmc_no
					 FROM MP_PATIENT_MAST
					 WHERE patient_id = :nd_hosp_no;

		}
		else if (strcmp(rl_alt_id_for_pat_id.arr, "ALT_ID4_NO") == 0 ||
			strcmp(rl_alt_id_for_pat_id.arr, "ALTERNATE_ID4_NUM") == 0)
		{
			EXEC SQL SELECT alternate_id4_num
					 INTO :rl_hmc_no
					 FROM MP_PATIENT_MAST
					 WHERE patient_id = :nd_hosp_no;

		}


		if (NODATAFOUND);

		if (OERROR);

	}

	rl_hmc_no.arr[rl_hmc_no.len]			= '\0';

}
/*------------------------------------------------------------*/



/* *******				16.05.2004 ADDED				******* */

/*-----------------------------------------------------*/
open_result_modify_reason()
{
    EXEC SQL OPEN RL_RESULT_MODIFY_REASON_CUR;

    if (OERROR)
         ins_message(ORA_MESG,"OPEN failed on cursor RL_RESULT_MODIFY_REASON_CUR");
}
/*-----------------------------------------------------*/

fetch_result_modify_reason()
{
#ifdef DEBUG
       printf("In fetch_result_modify_reason() \n");
#endif

    rl_res_modify_reason.arr[0]		= '\0';
    rl_modify_reason_rel_by.arr[0]  = '\0';
    rl_modify_reason_rel_dt.arr[0]  = '\0';

    EXEC SQL FETCH RL_RESULT_MODIFY_REASON_CUR
              INTO rl_res_modify_reason,rl_modify_reason_rel_by,rl_modify_reason_rel_dt;
			  
    if (OERROR)
         ins_message(ORA_MESG,"FETCH failed on cursor RL_RESULT_MODIFY_REASON_CUR",0,"");

    rl_res_modify_reason.arr[rl_res_modify_reason.len] = '\0';
    rl_modify_reason_rel_by.arr[rl_modify_reason_rel_by.len] = '\0';
    rl_modify_reason_rel_dt.arr[rl_modify_reason_rel_dt.len] = '\0';

    return (LAST_ROW?0:1);
}


/*-----------------------------------------------------*/
print_result_modify_reason()
{
 
  if (something_to_print > 0)
  {

	open_result_modify_reason();

	_flushall();
  
	test_printed = 0;	

	while(fetch_result_modify_reason())
	{
	 if (rl_res_modify_reason.len)
     {

       if(test_printed)
       {  
	      sprintf(text_line,"%-31.31s%-17.17s%s",rl_modify_reason_rel_by.arr,
							rl_modify_reason_rel_dt.arr,rl_res_modify_reason.arr);
	      print_line(text_line);
       }
       else
       {
	      
	      sprintf(text_line,"%s","Reason for Modification: ");
	      print_line(text_line);
	      sprintf(text_line,"%-31.31s%-17.17s%s",rl_modify_reason_rel_by.arr,
							rl_modify_reason_rel_dt.arr,rl_res_modify_reason.arr);
	      print_line(text_line);
	      test_printed = 1;
       }
     }
   }

   	close_result_modify_reason_cur();

   _flushall();
 }

}


/*-----------------------------------------------------*/

close_result_modify_reason_cur()
{
	EXEC SQL CLOSE RL_RESULT_MODIFY_REASON_CUR;

	if (OERROR)
		ins_message(ORA_MESG,"CLOSE failed on cursor RL_RESULT_MODIFY_REASON_CUR");

}

/*-----------------------------------------------------*/

check_for_print_destn_type()
{

 if (((rl_hdr_episode_type.arr[0] == 'I') &&  (strcmp(rl_rep_inpatient_yn.arr, "Y") == 0 )) ||
    ((rl_hdr_episode_type.arr[0] == 'O') &&  (strcmp(rl_rep_outpatient_yn.arr, "Y") == 0 )) ||
    ((rl_hdr_episode_type.arr[0] == 'H') &&  (strcmp(rl_rep_referral_yn.arr, "Y") == 0 ))   ||
	((rl_hdr_episode_type.arr[0] == 'I') && (strcmp(l_rep_disch_pat_result.arr, "Y") == 0)) ||
    ((rl_hdr_episode_type.arr[0] == 'R') &&  (strcmp(rl_rep_external_yn.arr, "Y") == 0 )))

    l_destn_rep_yn = 'Y';
 else
    l_destn_rep_yn = 'N';
   
 if (((rl_hdr_episode_type.arr[0] == 'I') &&  (strcmp(rl_fax_inpatient_yn.arr, "Y") == 0 )) ||
    ((rl_hdr_episode_type.arr[0] == 'O') &&  (strcmp(rl_fax_outpatient_yn.arr, "Y") == 0 )) ||
	((rl_hdr_episode_type.arr[0] == 'H') &&  (strcmp(rl_fax_referral_yn.arr, "Y") == 0 ))   ||
    ((rl_hdr_episode_type.arr[0] == 'I') && (strcmp(l_fax_disch_pat_result.arr, "Y") == 0)) ||	 
	((rl_hdr_episode_type.arr[0] == 'R') &&  (strcmp(rl_fax_external_yn.arr, "Y") == 0 )))

    l_destn_fax_yn = 'Y';
 else
    l_destn_fax_yn = 'N';  

   
///						:l_rep_disch_pat_result,:l_fax_disch_pat_result,
////l_rep_disch_pat_result
}


/*-----------------------------------------------------*/
gen_file_name_fax()
{

/*     nd_file_name_fax.arr[0]   = '\0';   
     nd_file_name_fax.len      = 0;

*/

	 EXEC SQL EXECUTE 
		  begin
			   declare
					 v_file_name VARCHAR2(500);
					 v_err_txt   VARCHAR2(500);
			   begin
					workstation.get_ws_param(:sy_ws_no,           
											 'FAX_MAIL_FILE_LOCN',
											 v_file_name,  
											 v_err_txt     
											 );
					if v_err_txt is null then
						if v_file_name is not null then
						   :nd_file_name_fax := v_file_name;
						end if;
					else
						:nd_file_name_fax := null;
					end if;			    
			   end;
		  end;
	 END-EXEC;


     if (OERROR)
         ins_message(ORA_MESG,"Fetch failed on while getting file number");
      
     nd_file_name_fax.arr[nd_file_name_fax.len] = '\0';
/*
     p_rep_file_fax.arr[0]   = '\0';   
     p_rep_file_fax.len      = 0;

     p_rep_file_fax_ext.arr[0]   = '\0';   
     p_rep_file_fax_ext.len      = 0;

     sprintf(p_rep_file_fax.arr,"%srslt_%s.lis", nd_file_name_fax.arr,nd_file_no.arr);


	 sprintf(p_rep_file_fax_ext.arr,"%srslt_%s.ext",nd_file_name_fax.arr,nd_file_no.arr);

*/

}
/*-----------------------------------------------------*/