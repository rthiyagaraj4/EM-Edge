
#define NO_DATA_FOUND (sqlca.sqlcode == 1403)
#define VIEW_LOG_FILE 1
#define ONLINE_PRINTING 1
#define OERROR 		  (sqlca.sqlcode < 0)
#define INIT_MESG "Label Printing"
#define ESC 0x1B

#include <stdio.h>  
#include <string.h>
#include <math.h>
#include <malloc.h>   
#include <rl.h> 

EXEC SQL BEGIN DECLARE SECTION;                  

VARCHAR uid_pwd                 [500],     
		nd_source_type	        [10],
		nd_fm_source	        [500],
        d_no_copy				[4],
        nd_facility_id			[30],
		nd_session_id           [500],
		nd_ws_no                [500],

	nd_facility_ind			[10],
	nd_report_group_id		[500],
	nd_printer_id			[1000],
	d_facility_name         [1001],

		nd_trx_ind			    [20],
		nd_printer_type         [20],

		d_fm_unit_no	        [410],
		d_fm_product_code       [410],
		d_fm_ch_product_code    [410],// added by sunil  on 08-Aug-2008 against CRF
		d_fm_ch_unit_no			[200],
		d_facility_id           [41],
        d_antigen_date		    [500],// added by sunil  on 08-Aug-2008 against CRF
        d_antigen_desc		    [500],// added by sunil  on 08-Aug-2008 against CRF

		d_antigen_desc2			[500],// added by sunil  on 05/01/2010
		d_antigen_desc3			[500],// added by sunil  on 05/01/2010
		d_antigen_desc4			[500],// added by sunil  on 05/01/2010
		d_antigen_desc5			[500],// added by sunil  on 05/01/2010
		d_antigen_desc6			[500],// added by sunil  on 05/01/2010
		d_antigen_desc7			[500],// added by sunil  on 05/01/2010
		d_antigen_desc8			[500],// added by sunil  on 05/01/2010
		d_antigen_desc9			[500],// added by sunil  on 05/01/2010
		d_antigen_desc10		[500],// added by sunil  on 05/01/2010

        d_unit_barcode_value    [1010],
		d_product_code_temp     [41], 
		d_product_desc_temp     [1010],
		d_store_instr_code      [110],
		d_store_instr_desc_temp [1000],

		nd_report_ind           [50], // added by preetham on 09/01/2009 wrt SCR7021
        nd_donation_date         [51],
        nd_donation_date1         [51], //added for globalisation
        nd_donor_product_code    [410], 
        nd_donor_unit_no         [410],
        nd_product_code          [410], 
//Dhana changes
		nd_bld_grp_rh_barcode	 [500],	
		nd_prod_barcode_msg1	 [2500],
		nd_prod_barcode_msg2	 [2500],
		nd_donor_id				 [200],
		nd_center_code			 [40],
		nd_center_desc			 [400], // added by sunil 
		nd_product_barcode_value [450],
		nd_product_long_desc	 [410], // added by sunil
		nd_donation_process		 [20],	
		nd_collection_date		 [41], // added by sunil 0n 01-Jun-2008 against CRF	
		nd_volume_units			 [410], // added by sunil 0n 08-aug-2008 against CRF	
		nd_volume_unit			 [410], // added by sunil 0n 16-dec-2008 against SCF	



		d_bld_grp_rh_barcode	 [20][350],	
		d_prod_barcode_msg1		 [20][2500],
		d_prod_barcode_msg2		 [20][2500],
		split_text               [4000],   //added by sunil
		d_donor_id				 [20][200],
		d_center_code			 [20][40],
		d_center_desc			 [40][400], // added by sunil
		d_product_barcode_value	 [20][1500],
		d_product_long_desc		 [45][550], // added by sunil
		d_donation_process		 [20][20],	
		isb_value		         [40],
		isb_unit_no_format       [20],
		nd_sys_date              [41],   // added by sunil
        d_collection_date        [500][210], // added by sunil on 01-Jun-2008 against CRF	
		d_volume_units			 [500][41], // added by sunil 0n 08-aug-2008 against CRF	
		d_volume_unit			 [500][41], // added by sunil 0n 16-dec-2008 against SCF	


		nd_product_desc          [1010], 
        nd_unit_no               [410],
        nd_unit_no_split         [410],// added by sunil
        nd_unit_no_split1        [410],// added by sunil
        nd_unit_no_split2        [410],// added by sunil
        nd_unit_no_seq	         [410],// added by sunil
        nd_rownum_ali			 [410],// added by sunil
        nd_unit_no_gen_yn		 [41],// added by sunil
        nd_blood_group           [41], 

		nd_blood_grp_for_disp    [41],  // added by sunil on 05/01/2010
		nd_blood_group_desc		 [410], // added by sunil on 05/01/2010 

        nd_rhesus_code           [41], 
        nd_rhesus_desc           [410], // added by sunil
        nd_expiry_date           [41],
        nd_expiry_date1          [41], // added by sunil  on 01-Jun-2008 against CRF
        nd_expiry_date2          [41], // added by sunil  on 01-Jun-2008 against CRF
        nd_expiry_date3          [41], // added by sunil  on 01-Jun-2008 against CRF
        nd_screened_legend       [410],
        nd_add_to_stock_yn       [41], // added by sunil  on 01-Jun-2008 against CRF


        d_donation_date         [500][210],
        d_donor_product_code    [500][41], 
        d_donor_unit_no         [500][410],
        d_product_code          [500][41], 
		d_store_instr_desc      [500][1010], 
		d_product_desc          [500][1010], 
        d_unit_no               [500][41],
        d_unit_no_split         [500][41], // added by sunil
		d_unit_no_split1        [500][41], // added by sunil
		d_unit_no_split2        [500][41], // added by sunil
        d_unit_no_seq	        [500][41], // added by sunil
        d_rownum_ali	        [500][410], // added by sunil
		d_unit_no_gen_yn		[500][41],// added by sunil
        d_blood_group           [500][41], 

		d_blood_grp_for_disp    [500][41], // added by sunil on 05/01/2010 
		d_blood_group_desc		[500][410],// added by sunil on 05/01/2010 

        d_rhesus_code           [500][41], 
        d_rhesus_desc           [500][410],  // added by sunil
        d_expiry_date           [500][41],
        d_expiry_date1          [500][41], // added by sunil  on 01-Jun-2008 against CRF
        d_expiry_date2          [500][41], // added by sunil  on 01-Jun-2008 against CRF
        d_expiry_date3          [500][41],
        d_screened_legend       [500][41],
        d_add_to_stock_yn      [500][41], // added by sunil  on 01-Jun-2008 against CRF

		d_flag					[20],

		er_msg                  [3710], 

/***************** variables added for label_cur cursor ***********/

		a_ws_no					[410],
		a_cmd_line_arg			[500],
		a_rowid					[410],
		a_pgm_id				[41],
		b_pgm_id				[41], //added by sunil on 18-08-2008
		l_translated_value		[2500],
		language_id				[25],
/***************** variables added for enhancement ***********/

//		nd_file_no				[100],
		nd_print_source_type	[20],
		nd_print_source			[50];



  int  d_volume[500],
       nd_volume,
	   d_NumOfCopies = 1, // added by sunil  on 27-Aug-2008 against CRF
       d_tot_no_products,
	   a = 0,		//added by sunil to use in splitting
	   b = 0,		//added by sunil to use in splitting
	   h_no_of_rec = 0;


  char string_var[2000],	
     string_var1[2000],	
   v_out_string1[200],
   v_out_string2[200],
   v_out_string3[200],
   v_out_string4[200],
  	chk_unit                 [240],   //added by sunil
	chk_sum                  [24];   //added by sunil

	char v_delimeter = ' ';

  VARCHAR l_temp1  [2100];

// Added on 28/04/2011 for controlling the printing of previously aliquoted units
VARCHAR d_sequence_no [20];

/*tern  char WORKING_DIR_NAME [75];*/

  int er_msg_type = 0;	
  int err_flag = 0;

  int isb_flag = 0;

  int	i,
  err_flag_sql; //added by sunil 0n 280Mar 2008
  char string_char[2500];
  	
EXEC SQL END DECLARE SECTION; 

EXEC SQL INCLUDE SQLCA.H;
EXEC SQL INCLUDE SQLDA.H;
#include <winproc.h>

FILE *f1,*f2;
char filename[500];
char filename1[500];

char filename2[500];// added by sunil on 18-08-2008
char filename3[500];// added by sunil on 18-08-2008

char *command;  
char gtt_yn = 'N';

char local_legend[20][100];

void proc_main(argc,argv)
int argc;
char *argv[];
{
 err_flag = 0;


  if(argc <= 6) 
  {
     ins_message(ERR_MESG,"btrlabel : Usage - BTRUNTLB UID_PWD SESSION_ID PGM_ID UNIT_NO PRODUCT_CODE FACILITY_ID WS_NO arguments wrong\n");
  }

    strcpy(filename,WORKING_DIR);

    strcpy(filename3,WORKING_DIR);// added by sunil on 18-08-2008

    strcpy(a_pgm_id.arr,argv[0]);
    a_pgm_id.len = strlen(a_pgm_id.arr); 

    strcpy(uid_pwd.arr,argv[1]);
    uid_pwd.len = strlen(uid_pwd.arr); 

	extract_act_user(argv[1]); // added on 27 Mar 2008

    strcpy(nd_session_id.arr, argv[2]);
    nd_session_id.len = strlen(nd_session_id.arr);
	

    strcpy(a_pgm_id.arr,argv[3]);
    a_pgm_id.len = strlen(a_pgm_id.arr); 


    if (strcmp(strupr(a_pgm_id.arr), "BTRUNTLB") == 0)
    {

	strcpy(d_fm_unit_no.arr,argv[4]);
	d_fm_unit_no.len = strlen(d_fm_unit_no.arr);
	
    
	strcpy(d_fm_product_code.arr,argv[5]);
	d_fm_product_code.len = strlen(d_fm_product_code.arr);
	

	strcpy(d_facility_id.arr,argv[6]);
	d_facility_id.len = strlen(d_facility_id.arr);

	
	strcpy(nd_ws_no.arr, argv[7]);
	nd_ws_no.len = strlen(nd_ws_no.arr);


	//d_NumOfCopies = atoi(argv[8]);
    }
    else if (strcmp(strupr(a_pgm_id.arr), "BTRSCRLB") == 0)
    {
	strcpy(d_fm_unit_no.arr,argv[4]);
	d_fm_unit_no.len = strlen(d_fm_unit_no.arr);

	strcpy(d_fm_product_code.arr,argv[5]);
	d_fm_product_code.len = strlen(d_fm_product_code.arr);

	strcpy(d_facility_id.arr,argv[6]);
	d_facility_id.len = strlen(d_facility_id.arr);

	strcpy(nd_ws_no.arr, argv[7]);
	nd_ws_no.len = strlen(nd_ws_no.arr);

	//d_NumOfCopies = atoi(argv[8]);

	}
    else if (strcmp(strupr(a_pgm_id.arr), "BDRUSRLB") == 0)
    {

	strcpy(d_fm_unit_no.arr,argv[4]);
	d_fm_unit_no.len = strlen(d_fm_unit_no.arr);

	strcpy(d_fm_product_code.arr,argv[5]);
	d_fm_product_code.len = strlen(d_fm_product_code.arr);

	strcpy(d_facility_id.arr,argv[6]);
	d_facility_id.len = strlen(d_facility_id.arr);

	strcpy(nd_ws_no.arr, argv[7]);
	nd_ws_no.len = strlen(nd_ws_no.arr);

//	d_NumOfCopies = atoi(argv[8]);

    }
//added for aliquot labels
	else if ((strcmp(strupr(a_pgm_id.arr), "BTRALILB") == 0))
    {
	strcpy(d_fm_unit_no.arr,argv[4]);
	d_fm_unit_no.len = strlen(d_fm_unit_no.arr);

	strcpy(d_fm_product_code.arr,argv[5]);
	d_fm_product_code.len = strlen(d_fm_product_code.arr);

	strcpy(d_facility_id.arr,argv[6]);
	d_facility_id.len = strlen(d_facility_id.arr);

	strcpy(nd_ws_no.arr, argv[7]);
	nd_ws_no.len = strlen(nd_ws_no.arr);

//	d_NumOfCopies = atoi(argv[8]);
// checking for argv from reprint or stock entry

// Added on 28/04/2011 for controlling the printing of previously aliquoted units
		if (argv[12])
		{
			strcpy(d_sequence_no.arr, argv[12]);
			d_sequence_no.len = strlen(d_sequence_no.arr);
		}


		if (argv[9])
		{

			if (strcmp(argv[9], "!!") != 0)
			{
				strcpy(d_fm_ch_product_code.arr,argv[9]);
				d_fm_ch_product_code.len = strlen(d_fm_ch_product_code.arr);		
			}

		}

		if (argv[10])
		{

			if (strcmp(argv[10], "!!") != 0)
			{
				strcpy(d_fm_ch_unit_no.arr,argv[10]);
				d_fm_ch_unit_no.len = strlen(d_fm_ch_unit_no.arr);
			}

		}

//sprintf(string_var, "Unit   [%s]  Product  [%s]  Seq  [%s]", d_fm_ch_unit_no.arr, d_fm_ch_product_code.arr, d_sequence_no.arr);
//disp_message(ERR_MESG, string_var);

    }
//added for screend lables
	else if ((strcmp(strupr(a_pgm_id.arr), "BTRSPRLB") == 0))
    {
	
	strcpy(d_fm_unit_no.arr,argv[4]);
	d_fm_unit_no.len = strlen(d_fm_unit_no.arr);

	strcpy(d_fm_product_code.arr,argv[5]);
	d_fm_product_code.len = strlen(d_fm_product_code.arr);

	strcpy(d_facility_id.arr,argv[6]);
	d_facility_id.len = strlen(d_facility_id.arr);

	strcpy(nd_ws_no.arr, argv[7]);
	nd_ws_no.len = strlen(nd_ws_no.arr);

 //	d_NumOfCopies = atoi(argv[8]);
   }
	//added for BT functionality lables
	else if ((strcmp(strupr(a_pgm_id.arr), "BTRCONVL") == 0))
    {
	
	strcpy(d_fm_unit_no.arr,argv[4]);
	d_fm_unit_no.len = strlen(d_fm_unit_no.arr);

	strcpy(d_fm_product_code.arr,argv[5]);
	d_fm_product_code.len = strlen(d_fm_product_code.arr);

	strcpy(d_facility_id.arr,argv[6]);
	d_facility_id.len = strlen(d_facility_id.arr);

	strcpy(nd_ws_no.arr, argv[7]);
	nd_ws_no.len = strlen(nd_ws_no.arr);

//	d_NumOfCopies = atoi(argv[8]);
    }

/************** to be verified later after finalizing the arguments with front end ************/
	  if (argc > 11)
		{
			strcpy(nd_report_ind.arr, argv[11]);
   			nd_report_ind.len = strlen(nd_report_ind.arr);
		}	

    EXEC SQL WHENEVER SQLERROR GOTO err_exit;
    EXEC SQL CONNECT :uid_pwd;

    set_meduser_role();

	strcpy(language_id.arr,l_language_id.arr);
	language_id.len =l_language_id.len;
	language_id.arr[l_language_id.len]='\0';

	//from here added by sunil on 03/12/2007
	EXEC SQL EXECUTE
	DECLARE
	t_date   VARCHAR2(50);
	BEGIN
	
		t_date := NVL(GET_LOCALE_DATE_2T.GET_CURRENT_DATE (:language_id, 'MONTH DD YYYY' ),SYSDATE);
 		:nd_sys_date := t_date;
	END;
    END-EXEC;

    //upto here added by sunil on 03/12/2007

//disp_message(ERR_MESG, a_pgm_id.arr);

	get_legend_value(15);

	get_isb_status();

    get_facility_name();

    get_printer_type();

	get_trans_ind();

//sprintf(string_var, "6 -   %s   %s %s ", a_pgm_id.arr,nd_print_source_type.arr, nd_print_source.arr);
//disp_message(ERR_MESG, string_var);

	get_printer_id_dtls();

//sprintf(string_var, "7 - PGM ID   %s", a_pgm_id.arr);
//disp_message(ERR_MESG, string_var);

	nd_printer_id.len = strlen(nd_printer_id.arr);
	

    if (strcmp(strupr(a_pgm_id.arr), "BTRSCRLB") == 0)
    {
      //dclr_un_screened_cur();
	  dclr_screened_cur();
      //while(fetch_un_screened_cur())
	  while(fetch_screened_cur())
	  {
	    get_product_desc();
		if(isb_flag == 1)
		  {
			get_graph_barcode();
			get_center_code();		
			//get_donation_details();


			if (strlen(d_donor_id[h_no_of_rec].arr) > 0)
			{
				get_donation_details_bd();
			}
			else
			{

				if (strlen(d_donation_process[h_no_of_rec].arr) == 0)
				{
					strcpy(nd_donation_process.arr, "R");
					nd_donation_process.len = strlen(nd_donation_process.arr);

					strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
					d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);
				}

			}

			get_label_gen_yn();
			get_unit_no();  		
		   }
        h_no_of_rec = h_no_of_rec + 1;
       }
     }  

    //ADDED FOR BT functionality

    if (strcmp(strupr(a_pgm_id.arr), "BTRCONVL") == 0)
    {
	  dclr_screened_cur();
      while(fetch_screened_cur())
	  {
	    get_product_desc();
		if(isb_flag == 1)
		{
			get_graph_barcode();
			get_center_code();		
			//get_donation_details(); 

			if (strlen(d_donor_id[h_no_of_rec].arr) > 0)
			{
				get_donation_details_bd();
			}

			get_label_gen_yn(); 		
			get_unit_no();  		
		}
        h_no_of_rec = h_no_of_rec + 1;
      }
     }  


    //ADDED FOR ALIQUOT LABEL
	if (strcmp(strupr(a_pgm_id.arr),"BTRALILB") == 0)
    {
	  dclr_un_screenedali_cur();
      while(fetch_un_screenedali_cur())
	  {

			get_product_desc();
			if(isb_flag == 1)
			{
				get_graph_barcode();
				get_center_code();		
				//get_donation_details();

				if (strlen(d_donor_id[h_no_of_rec].arr) > 0)
				{
					get_donation_details_bd();
				}
				else
				{

					if (strlen(d_donation_process[h_no_of_rec].arr) == 0)
					{
						strcpy(nd_donation_process.arr, "R");
						nd_donation_process.len = strlen(nd_donation_process.arr);

						strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
						d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);
					}

				}

				get_label_gen_yn();  		
				get_unit_no();  		
			}

	        h_no_of_rec = h_no_of_rec + 1;

//sprintf(string_var, "While Loop  [%d]", h_no_of_rec);
//disp_message(ERR_MESG, string_var);

      }
    }  
    
	//ADDED FOR SCREENED LABEL
	if (strcmp(strupr(a_pgm_id.arr),"BTRSPRLB") == 0)
    {
	  dclr_screened_cur();
      while(fetch_screened_cur())
	  {
	    get_product_desc();
		if(isb_flag == 1)
		{
			get_graph_barcode();
			get_center_code();		
			//get_donation_details();  		

			if (strlen(d_donor_id[h_no_of_rec].arr) > 0)
			{
				get_donation_details_bd();
			}

			get_label_gen_yn();
			get_unit_no();  		
		}
        h_no_of_rec = h_no_of_rec + 1;
      }
    } 
	if (strcmp(strupr(a_pgm_id.arr), "BDRUSRLB") == 0)
    {
      //dclr_un_screened_cur();
	  dclr_screened_cur();
      //while(fetch_un_screened_cur())
	  while(fetch_screened_cur())
	  {
	    get_product_desc();
		if(isb_flag == 1)
		  {
			get_graph_barcode();
			get_center_code();		
			//get_donation_details();

			if (strlen(d_donor_id[h_no_of_rec].arr) > 0)
			{
				get_donation_details_bd();
			}

			get_label_gen_yn();
			get_unit_no();  		
		   }
        h_no_of_rec = h_no_of_rec + 1;
       }
     }  

	get_antigen_name(); 
//disp_message(ERR_MESG, "9");
	call_main_report();
//disp_message(ERR_MESG, "10");
    EXEC SQL COMMIT WORK RELEASE;
    return;

	err_exit:
    EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(f1);
    sprintf(string_var,"%s -> %s\n",d_fm_unit_no.arr, sqlca.sqlerrm.sqlerrmc);
    ins_message(ORA_MESG,string_var);
    EXEC SQL COMMIT WORK RELEASE;

}


CalculateChecksum(char *inputString)
{
	int ch, sum, charValue, isDigit, isUpperAlpha;
	static char iso7064ValueToCharTable[] ="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ*";
	for (sum = 0; ch = *inputString; inputString++)
	{
		isDigit = ((ch >= '0') && (ch <= '9'));
		isUpperAlpha = ((ch >= 'A') && (ch <= 'Z'));
		if (isDigit || isUpperAlpha)
		{
			if (isDigit)
				charValue = ch - '0';
			else
				charValue = ch - 'A' + 10;
		sum = ((sum + charValue) * 2) % 37;
		}
	}
charValue = (38 - sum) % 37;
sprintf(chk_sum,"%c",iso7064ValueToCharTable[charValue]);
}


get_isb_status()
 {

	isb_value.arr[0]	= '\0';
	isb_value.len		= 0;

	isb_unit_no_format.arr[0]	= '\0';/* added on 17/11/2008*/
	isb_unit_no_format.len		= 0;/*added on 17/11/2008*/



	EXEC SQL  SELECT USE_ISBT_NUMBERING_YN,nvl(UNIT_NO_FORMAT_IND, 'S') /* added on 17/11/2008*/
	            INTO :isb_value, :isb_unit_no_format /* added on 17/11/2008*/
	            FROM BD_PARAM;              

	isb_value.arr[isb_value.len]   = '\0';
	isb_value.len = strlen(isb_value.arr);

	isb_unit_no_format.arr[isb_unit_no_format.len]   = '\0';
	isb_unit_no_format.len = strlen(isb_unit_no_format.arr);

//sprintf(string_var,"%s",isb_unit_no_format.arr);
//disp_message(ERR_MESG, string_var); 

    if(isb_value.arr[0] == 'Y')
	{		
/*from here added by sunil on 29-09-2008*/
	    if (strcmp(strupr(a_pgm_id.arr), "BTRUNTLB") == 0)
		{
/*			if (strcmp(isb_unit_no_format.arr,"P") == 0)
			{
			strcpy(b_pgm_id.arr,"BTRUNIBT"); 
			b_pgm_id.len = strlen(b_pgm_id.arr); 
			strcpy(filename1, "BDRUNIBP");
			strcat(filename, strcat(filename1, ".lis"));
			}
			else 
			{
				strcpy(b_pgm_id.arr,"BTRUNIBT"); 
				b_pgm_id.len = strlen(b_pgm_id.arr); 
				strcpy(filename1, b_pgm_id.arr);
				strcat(filename, strcat(filename1, ".lis"));
			}
*/
			strcpy(b_pgm_id.arr,"BTRUNIBT"); 
			b_pgm_id.len = strlen(b_pgm_id.arr); 
			strcpy(filename1, b_pgm_id.arr);
			strcat(filename, strcat(filename1, ".lis"));
		}
		else if (strcmp(strupr(a_pgm_id.arr), "BDRUSRLB") == 0)
		{
			strcpy(filename1, a_pgm_id.arr);
			strcat(filename, strcat(filename1, ".lis"));
			strcpy(b_pgm_id.arr,"BDRUSRLB");
			b_pgm_id.len = strlen(b_pgm_id.arr); 
		}
		else
		{
			strcpy(b_pgm_id.arr,"BTRSCIBT");
			b_pgm_id.len = strlen(b_pgm_id.arr); 
			strcpy(filename1, b_pgm_id.arr);
			strcat(filename, strcat(filename1, ".lis"));
		}
/*upto here added by sunil on 29-09-2008*/
		isb_flag = 1;
	}
	else
	{
		strcpy(filename1, a_pgm_id.arr);// added by sunil on 29-09-2008
		strcat(filename, strcat(filename1, ".lis"));// added by sunil on 29-09-2008
		isb_flag= 0;
	}
	if(OERROR)
	{
		sprintf(string_var,"%s get_isb_status()-> %s\n", isb_value, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

    if(NO_DATA_FOUND)
    {
      isb_value.arr[isb_value.len]   = '\0';
      isb_value.len = strlen(isb_value.arr);
    }

 }


get_legend_value(int cou)
 {
	EXEC SQL EXECUTE
	BEGIN
	  SM_POPULATE_REPORT_LEGEND.FETCH_LEGEND (:d_facility_id,:language_id,'BTRLBPRN.LEGEND_');
	END;
	END-EXEC;

	for (i=1; i<=cou; i++)
	{
		l_translated_value.arr[0]		= '\0';
		EXEC SQL EXECUTE
		BEGIN
               :l_translated_value :=    GET_LEGEND(LTRIM(RTRIM('BTRLBPRN.LEGEND_'||LTRIM(RTRIM(TO_CHAR(:i,'009'))))));
		END;
		END-EXEC;
	
		l_translated_value.arr[l_translated_value.len] = '\0';
		
		//disp_message(ERR_MESG,l_translated_value.arr);
		
		strcpy(local_legend[i],l_translated_value.arr);
		
		//disp_message(ERR_MESG,local_legend[i]);
	}
 }

//ADDED FOR SCREENED CURSOR
dclr_screened_cur()
{
		EXEC SQL DECLARE c_screen CURSOR FOR
                       SELECT a.donation_date,
							  a.donor_id,
							  a.donation_type,
							  a.product_code, 
                              a.unit_no,
                              a.blood_group,

                              NVL(d.blood_grp_for_disp, a.blood_group) blood_grp_for_disp, /* added by sunil on 05/01/2010*/
							  NVL(d.blood_group_desc, ' ') blood_group_desc, /* added by sunil on 05/01/2010*/

                  	          a.rhesus_code,
							  b.long_desc,
                              a.Current_Volume,
							  c.short_desc volume_units,
							  a.volume_units volume_unit,
                              a.expiry_date, 
							  a.centre_code
							  FROM
							  (SELECT TO_CHAR(donation_date, 'DD/MM/YYYY') donation_date,
									  donor_id,
									  donation_type,
							  		  product_code, 
									  unit_no,
                              		  blood_group,
                  	          		  rhesus_code,
							  		  Current_Volume,
							  		  volume_units,
                              		  TO_CHAR(expiry_date, 'DDMMYYYY HH24:MI') expiry_date,
									  centre_code
                       			FROM   BT_BLOOD_UNITS_MAST
		                        WHERE  unit_no = :d_fm_unit_no
							    AND    Product_code = :d_fm_product_code
							    AND    operating_facility_id = :d_facility_id) a, 
								(SELECT rhesus_code, long_desc 
								from BT_RHESUS_CODE_MAST_LANG_VW
								WHERE language_id = :language_id) b,
								(SELECT uom_code, short_desc
								FROM BT_UOM_MAST_LANG_VW
								WHERE language_id = :language_id) c,

								(SELECT NVL(b.blood_group, a.blood_group) blood_group, NVL(b.blood_grp_for_disp, a.blood_group) blood_grp_for_disp, NVL(b.disp_long_desc, a.long_desc) blood_group_desc
								FROM BT_BLOOD_GROUP_MAST_LANG_VW a, BD_BLOOD_GRP_DESC_MAST_LANG_VW b
								WHERE a.blood_group = b.blood_group(+)
								AND a.language_id = b.language_id(+)
								AND a.language_id = :language_id) d /* added by sunil on 05/01/2010 */

								WHERE  a.rhesus_code = b.rhesus_code
					   			AND	  a.volume_units= c.uom_code(+)
								AND	a.blood_group = d.blood_group(+); /* added by sunil on 05/01/2010 */



		EXEC SQL OPEN c_screen;
  
    if (OERROR) 
	{
        ins_message (ORA_MESG, "OPEN Cursor c_scr Failed ");
    }
}

dclr_un_screenedali_cur()
{
		EXEC SQL DECLARE c_scr_ali CURSOR FOR
                       SELECT A.donation_date, 
							  a.donor_id,
							  a.donation_type, 
					          A.A_product_code, 
                              A.A_unit_no,
                              A.blood_group,

                              NVL(D.blood_grp_for_disp, A.blood_group) blood_grp_for_disp, /* added by sunil on 05/01/2010*/
							  NVL(D.blood_group_desc, ' ') blood_group_desc, /* added by sunil on 05/01/2010*/

                  	          A.rhesus_code,
							  B.long_desc,
                              A.A_Volume,
							  C.short_desc volume_units,
							  A.volume_units volume_unit,
                              A.expiry_date,
							  a.centre_code,
							  rownum
					   FROM
					   (SELECT TO_CHAR(B.donation_date, 'DD/MM/YYYY') donation_date,
							  b.donor_id,
							  b.donation_type,
					          A.A_product_code, 
                              A.A_unit_no,
                              B.blood_group,
                  	          B.rhesus_code,
							  A.A_Volume,
							  b.volume_units,
                              TO_CHAR(B.expiry_date, 'DDMMYYYY HH24:MI') expiry_date,
							  b.centre_code
						FROM   BT_ALIQUOT_UNITS A,BT_BLOOD_UNITS_MAST B
						WHERE  A.unit_no = :d_fm_unit_no
                        AND    A.Product_code = :d_fm_product_code
                        AND    A.operating_facility_id = :d_facility_id
			AND ( ( :a_pgm_id = 'BTRALILB') AND ( (:d_sequence_no IS NOT NULL AND A.seq_no = TO_NUMBER(:d_sequence_no) )
                              OR (A_unit_no = :d_fm_ch_unit_no AND A_product_code = :d_fm_ch_product_code) ) )
//			((:a_pgm_id = 'BTRALILB') AND A.seq_no = NVL(TO_NUMBER(:d_sequence_no), 0))
					    AND    A.Product_code=B.Product_code
					    AND    A.Unit_no=B.unit_no ) a,
						(SELECT rhesus_code, long_desc 
								from BT_RHESUS_CODE_MAST_LANG_VW
								WHERE language_id = :language_id) b,
						(SELECT uom_code, short_desc
								FROM BT_UOM_MAST_LANG_VW
								WHERE language_id = :language_id) c,

						(SELECT NVL(b.blood_group, a.blood_group) blood_group, NVL(b.blood_grp_for_disp, a.blood_group) blood_grp_for_disp, NVL(b.disp_long_desc, a.long_desc) blood_group_desc
								FROM BT_BLOOD_GROUP_MAST_LANG_VW a, BD_BLOOD_GRP_DESC_MAST_LANG_VW b
								WHERE a.blood_group = b.blood_group(+)
								AND a.language_id = b.language_id(+)
								AND a.language_id = :language_id) d /* added by sunil on 05/01/2010 */

								WHERE  a.rhesus_code = b.rhesus_code
					   			AND	  a.volume_units= c.uom_code(+)
								AND	a.blood_group = d.blood_group(+) /* added by sunil on 05/01/2010 */
						ORDER BY a_unit_no, a_product_code;		

		EXEC SQL OPEN c_scr_ali;
  
    if (OERROR) 
	{
        ins_message (ORA_MESG, "OPEN Cursor c_scr Failed ");
    }

}


dclr_un_screened_cur()
{
		EXEC SQL DECLARE c_scr CURSOR FOR
                       SELECT A.donation_date,
							  a.donor_id,
							  a.donation_type,
                              A.donor_product_code, 
                              A.donor_unit_no,
                              A.product_code, 
                              A.unit_no, 
							  A.blood_group, 

                              NVL(D.blood_grp_for_disp, A.blood_group) blood_grp_for_disp, /* added by sunil on 05/01/2010*/
							  NVL(D.blood_group_desc, ' ') blood_group_desc, /* added by sunil on 05/01/2010*/

							  A.rhesus_code,
							  B.long_desc,
							  C.short_desc volume_units,
							  A.volume_units volume_unit,
                              A.expiry_date,
							  a.centre_code
					   FROM 
					   (      SELECT TO_CHAR(donation_date, 'DD/MM/YYYY') donation_date,
							  donor_id,
							  donation_type, 
                              product_code donor_product_code, 
                              unit_no donor_unit_no,
                              product_code, 
                              unit_no, 
							  blood_group, 
							  rhesus_code, 
							  volume_units,
                              TO_CHAR(expiry_date, 'DDMMYYYYHH24:MI') expiry_date,
							  centre_code
							  FROM bt_blood_units_mast
                       		  WHERE  unit_no = :d_fm_unit_no
                       		  AND    product_code = :d_fm_product_code 
                       		  AND    operating_facility_id = :d_facility_id
					   		  AND    ( ( :a_pgm_id = 'BTRSCRLB' AND 1 = 1 )
					          		   OR (  :a_pgm_id = 'BDRUSRLB' AND 1=1)
					          		   OR (  :a_pgm_id = 'BTRUNTLB' AND 1=1)
					          		   )
							  AND product_code = nvl(:d_fm_ch_product_code, product_code)		   
						) A,  
						(SELECT RHESUS_CODE , LONG_DESC FROM BT_RHESUS_CODE_MAST_LANg_vW 
								WHERE    Language_id = :language_id
						)B,
						(SELECT UOM_CODE, SHORT_DESC FROM BT_UOM_MAST_LANG_VW
								WHERE language_id = :language_id
						) C,	 

						(SELECT NVL(b.blood_group, a.blood_group) blood_group, NVL(b.blood_grp_for_disp, a.blood_group) blood_grp_for_disp, NVL(b.disp_long_desc, a.long_desc) blood_group_desc
								FROM BT_BLOOD_GROUP_MAST_LANG_VW a, BD_BLOOD_GRP_DESC_MAST_LANG_VW b
								WHERE a.blood_group = b.blood_group(+)
								AND a.language_id = b.language_id(+)
								AND a.language_id = :language_id
						) D /* added by sunil on 05/01/2010 */

						WHERE A.RHESUS_CODE = B.RHESUS_CODE(+)
						AND	  A.VOLUME_UNITS = C.UOM_CODE(+)
						AND	A.blood_group = D.blood_group(+) /* added by sunil on 05/01/2010 */
						ORDER BY A.unit_no, A.product_code;	
									
		EXEC SQL OPEN c_scr;
  
    if (OERROR) 
	{
        ins_message (ORA_MESG, "OPEN Cursor c_scr Failed ");
    }
}

int fetch_un_screened_cur()
{

	nd_donor_id.arr[0]='\0';
	nd_donor_id.len=0;

	nd_donation_process.arr[0]='\0';
	nd_donation_process.len=0;


	nd_center_code.arr[0]='\0';
	nd_center_code.len=0;

  nd_donation_date.arr[0] = '\0';
  nd_donation_date.len = 0;

  nd_donor_product_code.arr[0] = '\0';
  nd_donor_product_code.len = 0;


  nd_donor_unit_no.arr[0] = '\0';
  nd_donor_unit_no.len = 0;

  nd_product_code.arr[0] = '\0';
  nd_product_code.len = 0;

  nd_unit_no.arr[0] = '\0';
  nd_unit_no.len = 0;


  nd_blood_group.arr[0] = '\0';
  nd_blood_group.len = 0;

  nd_blood_grp_for_disp.arr[0] = '\0'; /*added by sunil on 05/01/2010 */
  nd_blood_grp_for_disp.len = 0; /*added by sunil on 05/01/2010 */

  nd_blood_group_desc.arr[0] = '\0'; /*added by sunil on 05/01/2010 */
  nd_blood_group_desc.len = 0; /*added by sunil on 05/01/2010 */


  nd_rhesus_code.arr[0] = '\0';
  nd_rhesus_code.len = 0;

  nd_rhesus_desc.arr[0] = '\0';
  nd_rhesus_desc.len = 0;

  nd_expiry_date.arr[0] = '\0';
  nd_expiry_date.len = 0;

  nd_expiry_date1.arr[0] = '\0';
  nd_expiry_date1.len = 0;

  nd_expiry_date2.arr[0] = '\0';
  nd_expiry_date2.len = 0;

  nd_expiry_date3.arr[0] = '\0';
  nd_expiry_date3.len = 0;

  nd_screened_legend.arr[0] = '\0';
  nd_screened_legend.len = 0;

  nd_volume_units.arr[0] = '\0';
  nd_volume_units.len = 0;
 
  nd_volume_unit.arr[0] = '\0';
  nd_volume_unit.len = 0;

  nd_add_to_stock_yn.arr[0] = '\0';
  nd_add_to_stock_yn.len = 0;


  EXEC SQL FETCH c_scr INTO
                        :nd_donation_date,
						:nd_donor_id, 
						:nd_donation_process, 
                        :nd_donor_product_code,
                        :nd_donor_unit_no,
                        :nd_product_code,
                        :nd_unit_no,
                        :nd_blood_group,
						:nd_blood_grp_for_disp, /*added by sunil on 05/01/2010*/
						:nd_blood_group_desc, /*added by sunil on 05/01/2010*/
                        :nd_rhesus_code,
						:nd_rhesus_desc,
						:nd_volume,
						:nd_volume_units,
						:nd_volume_unit,
                        :nd_expiry_date,
						:nd_center_code;
 
	if (OERROR)
	{
//		sprintf(string_var,"%s get_facility_name()-> %s\n", d_facility_id.arr, sqlca.sqlerrm.sqlerrmc);
//		disp_message(ERR_MESG, string_var);
        ins_message (ORA_MESG, "FETCH failed c2 ");
		return 0;
      }

    if (NO_DATA_FOUND)
       return 0;
	   

	nd_donor_id.arr[nd_donor_id.len]='\0';
	nd_donation_process.arr[nd_donation_process.len]	= '\0';
 
  nd_center_code.arr[nd_center_code.len] = '\0';

  nd_donation_date.arr[nd_donation_date.len] = '\0';
  nd_donation_date.len = strlen(nd_donation_date.arr);

  nd_collection_date.arr[nd_collection_date.len] = '\0';
  nd_collection_date.len = strlen(nd_collection_date.arr);

  nd_donor_product_code.arr[nd_donor_product_code.len] = '\0';
  nd_donor_product_code.len = strlen(nd_donor_product_code.arr);

  nd_donor_unit_no.arr[nd_donor_unit_no.len] = '\0';
  nd_donor_unit_no.len = strlen(nd_donor_product_code.arr);

  nd_product_code.arr[nd_product_code.len] = '\0';
  nd_product_code.len = strlen(nd_product_code.arr);

  nd_unit_no.arr[nd_unit_no.len] = '\0';
  nd_unit_no.len = strlen(nd_unit_no.arr);

  nd_blood_group.arr[nd_blood_group.len] = '\0';
  nd_blood_group.len = strlen(nd_blood_group.arr);

  nd_blood_grp_for_disp.arr[nd_blood_grp_for_disp.len] = '\0';/*added by sunil on 05/01/2010*/
  nd_blood_grp_for_disp.len = strlen(nd_blood_grp_for_disp.arr);/*added by sunil on 05/01/2010*/

  nd_blood_group_desc.arr[nd_blood_group_desc.len] = '\0';/*added by sunil on 05/01/2010*/
  nd_blood_group_desc.len = strlen(nd_blood_group_desc.arr);/*added by sunil on 05/01/2010*/

  nd_rhesus_code.arr[nd_rhesus_code.len] = '\0';
  nd_rhesus_code.len = strlen(nd_rhesus_code.arr);

  nd_rhesus_desc.arr[nd_rhesus_desc.len] = '\0';
  nd_rhesus_desc.len = strlen(nd_rhesus_desc.arr);

  nd_expiry_date.arr[nd_expiry_date.len] = '\0';
  nd_expiry_date.len = strlen(nd_expiry_date.arr);

  nd_expiry_date1.arr[nd_expiry_date1.len] = '\0';
  nd_expiry_date1.len = strlen(nd_expiry_date1.arr);

  nd_expiry_date2.arr[nd_expiry_date2.len] = '\0';
  nd_expiry_date2.len = strlen(nd_expiry_date2.arr);

  nd_expiry_date3.arr[nd_expiry_date3.len] = '\0';
  nd_expiry_date3.len = strlen(nd_expiry_date3.arr);

  nd_screened_legend.arr[nd_screened_legend.len] = '\0';
  nd_screened_legend.len = strlen(nd_screened_legend.arr);

  nd_volume_units.arr[nd_volume_units.len] = '\0';
  nd_volume_units.len = strlen(nd_volume_units.arr);

  nd_volume_unit.arr[nd_volume_unit.len] = '\0';
  nd_volume_unit.len = strlen(nd_volume_unit.arr);

  nd_add_to_stock_yn.arr[nd_add_to_stock_yn.len] = '\0';
  nd_add_to_stock_yn.len = strlen(nd_add_to_stock_yn.arr);

EXEC SQL EXECUTE
	DECLARE
	t_date   VARCHAR2(50);

	BEGIN
	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (to_date(:nd_donation_date,'DD/MM/YYYY'), :language_id , t_date);
	:nd_donation_date1 := t_date;
	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (to_date(:nd_donation_date,'DD/MM/YYYY'), :language_id , t_date, 'DD Mon YYYY');
	:nd_collection_date := t_date;
	END;
END-EXEC;


/*
  sprintf(d_donation_date[h_no_of_rec].arr,"%s", nd_donation_date1.arr);
  d_donation_date[h_no_of_rec].len = strlen(d_donation_date[h_no_of_rec].arr);

  sprintf(d_donor_product_code[h_no_of_rec].arr,"%s", nd_donor_product_code.arr);
  d_donor_product_code[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

  sprintf(d_donor_unit_no[h_no_of_rec].arr,"%s", nd_donor_unit_no.arr);
  d_donor_unit_no[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

  sprintf(d_product_code[h_no_of_rec].arr,"%s", nd_product_code.arr);
  d_product_code[h_no_of_rec].len = strlen(d_product_code[h_no_of_rec].arr);

  sprintf(d_unit_no[h_no_of_rec].arr,"%s", nd_unit_no.arr);
  d_unit_no[h_no_of_rec].len = strlen(d_unit_no[h_no_of_rec].arr);

  sprintf(d_blood_group[h_no_of_rec].arr,"%s", nd_blood_group.arr);
  d_blood_group[h_no_of_rec].len = strlen(d_blood_group[h_no_of_rec].arr);

  sprintf(d_rhesus_code[h_no_of_rec].arr,"%s", nd_rhesus_code.arr);
  d_rhesus_code[h_no_of_rec].len = strlen(d_rhesus_code[h_no_of_rec].arr);

  sprintf(d_rhesus_desc[h_no_of_rec].arr,"%s", nd_rhesus_desc.arr);
  d_rhesus_desc[h_no_of_rec].len = strlen(d_rhesus_desc[h_no_of_rec].arr);
*/


	strcpy(d_donor_id[h_no_of_rec].arr, nd_donor_id.arr);
	d_donor_id[h_no_of_rec].len = strlen(d_donor_id[h_no_of_rec].arr);
	
	strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
	d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);

  strcpy(d_donation_date[h_no_of_rec].arr, nd_donation_date1.arr);
  d_donation_date[h_no_of_rec].len = strlen(d_donation_date[h_no_of_rec].arr);

	strcpy(d_collection_date[h_no_of_rec].arr, nd_collection_date.arr);
	d_collection_date[h_no_of_rec].len = strlen(d_collection_date[h_no_of_rec].arr);


  strcpy(d_donor_product_code[h_no_of_rec].arr, nd_donor_product_code.arr);
  d_donor_product_code[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

  strcpy(d_donor_unit_no[h_no_of_rec].arr, nd_donor_unit_no.arr);
  d_donor_unit_no[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

  strcpy(d_product_code[h_no_of_rec].arr, nd_product_code.arr);
  d_product_code[h_no_of_rec].len = strlen(d_product_code[h_no_of_rec].arr);

  strcpy(d_unit_no[h_no_of_rec].arr, nd_unit_no.arr);
  d_unit_no[h_no_of_rec].len = strlen(d_unit_no[h_no_of_rec].arr);

  strcpy(d_blood_group[h_no_of_rec].arr, nd_blood_group.arr);
  d_blood_group[h_no_of_rec].len = strlen(d_blood_group[h_no_of_rec].arr);

  strcpy(d_blood_grp_for_disp[h_no_of_rec].arr, nd_blood_grp_for_disp.arr);/*added by sunil on 05/01/2010*/
  d_blood_grp_for_disp[h_no_of_rec].len = strlen(d_blood_grp_for_disp[h_no_of_rec].arr);/*added by sunil on 05/01/2010*/

  strcpy(d_blood_group_desc[h_no_of_rec].arr, nd_blood_group_desc.arr);/*added by sunil on 05/01/2010*/
  d_blood_group_desc[h_no_of_rec].len = strlen(d_blood_group_desc[h_no_of_rec].arr);/*added by sunil on 05/01/2010*/

  strcpy(d_rhesus_code[h_no_of_rec].arr, nd_rhesus_code.arr);
  d_rhesus_code[h_no_of_rec].len = strlen(d_rhesus_code[h_no_of_rec].arr);

  strcpy(d_rhesus_desc[h_no_of_rec].arr, nd_rhesus_desc.arr);
  d_rhesus_desc[h_no_of_rec].len = strlen(d_rhesus_desc[h_no_of_rec].arr);

	strcpy(d_center_code[h_no_of_rec].arr, nd_center_code.arr);
	d_center_code[h_no_of_rec].len = strlen(d_center_code[h_no_of_rec].arr);


EXEC SQL EXECUTE
	DECLARE
	s_date   VARCHAR2(50);
	l_date date;
	BEGIN
	l_date := to_date(:nd_expiry_date,'DD/MM/YYYY HH24:MI');

	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date);
	:nd_expiry_date1 := s_date;

	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date, 'DDMMYYYYHH24MI' );
	:nd_expiry_date2 := s_date;

	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date, 'DD Mon YYYY HH24:MI');
	:nd_expiry_date3 := s_date;

	END;
END-EXEC;

  strcpy(d_expiry_date[h_no_of_rec].arr, nd_expiry_date.arr);
  d_expiry_date[h_no_of_rec].len = strlen(d_expiry_date[h_no_of_rec].arr);

  strcpy(d_expiry_date1[h_no_of_rec].arr, nd_expiry_date1.arr);
  d_expiry_date1[h_no_of_rec].len = strlen(d_expiry_date1[h_no_of_rec].arr);

  strcpy(d_expiry_date2[h_no_of_rec].arr, nd_expiry_date2.arr);
  d_expiry_date2[h_no_of_rec].len = strlen(d_expiry_date2[h_no_of_rec].arr);

  strcpy(d_expiry_date3[h_no_of_rec].arr, nd_expiry_date3.arr);
  d_expiry_date3[h_no_of_rec].len = strlen(d_expiry_date3[h_no_of_rec].arr);

  strcpy(d_screened_legend[h_no_of_rec].arr, nd_screened_legend.arr);
  d_screened_legend[h_no_of_rec].len = strlen(d_screened_legend[h_no_of_rec].arr);

  strcpy(d_volume_units[h_no_of_rec].arr, nd_volume_units.arr);
  d_volume_units[h_no_of_rec].len = strlen(d_volume_units[h_no_of_rec].arr);

  strcpy(d_volume_unit[h_no_of_rec].arr, nd_volume_unit.arr);
  d_volume_unit[h_no_of_rec].len = strlen(d_volume_unit[h_no_of_rec].arr);

  strcpy(d_add_to_stock_yn[h_no_of_rec].arr, nd_add_to_stock_yn.arr);
  d_add_to_stock_yn[h_no_of_rec].len = strlen(d_add_to_stock_yn[h_no_of_rec].arr);

  d_volume[h_no_of_rec] = nd_volume;

  return 1;
  
}

//added for  aliquot 
int fetch_un_screenedali_cur()
{

	nd_donor_id.arr[0]='\0';
	nd_donor_id.len=0;

	nd_donation_process.arr[0]='\0';
	nd_donation_process.len=0;


	nd_center_code.arr[0]='\0';
	nd_center_code.len=0;

  nd_donation_date.arr[0] = '\0';
  nd_donation_date.len = 0;
  
  nd_collection_date.arr[0] = '\0';
  nd_collection_date.len = 0;
  
  nd_product_code.arr[0] = '\0';
  nd_product_code.len = 0;

  nd_unit_no.arr[0] = '\0';
  nd_unit_no.len = 0;

  nd_blood_group.arr[0] = '\0';
  nd_blood_group.len = 0;

  nd_blood_grp_for_disp.arr[0] = '\0'; /*added by sunil on 05/01/2010 */
  nd_blood_grp_for_disp.len = 0; /*added by sunil on 05/01/2010 */

  nd_blood_group_desc.arr[0] = '\0'; /*added by sunil on 05/01/2010 */
  nd_blood_group_desc.len = 0; /*added by sunil on 05/01/2010 */

  nd_rhesus_code.arr[0] = '\0';
  nd_rhesus_code.len = 0;

  nd_rhesus_desc.arr[0] = '\0';
  nd_rhesus_desc.len = 0;

  nd_expiry_date.arr[0] = '\0';
  nd_expiry_date.len = 0;


  nd_expiry_date1.arr[0] = '\0';
  nd_expiry_date1.len = 0;

  nd_expiry_date2.arr[0] = '\0';
  nd_expiry_date2.len = 0;

  nd_expiry_date3.arr[0] = '\0';
  nd_expiry_date3.len = 0;

  nd_screened_legend.arr[0] = '\0';
  nd_screened_legend.len = 0;


  nd_volume_units.arr[0] = '\0';
  nd_volume_units.len = 0;

  nd_volume_unit.arr[0] = '\0';
  nd_volume_unit.len = 0;

  nd_rownum_ali.arr[0] = '\0';
  nd_rownum_ali.len = 0;


	  EXEC SQL FETCH c_scr_ali INTO
                        :nd_donation_date,
						:nd_donor_id,
						:nd_donation_process,
						:nd_product_code,
                        :nd_unit_no,
                        :nd_blood_group,
						:nd_blood_grp_for_disp, /*added by sunil on 05/01/2010*/
						:nd_blood_group_desc, /*added by sunil on 05/01/2010*/
                        :nd_rhesus_code,
						:nd_rhesus_desc,
						:nd_volume,
						:nd_volume_units,
						:nd_volume_unit,
                        :nd_expiry_date,
						:nd_center_code, 
						:nd_rownum_ali;
                         
// disp_message(ERR_MESG, "s1");
    if (OERROR)
	{
//		sprintf(string_var,"%s get_facility_name()-> %s\n", d_facility_id.arr, sqlca.sqlerrm.sqlerrmc);
//		disp_message(ERR_MESG, string_var);
        ins_message (ORA_MESG, "FETCH failed c2 ");
		return 0;
      }

    if (NO_DATA_FOUND)
      return 0;

	nd_donor_id.arr[nd_donor_id.len]='\0';
	nd_donation_process.arr[nd_donation_process.len]	= '\0';

  nd_center_code.arr[nd_center_code.len] = '\0';

  nd_donation_date.arr[nd_donation_date.len] = '\0';
  nd_donation_date.len = strlen(nd_donation_date.arr);

  nd_product_code.arr[nd_product_code.len] = '\0';
  nd_product_code.len = strlen(nd_product_code.arr);

  nd_unit_no.arr[nd_unit_no.len] = '\0';
  nd_unit_no.len = strlen(nd_unit_no.arr);

  nd_blood_group.arr[nd_blood_group.len] = '\0';
  nd_blood_group.len = strlen(nd_blood_group.arr);

  nd_blood_grp_for_disp.arr[nd_blood_grp_for_disp.len] = '\0';/*added by sunil on 05/01/2010*/
  nd_blood_grp_for_disp.len = strlen(nd_blood_grp_for_disp.arr);/*added by sunil on 05/01/2010*/

  nd_blood_group_desc.arr[nd_blood_group_desc.len] = '\0';/*added by sunil on 05/01/2010*/
  nd_blood_group_desc.len = strlen(nd_blood_group_desc.arr);/*added by sunil on 05/01/2010*/

  nd_rhesus_code.arr[nd_rhesus_code.len] = '\0';
  nd_rhesus_code.len = strlen(nd_rhesus_code.arr);

  nd_rhesus_desc.arr[nd_rhesus_desc.len] = '\0';
  nd_rhesus_desc.len = strlen(nd_rhesus_desc.arr);

  nd_expiry_date.arr[nd_expiry_date.len] = '\0';
  nd_expiry_date.len = strlen(nd_expiry_date.arr);

/********** added against SRR SCF - 5675 to print the actual expiry date for aliquoted units
**************/

  get_expiry_for_ali_cur();

  nd_expiry_date1.arr[nd_expiry_date1.len] = '\0';
  nd_expiry_date1.len = strlen(nd_expiry_date1.arr);

  nd_expiry_date2.arr[nd_expiry_date2.len] = '\0';
  nd_expiry_date2.len = strlen(nd_expiry_date2.arr);

  nd_expiry_date3.arr[nd_expiry_date3.len] = '\0';
  nd_expiry_date3.len = strlen(nd_expiry_date3.arr);

  nd_screened_legend.arr[nd_screened_legend.len] = '\0';
  nd_screened_legend.len = strlen(nd_screened_legend.arr);

  nd_rownum_ali.arr[nd_rownum_ali.len] = '\0';
  nd_rownum_ali.len = strlen(nd_rownum_ali.arr);

  nd_volume_units.arr[nd_volume_units.len] = '\0';
  nd_volume_units.len = strlen(nd_volume_units.arr);

  nd_volume_unit.arr[nd_volume_unit.len] = '\0';
  nd_volume_unit.len = strlen(nd_volume_unit.arr);

  if (strlen(nd_donation_date.arr) >0)
  {
	EXEC SQL EXECUTE
		DECLARE
			t_date   VARCHAR2(50);
			l_date   DATE;
		BEGIN

			l_date := to_date(:nd_donation_date,'DD/MM/YYYY');

			GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE 
					(l_date, :language_id , t_date);

			:nd_donation_date := t_date;

			GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE 
					(l_date, :language_id , t_date,'DD Mon YYYY');

			:nd_collection_date := t_date;
		END;
	END-EXEC;

  nd_collection_date.arr[nd_collection_date.len] = '\0';
  nd_collection_date.len = strlen(nd_collection_date.arr);


	strcpy (d_donation_date[h_no_of_rec].arr, nd_donation_date.arr);
	d_donation_date[h_no_of_rec].len = strlen(d_donation_date[h_no_of_rec].arr);

	strcpy(d_collection_date[h_no_of_rec].arr, nd_collection_date.arr);
	d_collection_date[h_no_of_rec].len = strlen(d_collection_date[h_no_of_rec].arr);

	strcpy(d_donor_id[h_no_of_rec].arr, nd_donor_id.arr);
	d_donor_id[h_no_of_rec].len = strlen(d_donor_id[h_no_of_rec].arr);
	
	strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
	d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);

	strcpy (d_donor_product_code[h_no_of_rec].arr, nd_donor_product_code.arr);
	d_donor_product_code[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

	strcpy(d_donor_unit_no[h_no_of_rec].arr, nd_donor_unit_no.arr);
	d_donor_unit_no[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

	strcpy (d_product_code[h_no_of_rec].arr, nd_product_code.arr);
	d_product_code[h_no_of_rec].len = strlen(d_product_code[h_no_of_rec].arr);

	strcpy(d_unit_no[h_no_of_rec].arr, nd_unit_no.arr);
	d_unit_no[h_no_of_rec].len = strlen(d_unit_no[h_no_of_rec].arr);

	strcpy (d_blood_group[h_no_of_rec].arr, nd_blood_group.arr);
	d_blood_group[h_no_of_rec].len = strlen(d_blood_group[h_no_of_rec].arr);

	strcpy(d_blood_grp_for_disp[h_no_of_rec].arr, nd_blood_grp_for_disp.arr);/*added by sunil on 05/01/2010*/
	d_blood_grp_for_disp[h_no_of_rec].len = strlen(d_blood_grp_for_disp[h_no_of_rec].arr);/*added by sunil on 05/01/2010*/

	strcpy(d_blood_group_desc[h_no_of_rec].arr, nd_blood_group_desc.arr);/*added by sunil on 05/01/2010*/
	d_blood_group_desc[h_no_of_rec].len = strlen(d_blood_group_desc[h_no_of_rec].arr);/*added by sunil on 05/01/2010*/

	strcpy(d_rhesus_code[h_no_of_rec].arr, nd_rhesus_code.arr);
	d_rhesus_code[h_no_of_rec].len = strlen(d_rhesus_code[h_no_of_rec].arr);

	strcpy(d_rhesus_desc[h_no_of_rec].arr, nd_rhesus_desc.arr);
	d_rhesus_desc[h_no_of_rec].len = strlen(d_rhesus_desc[h_no_of_rec].arr);

	strcpy(d_center_code[h_no_of_rec].arr, nd_center_code.arr);
	d_center_code[h_no_of_rec].len = strlen(d_center_code[h_no_of_rec].arr);


	EXEC SQL EXECUTE
	DECLARE
		s_date   VARCHAR2(50);
		l_date date;
	BEGIN
		l_date := to_date(:nd_expiry_date,'DD/MM/YYYY HH24:MI');

		GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date);
		:nd_expiry_date1 := s_date;

		GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date, 'DDMMYYYYHH24MI');
		:nd_expiry_date2 := s_date;

		GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date, 'DD Mon YYYY HH24:MI');
		:nd_expiry_date3 := s_date;
	END;
	END-EXEC;

	strcpy(d_expiry_date[h_no_of_rec].arr, nd_expiry_date.arr);
	d_expiry_date[h_no_of_rec].len = strlen(d_expiry_date[h_no_of_rec].arr);

	strcpy (d_expiry_date1[h_no_of_rec].arr, nd_expiry_date1.arr);
	d_expiry_date1[h_no_of_rec].len = strlen(d_expiry_date1[h_no_of_rec].arr);

	strcpy (d_expiry_date2[h_no_of_rec].arr, nd_expiry_date2.arr);
	d_expiry_date2[h_no_of_rec].len = strlen(d_expiry_date2[h_no_of_rec].arr);

	strcpy (d_expiry_date3[h_no_of_rec].arr, nd_expiry_date3.arr);
	d_expiry_date3[h_no_of_rec].len = strlen(d_expiry_date3[h_no_of_rec].arr);

	strcpy (d_screened_legend[h_no_of_rec].arr, nd_screened_legend.arr);
	d_screened_legend[h_no_of_rec].len = strlen(d_screened_legend[h_no_of_rec].arr);

	strcpy (d_volume_units[h_no_of_rec].arr, nd_volume_units.arr);
	d_volume_units[h_no_of_rec].len = strlen(d_volume_units[h_no_of_rec].arr);

	strcpy (d_volume_unit[h_no_of_rec].arr, nd_volume_unit.arr);
	d_volume_unit[h_no_of_rec].len = strlen(d_volume_unit[h_no_of_rec].arr);

	strcpy (d_rownum_ali[h_no_of_rec].arr, nd_rownum_ali.arr);
	d_rownum_ali[h_no_of_rec].len = strlen(d_rownum_ali[h_no_of_rec].arr);

	  d_volume[h_no_of_rec] = nd_volume;

  }

  return 1;
  
}

//ADDED FOR SCREENED LABEL
int fetch_screened_cur()
{

	nd_donor_id.arr[0]='\0';
	nd_donor_id.len=0;

	nd_donation_process.arr[0]='\0';
	nd_donation_process.len=0;

	nd_center_code.arr[0]='\0';
	nd_center_code.len=0;

  nd_donation_date.arr[0] = '\0';
  nd_donation_date.len = 0;

  nd_collection_date.arr[0] = '\0';
  nd_collection_date.len = 0;
  
  nd_donor_product_code.arr[0] = '\0';
  nd_donor_product_code.len = 0;

  nd_donor_unit_no.arr[0] = '\0';
  nd_donor_unit_no.len = 0;

  nd_product_code.arr[0] = '\0';
  nd_product_code.len = 0;

  nd_unit_no.arr[0] = '\0';
  nd_unit_no.len = 0;

  nd_blood_group.arr[0] = '\0';
  nd_blood_group.len = 0;

  nd_blood_grp_for_disp.arr[0] = '\0'; /*added by sunil on 05/01/2010 */
  nd_blood_grp_for_disp.len = 0; /*added by sunil on 05/01/2010 */

  nd_blood_group_desc.arr[0] = '\0'; /*added by sunil on 05/01/2010 */
  nd_blood_group_desc.len = 0; /*added by sunil on 05/01/2010 */

  nd_rhesus_code.arr[0] = '\0';
  nd_rhesus_code.len = 0;

  nd_rhesus_desc.arr[0] = '\0';
  nd_rhesus_desc.len = 0;

  nd_expiry_date.arr[0] = '\0';
  nd_expiry_date.len = 0;

  nd_expiry_date1.arr[0] = '\0';
  nd_expiry_date1.len = 0;

  nd_expiry_date2.arr[0] = '\0';
  nd_expiry_date2.len = 0;

  nd_expiry_date3.arr[0] = '\0';
  nd_expiry_date3.len = 0;

  nd_screened_legend.arr[0] = '\0';
  nd_screened_legend.len = 0;

  nd_volume_units.arr[0] = '\0';
  nd_volume_units.len = 0;

  nd_volume_unit.arr[0] = '\0';
  nd_volume_unit.len = 0;

      
	  EXEC SQL FETCH c_screen INTO
						:nd_donation_date,
						:nd_donor_id,
						:nd_donation_process, 
                        :nd_product_code,
                        :nd_unit_no,
                        :nd_blood_group,
						:nd_blood_grp_for_disp, /*added by sunil on 05/01/2010*/
						:nd_blood_group_desc, /*added by sunil on 05/01/2010*/
                        :nd_rhesus_code,
						:nd_rhesus_desc,
						:nd_volume,
						:nd_volume_units,
						:nd_volume_unit,
                        :nd_expiry_date,
						:nd_center_code;
                         
// disp_message(ERR_MESG, "s1");
    if (OERROR)
	{
//		sprintf(string_var,"%s get_facility_name()-> %s\n", d_facility_id.arr, sqlca.sqlerrm.sqlerrmc);
//		disp_message(ERR_MESG, string_var);
        ins_message (ORA_MESG, "FETCH failed c2 ");
		return 0;
      }

//sprintf(string_var, "Info  1   %s", nd_donation_process.arr);
//disp_message(ERR_MESG, string_var);

    if (NO_DATA_FOUND)
      return 0;

	nd_donor_id.arr[nd_donor_id.len]='\0';
	nd_donation_process.arr[nd_donation_process.len]	= '\0';

	nd_center_code.arr[nd_center_code.len] = '\0';

  nd_donation_date.arr[nd_donation_date.len] = '\0';
  nd_donation_date.len = strlen(nd_donation_date.arr);

  nd_donor_product_code.arr[nd_donor_product_code.len] = '\0';
  nd_donor_product_code.len = strlen(nd_donor_product_code.arr);

  nd_donor_unit_no.arr[nd_donor_unit_no.len] = '\0';
  nd_donor_unit_no.len = strlen(nd_donor_product_code.arr);

  nd_product_code.arr[nd_product_code.len] = '\0';
  nd_product_code.len = strlen(nd_product_code.arr);

  nd_unit_no.arr[nd_unit_no.len] = '\0';
  nd_unit_no.len = strlen(nd_unit_no.arr);

  nd_blood_group.arr[nd_blood_group.len] = '\0';
  nd_blood_group.len = strlen(nd_blood_group.arr);

  nd_blood_grp_for_disp.arr[nd_blood_grp_for_disp.len] = '\0';/*added by sunil on 05/01/2010*/
  nd_blood_grp_for_disp.len = strlen(nd_blood_grp_for_disp.arr);/*added by sunil on 05/01/2010*/

  nd_blood_group_desc.arr[nd_blood_group_desc.len] = '\0';/*added by sunil on 05/01/2010*/
  nd_blood_group_desc.len = strlen(nd_blood_group_desc.arr);/*added by sunil on 05/01/2010*/

  nd_rhesus_code.arr[nd_rhesus_code.len] = '\0';
  nd_rhesus_code.len = strlen(nd_rhesus_code.arr);

  nd_rhesus_desc.arr[nd_rhesus_desc.len] = '\0';
  nd_rhesus_desc.len = strlen(nd_rhesus_desc.arr);

  nd_expiry_date.arr[nd_expiry_date.len] = '\0';
  nd_expiry_date.len = strlen(nd_expiry_date.arr);

  nd_expiry_date1.arr[nd_expiry_date1.len] = '\0';
  nd_expiry_date1.len = strlen(nd_expiry_date1.arr);

  nd_expiry_date2.arr[nd_expiry_date2.len] = '\0';
  nd_expiry_date2.len = strlen(nd_expiry_date2.arr);
 
  nd_expiry_date3.arr[nd_expiry_date3.len] = '\0';
  nd_expiry_date3.len = strlen(nd_expiry_date3.arr);

  nd_screened_legend.arr[nd_screened_legend.len] = '\0';
  nd_screened_legend.len = strlen(nd_screened_legend.arr);

  nd_volume_units.arr[nd_volume_units.len] = '\0';
  nd_volume_units.len = strlen(nd_volume_units.arr);

  nd_volume_unit.arr[nd_volume_unit.len] = '\0';
  nd_volume_unit.len = strlen(nd_volume_unit.arr);

EXEC SQL EXECUTE
	DECLARE
		t_date   VARCHAR2(50);
		l_date	 DATE;
	BEGIN
		l_date := to_date(:nd_donation_date,'DD/MM/YYYY');

	GET_LOCALE_DATE_2t.CONVERT_TO_LOCALE_DATE (l_date, :language_id , t_date);
	:nd_donation_date := t_date;

	GET_LOCALE_DATE_2t.CONVERT_TO_LOCALE_DATE (l_date, :language_id , t_date, 'DD Mon YYYY');
	:nd_collection_date := t_date;
	END;
END-EXEC;

  nd_collection_date.arr[nd_collection_date.len] = '\0';
  nd_collection_date.len = strlen(nd_collection_date.arr);


	strcpy(d_center_code[h_no_of_rec].arr, nd_center_code.arr);
	d_center_code[h_no_of_rec].len = strlen(d_center_code[h_no_of_rec].arr);

  strcpy (d_donation_date[h_no_of_rec].arr, nd_donation_date.arr);
  d_donation_date[h_no_of_rec].len = strlen(d_donation_date[h_no_of_rec].arr);

	strcpy(d_collection_date[h_no_of_rec].arr, nd_collection_date.arr);
	d_collection_date[h_no_of_rec].len = strlen(d_collection_date[h_no_of_rec].arr);

	strcpy(d_donor_id[h_no_of_rec].arr, nd_donor_id.arr);
	d_donor_id[h_no_of_rec].len = strlen(d_donor_id[h_no_of_rec].arr);
	
	strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
	d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);


  strcpy (d_donor_product_code[h_no_of_rec].arr, nd_donor_product_code.arr);
  d_donor_product_code[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

  strcpy(d_donor_unit_no[h_no_of_rec].arr, nd_donor_unit_no.arr);
  d_donor_unit_no[h_no_of_rec].len = strlen(d_donor_product_code[h_no_of_rec].arr);

  strcpy(d_product_code[h_no_of_rec].arr, nd_product_code.arr);
  d_product_code[h_no_of_rec].len = strlen(d_product_code[h_no_of_rec].arr);

  strcpy(d_unit_no[h_no_of_rec].arr, nd_unit_no.arr);
  d_unit_no[h_no_of_rec].len = strlen(d_unit_no[h_no_of_rec].arr);

  strcpy(d_blood_group[h_no_of_rec].arr, nd_blood_group.arr);
  d_blood_group[h_no_of_rec].len = strlen(d_blood_group[h_no_of_rec].arr);

  strcpy(d_blood_grp_for_disp[h_no_of_rec].arr, nd_blood_grp_for_disp.arr);/*added by sunil on 05/01/2010*/
  d_blood_grp_for_disp[h_no_of_rec].len = strlen(d_blood_grp_for_disp[h_no_of_rec].arr);/*added by sunil on 05/01/2010*/

  strcpy(d_blood_group_desc[h_no_of_rec].arr, nd_blood_group_desc.arr);/*added by sunil on 05/01/2010*/
  d_blood_group_desc[h_no_of_rec].len = strlen(d_blood_group_desc[h_no_of_rec].arr);/*added by sunil on 05/01/2010*/

  strcpy(d_rhesus_code[h_no_of_rec].arr, nd_rhesus_code.arr);
  d_rhesus_code[h_no_of_rec].len = strlen(d_rhesus_code[h_no_of_rec].arr);

  strcpy(d_rhesus_desc[h_no_of_rec].arr, nd_rhesus_desc.arr);
  d_rhesus_desc[h_no_of_rec].len = strlen(d_rhesus_desc[h_no_of_rec].arr);

EXEC SQL EXECUTE
	DECLARE
	s_date   VARCHAR2(50);
	l_date	 date;
	BEGIN
	l_date :=to_date(:nd_expiry_date,'DD/MM/YYYY HH24:MI'); 

	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date);
	:nd_expiry_date1 := s_date;
	
	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date, 'DDMMYYYYHH24MI');
	:nd_expiry_date2 := s_date;

	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (l_date, :language_id , s_date, 'DD Mon YYYY HH24:MI');
	:nd_expiry_date3 := s_date;
	END;
END-EXEC;

  strcpy(d_expiry_date[h_no_of_rec].arr, nd_expiry_date.arr);
  d_expiry_date[h_no_of_rec].len = strlen(d_expiry_date[h_no_of_rec].arr);

  strcpy(d_expiry_date1[h_no_of_rec].arr, nd_expiry_date1.arr);
  d_expiry_date1[h_no_of_rec].len = strlen(d_expiry_date1[h_no_of_rec].arr);

  strcpy(d_expiry_date2[h_no_of_rec].arr, nd_expiry_date2.arr);
  d_expiry_date2[h_no_of_rec].len = strlen(d_expiry_date2[h_no_of_rec].arr);

  strcpy(d_expiry_date3[h_no_of_rec].arr, nd_expiry_date3.arr);
  d_expiry_date3[h_no_of_rec].len = strlen(d_expiry_date3[h_no_of_rec].arr);

  strcpy(d_screened_legend[h_no_of_rec].arr, nd_screened_legend.arr);
  d_screened_legend[h_no_of_rec].len = strlen(d_screened_legend[h_no_of_rec].arr);

  strcpy(d_volume_units[h_no_of_rec].arr, nd_volume_units.arr);
  d_volume_units[h_no_of_rec].len = strlen(d_volume_units[h_no_of_rec].arr);

  strcpy(d_volume_unit[h_no_of_rec].arr, nd_volume_unit.arr);
  d_volume_unit[h_no_of_rec].len = strlen(d_volume_unit[h_no_of_rec].arr);

  d_volume[h_no_of_rec] = nd_volume;

  return 1;
  
}

get_facility_name()
{
	d_facility_name.arr[0]		= '\0';
	d_facility_name.len		= 0;

	EXEC SQL  SELECT facility_name
	            INTO :d_facility_name
	            FROM sm_facility_param_lang_vw
               WHERE facility_id = :d_facility_id
	       and language_id=:language_id;

	if(OERROR)
	{
		sprintf(string_var,"%s get_facility_name()-> %s\n", d_facility_id.arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

	d_facility_name.arr[d_facility_name.len]   = '\0';
	d_facility_name.len = strlen(d_facility_name.arr);

    if(NO_DATA_FOUND)
    {
      d_facility_name.arr[d_facility_name.len]   = '\0';
      d_facility_name.len = strlen(d_facility_name.arr);
    }
}

/*js*/
get_antigen_name()
{
	d_antigen_desc.arr[0]		= '\0';
	d_antigen_desc.len		= 0;

	d_antigen_desc2.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc2.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc3.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc3.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc4.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc4.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc5.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc5.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc6.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc6.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc7.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc7.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc8.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc8.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc9.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc9.len		= 0;// added by sunil on 05/01/2010
	d_antigen_desc10.arr[0]		= '\0';// added by sunil on 05/01/2010
	d_antigen_desc10.len		= 0;// added by sunil on 05/01/2010

	d_antigen_date.arr[0]		= '\0';
	d_antigen_date.len		= 0;

	EXEC SQL EXECUTE
		DECLARE
	 		CURSOR c1 is SELECT DISTINCT b.short_desc ANTIGEN_DESC, a.last_reported_date //changed from long_desc to chort_desc by sunil on 05/01/2010
					FROM BT_DONOR_ANTIGEN A, BT_ANTIGEN_CODE_MAST_LANG_VW B  
					WHERE A.antigen_code = B.antigen_code
					AND A.unit_no = :d_fm_unit_no 
					AND A.product_code = :d_fm_product_code
					AND A.operating_facility_id = :d_facility_id
					AND B.language_id = :language_id
					ORDER BY A.last_reported_date DESC;

			l_cnt	NUMBER:=0;

		BEGIN
/*			For r1 in c1 Loop
				:d_antigen_desc := r1.ANTIGEN_DESC;
				Exit;
			End Loop;
	commented on 05/01/2010 and below for loop added for multiple antigens by sunil
*/
			For r1 in c1 Loop
				IF l_cnt = 0 THEN
					:d_antigen_desc := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 1 THEN
					:d_antigen_desc2 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 2 THEN
					:d_antigen_desc3 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 3 THEN
					:d_antigen_desc4 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 4 THEN
					:d_antigen_desc5 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 5 THEN
					:d_antigen_desc6 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 6 THEN
					:d_antigen_desc7 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 7 THEN
					:d_antigen_desc8 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 8 THEN
					:d_antigen_desc9 := r1.ANTIGEN_DESC;
					l_cnt := l_cnt + 1;
				ELSIF l_cnt = 9 THEN
					:d_antigen_desc10 := '**';
					l_cnt := l_cnt + 1;
					EXIT;
				END IF;
			End Loop;
		END;
	END-EXEC;

	if(OERROR)
	{
		sprintf(string_var,"%s fetch_un_screened_cur()-> %s\n", d_fm_unit_no.arr, sqlca.sqlerrm.sqlerrmc);
	}

    if(NO_DATA_FOUND)
    {
      d_antigen_desc.arr[d_antigen_desc.len]   = '\0';
      d_antigen_desc.len = strlen(d_antigen_desc.arr);
      d_antigen_date.arr[d_antigen_date.len]   = '\0';
      d_antigen_date.len = strlen(d_antigen_date.arr);
    }

    d_antigen_desc.arr[d_antigen_desc.len]   = '\0';
    d_antigen_desc.len = strlen(d_antigen_desc.arr);

    d_antigen_desc2.arr[d_antigen_desc2.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc2.len = strlen(d_antigen_desc2.arr);// added by sunil on 05/01/2010

    d_antigen_desc3.arr[d_antigen_desc3.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc3.len = strlen(d_antigen_desc3.arr);// added by sunil on 05/01/2010

    d_antigen_desc4.arr[d_antigen_desc4.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc4.len = strlen(d_antigen_desc4.arr);// added by sunil on 05/01/2010

    d_antigen_desc5.arr[d_antigen_desc5.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc5.len = strlen(d_antigen_desc5.arr);// added by sunil on 05/01/2010

    d_antigen_desc6.arr[d_antigen_desc6.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc6.len = strlen(d_antigen_desc6.arr);// added by sunil on 05/01/2010

    d_antigen_desc7.arr[d_antigen_desc7.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc7.len = strlen(d_antigen_desc7.arr);// added by sunil on 05/01/2010

    d_antigen_desc8.arr[d_antigen_desc8.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc8.len = strlen(d_antigen_desc8.arr);// added by sunil on 05/01/2010

    d_antigen_desc9.arr[d_antigen_desc9.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc9.len = strlen(d_antigen_desc9.arr);// added by sunil on 05/01/2010

    d_antigen_desc10.arr[d_antigen_desc10.len]   = '\0';// added by sunil on 05/01/2010
    d_antigen_desc10.len = strlen(d_antigen_desc10.arr);// added by sunil on 05/01/2010

    d_antigen_date.arr[d_antigen_date.len]   = '\0';
    d_antigen_date.len = strlen(d_antigen_date.arr);
}

get_graph_barcode()
{

	nd_bld_grp_rh_barcode.arr[0]='\0';
	nd_bld_grp_rh_barcode.len=0;


	EXEC SQL	SELECT BLOOD_GRP_RH_BARCODE_CODE 
			INTO :nd_bld_grp_rh_barcode
			FROM BT_BLOOD_GRP_RH_BARCODE  
			WHERE 	BLOOD_GROUP=:d_blood_group[h_no_of_rec]
			AND RHESUS_CODE=:d_rhesus_code[h_no_of_rec];

	nd_bld_grp_rh_barcode.arr[nd_bld_grp_rh_barcode.len]='\0';



  strcpy(d_bld_grp_rh_barcode[h_no_of_rec].arr, nd_bld_grp_rh_barcode.arr);
  d_bld_grp_rh_barcode[h_no_of_rec].len = strlen(d_bld_grp_rh_barcode[h_no_of_rec].arr);



if(OERROR)
	{
		sprintf(string_var,"%s and %s and %s  get_graph_barcode-> %s\n", d_product_code[h_no_of_rec].arr,d_blood_group[h_no_of_rec].arr,d_rhesus_code[h_no_of_rec].arr,sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}
}


get_center_code()
 {

	nd_center_desc.arr[0]='\0'; // added by sunil
	nd_center_desc.len=0;  // added by sunil


/*below if condition added by sunil on 27-08-2008 against CRF */
		EXEC SQL SELECT b.desc_on_label
			into :nd_center_desc
			FROM BT_COLLECTION_CENTRE_LANG_VW b
			WHERE b.centre_code = :nd_center_code
			and b.LANGUAGE_ID= :language_id;

	nd_center_desc.arr[nd_center_desc.len] = '\0';

	
	strcpy(d_center_desc[h_no_of_rec].arr, nd_center_desc.arr);
	d_center_desc[h_no_of_rec].len = strlen(d_center_desc[h_no_of_rec].arr);

	if(OERROR)
	{
		sprintf(string_var,"%s get_center_code-> %s\n", d_unit_no[h_no_of_rec].arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

 }

get_label_gen_yn()
 {
	nd_unit_no_gen_yn.arr[0] = '\0';
	nd_unit_no_gen_yn.len = 0;


		EXEC SQL 
			SELECT 'C' into :nd_unit_no_gen_yn
			FROM BT_Collection_Centre b
			where b.CENTRE_CODE = :nd_center_code
			and nvl(UNIT_NO_GEN_YN,'N') = 'Y';

		if(NO_DATA_FOUND)
		{
			EXEC SQL 
			SELECT 'P' into :nd_unit_no_gen_yn
			FROM bt_product_mast
			where PRODUCT_CODE = :d_fm_product_code
			and nvl(UNIT_NO_GEN_YN,'N') = 'Y';
		}
	

		if(NO_DATA_FOUND);

	nd_unit_no_gen_yn.arr[nd_unit_no_gen_yn.len] = '\0';

	strcpy(d_unit_no_gen_yn[h_no_of_rec].arr, nd_unit_no_gen_yn.arr);
	d_unit_no_gen_yn[h_no_of_rec].len = strlen(d_unit_no_gen_yn[h_no_of_rec].arr);

	if(OERROR)
	{
		sprintf(string_var,"%s get_center_code-> %s\n", d_unit_no[h_no_of_rec].arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

 }

get_unit_no()
 {

	nd_unit_no_split.arr[0] = '\0';
	nd_unit_no_split.len = 0;

	nd_unit_no_split1.arr[0] = '\0';
	nd_unit_no_split1.len = 0;

	nd_unit_no_split2.arr[0] = '\0';
	nd_unit_no_split2.len = 0;

	nd_unit_no_seq.arr[0] = '\0';
	nd_unit_no_seq.len = 0;


//sprintf(string_var,"%s",d_unit_no_gen_yn[h_no_of_rec].arr);
//disp_message(ERR_MESG, string_var); 

	if(strcmp(d_unit_no_gen_yn[h_no_of_rec].arr,"C") == 0) 
	{
		if ((strcmp(a_pgm_id.arr,"BTRSCRLB") == 0) && (strcmp(d_add_to_stock_yn[h_no_of_rec].arr,"N") == 0)) /* if condition added by sunil on 13-aug-2008*/
		{
			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,length(b.UNIT_NO_PREFIX))||Substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+3)) ,
			'00' ,
			substr(:d_unit_no[h_no_of_rec],1,length(b.UNIT_NO_PREFIX))||Substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+1,2),
			substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+3)
				into :nd_unit_no_split, :nd_unit_no_seq, :nd_unit_no_split1, :nd_unit_no_split2
				FROM BT_COLLECTION_CENTRE b
				where b.CENTRE_CODE = :d_center_code[h_no_of_rec];

			if(NO_DATA_FOUND)
			{
				EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8)),  
				'00',
				substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
				substr(:d_unit_no[h_no_of_rec],8)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}
		} 
		else if (strcmp(a_pgm_id.arr,"BTRALILB") == 0)
		{
			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,length(b.UNIT_NO_PREFIX))||substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+3))  ,
				lpad(substr(:d_unit_no[h_no_of_rec],instr(:d_unit_no[h_no_of_rec],'-')+1),2,'0'),
				substr(:d_unit_no[h_no_of_rec],1,length(b.UNIT_NO_PREFIX))||Substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+1,2),
				substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+3)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM BT_BLOOD_UNITS_MAST a, BT_COLLECTION_CENTRE b
				WHERE a.CENTRE_CODE = b.CENTRE_CODE
				and a.UNIT_NO=:d_unit_no[h_no_of_rec]
				and a.product_code=:d_product_code[h_no_of_rec]
				AND a.operating_facility_id = :d_facility_id;

			if(NO_DATA_FOUND)
			{
				EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8)) , 
				lpad(:d_rownum_ali[h_no_of_rec],2,'0'),
				substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
				substr(:d_unit_no[h_no_of_rec],8)
				into :nd_unit_no_split, :nd_unit_no_seq,
					:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}
		}
		else if (strcmp(a_pgm_id.arr,"BTRUNTLB") == 0)
		{
			EXEC SQL SELECT (substr(:d_fm_unit_no,1,length(b.UNIT_NO_PREFIX))||substr(:d_fm_unit_no,length(b.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_fm_unit_no,length(b.UNIT_NO_PREFIX)+3))  ,
				'00',
					substr(:d_fm_unit_no,1,length(b.UNIT_NO_PREFIX))||Substr(:d_fm_unit_no,length(b.UNIT_NO_PREFIX)+1,2),
					substr(:d_fm_unit_no,length(b.UNIT_NO_PREFIX)+3)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM BT_COLLECTION_CENTRE b
				where b.CENTRE_CODE = :d_center_code[h_no_of_rec];


			if(NO_DATA_FOUND)
			{
				EXEC SQL SELECT (substr(:d_fm_unit_no,1,5)||substr(:d_fm_unit_no,6,2)||' '||substr(:d_fm_unit_no,8)) , 
				'00',
				substr(:d_fm_unit_no,1,5)||substr(:d_fm_unit_no,6,2),
				substr(:d_fm_unit_no,8)				
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}
		}
		else
		{


			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,length(b.UNIT_NO_PREFIX))||substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+3))  ,
				'00',
				substr(:d_unit_no[h_no_of_rec],1,length(b.UNIT_NO_PREFIX))||Substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+1,2),
				substr(:d_unit_no[h_no_of_rec],length(b.UNIT_NO_PREFIX)+3)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM BT_BLOOD_UNITS_MAST a, BT_COLLECTION_CENTRE b
				WHERE a.CENTRE_CODE = b.CENTRE_CODE
				and a.UNIT_NO=:d_unit_no[h_no_of_rec]
				and a.product_code=:d_product_code[h_no_of_rec]
				AND a.operating_facility_id = :d_facility_id;

			if(NO_DATA_FOUND)
			{

				EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8))  ,
				'00',
				substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
				substr(:d_unit_no[h_no_of_rec],8)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}
		}
	}
	else if (strcmp(d_unit_no_gen_yn[h_no_of_rec].arr,"P") == 0)  
	{
		if (strcmp(a_pgm_id.arr,"BTRALILB") == 0)
		{
			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,length(a.UNIT_NO_PREFIX))||substr(:d_unit_no[h_no_of_rec],length(a.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_unit_no[h_no_of_rec],length(a.UNIT_NO_PREFIX)+3))  ,
			lpad(substr(:d_unit_no[h_no_of_rec],instr(:d_unit_no[h_no_of_rec],'-')+1),2,'0'),
			substr(:d_unit_no[h_no_of_rec],1,length(a.UNIT_NO_PREFIX))||substr(:d_unit_no[h_no_of_rec],length(a.UNIT_NO_PREFIX)+1,2),
			substr(:d_unit_no[h_no_of_rec],length(a.UNIT_NO_PREFIX)+3)
			into :nd_unit_no_split, :nd_unit_no_seq,
				:nd_unit_no_split1, :nd_unit_no_split2
			FROM BT_PRODUCT_MAST a
			WHERE a.product_code=:d_fm_product_code;

			if(NO_DATA_FOUND)
			{
				EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8))  ,
				lpad(:d_rownum_ali[h_no_of_rec]+1,2,'0'),
				substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
				substr(:d_unit_no[h_no_of_rec],8)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}

		}
		else if (strcmp(a_pgm_id.arr,"BTRUNTLB") == 0)
		{
			EXEC SQL SELECT (substr(:d_fm_unit_no,1,length(a.UNIT_NO_PREFIX))||substr(:d_fm_unit_no,length(a.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_fm_unit_no,length(a.UNIT_NO_PREFIX)+3))  ,
			'00',
			substr(:d_fm_unit_no,1,length(a.UNIT_NO_PREFIX))||substr(:d_fm_unit_no,length(a.UNIT_NO_PREFIX)+1,2),
			substr(:d_fm_unit_no,length(a.UNIT_NO_PREFIX)+3)
			into :nd_unit_no_split, :nd_unit_no_seq,
				:nd_unit_no_split1, :nd_unit_no_split2
			FROM BT_PRODUCT_MAST a
			WHERE a.product_code=:d_fm_product_code;

			if(NO_DATA_FOUND)
			{
				EXEC SQL SELECT (substr(:d_fm_unit_no,1,5)||substr(:d_fm_unit_no,6,2)||' '||substr(:d_fm_unit_no,8)) ,
				'00',
				substr(:d_fm_unit_no,1,5)||substr(:d_fm_unit_no,6,2),
				substr(:d_fm_unit_no,8)				
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}
		}
		else
		{
			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,length(a.UNIT_NO_PREFIX))||substr(:d_unit_no[h_no_of_rec],length(a.UNIT_NO_PREFIX)+1,2)||' '||substr(:d_unit_no[h_no_of_rec],length(a.UNIT_NO_PREFIX)+3))  ,
			'00',
				substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
				substr(:d_unit_no[h_no_of_rec],8)
			into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
			FROM BT_PRODUCT_MAST a
			WHERE a.product_code=:d_fm_product_code;

			if(NO_DATA_FOUND)
			{
				EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8)) ,
				'00',
				substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
				substr(:d_unit_no[h_no_of_rec],8)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM dual;
			}
		}
	}

	else
	{
//disp_message(ERR_MESG, a_pgm_id.arr);
		if (strcmp(a_pgm_id.arr,"BTRALILB") == 0)
		{	
			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8))  ,
			lpad(substr(:d_unit_no[h_no_of_rec],instr(:d_unit_no[h_no_of_rec],'-')+1),2,'0'),
//			lpad(:d_rownum_ali[h_no_of_rec],2,'0'),
			substr(:d_unit_no[h_no_of_rec],1, 5)||substr(:d_unit_no[h_no_of_rec],6,2),
			substr(:d_unit_no[h_no_of_rec],8)
			into :nd_unit_no_split, :nd_unit_no_seq,
					:nd_unit_no_split1, :nd_unit_no_split2
			FROM dual;
		}
		else if (strcmp(a_pgm_id.arr,"BTRUNTLB") == 0)
		{

			EXEC SQL SELECT (substr(:d_fm_unit_no,1,5)||substr(:d_fm_unit_no,6,2)||' '||substr(:d_fm_unit_no,8))  ,
				'00',
					substr(:d_fm_unit_no,1,5)||Substr(:d_fm_unit_no,6,2),
					substr(:d_fm_unit_no,8)
				into :nd_unit_no_split, :nd_unit_no_seq,
						:nd_unit_no_split1, :nd_unit_no_split2
				FROM DUAL;
				
		}
		else
		{	
			EXEC SQL SELECT (substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2)||' '||substr(:d_unit_no[h_no_of_rec],8))  ,
			'00',
			substr(:d_unit_no[h_no_of_rec],1,5)||substr(:d_unit_no[h_no_of_rec],6,2),
			substr(:d_unit_no[h_no_of_rec],8)
			into :nd_unit_no_split, :nd_unit_no_seq,
					:nd_unit_no_split1, :nd_unit_no_split2
			FROM dual;
		}
	}

	nd_unit_no_split.arr[nd_unit_no_split.len]	= '\0';
	nd_unit_no_split1.arr[nd_unit_no_split1.len]	= '\0';
	nd_unit_no_split2.arr[nd_unit_no_split2.len]	= '\0';
	nd_unit_no_seq.arr[nd_unit_no_seq.len]		= '\0';

//sprintf(string_var, "Split value  %s", nd_unit_no_split.arr);
//disp_message(ERR_MESG, string_var);

	strcpy(d_unit_no_split[h_no_of_rec].arr, nd_unit_no_split.arr);
	d_unit_no_split[h_no_of_rec].len = strlen(d_unit_no_split[h_no_of_rec].arr);

	strcpy(d_unit_no_split1[h_no_of_rec].arr, nd_unit_no_split1.arr);
	d_unit_no_split1[h_no_of_rec].len = strlen(d_unit_no_split1[h_no_of_rec].arr);

	strcpy(d_unit_no_split2[h_no_of_rec].arr, nd_unit_no_split2.arr);
	d_unit_no_split2[h_no_of_rec].len = strlen(d_unit_no_split2[h_no_of_rec].arr);

	strcpy(d_unit_no_seq[h_no_of_rec].arr, nd_unit_no_seq.arr);
	d_unit_no_seq[h_no_of_rec].len = strlen(d_unit_no_seq[h_no_of_rec].arr);

	if(OERROR)
	{
		sprintf(string_var,"%s get_center_code-> %s\n", d_unit_no[h_no_of_rec].arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

 }

 get_donation_details_bd()
  {

	nd_donation_process.arr[0]='\0';
	nd_donation_process.len=0;

//sprintf(string_var, "Info  3   %s   %d", d_donation_process[h_no_of_rec].arr, h_no_of_rec);
//disp_message(ERR_MESG, string_var);

		EXEC SQL 	 SELECT NVL(DONATION_PROCESS, donation_type)
				 INTO :nd_donation_process
				 FROM BD_DONOR_Q_P_HDR
				 WHERE UNIT_NO = :d_unit_no[h_no_of_rec]
				 AND operating_facility_id = :d_facility_id;

		nd_donation_process.arr[nd_donation_process.len]	= '\0';


	if (NO_DATA_FOUND)
	{
		if (strlen(d_donation_process[h_no_of_rec].arr) == 0)
		{
			strcpy(nd_donation_process.arr, "R");
			nd_donation_process.len = strlen(nd_donation_process.arr);
		}
	}

	strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
	d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);


	if(OERROR)
	{
		sprintf(string_var,"%s get donation_details-> %s\n", d_unit_no[h_no_of_rec].arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

  }

get_donation_details()
  {
	nd_donor_id.arr[0]='\0';
	nd_donor_id.len=0;

	nd_donation_process.arr[0]='\0';
	nd_donation_process.len=0;

	nd_collection_date.arr[0]='\0';
	nd_collection_date.len=0;

    if ((strcmp(a_pgm_id.arr,"BTRALILB") == 0) && (isb_flag == 1)) /* if condition added by sunil on 13-aug-2008*/
	{
		EXEC SQL 	 SELECT DONOR_ID,NVL(DONATION_PROCESS, DONATION_TYPE), to_char(BLEEDING_END_DATETIME, 'DD/MM/YYYY')
				 INTO :nd_donor_id,:nd_donation_process, :nd_collection_date
				 FROM BD_DONOR_Q_P_HDR
				 WHERE UNIT_NO=:d_fm_unit_no
				AND operating_facility_id = :d_facility_id;
	}
	else if ((strcmp(a_pgm_id.arr,"BTRSCRLB") == 0) && (isb_flag == 1)) /* if condition added by sunil on 13-aug-2008*/
	{
		EXEC SQL 	 SELECT DONOR_ID,NVL(DONATION_PROCESS, DONATION_TYPE), to_char(BLEEDING_END_DATETIME, 'DD/MM/YYYY')
				 INTO :nd_donor_id,:nd_donation_process, :nd_collection_date
				 FROM BD_DONOR_Q_P_HDR
				 WHERE UNIT_NO=:d_unit_no[h_no_of_rec] AND PRODUCT_CODE=:d_fm_product_code; 
	}        
	else if (((strcmp(a_pgm_id.arr,"BTRSPRLB") == 0)||(strcmp(a_pgm_id.arr,"BTRCONVL") == 0) ) && (isb_flag == 1)) /* if condition added by sunil on 13-aug-2008*/
	{
		EXEC SQL 	 SELECT DONOR_ID,'R', to_char(DONATION_DATE, 'DD/MM/YYYY')
				 INTO :nd_donor_id,:nd_donation_process, :nd_collection_date
				 FROM BD_BLOOD_UNITS_MAST
				 WHERE UNIT_NO=:d_unit_no[h_no_of_rec] AND PRODUCT_CODE=:d_fm_product_code; 
	}        
	else
	{
		EXEC SQL 	 SELECT DONOR_ID, NVL(DONATION_PROCESS, DONATION_TYPE), to_char(BLEEDING_END_DATETIME, 'DD/MM/YYYY')
				 INTO :nd_donor_id,:nd_donation_process, :nd_collection_date
				 FROM BD_DONOR_Q_P_HDR
				 WHERE UNIT_NO=:d_unit_no[h_no_of_rec] AND PRODUCT_CODE=:d_fm_product_code; 
	}        
	
	//fprintf(f2,"\nDONOR_ID = %s  DONATION_PROCESS=%s",nd_donor_id.arr,nd_donation_process.arr);
	nd_donor_id.arr[nd_donor_id.len]='\0';
	nd_donation_process.arr[nd_donation_process.len]	= '\0';
	nd_collection_date.arr[nd_collection_date.len]		= '\0';

	strcpy(d_donor_id[h_no_of_rec].arr, nd_donor_id.arr);
	d_donor_id[h_no_of_rec].len = strlen(d_donor_id[h_no_of_rec].arr);
	
	strcpy(d_donation_process[h_no_of_rec].arr, nd_donation_process.arr);
	d_donation_process[h_no_of_rec].len = strlen(d_donation_process[h_no_of_rec].arr);

EXEC SQL EXECUTE
	DECLARE
	s_date   VARCHAR2(50);
	BEGIN
	GET_LOCALE_DATE_2T.CONVERT_TO_LOCALE_DATE (to_date(:nd_collection_date,'DD/MM/YYYY'), :language_id , s_date, 'DD Mon YYYY');
	:nd_collection_date := s_date;
	END;
END-EXEC;

	strcpy(d_collection_date[h_no_of_rec].arr, nd_collection_date.arr);
	d_collection_date[h_no_of_rec].len = strlen(d_collection_date[h_no_of_rec].arr);
	
	if(OERROR)
	{
		sprintf(string_var,"%s get_center_code-> %s\n", d_unit_no[h_no_of_rec].arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}
  }

print_isb_label(int position)
{
int kl =0;

//Barcode
/*	if ((strcmp(a_pgm_id.arr,"BTRSCRLB") == 0) && (isb_flag == 1)) /* if condition added by sunil on 18-aug-2008*/
/*	{
		if ( ( f1 = fopen ( filename3, "w" ) ) == NULL ) 
		{	
		ins_message(ERR_MESG,"Error in opening output file...\n");  
		}
	}
	else
	{
		if ( ( f1 = fopen ( filename, "w" ) ) == NULL ) 
		{	
		ins_message(ERR_MESG,"Error in opening output file...\n");  
		}
	}
    if (strcmp(nd_printer_type.arr,"3")!= 0)
    {
      fprintf(f1, "%cE", ESC);
      set_fonts();
    }
*/	
//atoi(nd_printer_type.arr)
	
	nd_printer_type.arr[0]='3';
	nd_printer_type.arr[1]='\0';

	print_barcode(f1,d_unit_no[position].arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));
	fprintf(f1,"\n"); 
	print_barcode(f1,d_bld_grp_rh_barcode[position].arr, 0,0,  40, 250,atoi(nd_printer_type.arr));
	fprintf(f1,"\n"); 
	
//	fprintf(f1,"%s\n",d_unit_no[position].arr);
//	fprintf(f1,"%s\n",d_unit_no_split[position].arr);
	fprintf(f1,"%s\n",d_unit_no_split1[position].arr);
	fprintf(f1,"%s\n",d_unit_no_split2[position].arr);

/*	if (strcmp(a_pgm_id.arr,"BTRALILB") == 0)
	{
		kl = position;
		kl++;
		if (kl <=9)
		{
		fprintf(f1,"0%d\n",kl);
		}
		else
		fprintf(f1,"%d\n",kl);
	}
	else
	{
		fprintf(f1,"%s\n","00");
	}
*/
	fprintf(f1,"%s\n",d_unit_no_seq[position].arr);
	strcpy(chk_unit,d_unit_no[position].arr);
	CalculateChecksum(chk_unit);
	fprintf(f1,"%s\n",chk_sum);
	fprintf(f1,"%s\n",d_bld_grp_rh_barcode[position].arr);
	
//Value
	 
	fprintf(f1,"____________________\n");
	// commented by sunil  fprintf(f1,"%-s\n",d_center_code[position].arr);

	
	initialize_out_var();

	
	rl_split_text(d_center_desc[position].arr, ' ', 35, v_out_string1,
			v_out_string2, v_out_string3, v_out_string4);

	fprintf(f1,"%-s\n",v_out_string1);
	if (strlen(v_out_string2) == 0)
	{
		strcpy(v_out_string2, " ");
	}

	fprintf(f1,"%-s\n",v_out_string2);

	
	
	//fprintf(f1,"%s\n"," ");

	fprintf(f1, "%s:\n",local_legend[10]); /*	added by sunil on 01-Jun-2006 against CRF */
	fprintf(f1, "%-s\n",d_collection_date[position].arr); /*	added by sunil on 01-Jun-2006 against CRF */
//	fprintf(f1, "%-s\n",d_donation_date[position].arr); 
	fprintf(f1,"____________________\n");
//	fprintf(f1,"%s\n",d_blood_group[position].arr);
	fprintf(f1,"%s\n",d_blood_grp_for_disp[position].arr);/*above line commented and this added by sunil on 05/01/2010*/
//	fprintf(f1,"%-s\n",d_prod_barcode_msg1[position].arr);
	strcpy(split_text.arr, d_prod_barcode_msg1[position].arr);
	split_text.arr[strlen(split_text.arr)]='\0';
	split_text.len = strlen(split_text.arr); 
	splitting();
/*	sprintf(string_var,"value of b : %d",b);
//	disp_message(ERR_MESG, string_var);
	for(i=1;i <= (65-a) ;i++)
	{
		fprintf(f1,"%s"," ");
	}	
*/	//fprintf(f1,"%-65.15s","               ");
	for (i=b; i< 5; i++)
	{
		fprintf(f1,"%s\n"," "); 
	}
//sprintf(string_var, "proces type   %s  ---- %s", d_donation_process[position].arr, local_legend[14]);
//disp_message(ERR_MESG, string_var);

	//fprintf(f1,"%s\n",d_blood_group_desc[position].arr);/*added by sunil on 05/01/2010 and commented as per dineshs intructions and below line added*/
	fprintf(f1,"%s\n"," ");/*added by sunil on 05/01/2010*/

	fprintf(f1,"%s\n",d_rhesus_desc[position].arr);
	//commented by sunilfprintf(f1,"%-s\n",d_blood_group[position].arr);

	//fprintf(f1,"%-s\n",d_donation_process[position].arr);
	if (strcmp(d_donation_process[position].arr,"R") == 0 )
		fprintf(f1, "%-s\n",local_legend[6]);
	else if (strcmp(d_donation_process[position].arr,"P") == 0 )
		fprintf(f1, "%-s\n",local_legend[7]);
	else if (strcmp(d_donation_process[position].arr,"C") == 0 )
		fprintf(f1, "%-s\n",local_legend[8]);
	else if (strcmp(d_donation_process[position].arr,"D") == 0 )
		fprintf(f1, "%-s\n",local_legend[9]);
	else if (strcmp(d_donation_process[position].arr,"T") == 0 )
		fprintf(f1, "%-s\n",local_legend[14]);
	else
		fprintf(f1, "%-s\n",local_legend[6]);
	
	// commented by sunil fprintf(f1,"%-s\n",d_rhesus_code[position].arr);
	
//Barcode

//atoi(nd_printer_type.arr)

//	print_barcode(f1,d_donor_id[position].arr,0,0,  40, 250,atoi(nd_printer_type.arr));
	print_barcode(f1,d_product_code[position].arr,0,0,  40, 250,atoi(nd_printer_type.arr));
	fprintf(f1,"\n");
	//fprintf(f1,"\nX%-sX",d_donor_id[position].arr,135,135);
	
	print_barcode(f1,d_expiry_date2[position].arr, 0,0,  40, 250,atoi(nd_printer_type.arr));
	fprintf(f1,"\n");
	
//	fprintf(f1,"%s",d_donor_id[position].arr); 
	fprintf(f1,"%s",d_product_code[position].arr); 
	fprintf(f1,"\n");
	fprintf(f1,"%s\n",d_expiry_date2[position].arr);
	fprintf(f1, "%s\n",local_legend[12]);/*added by sunil 0n 13-Aug-2008 against CRF*/
	fprintf(f1, "%s\n",local_legend[13]);/*added by sunil 0n 13-Aug-2008 against CRF*/
	fprintf(f1,"%s\n",d_expiry_date3[position].arr);
	
//	fprintf(f1,"%-s\n",d_product_long_desc[position].arr);
	strcpy(split_text.arr, d_product_long_desc[position].arr);
	split_text.arr[strlen(split_text.arr)]='\0';
	split_text.len = strlen(split_text.arr);


//	splitting1();

	initialize_out_var();

	rl_split_text(split_text.arr, ' ', 20, v_out_string1,
			v_out_string2, v_out_string3, v_out_string4);


		fprintf(f1,"%-20.20s\n", v_out_string1);
		if (strlen(v_out_string2) == 0)
		{
				strcpy(v_out_string2, " ");
		}
		fprintf(f1,"%-20.20s\n", v_out_string2);


/*	for (i=b; i< 2; i++)
	{
		fprintf(f1,"%s\n"," "); 
	}
*/	

	fprintf(f1, "%-s\n", d_antigen_desc.arr);/* added sunil js on 08/08/2008*/

	fprintf(f1, "%-s\n", d_antigen_desc2.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc3.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc4.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc5.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc6.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc7.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc8.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc9.arr);/* added by sunil on 05/01/2010*/
	fprintf(f1, "%-s\n", d_antigen_desc10.arr);/*added by sunil on 05/01/2010*/

	//fprintf(f1, "%s: %-s\n",local_legend[1], d_store_instr_desc[position].arr);/*added by sunil 0n 01-Jun-2008 against CRF*/
			/*above line commented and moved down on 05/01/2010*/

	// fprintf(f1,"%s\n",d_prod_barcode_msg2[position].arr);
	strcpy(split_text.arr, d_prod_barcode_msg2[position].arr);
	split_text.arr[strlen(split_text.arr)]='\0';
	split_text.len = strlen(split_text.arr);
	splitting();
	for (i=b; i< 5; i++)
	{
		fprintf(f1,"%s\n"," "); 
	}
	fprintf(f1, "%s: %-s\n",local_legend[1], d_store_instr_desc[position].arr);/*added by sunil on 05/01/2010*/
	fprintf(f1,"%s: %-4d %s",local_legend[11], d_volume[position], d_volume_units[position].arr);

	fclose(f1);
//	print_barcode_label(1);
}

get_product_desc()
{

	nd_prod_barcode_msg1.arr[0]	= '\0';
	nd_prod_barcode_msg1.len	= 0;

	nd_prod_barcode_msg2.arr[0]	= '\0';
	nd_prod_barcode_msg2.len	= 0;

	nd_product_barcode_value.arr[0]	= '\0';
	nd_product_barcode_value.len	= 0;

	nd_product_long_desc.arr[0]	= '\0';
	nd_product_long_desc.len	= 0;

        d_store_instr_code.arr[0]		     = '\0';
	d_store_instr_code.len		         = 0;

        d_store_instr_desc_temp.arr[0]	     = '\0';
	d_store_instr_desc_temp.len		     = 0;

	d_product_desc[h_no_of_rec].arr[0]	 = '\0';
	d_product_desc[h_no_of_rec].len		 = 0;

	d_store_instr_desc[h_no_of_rec].arr[0]	 = '\0';
	d_store_instr_desc[h_no_of_rec].len		 = 0;

	strcpy(d_product_code_temp.arr, d_product_code[h_no_of_rec].arr);
	d_product_code_temp.len = strlen(d_product_code_temp.arr);

	EXEC SQL  SELECT store_instr_code, long_desc,
					SUBSTR(PRODUCT_BARCODE_MESS1, 1, 200),
					SUBSTR(PRODUCT_BARCODE_MESS2, 1, 200),
					PRODUCT_BARCODE_CODE, long_desc
	            INTO :d_store_instr_code, :d_product_desc_temp,:nd_prod_barcode_msg1,
			:nd_prod_barcode_msg2,:nd_product_barcode_value, :nd_product_long_desc 
	            FROM bt_product_mast_lang_vw
               WHERE product_code = :d_product_code_temp
	       and language_id= :language_id;
	
	

	if(OERROR)
	{
		sprintf(string_var,"%s get_product_desc()-> %s\n", d_fm_unit_no.arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

    if(NO_DATA_FOUND)
    {
      d_product_desc[h_no_of_rec].arr[d_product_desc[h_no_of_rec].len]   = '\0';
      d_product_desc[h_no_of_rec].len = strlen(d_product_desc[h_no_of_rec].arr);

    }

	d_store_instr_code.arr[d_store_instr_code.len]   = '\0';
	d_product_desc_temp.arr[d_product_desc_temp.len] = '\0';
	
		
	nd_prod_barcode_msg1.arr[nd_prod_barcode_msg1.len]   = '\0';
//	nd_prod_barcode_msg1.len = strlen(nd_prod_barcode_msg1.arr);
	
	nd_prod_barcode_msg2.arr[nd_prod_barcode_msg2.len]   = '\0';
//	nd_prod_barcode_msg2.len = strlen(nd_prod_barcode_msg2.arr);
	
	nd_product_barcode_value.arr[nd_product_barcode_value.len]   = '\0';
//	nd_product_barcode_value.len = strlen(nd_product_barcode_value.arr);
	
	nd_product_long_desc.arr[nd_product_long_desc.len]   = '\0';
//	nd_product_long_desc.len = strlen(nd_product_long_desc.arr);
	
	strcpy(d_prod_barcode_msg1[h_no_of_rec].arr, nd_prod_barcode_msg1.arr);
        d_prod_barcode_msg1[h_no_of_rec].len = strlen(d_prod_barcode_msg1[h_no_of_rec].arr);
	
    	strcpy(d_prod_barcode_msg2[h_no_of_rec].arr,nd_prod_barcode_msg2.arr);
	d_prod_barcode_msg2[h_no_of_rec].len = strlen(d_prod_barcode_msg2[h_no_of_rec].arr);
	

	strcpy(d_product_barcode_value[h_no_of_rec].arr, nd_product_barcode_value.arr);
	d_product_barcode_value[h_no_of_rec].len = strlen(d_product_barcode_value[h_no_of_rec].arr);
	
	strcpy(d_product_long_desc[h_no_of_rec].arr,nd_product_long_desc.arr);
	d_product_long_desc[h_no_of_rec].len = strlen(d_product_long_desc[h_no_of_rec].arr);
	
	strcpy(d_product_desc[h_no_of_rec].arr, d_product_desc_temp.arr );
	d_product_desc[h_no_of_rec].len = strlen(d_product_desc[h_no_of_rec].arr);
	

	d_store_instr_desc_temp.arr[0] = '\0';
	d_store_instr_desc_temp.len = 0;
	
	EXEC SQL  SELECT long_desc
	            INTO :d_store_instr_desc_temp
	            FROM bd_storage_instruction_lang_vw
               WHERE store_instr_code = :d_store_instr_code
	       and language_id=:language_id;
	
	if(OERROR)
	{
		sprintf(string_var,"%s get_product_desc()-> %s\n", d_fm_unit_no.arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

    if(NO_DATA_FOUND)
    {
		d_store_instr_desc_temp.arr[0] = '\0';
		d_store_instr_desc_temp.len = 0;
      
    }

    d_store_instr_desc_temp.arr[d_store_instr_desc_temp.len]   = '\0';

    strcpy(d_store_instr_desc[h_no_of_rec].arr, d_store_instr_desc_temp.arr );
    d_store_instr_desc[h_no_of_rec].len = strlen(d_store_instr_desc[h_no_of_rec].arr);

}

/**************************get printer id details ***************/
get_printer_id_dtls()
{

		EXEC SQL EXECUTE
				DECLARE
 						p_location_varray	APPPRINT.location_varray_type := APPPRINT.LOCATION_VARRAY_TYPE();
						p_printer_id		VARCHAR2(1000);
						p_printer			VARCHAR2(1000);
						p_printer_types		VARCHAR2(1000);
						p_queue				VARCHAR2(1000);
						p_copies			VARCHAR2(50);
						p_error_text		VARCHAR2(1000);
						p_facility_yn		VARCHAR2(100);
						p_report_group		VARCHAR2(1000);
						p_trans_ind			VARCHAR2 (100);
				BEGIN
						  
						  p_location_varray.extend(10);
						  p_location_varray(1).location_type := :nd_print_source_type;
						  p_location_varray(1).location_code := :nd_print_source;

						  p_facility_yn	:= :nd_facility_ind;
						  p_report_group := :nd_report_group_id;
						  p_trans_ind := :nd_trx_ind;


--						  p_location_varray(1).location_type := 'O';
--						  p_location_varray(1).location_code :=  NULL;
--						  p_report_group := NULL;
--						  p_facility_yn	:= 'Y';
--						  p_trans_ind := 'N';
						  


				APPPRINT.get_routing_printer_property(:nd_ws_no,
						  	    :d_facility_id,
								'BT',
								'BTRALILB',
								 p_location_varray,
								 p_facility_yn,
								 p_trans_ind,
								 p_report_group,
								 p_printer_id,
								 p_printer,
								 p_printer_types,
								 p_queue,
								 p_copies,
								 p_error_text);

					
					IF p_printer_id LIKE 'ZPL%' THEN
						:nd_printer_id := 'ZPL';
					ELSE
						:nd_printer_id := 'EPL';
					END IF;

				END;
		END-EXEC;


}

/**************************select transaction based or not ***************/
get_trans_ind()
{
	
	nd_trx_ind.arr[0]		= '\0';
	nd_trx_ind.len		= 0;

	EXEC SQL  SELECT NVL(TRANSACTION_BASED_YN, 'N')
	            INTO :nd_trx_ind
	            FROM sy_online_print_id
               WHERE MODULE_ID = 'BT'
   		         AND ONLINE_PRINT_NAME = :a_pgm_id;

	if(OERROR)
	{
		sprintf(string_var,"%s get_trans_ind()-> %s\n", d_fm_unit_no.arr, sqlca.sqlerrm.sqlerrmc);
		ins_message(ORA_MESG, string_var);
	}

	nd_trx_ind.arr[nd_trx_ind.len]   = '\0';

    if(NO_DATA_FOUND)
	  nd_trx_ind.arr[nd_trx_ind.len]   = '\0';
		
       if (strcmp(nd_trx_ind.arr, "Y") == 0)
	 {
		strcpy(nd_print_source_type.arr, nd_source_type.arr);
		strcpy(nd_print_source.arr, nd_fm_source.arr);

	 }
	 else
	 {
	        strcpy(nd_print_source_type.arr, "O");
        	strcpy(nd_print_source.arr, " ");
	 }
	 nd_print_source_type.len = strlen(nd_print_source_type.arr);
	 nd_print_source.len = strlen(nd_print_source.arr);


}

call_main_report()
{
  call_print_label();
}

set_fonts()
{

/*	fprintf(f1,"%c&k4S",ESC); This will make the font condensed */	
/*  fprintf(fp,"%c(s4B",ESC); This will make the font bold      */
	fprintf(f1, "%c(s15H", ESC);/* Reduce the font size*/
	fprintf(f1,"%c&a0L",ESC);/* This will make the left margin to reduce to 0 */
	fprintf(f1,"%c&l0E\n",ESC);	/* This will make the top margin to reduce to 0 */
	fprintf(f1,"%c&l12D",ESC);/* This will make no. of lines per inch to 8 */
}


call_print_label()
{
  int v_i = 0;


  if (strcmp(a_pgm_id.arr,"BTRUNTLB") == 0 )
  {

    if ( ( f1 = fopen ( filename, "w" ) ) == NULL ) 
    {
      ins_message(ERR_MESG,"Error in opening output file...\n");  
    }

    if (strcmp(nd_printer_type.arr,"3")!= 0)
    {	
      fprintf(f1, "%cE", ESC);
      set_fonts();
    }
	get_label_gen_yn(); // added by sunil 0n 03032009
	get_unit_no();		// added by sunil 0n 03032009
    print_unit_label(v_i);
    fclose(f1);

    if (strcmp(nd_printer_type.arr,"3")!= 0)
    {	
      fprintf(f1, "%cE", ESC);
      set_fonts();
    }

    if (err_flag == 0)
    {
       print_barcode_label(1);
    }
  }

  for (v_i=0;v_i<h_no_of_rec;v_i++)
  {

    if ( ( f1 = fopen ( filename, "w" ) ) == NULL ) 
    {
      ins_message(ERR_MESG,"Error in opening output file...\n");  
    }

    if (strcmp(nd_printer_type.arr,"3")!= 0)
    {
      fprintf(f1, "%cE", ESC);
      set_fonts();
    }

    if (strcmp(a_pgm_id.arr,"BDRUSRLB") == 0 )
    {
      print_unscreened_label(v_i);
    }
    else if (strcmp(a_pgm_id.arr,"BTRSCRLB") == 0 )
    {

	  if(isb_flag == 1)
		{

		   print_isb_label(v_i);

		   }
	  else
	  {

	      print_screened_label(v_i);

		}
    }
    else if (strcmp(a_pgm_id.arr,"BTRSCIBT") == 0 )
    {
	  if(isb_flag == 1)
		{
		   print_isb_label(v_i);
		   }
	  else
	      print_screened_label(v_i);
    }
//added for aliquot 
	else if (strcmp(a_pgm_id.arr,"BTRALILB") == 0 )
    {
	   if(isb_flag == 1) 
		  
		   print_isb_label(v_i);
	  else

		  print_screened_label(v_i);

    }
    
//added by for screened LABEL
    else if (strcmp(a_pgm_id.arr,"BTRSPRLB") == 0 )
    {
	   if(isb_flag == 1) 
		   print_isb_label(v_i);
	  else

	      print_screened_label(v_i);
    }
    else if (strcmp(a_pgm_id.arr,"BTRCONVL") == 0 )
    {
	   if(isb_flag == 1) 
		   print_isb_label(v_i);
	  else

	      print_screened_label(v_i);
    }
	fclose(f1);

    if (strcmp(nd_printer_type.arr,"3")!= 0)
    {	
      fprintf(f1, "%cE", ESC);
      set_fonts();
    }
//disp_message(ERR_MESG, "9.a");
    if (err_flag == 0)
    {
       print_barcode_label(1);
    }
//disp_message(ERR_MESG, "9.b");
  }
//disp_message(ERR_MESG, "9.c");
}

/******************* added on 28.07.2003 ********/
get_printer_type()
{

	  strcpy(nd_printer_type.arr, "3");
	  nd_printer_type.len = strlen(nd_printer_type.arr);

	  EXEC SQL SELECT NVL(printer_type, '1')
  	           INTO  :nd_printer_type
  	           FROM   SY_ONLINE_PRINT_ID
	           WHERE  module_id = 'BT'
	           AND    online_print_name = :a_pgm_id; 

        if(NO_DATA_FOUND)
   		strcpy(nd_printer_type.arr, "3");
		nd_printer_type.len = strlen(nd_printer_type.arr);
  	  if(OERROR)
   		strcpy(nd_printer_type.arr, "3");
		nd_printer_type.len = strlen(nd_printer_type.arr);

	  nd_printer_type.arr[nd_printer_type.len]  = '\0';

}

/*
print_unit_label(int v_ind)
{

	if (strcmp(nd_printer_type.arr,"3")!=0)	
	  {
	     print_barcode(f1,d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));
	     fprintf(f1,"\n");  
	  }
	else
	 {
	     print_barcode(f1, d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
	     fprintf(f1,"\n");
	 }
	fprintf(f1, "%s\n", d_fm_unit_no.arr);
	if(isb_flag == 1) // added on 29/09/2008
	{
		fprintf(f1,"00\n");
		strcpy(chk_unit,d_fm_unit_no.arr);
		CalculateChecksum(chk_unit);
		fprintf(f1,"%s\n",chk_sum);
	}
}
commented and below code added on 07/10/2008 by sunil
*/
print_unit_label(int v_ind)
{
int aa=0; 

	strcpy(chk_unit,d_fm_unit_no.arr);
	CalculateChecksum(chk_unit);

/*
	if (strcmp(isb_unit_no_format.arr,"P") == 0)
	{
		while(d_NumOfCopies > aa)
		{

			if ((d_NumOfCopies - aa) ==1)
			{
				print_barcode(f1, d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
				fprintf(f1,"~");
				fprintf(f1,"\n");
//				fprintf(f1, "%s~\n", d_fm_unit_no.arr);
//				fprintf(f1, "%s~\n",d_unit_no_split[h_no_of_rec].arr);
				fprintf(f1, "%s~\n",d_unit_no_split1[h_no_of_rec].arr);
				fprintf(f1, "%s~\n",d_unit_no_split2[h_no_of_rec].arr);
				if(isb_flag == 1) // added on 29/09/2008
				{
					fprintf(f1,"00~\n");
					fprintf(f1,"%s~\n",chk_sum);
				}
				aa++;
			}
			else
			{
				print_barcode(f1, d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
				fprintf(f1,"~");
				print_barcode(f1, d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
				fprintf(f1,"\n");
//				fprintf(f1, "%s~", d_fm_unit_no.arr);
//				fprintf(f1, "%s\n", d_fm_unit_no.arr);
				fprintf(f1, "%s~",d_unit_no_split1[h_no_of_rec].arr);
				fprintf(f1, "%s\n",d_unit_no_split1[h_no_of_rec].arr);
				fprintf(f1, "%s~",d_unit_no_split2[h_no_of_rec].arr);
				fprintf(f1, "%s\n",d_unit_no_split2[h_no_of_rec].arr);
				if(isb_flag == 1) // added on 29/09/2008
				{
					fprintf(f1,"00~");
					fprintf(f1,"00\n");
					fprintf(f1,"%s~",chk_sum);
					fprintf(f1,"%s\n",chk_sum);
				}
				aa++;aa++;
			}
		}
		if (d_NumOfCopies>1)
		{
			d_NumOfCopies =1;
		}
	}
	else
	{
		print_barcode(f1, d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
		fprintf(f1,"\n");
//		fprintf(f1, "%s\n", d_fm_unit_no.arr);
				fprintf(f1, "%s~\n",d_unit_no_split1[h_no_of_rec].arr);
				fprintf(f1, "%s~\n",d_unit_no_split2[h_no_of_rec].arr);
		if(isb_flag == 1) // added on 29/09/2008
		{
			fprintf(f1,"00\n");
			fprintf(f1,"%s\n",chk_sum);
		}
	}
*/
	print_barcode(f1, d_fm_unit_no.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
	fprintf(f1,"\n");
//	fprintf(f1, "%s\n", d_fm_unit_no.arr);
//			fprintf(f1, "%s\n",d_unit_no_split[h_no_of_rec].arr);  commented and added below 2 lines wrt IN018889	
//			fprintf(f1, "%s\n",d_unit_no_split1[h_no_of_rec].arr);
//			fprintf(f1, "%s\n",d_unit_no_split2[h_no_of_rec].arr);
	if(isb_flag == 1) // added on 29/09/2008
	{
		fprintf(f1, "%s\n",d_unit_no_split1[h_no_of_rec].arr);
		fprintf(f1, "%s\n",d_unit_no_split2[h_no_of_rec].arr);
		fprintf(f1,"00\n");
		fprintf(f1,"%s\n",chk_sum);
	}
	else
	{
		fprintf(f1, "%s\n", d_fm_unit_no.arr);
	}

}

print_unscreened_label(int v_ind)
{

	fprintf(f1, "%-13s", d_donation_date[v_ind].arr);
	fprintf(f1, "%-s\n", d_product_desc[v_ind].arr);
	sprintf(d_unit_barcode_value.arr,"%s %s ", d_unit_no[v_ind].arr, d_product_code[v_ind].arr);
//	sprintf(d_unit_barcode_value.arr,"%s %s %d/%d", d_unit_no[v_ind].arr, d_product_code[v_ind].arr, v_ind+1, h_no_of_rec);

	if (strcmp(nd_printer_type.arr,"3")!=0)	
	  {
	     print_barcode(f1,d_unit_barcode_value.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));
	     fprintf(f1,"\n");  
	  }
	else
	 {
	     print_barcode(f1, d_unit_barcode_value.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
	     fprintf(f1,"\n");
	 }
	//fprintf(f1, "%-s\n", d_blood_group[v_ind].arr);

	fprintf(f1, "%-s\n", d_blood_grp_for_disp[v_ind].arr);/*above line commented and this line added by sunil on 05/01/2010*/

	fprintf(f1, "%-s\n", d_rhesus_code[v_ind].arr);
	fprintf(f1, "%-d", d_volume[v_ind]);
	fprintf(f1, " %s\n", d_volume_unit[v_ind].arr);
	fprintf(f1, "%-s %d/%d\n", d_unit_barcode_value.arr,v_ind+1,h_no_of_rec);
	//fprintf(f1, "%-s\n", "UNSCREENED");
	fprintf(f1, "%-s\n",local_legend[5]);
	
}

print_screened_label(int v_ind)
{


	fprintf(f1, "%-s\n", d_facility_name.arr);
	fprintf(f1, "%-s\n", d_product_desc[v_ind].arr);
	fprintf(f1, "%s: %-s\n",local_legend[1], d_store_instr_desc[v_ind].arr);
//	fprintf(f1, "%s: %-s\n",local_legend[2], d_donation_date[v_ind].arr);  //commeneted by preetham on 09/01/2009 wrt SCR7021

	if (strcmp(strupr(nd_report_ind.arr),"POOLED") == 0)  // added by preetham on 09/01/2009 wrt SCR7021
		fprintf(f1, "%s: %-s\n",local_legend[15], d_donation_date[v_ind].arr);
	else	
		fprintf(f1, "%s: %-s\n",local_legend[2], d_donation_date[v_ind].arr);

	fprintf(f1, "%s: %-s\n",local_legend[3], d_expiry_date1[v_ind].arr);
//	fprintf(f1, "FOR FRACTIONATION\n");


	if (strcmp(nd_printer_id.arr, "ZPL") == 0)
	{
		fprintf(f1, "%-s   %-s\n\n", d_blood_group[v_ind].arr, d_rhesus_code[v_ind].arr);
		fprintf(f1, "%d   %-s\n", d_volume[v_ind], d_volume_unit[v_ind].arr);

	}
	else
	{
		//fprintf(f1, "%-s\n", d_blood_group[v_ind].arr);
		fprintf(f1, "%-s\n", d_blood_grp_for_disp[v_ind].arr);/*above line commented and this line added by sunil on 05/01/2010*/
		fprintf(f1, "%d", d_volume[v_ind]);
		fprintf(f1, " %s\n", d_volume_unit[v_ind].arr);
		fprintf(f1, "%-s\n", d_rhesus_code[v_ind].arr);
	}

	sprintf(d_unit_barcode_value.arr,"%s %s", d_unit_no[v_ind].arr, d_product_code[v_ind].arr);
//	sprintf(d_unit_barcode_value.arr,"%s %s %d/%d", d_unit_no[v_ind].arr, d_product_code[v_ind].arr, v_ind+1, h_no_of_rec);
	if (strcmp(nd_printer_type.arr,"3")!=0)	
	  {
	     print_barcode(f1,d_unit_barcode_value.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));
	     fprintf(f1,"\n");  
	  }
	else
	 {
	     print_barcode(f1, d_unit_barcode_value.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
	     fprintf(f1,"\n");
	 }
	fprintf(f1, "%-s %d/%d\n", d_unit_barcode_value.arr,v_ind+1,h_no_of_rec);
//	fprintf(f1, "    SCREENED");
	fprintf(f1, "%s \n",local_legend[4]);

}

print_screened_label1(int v_ind)
{
    
	fprintf(f1, "%-s\n", d_facility_name.arr);
	fprintf(f1, "%-s\n", d_product_desc[v_ind].arr);
	fprintf(f1, "%s: %-s\n",local_legend[1], d_store_instr_desc[v_ind].arr);


	fprintf(f1, "%s: %-s\n",local_legend[2], d_donation_date[v_ind].arr);
	fprintf(f1, "%s: %-s\n",local_legend[3], d_expiry_date1[v_ind].arr);
//	fprintf(f1, "FOR FRACTIONATION\n");
	fprintf(f1, "%-s\n", d_blood_group[v_ind].arr);
	fprintf(f1, "%-d", d_volume[v_ind]);
	fprintf(f1, " %s\n", d_volume_unit[v_ind].arr);
	fprintf(f1, "%-s\n", d_rhesus_code[v_ind].arr);
	sprintf(d_unit_barcode_value.arr,"%s %s", d_unit_no[v_ind].arr, d_product_code[v_ind].arr);
//	sprintf(d_unit_barcode_value.arr,"%s %s %d/%d", d_unit_no[v_ind].arr, d_product_code[v_ind].arr, v_ind+1, h_no_of_rec);
	if (strcmp(nd_printer_type.arr,"3")!=0)	
	  {
	     print_barcode(f1,d_unit_barcode_value.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));
	     fprintf(f1,"\n");  
	  }
	else
	 {
	     print_barcode(f1, d_unit_barcode_value.arr, 0, 0, 40, 250,atoi(nd_printer_type.arr));		
	     fprintf(f1,"\n");
	 }
	fprintf(f1, "%-s %d/%d\n", d_unit_barcode_value.arr,v_ind+1,h_no_of_rec);
//	fprintf(f1, "    SCREENED");
	fprintf(f1, "%s \n",local_legend[4]);
}


/***************** Print BarCode Label ********************/
print_barcode_label(int nolabel)
 {
    int i;
    int WSPrintstatus;

    for(i=0;i<nolabel;i++)


		  {

/*
sprintf(string_var,"%s",a_pgm_id.arr);
disp_message(ERR_MESG, string_var); 
sprintf(string_var,"%s",b_pgm_id.arr);
disp_message(ERR_MESG, string_var);

sprintf(string_var,"%s",filename);
disp_message(ERR_MESG, string_var); 

sprintf(string_var,"%d",d_NumOfCopies);
disp_message(ERR_MESG, string_var); 
*/
//commented on 29/09/2008		    if (((strcmp(a_pgm_id.arr,"BTRSCRLB") == 0)||(strcmp(a_pgm_id.arr,"BTRSPRLB") == 0)||(strcmp(a_pgm_id.arr,"BTRALILB") == 0)||(strcmp(a_pgm_id.arr,"BTRCONVL") == 0)) && (isb_flag == 1)) /* if condition added by sunil on 13-aug-2008*/

/*************
sprintf(string_var, " isbt -%d  source  -%s  facility  -%s pgmid -%s filename -%s copies -%d dir-%s", isb_flag,nd_source_type.arr, d_facility_id.arr, b_pgm_id.arr,filename, d_NumOfCopies, WORKING_DIR);
disp_message(ERR_MESG, string_var);

sprintf(string_var, " print source type [%s] [%s] [%s]", nd_source_type.arr, nd_print_source_type.arr, nd_print_source.arr);
disp_message(ERR_MESG, string_var);
****************/

		    if (isb_flag == 1) /*  added by sunil on 29/092008*/
			{ 
		 		if (nd_source_type.arr[0]	== '!')
				{	
					 WSPrintDocument 
						   (
							uid_pwd.arr,		//char	*PUidPwd;
							nd_session_id.arr,	//char	*PSessionID;
							d_facility_id.arr,	//char	*PFacilityID;
							"BT",				//char	*PModuleID;
							b_pgm_id.arr,		//char	*PDocumentID;
							filename,	    	//char	*POnlinePrintFileNames;
							"O",				//char	*PLocationTypes;
							" ",				//char	*PLocationCodes;
							d_NumOfCopies,		//int	PNumOfCopies;
							1,				    //int	PPageFrom;
							9999,				//int	PPageTo;
							nd_ws_no.arr,		//char	*PWorkstationID
							WORKING_DIR			//char	*PReportOutputDir
						   );
				}						   
				else
				{

					WSPrintstatus =		 WSPrintDocument
						   (
							uid_pwd.arr,				//char	*PUidPwd;
							nd_session_id.arr,			//char	*PSessionID;
							d_facility_id.arr,			//char	*PFacilityID;
							"BT",						//char	*PModuleID;
							b_pgm_id.arr,				//char	*PDocumentID;
							filename,	    			//char	*POnlinePrintFileNames;
							nd_print_source_type.arr,	//char	*PLocationTypes;
							nd_print_source.arr,	    //char	*PLocationCodes;
							d_NumOfCopies,				//int	PNumOfCopies;
							1,							//int	PPageFrom;
							9999,						//int	PPageTo;
							nd_ws_no.arr,				//char	*PWorkstationID
							WORKING_DIR					//char	*PReportOutputDir
						   );
				}
			}
			else
			{ 
				if (nd_source_type.arr[0]	== '!')
				{					
					 WSPrintDocument 
						   (
							uid_pwd.arr,		//char	*PUidPwd;
							nd_session_id.arr,	//char	*PSessionID;
							d_facility_id.arr,	//char	*PFacilityID;
							"BT",				//char	*PModuleID;
							a_pgm_id.arr,			//char	*PDocumentID;
							filename,	    	//char	*POnlinePrintFileNames;
							"O",				//char	*PLocationTypes;
							" ",				//char	*PLocationCodes;
							d_NumOfCopies,		//int	PNumOfCopies;
							1,				    //int	PPageFrom;
							9999,				//int	PPageTo;
							nd_ws_no.arr,		//char	*PWorkstationID
							WORKING_DIR			//char	*PReportOutputDir
						   );
				}						   
				else
				{

					WSPrintstatus =		 WSPrintDocument
						   (
							uid_pwd.arr,				//char	*PUidPwd;
							nd_session_id.arr,			//char	*PSessionID;
							d_facility_id.arr,			//char	*PFacilityID;
							"BT",						//char	*PModuleID;
							a_pgm_id.arr,					//char	*PDocumentID;
							filename,	    			//char	*POnlinePrintFileNames;
							nd_print_source_type.arr,	//char	*PLocationTypes;
							nd_print_source.arr,	    //char	*PLocationCodes;
							d_NumOfCopies,				//int	PNumOfCopies;
							1,							//int	PPageFrom;
							9999,						//int	PPageTo;
							nd_ws_no.arr,				//char	*PWorkstationID
							WORKING_DIR					//char	*PReportOutputDir
						   );
				}
			}	  					   
		  }
 }


/*--------------------------------------------------*/
ins_message(int msg_type,char msg[])
{
   er_msg.arr[0] = '\0';
   er_msg.len = 0;
   
   er_msg_type = 0;

   strcpy(er_msg.arr,msg);
   er_msg.len = strlen(er_msg.arr);
 
   er_msg_type = msg_type;   


   EXEC SQL

   INSERT INTO SY_PROG_MSG
         (OPERATING_FACILITY_ID,PGM_ID,MSG_TYPE,MSG_NUM,MSG_DESC,MSG_DATE_TIME,SESSION_ID,PGM_DATE)
   VALUES 
         (:nd_facility_id,'BTRLBPRN',:er_msg_type,NULL, SUBSTR(:er_msg, 1, 70),SYSDATE,USERENV('sessionid'),TO_CHAR(SYSDATE,'DD/MM/YYYY'));

   err_flag = 1;
}


splitting()
{
  
   	char word[2];
	int qq = 0, cntr = 0, z = 0, hell = 0, clt = 0, cmp = 0, t_rue = 0;
	char word1[2];
	strcpy(word1,"F");	
	a = 0; // added by sunl on 04/12/2007 
	b = 0;	// added by sunil on 13-08-2008

    _flushall(); 

     hell = strlen(split_text.arr);
		  

	     z = 0;
	     clt = 0;
	     strcpy(word1,"F");
	     cntr = 1;
	     qq = 0;

         while (z < hell)
         {
		     word[0] = split_text.arr[z];
 		     word[1] = '\0';

		     if (strcmp(word,"\n") == 0)
		     {
		       cntr = 0;

		       strcpy(word1,"N");
		       qq = z ;

			   b++; //added on 30/09/2008
		      }

  		      if(cntr >= 40)
		      {
			     cmp = cntr;
			     while((split_text.arr[z] != 32) && (cmp > 1))
			     {
			         z--;
				     cmp--;
			      }

				  qq = z;
				  			   
			      word[0] = split_text.arr[z];
   			      word[1] = '\0';
		
		  	      if (cmp == 1)
				     strcpy(word1,"W");
			      else
			         strcpy(word1,"T");
		       }
			   if (((z == hell) || (z == hell - 1)) && (strcmp(word1,"F") == 0))
			   {
				   for(i=clt;i < z + 1;i++)
		           {
		              fprintf(f1,"%c",split_text.arr[i]);
					  a++;
			       }
//			       fprintf	(f1,"\n"); COMMENTED NOW
//			       fprintf	(f1,"\n"); 
//				b++;
				   cntr = 0 ;

				   clt = clt + 40 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");
				}
			
		       if (strcmp(word1,"N") == 0) 
		       {
				  for(i=clt;i<=qq;i++)
		          {
			         fprintf(f1,"%c",split_text.arr[i]);
					
			      }
			      strcpy(word1,"F");
			      cntr = 0 ;
			      clt = qq + 1;
		          qq = 0;
	   	       }

			   if (strcmp(word1,"T") == 0)
		       {
				  for(i=clt;i<= qq;i++)
		          {
		             fprintf(f1,"%c",split_text.arr[i]);
			      }
			       fprintf	(f1,"\n");
					b++;	// added by sunil on 13-08-2008
			       cntr = 0 ;
				   clt = qq + 1 ;
			       qq = 0;
				   strcpy(word1,"F");
		        }

		        if (strcmp(word1,"W") == 0)
		        {

				   for(i=clt;i < clt + 40;i++)
		           {
		              fprintf(f1,"%c",split_text.arr[i]);
			       }

			       fprintf(f1,"\n");
					b++;	// added by sunil on 13-08-2008
				   cntr = 0 ;

				   clt = clt + 40 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");
		        }
		  
            cntr += 1;
	        z++ ;
			if (b >= 5) // added by sunil on 13-08-2008
			{
				z = hell;
				break;
			}
          }

  
       fflush(f1);

#ifdef DEBUG
   printf("split_text = %s\n", split_text.arr);
#endif

if (OERROR)
   ins_message(ORA_MESG,"Error occurred at splitting()");

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   ins_message(ORA_MESG,"Error occurred at splitting()");
   return 0;

}



 splitting1()
{
  
   	char word[2];
	int qq = 0, cntr = 0, z = 0, hell = 0, clt = 0, cmp = 0, t_rue = 0;
	char word1[2];
	strcpy(word1,"F");	
	a = 0; // added by sunl on 04/12/2007 
	b = 0;	// added by sunil on 13-08-2008

    _flushall(); 

     hell = strlen(split_text.arr);


	     z = 0;
	     clt = 0;
	     strcpy(word1,"F");
	     cntr = 1;
	     qq = 0;

	     while(z<hell)
         {
		     word[0] = split_text.arr[z];
 		     word[1] = '\0';

		     if (strcmp(word,"\n") == 0)
		     {
		       cntr = 0;
		       strcpy(word1,"N");
		       qq = z ;
		//	   b++; //added on 30/09/2008
		      }
  		      if(cntr >= 20)
		      {
			     cmp = cntr;
			     while((split_text.arr[z] != 32) && (cmp > 1))
			     {
			         z--;
				     cmp--;
			      }

				  qq = z;
				  			   
			      word[0] = split_text.arr[z];
   			      word[1] = '\0';
		
		  	      if (cmp == 1)
				     strcpy(word1,"W");
			      else
			         strcpy(word1,"T");	
		       }

			   if (((z == hell) || (z == hell - 1)) && (strcmp(word1,"F") == 0))
			   {
				   for(i=clt;i < z + 1;i++)
		           {
		              fprintf(f1,"%c",split_text.arr[i]);

//sprintf(string_var, "%c", split_text.arr[i]);

					  a++;
			       }
//sprintf(string_var1, "one   [%s]", string_var);
//disp_message(ERR_MESG, string_var1);		  
				   cntr = 0 ;
				   clt = clt + 20 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");
				}
			
		       if (strcmp(word1,"N") == 0) 
		       {
				  for(i=clt;i<=qq;i++)
		          {
			         fprintf(f1,"%c",split_text.arr[i]);
//sprintf(string_var, "%c", split_text.arr[i]);					
			      }

//sprintf(string_var1, "two   [%s]", string_var);
//disp_message(ERR_MESG, string_var1);		  
			      strcpy(word1,"F");
			      cntr = 0 ;
			      clt = qq + 1;
		          qq = 0;
	   	       }

			   if (strcmp(word1,"T") == 0)
		       {
				  for(i=clt;i<= qq;i++)
		          {
		             fprintf(f1,"%c",split_text.arr[i]);
//sprintf(string_var, "%d", i);					
			      }
//sprintf(string_var1, "three   [%s]", string_var);
//disp_message(ERR_MESG, string_var1);		  
				   if (i >= 20)
				   {
					 fprintf	(f1,"\n");
					  b++;	// added by sunil on 13-08-2008
					}
	 		         cntr = 0 ;
				   clt = qq + 1 ;
			       qq = 0;
				   strcpy(word1,"F");
		        }

		        if (strcmp(word1,"W") == 0)
		        {
				   for(i=clt;i < clt + 20;i++)
		           {
		              fprintf(f1,"%c",split_text.arr[i]);
			       }

			       fprintf(f1,"\n");
					b++;	// added by sunil on 13-08-2008
				   cntr = 0 ;
				   clt = clt + 20 ;
				   z = clt ;
			       qq = 0;
				   strcpy(word1,"F");
		        }
		  
            cntr += 1;
	        z++ ;
			
			if (b == 2) // added by sunil on 13-08-2008
			{
				z = hell;
				break;
			}
			
          }
  
       fflush(f1);

#ifdef DEBUG
   printf("split_text = %s\n", split_text.arr);
#endif

if (OERROR)
   ins_message(ORA_MESG,"Error occurred at splitting1()");

  return;

err_exit:
   EXEC SQL WHENEVER SQLERROR CONTINUE;
   ins_message(ORA_MESG,"Error occurred at splitting1()");
   return 0;

}

// below program added on 27 Mar 2008 
extract_act_user(char l_user_str[])
{

	char dup_user[100];
	char l_act_string[200];
	int i = 0;

	strcpy(dup_user, "");
    dup_user[0] = '\0';

    l_temp1.arr[0] = '\0';
	l_temp1.len = 0;


	strcpy(l_act_string, "");
    l_act_string[0] = '\0';

	strcpy(l_act_string, l_user_str);

	strcpy (dup_user, strtok (l_act_string, "/"));


	if (strcmp(strupr(dup_user),"APPLUSER") == 0)
	{
		for ( i = 0 ; i < strlen(l_user_str); i++)
		{
			if ( l_user_str[i] == '#' )
			{
				break;
			}
			else
			{
				//l_temp[i] = l_user_str[i];			
				l_temp1.arr[i] = l_user_str[i];			
//				strcpy(l_temp.arr[i],l_user_str[i]);
				l_temp1.len = strlen(l_temp1.arr);
				l_temp1.arr[l_temp1.len] = '\0';
			}
		    
		}
	
		strcpy(uid_pwd.arr,l_temp1.arr);
		uid_pwd.len = strlen(uid_pwd.arr); 
        uid_pwd.arr[uid_pwd.len] = '\0';
	}
//disp_message(ERR_MESG, "end of extract_act_user()");
}

initialize_out_var()
{

	strcpy(v_out_string1, "");
	strcpy(v_out_string2, "");
	strcpy(v_out_string3, "");
	strcpy(v_out_string4, "");

}

get_expiry_for_ali_cur()
{

  nd_expiry_date.arr[0] = '\0';
  nd_expiry_date.len = 0;



	  EXEC SQL SELECT TO_CHAR(expiry_date, 'DDMMYYYY HH24:MI')
		INTO :nd_expiry_date
		FROM BT_BLOOD_UNITS_MAST
		WHERE unit_no = :nd_unit_no
		AND product_code = :nd_product_code
		AND operating_facility_id = :d_facility_id;

    if (OERROR)
	{
	        ins_message (ORA_MESG, "FETCH failed c2 ");
		return 0;
      }

    if (NO_DATA_FOUND);

    nd_expiry_date.arr[nd_expiry_date.len] 	= '\0';


}
